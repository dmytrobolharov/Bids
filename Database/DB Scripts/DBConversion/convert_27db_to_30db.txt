/*
Run this script on:

        (local).plmOn27    -  This database will be modified

to synchronize it with:

        (local).plmOn30

You are recommended to back up your database before running this script

Script created by SQL Compare version 8.2.0 from Red Gate Software Ltd at 5/12/2010 11:01:27 AM

*/
SET NUMERIC_ROUNDABORT OFF
GO
SET ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, ARITHABORT, QUOTED_IDENTIFIER, ANSI_NULLS ON
GO
IF EXISTS (SELECT * FROM tempdb..sysobjects WHERE id=OBJECT_ID('tempdb..#tmpErrors')) DROP TABLE #tmpErrors
GO
CREATE TABLE #tmpErrors (Error int)
GO
SET XACT_ABORT ON
GO
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE
GO
BEGIN TRANSACTION
GO
PRINT N'Dropping extended properties'
GO
EXEC sp_dropextendedproperty N'MS_DefaultView', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Filter', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_OrderBy', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_OrderByOn', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Orientation', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_TableMaxRecords', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'Active'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'Active'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'Active'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'CDate'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'CDate'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'CDate'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'CUser'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'CUser'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'CUser'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'MDate'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'MDate'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'MDate'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'MUser'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'MUser'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'MUser'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField1'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField1'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField1'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField1'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField1'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField1'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField10'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField10'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField10'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField10'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField10'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField10'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField11'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField11'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField11'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField11'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField11'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField11'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField12'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField12'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField12'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField12'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField12'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField12'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField13'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField13'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField13'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField13'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField13'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField13'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField14'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField14'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField14'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField14'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField14'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField14'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField15'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField15'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField15'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField15'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField15'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField15'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField16'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField16'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField16'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField16'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField16'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField16'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField17'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField17'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField17'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField17'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField17'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField17'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField18'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField18'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField18'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField18'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField18'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField18'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField19'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField19'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField19'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField19'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField19'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField19'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField2'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField2'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField2'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField2'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField2'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField2'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField20'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField20'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField20'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField20'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField20'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField20'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField21'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField21'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField21'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField21'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField21'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField21'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField22'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField22'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField22'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField22'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField22'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField22'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField23'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField23'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField23'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField23'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField23'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField23'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField24'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField24'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField24'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField24'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField24'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField24'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField25'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField25'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField25'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField25'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField25'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField25'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField26'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField26'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField26'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField26'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField26'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField26'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField27'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField27'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField27'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField27'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField27'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField27'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField28'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField28'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField28'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField28'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField28'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField28'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField29'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField29'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField29'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField29'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField29'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField29'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField3'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField3'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField3'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField3'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField3'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField3'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField30'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField30'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField30'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField30'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField30'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField30'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField31'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField31'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField31'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField32'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField32'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField32'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField33'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField33'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField33'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField34'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField34'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField34'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField35'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField35'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField35'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField4'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField4'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField4'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField4'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField4'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField4'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField5'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField5'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField5'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField5'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField5'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField5'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField6'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField6'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField6'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField6'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField6'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField6'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField7'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField7'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField7'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField7'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField7'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField7'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField8'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField8'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField8'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField8'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField8'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField8'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField9'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField9'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField9'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField9'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField9'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingCustomField9'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingDate'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingDate'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingDate'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingDate'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingDate'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingDate'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingFreightTypeID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingFreightTypeID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingFreightTypeID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingFreightTypeID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingFreightTypeID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingFreightTypeID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingStatus'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingStatus'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingStatus'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingStatus'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingStatus'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingStatus'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingTypeID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingTypeID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingTypeID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingTypeID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingTypeID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleCostingTypeID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleQuotaDutyID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleQuotaDutyID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleQuotaDutyID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleQuotaDutyID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleQuotaDutyID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCosting', 'COLUMN', N'StyleQuotaDutyID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DefaultView', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Filter', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_OrderBy', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_OrderByOn', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Orientation', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_TableMaxRecords', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'Active'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'Active'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'Active'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyCategory'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyCategory'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyCategory'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyCountry'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyCountry'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyCountry'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyCustom1'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyCustom1'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyCustom1'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyCustom2'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyCustom2'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyCustom2'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyFiber'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyFiber'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyFiber'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyGender'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyGender'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyGender'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyId'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyId'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyId'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyId'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyId'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyId'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyItem'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyItem'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyItem'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyMaterialType'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyMaterialType'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyMaterialType'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyPerc'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyPerc'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyPerc'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyPerc'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutyPerc'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnHidden', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutySurcharge'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnOrder', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutySurcharge'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_ColumnWidth', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutySurcharge'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutySurcharge'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleCostingDuty', 'COLUMN', N'DutySurcharge'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleMaterialTemp', 'COLUMN', N'Source'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleMaterialTemp', 'COLUMN', N'Source'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleMaterialTemp', 'COLUMN', N'Source'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleMaterialTemp', 'COLUMN', N'X'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleMaterialTemp', 'COLUMN', N'X'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleMaterialTemp', 'COLUMN', N'X'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DisplayControl', 'SCHEMA', N'dbo', 'TABLE', N'pStyleMaterialTemp', 'COLUMN', N'Z'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Format', 'SCHEMA', N'dbo', 'TABLE', N'pStyleMaterialTemp', 'COLUMN', N'Z'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_IMEMode', 'SCHEMA', N'dbo', 'TABLE', N'pStyleMaterialTemp', 'COLUMN', N'Z'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPane1', 'SCHEMA', N'dbo', 'VIEW', N'vwx_LinePlanShowroomItem_SEL', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPane2', 'SCHEMA', N'dbo', 'VIEW', N'vwx_LinePlanShowroomItem_SEL', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPaneCount', 'SCHEMA', N'dbo', 'VIEW', N'vwx_LinePlanShowroomItem_SEL', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPane1', 'SCHEMA', N'dbo', 'VIEW', N'vwx_MaterialColor_SEL', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPaneCount', 'SCHEMA', N'dbo', 'VIEW', N'vwx_MaterialColor_SEL', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPane1', 'SCHEMA', N'dbo', 'VIEW', N'vwx_MaterialColorSeasonYear_SEL', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPaneCount', 'SCHEMA', N'dbo', 'VIEW', N'vwx_MaterialColorSeasonYear_SEL', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPane1', 'SCHEMA', N'dbo', 'VIEW', N'vwx_MaterialRequestSubmitSchedule_SEL', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPane2', 'SCHEMA', N'dbo', 'VIEW', N'vwx_MaterialRequestSubmitSchedule_SEL', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPaneCount', 'SCHEMA', N'dbo', 'VIEW', N'vwx_MaterialRequestSubmitSchedule_SEL', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPane1', 'SCHEMA', N'dbo', 'VIEW', N'vwx_MaterialSeasonYear_SEL', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPaneCount', 'SCHEMA', N'dbo', 'VIEW', N'vwx_MaterialSeasonYear_SEL', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPane1', 'SCHEMA', N'dbo', 'PROCEDURE', N'spx_StyleCostingHeaderLogic_UPDATE', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPaneCount', 'SCHEMA', N'dbo', 'PROCEDURE', N'spx_StyleCostingHeaderLogic_UPDATE', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Orientation', 'SCHEMA', N'dbo', 'PROCEDURE', N'spx_StyleCostingHeaderLogic_UPDATE', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPane1', 'SCHEMA', N'dbo', 'PROCEDURE', N'spx_StyleCostingLogic_UPDATE', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPaneCount', 'SCHEMA', N'dbo', 'PROCEDURE', N'spx_StyleCostingLogic_UPDATE', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Orientation', 'SCHEMA', N'dbo', 'PROCEDURE', N'spx_StyleCostingLogic_UPDATE', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPane1', 'SCHEMA', N'dbo', 'PROCEDURE', N'spx_StyleCosting_INSERT', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPaneCount', 'SCHEMA', N'dbo', 'PROCEDURE', N'spx_StyleCosting_INSERT', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Orientation', 'SCHEMA', N'dbo', 'PROCEDURE', N'spx_StyleCosting_INSERT', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPane1', 'SCHEMA', N'dbo', 'PROCEDURE', N'spx_StyleCostingHeader_INSERT', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPaneCount', 'SCHEMA', N'dbo', 'PROCEDURE', N'spx_StyleCostingHeader_INSERT', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Orientation', 'SCHEMA', N'dbo', 'PROCEDURE', N'spx_StyleCostingHeader_INSERT', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPane1', 'SCHEMA', N'dbo', 'PROCEDURE', N'spx_MaterialCoreItem_INSERT', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPaneCount', 'SCHEMA', N'dbo', 'PROCEDURE', N'spx_MaterialCoreItem_INSERT', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Orientation', 'SCHEMA', N'dbo', 'PROCEDURE', N'spx_MaterialCoreItem_INSERT', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPane1', 'SCHEMA', N'dbo', 'PROCEDURE', N'spx_StyleCostingTypeLogic_SELECT', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_DiagramPaneCount', 'SCHEMA', N'dbo', 'PROCEDURE', N'spx_StyleCostingTypeLogic_SELECT', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_dropextendedproperty N'MS_Orientation', 'SCHEMA', N'dbo', 'PROCEDURE', N'spx_StyleCostingTypeLogic_SELECT', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[iCustom10]'
GO
ALTER TABLE [dbo].[iCustom10] DROP CONSTRAINT [PK__iCustom10__65370702]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[iCustom11]'
GO
ALTER TABLE [dbo].[iCustom11] DROP CONSTRAINT [PK__iCustom11__1940BAED]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[iCustom12]'
GO
ALTER TABLE [dbo].[iCustom12] DROP CONSTRAINT [PK__iCustom12__44A01A3E]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[iCustom13]'
GO
ALTER TABLE [dbo].[iCustom13] DROP CONSTRAINT [PK__iCustom13__13F1F5EB]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[iCustom14]'
GO
ALTER TABLE [dbo].[iCustom14] DROP CONSTRAINT [PK__iCustom14__664B26CC]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[iCustom2]'
GO
ALTER TABLE [dbo].[iCustom2] DROP CONSTRAINT [PK__iCustom1__3D690CCA]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[iCustom3]'
GO
ALTER TABLE [dbo].[iCustom3] DROP CONSTRAINT [PK__iCustom3__0E240DFC]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[iCustom4]'
GO
ALTER TABLE [dbo].[iCustom4] DROP CONSTRAINT [PK__iCustom4__236943A5]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[iCustom5]'
GO
ALTER TABLE [dbo].[iCustom5] DROP CONSTRAINT [PK__iCustom5__2E90DD8E]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[iCustom6]'
GO
ALTER TABLE [dbo].[iCustom6] DROP CONSTRAINT [PK__iCustom5__450A2E92]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[iCustom7]'
GO
ALTER TABLE [dbo].[iCustom7] DROP CONSTRAINT [PK__iCustom7__4297D63B]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[iCustom8]'
GO
ALTER TABLE [dbo].[iCustom8] DROP CONSTRAINT [PK__iCustom8__50B0EB68]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[iCustom9]'
GO
ALTER TABLE [dbo].[iCustom9] DROP CONSTRAINT [PK__iCustom9__47A6A41B]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[iCustom91]'
GO
ALTER TABLE [dbo].[iCustom91] DROP CONSTRAINT [PK_iCustom91]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] DROP CONSTRAINT [PK_pLinePlanBusiness]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] DROP CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusLYCh1]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] DROP CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusLYCh2]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] DROP CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusLYCh3]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] DROP CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusLYCh4]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] DROP CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusLYCh5]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] DROP CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusPnCh1]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] DROP CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusPnCh2]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] DROP CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusPnCh3]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] DROP CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusPnCh4]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] DROP CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusPnCh5]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] DROP CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusCuCh1]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] DROP CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusCuCh2]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] DROP CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusCuCh3]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] DROP CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusCuCh4]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] DROP CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusCuCh5]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] DROP CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusLWpCh1]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] DROP CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusLWpCh2]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] DROP CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusLWpCh3]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] DROP CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusLWpCh4]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] DROP CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusLWpCh5]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] DROP CONSTRAINT [PK_pLinePlanBusinessItem]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] DROP CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusLYCh1]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] DROP CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusLYCh2]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] DROP CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusLYCh3]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] DROP CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusLYCh4]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] DROP CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusLYCh5]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] DROP CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusPnCh1]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] DROP CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusPnCh2]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] DROP CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusPnCh3]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] DROP CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusPnCh4]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] DROP CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusPnCh5]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] DROP CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusCuCh1]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] DROP CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusCuCh2]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] DROP CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusCuCh3]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] DROP CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusCuCh4]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] DROP CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusCuCh5]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] DROP CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusLWpCh1]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] DROP CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusLWpCh2]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] DROP CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusLWpCh3]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] DROP CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusLWpCh4]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] DROP CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusLWpCh5]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pSampleRequestSubmitStatus]'
GO
ALTER TABLE [dbo].[pSampleRequestSubmitStatus] DROP CONSTRAINT [PK__pSampleRequestSu__40AF8DC9]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pSeasonYear]'
GO
ALTER TABLE [dbo].[pSeasonYear] DROP CONSTRAINT [PK_pSeasonYear]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStitchType]'
GO
ALTER TABLE [dbo].[pStitchType] DROP CONSTRAINT [PK__pStitchType__68DFDCB9]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleColorStandard]'
GO
ALTER TABLE [dbo].[pStyleColorStandard] DROP CONSTRAINT [PK_pStyleColorStandard_1]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleColorStandard]'
GO
ALTER TABLE [dbo].[pStyleColorStandard] DROP CONSTRAINT [DF_pStyleColorStandard_Active]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleCosting]'
GO
ALTER TABLE [dbo].[pStyleCosting] DROP CONSTRAINT [PK_pStyleCosting]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleCosting]'
GO
ALTER TABLE [dbo].[pStyleCosting] DROP CONSTRAINT [DF_pStyleCosting_StyleCostingID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleCosting]'
GO
ALTER TABLE [dbo].[pStyleCosting] DROP CONSTRAINT [DF_pStyleCosting_Active]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleCosting]'
GO
ALTER TABLE [dbo].[pStyleCosting] DROP CONSTRAINT [DF_pStyleCosting_StyleColorwayID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleCostingDuty]'
GO
ALTER TABLE [dbo].[pStyleCostingDuty] DROP CONSTRAINT [PK_pStyleCostingDuty]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleCostingDuty]'
GO
ALTER TABLE [dbo].[pStyleCostingDuty] DROP CONSTRAINT [DF_pStyleCostingDuty_DutyId]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleQuoteItem]'
GO
ALTER TABLE [dbo].[pStyleQuoteItem] DROP CONSTRAINT [PK_pStyleQuoteItem]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleQuoteItem]'
GO
ALTER TABLE [dbo].[pStyleQuoteItem] DROP CONSTRAINT [DF_pStyleQuoteItem_StyleQuoteItemID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleQuoteItem]'
GO
ALTER TABLE [dbo].[pStyleQuoteItem] DROP CONSTRAINT [DF_pStyleQuoteItem_StyleQuoteItemShare]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleQuoteItem]'
GO
ALTER TABLE [dbo].[pStyleQuoteItem] DROP CONSTRAINT [DF_pStyleQuoteItem_AgentView]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleQuoteItemVersion]'
GO
ALTER TABLE [dbo].[pStyleQuoteItemVersion] DROP CONSTRAINT [PK_pStyleQuoteItemVersion]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleQuoteItemVersion]'
GO
ALTER TABLE [dbo].[pStyleQuoteItemVersion] DROP CONSTRAINT [DF_pStyleQuoteItemVersion_StyleQuoteItemVersionID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleQuoteItemVersion]'
GO
ALTER TABLE [dbo].[pStyleQuoteItemVersion] DROP CONSTRAINT [DF_pStyleQuoteItemVersion_Version]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleQuoteVariation]'
GO
ALTER TABLE [dbo].[pStyleQuoteVariation] DROP CONSTRAINT [PK_pStyleQuoteVariationID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleQuoteVariation]'
GO
ALTER TABLE [dbo].[pStyleQuoteVariation] DROP CONSTRAINT [DF_pStyleQuoteVariationID_StyleQuoteVariationID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleSourcing]'
GO
ALTER TABLE [dbo].[pStyleSourcing] DROP CONSTRAINT [PK_pStyleSourcing]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleSourcing]'
GO
ALTER TABLE [dbo].[pStyleSourcing] DROP CONSTRAINT [DF_pStyleSourcing_StyleSourcingID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[xCustom1]'
GO
ALTER TABLE [dbo].[xCustom1] DROP CONSTRAINT [PK__xxCustom1__77CAB889]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[xCustom10]'
GO
ALTER TABLE [dbo].[xCustom10] DROP CONSTRAINT [PK__xCustom10__6A518D31]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[xCustom11]'
GO
ALTER TABLE [dbo].[xCustom11] DROP CONSTRAINT [PK__xCustom11__50C5FA01]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[xCustom2]'
GO
ALTER TABLE [dbo].[xCustom2] DROP CONSTRAINT [PK__xCustom2__4FF1D159]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[xCustom20]'
GO
ALTER TABLE [dbo].[xCustom20] DROP CONSTRAINT [PK__xCustom20__7DB89C09]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[xCustom21]'
GO
ALTER TABLE [dbo].[xCustom21] DROP CONSTRAINT [PK__xCustom21__3B40CD36]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[xCustom3]'
GO
ALTER TABLE [dbo].[xCustom3] DROP CONSTRAINT [PK_pStyleCategory]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[xCustom4]'
GO
ALTER TABLE [dbo].[xCustom4] DROP CONSTRAINT [PK__xCustom4__1B7E091A]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[xCustom51]'
GO
ALTER TABLE [dbo].[xCustom51] DROP CONSTRAINT [PK__xCustom51__5C57A83E]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[xCustom52]'
GO
ALTER TABLE [dbo].[xCustom52] DROP CONSTRAINT [PK__xCustom52__11D4A34F]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[xCustom53]'
GO
ALTER TABLE [dbo].[xCustom53] DROP CONSTRAINT [PK__xCustom53__367C1819]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[xCustom54]'
GO
ALTER TABLE [dbo].[xCustom54] DROP CONSTRAINT [PK__xCustom54__08362A7C]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[xCustom6]'
GO
ALTER TABLE [dbo].[xCustom6] DROP CONSTRAINT [PK__xCustom6__74643BF9]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[xCustom7]'
GO
ALTER TABLE [dbo].[xCustom7] DROP CONSTRAINT [PK__xCustom7__11007AA7]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[xCustom9]'
GO
ALTER TABLE [dbo].[xCustom9] DROP CONSTRAINT [PK__xCustom9__3939548A]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[hImage_old_06112008]'
GO
ALTER TABLE [dbo].[hImage_old_06112008] DROP CONSTRAINT [PK__hImage_old_06112008__3AC275A0]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[hImage_old_06112008]'
GO
ALTER TABLE [dbo].[hImage_old_06112008] DROP CONSTRAINT [DF_hImage_old_06112008_ImageHistoryID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[iCustom1_old_06112008]'
GO
ALTER TABLE [dbo].[iCustom1_old_06112008] DROP CONSTRAINT [PK_iCustom1_old_06112008]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[iCustom1_old_06112008]'
GO
ALTER TABLE [dbo].[iCustom1_old_06112008] DROP CONSTRAINT [DF_iCustom1_old_06112008_CustomID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[iCustom1_old_06112008]'
GO
ALTER TABLE [dbo].[iCustom1_old_06112008] DROP CONSTRAINT [DF_iCustom1_old_06112008_Active]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerLabDip]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerLabDip] DROP CONSTRAINT [PK_pMaterialTradePartnerLabDip]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerLabDip]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerLabDip] DROP CONSTRAINT [DF_pMaterialTradePartnerLabDip_MaterialTradePartnerLabDipId]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerLabDipItem]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerLabDipItem] DROP CONSTRAINT [PK_pMaterialTradePartnerLabDipItem]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerLabDipItem]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerLabDipItem] DROP CONSTRAINT [DF_pMaterialTradePartnerLabDipItem_MaterialTradePartnerLabDipItemId]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerLabDipStatus]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerLabDipStatus] DROP CONSTRAINT [PK_pMaterialTradePartnerLabDipStatus]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerLabDipSubmit]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerLabDipSubmit] DROP CONSTRAINT [PK_pMaterialTradePartnerLabDipSubmit]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerLabDipSubmit]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerLabDipSubmit] DROP CONSTRAINT [DF_pMaterialTradePartnerLabDipSubmit_MaterialTradePartnerLabDipSubmitID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerLabDipSubmit]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerLabDipSubmit] DROP CONSTRAINT [DF_pMaterialTradePartnerLabDipSubmit_Submit]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerLabDipSubmitComment]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerLabDipSubmitComment] DROP CONSTRAINT [PK_pMaterialTradePartnerLabDipSubmitComment]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerLabDipSubmitDocument]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerLabDipSubmitDocument] DROP CONSTRAINT [PK_pMaterialTradePartnerLabDipSubmitImage]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerLabDipSubmitItem]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerLabDipSubmitItem] DROP CONSTRAINT [PK_pMaterialTradePartnerLabDipSubmitItem]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerLabDipSubmitItem]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerLabDipSubmitItem] DROP CONSTRAINT [DF_pMaterialTradePartnerLabDipSubmitItem_MaterialTradePartnerLabDipSubmitItemID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerTesting]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerTesting] DROP CONSTRAINT [PK_pMaterialTradePartnerTesting]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerTesting]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerTesting] DROP CONSTRAINT [DF_pMaterialTradePartnerTesting_MaterialTradePartnerTestingID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerTesting]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerTesting] DROP CONSTRAINT [DF_pMaterialTradePartnerTesting_MaterialTradePartnerLabDipSubmit]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerTestingSubmit]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerTestingSubmit] DROP CONSTRAINT [PK_pMaterialTradePartnerTestingSubmit]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerTestingSubmit]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerTestingSubmit] DROP CONSTRAINT [DF_pMaterialTradePartnerTestingSubmit_MaterialTradePartnerTestingSubmitID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerTestingSubmit]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerTestingSubmit] DROP CONSTRAINT [DF_pMaterialTradePartnerTestingSubmit_MaterialTradePartnerTestingSubmit1]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerTestingSubmitComment]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerTestingSubmitComment] DROP CONSTRAINT [PK_pMaterialTradePartnerTestingSubmitComment]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerTestingSubmitComment]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerTestingSubmitComment] DROP CONSTRAINT [DF_pMaterialTradePartnerTestingSubmitComment_MaterialTradePartnerTestingSubmitCommentID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerTestingSubmitDocument]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerTestingSubmitDocument] DROP CONSTRAINT [PK_pMaterialTradePartnerTestingSubmitDocument]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerTestingSubmitDocument]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerTestingSubmitDocument] DROP CONSTRAINT [DF_pMaterialTradePartnerTestingSubmitDocument_MaterialTradePartnerTestingSubmitDocumentID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerTestingSubmitItem]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerTestingSubmitItem] DROP CONSTRAINT [PK_pMaterialTradePartnerTestingSubmitItem]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerTestingSubmitItem]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerTestingSubmitItem] DROP CONSTRAINT [DF_pMaterialTradePartnerTestingSubmitItem_MaterialTradePartnerTestingSubmitItemID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerTestingType]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerTestingType] DROP CONSTRAINT [PK_pMaterialTradePartnerTestingType]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[cCalendarEvent]'
GO
ALTER TABLE [dbo].[cCalendarEvent] DROP CONSTRAINT [DF_cCalendarEvent_CalendarEventID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[cCalendarEvent]'
GO
ALTER TABLE [dbo].[cCalendarEvent] DROP CONSTRAINT [DF_cCalendarEvent_CDate]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[cCalendarEvent]'
GO
ALTER TABLE [dbo].[cCalendarEvent] DROP CONSTRAINT [DF_cCalendarEvent_MDate]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[hImage]'
GO
ALTER TABLE [dbo].[hImage] DROP CONSTRAINT [DF_hImage_SystemServerStorageID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pColorType]'
GO
ALTER TABLE [dbo].[pColorType] DROP CONSTRAINT [DF_pColorType_Active]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pImageType]'
GO
ALTER TABLE [dbo].[pImageType] DROP CONSTRAINT [DF_pImageType_Active]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanShowroomStyleColor]'
GO
ALTER TABLE [dbo].[pLinePlanShowroomStyleColor] DROP CONSTRAINT [DF_pLinePlanShowroomStyleColor_LinePlanShowroomStyleColorID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pLinePlanTemplate]'
GO
ALTER TABLE [dbo].[pLinePlanTemplate] DROP CONSTRAINT [DF_pLinePlanTemplate_Active]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialSize]'
GO
ALTER TABLE [dbo].[pMaterialSize] DROP CONSTRAINT [DF_pMaterialSize_MaterialSizeID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pMaterialTradePartnerColor]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerColor] DROP CONSTRAINT [DF_pMaterialTradePartnerColor_AgentView]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleCostingHeader]'
GO
ALTER TABLE [dbo].[pStyleCostingHeader] DROP CONSTRAINT [DF_pStyleCostingHeader_StyleCostingHeaderID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleDocument]'
GO
ALTER TABLE [dbo].[pStyleDocument] DROP CONSTRAINT [DF_pStyleDocument_SystemServerStorageID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleMaterialTemp]'
GO
ALTER TABLE [dbo].[pStyleMaterialTemp] DROP CONSTRAINT [DF_pStyleMaterialTemp_Colorway]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleMaterialTemp]'
GO
ALTER TABLE [dbo].[pStyleMaterialTemp] DROP CONSTRAINT [DF_pStyleMaterialTemp_MaterialTrack]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleMaterialTemp]'
GO
ALTER TABLE [dbo].[pStyleMaterialTemp] DROP CONSTRAINT [DF_pStyleMaterialTemp_MaterialLinked]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping constraints from [dbo].[pStyleSourcing_old_06112008]'
GO
ALTER TABLE [dbo].[pStyleSourcing_old_06112008] DROP CONSTRAINT [DF_pStyleSourcing_old_06112008_Active]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping trigger [dbo].[tgx_StyleHeader_DELETE] from [dbo].[pStyleHeader]'
GO
DROP TRIGGER [dbo].[tgx_StyleHeader_DELETE]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[rReportSubTable1_old_06112008]'
GO
DROP TABLE [dbo].[rReportSubTable1_old_06112008]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pStyleSpecSize_Backup_REC_4_4_08_T715]'
GO
DROP TABLE [dbo].[pStyleSpecSize_Backup_REC_4_4_08_T715]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pStyleSourcing_AGC]'
GO
DROP TABLE [dbo].[pStyleSourcing_AGC]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pStyleImageItem_Backup_REC_6_9_08]'
GO
DROP TABLE [dbo].[pStyleImageItem_Backup_REC_6_9_08]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pStyleHeader_BK]'
GO
DROP TABLE [dbo].[pStyleHeader_BK]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pStyleHeader_AGC]'
GO
DROP TABLE [dbo].[pStyleHeader_AGC]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pStyleColorway_AGC]'
GO
DROP TABLE [dbo].[pStyleColorway_AGC]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pMaterialTradePartnerLabDipStatus]'
GO
DROP TABLE [dbo].[pMaterialTradePartnerLabDipStatus]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pLinePlanItem_AGC]'
GO
DROP TABLE [dbo].[pLinePlanItem_AGC]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pImage_Backup_4_22_09]'
GO
DROP TABLE [dbo].[pImage_Backup_4_22_09]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pColorPalette_AGC]'
GO
DROP TABLE [dbo].[pColorPalette_AGC]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[iCustom200]'
GO
DROP TABLE [dbo].[iCustom200]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[iCustom101_old_06112008]'
GO
DROP TABLE [dbo].[iCustom101_old_06112008]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[icustom100]'
GO
DROP TABLE [dbo].[icustom100]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[hImage_Backup_4_22_09]'
GO
DROP TABLE [dbo].[hImage_Backup_4_22_09]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[ColorLibrary_AGC]'
GO
DROP TABLE [dbo].[ColorLibrary_AGC]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[dpx_SeasonYear_SKU_Count_SELECT]'
GO
DROP PROCEDURE [dbo].[dpx_SeasonYear_SKU_Count_SELECT]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[iCustom1_old_06112008]'
GO
DROP TABLE [dbo].[iCustom1_old_06112008]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pMaterialTradePartnerTesting]'
GO
DROP TABLE [dbo].[pMaterialTradePartnerTesting]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pMaterialTradePartnerTestingSubmitComment]'
GO
DROP TABLE [dbo].[pMaterialTradePartnerTestingSubmitComment]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pMaterialTradePartnerTestingSubmitDocument]'
GO
DROP TABLE [dbo].[pMaterialTradePartnerTestingSubmitDocument]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[spx_User_DesktopAccessLinePlanFolderCheck_INSERT]'
GO
DROP PROCEDURE [dbo].[spx_User_DesktopAccessLinePlanFolderCheck_INSERT]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pMaterialTradePartnerLabDipItem]'
GO
DROP TABLE [dbo].[pMaterialTradePartnerLabDipItem]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[spx_Users]'
GO
DROP PROCEDURE [dbo].[spx_Users]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[spx_User_AccessLinePlanFolder_SELECT]'
GO
DROP PROCEDURE [dbo].[spx_User_AccessLinePlanFolder_SELECT]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[dpx_SeasonYear_SKU_Count_Summary_SELECT]'
GO
DROP PROCEDURE [dbo].[dpx_SeasonYear_SKU_Count_Summary_SELECT]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pMaterialTradePartnerLabDipSubmitItem]'
GO
DROP TABLE [dbo].[pMaterialTradePartnerLabDipSubmitItem]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pMaterialTradePartnerLabDipSubmit]'
GO
DROP TABLE [dbo].[pMaterialTradePartnerLabDipSubmit]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[vwx_Material_AgentVendorTestingSubmitItem_SELECT]'
GO
DROP VIEW [dbo].[vwx_Material_AgentVendorTestingSubmitItem_SELECT]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pMaterialTradePartnerTestingSubmitItem]'
GO
DROP TABLE [dbo].[pMaterialTradePartnerTestingSubmitItem]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[vwx_Material_AgentVendorTestingSubmit_SELECT]'
GO
DROP VIEW [dbo].[vwx_Material_AgentVendorTestingSubmit_SELECT]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pMaterialTradePartnerTestingSubmit]'
GO
DROP TABLE [dbo].[pMaterialTradePartnerTestingSubmit]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pMaterialTradePartnerLabDip]'
GO
DROP TABLE [dbo].[pMaterialTradePartnerLabDip]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pStyleSourcing_old_06112008]'
GO
DROP TABLE [dbo].[pStyleSourcing_old_06112008]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[hImage_old_06112008]'
GO
DROP TABLE [dbo].[hImage_old_06112008]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pMaterialTradePartnerLabDipSubmitDocument]'
GO
DROP TABLE [dbo].[pMaterialTradePartnerLabDipSubmitDocument]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pMaterialTradePartnerLabDipSubmitComment]'
GO
DROP TABLE [dbo].[pMaterialTradePartnerLabDipSubmitComment]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pMaterialTradePartnerTestingStatus]'
GO
DROP TABLE [dbo].[pMaterialTradePartnerTestingStatus]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Dropping [dbo].[pMaterialTradePartnerTestingType]'
GO
DROP TABLE [dbo].[pMaterialTradePartnerTestingType]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pStyleColorwayTemp]'
GO
CREATE TABLE [dbo].[pStyleColorwayTemp]
(
[StyleID] [uniqueidentifier] NULL,
[NewStyleID] [uniqueidentifier] NULL,
[StyleColorwayID] [uniqueidentifier] NULL,
[StyleColorName] [varchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleSeason] [varchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleYear] [varchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleColorwayTemp_INSERT]'
GO

CREATE PROCEDURE [dbo].[spx_StyleColorwayTemp_INSERT]  (
	@StyleID uniqueidentifier
   ,@NewStyleID uniqueidentifier
   ,@StyleColorwayID uniqueidentifier
   ,@StyleColorName varchar(100)
   ,@StyleSeason varchar(100)
   ,@StyleYear varchar(100)
)
AS 


INSERT INTO pStyleColorwayTemp
           (StyleID
           ,NewStyleID
           ,StyleColorwayID
           ,StyleColorName
           ,StyleSeason
           ,StyleYear)
     VALUES
           (@StyleID
           ,@NewStyleID
           ,@StyleColorwayID
           ,@StyleColorName
           ,@StyleSeason
           ,@StyleYear)


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pLinePlanStyleAttributeItem]'
GO
CREATE TABLE [dbo].[pLinePlanStyleAttributeItem]
(
[LinePlanStyleAttributeItemID] [uniqueidentifier] NOT NULL,
[LineplanStyleAttributeID] [uniqueidentifier] NOT NULL,
[LinePlanAttributeTypeID] [int] NOT NULL,
[LinePlanID] [uniqueidentifier] NULL,
[LinePlanAttributeItemID1] [uniqueidentifier] NULL,
[LinePlanAttributeItemID2] [uniqueidentifier] NULL,
[LinePlanAttributeItemID3] [uniqueidentifier] NULL,
[LinePlanAttributeItemID4] [uniqueidentifier] NULL,
[AttributeID] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[AttributeName] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[LinePlanRangeID] [uniqueidentifier] NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pLinePlanShowroomStyle]'
GO
CREATE TABLE [dbo].[pLinePlanShowroomStyle]
(
[LinePlanShowroomStyleID] [uniqueidentifier] NULL,
[LinePlanRangeID] [uniqueidentifier] NULL,
[StyleID] [uniqueidentifier] NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pLinePlanRangeAttribute]'
GO
CREATE TABLE [dbo].[pLinePlanRangeAttribute]
(
[LinePlanRangeAttributeID] [uniqueidentifier] NOT NULL,
[LinePlanStyleAttributeItemID] [uniqueidentifier] NOT NULL,
[AttributeID] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
[AttributeName] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[LinePlanAttributeItemID1] [uniqueidentifier] NULL,
[LinePlanAttributeItemID2] [uniqueidentifier] NULL,
[LinePlanAttributeItemID3] [uniqueidentifier] NULL,
[LinePlanAttributeItemID4] [uniqueidentifier] NULL,
[LinePlanID] [uniqueidentifier] NOT NULL,
[LinePlanFinancialID] [uniqueidentifier] NOT NULL,
[LinePlanRange] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
[LinePlanRangeDelCO1] [int] NULL,
[LinePlanRangeDelNV1] [int] NULL,
[LinePlanRangeDelN1] [int] NULL,
[LinePlanRangeDelTL1] [int] NULL,
[LinePlanRangeDelCO2] [int] NULL,
[LinePlanRangeDelNV2] [int] NULL,
[LinePlanRangeDelN2] [int] NULL,
[LinePlanRangeDelTL2] [int] NULL,
[LinePlanRangeDelCO3] [int] NULL,
[LinePlanRangeDelNV3] [int] NULL,
[LinePlanRangeDelN3] [int] NULL,
[LinePlanRangeDelTL3] [int] NULL,
[LinePlanRangeDelCO4] [int] NULL,
[LinePlanRangeDelNV4] [int] NULL,
[LinePlanRangeDelN4] [int] NULL,
[LinePlanRangeDelTL4] [int] NULL,
[LinePlanRangeDelAVCO] [int] NULL,
[LinePlanRangeDelAVNV] [int] NULL,
[LinePlanRangeDelAVN] [int] NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[LinePlanFinancialSort] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pStyleDevelopmentItemTemp]'
GO
CREATE TABLE [dbo].[pStyleDevelopmentItemTemp]
(
[StyleDevelopmentItemID] [uniqueidentifier] NULL,
[StyleDevelopmentID] [uniqueidentifier] NULL,
[NewStyleDevelopmentID] [uniqueidentifier] NULL,
[StyleID] [uniqueidentifier] NULL,
[NewStyleID] [uniqueidentifier] NULL,
[StyleCopyType] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleDevelopmentName] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Variation] [int] NULL,
[DevNo] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[DevTempID] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[DevTempNo] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pLinePlanStyleAttribute]'
GO
CREATE TABLE [dbo].[pLinePlanStyleAttribute]
(
[LinePlanStyleAttributeID] [uniqueidentifier] NOT NULL,
[LinePlanAttributeTypeID] [int] NOT NULL,
[LinePlanID] [uniqueidentifier] NULL,
[AttributeID] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[AttributeName] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[fnx_GetStreamingColorImagePath]'
GO
/*
Comments:

General - Ryan Cabanas - September 23, 2009
	Pass the Color Folder ID and Color Palette ID and get the new Streaming Color
Image Path back.
*/


CREATE FUNCTION [dbo].[fnx_GetStreamingColorImagePath](
	@ColorFolderID uniqueidentifier
	,@ColorPaletteID uniqueidentifier
)

RETURNS nvarchar(255)

AS

BEGIN
	/*Declare variables.*/
	DECLARE @StreamingImagePath nvarchar(255)
	DECLARE @ImageServer nvarchar(200)
	DECLARE @ImageQualityValue nvarchar(5)

	/*Set image quality value.*/
	SET @ImageQualityValue = '100'

	/*Get Image Server path portion.*/
	SET @ImageServer = (SELECT TOP 1 SettingValue FROM rReportSetting WHERE SettingType = 'ImageServer')

	/*Build the path.*/
	SET @StreamingImagePath = @ImageServer + '/ColorStream.ashx?S=' + @ImageQualityValue + '&CFID=' + CAST(@ColorFolderID AS varchar(255)) + '&CPID=' + CAST(@ColorPaletteID AS varchar(255))

	/*Return.*/
	RETURN @StreamingImagePath
END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_FullFolderName]'
GO



ALTER PROCEDURE [dbo].[spx_FullFolderName] ( @UserId uniqueidentifier ,  @MessageFolderID int , @iOut int =  1, @Res varchar (2500) = '' out   ) 
AS

declare @FolderName as varchar (150)
-- declare @Res  as varchar (2500)
declare  @ParentID as  int 


	select @ParentID = 0 
	select  @Res   = ''

	select   @FolderName=FolderName,  @ParentID = ParentID
	FROM         dbo.eMessageFolder WITH (NOLOCK)
	WHERE     UserID = @UserId  and MessageFolderID = @MessageFolderID

	if @FolderName is not null 
	begin 
		select @Res = @FolderName

		while @ParentID != 0  
		begin
	
			select   @FolderName=FolderName,  @ParentID = ParentID
			FROM         dbo.eMessageFolder WITH (NOLOCK)
			WHERE     UserID = @UserId  and MessageFolderID = @ParentID

			select @Res =    @FolderName   + '/'  +  @Res
	
		end  
	end 
	
	if ( @iOut = 1 )
		select FolderName = @Res





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Crosstab]'
GO
ALTER PROCEDURE [dbo].[spx_Crosstab]
    @DBFetch varchar(4000),
    @DBWhere varchar(2000) = NULL,
    @DBPivot varchar(4000) = NULL,
    @DBField varchar(100),
    @PCField varchar(100),
    @PCBuild varchar( 20),
    @PCAdmin varchar( 20) = NULL,
    @DBAdmin int = 0,
    @DBTable varchar(100) = NULL,
    @DBWrite varchar(160) = NULL,
    @DBUltra bit = 0
AS

SET NOCOUNT ON

DECLARE @Return int
DECLARE @Retain int
DECLARE @Status int

SET @Status = 0

DECLARE @TPre varchar(10)

DECLARE @TDo3 tinyint
DECLARE @TDo4 tinyint

SET @TPre = 'tbl'

SET @TDo3 = LEN(@TPre)
SET @TDo4 = LEN(@TPre) + 1

DECLARE @DBAE varchar(40)

DECLARE @Task varchar(8000)

DECLARE @Bank varchar(4000)

DECLARE @Cash varchar(2000)

DECLARE @Rich varchar(2000)

DECLARE @DBAI varchar(4000)
DECLARE @DBAO varchar(8000)
DECLARE @DBAU varchar(2000)

DECLARE @Name varchar(100)
DECLARE @Same varchar(100)

DECLARE @Home varchar(160)

DECLARE @Some varchar(20)

DECLARE @Work int

DECLARE @Wink int

SET @DBAE = '##Crosstab' + RIGHT(CONVERT(varchar(10),@@SPID+100000),5)

SET @Task = 'IF EXISTS (SELECT * FROM tempdb.dbo.sysobjects WHERE name = ' + CHAR(39) + @DBAE + CHAR(39) + ') DROP TABLE ' + @DBAE


EXECUTE (@Task)

CREATE TABLE #DBAT (Work int IDENTITY(1,1), Name varchar(100))

SET @Bank = @TPre + @DBFetch

IF NOT EXISTS (SELECT * FROM sysobjects WHERE RTRIM(type) = 'U' AND name = @Bank)

    BEGIN

    SET @Bank = CASE WHEN LEFT(@DBFetch,6) = 'SELECT' THEN '(' + @DBFetch + ')' ELSE @DBFetch END
    SET @Bank = REPLACE(@Bank,         CHAR(94),CHAR(39))
    SET @Bank = REPLACE(@Bank,CHAR(45)+CHAR(45),CHAR(32))
    SET @Bank = REPLACE(@Bank,CHAR(47)+CHAR(42),CHAR(32))

    END

IF @DBWhere IS NOT NULL

    BEGIN

    SET @Cash = REPLACE(@DBWhere,'WHERE'       ,CHAR(32))
    SET @Cash = REPLACE(@Cash,         CHAR(94),CHAR(39))
    SET @Cash = REPLACE(@Cash,CHAR(45)+CHAR(45),CHAR(32))
    SET @Cash = REPLACE(@Cash,CHAR(47)+CHAR(42),CHAR(32))

    END

SET @DBField = REPLACE(@DBField,CHAR(32),CHAR(95))

SET @PCField = REPLACE(@PCField,CHAR(32),CHAR(95))

SET @PCBuild = REPLACE(@PCBuild,CHAR(32),CHAR(95))

SET @PCAdmin = REPLACE(@PCAdmin,CHAR(32),CHAR(95))

SET @DBTable = REPLACE(@DBTable,CHAR(32),CHAR(95))

SET @DBWrite = REPLACE(@DBWrite,CHAR(32),CHAR(95))

SET @DBWhere = CASE WHEN @DBWhere IS NULL THEN '' ELSE ' WHERE (' + @Cash + ') AND 0 = 0' END

SET @Some = ISNULL(@PCAdmin,'NA')

SET @Task = 'SELECT * INTO ' + @DBAE + ' FROM ' + @Bank + ' AS T WHERE 0 = 1'


IF @Status = 0 EXECUTE (@Task) SET @Return = @@ERROR

IF @Status = 0 SET @Status = @Return

IF @DBPivot IS NOT NULL

    BEGIN

    IF LEFT(@DBPivot,6) <> 'SELECT'

        BEGIN

        SET @Wink = 1

        SET @Work = CHARINDEX('|',(@DBPivot)+'|')

        WHILE @Work > 0

            BEGIN

            SET @Name = SUBSTRING(@DBPivot,@Wink,@Work-@Wink)

            INSERT #DBAT (Name) VALUES (@Name)

            SET @Wink = @Work + 1

            SET @Work = CHARINDEX('|',(@DBPivot)+'|',@Wink)

            END

        END

    ELSE

        BEGIN

        SET @Task = 'INSERT #DBAT (Name) ' + @DBPivot

        SET @Task = REPLACE(@Task,         CHAR(94),CHAR(39))
        SET @Task = REPLACE(@Task,CHAR(45)+CHAR(45),CHAR(32))
        SET @Task = REPLACE(@Task,CHAR(47)+CHAR(42),CHAR(32))


        IF @Status = 0 EXECUTE (@Task) SET @Return = @@ERROR

        IF @Status = 0 SET @Status = @Return

        END

    END

ELSE

    BEGIN

    SET @Task = '   INSERT #DBAT (Name)'
              + '   SELECT CONVERT(varchar(100),' + @DBField + ')'
              + '     FROM ' + @Bank + ' AS T ' + @DBWhere
              + ' GROUP BY CONVERT(varchar(100),' + @DBField + ')'
              + ' ORDER BY 1'

    IF @Status = 0 EXECUTE (@Task) SET @Return = @@ERROR

    IF @Status = 0 SET @Status = @Return

    END

UPDATE #DBAT SET Name = @Some WHERE Name IS NULL

SET @DBAI = ''

SET @DBAO = ''

SET @Rich = ''

 DECLARE Fields CURSOR FAST_FORWARD FOR
  SELECT C.name
    FROM tempdb.dbo.sysobjects AS O
    JOIN tempdb.dbo.syscolumns AS C
      ON C.id = O.id
     AND C.name != @DBField
     AND C.name != @PCField
     AND O.name  = @DBAE
ORDER BY C.colid

SET @Retain = @@ERROR IF @Status = 0 SET @Status = @Retain

OPEN Fields

SET @Retain = @@ERROR IF @Status = 0 SET @Status = @Retain

FETCH NEXT FROM Fields INTO @Same

SET @Retain = @@ERROR IF @Status = 0 SET @Status = @Retain

WHILE @@FETCH_STATUS = 0 AND @Status = 0

    BEGIN

    SET @DBAI = @DBAI + ', ' +  @Same

    FETCH NEXT FROM Fields INTO @Same

    SET @Retain = @@ERROR IF @Status = 0 SET @Status = @Retain

    END

CLOSE Fields DEALLOCATE Fields

SET @DBAI = SUBSTRING(@DBAI,3,4000)

 DECLARE Fields CURSOR FAST_FORWARD FOR
  SELECT  Name
    FROM #DBAT
ORDER BY  Work

OPEN Fields

FETCH NEXT FROM Fields INTO @Same

WHILE @@FETCH_STATUS = 0 AND @Status = 0

    BEGIN

    IF LEN(@DBAO) < 7900 - LEN(@DBField) - LEN(@PCField) - LEN(@Same) - LEN(@Same)

        BEGIN

        SET @DBAO = @DBAO + ', ' + @PCBuild + '(CASE WHEN ISNULL(CONVERT(varchar(100),' + @DBField + '),'
                          + CHAR(39) + @Some + CHAR(39) + ') = '
                          + CHAR(39) + @Same + CHAR(39) + ' THEN '
                          + @PCField + ' ELSE NULL END) AS '
                          + CHAR(91) + @Same + CHAR(93)

        END
        ELSE
        BEGIN

        SET @Status = 50000

        END

    FETCH NEXT FROM Fields INTO @Same

    END

CLOSE Fields DEALLOCATE Fields

IF @DBAdmin IN (1,3) SET @Rich = @Rich + ', ' + @PCBuild + '(' + @PCField + ') AS All_' + @PCBuild

IF @DBAdmin IN (2,3) SET @Rich = @Rich + ', COUNT('            + @PCField + ') AS All_COUNT'

IF @DBAdmin IN (2,3) SET @Rich = @Rich + ',   MIN('            + @PCField + ') AS All_MIN'

IF @DBAdmin IN (2,3) SET @Rich = @Rich + ',   MAX('            + @PCField + ') AS All_MAX'

SET ANSI_WARNINGS OFF

SET @Home = ''

SET @Name = ''

IF @DBTable IS NOT NULL

    BEGIN

    SET @Name = @DBTable

    IF LEFT(@Name,2) = '##'

        BEGIN

        IF @DBUltra = 0

            BEGIN

            SET @Task = 'IF EXISTS (SELECT * FROM   tempdb.dbo.sysobjects WHERE name = ' + CHAR(39) + @Name + CHAR(39) + ') DROP TABLE ' +         @Name

            IF @Status = 0 EXECUTE (@Task) SET @Return = @@ERROR

            IF @Status = 0 SET @Status = @Return

            END

        END

    ELSE

        BEGIN

        IF @DBWrite IS NOT NULL SET @Home = @DBWrite + '.dbo.'

        IF @DBUltra = 0

            BEGIN

            SET @Task = 'IF EXISTS (SELECT * FROM ' + @Home + 'sysobjects WHERE name = ' + CHAR(39) + @Name + CHAR(39) + ') DROP TABLE ' + @Home + @Name

            IF @Status = 0 EXECUTE (@Task) SET @Return = @@ERROR

            IF @Status = 0 SET @Status = @Return

            END

        END

    END

IF @DBTable IS NOT NULL

    BEGIN

    IF @DBUltra = 0

        BEGIN

        IF @Status = 0 EXECUTE ( '   SELECT ' + @DBAI + @DBAO + @Rich
                               + '     INTO ' + @Home + @Name
                               + '     FROM ' + @Bank + ' AS T ' + @DBWhere
                               + ' GROUP BY ' + @DBAI
                               + ' ORDER BY ' + @DBAI ) SET @Return = @@ERROR

        IF @Status = 0 SET @Status = @Return

        END

    ELSE

        BEGIN

        IF @Status = 0 EXECUTE ( '   INSERT ' + @Home + @Name
                               + '   SELECT ' + @DBAI + @DBAO + @Rich
                               + '     FROM ' + @Bank + ' AS T ' + @DBWhere
                               + ' GROUP BY ' + @DBAI
                               + ' ORDER BY ' + @DBAI ) SET @Return = @@ERROR

        IF @Status = 0 SET @Status = @Return

        END

    END

ELSE

    BEGIN

    IF @Status = 0 EXECUTE ( '   SELECT ' + @DBAI + @DBAO + @Rich
                           + '     FROM ' + @Bank + ' AS T ' + @DBWhere
                           + ' GROUP BY ' + @DBAI
                           + ' ORDER BY ' + @DBAI ) SET @Return = @@ERROR

    IF @Status = 0 SET @Status = @Return

    END

SET ANSI_WARNINGS ON

SET @Task = 'IF EXISTS (SELECT * FROM tempdb.dbo.sysobjects WHERE name = ' + CHAR(39) + @DBAE + CHAR(39) + ') DROP TABLE ' + @DBAE

EXECUTE (@Task)

DROP TABLE #DBAT

SET NOCOUNT OFF

RETURN (@Status)











GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pLinePlanStyleAttributeType2]'
GO
CREATE TABLE [dbo].[pLinePlanStyleAttributeType2]
(
[AttributeID] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[AttributeName] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[LinePlanAttributeTypeID] [int] NULL,
[SAPCode] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pLinePlanStyleAttributeType1]'
GO
CREATE TABLE [dbo].[pLinePlanStyleAttributeType1]
(
[AttributeID] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[AttributeName] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[LinePlanAttributeTypeID] [int] NULL,
[SAPCode] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[fnx_GetStreamingPOMImageSmallPath]'
GO
/*
Comments:

General - Ryan Cabanas - September 23, 2009
	Pass the POM Library ID and get the new Streaming Image Path
back for POM Images.

General - Ryan Cabanas - September 25, 2009
	Smaller image version of this procedure.
*/


CREATE FUNCTION [dbo].[fnx_GetStreamingPOMImageSmallPath](
	@POMLibraryID uniqueidentifier
)

RETURNS nvarchar(255)

AS

BEGIN
	/*Declare variables.*/
	DECLARE @StreamingImagePath nvarchar(255)
	DECLARE @ImageServer nvarchar(200)
	DECLARE @ImageQualityValue nvarchar(5)

	/*Set image quality value.*/
	SET @ImageQualityValue = '500'

	/*Get Image Server path portion.*/
	SET @ImageServer = (SELECT TOP 1 SettingValue FROM rReportSetting WHERE SettingType = 'ImageServer')

	/*Build the path.*/
	SET @StreamingImagePath = @ImageServer + '/ImageStream.ashx?IT=P&S=' + @ImageQualityValue + '&ID=' + CAST(@POMLibraryID AS varchar(255))

	/*Return.*/
	RETURN @StreamingImagePath
END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pLinePlanAttributeType]'
GO
CREATE TABLE [dbo].[pLinePlanAttributeType]
(
[LinePlanAttributeTypeID] [int] NULL,
[LinePlanAttributeType] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[SearchSchema] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[DefaultSchema] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pLinePlanItemTemp]'
GO
CREATE TABLE [dbo].[pLinePlanItemTemp]
(
[LinePlanItemID] [uniqueidentifier] NULL,
[LinePlanRangeID] [uniqueidentifier] NULL,
[StyleID] [uniqueidentifier] NULL,
[LinePlanStyleAttributeItemID] [uniqueidentifier] NULL,
[LinePlanRangeTypeID] [uniqueidentifier] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pLinePlanRangeAttributeTemp]'
GO
CREATE TABLE [dbo].[pLinePlanRangeAttributeTemp]
(
[LinePlanRangeAttributeID] [uniqueidentifier] NOT NULL,
[LinePlanStyleAttributeItemID] [uniqueidentifier] NOT NULL,
[AttributeID] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
[AttributeName] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[LinePlanAttributeItemID1] [uniqueidentifier] NULL,
[LinePlanAttributeItemID2] [uniqueidentifier] NULL,
[LinePlanAttributeItemID3] [uniqueidentifier] NULL,
[LinePlanAttributeItemID4] [uniqueidentifier] NULL,
[LinePlanID] [uniqueidentifier] NOT NULL,
[LinePlanFinancialID] [uniqueidentifier] NOT NULL,
[LinePlanRange] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
[LinePlanRangeDelCO1] [int] NULL,
[LinePlanRangeDelNV1] [int] NULL,
[LinePlanRangeDelN1] [int] NULL,
[LinePlanRangeDelTL1] [int] NULL,
[LinePlanRangeDelCO2] [int] NULL,
[LinePlanRangeDelNV2] [int] NULL,
[LinePlanRangeDelN2] [int] NULL,
[LinePlanRangeDelTL2] [int] NULL,
[LinePlanRangeDelCO3] [int] NULL,
[LinePlanRangeDelNV3] [int] NULL,
[LinePlanRangeDelN3] [int] NULL,
[LinePlanRangeDelTL3] [int] NULL,
[LinePlanRangeDelCO4] [int] NULL,
[LinePlanRangeDelNV4] [int] NULL,
[LinePlanRangeDelN4] [int] NULL,
[LinePlanRangeDelTL4] [int] NULL,
[LinePlanRangeDelAVCO] [int] NULL,
[LinePlanRangeDelAVNV] [int] NULL,
[LinePlanRangeDelAVN] [int] NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[LinePlanFinancialSort] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pBodyType]'
GO
ALTER TABLE [dbo].[pBodyType] ADD
[BodyTypeOrder] [int] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pBodyHistory]'
GO
CREATE TABLE [dbo].[pBodyHistory]
(
[BodyHistoryID] [int] NOT NULL IDENTITY(1, 1),
[BodyID] [uniqueidentifier] NULL,
[TeamID] [uniqueidentifier] NULL,
[CDate] [datetime] NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pBodyHistory] on [dbo].[pBodyHistory]'
GO
ALTER TABLE [dbo].[pBodyHistory] ADD CONSTRAINT [PK_pBodyHistory] PRIMARY KEY CLUSTERED  ([BodyHistoryID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_BodyHistory_INSERT]'
GO



CREATE PROCEDURE [dbo].[spx_BodyHistory_INSERT]
(@BodyId uniqueidentifier,
@TeamId uniqueidentifier,
@CreatedDate datetime)
AS 


IF (SELECT COUNT(*) FROM pBodyHistory WITH (NOLOCK) WHERE TeamID = @TeamID AND BodyId = @BodyId) = 0
	BEGIN
		INSERT INTO pBodyHistory  (BodyID, TeamID, CDate) VALUES ( @BodyID, @TeamID, @CreatedDate)
	END
Else
	BEGIN
		UPDATE pBodyHistory SET  CDate = @CreatedDate WHERE BodyID = @BodyID AND TeamID = @TeamID
	END

BEGIN
	DELETE FROM pBodyHistory WHERE TeamID = @TeamID AND  BodyID NOT IN (SELECT TOP 9 BodyID From pBodyHistory WITH (NOLOCK) WHERE TeamID = @TeamID ORDER BY CDate DESC)
END
	
	
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[fnx_int2StrDelivery]'
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE FUNCTION [dbo].[fnx_int2StrDelivery] (@X int) 	 
RETURNS varchar(10)
AS
BEGIN	
	DECLARE @Int2StrDelivery AS varchar(10)	
		
	If (@X = 1) 
	    SET @Int2StrDelivery = 'Yes' 
	Else
		SET @Int2StrDelivery = 'No'	
	
	RETURN @Int2StrDelivery 

END

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pMaterialRequestSubmitGroup]'
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pMaterialRequestSubmitGroup]
(
[MaterialRequestSubmitGroupID] [uniqueidentifier] NOT NULL,
[MaterialTradePartnerID] [uniqueidentifier] NULL,
[MaterialRequestWorkflowID] [varchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MaterialTradePartnerColorID] [uniqueidentifier] NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pMaterialRequestSubmitGroup] on [dbo].[pMaterialRequestSubmitGroup]'
GO
ALTER TABLE [dbo].[pMaterialRequestSubmitGroup] ADD CONSTRAINT [PK_pMaterialRequestSubmitGroup] PRIMARY KEY CLUSTERED  ([MaterialRequestSubmitGroupID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[fnx_GetStreamingImageSmallPath]'
GO
/*
Comments:

General - Ryan Cabanas - September 23, 2009
	Pass the Image Version and Image ID and get the new Streaming Image Path
back.

General - Ryan Cabanas - September 25, 2009
	Alternate version of function to give back lower quality for smaller images.
*/


CREATE FUNCTION [dbo].[fnx_GetStreamingImageSmallPath](
	@ImageID uniqueidentifier
	,@ImageVersion int
)

RETURNS nvarchar(255)

AS

BEGIN
	/*Declare variables.*/
	DECLARE @StreamingImagePath nvarchar(255)
	DECLARE @ImageServer nvarchar(200)
	DECLARE @ImageQualityValue nvarchar(5)

	/*Set image quality value.*/
	SET @ImageQualityValue = '500'

	/*Get Image Server path portion.*/
	SET @ImageServer = (SELECT TOP 1 SettingValue FROM rReportSetting WHERE SettingType = 'ImageServer')

	/*Build the path.*/
	SET @StreamingImagePath = @ImageServer + '/ImageStream.ashx?S=' + @ImageQualityValue + '&V=' + CAST(@ImageVersion AS varchar(5)) + '&IID=' + CAST(@ImageID AS varchar(255))

	/*Return.*/
	RETURN @StreamingImagePath
END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleMaterialSummary_UPDATE]'
GO
ALTER PROCEDURE [dbo].[spx_StyleMaterialSummary_UPDATE]
(
	@StyleMaterialID uniqueidentifier
	,@StyleID uniqueidentifier
	,@StyleSet int
	,@MUser nvarchar(200)
	,@MDate datetime
	,@SQLString varchar(8000)
)

AS

BEGIN

	EXEC(@SqlString)

END

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[fnx_GetStreamingImagePOMPath]'
GO
/*
Comments:

General - Ryan Cabanas - September 23, 2009
	Pass the POM Library ID and get the new Streaming Image Path
back for POM Images.
*/


CREATE FUNCTION [dbo].[fnx_GetStreamingImagePOMPath](
	@POMLibraryID uniqueidentifier
)

RETURNS nvarchar(255)

AS

BEGIN
	/*Declare variables.*/
	DECLARE @StreamingImagePath nvarchar(255)
	DECLARE @ImageServer nvarchar(200)
	DECLARE @ImageQualityValue nvarchar(5)

	/*Set image quality value.*/
	SET @ImageQualityValue = '2000'

	/*Get Image Server path portion.*/
	SET @ImageServer = (SELECT TOP 1 SettingValue FROM rReportSetting WHERE SettingType = 'ImageServer')

	/*Build the path.*/
	SET @StreamingImagePath = @ImageServer + '/ImageStream.ashx?IT=P&S=' + @ImageQualityValue + '&ID=' + CAST(@POMLibraryID AS varchar(255))

	/*Return.*/
	RETURN @StreamingImagePath
END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[fnx_GetStreamingSampleImagePath]'
GO
/*
Comments:

General - Ryan Cabanas - September 23, 2009
	Pass the Trade Partner Vendor ID, Sample Request Trade ID, Sample Request Submit
Image ID, and the Image ID and get the new Streaming Image Path back for Sample
attached images.
*/


CREATE FUNCTION [dbo].[fnx_GetStreamingSampleImagePath](
	@SampleRequestTradeID uniqueidentifier
	,@TradePartnerVendorID uniqueidentifier
	,@SampleRequestSubmitImageID uniqueidentifier
	,@ImageID uniqueidentifier
)

RETURNS nvarchar(255)

AS

BEGIN
	/*Declare variables.*/
	DECLARE @StreamingImagePath nvarchar(255)
	DECLARE @ImageServer nvarchar(200)
	DECLARE @ImageQualityValue nvarchar(5)

	/*Set image quality value.*/
	SET @ImageQualityValue = '2000'

	/*Get Image Server path portion.*/
	SET @ImageServer = (SELECT TOP 1 SettingValue FROM rReportSetting WHERE SettingType = 'ImageServer')

	/*Build the path.*/
	SET @StreamingImagePath =	@ImageServer
								+ '/ImageStream.ashx?IT=S&SRTID=' + CAST(@SampleRequestTradeID AS varchar(255))
								+ '&TPVID=' + CAST(@TradePartnerVendorID AS varchar(255))
								+ '&L=0&Comp=100&S=' + @ImageQualityValue
								+ '&SRSID=' + CAST(@SampleRequestSubmitImageID AS varchar(255))
								+ '&IID=' + CAST(@ImageID AS varchar(255))
								+ '&V=1'

	/*Return.*/
	RETURN @StreamingImagePath
END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[sSystemServerSetting]'
GO
ALTER TABLE [dbo].[sSystemServerSetting] ALTER COLUMN [SystemServerID] [uniqueidentifier] NOT NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_sSystemServerSetting] on [dbo].[sSystemServerSetting]'
GO
ALTER TABLE [dbo].[sSystemServerSetting] ADD CONSTRAINT [PK_sSystemServerSetting] PRIMARY KEY CLUSTERED  ([SystemServerID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteItemActivity_INSERT]'
GO


ALTER PROCEDURE [dbo].[spx_StyleQuoteItemActivity_INSERT]
(@StyleQuoteItemId uniqueidentifier,
@StyleQuoteId uniqueidentifier,
@StyleId uniqueidentifier,
@TeamId uniqueidentifier,
@TradePartner int,
@CreatedDate datetime,
@CreatedBy nvarchar(150),
@StyleQuoteActivityType nvarchar(2))
AS 

DECLARE @StyleQuoteActivityTypeDescription varchar(200)

IF @StyleQuoteActivityType = 'N'
	BEGIN
		SET @StyleQuoteActivityTypeDescription = 'New Quote' 
	END
ELSE IF	@StyleQuoteActivityType = 'A'
	BEGIN
		SET @StyleQuoteActivityTypeDescription = 'Quote Approved'
	END	
ELSE IF	@StyleQuoteActivityType = 'D'
	BEGIN
		SET @StyleQuoteActivityTypeDescription = 'Quote Dropped'
	END	
ELSE IF	@StyleQuoteActivityType = 'H'
	BEGIN
		SET @StyleQuoteActivityTypeDescription = 'Quote On Hold'
	END		
ELSE IF	@StyleQuoteActivityType = 'U'
	BEGIN
		SET @StyleQuoteActivityTypeDescription = 'Quote Updated'
	END	
ELSE IF	@StyleQuoteActivityType = 'F'
	BEGIN
		SET @StyleQuoteActivityTypeDescription = 'Fail Creating Quote'
	END	
ELSE IF	@StyleQuoteActivityType = 'V'
	BEGIN
		SET @StyleQuoteActivityTypeDescription = 'Quote Page Accessed'
	END		
ELSE
	BEGIN
		SET @StyleQuoteActivityTypeDescription = ''
	END
	
	
	
	IF @StyleQuoteActivityType <> 'V'
	BEGIN
		DELETE FROM pStyleQuoteItemActivity WHERE CONVERT(varchar(10),CDATE,101) = CONVERT(varchar(10),GETDATE(),101) AND TeamId = @TeamId AND ActivityType <> 'V' AND StyleQuoteItemId = @StyleQuoteItemId
		INSERT INTO pStyleQuoteItemActivity
			(StyleQuoteItemId, StyleQuoteId, StyleID, TeamID, TradePartner, CDate, CUser, StyleQuoteItemActivity, ActivityType)
		VALUES (@StyleQuoteItemId, @StyleQuoteId, @StyleId, @TeamId, @TradePartner, @CreatedDate, @CreatedBy, @StyleQuoteActivityTypeDescription, @StyleQuoteActivityType)		
	END
			
			
/*			
IF @StyleQuoteActivityTypeDescription <> ''
	BEGIN
	IF (SELECT COUNT(*) FROM pStyleQuoteItemActivity WITH (NOLOCK) WHERE CONVERT(varchar(10),CDATE,101) = CONVERT(varchar(10),GETDATE(),101) AND TeamId = @TeamId AND ActivityType = @StyleQuoteActivityType AND StyleQuoteItemId = @StyleQuoteItemId) <> 0
		IF	@StyleQuoteActivityType <> 'V'
			UPDATE pStyleQuoteItemActivity SET CDATE = GETDATE() WHERE TeamId = @TeamId AND TeamId = @TeamId AND ActivityType = @StyleQuoteActivityType AND StyleQuoteItemId = @StyleQuoteItemId	
		ELSE
			SELECT 1
	ELSE
		INSERT INTO pStyleQuoteItemActivity
			(StyleQuoteItemId, StyleQuoteId, StyleID, TeamID, TradePartner, CDate, CUser, StyleQuoteItemActivity, ActivityType)
		VALUES (@StyleQuoteItemId, @StyleQuoteId, @StyleId, @TeamId, @TradePartner, @CreatedDate, @CreatedBy, @StyleQuoteActivityTypeDescription, @StyleQuoteActivityType)
	END	
*/




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[vmx_LinePlanStyleAttribute_SEL]'
GO
CREATE VIEW  [dbo].[vmx_LinePlanStyleAttribute_SEL]
AS

	select * from pLinePlanStyleAttributeType1
	UNION 
	select * from pLinePlanStyleAttributeType2



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_PageUsageLog_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_User_PageUsageLog_INSERT]  (
	@TeamID  uniqueidentifier,
	@PageName varchar  (200) , 
	@VDate datetime 
)
AS

	DECLARE @PageUsageLogID  uniqueidentifier 
	
	SELECT @PageUsageLogID  =  PageUsageLogID   FROM uPageUsageLogID WITH (NOLOCK) WHERE TeamID = @TeamID AND PageName = @PageName 

	IF @PageUsageLogID IS NULL 
	BEGIN
		INSERT INTO  uPageUsageLog  ( PageUsageLogID, TeamID ,  PageName, VDate ) 
		VALUES ( newid() ,  @TeamID ,  @PageName,  @VDate ) 
	END
	ELSE
	BEGIN 
		UPDATE uPageUsageLog SET VDate  = @VDate  WHERE PageUsageLogID  = @PageUsageLogID 
	END








GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanItem_GroupItem_Check_INSERT]'
GO
ALTER PROCEDURE [dbo].[spx_LinePlanItem_GroupItem_Check_INSERT] ( 
@LinePlanGroupTypeID UNIQUEIDENTIFIER,
@LinePlanID UNIQUEIDENTIFIER,
@GroupItemName NVARCHAR (200 ) ,
@CUser NVARCHAR (200 ) ,
@CDate DATETIME 
)
AS 

DECLARE @LinePlanGroupTypeItemID AS UNIQUEIDENTIFIER 

SELECT @LinePlanGroupTypeItemID = LinePlanGroupTypeItemID 
FROM  pLinePlanGroupTypeItem WITH (NOLOCK)
WHERE LinePlanGroupTypeID  = @LinePlanGroupTypeID 
AND LinePlanID = @LinePlanID
AND LOWER(RTRIM(LTRIM(GroupItemName)))  = LOWER(RTRIM(LTRIM(@GroupItemName))) 


IF  @LinePlanGroupTypeItemID  IS NULL 
BEGIN
	SET @LinePlanGroupTypeItemID  = NEWID()
	INSERT INTO pLinePlanGroupTypeItem (LinePlanGroupTypeItemID , LinePlanID , LinePlanGroupTypeID , GroupItemName , CUser, CDate , MUser, MDate )
	VALUES (@LinePlanGroupTypeItemID , @LinePlanID , @LinePlanGroupTypeID , @GroupItemName , @CUser, @CDate , @CUser, @CDate )
END


SELECT LinePlanGroupTypeItemID  = @LinePlanGroupTypeItemID 






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[vwx_LinePlanStyleAttributeItem_SEL]'
GO
CREATE  VIEW [dbo].[vwx_LinePlanStyleAttributeItem_SEL]
AS
SELECT b.LinePlanAttributeType  , a.* 
FROM pLinePlanStyleAttributeItem a
INNER JOIN pLinePlanAttributeType b ON a.LinePlanAttributeTypeID = b.LinePlanAttributeTypeID



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanStyleAttribute_INSERT]'
GO
CREATE PROCEDURE [dbo].[spx_LinePlanStyleAttribute_INSERT]  (
@AttributeID NVARCHAR(200) , 
@LinePlanID  UNIQUEIDENTIFIER, 
@LinePlanAttributeTypeID INT, 
@AttributeName NVARCHAR(200),
@CUser NVARCHAR(200),
@CDate DATETIME 
)
AS


IF ( 
SELECT  COUNT(*) FROM pLinePlanStyleAttribute 
WHERE LinePlanID = @LinePlanID AND ( AttributeName = @AttributeName  OR AttributeID = @AttributeID ) ) =  0 
	INSERT INTO pLinePlanStyleAttribute ( LinePlanStyleAttributeID , LinePlanAttributeTypeID , LinePlanID , AttributeID, 
	AttributeName, CUser, CDate, MUSer, MDate)
	VALUES ( NEWID() , @LinePlanAttributeTypeID , @LinePlanID , @AttributeID, 
	@AttributeName, @CUser, @CDate,@CUser, @CDate )







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pStyleSourcingColor]'
GO
CREATE TABLE [dbo].[pStyleSourcingColor]
(
[StyleSourcingColorID] [uniqueidentifier] NOT NULL,
[StyleSourcingID] [uniqueidentifier] NOT NULL,
[StyleColorID] [uniqueidentifier] NOT NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[ColorCustom1] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ColorCustom2] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ColorCustom3] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pStyleSourcingColor] on [dbo].[pStyleSourcingColor]'
GO
ALTER TABLE [dbo].[pStyleSourcingColor] ADD CONSTRAINT [PK_pStyleSourcingColor] PRIMARY KEY CLUSTERED  ([StyleSourcingColorID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleSourcingColor_CHECK_SELECT]'
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE PROCEDURE dbo.spx_StyleSourcingColor_CHECK_SELECT(
@StyleSourcingID UNIQUEIDENTIFIER,
@StyleColorID UNIQUEIDENTIFIER
)
AS

DECLARE  @StyleSourcingColorID UNIQUEIDENTIFIER 

SELECT @StyleSourcingColorID = StyleSourcingColorID 
FROM pStyleSourcingColor
WHERE StyleSourcingID = @StyleSourcingID 
AND StyleColorID = @StyleColorID 


IF @StyleSourcingColorID IS NULL 
BEGIN 
	SET @StyleSourcingColorID = NEWID()

	INSERT INTO pStyleSourcingColor  ( StyleSourcingColorID , StyleSourcingID, StyleColorID ) 
	VALUES ( @StyleSourcingColorID, @StyleSourcingID, @StyleColorID )
END 

SELECT @StyleSourcingColorID AS StyleSourcingColorID 


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[iCustom13]'
GO
ALTER TABLE [dbo].[iCustom13] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_iCustom13_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_iCustom13] on [dbo].[iCustom13]'
GO
ALTER TABLE [dbo].[iCustom13] ADD CONSTRAINT [PK_iCustom13] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[ACustom1]'
GO
ALTER TABLE [dbo].[ACustom1] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_ACustom1_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_ACustom1] on [dbo].[ACustom1]'
GO
ALTER TABLE [dbo].[ACustom1] ADD CONSTRAINT [PK_ACustom1] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[ACustom10]'
GO
ALTER TABLE [dbo].[ACustom10] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_ACustom10_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_ACustom10] on [dbo].[ACustom10]'
GO
ALTER TABLE [dbo].[ACustom10] ADD CONSTRAINT [PK_ACustom10] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[ACustom11]'
GO
ALTER TABLE [dbo].[ACustom11] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_ACustom11_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_ACustom11] on [dbo].[ACustom11]'
GO
ALTER TABLE [dbo].[ACustom11] ADD CONSTRAINT [PK_ACustom11] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[ACustom13]'
GO
ALTER TABLE [dbo].[ACustom13] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_ACustom13_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_ACustom13] on [dbo].[ACustom13]'
GO
ALTER TABLE [dbo].[ACustom13] ADD CONSTRAINT [PK_ACustom13] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[ACustom14]'
GO
ALTER TABLE [dbo].[ACustom14] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_ACustom14_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_ACustom14] on [dbo].[ACustom14]'
GO
ALTER TABLE [dbo].[ACustom14] ADD CONSTRAINT [PK_ACustom14] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[ACustom15]'
GO
ALTER TABLE [dbo].[ACustom15] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_ACustom15_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_ACustom15] on [dbo].[ACustom15]'
GO
ALTER TABLE [dbo].[ACustom15] ADD CONSTRAINT [PK_ACustom15] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[ACustom2]'
GO
ALTER TABLE [dbo].[ACustom2] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_ACustom2_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_ACustom2] on [dbo].[ACustom2]'
GO
ALTER TABLE [dbo].[ACustom2] ADD CONSTRAINT [PK_ACustom2] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[ACustom3]'
GO
ALTER TABLE [dbo].[ACustom3] ADD
[CustomSort1] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_ACustom3_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_ACustom3] on [dbo].[ACustom3]'
GO
ALTER TABLE [dbo].[ACustom3] ADD CONSTRAINT [PK_ACustom3] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[ACustom4]'
GO
ALTER TABLE [dbo].[ACustom4] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_ACustom4_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_ACustom4] on [dbo].[ACustom4]'
GO
ALTER TABLE [dbo].[ACustom4] ADD CONSTRAINT [PK_ACustom4] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[xCustom10]'
GO
ALTER TABLE [dbo].[xCustom10] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_xCustom10_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_xCustom10] on [dbo].[xCustom10]'
GO
ALTER TABLE [dbo].[xCustom10] ADD CONSTRAINT [PK_xCustom10] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[ACustom5]'
GO
ALTER TABLE [dbo].[ACustom5] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_ACustom5_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_ACustom5] on [dbo].[ACustom5]'
GO
ALTER TABLE [dbo].[ACustom5] ADD CONSTRAINT [PK_ACustom5] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[ACustom6]'
GO
ALTER TABLE [dbo].[ACustom6] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_ACustom6_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_ACustom6] on [dbo].[ACustom6]'
GO
ALTER TABLE [dbo].[ACustom6] ADD CONSTRAINT [PK_ACustom6] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[ACustom7]'
GO
ALTER TABLE [dbo].[ACustom7] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_ACustom7_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_ACustom7] on [dbo].[ACustom7]'
GO
ALTER TABLE [dbo].[ACustom7] ADD CONSTRAINT [PK_ACustom7] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[ACustom8]'
GO
ALTER TABLE [dbo].[ACustom8] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_ACustom8_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_ACustom8] on [dbo].[ACustom8]'
GO
ALTER TABLE [dbo].[ACustom8] ADD CONSTRAINT [PK_ACustom8] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[ACustom9]'
GO
ALTER TABLE [dbo].[ACustom9] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_ACustom9_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_ACustom9] on [dbo].[ACustom9]'
GO
ALTER TABLE [dbo].[ACustom9] ADD CONSTRAINT [PK_ACustom9] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[FCustom1]'
GO
ALTER TABLE [dbo].[FCustom1] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_FCustom1_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_FCustom1] on [dbo].[FCustom1]'
GO
ALTER TABLE [dbo].[FCustom1] ADD CONSTRAINT [PK_FCustom1] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[FCustom10]'
GO
ALTER TABLE [dbo].[FCustom10] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_FCustom10_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_FCustom10] on [dbo].[FCustom10]'
GO
ALTER TABLE [dbo].[FCustom10] ADD CONSTRAINT [PK_FCustom10] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[FCustom11]'
GO
ALTER TABLE [dbo].[FCustom11] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_FCustom11_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_FCustom11] on [dbo].[FCustom11]'
GO
ALTER TABLE [dbo].[FCustom11] ADD CONSTRAINT [PK_FCustom11] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[FCustom12]'
GO
ALTER TABLE [dbo].[FCustom12] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_FCustom12_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_FCustom12] on [dbo].[FCustom12]'
GO
ALTER TABLE [dbo].[FCustom12] ADD CONSTRAINT [PK_FCustom12] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[FCustom13]'
GO
ALTER TABLE [dbo].[FCustom13] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_FCustom13_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_FCustom13] on [dbo].[FCustom13]'
GO
ALTER TABLE [dbo].[FCustom13] ADD CONSTRAINT [PK_FCustom13] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[FCustom14]'
GO
ALTER TABLE [dbo].[FCustom14] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_FCustom14_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_FCustom14] on [dbo].[FCustom14]'
GO
ALTER TABLE [dbo].[FCustom14] ADD CONSTRAINT [PK_FCustom14] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[FCustom15]'
GO
ALTER TABLE [dbo].[FCustom15] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_FCustom15_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_FCustom15] on [dbo].[FCustom15]'
GO
ALTER TABLE [dbo].[FCustom15] ADD CONSTRAINT [PK_FCustom15] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[FCustom2]'
GO
ALTER TABLE [dbo].[FCustom2] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_FCustom2_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_FCustom2] on [dbo].[FCustom2]'
GO
ALTER TABLE [dbo].[FCustom2] ADD CONSTRAINT [PK_FCustom2] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[FCustom3]'
GO
ALTER TABLE [dbo].[FCustom3] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_FCustom3_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_FCustom3] on [dbo].[FCustom3]'
GO
ALTER TABLE [dbo].[FCustom3] ADD CONSTRAINT [PK_FCustom3] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[FCustom4]'
GO
ALTER TABLE [dbo].[FCustom4] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_FCustom4_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_FCustom4] on [dbo].[FCustom4]'
GO
ALTER TABLE [dbo].[FCustom4] ADD CONSTRAINT [PK_FCustom4] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[iCustom14]'
GO
ALTER TABLE [dbo].[iCustom14] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_iCustom14_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_iCustom14] on [dbo].[iCustom14]'
GO
ALTER TABLE [dbo].[iCustom14] ADD CONSTRAINT [PK_iCustom14] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[FCustom5]'
GO
ALTER TABLE [dbo].[FCustom5] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_FCustom5_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_FCustom5] on [dbo].[FCustom5]'
GO
ALTER TABLE [dbo].[FCustom5] ADD CONSTRAINT [PK_FCustom5] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[FCustom6]'
GO
ALTER TABLE [dbo].[FCustom6] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_FCustom6_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_FCustom6] on [dbo].[FCustom6]'
GO
ALTER TABLE [dbo].[FCustom6] ADD CONSTRAINT [PK_FCustom6] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[FCustom7]'
GO
ALTER TABLE [dbo].[FCustom7] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_FCustom7_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_FCustom7] on [dbo].[FCustom7]'
GO
ALTER TABLE [dbo].[FCustom7] ADD CONSTRAINT [PK_FCustom7] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[FCustom8]'
GO
ALTER TABLE [dbo].[FCustom8] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_FCustom8_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_FCustom8] on [dbo].[FCustom8]'
GO
ALTER TABLE [dbo].[FCustom8] ADD CONSTRAINT [PK_FCustom8] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[xCustom29]'
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[xCustom29]
(
[Custom] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
[CustomKey] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Custom1] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Active] [int] NULL,
[CUser] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_xCustom29_CustomID] DEFAULT (newid()),
[CustomSort] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_xCustom29] on [dbo].[xCustom29]'
GO
ALTER TABLE [dbo].[xCustom29] ADD CONSTRAINT [PK_xCustom29] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[FCustom9]'
GO
ALTER TABLE [dbo].[FCustom9] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_FCustom9_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_FCustom9] on [dbo].[FCustom9]'
GO
ALTER TABLE [dbo].[FCustom9] ADD CONSTRAINT [PK_FCustom9] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[xCustom26]'
GO
CREATE TABLE [dbo].[xCustom26]
(
[Custom] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
[CustomKey] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Custom1] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Active] [int] NULL,
[CUser] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_xCustom26_CustomID] DEFAULT (newid()),
[CustomSort] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_xCustom26] on [dbo].[xCustom26]'
GO
ALTER TABLE [dbo].[xCustom26] ADD CONSTRAINT [PK_xCustom26] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[HCustom1]'
GO
ALTER TABLE [dbo].[HCustom1] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_HCustom1_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_HCustom1] on [dbo].[HCustom1]'
GO
ALTER TABLE [dbo].[HCustom1] ADD CONSTRAINT [PK_HCustom1] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[xCustom99]'
GO
CREATE TABLE [dbo].[xCustom99]
(
[CustomID] [uniqueidentifier] NULL CONSTRAINT [DF_xCustom99_CustomID] DEFAULT (newid()),
[Custom] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
[CustomKey] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Custom1] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Active] [int] NULL,
[CUser] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[CustomSort] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[HCustom10]'
GO
ALTER TABLE [dbo].[HCustom10] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_HCustom10_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_HCustom10] on [dbo].[HCustom10]'
GO
ALTER TABLE [dbo].[HCustom10] ADD CONSTRAINT [PK_HCustom10] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[HCustom11]'
GO
ALTER TABLE [dbo].[HCustom11] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_HCustom11_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_HCustom11] on [dbo].[HCustom11]'
GO
ALTER TABLE [dbo].[HCustom11] ADD CONSTRAINT [PK_HCustom11] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[HCustom12]'
GO
ALTER TABLE [dbo].[HCustom12] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_HCustom12_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_HCustom12] on [dbo].[HCustom12]'
GO
ALTER TABLE [dbo].[HCustom12] ADD CONSTRAINT [PK_HCustom12] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[HCustom13]'
GO
ALTER TABLE [dbo].[HCustom13] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_HCustom13_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_HCustom13] on [dbo].[HCustom13]'
GO
ALTER TABLE [dbo].[HCustom13] ADD CONSTRAINT [PK_HCustom13] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[HCustom14]'
GO
ALTER TABLE [dbo].[HCustom14] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_HCustom14_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_HCustom14] on [dbo].[HCustom14]'
GO
ALTER TABLE [dbo].[HCustom14] ADD CONSTRAINT [PK_HCustom14] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[HCustom15]'
GO
ALTER TABLE [dbo].[HCustom15] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_HCustom15_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_HCustom15] on [dbo].[HCustom15]'
GO
ALTER TABLE [dbo].[HCustom15] ADD CONSTRAINT [PK_HCustom15] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[HCustom2]'
GO
ALTER TABLE [dbo].[HCustom2] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_HCustom2_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_HCustom2] on [dbo].[HCustom2]'
GO
ALTER TABLE [dbo].[HCustom2] ADD CONSTRAINT [PK_HCustom2] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[HCustom3]'
GO
ALTER TABLE [dbo].[HCustom3] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_HCustom3_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_HCustom3] on [dbo].[HCustom3]'
GO
ALTER TABLE [dbo].[HCustom3] ADD CONSTRAINT [PK_HCustom3] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[HCustom4]'
GO
ALTER TABLE [dbo].[HCustom4] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_HCustom4_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_HCustom4] on [dbo].[HCustom4]'
GO
ALTER TABLE [dbo].[HCustom4] ADD CONSTRAINT [PK_HCustom4] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[HCustom5]'
GO
ALTER TABLE [dbo].[HCustom5] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_HCustom5_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_HCustom5] on [dbo].[HCustom5]'
GO
ALTER TABLE [dbo].[HCustom5] ADD CONSTRAINT [PK_HCustom5] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[HCustom6]'
GO
ALTER TABLE [dbo].[HCustom6] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_HCustom6_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_HCustom6] on [dbo].[HCustom6]'
GO
ALTER TABLE [dbo].[HCustom6] ADD CONSTRAINT [PK_HCustom6] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[HCustom7]'
GO
ALTER TABLE [dbo].[HCustom7] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_HCustom7_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_HCustom7] on [dbo].[HCustom7]'
GO
ALTER TABLE [dbo].[HCustom7] ADD CONSTRAINT [PK_HCustom7] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rReportMaterialHeaderTemp]'
GO
CREATE TABLE [dbo].[rReportMaterialHeaderTemp]
(
[ReportMaterialHeaderTempId] [int] NOT NULL IDENTITY(1, 1),
[DataXmlId] [uniqueidentifier] NOT NULL,
[DataColumnNumber] [int] NULL,
[DataColumnName] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[DataHeader] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[DataValue] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[DataSort] [varchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL CONSTRAINT [DF_rReportMaterialHeaderTemp_CDate] DEFAULT (getdate())
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_rReportMaterialHeaderTemp] on [dbo].[rReportMaterialHeaderTemp]'
GO
ALTER TABLE [dbo].[rReportMaterialHeaderTemp] ADD CONSTRAINT [PK_rReportMaterialHeaderTemp] PRIMARY KEY CLUSTERED  ([ReportMaterialHeaderTempId])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[HCustom8]'
GO
ALTER TABLE [dbo].[HCustom8] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_HCustom8_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_HCustom8] on [dbo].[HCustom8]'
GO
ALTER TABLE [dbo].[HCustom8] ADD CONSTRAINT [PK_HCustom8] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[HCustom9]'
GO
ALTER TABLE [dbo].[HCustom9] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_HCustom9_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_HCustom9] on [dbo].[HCustom9]'
GO
ALTER TABLE [dbo].[HCustom9] ADD CONSTRAINT [PK_HCustom9] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[xCustom52]'
GO
ALTER TABLE [dbo].[xCustom52] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_xCustom52_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_xCustom52] on [dbo].[xCustom52]'
GO
ALTER TABLE [dbo].[xCustom52] ADD CONSTRAINT [PK_xCustom52] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[jCustom1]'
GO
ALTER TABLE [dbo].[jCustom1] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_jCustom1_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_jCustom1] on [dbo].[jCustom1]'
GO
ALTER TABLE [dbo].[jCustom1] ADD CONSTRAINT [PK_jCustom1] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[jCustom2]'
GO
ALTER TABLE [dbo].[jCustom2] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_jCustom2_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_jCustom2] on [dbo].[jCustom2]'
GO
ALTER TABLE [dbo].[jCustom2] ADD CONSTRAINT [PK_jCustom2] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[xCustom6]'
GO
ALTER TABLE [dbo].[xCustom6] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_xCustom6_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_xCustom6] on [dbo].[xCustom6]'
GO
ALTER TABLE [dbo].[xCustom6] ADD CONSTRAINT [PK_xCustom6] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[jCustom3]'
GO
ALTER TABLE [dbo].[jCustom3] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_jCustom3_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_jCustom3] on [dbo].[jCustom3]'
GO
ALTER TABLE [dbo].[jCustom3] ADD CONSTRAINT [PK_jCustom3] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[jCustom4]'
GO
ALTER TABLE [dbo].[jCustom4] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_jCustom4_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_jCustom4] on [dbo].[jCustom4]'
GO
ALTER TABLE [dbo].[jCustom4] ADD CONSTRAINT [PK_jCustom4] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[xCustom7]'
GO
ALTER TABLE [dbo].[xCustom7] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_xCustom7_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_xCustom7] on [dbo].[xCustom7]'
GO
ALTER TABLE [dbo].[xCustom7] ADD CONSTRAINT [PK_xCustom7] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[jCustom5]'
GO
ALTER TABLE [dbo].[jCustom5] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_jCustom5_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_jCustom5] on [dbo].[jCustom5]'
GO
ALTER TABLE [dbo].[jCustom5] ADD CONSTRAINT [PK_jCustom5] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[jCustom6]'
GO
ALTER TABLE [dbo].[jCustom6] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_jCustom6_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_jCustom6] on [dbo].[jCustom6]'
GO
ALTER TABLE [dbo].[jCustom6] ADD CONSTRAINT [PK_jCustom6] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[iCustom4]'
GO
ALTER TABLE [dbo].[iCustom4] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_iCustom4_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_iCustom4] on [dbo].[iCustom4]'
GO
ALTER TABLE [dbo].[iCustom4] ADD CONSTRAINT [PK_iCustom4] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[jCustom7]'
GO
ALTER TABLE [dbo].[jCustom7] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_jCustom7_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_jCustom7] on [dbo].[jCustom7]'
GO
ALTER TABLE [dbo].[jCustom7] ADD CONSTRAINT [PK_jCustom7] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[iCustom101]'
GO
ALTER TABLE [dbo].[iCustom101] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_iCustom101_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_iCustom101] on [dbo].[iCustom101]'
GO
ALTER TABLE [dbo].[iCustom101] ADD CONSTRAINT [PK_iCustom101] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[xCustom4]'
GO
ALTER TABLE [dbo].[xCustom4] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_xCustom4_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_xCustom4] on [dbo].[xCustom4]'
GO
ALTER TABLE [dbo].[xCustom4] ADD CONSTRAINT [PK_xCustom4] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[iCustom5]'
GO
ALTER TABLE [dbo].[iCustom5] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_iCustom5_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_iCustom5] on [dbo].[iCustom5]'
GO
ALTER TABLE [dbo].[iCustom5] ADD CONSTRAINT [PK_iCustom5] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[xCustom11]'
GO
ALTER TABLE [dbo].[xCustom11] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_xCustom11_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_xCustom11] on [dbo].[xCustom11]'
GO
ALTER TABLE [dbo].[xCustom11] ADD CONSTRAINT [PK_xCustom11] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[sSystemButtons]'
GO
CREATE TABLE [dbo].[sSystemButtons]
(
[SystemButtonID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_sSystemButtons_SystemButtonID] DEFAULT (newsequentialid()),
[ButtonIcon] [varchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ButtonType] [varchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[DesignString] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[da_DK] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[de_DE] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[en_US] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[en_GB] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[en_CA] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[fr_FR] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[fr_CA] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[es_ES] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[es_MX] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[hi_IN] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[it_IT] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ja_JA] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ko_KR] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[nl_NL] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[pl_PL] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[pt_PT] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[pt_BR] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ru_RU] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[sv_FI] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[sv_SE] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[tr_TR] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[zh_CHS] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[zh_CHT] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_sSystemButtons] on [dbo].[sSystemButtons]'
GO
ALTER TABLE [dbo].[sSystemButtons] ADD CONSTRAINT [PK_sSystemButtons] PRIMARY KEY CLUSTERED  ([SystemButtonID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[iCustom7]'
GO
ALTER TABLE [dbo].[iCustom7] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_iCustom7_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_iCustom7] on [dbo].[iCustom7]'
GO
ALTER TABLE [dbo].[iCustom7] ADD CONSTRAINT [PK_iCustom7] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pStyleColorwaySampleStatus]'
GO
CREATE TABLE [dbo].[pStyleColorwaySampleStatus]
(
[StatusID] [int] NOT NULL,
[Status] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Active] [int] NULL CONSTRAINT [DF_pStyleColorwaySampleStatus_Active] DEFAULT ((1)),
[StatusIconUrl] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Custom] [int] NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pStyleColorwaySampleStatus] on [dbo].[pStyleColorwaySampleStatus]'
GO
ALTER TABLE [dbo].[pStyleColorwaySampleStatus] ADD CONSTRAINT [PK_pStyleColorwaySampleStatus] PRIMARY KEY CLUSTERED  ([StatusID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[xCustom51]'
GO
ALTER TABLE [dbo].[xCustom51] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_xCustom51_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_xCustom51] on [dbo].[xCustom51]'
GO
ALTER TABLE [dbo].[xCustom51] ADD CONSTRAINT [PK_xCustom51] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[xCustom1]'
GO
ALTER TABLE [dbo].[xCustom1] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_xCustom1_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_xCustom1] on [dbo].[xCustom1]'
GO
ALTER TABLE [dbo].[xCustom1] ADD CONSTRAINT [PK_xCustom1] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[iCustom6]'
GO
ALTER TABLE [dbo].[iCustom6] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_iCustom6_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_iCustom6] on [dbo].[iCustom6]'
GO
ALTER TABLE [dbo].[iCustom6] ADD CONSTRAINT [PK_iCustom6] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[xCustom20]'
GO
ALTER TABLE [dbo].[xCustom20] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_xCustom20_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_xCustom20] on [dbo].[xCustom20]'
GO
ALTER TABLE [dbo].[xCustom20] ADD CONSTRAINT [PK_xCustom20] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pStitchType]'
GO
ALTER TABLE [dbo].[pStitchType] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_pStitchType_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pStitchType] on [dbo].[pStitchType]'
GO
ALTER TABLE [dbo].[pStitchType] ADD CONSTRAINT [PK_pStitchType] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[xCustom53]'
GO
ALTER TABLE [dbo].[xCustom53] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_xCustom53_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_xCustom53] on [dbo].[xCustom53]'
GO
ALTER TABLE [dbo].[xCustom53] ADD CONSTRAINT [PK_xCustom53] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[xCustom21]'
GO
ALTER TABLE [dbo].[xCustom21] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_xCustom21_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_xCustom21] on [dbo].[xCustom21]'
GO
ALTER TABLE [dbo].[xCustom21] ADD CONSTRAINT [PK_xCustom21] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[xCustom54]'
GO
ALTER TABLE [dbo].[xCustom54] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_xCustom54_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_xCustom54] on [dbo].[xCustom54]'
GO
ALTER TABLE [dbo].[xCustom54] ADD CONSTRAINT [PK_xCustom54] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[iCustom8]'
GO
ALTER TABLE [dbo].[iCustom8] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_iCustom8_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_iCustom8] on [dbo].[iCustom8]'
GO
ALTER TABLE [dbo].[iCustom8] ADD CONSTRAINT [PK_iCustom8] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[iCustom9]'
GO
ALTER TABLE [dbo].[iCustom9] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_iCustom9_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_iCustom9] on [dbo].[iCustom9]'
GO
ALTER TABLE [dbo].[iCustom9] ADD CONSTRAINT [PK_iCustom9] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[iCustom19]'
GO
ALTER TABLE [dbo].[iCustom19] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_iCustom19_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_iCustom19] on [dbo].[iCustom19]'
GO
ALTER TABLE [dbo].[iCustom19] ADD CONSTRAINT [PK_iCustom19] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[xCustom17]'
GO
ALTER TABLE [dbo].[xCustom17] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_xCustom17_CustomID] DEFAULT (newid()),
[CustomSort] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_xCustom17] on [dbo].[xCustom17]'
GO
ALTER TABLE [dbo].[xCustom17] ADD CONSTRAINT [PK_xCustom17] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[iCustom10]'
GO
ALTER TABLE [dbo].[iCustom10] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_iCustom10_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_iCustom10] on [dbo].[iCustom10]'
GO
ALTER TABLE [dbo].[iCustom10] ADD CONSTRAINT [PK_iCustom10] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[xCustom55]'
GO
CREATE TABLE [dbo].[xCustom55]
(
[Custom] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomKey] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
[CUser] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[Active] [int] NULL,
[Custom1] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[SAPCode] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_xCustom55_CustomID] DEFAULT (newid()),
[CustomSort] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_xCustom55] on [dbo].[xCustom55]'
GO
ALTER TABLE [dbo].[xCustom55] ADD CONSTRAINT [PK_xCustom55] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pImageMultiPage]'
GO
CREATE TABLE [dbo].[pImageMultiPage]
(
[ImageMultiPageID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_pImageMultiPageID] DEFAULT (newid()),
[ImageID] [uniqueidentifier] NULL,
[ImageNo] [nvarchar] (10) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage1] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage2] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage3] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage4] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage5] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage6] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage7] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage8] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage9] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage10] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage11] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage12] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage13] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage14] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage15] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage16] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage17] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage18] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage19] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage20] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage21] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage22] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage23] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage24] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ImageMultiPage25] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[xCustom28]'
GO
CREATE TABLE [dbo].[xCustom28]
(
[Custom] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
[CustomKey] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Custom1] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Active] [int] NULL,
[CUser] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_xCustom28_CustomID] DEFAULT (newid()),
[CustomSort] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_xCustom28] on [dbo].[xCustom28]'
GO
ALTER TABLE [dbo].[xCustom28] ADD CONSTRAINT [PK_xCustom28] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[iCustom11]'
GO
ALTER TABLE [dbo].[iCustom11] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_iCustom11_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_iCustom11] on [dbo].[iCustom11]'
GO
ALTER TABLE [dbo].[iCustom11] ADD CONSTRAINT [PK_iCustom11] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[iCustom12]'
GO
ALTER TABLE [dbo].[iCustom12] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_iCustom12_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_iCustom12] on [dbo].[iCustom12]'
GO
ALTER TABLE [dbo].[iCustom12] ADD CONSTRAINT [PK_iCustom12] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pMaterial]'
GO
ALTER TABLE [dbo].[pMaterial] ADD
[HeaderLocked] [int] NOT NULL CONSTRAINT [DF_pMaterial_HeaderLocked] DEFAULT ((0))
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pMaterial] ALTER COLUMN [height] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[pMaterial] ALTER COLUMN [width] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[uTradePartnerVendor]'
GO
ALTER TABLE [dbo].[uTradePartnerVendor] ADD
[Fabric] [int] NULL,
[Trim] [int] NULL,
[FG] [int] NULL,
[Mill] [int] NULL,
[CurrencyType] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[HKFreight] [decimal] (18, 2) NULL,
[HKDuty] [decimal] (18, 2) NULL,
[USFreight] [decimal] (18, 2) NULL,
[USDuty] [decimal] (18, 2) NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[uTradePartner]'
GO
ALTER TABLE [dbo].[uTradePartner] ADD
[Fabric] [int] NULL,
[Trim] [int] NULL,
[FG] [int] NULL,
[Mill] [int] NULL,
[CurrencyType] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Freight] [decimal] (18, 6) NULL CONSTRAINT [DF_uTradePartner_Freight] DEFAULT ((0)),
[Duty] [decimal] (18, 6) NULL CONSTRAINT [DF_uTradePartner_Duty] DEFAULT ((0)),
[HKFreight] [decimal] (18, 2) NULL,
[HKDuty] [decimal] (18, 2) NULL,
[USFreight] [decimal] (18, 2) NULL,
[USDuty] [decimal] (18, 2) NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pStyleHeader]'
GO
ALTER TABLE [dbo].[pStyleHeader] ADD
[StyleLinkID] [uniqueidentifier] NULL,
[MaterialCoreID] [uniqueidentifier] NULL,
[ProdDev] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[HeaderLocked] [int] NOT NULL CONSTRAINT [DF_pStyleHeader_ApprovalStatus] DEFAULT ((0))
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pStyleHeader] ALTER COLUMN [CustomField1] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[pStyleHeader] ALTER COLUMN [StyleDetail] [nvarchar] (max) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[pStyleHeader] ALTER COLUMN [StyleDetail1] [nvarchar] (max) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[pStyleHeader] ALTER COLUMN [StyleAttribute] [nvarchar] (max) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[pStyleHeader] ALTER COLUMN [StyleDetail2] [nvarchar] (max) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pSampleRequestSubmitStatus]'
GO
UPDATE [dbo].[pSampleRequestSubmitStatus] SET [ApprovedType]=((0)) WHERE [ApprovedType] IS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pSampleRequestSubmitStatus] ALTER COLUMN [ApprovedType] [int] NOT NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pStyleSourcing]'
GO
ALTER TABLE [dbo].[pStyleSourcing] ALTER COLUMN [StyleSourcingID] DROP ROWGUIDCOL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pStyleSourcing] ALTER COLUMN [StyleSourcingID] [uniqueidentifier] NOT NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pStyleSourcing] on [dbo].[pStyleSourcing]'
GO
ALTER TABLE [dbo].[pStyleSourcing] ADD CONSTRAINT [PK_pStyleSourcing] PRIMARY KEY CLUSTERED  ([StyleSourcingID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO

PRINT N'Rebuilding [dbo].[pStyleQuoteItem]'
GO
CREATE TABLE [dbo].[tmp_rg_xx_pStyleQuoteItem]
(
[StyleQuoteItemID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_pStyleQuoteItem_StyleQuoteItemID] DEFAULT (newid()),
[StyleQuoteItemNo] [int] NOT NULL IDENTITY(1, 1),
[StyleQuoteItemShare] [int] NULL CONSTRAINT [DF_pStyleQuoteItem_StyleQuoteItemShare] DEFAULT ((0)),
[StyleQuoteItemStatusId] [int] NULL,
[StyleQuoteVariationId] [uniqueidentifier] NULL,
[StyleQuoteID] [uniqueidentifier] NULL,
[StyleQuotaDutyID] [uniqueidentifier] NULL,
[StyleDevelopmentID] [uniqueidentifier] NULL,
[StyleID] [uniqueidentifier] NULL,
[StyleQuoteTradePartnerID] [uniqueidentifier] NULL,
[StyleCostingID] [uniqueidentifier] NULL,
[StyleCostingType] [int] NULL,
[StyleCostingFreightTypeID] [int] NULL,
[TradePartnerID] [uniqueidentifier] NULL,
[TradePartnerVendorID] [uniqueidentifier] NULL,
[StyleQuoteItemDueDate] [datetime] NULL,
[StyleQuoteItemApprovedBy] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemApprovedDate] [datetime] NULL,
[StyleQuoteItemCustomField1] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField2] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField3] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField4] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField5] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField6] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField7] [uniqueidentifier] NULL,
[StyleQuoteItemCustomField8] [money] NULL,
[StyleQuoteItemCustomField9] [money] NULL,
[StyleQuoteItemCustomField10] [money] NULL,
[StyleQuoteItemCustomField11] [decimal] (18, 4) NULL CONSTRAINT [DF_pStyleQuoteItem_StyleQuoteItemCustomField11] DEFAULT ((0)),
[StyleQuoteItemCustomField12] [decimal] (18, 4) NULL,
[StyleQuoteItemCustomField13] [decimal] (18, 4) NULL,
[StyleQuoteItemCustomField14] [money] NULL,
[StyleQuoteItemCustomField15] [money] NULL,
[StyleQuoteItemCustomField16] [decimal] (18, 4) NULL,
[StyleQuoteItemCustomField17] [money] NULL CONSTRAINT [DF_pStyleQuoteItem_StyleQuoteItemCustomField17] DEFAULT ((0)),
[StyleQuoteItemCustomField18] [money] NULL CONSTRAINT [DF_pStyleQuoteItem_StyleQuoteItemCustomField18] DEFAULT ((0)),
[StyleQuoteItemCustomField19] [money] NULL CONSTRAINT [DF_pStyleQuoteItem_StyleQuoteItemCustomField19] DEFAULT ((0)),
[StyleQuoteItemCustomField20] [money] NULL CONSTRAINT [DF_pStyleQuoteItem_StyleQuoteItemCustomField20] DEFAULT ((0)),
[StyleQuoteItemCustomField21] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField22] [decimal] (18, 3) NULL,
[StyleQuoteItemCustomField23] [decimal] (18, 4) NULL,
[StyleQuoteItemCustomField24] [decimal] (18, 4) NULL,
[StyleQuoteItemCustomField25] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField26] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField27] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField28] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField29] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField30] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemNotes] [ntext] COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField1] [money] NULL,
[StyleCostingCustomField2] [money] NULL,
[StyleCostingCustomField3] [decimal] (18, 4) NULL,
[StyleCostingCustomField4] [int] NULL,
[StyleCostingCustomField5] [int] NULL,
[StyleCostingCustomField6] [decimal] (18, 3) NULL,
[StyleCostingCustomField7] [decimal] (18, 3) NULL,
[StyleCostingCustomField8] [decimal] (18, 3) NULL,
[StyleCostingCustomField9] [decimal] (18, 3) NULL,
[StyleCostingCustomField10] [decimal] (18, 3) NULL,
[StyleCostingCustomField11] [decimal] (18, 3) NULL,
[StyleCostingCustomField12] [decimal] (18, 3) NULL,
[StyleCostingCustomField13] [decimal] (18, 3) NULL,
[StyleCostingCustomField14] [decimal] (18, 3) NULL,
[StyleCostingCustomField15] [decimal] (18, 3) NULL,
[StyleCostingCustomField16] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField17] [datetime] NULL,
[StyleCostingCustomField18] [decimal] (18, 3) NULL,
[StyleCostingCustomField19] [decimal] (18, 3) NULL,
[StyleCostingCustomField20] [decimal] (18, 3) NULL,
[StyleCostingCustomField21] [decimal] (18, 3) NULL,
[StyleCostingCustomField22] [decimal] (18, 3) NULL,
[StyleCostingCustomField23] [decimal] (18, 3) NULL,
[StyleCostingCustomField24] [decimal] (18, 3) NULL,
[StyleCostingCustomField25] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField26] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField27] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField28] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField29] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField30] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField31] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField32] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField33] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField34] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField35] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[QuoteFolderSort] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[AgentView] [int] NULL CONSTRAINT [DF_pStyleQuoteItem_AgentView] DEFAULT ((0)),
[StyleColorID] [uniqueidentifier] NULL,
[StyleSourcingID] [uniqueidentifier] NULL,
[StyleQuoteItemCustomField31] [decimal] (18, 3) NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO

update pstylequoteitem
set stylequoteitemcustomfield17 = NULL
where IsNumeric(stylequoteitemcustomfield17) = 0
GO

IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO

IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO


update pstylequoteitem
set stylequoteitemcustomfield7 = NULL
where IsNumeric(stylequoteitemcustomfield7) = 1
GO

IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO

IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO

UPDATE pStyleQuoteItem
 SET StyleQuoteItemCustomField13 = NULL
WHERE isnumeric(StyleQuoteItemCustomField13) = 0
GO


IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO

IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO

UPDATE pStyleQuoteItem
 SET StyleQuoteItemCustomField16 = NULL
WHERE isnumeric(StyleQuoteItemCustomField16) = 0
GO

IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO

IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO

UPDATE pStyleQuoteItem
 SET StyleQuoteItemCustomField22 = NULL
WHERE isnumeric(StyleQuoteItemCustomField22) = 0
GO

IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO

IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO

UPDATE pStyleQuoteItem
 SET StyleCostingCustomField20 = NULL
WHERE isnumeric(StyleCostingCustomField20) = 0
GO

IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO

IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO

SET IDENTITY_INSERT [dbo].[tmp_rg_xx_pStyleQuoteItem] ON
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO


INSERT INTO [dbo].[tmp_rg_xx_pStyleQuoteItem]([StyleQuoteItemID], [StyleQuoteItemNo], [StyleQuoteItemShare], [StyleQuoteItemStatusId], [StyleQuoteVariationId], [StyleQuoteID], [StyleQuotaDutyID], [StyleDevelopmentID], [StyleID], [StyleQuoteTradePartnerID], [StyleCostingID], [StyleCostingType], [StyleCostingFreightTypeID], [TradePartnerID], [TradePartnerVendorID], [StyleQuoteItemDueDate], [StyleQuoteItemApprovedBy], [StyleQuoteItemApprovedDate], [StyleQuoteItemCustomField1], [StyleQuoteItemCustomField2], [StyleQuoteItemCustomField3], [StyleQuoteItemCustomField4], [StyleQuoteItemCustomField5], [StyleQuoteItemCustomField6], [StyleQuoteItemCustomField7], [StyleQuoteItemCustomField8], [StyleQuoteItemCustomField9], [StyleQuoteItemCustomField10], [StyleQuoteItemCustomField11], [StyleQuoteItemCustomField12], [StyleQuoteItemCustomField13], [StyleQuoteItemCustomField14], [StyleQuoteItemCustomField15], [StyleQuoteItemCustomField16], [StyleQuoteItemCustomField17], [StyleQuoteItemCustomField18], [StyleQuoteItemCustomField19], [StyleQuoteItemCustomField20], [StyleQuoteItemCustomField21], [StyleQuoteItemCustomField22], [StyleQuoteItemCustomField23], [StyleQuoteItemCustomField24], [StyleQuoteItemCustomField25], [StyleQuoteItemCustomField26], [StyleQuoteItemCustomField27], [StyleQuoteItemCustomField28], [StyleQuoteItemCustomField29], [StyleQuoteItemCustomField30], [StyleQuoteItemNotes], [StyleCostingCustomField1], [StyleCostingCustomField2], [StyleCostingCustomField3], [StyleCostingCustomField4], [StyleCostingCustomField5], [StyleCostingCustomField6], [StyleCostingCustomField7], [StyleCostingCustomField8], [StyleCostingCustomField9], [StyleCostingCustomField10], [StyleCostingCustomField11], [StyleCostingCustomField12], [StyleCostingCustomField13], [StyleCostingCustomField14], [StyleCostingCustomField15], [StyleCostingCustomField16], [StyleCostingCustomField17], [StyleCostingCustomField18], [StyleCostingCustomField19], [StyleCostingCustomField20], [StyleCostingCustomField21], [StyleCostingCustomField22], [StyleCostingCustomField23], [StyleCostingCustomField24], [StyleCostingCustomField25], [StyleCostingCustomField26], [StyleCostingCustomField27], [StyleCostingCustomField28], [StyleCostingCustomField29], [StyleCostingCustomField30], [StyleCostingCustomField31], [StyleCostingCustomField32], [StyleCostingCustomField33], [StyleCostingCustomField34], [StyleCostingCustomField35], [CUser], [CDate], [MUser], [MDate], [QuoteFolderSort], [AgentView], [StyleColorID], [StyleSourcingID], [StyleQuoteItemCustomField31]) SELECT [StyleQuoteItemID], [StyleQuoteItemNo], [StyleQuoteItemShare], [StyleQuoteItemStatusId], [StyleQuoteVariationId], [StyleQuoteID], [StyleQuotaDutyID], [StyleDevelopmentID], [StyleID], [StyleQuoteTradePartnerID], [StyleCostingID], [StyleCostingType], [StyleCostingFreightTypeID], [TradePartnerID], [TradePartnerVendorID], [StyleQuoteItemDueDate], [StyleQuoteItemApprovedBy], [StyleQuoteItemApprovedDate], CAST([StyleQuoteItemCustomField1] AS [nvarchar] (200)) COLLATE SQL_Latin1_General_CP1_CI_AS, CAST([StyleQuoteItemCustomField2] AS [nvarchar] (200)) COLLATE SQL_Latin1_General_CP1_CI_AS, [StyleQuoteItemCustomField3], [StyleQuoteItemCustomField4], [StyleQuoteItemCustomField5], [StyleQuoteItemCustomField6], [StyleQuoteItemCustomField7], CAST([StyleQuoteItemCustomField8] AS [money]), CAST([StyleQuoteItemCustomField9] AS [money]), CAST([StyleQuoteItemCustomField10] AS [money]), CAST([StyleQuoteItemCustomField11] AS [decimal] (18, 4)), [StyleQuoteItemCustomField12], [StyleQuoteItemCustomField13], CAST([StyleQuoteItemCustomField14] AS [money]), [StyleQuoteItemCustomField15], [StyleQuoteItemCustomField16], CAST([StyleQuoteItemCustomField17] AS [money]), CAST([StyleQuoteItemCustomField18] AS [money]), CAST([StyleQuoteItemCustomField19] AS [money]), CAST([StyleQuoteItemCustomField20] AS [money]), [StyleQuoteItemCustomField21], [StyleQuoteItemCustomField22], [StyleQuoteItemCustomField23], [StyleQuoteItemCustomField24], [StyleQuoteItemCustomField25], [StyleQuoteItemCustomField26], [StyleQuoteItemCustomField27], [StyleQuoteItemCustomField28], [StyleQuoteItemCustomField29], [StyleQuoteItemCustomField30], [StyleQuoteItemNotes], [StyleCostingCustomField1], [StyleCostingCustomField2], CAST([StyleCostingCustomField3] AS [decimal] (18, 4)), [StyleCostingCustomField4], [StyleCostingCustomField5], [StyleCostingCustomField6], [StyleCostingCustomField7], CAST([StyleCostingCustomField8] AS [decimal] (18, 3)), [StyleCostingCustomField9], [StyleCostingCustomField10], [StyleCostingCustomField11], [StyleCostingCustomField12], [StyleCostingCustomField13], [StyleCostingCustomField14], [StyleCostingCustomField15], [StyleCostingCustomField16], [StyleCostingCustomField17], CAST([StyleCostingCustomField18] AS [decimal] (18, 3)), [StyleCostingCustomField19], [StyleCostingCustomField20], [StyleCostingCustomField21], [StyleCostingCustomField22], [StyleCostingCustomField23], [StyleCostingCustomField24], [StyleCostingCustomField25], [StyleCostingCustomField26], [StyleCostingCustomField27], [StyleCostingCustomField28], [StyleCostingCustomField29], [StyleCostingCustomField30], [StyleCostingCustomField31], [StyleCostingCustomField32], [StyleCostingCustomField33], [StyleCostingCustomField34], [StyleCostingCustomField35], [CUser], [CDate], [MUser], [MDate], [QuoteFolderSort], [AgentView], [StyleColorID], [StyleSourcingID], [StyleQuoteItemCustomField31] FROM [dbo].[pStyleQuoteItem]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO

IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
SET IDENTITY_INSERT [dbo].[tmp_rg_xx_pStyleQuoteItem] OFF
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
DECLARE @idVal INT
SELECT @idVal = IDENT_CURRENT(N'pStyleQuoteItem')
DBCC CHECKIDENT([tmp_rg_xx_pStyleQuoteItem], RESEED, @idVal)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
DROP TABLE [dbo].[pStyleQuoteItem]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_rename N'[dbo].[tmp_rg_xx_pStyleQuoteItem]', N'pStyleQuoteItem'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pStyleCostingHeader]'
GO
ALTER TABLE [dbo].[pStyleCostingHeader] ADD
[UnitsPlan] [int] NULL,
[UnitsActual] [int] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pStyleCostingHeader] ALTER COLUMN [StyleCostingHeaderID] [uniqueidentifier] NOT NULL
ALTER TABLE [dbo].[pStyleCostingHeader] ALTER COLUMN [StyleCostingCustomField1] [money] NULL
ALTER TABLE [dbo].[pStyleCostingHeader] ALTER COLUMN [StyleCostingCustomField2] [money] NULL
ALTER TABLE [dbo].[pStyleCostingHeader] ALTER COLUMN [StyleCostingCustomField3] [decimal] (18, 4) NULL
ALTER TABLE [dbo].[pStyleCostingHeader] ALTER COLUMN [StyleCostingCustomField4] [decimal] (18, 0) NULL
ALTER TABLE [dbo].[pStyleCostingHeader] ALTER COLUMN [StyleCostingCustomField7] [decimal] (18, 2) NULL
ALTER TABLE [dbo].[pStyleCostingHeader] ALTER COLUMN [StyleCostingCustomField8] [decimal] (18, 2) NULL
ALTER TABLE [dbo].[pStyleCostingHeader] ALTER COLUMN [StyleCostingCustomField9] [decimal] (18, 2) NULL
ALTER TABLE [dbo].[pStyleCostingHeader] ALTER COLUMN [StyleCostingCustomField16] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[pStyleCostingHeader] ALTER COLUMN [StyleCostingCustomField17] [datetime] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pStyleCostingHeader] ALTER COLUMN [StyleCostingHeaderID] ADD ROWGUIDCOL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pStyleCostingHeader_1] on [dbo].[pStyleCostingHeader]'
GO
ALTER TABLE [dbo].[pStyleCostingHeader] ADD CONSTRAINT [PK_pStyleCostingHeader_1] PRIMARY KEY CLUSTERED  ([StyleCostingHeaderID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[iCustom20]'
GO
ALTER TABLE [dbo].[iCustom20] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_iCustom20_CustomID] DEFAULT (newid()),
[Brand] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Category] [nvarchar] (255) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[SeasonYearID] [uniqueidentifier] NULL,
[GBPS10] [decimal] (18, 2) NULL,
[US] [decimal] (18, 2) NULL,
[EUR] [decimal] (18, 2) NULL,
[HKD] [decimal] (18, 2) NULL,
[LookupRef] [nvarchar] (1000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[iCustom20] DROP
COLUMN [CustomKey],
COLUMN [TableRelation],
COLUMN [Active],
COLUMN [CUser],
COLUMN [CDate],
COLUMN [MUser],
COLUMN [MDate]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[iCustom20] ALTER COLUMN [Custom] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[iCustom20] ALTER COLUMN [CustomSort] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating index [IX_iCustom20_3] on [dbo].[iCustom20]'
GO
CREATE NONCLUSTERED INDEX [IX_iCustom20_3] ON [dbo].[iCustom20] ([Custom])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating index [IX_iCustom20] on [dbo].[iCustom20]'
GO
CREATE NONCLUSTERED INDEX [IX_iCustom20] ON [dbo].[iCustom20] ([Brand])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating index [IX_iCustom20_1] on [dbo].[iCustom20]'
GO
CREATE NONCLUSTERED INDEX [IX_iCustom20_1] ON [dbo].[iCustom20] ([Category])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating index [IX_iCustom20_2] on [dbo].[iCustom20]'
GO
CREATE NONCLUSTERED INDEX [IX_iCustom20_2] ON [dbo].[iCustom20] ([SeasonYearID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] ALTER COLUMN [LinePlanBusLYCh1] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusiness] ALTER COLUMN [LinePlanBusLYCh2] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusiness] ALTER COLUMN [LinePlanBusLYCh3] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusiness] ALTER COLUMN [LinePlanBusLYCh4] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusiness] ALTER COLUMN [LinePlanBusLYCh5] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusiness] ALTER COLUMN [LinePlanBusPnCh1] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusiness] ALTER COLUMN [LinePlanBusPnCh2] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusiness] ALTER COLUMN [LinePlanBusPnCh3] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusiness] ALTER COLUMN [LinePlanBusPnCh4] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusiness] ALTER COLUMN [LinePlanBusPnCh5] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusiness] ALTER COLUMN [LinePlanBusCuCh1] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusiness] ALTER COLUMN [LinePlanBusCuCh2] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusiness] ALTER COLUMN [LinePlanBusCuCh3] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusiness] ALTER COLUMN [LinePlanBusCuCh4] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusiness] ALTER COLUMN [LinePlanBusCuCh5] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusiness] ALTER COLUMN [LinePlanBusWpCh1] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusiness] ALTER COLUMN [LinePlanBusWpCh2] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusiness] ALTER COLUMN [LinePlanBusWpCh3] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusiness] ALTER COLUMN [LinePlanBusWpCh4] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusiness] ALTER COLUMN [LinePlanBusWpCh5] [decimal] (18, 5) NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pLinePlanItem]'
GO
ALTER TABLE [dbo].[pLinePlanItem] ADD
[Yunique] [int] NULL CONSTRAINT [DF_pLinePlanItem_Yunique] DEFAULT ((0)),
[LinePlanStyleAttributeItemID] [uniqueidentifier] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_Material_RequestAgentVendor_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_Material_RequestAgentVendor_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pStyleMaterials]'
GO
ALTER TABLE [dbo].[pStyleMaterials] ADD
[StyleMaterialLinkID] [uniqueidentifier] NULL,
[MultiCloth] [int] NOT NULL CONSTRAINT [DF_pStyleMaterials_MultiCloth] DEFAULT ((0))
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pStyleMaterials] ALTER COLUMN [Qty] [nvarchar] (18) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[pStyleMaterials] ALTER COLUMN [height] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[pStyleMaterials] ALTER COLUMN [width] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[pStyleMaterials] ALTER COLUMN [MaterialSort] [varchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pStyleColorway]'
GO
ALTER TABLE [dbo].[pStyleColorway] ALTER COLUMN [CustomField1] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pStyleColorwaySeasonYear]'
GO
ALTER TABLE [dbo].[pStyleColorwaySeasonYear] ADD
[SampleStatus] [int] NOT NULL CONSTRAINT [DF_pStyleColorwaySeasonYear_SampleStatus] DEFAULT ((900)),
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_LinePlanItemProduct_SELECT]'
GO
EXEC sp_refreshview N'[dbo].[vwx_LinePlanItemProduct_SELECT]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanStyleAttribute_Plan_SELECT]'
GO
CREATE PROCEDURE [dbo].[spx_LinePlanStyleAttribute_Plan_SELECT](
@LinePlanID varchar(50)
)
AS 


SELECT LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3, LinePlanAttributeItemID4, 
LinePlanAttributeText1,  LinePlanAttributeText2, LinePlanAttributeText3, LinePlanAttributeText4
FROM  pLinePlanBusiness WITH(NOLOCK)
WHERE (LinePlanID = @LinePlanID) 
GROUP BY LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3, LinePlanAttributeItemID4, 
LinePlanAttributeText1,  LinePlanAttributeText2, LinePlanAttributeText3, LinePlanAttributeText4, 
LinePlanAttributeItemSort1, LinePlanAttributeItemSort2, LinePlanAttributeItemSort3, LinePlanAttributeItemSort4
ORDER BY LinePlanAttributeItemSort1, LinePlanAttributeItemSort2, LinePlanAttributeItemSort3, LinePlanAttributeItemSort4

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pStyleCosting]'
GO
ALTER TABLE [dbo].[pStyleCosting] ALTER COLUMN [StyleCostingID] DROP ROWGUIDCOL
GO

IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO

IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO

UPDATE pStyleCosting
 SET StyleCostingCustomField20 = NULL
WHERE isnumeric(StyleCostingCustomField20) = 0
GO

IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pStyleCosting] ALTER COLUMN [StyleCostingID] [uniqueidentifier] NOT NULL
ALTER TABLE [dbo].[pStyleCosting] ALTER COLUMN [StyleCostingCustomField1] [money] NULL
ALTER TABLE [dbo].[pStyleCosting] ALTER COLUMN [StyleCostingCustomField2] [money] NULL
ALTER TABLE [dbo].[pStyleCosting] ALTER COLUMN [StyleCostingCustomField3] [decimal] (18, 4) NULL
ALTER TABLE [dbo].[pStyleCosting] ALTER COLUMN [StyleCostingCustomField4] [int] NULL
ALTER TABLE [dbo].[pStyleCosting] ALTER COLUMN [StyleCostingCustomField5] [int] NULL
ALTER TABLE [dbo].[pStyleCosting] ALTER COLUMN [StyleCostingCustomField8] [decimal] (18, 3) NULL
ALTER TABLE [dbo].[pStyleCosting] ALTER COLUMN [StyleCostingCustomField16] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[pStyleCosting] ALTER COLUMN [StyleCostingCustomField17] [datetime] NULL
ALTER TABLE [dbo].[pStyleCosting] ALTER COLUMN [StyleCostingCustomField20] [decimal] (18, 3) NULL
ALTER TABLE [dbo].[pStyleCosting] ALTER COLUMN [Active] [bit] NULL
ALTER TABLE [dbo].[pStyleCosting] ALTER COLUMN [StyleColorwayID] [uniqueidentifier] NULL
GO


IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pStyleCosting] ALTER COLUMN [StyleCostingID] ADD ROWGUIDCOL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_Temp_pStyleCosting] on [dbo].[pStyleCosting]'
GO
ALTER TABLE [dbo].[pStyleCosting] ADD CONSTRAINT [PK_Temp_pStyleCosting] PRIMARY KEY CLUSTERED  ([StyleCostingID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleCostingId_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_StyleCostingId_SELECT]
(@StyleID uniqueidentifier,
@StyleCostingTypeID int)
AS 


IF @StyleCostingTypeID = 0
	SELECT StyleCostingID, StyleID, StyleCostingTypeID
	FROM dbo.pStyleCosting WITH (NOLOCK)
	WHERE (StyleID = @StyleID) 
	ORDER BY StyleCostingTypeID ASC
ELSE
	SELECT StyleCostingID, StyleID, StyleCostingTypeID
	FROM dbo.pStyleCosting WITH (NOLOCK)
	WHERE (StyleID = @StyleID) AND (StyleCostingTypeID = @StyleCostingTypeID)
	ORDER BY StyleCostingTypeID ASC



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_Material_TradePartnerTemp_SELECT]'
GO
EXEC sp_refreshview N'[dbo].[vwx_Material_TradePartnerTemp_SELECT]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pImage]'
GO
ALTER TABLE [dbo].[pImage] ADD
[ImageMultiPage] [int] NULL CONSTRAINT [DF_pImage_ImageMultiPage] DEFAULT ((0))
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pImage] ALTER COLUMN [ImageDateLastAccessed] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[pImage] ALTER COLUMN [ImageDateLastModified] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[hImage]'
GO
ALTER TABLE [dbo].[hImage] ALTER COLUMN [ImageDateLastAccessed] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[hImage] ALTER COLUMN [ImageDateLastModified] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[hImage] ALTER COLUMN [SystemServerStorageID] [uniqueidentifier] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[sSystemServerStorageSetting]'
GO
ALTER TABLE [dbo].[sSystemServerStorageSetting] ALTER COLUMN [SystemServerStorageID] [uniqueidentifier] NOT NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_sSystemServerStorageSetting] on [dbo].[sSystemServerStorageSetting]'
GO
ALTER TABLE [dbo].[sSystemServerStorageSetting] ADD CONSTRAINT [PK_sSystemServerStorageSetting] PRIMARY KEY CLUSTERED  ([SystemServerStorageID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleRequestCalendarVendorSubmit_INSERT]'
GO







ALTER PROCEDURE [dbo].[spx_SampleRequestCalendarVendorSubmit_INSERT]
(@SampleRequestTradeId varchar(50),
@TradePartnerId varchar(50),
@TradePartnerVendorId varchar(50),
@CalendarId varchar(50),
@StartDate datetime,
@EndDate datetime,
@TeamID uniqueidentifier = NULL 
)
AS 

BEGIN

	INSERT INTO dbo.pStyleCalendarTemp
	(CalendarId, PKeyId, CalendarLinkId, 
	CalendarLinkSubId, CalendarDate, CalendarType, CalendarStatus, CalendarDescription, CalendarView)
	SELECT @CalendarId AS CalendarId, pSampleRequestWorkflow.SampleRequestWorkflowID, pSampleRequestWorkflow.SampleRequestTradeId, 
	pSampleWorkflow.SampleWorkflow + N' (' + CAST(pSampleRequestWorkflow.Submit AS varchar(4)) + ') ' AS CalendarLinkSubId, dbo.pSampleRequestWorkflow.DueDate, 'SampleRequest', 
	CASE 
		WHEN pSampleRequestWorkflow.Submit = 1 THEN 0
		ELSE  1
	END AS Status, 
		'<b>A: </b>' + uTradePartner.TradePartnerCode + ' / <b>V: </b>' + uTradePartnerVendor.VendorCode + '<BR>' + dbo.pStyleHeader.StyleNo +  
		case pSampleRequestWorkflow.StyleSet
			when 1 then 
				CASE 
					WHEN len (pStyleHeader.Pc1) = 0 THEN ' / 1st '
					WHEN len (pStyleHeader.Pc1) IS NULL THEN ' / 1st '
					ELSE ' / ' + pStyleHeader.Pc1
				END 
			when 2 then 
				CASE 
					WHEN len (pStyleHeader.Pc2) = 0 THEN ' / 2nd '
					WHEN len (pStyleHeader.Pc2) IS NULL THEN ' / 2nd '
					ELSE ' / ' + pStyleHeader.Pc2
				END 
			when 3 then 
				CASE 
					WHEN len (pStyleHeader.Pc3) = 0 THEN ' / 3rd '
					WHEN len (pStyleHeader.Pc3) IS NULL THEN ' / 3rd '
					ELSE ' / ' + pStyleHeader.Pc3
				END 
			when 4 then 
				CASE 
					WHEN len (pStyleHeader.Pc4) = 0 THEN ' / 4th '
					WHEN len (pStyleHeader.Pc4) IS NULL THEN ' / 4th '
					ELSE ' / ' + pStyleHeader.Pc4
				END 
		end
		+  ' (' + dbo.pStyleHeader.SizeClass + ') ' + dbo.pStyleHeader.Description AS CalendarDescription, 0
	FROM         dbo.pSampleRequestWorkflow WITH (NOLOCK) INNER JOIN
		dbo.pSampleWorkflow WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.SampleWorkflowID = dbo.pSampleWorkflow.SampleWorkflowID INNER JOIN
		dbo.pStyleHeader WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.StyleID = dbo.pStyleHeader.StyleID INNER JOIN
		dbo.uTradePartnerVendor WITH (NOLOCK) ON pSampleRequestWorkflow.TradePartnerVendorID = dbo.uTradePartnerVendor.TradePartnerVendorID INNER JOIN
		dbo.uTradePartner WITH (NOLOCK) ON pSampleRequestWorkflow.TradePartnerID = dbo.uTradePartner.TradePartnerID 
	WHERE  
		(dbo.pSampleRequestWorkflow.DueDate BETWEEN @StartDate AND @EndDate) 
		AND	( dbo.pSampleRequestWorkflow.Status NOT IN (SELECT StatusID FROM dbo.pSampleRequestSubmitStatus WHERE ApprovedType = 1 OR StatusID = 4)
		) 
		AND pSampleRequestWorkflow.TradePartnerID = @TradePartnerId 
		AND pSampleRequestWorkflow.TradePartnerVendorID = @TradePartnerVendorId 
		AND	pSampleRequestWorkflow.SampleRequestTradeId = @SampleRequestTradeId 
		AND pStyleHeader.StyleType  in  (  SELECT  StyleTypeId from sAccessStyleFolder WITH (NOLOCK) where TeamID = @TeamID  AND ( AccessRoleId =  3 OR AccessView = 1) ) 
	ORDER BY dbo.pSampleRequestWorkflow.DueDate, dbo.pStyleHeader.StyleNo, dbo.pSampleWorkflow.SampleWorkflowID	

END 


BEGIN

	INSERT INTO dbo.pStyleCalendarTemp
	(CalendarId, PKeyId, CalendarLinkId, CalendarLinkSubId, CalendarDate, CalendarType, CalendarStatus, CalendarDescription, CalendarView)
	SELECT @CalendarId AS CalendarId, pSampleRequestWorkflow.SampleRequestWorkflowID, pSampleRequestWorkflow.SampleRequestTradeId, 
	pSampleWorkflow.SampleWorkflow + N' (' + CAST(pSampleRequestWorkflow.Submit AS varchar(4)) + ') ' AS CalendarLinkSubId, dbo.pSampleRequestWorkflow.DueDate, 'SampleRequest', pSampleRequestWorkflow.Status,  
		'<b>A: </b>' + uTradePartner.TradePartnerCode + ' / <b>V: </b>' + uTradePartnerVendor.VendorCode + '<BR>' + dbo.pStyleHeader.StyleNo + 
		case pSampleRequestWorkflow.StyleSet
			when 1 then 
				CASE 
					WHEN len (pStyleHeader.Pc1) = 0 THEN ' / 1st '
					WHEN len (pStyleHeader.Pc1) IS NULL THEN ' / 1st '
					ELSE ' / ' + pStyleHeader.Pc1
				END 
			when 2 then 
				CASE 
					WHEN len (pStyleHeader.Pc2) = 0 THEN ' / 2nd '
					WHEN len (pStyleHeader.Pc2) IS NULL THEN ' / 2nd '
					ELSE ' / ' + pStyleHeader.Pc2
				END 
			when 3 then 
				CASE 
					WHEN len (pStyleHeader.Pc3) = 0 THEN ' / 3rd '
					WHEN len (pStyleHeader.Pc3) IS NULL THEN ' / 3rd '
					ELSE ' / ' + pStyleHeader.Pc3
				END 
			when 4 then 
				CASE 
					WHEN len (pStyleHeader.Pc4) = 0 THEN ' / 4th '
					WHEN len (pStyleHeader.Pc4) IS NULL THEN ' / 4th '
					ELSE ' / ' + pStyleHeader.Pc4
				END 
		end
		+ ' (' + dbo.pStyleHeader.SizeClass + ') ' + dbo.pStyleHeader.Description AS CalendarDescription, 0
	FROM         dbo.pSampleRequestWorkflow WITH (NOLOCK) INNER JOIN
		dbo.pSampleWorkflow WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.SampleWorkflowID = dbo.pSampleWorkflow.SampleWorkflowID INNER JOIN
		dbo.pStyleHeader WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.StyleID = dbo.pStyleHeader.StyleID INNER JOIN
		dbo.uTradePartnerVendor WITH (NOLOCK) ON pSampleRequestWorkflow.TradePartnerVendorID = dbo.uTradePartnerVendor.TradePartnerVendorID INNER JOIN
		dbo.uTradePartner WITH (NOLOCK) ON pSampleRequestWorkflow.TradePartnerID = dbo.uTradePartner.TradePartnerID 
	WHERE  
		(pSampleRequestWorkflow.EndDate BETWEEN @StartDate AND @EndDate) AND (pSampleRequestWorkflow.Status = 1) AND 
		pSampleRequestWorkflow.TradePartnerID = @TradePartnerId AND pSampleRequestWorkflow.TradePartnerVendorID = @TradePartnerVendorId AND
		pSampleRequestWorkflow.SampleRequestTradeId = @SampleRequestTradeId 
		AND pStyleHeader.StyleType  in  (  SELECT  StyleTypeId from sAccessStyleFolder WITH (NOLOCK) where TeamID = @TeamID  AND ( AccessRoleId =  3 OR AccessView = 1) ) 
	ORDER BY pSampleRequestWorkflow.EndDate, dbo.pStyleHeader.StyleNo, dbo.pSampleWorkflow.SampleWorkflowID

END





set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON





set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[xCustom8]'
GO
ALTER TABLE [dbo].[xCustom8] ADD
[CustomChina] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[xCustom8] ALTER COLUMN [Active] [bit] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[vwx_xCustom8]'
GO
CREATE VIEW dbo.vwx_xCustom8
AS
SELECT     Custom, CustomChina + ' ' + Custom AS CustomKey
FROM         dbo.xCustom8
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanItemStyleColorwayDelivery_INSERT]'
GO





ALTER procedure [dbo].[spx_LinePlanItemStyleColorwayDelivery_INSERT] (
@StyleID UNIQUEIDENTIFIER,
@ColorPaletteID UNIQUEIDENTIFIER ,
@Delivery1 INT ,
@Delivery2 INT ,
@Delivery3 INT ,
@Delivery4 INT ,
@Units INT,
@SeasonYearID UNIQUEIDENTIFIER, 
@StyleSeasonYearID  UNIQUEIDENTIFIER,
@CUser NVARCHAR(200), 
@CDate DATETIME ,
@LinePlanItemID UNIQUEIDENTIFIER ,
@ColorType NVARCHAR(5)
)
AS

DECLARE @StyleColorStatus INT 
DECLARE @StyleColorID UNIQUEIDENTIFIER 
DECLARE @StyleColorwaySeasonYearID UNIQUEIDENTIFIER 
SET @StyleColorwaySeasonYearID  = NEWID()


IF @Delivery1 = 1 
	SELECT @Delivery2=1, @Delivery3=1 
ELSE IF @Delivery2 = 1 
	SET @Delivery3=1 

SET @Delivery4 = 0


IF @Delivery1 = 0  AND @Delivery2 = 0  AND @Delivery3 = 0
	SET @Delivery4 = 1


IF @Delivery1 = 1 OR @Delivery2 = 1 OR @Delivery3 = 1 
BEGIN
	SET @StyleColorStatus  = 100 
END
ELSE 
BEGIN
	SET @StyleColorStatus = 900
END



SELECT @StyleColorID = StyleColorID FROM pStyleColorway
WHERE StyleID  = @StyleID 
AND ColorPaletteID = @ColorPaletteID

IF @StyleColorID IS NULL 
BEGIN

	DECLARE @StyleColorNo NVARCHAR(200)
	DECLARE @StyleColorName NVARCHAR(200)
	DECLARE @PLMCode NVARCHAR(200)

	
	SELECT  @StyleColorNo = ColorCode,  @StyleColorName = ColorName 
	FROM pColorPalette
	WHERE ColorPaletteID =  @ColorPaletteID 

	IF @StyleColorNo IS NULL 
		SET @StyleColorNo = ''

	SET @StyleColorID  = NEWID()
	SELECT @PLMCode = StyleNo  + @StyleColorNo FROM pStyleHeader WHERE StyleID = @StyleID
	
	INSERT INTO pStyleColorway  ( 
	StyleColorID , StyleID , StyleSet , StyleColorNo, StyleColorName, MainColor , Version, 
	CDate, CUser, MDate, MUser, ColorPaletteID ,  PLMCode ) 
	VALUES ( @StyleColorID , @StyleID , 1, @StyleColorNo, @StyleColorName, @StyleColorName , 1, 
	@CDate, @CUser, @CDate, @CUser, @ColorPaletteID ,  @PLMCode ) 

END 



INSERT INTO pStyleColorwaySeasonYear ( StyleColorwaySeasonYearID , StyleSeasonYearID , StyleColorwayID , 
StyleID , StyleColorDelivery1, StyleColorDelivery2, StyleColorDelivery3, StyleColorDelivery4,
StyleColorStatus, Units , ColorType, SampleStatus ) 
VALUES ( @StyleColorwaySeasonYearID , @StyleSeasonYearID , @StyleColorID , 
@StyleID , @Delivery1, @Delivery2, @Delivery3, @Delivery4,
@StyleColorStatus, @Units, @ColorType , @StyleColorStatus ) 

















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_LinePlanMaterial_SEL]'
GO
ALTER VIEW dbo.vwx_LinePlanMaterial_SEL
AS
SELECT     dbo.pMaterial.MaterialID, dbo.pMaterial.MaterialImageID, dbo.pMaterial.MaterialImageVersion, dbo.pMaterial.MaterialImageDetailID, 
                      dbo.pMaterial.MaterialImageDetailVersion, dbo.pMaterial.MaterialType, dbo.pMaterial.MaterialNo, dbo.pMaterial.MaterialName, dbo.pMaterial.A, 
                      dbo.pMaterial.B, dbo.pMaterial.C, dbo.pMaterial.D, dbo.pMaterial.E, dbo.pMaterial.F, dbo.pMaterial.G, dbo.pMaterial.H, dbo.pMaterial.I, 
                      dbo.pMaterial.J, dbo.pMaterial.K, dbo.pMaterial.L, dbo.pMaterial.M, dbo.pMaterial.N, dbo.pMaterial.O, dbo.pMaterial.P, dbo.pMaterial.Q, 
                      dbo.pMaterial.R, dbo.pMaterial.S, dbo.pMaterial.T, dbo.pMaterial.U, dbo.pMaterial.V, dbo.pMaterial.W, dbo.pMaterial.X, dbo.pMaterial.Y, 
                      dbo.pMaterial.Z, dbo.pMaterial.MaterialPlacement, dbo.pLinePlanMaterial.LinePlanMaterialID, dbo.pLinePlanMaterial.LinePlanID, 
                      dbo.pLinePlanMaterial.CUser, dbo.pLinePlanMaterial.CDate, dbo.pLinePlanMaterial.MUser, dbo.pLinePlanMaterial.MDate, 
                      dbo.pMaterial.MaterialCode
FROM         dbo.pMaterial INNER JOIN
                      dbo.pLinePlanMaterial ON dbo.pMaterial.MaterialID = dbo.pLinePlanMaterial.MaterialID
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanStyleAtrribute_RangeCount_SELECT]'
GO

CREATE PROCEDURE dbo.spx_LinePlanStyleAtrribute_RangeCount_SELECT(
@LinePlanAttributeItemID1 VARCHAR(40),
@LinePlanAttributeItemID2 VARCHAR(40),
@LinePlanAttributeItemID3 VARCHAR(40),
@LinePlanAttributeItemID4 VARCHAR(40),
@LinePlanFinancialID VARCHAR(40)
)
AS

DECLARE @LinePlanRangeID UNIQUEIDENTIFIER 

IF @LinePlanAttributeItemID4 IS NULL 
	SELECT @LinePlanRangeID = LinePlanRangeID 	FROM pLinePlanRange
	WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
		AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
		AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
		AND (LinePlanFinancialID = @LinePlanFinancialID)
ELSE IF @LinePlanAttributeItemID3 IS NULL 
	SELECT @LinePlanRangeID = LinePlanRangeID FROM pLinePlanRange
	WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
		AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
		AND (LinePlanFinancialID = @LinePlanFinancialID)
ELSE IF @LinePlanAttributeItemID2 IS NULL 
	SELECT @LinePlanRangeID = LinePlanRangeID	FROM pLinePlanRange
	WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
		AND (LinePlanFinancialID = @LinePlanFinancialID)
ELSE  
	SELECT @LinePlanRangeID = LinePlanRangeID 	FROM pLinePlanRange
	WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
		AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
		AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
		AND (LinePlanAttributeItemID4 = @LinePlanAttributeItemID4)
		AND (LinePlanFinancialID = @LinePlanFinancialID)
	


--select @LinePlanRangeID as tp

IF @LinePlanRangeID IS NOT NULL 
BEGIN
	IF ( SELECT COUNT(*) FROM pLinePlanItem 
	WHERE LinePlanRangeID = @LinePlanRangeID   )   = 0
		SET @LinePlanRangeID =  NULL
END 	

SELECT @LinePlanRangeID AS LinePlanRangeID







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pMaterialColor]'
GO
ALTER TABLE [dbo].[pMaterialColor] ADD
[MaterialColorImageIDBak] [uniqueidentifier] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_MaterialColor_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_MaterialColor_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[fnx_GetStreamingImagePath]'
GO
/*
Comments:

General - Ryan Cabanas - September 23, 2009
	Pass the Image Version and Image ID and get the new Streaming Image Path
back.
*/


CREATE FUNCTION [dbo].[fnx_GetStreamingImagePath](
	@ImageID uniqueidentifier
	,@ImageVersion int
)

RETURNS nvarchar(255)

AS

BEGIN
	/*Declare variables.*/
	DECLARE @StreamingImagePath nvarchar(255)
	DECLARE @ImageServer nvarchar(200)
	DECLARE @ImageQualityValue nvarchar(5)

	/*Set image quality value.*/
	SET @ImageQualityValue = '2000'

	/*Get Image Server path portion.*/
	SET @ImageServer = (SELECT TOP 1 SettingValue FROM rReportSetting WHERE SettingType = 'ImageServer')

	/*Build the path.*/
	SET @StreamingImagePath = @ImageServer + '/ImageStream.ashx?S=' + @ImageQualityValue + '&V=' + CAST(@ImageVersion AS varchar(5)) + '&IID=' + CAST(@ImageID AS varchar(255))

	/*Return.*/
	RETURN @StreamingImagePath
END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pLineFolder]'
GO
ALTER TABLE [dbo].[pLineFolder] ADD
[LineFolderTypeID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_pLineFolder_LineFolderTypeID] DEFAULT ('00000000-0000-0000-0000-000000000000'),
[SeasonYearID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_pLineFolder_SeasonYearID] DEFAULT ('00000000-0000-0000-0000-000000000000'),
[LineFolderSortBy] [varchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLineFolder] ALTER COLUMN [CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[pLineFolder] ALTER COLUMN [MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_LinePlanMaterialItem_SEL]'
GO
ALTER VIEW dbo.vwx_LinePlanMaterialItem_SEL
AS
SELECT     dbo.pMaterial.MaterialID, dbo.pMaterial.MaterialImageID, dbo.pMaterial.MaterialImageVersion, dbo.pMaterial.MaterialImageDetailID, 
                      dbo.pMaterial.MaterialImageDetailVersion, dbo.pMaterial.MaterialType, dbo.pMaterial.MaterialNo, dbo.pMaterial.MaterialName, dbo.pMaterial.A, 
                      dbo.pMaterial.B, dbo.pMaterial.C, dbo.pMaterial.D, dbo.pMaterial.E, dbo.pMaterial.F, dbo.pMaterial.G, dbo.pMaterial.H, dbo.pMaterial.I, 
                      dbo.pMaterial.J, dbo.pMaterial.K, dbo.pMaterial.L, dbo.pMaterial.M, dbo.pMaterial.N, dbo.pMaterial.O, dbo.pMaterial.P, dbo.pMaterial.Q, 
                      dbo.pMaterial.R, dbo.pMaterial.S, dbo.pMaterial.T, dbo.pMaterial.U, dbo.pMaterial.V, dbo.pMaterial.W, dbo.pMaterial.X, dbo.pMaterial.Y, 
                      dbo.pMaterial.Z, dbo.pMaterial.MaterialPlacement, dbo.pLinePlanMaterialItem.LinePlanMaterialItemID, dbo.pLinePlanMaterialItem.LinePlanID, 
                      dbo.pLinePlanMaterialItem.LinePlanRangeID, dbo.pLinePlanMaterialItem.CUser, dbo.pLinePlanMaterialItem.CDate, dbo.pLinePlanMaterialItem.MUser, 
                      dbo.pLinePlanMaterialItem.MDate, dbo.pMaterial.MaterialCode, dbo.pMaterial.MaterialCodeNo
FROM         dbo.pMaterial INNER JOIN
                      dbo.pLinePlanMaterialItem ON dbo.pMaterial.MaterialID = dbo.pLinePlanMaterialItem.MaterialID

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleCostingTab_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_StyleCostingTab_SELECT]
(@StyleID uniqueidentifier)
AS 

SELECT dbo.pStyleCosting.StyleCostingID, dbo.pStyleCosting.StyleID, dbo.pStyleCostingType.StyleCostingType, dbo.pStyleCostingStatus.Custom, 
dbo.pStyleCostingStatus.CustomIcon, dbo.pStyleCostingType.StyleCostingTypeID
FROM  dbo.pStyleCosting WITH (NOLOCK) INNER JOIN
dbo.pStyleCostingType WITH (NOLOCK) ON dbo.pStyleCosting.StyleCostingTypeID = dbo.pStyleCostingType.StyleCostingTypeID INNER JOIN
dbo.pStyleCostingStatus WITH (NOLOCK) ON dbo.pStyleCosting.StyleCostingStatus = dbo.pStyleCostingStatus.CustomKey
WHERE (dbo.pStyleCosting.StyleID = @StyleID)
ORDER BY dbo.pStyleCosting.StyleCostingTypeID ASC



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pStyleColorwayItem]'
GO
ALTER TABLE [dbo].[pStyleColorwayItem] ADD
[MaterialCoreColorItemID] [uniqueidentifier] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pSeasonYear]'
GO
ALTER TABLE [dbo].[pSeasonYear] ADD
[CurrentSeason] [int] NULL CONSTRAINT [DF_pSeasonYear_CurrentSeason] DEFAULT ((0)),
[SAPCode] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleHeader_SELECT]'
GO


ALTER PROCEDURE [dbo].[spx_StyleHeader_SELECT]
(@StyleID uniqueidentifier)
AS SELECT     StyleID, StyleType, WorkflowType, RefNo, StyleNo, TempID, TempNo, CustomerNo, ConceptID, ConceptNo, SpecNo, Description, SizeRange, 
        StyleCategory, StyleSet, DueDate, RecDate, Customer, Buyer, Designer, SampleMaker, PatternMaker, ProductionManager, TechnicalDesigner, 
        StyleStatus, StyleLocation, WashType, Pitch, MaterialID, MaterialImageID, MaterialImageVersion, MaterialNo, MaterialName, CustomField1, 
        CustomField2, CustomField3, CustomField4, CustomField5, CustomField6, CustomField7, CustomField8, CustomField9, CustomField10, 
        CustomField11, CustomField12, CustomField13, CustomField14, CustomField15, Pc1, Pc2, Pc3, Pc4, CUser, CDate, MUser, MDate, Active, 
        Change, Action, StyleMaterialID, DesignSketchID, DesignSketchVersion, POMTempID1, POMTempVersion1, POMTempSizeClass1, POMTempID2, 
        POMTempVersion2, POMTempSizeClass2, POMTempID3, POMTempVersion3, POMTempSizeClass3, POMTempID4, POMTempVersion4, 
        POMTempSizeClass4, StyleDetail, StyleDetail1, SizeClass, DevelopmentID, DevelopmentNo, TechPackId, TechPackDate, StyleWorkflowID, StyleDetail2 ,
		CustomField16, CustomField17, CustomField18, CustomField19, CustomField20, CustomField21, CustomField22,  CustomField23, CustomField24,  CustomField25, 
		CustomField26, CustomField27, CustomField28,  CustomField29,  CustomField30, StyleStatusId, ISNULL (HeaderLocked,0) AS HeaderLocked
FROM    pStyleHeader
WHERE     (StyleID = @StyleID)




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanMaterialAllocationFilter_SELECT]'
GO

ALTER  PROCEDURE [dbo].[spx_LinePlanMaterialAllocationFilter_SELECT]
(
@LinePlanId varchar(40),
@LinePlanIndex VARCHAR (1) , 
@LinePlanAttributeItemId1 UNIQUEIDENTIFIER, 
@LinePlanAttributeItemId2 UNIQUEIDENTIFIER, 
@LinePlanAttributeItemId3 UNIQUEIDENTIFIER, 
@LinePlanAttributeItemId4 UNIQUEIDENTIFIER,
@MaterialID varchar(40)
)
AS 


IF @LinePlanIndex  = '0' 
BEGIN 
	SELECT pLinePlanRange.LinePlanRangeID, pLinePlanAttributeItem_1.LinePlanAttributeItemID AS LinePlanAttributeItemID1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeItemID AS LinePlanAttributeItemID2, pLinePlanAttributeItem_3.LinePlanAttributeItemID AS LinePlanAttributeItemID3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeItemID AS LinePlanAttributeItemID4, pLinePlanAttributeItem_1.LinePlanAttributeText AS LinePlanAttributeHeader1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeText AS LinePlanAttributeHeader2, pLinePlanAttributeItem_3.LinePlanAttributeText AS LinePlanAttributeHeader3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeText AS LinePlanAttributeHeader4
	FROM dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_3 RIGHT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_1 RIGHT OUTER JOIN
	  dbo.pLinePlanRange ON pLinePlanAttributeItem_1.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID1 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_2 ON dbo.pLinePlanRange.LinePlanAttributeItemID2 = pLinePlanAttributeItem_2.LinePlanAttributeItemID ON 
	  pLinePlanAttributeItem_3.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID3 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_4 ON dbo.pLinePlanRange.LinePlanAttributeItemID4 = pLinePlanAttributeItem_4.LinePlanAttributeItemID
	WHERE pLinePlanAttributeItem_1.LinePlanID = @LinePlanID AND pLinePlanRange.LinePlanFinancialID = '10000000-0000-0000-0000-000000000001' AND 
		pLinePlanRange.LinePlanRangeID NOT IN (SELECT LinePlanRangeID FROM pLinePlanMaterialItem WHERE 
		MaterialID = @MaterialID) 
	ORDER BY LinePlanAttributeHeader1, LinePlanAttributeHeader2, LinePlanAttributeHeader3, LinePlanAttributeHeader4
END
ELSE IF @LinePlanIndex  = '1' 
BEGIN 

	SELECT pLinePlanRange.LinePlanRangeID, pLinePlanAttributeItem_1.LinePlanAttributeItemID AS LinePlanAttributeItemID1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeItemID AS LinePlanAttributeItemID2, pLinePlanAttributeItem_3.LinePlanAttributeItemID AS LinePlanAttributeItemID3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeItemID AS LinePlanAttributeItemID4, pLinePlanAttributeItem_1.LinePlanAttributeText AS LinePlanAttributeHeader1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeText AS LinePlanAttributeHeader2, pLinePlanAttributeItem_3.LinePlanAttributeText AS LinePlanAttributeHeader3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeText AS LinePlanAttributeHeader4
	FROM dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_3 RIGHT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_1 RIGHT OUTER JOIN
	  dbo.pLinePlanRange ON pLinePlanAttributeItem_1.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID1 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_2 ON dbo.pLinePlanRange.LinePlanAttributeItemID2 = pLinePlanAttributeItem_2.LinePlanAttributeItemID ON 
	  pLinePlanAttributeItem_3.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID3 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_4 ON dbo.pLinePlanRange.LinePlanAttributeItemID4 = pLinePlanAttributeItem_4.LinePlanAttributeItemID
	WHERE pLinePlanAttributeItem_1.LinePlanID = @LinePlanID AND pLinePlanRange.LinePlanFinancialID = '10000000-0000-0000-0000-000000000001' AND 
		pLinePlanRange.LinePlanRangeID NOT IN (SELECT LinePlanRangeID FROM pLinePlanMaterialItem WHERE 
		MaterialID = @MaterialID) 
	AND pLinePlanAttributeItem_1.LinePlanAttributeItemID  = @LinePlanAttributeItemId1
	ORDER BY LinePlanAttributeHeader1, LinePlanAttributeHeader2, LinePlanAttributeHeader3, LinePlanAttributeHeader4

END 
ELSE IF @LinePlanIndex  = '2' 
BEGIN 

	SELECT pLinePlanRange.LinePlanRangeID, pLinePlanAttributeItem_1.LinePlanAttributeItemID AS LinePlanAttributeItemID1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeItemID AS LinePlanAttributeItemID2, pLinePlanAttributeItem_3.LinePlanAttributeItemID AS LinePlanAttributeItemID3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeItemID AS LinePlanAttributeItemID4, pLinePlanAttributeItem_1.LinePlanAttributeText AS LinePlanAttributeHeader1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeText AS LinePlanAttributeHeader2, pLinePlanAttributeItem_3.LinePlanAttributeText AS LinePlanAttributeHeader3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeText AS LinePlanAttributeHeader4
	FROM dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_3 RIGHT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_1 RIGHT OUTER JOIN
	  dbo.pLinePlanRange ON pLinePlanAttributeItem_1.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID1 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_2 ON dbo.pLinePlanRange.LinePlanAttributeItemID2 = pLinePlanAttributeItem_2.LinePlanAttributeItemID ON 
	  pLinePlanAttributeItem_3.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID3 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_4 ON dbo.pLinePlanRange.LinePlanAttributeItemID4 = pLinePlanAttributeItem_4.LinePlanAttributeItemID
	WHERE pLinePlanAttributeItem_1.LinePlanID = @LinePlanID AND pLinePlanRange.LinePlanFinancialID = '10000000-0000-0000-0000-000000000001' AND 
		pLinePlanRange.LinePlanRangeID NOT IN (SELECT LinePlanRangeID FROM pLinePlanMaterialItem WHERE 
		MaterialID = @MaterialID) 
	AND pLinePlanAttributeItem_1.LinePlanAttributeItemID  = @LinePlanAttributeItemId1
	AND pLinePlanAttributeItem_2.LinePlanAttributeItemID  = @LinePlanAttributeItemId2
	ORDER BY LinePlanAttributeHeader1, LinePlanAttributeHeader2, LinePlanAttributeHeader3, LinePlanAttributeHeader4

END 
ELSE IF @LinePlanIndex  = '3' 
BEGIN 

	SELECT pLinePlanRange.LinePlanRangeID, pLinePlanAttributeItem_1.LinePlanAttributeItemID AS LinePlanAttributeItemID1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeItemID AS LinePlanAttributeItemID2, pLinePlanAttributeItem_3.LinePlanAttributeItemID AS LinePlanAttributeItemID3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeItemID AS LinePlanAttributeItemID4, pLinePlanAttributeItem_1.LinePlanAttributeText AS LinePlanAttributeHeader1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeText AS LinePlanAttributeHeader2, pLinePlanAttributeItem_3.LinePlanAttributeText AS LinePlanAttributeHeader3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeText AS LinePlanAttributeHeader4
	FROM dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_3 RIGHT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_1 RIGHT OUTER JOIN
	  dbo.pLinePlanRange ON pLinePlanAttributeItem_1.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID1 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_2 ON dbo.pLinePlanRange.LinePlanAttributeItemID2 = pLinePlanAttributeItem_2.LinePlanAttributeItemID ON 
	  pLinePlanAttributeItem_3.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID3 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_4 ON dbo.pLinePlanRange.LinePlanAttributeItemID4 = pLinePlanAttributeItem_4.LinePlanAttributeItemID
	WHERE pLinePlanAttributeItem_1.LinePlanID = @LinePlanID AND pLinePlanRange.LinePlanFinancialID = '10000000-0000-0000-0000-000000000001' AND 
		pLinePlanRange.LinePlanRangeID NOT IN (SELECT LinePlanRangeID FROM pLinePlanMaterialItem WHERE 
		MaterialID = @MaterialID) 
	AND pLinePlanAttributeItem_1.LinePlanAttributeItemID  = @LinePlanAttributeItemId1
	AND pLinePlanAttributeItem_2.LinePlanAttributeItemID  = @LinePlanAttributeItemId2
	AND pLinePlanAttributeItem_3.LinePlanAttributeItemID  = @LinePlanAttributeItemId3
	ORDER BY LinePlanAttributeHeader1, LinePlanAttributeHeader2, LinePlanAttributeHeader3, LinePlanAttributeHeader4

END 
ELSE IF @LinePlanIndex  = '4' 
BEGIN 

	SELECT pLinePlanRange.LinePlanRangeID, pLinePlanAttributeItem_1.LinePlanAttributeItemID AS LinePlanAttributeItemID1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeItemID AS LinePlanAttributeItemID2, pLinePlanAttributeItem_3.LinePlanAttributeItemID AS LinePlanAttributeItemID3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeItemID AS LinePlanAttributeItemID4, pLinePlanAttributeItem_1.LinePlanAttributeText AS LinePlanAttributeHeader1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeText AS LinePlanAttributeHeader2, pLinePlanAttributeItem_3.LinePlanAttributeText AS LinePlanAttributeHeader3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeText AS LinePlanAttributeHeader4
	FROM dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_3 RIGHT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_1 RIGHT OUTER JOIN
	  dbo.pLinePlanRange ON pLinePlanAttributeItem_1.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID1 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_2 ON dbo.pLinePlanRange.LinePlanAttributeItemID2 = pLinePlanAttributeItem_2.LinePlanAttributeItemID ON 
	  pLinePlanAttributeItem_3.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID3 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_4 ON dbo.pLinePlanRange.LinePlanAttributeItemID4 = pLinePlanAttributeItem_4.LinePlanAttributeItemID
	WHERE pLinePlanAttributeItem_1.LinePlanID = @LinePlanID AND pLinePlanRange.LinePlanFinancialID = '10000000-0000-0000-0000-000000000001' AND 
		pLinePlanRange.LinePlanRangeID NOT IN (SELECT LinePlanRangeID FROM pLinePlanMaterialItem WHERE 
		MaterialID = @MaterialID) 
	AND pLinePlanAttributeItem_1.LinePlanAttributeItemID  = @LinePlanAttributeItemId1
	AND pLinePlanAttributeItem_2.LinePlanAttributeItemID  = @LinePlanAttributeItemId2
	AND pLinePlanAttributeItem_3.LinePlanAttributeItemID  = @LinePlanAttributeItemId3
	AND pLinePlanAttributeItem_4.LinePlanAttributeItemID  = @LinePlanAttributeItemId4
	ORDER BY LinePlanAttributeHeader1, LinePlanAttributeHeader2, LinePlanAttributeHeader3, LinePlanAttributeHeader4

END 















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_LinePlanMaterialItemNew_SEL]'
GO
ALTER VIEW dbo.vwx_LinePlanMaterialItemNew_SEL
AS
SELECT     dbo.pMaterial.MaterialID, dbo.pMaterial.MaterialImageID, dbo.pMaterial.MaterialImageVersion, dbo.pMaterial.MaterialImageDetailID, 
                      dbo.pMaterial.MaterialImageDetailVersion, dbo.pMaterial.MaterialType, dbo.pMaterial.MaterialNo, dbo.pMaterial.MaterialName, dbo.pMaterial.A, 
                      dbo.pMaterial.B, dbo.pMaterial.C, dbo.pMaterial.D, dbo.pMaterial.E, dbo.pMaterial.F, dbo.pMaterial.G, dbo.pMaterial.H, dbo.pMaterial.I, 
                      dbo.pMaterial.J, dbo.pMaterial.K, dbo.pMaterial.L, dbo.pMaterial.M, dbo.pMaterial.N, dbo.pMaterial.O, dbo.pMaterial.P, dbo.pMaterial.Q, 
                      dbo.pMaterial.R, dbo.pMaterial.S, dbo.pMaterial.T, dbo.pMaterial.U, dbo.pMaterial.V, dbo.pMaterial.W, dbo.pMaterial.X, dbo.pMaterial.Y, 
                      dbo.pMaterial.Z, dbo.pMaterial.MaterialPlacement, dbo.pLinePlanMaterialItem.LinePlanMaterialItemID, dbo.pLinePlanMaterialItem.LinePlanID, 
                      dbo.pLinePlanMaterialItem.LinePlanRangeID, dbo.pLinePlanMaterialItem.CUser, dbo.pLinePlanMaterialItem.CDate, dbo.pLinePlanMaterialItem.MUser, 
                      dbo.pLinePlanMaterialItem.MDate, dbo.pMaterial.MaterialCode
FROM         dbo.pMaterial INNER JOIN
                      dbo.pLinePlanMaterialItem ON dbo.pMaterial.MaterialID = dbo.pLinePlanMaterialItem.MaterialID
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanStyleAttribute_Range_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_LinePlanStyleAttribute_Range_SELECT] (
@LinePlanRangeID UNIQUEIDENTIFIER 
)
AS 

	DECLARE @LinePlanAttributeItemID1 UNIQUEIDENTIFIER 
	DECLARE @LinePlanAttributeItemID2 UNIQUEIDENTIFIER 
	DECLARE @LinePlanAttributeItemID3 UNIQUEIDENTIFIER 
	DECLARE @LinePlanAttributeItemID4 UNIQUEIDENTIFIER 


	SELECT @LinePlanAttributeItemID1 = LinePlanAttributeItemID1, @LinePlanAttributeItemID2 = LinePlanAttributeItemID2,
	@LinePlanAttributeItemID3 = LinePlanAttributeItemID3, @LinePlanAttributeItemID4 = LinePlanAttributeItemID4	
	FROM pLinePlanRange
	WHERE LinePlanRangeID = @LinePlanRangeID 

	SELECT * FROM pLinePlanStyleAttributeItem
	WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
	AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
	AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3
	






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pComponentType]'
GO
ALTER TABLE [dbo].[pComponentType] ADD
[ComponentTradePartnerColorSchema] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ComponentTradePartnerPrintSchema] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pImageType]'
GO
ALTER TABLE [dbo].[pImageType] ADD
[ImageCode] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pImageType] ALTER COLUMN [CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[pImageType] ALTER COLUMN [MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[pImageType] ALTER COLUMN [Active] [int] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pPOMLibrary]'
GO
ALTER TABLE [dbo].[pPOMLibrary] ADD
[SystemServerStorageID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_pPOMLibrary_SystemServerStorageID] DEFAULT ('00000000-0000-0000-0000-000000000000')
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pSampleRequestQAWorksheet]'
GO
CREATE TABLE [dbo].[pSampleRequestQAWorksheet]
(
[SampleRequestQAWorksheetID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_pSampleRequestQAWorksheet_SampleRequestQAWorksheetID] DEFAULT (newsequentialid()),
[SampleRequestQAWorksheetSizeID] [uniqueidentifier] NULL,
[SampleRequestTradeID] [uniqueidentifier] NULL,
[SampleRequestWorkflowID] [uniqueidentifier] NULL,
[SampleWorkflowID] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[TradePartnerVendorID] [uniqueidentifier] NULL,
[WorkflowID] [uniqueidentifier] NULL,
[SpecMasterID] [uniqueidentifier] NULL,
[POMTempItemID] [uniqueidentifier] NULL,
[POMLibraryID] [uniqueidentifier] NULL,
[ModelSpecID] [uniqueidentifier] NULL,
[ModelID] [uniqueidentifier] NULL,
[POMTempID] [uniqueidentifier] NULL,
[StyleID] [uniqueidentifier] NULL,
[StyleColorID] [uniqueidentifier] NULL,
[Submit] [int] NULL,
[Critical] [int] NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Critical] DEFAULT ((0)),
[SpecID] [uniqueidentifier] NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_SpecID] DEFAULT (newid()),
[StyleSet] [int] NULL,
[POM] [nvarchar] (10) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[PointMeasur] [nvarchar] (225) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[TOL] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_TOL] DEFAULT ((0)),
[TOLN] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_TOLN] DEFAULT ((0)),
[Asked] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Asked] DEFAULT ((0)),
[Ask000] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Ask000] DEFAULT ((0)),
[Ask001] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Ask001] DEFAULT ((0)),
[Ask002] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Ask002] DEFAULT ((0)),
[Ask003] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Ask003] DEFAULT ((0)),
[Ask004] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Ask004] DEFAULT ((0)),
[Ask005] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Ask005] DEFAULT ((0)),
[Ask006] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Ask006] DEFAULT ((0)),
[Ask007] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Ask007] DEFAULT ((0)),
[Ask008] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Ask008] DEFAULT ((0)),
[Ask009] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Ask009] DEFAULT ((0)),
[Ask010] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Ask010] DEFAULT ((0)),
[Ask011] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Ask011] DEFAULT ((0)),
[Ask012] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Ask012] DEFAULT ((0)),
[Ask013] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Ask013] DEFAULT ((0)),
[Ask014] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Ask014] DEFAULT ((0)),
[Ask015] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Ask015] DEFAULT ((0)),
[Ask016] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Ask016] DEFAULT ((0)),
[Ask017] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Ask017] DEFAULT ((0)),
[Ask018] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Ask018] DEFAULT ((0)),
[Ask019] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Ask019] DEFAULT ((0)),
[Spec000] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec000] DEFAULT ((0)),
[Spec001] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec001] DEFAULT ((0)),
[Spec002] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec002] DEFAULT ((0)),
[Spec003] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec003] DEFAULT ((0)),
[Spec004] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec004] DEFAULT ((0)),
[Spec005] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec005] DEFAULT ((0)),
[Spec006] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec006] DEFAULT ((0)),
[Spec007] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec007] DEFAULT ((0)),
[Spec008] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec008] DEFAULT ((0)),
[Spec009] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec009] DEFAULT ((0)),
[Spec010] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec010] DEFAULT ((0)),
[Spec011] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec011] DEFAULT ((0)),
[Spec012] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec012] DEFAULT ((0)),
[Spec013] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec013] DEFAULT ((0)),
[Spec014] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec014] DEFAULT ((0)),
[Spec015] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec015] DEFAULT ((0)),
[Spec016] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec016] DEFAULT ((0)),
[Spec017] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec017] DEFAULT ((0)),
[Spec018] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec018] DEFAULT ((0)),
[Spec019] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec019] DEFAULT ((0)),
[Spec020] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec020] DEFAULT ((0)),
[Spec021] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec021] DEFAULT ((0)),
[Spec022] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec022] DEFAULT ((0)),
[Spec023] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec023] DEFAULT ((0)),
[Spec024] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec024] DEFAULT ((0)),
[Spec025] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec025] DEFAULT ((0)),
[Spec026] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec026] DEFAULT ((0)),
[Spec027] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec027] DEFAULT ((0)),
[Spec028] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec028] DEFAULT ((0)),
[Spec029] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec029] DEFAULT ((0)),
[Spec030] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec030] DEFAULT ((0)),
[Spec031] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec031] DEFAULT ((0)),
[Spec032] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec032] DEFAULT ((0)),
[Spec033] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec033] DEFAULT ((0)),
[Spec034] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec034] DEFAULT ((0)),
[Spec035] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec035] DEFAULT ((0)),
[Spec036] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec036] DEFAULT ((0)),
[Spec037] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec037] DEFAULT ((0)),
[Spec038] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec038] DEFAULT ((0)),
[Spec039] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec039] DEFAULT ((0)),
[Spec040] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec040] DEFAULT ((0)),
[Spec041] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec041] DEFAULT ((0)),
[Spec042] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec042] DEFAULT ((0)),
[Spec043] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec043] DEFAULT ((0)),
[Spec044] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec044] DEFAULT ((0)),
[Spec045] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec045] DEFAULT ((0)),
[Spec046] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec046] DEFAULT ((0)),
[Spec047] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec047] DEFAULT ((0)),
[Spec048] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec048] DEFAULT ((0)),
[Spec049] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec049] DEFAULT ((0)),
[Spec050] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec050] DEFAULT ((0)),
[Spec051] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec051] DEFAULT ((0)),
[Spec052] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec052] DEFAULT ((0)),
[Spec053] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec053] DEFAULT ((0)),
[Spec054] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec054] DEFAULT ((0)),
[Spec055] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec055] DEFAULT ((0)),
[Spec056] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec056] DEFAULT ((0)),
[Spec057] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec057] DEFAULT ((0)),
[Spec058] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec058] DEFAULT ((0)),
[Spec059] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec059] DEFAULT ((0)),
[Spec060] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec060] DEFAULT ((0)),
[Spec061] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec061] DEFAULT ((0)),
[Spec062] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec062] DEFAULT ((0)),
[Spec063] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec063] DEFAULT ((0)),
[Spec064] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec064] DEFAULT ((0)),
[Spec065] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec065] DEFAULT ((0)),
[Spec066] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec066] DEFAULT ((0)),
[Spec067] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec067] DEFAULT ((0)),
[Spec068] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec068] DEFAULT ((0)),
[Spec069] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec069] DEFAULT ((0)),
[Spec070] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec070] DEFAULT ((0)),
[Spec071] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec071] DEFAULT ((0)),
[Spec072] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec072] DEFAULT ((0)),
[Spec073] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec073] DEFAULT ((0)),
[Spec074] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec074] DEFAULT ((0)),
[Spec075] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec075] DEFAULT ((0)),
[Spec076] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec076] DEFAULT ((0)),
[Spec077] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec077] DEFAULT ((0)),
[Spec078] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec078] DEFAULT ((0)),
[Spec079] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec079] DEFAULT ((0)),
[Spec080] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec080] DEFAULT ((0)),
[Spec081] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec081] DEFAULT ((0)),
[Spec082] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec082] DEFAULT ((0)),
[Spec083] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec083] DEFAULT ((0)),
[Spec084] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec084] DEFAULT ((0)),
[Spec085] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec085] DEFAULT ((0)),
[Spec086] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec086] DEFAULT ((0)),
[Spec087] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec087] DEFAULT ((0)),
[Spec088] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec088] DEFAULT ((0)),
[Spec089] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec089] DEFAULT ((0)),
[Spec090] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec090] DEFAULT ((0)),
[Spec091] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec091] DEFAULT ((0)),
[Spec092] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec092] DEFAULT ((0)),
[Spec093] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec093] DEFAULT ((0)),
[Spec094] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec094] DEFAULT ((0)),
[Spec095] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec095] DEFAULT ((0)),
[Spec096] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec096] DEFAULT ((0)),
[Spec097] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec097] DEFAULT ((0)),
[Spec098] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec098] DEFAULT ((0)),
[Spec099] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec099] DEFAULT ((0)),
[Spec100] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec100] DEFAULT ((0)),
[Spec101] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec101] DEFAULT ((0)),
[Spec102] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec102] DEFAULT ((0)),
[Spec103] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec103] DEFAULT ((0)),
[Spec104] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec104] DEFAULT ((0)),
[Spec105] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec105] DEFAULT ((0)),
[Spec106] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec106] DEFAULT ((0)),
[Spec107] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec107] DEFAULT ((0)),
[Spec108] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec108] DEFAULT ((0)),
[Spec109] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec109] DEFAULT ((0)),
[Spec110] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec110] DEFAULT ((0)),
[Spec111] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec111] DEFAULT ((0)),
[Spec112] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec112] DEFAULT ((0)),
[Spec113] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec113] DEFAULT ((0)),
[Spec114] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec114] DEFAULT ((0)),
[Spec115] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec115] DEFAULT ((0)),
[Spec116] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec116] DEFAULT ((0)),
[Spec117] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec117] DEFAULT ((0)),
[Spec118] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec118] DEFAULT ((0)),
[Spec119] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec119] DEFAULT ((0)),
[Spec120] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec120] DEFAULT ((0)),
[Spec121] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec121] DEFAULT ((0)),
[Spec122] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec122] DEFAULT ((0)),
[Spec123] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec123] DEFAULT ((0)),
[Spec124] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec124] DEFAULT ((0)),
[Spec125] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec125] DEFAULT ((0)),
[Spec126] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec126] DEFAULT ((0)),
[Spec127] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec127] DEFAULT ((0)),
[Spec128] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec128] DEFAULT ((0)),
[Spec129] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec129] DEFAULT ((0)),
[Spec130] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec130] DEFAULT ((0)),
[Spec131] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec131] DEFAULT ((0)),
[Spec132] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec132] DEFAULT ((0)),
[Spec133] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec133] DEFAULT ((0)),
[Spec134] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec134] DEFAULT ((0)),
[Spec135] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec135] DEFAULT ((0)),
[Spec136] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec136] DEFAULT ((0)),
[Spec137] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec137] DEFAULT ((0)),
[Spec138] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec138] DEFAULT ((0)),
[Spec139] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec139] DEFAULT ((0)),
[Spec140] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec140] DEFAULT ((0)),
[Spec141] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec141] DEFAULT ((0)),
[Spec142] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec142] DEFAULT ((0)),
[Spec143] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec143] DEFAULT ((0)),
[Spec144] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec144] DEFAULT ((0)),
[Spec145] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec145] DEFAULT ((0)),
[Spec146] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec146] DEFAULT ((0)),
[Spec147] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec147] DEFAULT ((0)),
[Spec148] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec148] DEFAULT ((0)),
[Spec149] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec149] DEFAULT ((0)),
[Spec150] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec150] DEFAULT ((0)),
[Spec151] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec151] DEFAULT ((0)),
[Spec152] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec152] DEFAULT ((0)),
[Spec153] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec153] DEFAULT ((0)),
[Spec154] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec154] DEFAULT ((0)),
[Spec155] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec155] DEFAULT ((0)),
[Spec156] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec156] DEFAULT ((0)),
[Spec157] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec157] DEFAULT ((0)),
[Spec158] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec158] DEFAULT ((0)),
[Spec159] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec159] DEFAULT ((0)),
[Spec160] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec160] DEFAULT ((0)),
[Spec161] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec161] DEFAULT ((0)),
[Spec162] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec162] DEFAULT ((0)),
[Spec163] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec163] DEFAULT ((0)),
[Spec164] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec164] DEFAULT ((0)),
[Spec165] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec165] DEFAULT ((0)),
[Spec166] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec166] DEFAULT ((0)),
[Spec167] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec167] DEFAULT ((0)),
[Spec168] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec168] DEFAULT ((0)),
[Spec169] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec169] DEFAULT ((0)),
[Spec170] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec170] DEFAULT ((0)),
[Spec171] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec171] DEFAULT ((0)),
[Spec172] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec172] DEFAULT ((0)),
[Spec173] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec173] DEFAULT ((0)),
[Spec174] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec174] DEFAULT ((0)),
[Spec175] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec175] DEFAULT ((0)),
[Spec176] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec176] DEFAULT ((0)),
[Spec177] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec177] DEFAULT ((0)),
[Spec178] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec178] DEFAULT ((0)),
[Spec179] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec179] DEFAULT ((0)),
[Spec180] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec180] DEFAULT ((0)),
[Spec181] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec181] DEFAULT ((0)),
[Spec182] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec182] DEFAULT ((0)),
[Spec183] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec183] DEFAULT ((0)),
[Spec184] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec184] DEFAULT ((0)),
[Spec185] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec185] DEFAULT ((0)),
[Spec186] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec186] DEFAULT ((0)),
[Spec187] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec187] DEFAULT ((0)),
[Spec188] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec188] DEFAULT ((0)),
[Spec189] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec189] DEFAULT ((0)),
[Spec190] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec190] DEFAULT ((0)),
[Spec191] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec191] DEFAULT ((0)),
[Spec192] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec192] DEFAULT ((0)),
[Spec193] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec193] DEFAULT ((0)),
[Spec194] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec194] DEFAULT ((0)),
[Spec195] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec195] DEFAULT ((0)),
[Spec196] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec196] DEFAULT ((0)),
[Spec197] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec197] DEFAULT ((0)),
[Spec198] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec198] DEFAULT ((0)),
[Spec199] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec199] DEFAULT ((0)),
[Spec200] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec200] DEFAULT ((0)),
[Spec201] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec201] DEFAULT ((0)),
[Spec202] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec202] DEFAULT ((0)),
[Spec203] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec203] DEFAULT ((0)),
[Spec204] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec204] DEFAULT ((0)),
[Spec205] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec205] DEFAULT ((0)),
[Spec206] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec206] DEFAULT ((0)),
[Spec207] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec207] DEFAULT ((0)),
[Spec208] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec208] DEFAULT ((0)),
[Spec209] [numeric] (18, 4) NOT NULL CONSTRAINT [DF_pSampleRequestQAWorksheet_Spec209] DEFAULT ((0)),
[CDate] [datetime] NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Change] [int] NULL,
[Sort] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[HowToMeasurText] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[HowToMeasurImage] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pSampleRequestQAWorksheet] on [dbo].[pSampleRequestQAWorksheet]'
GO
ALTER TABLE [dbo].[pSampleRequestQAWorksheet] ADD CONSTRAINT [PK_pSampleRequestQAWorksheet] PRIMARY KEY CLUSTERED  ([SampleRequestQAWorksheetID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pMaterialRequestWorkflow]'
GO
ALTER TABLE [dbo].[pMaterialRequestWorkflow] ADD
[MaterialRequestWorkflowControlSchema] [varchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MaterialRequestWorkflowColor] [int] NOT NULL CONSTRAINT [DF_pMaterialRequestWorkflow_MaterialRequestWorkflowColor] DEFAULT ((1)),
[MaterialRequestSubmitHeaderPrintSchema] [varchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MaterialRequestSubmitBodyPrintSchema] [varchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pMaterialRequestSubmitWorkflow]'
GO
ALTER TABLE [dbo].[pMaterialRequestSubmitWorkflow] ADD
[MaterialRequestSubmitGroupID] [uniqueidentifier] NULL,
[MaterialRequestWorkflowGroupID] [uniqueidentifier] NULL,
[MaterialRequestSubmitAllColors] [int] NULL CONSTRAINT [DF_pMaterialRequestSubmitWorkflow_MaterialRequestSubmitAllColors] DEFAULT ((0)),
[Active] [int] NOT NULL CONSTRAINT [DF_pMaterialRequestSubmitWorkflow_Active] DEFAULT ((1))
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pMaterialRequestSubmitStatus]'
GO
ALTER TABLE [dbo].[pMaterialRequestSubmitStatus] ADD
[StatusIcon] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pMaterialTradePartner]'
GO
ALTER TABLE [dbo].[pMaterialTradePartner] ALTER COLUMN [MaterialTradePartnerCustom5] [nvarchar] (max) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[pMaterialTradePartner] ALTER COLUMN [MaterialTradePartnerCustom6] [nvarchar] (max) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pMaterialRequestWorkflowTemplate]'
GO
ALTER TABLE [dbo].[pMaterialRequestWorkflowTemplate] ADD
[MaterialRequestWorkflowTempStartDate] [datetime] NULL,
[MaterialRequestWorkflowTempDueDate] [datetime] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pMaterialRequestWorkflowTemplateItem]'
GO
ALTER TABLE [dbo].[pMaterialRequestWorkflowTemplateItem] ADD
[MaterialRequestWorkflowGroupID] [uniqueidentifier] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pMaterialRequestWorkflowTemplateItem] ALTER COLUMN [MaterialRequestWorkflowAssignedTo] [int] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pLineFolderItem]'
GO
ALTER TABLE [dbo].[pLineFolderItem] ADD
[StyleSeasonYearID] [uniqueidentifier] NULL CONSTRAINT [DF_pLineFolderItem_StyleSeasonYearID] DEFAULT ('00000000-0000-0000-0000-000000000000')
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pLinePlanMaterialItemTemp]'
GO
CREATE TABLE [dbo].[pLinePlanMaterialItemTemp]
(
[LinePlanMaterialItemTempID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_pLinePlanMaterialItemTemp_LinePlanMaterialItemTempID] DEFAULT (newid()),
[LinePlanMaterialItemID] [uniqueidentifier] NULL,
[LinePlanColorGroupID] [uniqueidentifier] NULL,
[LinePlanID] [uniqueidentifier] NULL,
[LinePlanRangeID] [uniqueidentifier] NULL,
[MaterialID] [uniqueidentifier] NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pLinePlanMaterialItemTemp] on [dbo].[pLinePlanMaterialItemTemp]'
GO
ALTER TABLE [dbo].[pLinePlanMaterialItemTemp] ADD CONSTRAINT [PK_pLinePlanMaterialItemTemp] PRIMARY KEY CLUSTERED  ([LinePlanMaterialItemTempID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_LinePlanMaterialItemRollup1_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_LinePlanMaterialItemRollup1_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_SampleRequestQAItemPomTemplate_INSERT]'
GO


CREATE PROCEDURE [dbo].[spx_SampleRequestQAItemPomTemplate_INSERT](
@POMTempItemID uniqueidentifier,
@SampleRequestQAWorksheetID uniqueidentifier,
@SampleRequestTradeID uniqueidentifier,
@SampleRequestWorkflowID uniqueidentifier,
@SampleWorkflowID varchar(40),
@TradePartnerVendorID uniqueidentifier,
@StyleColorID uniqueidentifier,
@StyleID uniqueidentifier,
@StyleSet varchar(2),
@Submit varchar(2),
@CreatedDate datetime,
@CreatedBy nvarchar(200))

AS 

BEGIN

	INSERT INTO pSampleRequestQAWorksheet
		  (SampleRequestQAWorksheetID, POMTempID, Critical, POMTempItemID, POM, PointMeasur, TOL, TOLN, Sort, Change, 
		  SampleRequestTradeID, SampleRequestWorkflowID, SampleWorkflowID, TradePartnerVendorID, StyleColorID, StyleID, StyleSet, Submit, 
		  POMLibraryID, CDate, CUser, MDate, MUser)
	SELECT @SampleRequestQAWorksheetID, POMTempID, Critical, POMTempItemID, POM, PointMeasur, TOL, TOLN, Sort, Change, 
		  @SampleRequestTradeID AS SampleRequestTradeID, @SampleRequestWorkflowID AS SampleRequestWorkflowID, 
		  @SampleWorkflowID AS SampleWorkflowID, @TradePartnerVendorID AS TradePartnerVendorID, @StyleColorID AS StyleColorID, @StyleID AS StyleID, 
		  @StyleSet AS StyleSet, @Submit AS Submit, POMLibraryID, @CreatedDate AS CDate, @CreatedBy AS CUser, @CreatedDate AS MDate, 
		  @CreatedBy AS MUser
	FROM  pPOMTemplateItem WITH (NOLOCK)
	WHERE (POMTempItemID = @POMTempItemID)

END




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[dpx_SampleRequestSubmit_Score_SELECT]'
GO



ALTER  PROCEDURE [dbo].[dpx_SampleRequestSubmit_Score_SELECT]
(
	 @DateFrom  			datetime=NULL
	,@DateTo    			datetime=NULL
	,@Weight_Approved		float
	,@Weight_Average		float
	,@Weight_OverDue		float
	,@SubstractPercentPerSubmit  	float
	,@MinNumSubmitsForReporting	int
	,@SortBy			int
	--,@SeasonYearID		uniqueidentifier
)
WITH RECOMPILE
AS

DECLARE @SeasonYearID uniqueidentifier
IF @SeasonYearID IS NULL
BEGIN 
	SELECT TOP 1 @SeasonYearID = SeasonYearID FROM pSeasonYear WHERE CurrentSeason = 1
END


CREATE TABLE #tempStyleSeasonYear(
	StyleID uniqueidentifier,
	SeasonYearID uniqueidentifier
)

INSERT INTO #tempStyleSeasonYear (StyleID, SeasonYearID)
SELECT StyleID, SeasonYearID FROM pStyleSeasonYear 
WHERE SeasonYearID = @SeasonYearID


-- Declare variables.
DECLARE @MinSmplWrkflowSort int
DECLARE @MaxSortNum	    int
-- Make a temporary tables
-- Grouped by Request
CREATE TABLE #TempScore
(
	TrdPartnerID 		 uniqueidentifier
	,TrdPrtVendorID 	 uniqueidentifier
        ,StyleID		 uniqueidentifier
       	,SmplWrkFlowID    	 nvarchar(50)
	,SmplReqWrkFlowID 	 uniqueidentifier
       	,num_submit     	 int
	,num_open 		 int
	,num_resub       	 int
	,num_appcorr   		 int
	,num_approv      	 int
	,num_drop        	 int
	,num_overdue		 int
)
CREATE TABLE #TempWrkFlowSort
(
	SmplWrkFlowID		nvarchar(50),
	SmplWrkFlowSortNum	int
)
-- To insert summary records of integer values for each group of TrdPrtVendorID
CREATE TABLE #TempFinal (
TrdPartnerID	    	nvarchar(40),
TradePartnerName	nvarchar(100),
TrdPrtVendorID		nvarchar(40),
VendorName		nvarchar(100),
SmplWrkFlowID		nvarchar(50),
SampleWorkflow		nvarchar(50),
tot_appcorr   	 	 int,
tot_approv 		 int,
tot_drop	       	 int,
tot_overdue   		 float,
tot_submit      	 float,
tot_approv_request     	 int,
tot_approv_submit	 float,
tot_approv_average	 float,
tot_non_pending_submit	 float,
tot_style		 float,
tot_style_approv         float,
smplWrkFlowSortNum 	 int,
MaxSortNum	    	 int,
tot_submit_vendor	 int,
total_score		 float
)
--Set Default weights for the score for tests
--SET @Weight_Approved	  = 33.34
--SET @Weight_Average     = 33.33
--SET @Weight_OverDue     = 33.33
-- Get minimum value of SampleWorkflowSort
SET @MinSmplWrkflowSort = (SELECT MIN(SampleWorkflowSort) FROM pSampleWorkflow WITH (NOLOCK))
--Insert the sequential index into the temp table
INSERT INTO #TempWrkFlowSort (SmplWrkFlowID, SmplWrkFlowSortNum)
SELECT 				SampleWorkflowID 
     AS SmplWrkFlowID,
			       (SELECT 	count(*)
			        FROM 	pSampleWorkflow pp WITH (NOLOCK)
			        WHERE	pp.SampleWorkflowSort <= aa.SampleWorkflowSort
				   and  pp.SampleWorkflowSort >= @MinSmplWrkflowSort
				   and  pp.SampleWorkflowID   <= aa.SampleWorkflowID
   ) AS  SmplWrkFlowSortNum
FROM pSampleWorkflow aa WITH (NOLOCK)
ORDER BY aa.SampleWorkflowSort, aa.SampleWorkflowID
IF ((@DateFrom IS NOT NULL)  AND (@DateTo IS NOT NULL)) --Just due to SQL2000 can not handle null parameter well on dates
BEGIN
		--Insert the num of cases  into the temp table.
		INSERT INTO #TempScore (TrdPartnerID, TrdPrtVendorID, StyleID, SmplWrkFlowID, 
					SmplReqWrkFlowID, 
					num_submit, num_open, num_resub, num_appcorr, num_approv, num_drop, num_overdue )
		SELECT 
		 aa.TradePartnerID as TrdPartnerID
		,aa.TradePartnerVendorID as TrdPrtVendorID
		,aa.StyleID
		,aa.SampleWorkflowID as SmplWrkFlowID
		,aa.SampleRequestWorkflowID as SmplReqWrkFlowID
		,                (SELECT  count(*) as count_submits FROM pSampleRequestSubmit a9   
				  WHERE a9.DueDate >= @DateFrom
				   and  a9.DueDate < @DateTo
				   --and  a9.DueDate < GETDATE() -- For overdue rate calculation 
				   and ((a9.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR ( a9.TradePartnerID = aa.TradePartnerID))
				   and  a9.TradePartnerVendorID = aa.TradePartnerVendorID
				   and  a9.SampleWorkflowID = aa.SampleWorkflowID
		           and  a9.SampleRequestWorkflowID = aa.SampleRequestWorkflowID -- No need to check due date once id is the same
				   AND a9.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		)  AS num_submit
		,
				(SELECT  count(a0.status) as count0 FROM pSampleRequestSubmit a0  
				  WHERE a0.status = 0 
				   and ((a0.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR ( a0.TradePartnerID = aa.TradePartnerID))
				   and  a0.TradePartnerVendorID = aa.TradePartnerVendorID
				   and  a0.SampleWorkflowID = aa.SampleWorkflowID
		           and  a0.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
				   AND a0.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		
		 )  AS num_open
		,
				(SELECT count(a1.status) as count1 FROM pSampleRequestSubmit a1  
				  WHERE a1.status = 1 
				   and ((a1.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				       OR ( a1.TradePartnerID = aa.TradePartnerID))
				   and a1.TradePartnerVendorID = aa.TradePartnerVendorID
				   and a1.SampleWorkflowID = aa.SampleWorkflowID
				   and a1.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
				   AND a1.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		
		 )  AS num_resub
		,
				(SELECT count(a2.status) as count0 FROM pSampleRequestSubmit a2 
				  WHERE a2.status = 2 
				    and ((a2.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR ( a2.TradePartnerID = aa.TradePartnerID))
				    and a2.TradePartnerVendorID = aa.TradePartnerVendorID
				    and a2.SampleWorkflowID = aa.SampleWorkflowID
		            and a2.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a2.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		
		 )  AS num_appcorr
		,
				(SELECT count(a3.status) as count0 FROM pSampleRequestSubmit a3  
				  WHERE a3.status = 3 
				   and ((a3.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR (a3.TradePartnerID = aa.TradePartnerID))
				   and a3.TradePartnerVendorID = aa.TradePartnerVendorID
		                   and a3.SampleWorkflowID = aa.SampleWorkflowID
		                   and a3.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a3.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		
		 )  AS num_approv
		,
				(SELECT count(a4.status) as count4 FROM pSampleRequestSubmit a4  
				  WHERE a4.status = 4 
				  and ((a4.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR ( a4.TradePartnerID = aa.TradePartnerID))
				  and a4.TradePartnerVendorID = aa.TradePartnerVendorID
		                  and a4.SampleWorkflowID = aa.SampleWorkflowID
		                  and a4.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a4.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		
		 )  AS num_drop
		,
		 (SELECT count(*) as count4 FROM pSampleRequestSubmit a4  
				  WHERE 
                                      a4.MDate > a4.Duedate 
				  and (
					    (a4.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR (a4.TradePartnerID = aa.TradePartnerID)
				       )
				  and a4.TradePartnerVendorID = aa.TradePartnerVendorID
		            and a4.SampleWorkflowID = aa.SampleWorkflowID
		            and a4.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a4.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		 )  AS num_overdue
		
		FROM
			pSampleRequestSubmit aa 
		WHERE 
			--aa.DueDate >= @DateFrom and aa.DueDate <= @DateTo
		              ((aa.DueDate > @DateFrom) OR   (DATEDIFF(day,  aa.DueDate,  @DateFrom) = 0 ) )  
		               AND
		              ((aa.DueDate < @DateTo) OR   (DATEDIFF(day,  aa.DueDate,  @DateTo) = 0 ) )    
						AND aa.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)       
		GROUP BY 
				         aa.TradePartnerID 
					,aa.TradePartnerVendorID
					,aa.StyleID
		            ,aa.SampleWorkflowID
					,aa.SampleRequestWorkflowID
		ORDER BY
				     aa.TradePartnerID 
					,aa.TradePartnerVendorID
					,aa.StyleID
		            ,aa.SampleWorkflowID
					,aa.SampleRequestWorkflowID
    END
ELSE IF  ((@DateFrom IS NULL)  AND (@DateTo IS NOT NULL))
    BEGIN
    --Insert the num of cases  into the temp table.
		INSERT INTO #TempScore (TrdPartnerID, TrdPrtVendorID, StyleID, SmplWrkFlowID, 
					SmplReqWrkFlowID, 
					num_submit, num_open, num_resub, num_appcorr, num_approv, num_drop, num_overdue  )
		SELECT 
		 aa.TradePartnerID as TrdPartnerID
		,aa.TradePartnerVendorID as TrdPrtVendorID
		,aa.StyleID
		,aa.SampleWorkflowID as SmplWrkFlowID
		,aa.SampleRequestWorkflowID as SmplReqWrkFlowID
		,                (SELECT  count(*) as count_submits FROM pSampleRequestSubmit a9  
				 WHERE a9.DueDate < @DateTo
			           --and  a9.DueDate < GETDATE() -- For overdue rate calculation 
				   and ((a9.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR ( a9.TradePartnerID = aa.TradePartnerID))
				   and  a9.TradePartnerVendorID = aa.TradePartnerVendorID
				   and  a9.SampleWorkflowID = aa.SampleWorkflowID
		                   and  a9.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a9.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		)  AS num_submit
		,
				(SELECT  count(a0.status) as count0 FROM pSampleRequestSubmit a0 
				  WHERE a0.status = 0 
				   and ((a0.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR ( a0.TradePartnerID = aa.TradePartnerID))
				   and  a0.TradePartnerVendorID = aa.TradePartnerVendorID
				   and  a0.SampleWorkflowID = aa.SampleWorkflowID
		                   and  a0.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a0.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		
		 )  AS num_open
		,
				(SELECT count(a1.status) as count1 FROM pSampleRequestSubmit a1  
				  WHERE a1.status = 1 
				   and ((a1.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				       OR ( a1.TradePartnerID = aa.TradePartnerID))
				   and a1.TradePartnerVendorID = aa.TradePartnerVendorID
				   and a1.SampleWorkflowID = aa.SampleWorkflowID
				   and a1.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a1.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		
		 )  AS num_resub
		,
				(SELECT count(a2.status) as count0 FROM pSampleRequestSubmit a2  
				  WHERE a2.status = 2 
				    and ((a2.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR ( a2.TradePartnerID = aa.TradePartnerID))
				    and a2.TradePartnerVendorID = aa.TradePartnerVendorID
				    and a2.SampleWorkflowID = aa.SampleWorkflowID
		                    and a2.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a2.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		
		 )  AS num_appcorr
		,
				(SELECT count(a3.status) as count0 FROM pSampleRequestSubmit a3  
				  WHERE a3.status = 3 
				   and ((a3.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR (a3.TradePartnerID = aa.TradePartnerID))
				   and a3.TradePartnerVendorID = aa.TradePartnerVendorID
		                   and a3.SampleWorkflowID = aa.SampleWorkflowID
		                   and a3.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
		
		 )  AS num_approv
		,
				(SELECT count(a4.status) as count4 FROM pSampleRequestSubmit a4  
				  WHERE a4.status = 4 
				  and ((a4.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR ( a4.TradePartnerID = aa.TradePartnerID))
				  and a4.TradePartnerVendorID = aa.TradePartnerVendorID
		                  and a4.SampleWorkflowID = aa.SampleWorkflowID
		                  and a4.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a4.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		
		 )  AS num_drop
		,
		 (SELECT count(*) as count4 FROM pSampleRequestSubmit a4  WITH (NOLOCK)
				  WHERE a4.MDate > a4.Duedate
				  and ((a4.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR ( a4.TradePartnerID = aa.TradePartnerID))
				  and a4.TradePartnerVendorID = aa.TradePartnerVendorID
		                  and a4.SampleWorkflowID = aa.SampleWorkflowID
		                  and a4.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a4.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		 )  AS num_overdue
		
		FROM
			pSampleRequestSubmit aa 
		WHERE 
                       -- aa.DueDate <= @DateTo
		        (aa.DueDate < @DateTo) OR   (DATEDIFF(day,  aa.DueDate,  @DateTo) = 0 )            
		GROUP BY 
				         aa.TradePartnerID 
					,aa.TradePartnerVendorID
					,aa.StyleID
		                        ,aa.SampleWorkflowID
					,aa.SampleRequestWorkflowID
		ORDER BY
				         aa.TradePartnerID 
					,aa.TradePartnerVendorID
					,aa.StyleID
		                        ,aa.SampleWorkflowID
					,aa.SampleRequestWorkflowID
    END
ELSE IF  ((@DateFrom IS NOT NULL)  AND (@DateTo IS NULL))
    BEGIN
    --Insert the num of cases  into the temp table.
		INSERT INTO #TempScore (TrdPartnerID, TrdPrtVendorID, StyleID, SmplWrkFlowID, 
					SmplReqWrkFlowID, 
					num_submit, num_open, num_resub, num_appcorr, num_approv, num_drop, num_overdue  )
		SELECT 
		 aa.TradePartnerID as TrdPartnerID
		,aa.TradePartnerVendorID as TrdPrtVendorID
		,aa.StyleID
		,aa.SampleWorkflowID as SmplWrkFlowID
		,aa.SampleRequestWorkflowID as SmplReqWrkFlowID
		,                (SELECT  count(*) as count_submits FROM pSampleRequestSubmit a9  
				  WHERE a9.DueDate >= @DateFrom
                                   --and a9.DueDate <  GETDATE()
				   and ((a9.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR ( a9.TradePartnerID = aa.TradePartnerID))
				   and  a9.TradePartnerVendorID = aa.TradePartnerVendorID
				   and  a9.SampleWorkflowID = aa.SampleWorkflowID
		                   and  a9.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a9.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		)  AS num_submit
		,
				(SELECT  count(a0.status) as count0 FROM pSampleRequestSubmit a0  
				  WHERE a0.status = 0 
				   and ((a0.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR ( a0.TradePartnerID = aa.TradePartnerID))
				   and  a0.TradePartnerVendorID = aa.TradePartnerVendorID
				   and  a0.SampleWorkflowID = aa.SampleWorkflowID
		                   and  a0.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a0.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		
		 )  AS num_open
		,
				(SELECT count(a1.status) as count1 FROM pSampleRequestSubmit a1  
				  WHERE a1.status = 1 
				   and ((a1.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				       OR ( a1.TradePartnerID = aa.TradePartnerID))
				   and a1.TradePartnerVendorID = aa.TradePartnerVendorID
				   and a1.SampleWorkflowID = aa.SampleWorkflowID
				   and a1.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a1.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		
		 )  AS num_resub
		,
				(SELECT count(a2.status) as count0 FROM pSampleRequestSubmit a2  
				  WHERE a2.status = 2 
				    and ((a2.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR ( a2.TradePartnerID = aa.TradePartnerID))
				    and a2.TradePartnerVendorID = aa.TradePartnerVendorID
				    and a2.SampleWorkflowID = aa.SampleWorkflowID
		                    and a2.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a2.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		
		 )  AS num_appcorr
		,
				(SELECT count(a3.status) as count0 FROM pSampleRequestSubmit a3  
				  WHERE a3.status = 3 
				   and ((a3.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR (a3.TradePartnerID = aa.TradePartnerID))
				   and a3.TradePartnerVendorID = aa.TradePartnerVendorID
		                   and a3.SampleWorkflowID = aa.SampleWorkflowID
		                   and a3.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a3.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		
		 )  AS num_approv
		,
				(SELECT count(a4.status) as count4 FROM pSampleRequestSubmit a4  
				  WHERE a4.status = 4 
				  and ((a4.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR ( a4.TradePartnerID = aa.TradePartnerID))
				  and a4.TradePartnerVendorID = aa.TradePartnerVendorID
		                  and a4.SampleWorkflowID = aa.SampleWorkflowID
		                  and a4.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a4.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		
		 )  AS num_drop
		,
		 (SELECT count(*) as count5 FROM pSampleRequestSubmit a5  
				  WHERE a5.MDate > a5.Duedate
				  and ((a5.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR ( a5.TradePartnerID = aa.TradePartnerID))
				  and a5.TradePartnerVendorID = aa.TradePartnerVendorID
		                  and a5.SampleWorkflowID = aa.SampleWorkflowID
		                  and a5.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a5.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		 )  AS num_overdue
		
		FROM
			pSampleRequestSubmit aa 
		WHERE 
                        --- when input parameter @DateTo is null
			--aa.DueDate >= @DateFrom 
			 (aa.DueDate > @DateFrom) OR   (DATEDIFF(day,  aa.DueDate,  @DateFrom) = 0 )           
		GROUP BY 
				         aa.TradePartnerID 
					,aa.TradePartnerVendorID
					,aa.StyleID
		                        ,aa.SampleWorkflowID
					,aa.SampleRequestWorkflowID
		ORDER BY
				         aa.TradePartnerID 
					,aa.TradePartnerVendorID
					,aa.StyleID
		                        ,aa.SampleWorkflowID
					,aa.SampleRequestWorkflowID
    END
ELSE  -- ((@DateFrom IS  NULL)  AND (@DateTo IS NULL))
    BEGIN
    --Insert the num of cases  into the temp table.
		INSERT INTO #TempScore (TrdPartnerID, TrdPrtVendorID, StyleID, SmplWrkFlowID, 
					SmplReqWrkFlowID, 
					num_submit, num_open, num_resub, num_appcorr, num_approv, num_drop, num_overdue  )
		SELECT 
		 aa.TradePartnerID as TrdPartnerID
		,aa.TradePartnerVendorID as TrdPrtVendorID
		,aa.StyleID
		,aa.SampleWorkflowID as SmplWrkFlowID
		,aa.SampleRequestWorkflowID as SmplReqWrkFlowID
		,                (SELECT  count(*) as count_submits FROM pSampleRequestSubmit a9  
				  WHERE 
                                   -- a9.DueDate <  GETDATE()
				    --and 
				  ((a9.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR ( a9.TradePartnerID = aa.TradePartnerID))
				   and  a9.TradePartnerVendorID = aa.TradePartnerVendorID
				   and  a9.SampleWorkflowID = aa.SampleWorkflowID
		                   and  a9.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a9.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		)  AS num_submit
		,
				(SELECT  count(a0.status) as count0 FROM pSampleRequestSubmit a0 
				  WHERE a0.status = 0 
				   and ((a0.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR ( a0.TradePartnerID = aa.TradePartnerID))
				   and  a0.TradePartnerVendorID = aa.TradePartnerVendorID
				   and  a0.StyleID = aa.StyleID
				   and  a0.SampleWorkflowID = aa.SampleWorkflowID
		                   and  a0.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a0.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		
		 )  AS num_open
		,
				(SELECT count(a1.status) as count1 FROM pSampleRequestSubmit a1  
				  WHERE a1.status = 1 
				   and ((a1.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				       OR ( a1.TradePartnerID = aa.TradePartnerID))
				   and a1.TradePartnerVendorID = aa.TradePartnerVendorID
				   and a1.StyleID = aa.StyleID
				   and a1.SampleWorkflowID = aa.SampleWorkflowID
				   and a1.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a1.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		
		 )  AS num_resub
		,
				(SELECT count(a2.status) as count0 FROM pSampleRequestSubmit a2  
				  WHERE a2.status = 2 
				    and ((a2.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR ( a2.TradePartnerID = aa.TradePartnerID))
				    and a2.TradePartnerVendorID = aa.TradePartnerVendorID
				    and a2.StyleID = aa.StyleID
				    and a2.SampleWorkflowID = aa.SampleWorkflowID
		                    and a2.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a2.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		
		 )  AS num_appcorr
		,
				(SELECT count(a3.status) as count0 FROM pSampleRequestSubmit a3 
				  WHERE a3.status = 3 
				   and ((a3.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR (a3.TradePartnerID = aa.TradePartnerID))
				   and a3.TradePartnerVendorID = aa.TradePartnerVendorID
				   and a3.StyleID = aa.StyleID
		                   and a3.SampleWorkflowID = aa.SampleWorkflowID
		                   and a3.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
						AND a3.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		
		 )  AS num_approv
		,
				(SELECT count(a4.status) as count4 FROM pSampleRequestSubmit a4  
				  WHERE a4.status = 4 
				  and ((a4.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR ( a4.TradePartnerID = aa.TradePartnerID))
				  and a4.TradePartnerVendorID = aa.TradePartnerVendorID
				  and a4.StyleID = aa.StyleID
		                  and a4.SampleWorkflowID = aa.SampleWorkflowID
		                  and a4.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a4.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		
		 )  AS num_drop
		,
		 (SELECT count(*) as count4 FROM pSampleRequestSubmit a4  
				  WHERE a4.MDate > a4.Duedate
				  and ((a4.TradePartnerID IS NULL and aa.TradePartnerID IS NULL)
				         OR ( a4.TradePartnerID = aa.TradePartnerID))
				  and a4.TradePartnerVendorID = aa.TradePartnerVendorID
		                  and a4.SampleWorkflowID = aa.SampleWorkflowID
		                  and a4.SampleRequestWorkflowID = aa.SampleRequestWorkflowID
					AND a4.StyleID IN (SELECT StyleID FROM #tempStyleSeasonYear)
		 )  AS num_overdue
		
		FROM
			pSampleRequestSubmit aa 
		GROUP BY 
				         aa.TradePartnerID 
					,aa.TradePartnerVendorID
					,aa.StyleID
		                        ,aa.SampleWorkflowID
					,aa.SampleRequestWorkflowID
		ORDER BY
				         aa.TradePartnerID 
					,aa.TradePartnerVendorID
					,aa.StyleID
		                        ,aa.SampleWorkflowID
					,aa.SampleRequestWorkflowID
    END
SET @MaxSortNum  = (SELECT  COUNT(DISTINCT SampleWorkFlowID)  FROM pSampleWorkFlow WITH (NOLOCK))
INSERT INTO #TempFinal (TrdPartnerID, TradePartnerName, TrdPrtVendorID, VendorName, SmplWrkFlowID,
                         SampleWorkflow, tot_appcorr, tot_approv, tot_drop, tot_overdue, tot_submit, 
                        tot_approv_request, tot_approv_submit, tot_approv_average, tot_non_pending_submit, 
                         tot_style, tot_style_approv, smplWrkFlowSortNum,MaxSortNum, tot_submit_vendor)
SELECT  -- SQL2005+ ONLY: ROW_NUMBER() OVER(ORDER BY tt.TradePartnerName ASC) AS 'smplWrkFlowSortNum',
		CAST(tt.TrdPartnerID AS nvarchar(40))    			        AS TrdPartnerID
		, ut.TradePartnerName
		, CAST(tt.TrdPrtVendorID AS nvarchar(40))  			AS TrdPrtVendorID
		, uv.VendorName
                --, CAST(tt.StyleID AS nchar(40))         AS StyleID
		, CAST(tt.SmplWrkFlowID AS nvarchar(50))   			AS SmplWrkFlowID
		, wk.SampleWorkflow
		--, sum(tt.num_open)              				as tot_open
		--, ISNULL(sum(tt.num_resub),0) 				as tot_resub
		, ISNULL(sum(tt.num_appcorr),0) 				as tot_appcorr
		, ISNULL(sum(tt.num_approv),0) 					as tot_approv
		, ISNULL(sum(tt.num_drop),0) 				        as tot_drop
		, CAST(ISNULL(sum(tt.num_overdue),0) AS float)			as tot_overdue
		--, count(tt.SmplWrkFlowId) 					as tot_request
		, CAST(sum(tt.num_submit) AS float)				as tot_submit
		, (SELECT  COUNT(*)
		   FROM #TempScore t6
                   WHERE (    (t6.TrdPartnerID IS NULL and tt.TrdPartnerID IS NULL)
		           OR (t6.TrdPartnerID = tt.TrdPartnerID)
                         )
			 and t6.TrdPrtVendorID = tt.TrdPrtVendorID
			 -- and t1.StyleID = tt.StyleID
	 	         and t6.SmplWrkFlowID  = tt.SmplWrkFlowID
		         and (t6.num_appcorr > 0 or t6.num_approv > 0)
                   ) 								AS tot_approv_request
               
                , (SELECT  CAST(ISNULL(SUM(t0.num_submit), 0) AS float)
		   FROM #TempScore t0
                   WHERE (    (t0.TrdPartnerID IS NULL and tt.TrdPartnerID IS NULL)
		           OR (t0.TrdPartnerID = tt.TrdPartnerID)
                         )
			 and t0.TrdPrtVendorID = tt.TrdPrtVendorID
			 -- and t1.StyleID = tt.StyleID
	 	         and t0.SmplWrkFlowID  = tt.SmplWrkFlowID
		         and (t0.num_appcorr > 0 or t0.num_approv > 0)
                   ) 								AS tot_approv_submit
                 -- initial average. Will be updated at the next step
		 , 0					AS tot_approv_average
		, (SELECT  CAST(ISNULL(SUM(t1.num_submit), 0) AS float)
		   FROM #TempScore t1
                   WHERE (    (t1.TrdPartnerID IS NULL and tt.TrdPartnerID IS NULL)
		           OR (t1.TrdPartnerID = tt.TrdPartnerID)
                         )
			 and t1.TrdPrtVendorID = tt.TrdPrtVendorID
			 -- and t1.StyleID = tt.StyleID
	 	         and t1.SmplWrkFlowID  = tt.SmplWrkFlowID
		         and (t1.num_appcorr > 0 or t1.num_approv > 0 
						 or t1.num_drop > 0)			        
                   ) 								AS tot_non_pending_submit
		/*
		, (SELECT  COUNT(*)
		   FROM #TempScore t2
                   WHERE (    (t2.TrdPartnerID IS NULL and tt.TrdPartnerID IS NULL)
		              OR 
				(t2.TrdPartnerID = tt.TrdPartnerID)
                         )
			 and t2.TrdPrtVendorID = tt.TrdPrtVendorID
			 --and t2.StyleID = tt.StyleID
	 	         and t2.SmplWrkFlowID  = tt.SmplWrkFlowID
		         and (t2.num_appcorr > 0 or t2.num_approv > 0)
                   ) 								AS tot_approv_request
		 */
		 /*
		 , (SELECT  COUNT(DISTINCT CAST(t3.StyleID AS nchar(40)))
		   FROM #TempScore t3
                   WHERE (    (t3.TrdPartnerID IS NULL and tt.TrdPartnerID IS NULL)
		              OR 
				(t3.TrdPartnerID = tt.TrdPartnerID)
                         )
			 and t3.TrdPrtVendorID = tt.TrdPrtVendorID
                   ) 								AS tot_style
		  */								
		  /*								
		   , (SELECT  COUNT(DISTINCT CAST(t4.StyleID AS nchar(40)))
		   FROM #TempScore t4
                   WHERE (    (t4.TrdPartnerID IS NULL and tt.TrdPartnerID IS NULL)
		              OR 
				(t4.TrdPartnerID = tt.TrdPartnerID)
                         )
			 and t4.TrdPrtVendorID = tt.TrdPrtVendorID
			 and (t4.num_appcorr > 0 or t4.num_approv > 0)
                   ) 								AS tot_approv_style
		  */
		  ,(SELECT  COUNT(DISTINCT CAST(t5.StyleID AS nvarchar(40)))
		   FROM #TempScore t5
                   WHERE (    (t5.TrdPartnerID IS NULL and tt.TrdPartnerID IS NULL)
		              OR 
				(t5.TrdPartnerID = tt.TrdPartnerID)
                         )
			 --and t5.TrdPrtVendorID = tt.TrdPrtVendorID
			 --and (t5.num_appcorr > 0 or t5.num_approv > 0 
			 --		 or t5.num_drop > 0)	
                        	
                    )								AS tot_style
		  ,(SELECT  COUNT(DISTINCT CAST(t5.StyleID AS nvarchar(40)))
		   FROM #TempScore t5
                   WHERE (    (t5.TrdPartnerID IS NULL and tt.TrdPartnerID IS NULL)
		              OR 
				(t5.TrdPartnerID = tt.TrdPartnerID)
                         )
			 and t5.TrdPrtVendorID = tt.TrdPrtVendorID
			 and (t5.num_appcorr > 0 or t5.num_approv > 0 
			 		 or t5.num_drop > 0)	
                        	
                    )								AS tot_style_approv
		  , tmp.smplWrkFlowSortNum 					as smplWrkFlowSortNum
		  , @MaxSortNum 						AS MaxSortNum	
		  , 0								AS tot_submit_vendor					
FROM #TempScore tt
	     LEFT OUTER JOIN uTradePartner ut 		ON ( (tt.TrdPartnerID IS NULL and ut.TradePartnerID IS NULL)
		        				     OR 
							     ( tt.TrdPartnerID = ut.TradePartnerID))
	     LEFT OUTER JOIN uTradePartnerVendor uv 	ON (((tt.TrdPartnerID IS NULL and uv.TradePartnerID IS NULL)
		        					OR ( tt.TrdPartnerID = uv.TradePartnerID))
							and (tt.TrdPrtVendorID 	= uv.TradePartnerVendorID))
	     -- LEFT OUTER JOIN pStyleHeader  sh	ON (tt.StyleID = sh.StyleID)
	     LEFT OUTER JOIN pSampleWorkflow wk 	ON (tt.SmplWrkFlowID 	= wk.SampleWorkflowID)
	     LEFT OUTER JOIN #TempWrkFlowSort tmp  	ON tt.SmplWrkFlowID	= tmp.SmplWrkFlowID
GROUP BY tt.TrdPartnerID, ut.TradePartnerName, tt.TrdPrtVendorID, uv.VendorName, 
	 --tt.StyleID, 
         tt.SmplWrkFlowID, 
	 wk.SampleWorkflow,  tmp.smplWrkFlowSortNum
ORDER BY ut.TradePartnerName,CAST(tt.TrdPartnerID AS nchar(40)), uv.VendorName, CAST(tt.TrdPrtVendorID AS nvarchar(40)), 
       -- tt.StyleID, 
         tmp.smplWrkFlowSortNum 

--- UPDATE AVERAGE VALUE of tot_approv_average
UPDATE #TempFinal  SET tot_approv_average = ROUND(tot_approv_submit / tot_approv_request, 2)
WHERE tot_approv_request > 0




--- TOTAL COLUMN  of  View Designer of SQL 2000 Reporting Service
INSERT INTO #TempFinal (TrdPartnerID, TradePartnerName, TrdPrtVendorID, VendorName, SmplWrkFlowID, SampleWorkflow, tot_appcorr, tot_approv, tot_drop, tot_overdue, tot_submit, 
                        tot_approv_request, tot_approv_submit,tot_approv_average, tot_non_pending_submit, tot_style, tot_style_approv, smplWrkFlowSortNum,MaxSortNum, tot_submit_vendor)
SELECT 
TrdPartnerID, 
TradePartnerName, 
TrdPrtVendorID, 
VendorName, 
'**X', 
'TOTAL', 
SUM(tot_appcorr) as tot_appcorr, 
SUM(tot_approv)  as tot_approv, 
SUM(tot_drop)    as tot_drop, 
SUM(tot_overdue) as tot_overdue, 
SUM(tot_submit)  as tot_submit, 
SUM(tot_approv_request) as tot_approv_request, 
SUM(tot_approv_submit)  as tot_approv_submit,
0	 as  tot_approv_average,
SUM(tot_non_pending_submit) as tot_non_pending_submit, 
SUM(tot_style)              as tot_style, 
SUM(tot_style_approv)       as tot_style_approv, 
(@MaxSortNum + 1)    	    as smplWrkFlowSortNum,
@MaxSortNum		    as MaxSortNum,
0			    as tot_submit_vendor
FROM #TempFinal 
GROUP BY TrdPartnerID, TradePartnerName, TrdPrtVendorID, VendorName


-- UPDATE vendor total sumbits to all record (For giving users to control the minimun # of ventor submits for reporting)
UPDATE bb set bb.tot_submit_vendor = (SELECT aa.tot_submit FROM #TempFinal aa 
				      WHERE (
                                               (   (aa.TrdPartnerID IS NULL and bb.TrdPartnerID IS NULL)
		        			    OR ( aa.TrdPartnerID = bb.TrdPartnerID)
                                               )
					       and 
                                               (aa.TrdPrtVendorID = bb.TrdPrtVendorID)
                                            )
                                            and aa.smplWrkFlowSortNum = @MaxSortNum + 1)
FROM #TempFinal bb



--- RATE COLUMN  of  View Designer of SQL 2000 Reporting Service
INSERT INTO #TempFinal (TrdPartnerID, TradePartnerName, TrdPrtVendorID, VendorName, SmplWrkFlowID, SampleWorkflow, tot_appcorr, tot_approv, tot_drop, tot_overdue, tot_submit, 
                        tot_approv_request, tot_approv_submit,tot_approv_average, tot_non_pending_submit, tot_style, tot_style_approv, smplWrkFlowSortNum,MaxSortNum, tot_submit_vendor)
SELECT 
tf.TrdPartnerID, 
tf.TradePartnerName, 
tf.TrdPrtVendorID, 
tf.VendorName, 
'**Y', 
'RATE Out of 1.00*', 
tf.tot_appcorr as tot_appcorr, 
tf.tot_approv  as tot_approv, 
tf.tot_drop    as tot_drop, 
--  overdue submits rate over the total submits (pending or non-pending submits, with due dates < today)
tot_overdue = 
	CASE  WHEN tf.tot_submit = 0 THEN  -- Too avoid devided by zero error
					             1  -- No data means perfect rate for now
      	      ELSE ROUND(1 - (tf.tot_overdue /tf.tot_submit), 2)
	END, 
100	         as tot_submit, 
tf.tot_approv_request as tot_approv_request, 
--  the rate of approvals over total # of submit (non-pending: approved or dropped)
tot_approv_submit = 
	CASE WHEN tf.tot_non_pending_submit = 0 THEN -- Too avoid devided by zero error
						    1 -- No data means perfect rate for now
             ELSE ROUND((tf.tot_approv_submit /tf.tot_non_pending_submit ), 2)
	END, 
-- Weighted score of the # of avarage submits to get an approval per request
tot_approv_average =
        CASE WHEN tot_approv_request < 1 THEN -- Too avoid devided by zero error
		  1 -- No data means perfect rate for now
             WHEN ((tf.tot_approv_submit / tf.tot_approv_request)  * @SubstractPercentPerSubmit) > 100.00 THEN
		  0  -- Zero score	
             ELSE 
		ROUND(  
                                        1- ( (tf.tot_approv_submit / tf.tot_approv_request - 1) * @SubstractPercentPerSubmit /100 )
                                            
		      ,2) -- round up digits
            END,
100			        as tot_non_pending_submit, 
tf.tot_style		        as tot_style,
tf.tot_style_approv		as tot_style_approv,
(@MaxSortNum + 2)    	    as smplWrkFlowSortNum,
@MaxSortNum		    as MaxSortNum,
tf.tot_submit		    as tot_submit_vendor
FROM #TempFinal tf
WHERE tf.smplWrkFlowSortNum = (@MaxSortNum + 1)
ORDER BY tf.TrdPartnerID, tf.TradePartnerName, tf.TrdPrtVendorID, tf.VendorName





--- SCORE COLUMN  of  View Designer of SQL 2000 Reporting Service
INSERT INTO #TempFinal (TrdPartnerID, TradePartnerName, TrdPrtVendorID, VendorName, SmplWrkFlowID, SampleWorkflow, tot_appcorr, tot_approv, tot_drop, tot_overdue, tot_submit, 
                        tot_approv_request, tot_approv_submit,tot_approv_average, tot_non_pending_submit, tot_style, tot_style_approv, smplWrkFlowSortNum,MaxSortNum, tot_submit_vendor)



SELECT 
tf.TrdPartnerID, 
tf.TradePartnerName, 
tf.TrdPrtVendorID, 
tf.VendorName, 
'**Z', 
'SCORE **', 
tf.tot_appcorr as tot_appcorr, 
tf.tot_approv  as tot_approv, 
tf.tot_drop    as tot_drop, 
-- Weighted score of overdue submits rate over the total submits (pending or non-pending submits, with due dates < today)
tot_overdue = 
	CASE  WHEN tf.tot_submit = 0 THEN  -- Too avoid devided by zero error
					             ROUND(( @Weight_OverDue), 2) -- No data means perfect score for now
      	      ELSE ROUND((1 - (tf.tot_overdue /tf.tot_submit )) * @Weight_OverDue, 2)
	END, 
100	         as tot_submit, 
tf.tot_approv_request as tot_approv_request, 
-- Weighted score of the rate of approvals over total # of submit (non-pending: approved or dropped)
tot_approv_submit = 
	CASE WHEN tf.tot_non_pending_submit = 0 THEN -- Too avoid devided by zero error
						     ROUND(( @Weight_Approved), 2)  -- No data means perfect score for now
             ELSE ROUND(((tf.tot_approv_submit /tf.tot_non_pending_submit )) * @Weight_Approved, 2)
	END, 
-- Weighted score of the # of avarage submits to get an approval per request
tot_approv_average =
        CASE WHEN tot_approv_request < 1 THEN -- Too avoid devided by zero error
		  ROUND(( @Weight_Average), 2) -- No data means perfect score for now
             WHEN ((tf.tot_approv_submit / tf.tot_approv_request)  * @SubstractPercentPerSubmit) > 100.00 THEN --- Already substracted full
		  0  -- Zero score	
             ELSE 
		ROUND(
			 (   (
			       100 - (
				       -- Substracted score percentage based on the average # of  submits to get an approval 
				       -- If average # of  submits = 1  then, 0  percent substraction (When Input parameter @SubstractPercentage = 10)
				       -- If average # of  submits = 2  then, 10 percent substraction (When Input parameter @SubstractPercentage = 10)
                                       -- if average # of  submits = 3  then, 20 percent substraction (When Input parameter @SubstractPercentage = 10)
				        
                                         (tf.tot_approv_submit / tf.tot_approv_request - 1)  * @SubstractPercentPerSubmit
                                            
		                      )
                              )
                            / 100  * @Weight_Average
                          )
		      ,2) -- round up digits
            END,
100			        as tot_non_pending_submit, 
tf.tot_style		        as tot_style,
tf.tot_style_approv	    as tot_style_approv,
(@MaxSortNum + 3)    	    as smplWrkFlowSortNum,
@MaxSortNum		    as MaxSortNum,
tf.tot_submit		    as tot_submit_vendor
FROM #TempFinal tf 
WHERE tf.smplWrkFlowSortNum = (@MaxSortNum + 1)
ORDER BY  tf.TrdPartnerID, tf.TradePartnerName, tf.TrdPrtVendorID, tf.VendorName


-- UPDATE vendor total sumbits to all record (For giving users to control the minimun # of ventor submits for reporting)
UPDATE cc set cc.total_score = (SELECT dd.tot_approv_submit + dd.tot_approv_average + dd.tot_overdue FROM #TempFinal dd 
				      WHERE (
                                               (   (dd.TrdPartnerID IS NULL and cc.TrdPartnerID IS NULL)
		        			    OR ( dd.TrdPartnerID = cc.TrdPartnerID)
                                               )
					       and 
                                               (dd.TrdPrtVendorID = cc.TrdPrtVendorID)
                                            )
                                            and dd.smplWrkFlowSortNum = @MaxSortNum + 3)
FROM #TempFinal cc



IF @SortBy = 1
BEGIN
	SELECT * FROM  #TempFinal 
	WHERE tot_submit_vendor >= @MinNumSubmitsForReporting
	--GROUP BY total_score , TradePartnerName,TrdPartnerID,  VendorName, TrdPrtVendorID, smplWrkFlowSortNum 
	ORDER BY total_score DESC, TradePartnerName,TrdPartnerID,  VendorName, TrdPrtVendorID, smplWrkFlowSortNum 
END
ELSE IF @SortBy = 2 
BEGIN
	SELECT * FROM  #TempFinal 
	WHERE tot_submit_vendor >= @MinNumSubmitsForReporting
	--GROUP BY total_score , TradePartnerName,TrdPartnerID,  VendorName, TrdPrtVendorID, smplWrkFlowSortNum 
	ORDER BY total_score ASC, TradePartnerName, TrdPartnerID, VendorName, TrdPrtVendorID, smplWrkFlowSortNum 
END
ELSE IF @SortBy = 3 
BEGIN
	SELECT * FROM  #TempFinal 
	WHERE tot_submit_vendor >= @MinNumSubmitsForReporting
	ORDER BY  TradePartnerName ASC, TrdPartnerID, VendorName ASC,  smplWrkFlowSortNum 
END
ELSE IF @SortBy = 4 
BEGIN
	SELECT * FROM  #TempFinal 
	WHERE tot_submit_vendor >= @MinNumSubmitsForReporting
	ORDER BY  TradePartnerName DESC,TrdPartnerID,  VendorName DESC,  smplWrkFlowSortNum 
END
ELSE
BEGIN
	SELECT * FROM  #TempFinal 
	WHERE tot_submit_vendor >= @MinNumSubmitsForReporting
	--GROUP BY total_score , TradePartnerName,TrdPartnerID,  VendorName, TrdPrtVendorID, smplWrkFlowSortNum 
	ORDER BY total_score DESC, TradePartnerName,TrdPartnerID,  VendorName, TrdPrtVendorID, smplWrkFlowSortNum 
END





Drop Table #TempScore
Drop Table #TempWrkFlowSort
Drop Table #TempFinal



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pStyleMaterialTemp]'
GO
ALTER TABLE [dbo].[pStyleMaterialTemp] ADD
[StyleMaterialLinkID] [uniqueidentifier] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
UPDATE [dbo].[pStyleMaterialTemp] SET [MaterialLinked]=((1)) WHERE [MaterialLinked] IS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pStyleMaterialTemp] ALTER COLUMN [Qty] [decimal] (18, 2) NULL
ALTER TABLE [dbo].[pStyleMaterialTemp] ALTER COLUMN [Colorway] [int] NOT NULL
ALTER TABLE [dbo].[pStyleMaterialTemp] ALTER COLUMN [MaterialTrack] [int] NULL
ALTER TABLE [dbo].[pStyleMaterialTemp] ALTER COLUMN [MaterialLinked] [int] NOT NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleHeaderLink_REMOVE]'
GO



CREATE PROCEDURE [dbo].[spx_StyleHeaderLink_REMOVE]
(@StyleID uniqueidentifier,
@StyleType int,
@StyleStatusID int)
AS 


	BEGIN
		UPDATE  pStyleHeader
		SET StyleLinkID = NULL
		WHERE   (StyleID=@StyleID AND StyleType = @StyleType AND StyleStatusID=@StyleStatusID)
	END	
	













GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pShowroom]'
GO
ALTER TABLE [dbo].[pShowroom] ADD
[Sort] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pLinePlanShowroomStyleColor]'
GO
ALTER TABLE [dbo].[pLinePlanShowroomStyleColor] ADD
[StyleID] [uniqueidentifier] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
UPDATE [dbo].[pLinePlanShowroomStyleColor] SET [LinePlanShowroomStyleColorID]=(newid()) WHERE [LinePlanShowroomStyleColorID] IS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanShowroomStyleColor] ALTER COLUMN [LinePlanShowroomStyleColorID] [uniqueidentifier] NOT NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanMaterialItemTemp_INSERT]'
GO


CREATE PROCEDURE [dbo].[spx_LinePlanMaterialItemTemp_INSERT] (
	@LinePlanRangeID UNIQUEIDENTIFIER, 
	@LinePlanID UNIQUEIDENTIFIER, 
	@LinePlanColorGroupID UNIQUEIDENTIFIER,
	@MaterialID UNIQUEIDENTIFIER 
)
AS

IF (SELECT COUNT(*) FROM pLinePlanMaterialItemTemp WHERE LinePlanRangeID = @LinePlanRangeID 
		AND LinePlanID = @LinePlanID AND MaterialID = @MaterialID AND LinePlanColorGroupID = @LinePlanColorGroupID) = 0

BEGIN
	INSERT INTO pLinePlanMaterialItemTemp (LinePlanMaterialItemID, LinePlanId, LinePlanRangeID, MaterialID, LinePlanColorGroupID)
	SELECT LinePlanMaterialItemID, LinePlanId, LinePlanRangeID, MaterialID, @LinePlanColorGroupID FROM pLinePlanMaterialItem
	WHERE LinePlanRangeID = @LinePlanRangeID AND LinePlanID = @LinePlanID AND MaterialID = @MaterialID 		
END




















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_LinePlanMaterialItemRollup2_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_LinePlanMaterialItemRollup2_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pStyleColorGroupItem]'
GO
CREATE TABLE [dbo].[pStyleColorGroupItem]
(
[StyleColorGroupItemID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_pStyleColorGroupItem_StyleColorGroupItemID] DEFAULT (newsequentialid()),
[StyleColorGroupID] [uniqueidentifier] NOT NULL,
[StyleColorID] [uniqueidentifier] NOT NULL,
[StyleID] [uniqueidentifier] NOT NULL,
[Quantity] [decimal] (18, 0) NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[Sort] [varchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[SizeHomeID] [varchar] (10) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[SeasonYearID] [uniqueidentifier] NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pStyleColorGroupItemID] on [dbo].[pStyleColorGroupItem]'
GO
ALTER TABLE [dbo].[pStyleColorGroupItem] ADD CONSTRAINT [PK_pStyleColorGroupItemID] PRIMARY KEY CLUSTERED  ([StyleColorGroupItemID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pStyleColorGroup]'
GO
CREATE TABLE [dbo].[pStyleColorGroup]
(
[StyleColorGroupID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_pStyleColorGroup_StyleColorGroupID] DEFAULT (newsequentialid()),
[StyleID] [uniqueidentifier] NULL,
[StyleSet] [int] NULL,
[ColorGroupID] [uniqueidentifier] NULL,
[ColorGroupName] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[Sort] [varchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[SizeHomeID] [varchar] (10) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[SeasonYearID] [uniqueidentifier] NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pStyleColorGroupID] on [dbo].[pStyleColorGroup]'
GO
ALTER TABLE [dbo].[pStyleColorGroup] ADD CONSTRAINT [PK_pStyleColorGroupID] PRIMARY KEY CLUSTERED  ([StyleColorGroupID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleColorway_ChipColorSeasonYear_Logic_SELECT]'
GO
ALTER   PROCEDURE [dbo].[spx_StyleColorway_ChipColorSeasonYear_Logic_SELECT] (
@SeasonYearID UNIQUEIDENTIFIER ,
@MaterialColorID UNIQUEIDENTIFIER ,
@StyleMaterialID UNIQUEIDENTIFIER ,
@CUser NVARCHAR(200),
@CDate DATETIME 
)
AS 


DECLARE @MaterialID UNIQUEIDENTIFIER 
DECLARE @MaterialSeasonYearID UNIQUEIDENTIFIER 

SELECT @MaterialID = MaterialID FROM pMaterialColor WHERE @MaterialColorID = MaterialColorID

IF @MaterialID IS NOT NULL 
BEGIN 


	IF ( SELECT COUNT(*) FROM pMaterialSeasonYear WHERE MaterialID = @MaterialID  AND SeasonYearID = @SeasonYearID ) = 0
	BEGIN
		INSERT INTO pMaterialSeasonYear ( MaterialSeasonYearID, SeasonYearID , MaterialID , CUser, CDate ) 
		VALUES ( NEWID(), @SeasonYearID , @MaterialID , @CUser, @CDate ) 
	END 


	IF ( SELECT COUNT(*) FROM pMaterialColorSeasonYear  WHERE SeasonYearID = @SeasonYearID AND MaterialID = @MaterialID  AND MaterialColorID = @MaterialColorID) = 0
	BEGIN 
		INSERT INTO  pMaterialColorSeasonYear  ( MaterialColorSeasonYearID , MaterialColorID , MaterialID , SeasonYearID , MaterialSeason, MaterialYear, CUser, CDate, MUser, MDate  )  
		SELECT NEWID() , @MaterialColorID , @MaterialID , @SeasonYearID , Season, Year,  @CUser, @CDate, @CUser, @CDate 
		FROM pSeasonYear WHERE SeasonYearID = @SeasonYearID  
	END 




END 






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] ALTER COLUMN [LinePlanBusLYCh1] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusinessItem] ALTER COLUMN [LinePlanBusLYCh2] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusinessItem] ALTER COLUMN [LinePlanBusLYCh3] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusinessItem] ALTER COLUMN [LinePlanBusLYCh4] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusinessItem] ALTER COLUMN [LinePlanBusLYCh5] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusinessItem] ALTER COLUMN [LinePlanBusPnCh1] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusinessItem] ALTER COLUMN [LinePlanBusPnCh2] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusinessItem] ALTER COLUMN [LinePlanBusPnCh3] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusinessItem] ALTER COLUMN [LinePlanBusPnCh4] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusinessItem] ALTER COLUMN [LinePlanBusPnCh5] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusinessItem] ALTER COLUMN [LinePlanBusCuCh1] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusinessItem] ALTER COLUMN [LinePlanBusCuCh2] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusinessItem] ALTER COLUMN [LinePlanBusCuCh3] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusinessItem] ALTER COLUMN [LinePlanBusCuCh4] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusinessItem] ALTER COLUMN [LinePlanBusCuCh5] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusinessItem] ALTER COLUMN [LinePlanBusWpCh1] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusinessItem] ALTER COLUMN [LinePlanBusWpCh2] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusinessItem] ALTER COLUMN [LinePlanBusWpCh3] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusinessItem] ALTER COLUMN [LinePlanBusWpCh4] [decimal] (18, 5) NULL
ALTER TABLE [dbo].[pLinePlanBusinessItem] ALTER COLUMN [LinePlanBusWpCh5] [decimal] (18, 5) NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pLinePlan]'
GO
ALTER TABLE [dbo].[pLinePlan] ADD
[Active] [int] NULL,
[LinePlanTemplateID] [uniqueidentifier] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleRequestSpecItem_UPDATE]'
GO


ALTER  PROCEDURE [dbo].[spx_SampleRequestSpecItem_UPDATE]
(
	@SampleRequestSpecID uniqueidentifier, 
	@Status int,
	@WashType nvarchar(20),
	@Pom nvarchar(10),
	@PomMeasurment nvarchar(200),
	@Tol numeric(18,4),
	@TolN numeric(18,4),
	@Var numeric(18,2),   /*** Clay Parker July 6 2009 - Modified 18,4 to 18,2 to correct rounding issues onscreen in sample request **/
	@Ask numeric(18,4),
	@Rev numeric(18,4),
	@Spec numeric(18,4),
	@Final numeric(18,4),
	@ModifiedBy nvarchar(200),
	@ModifiedDate datetime
)


AS 

	IF @WashType = 'NONWASH'
		BEGIN
			UPDATE dbo.pSampleRequestSpecItem SET 
				POM = @Pom,
				PointMeasur = @PomMeasurment,
				TOLN = @TolN, 
				Ask = @Ask,
				Var = @Var,
				Rev = @Rev,
				Spec = @Spec,
				Final = @Final,
				MUser = @ModifiedBy, 
				MDate = @ModifiedDate
			WHERE (SampleRequestSpecID = @SampleRequestSpecID)  
		END
	ELSE
		BEGIN
			UPDATE dbo.pSampleRequestSpecItem SET 
				POM = @Pom,
				PointMeasur = @PomMeasurment,
				TOL = @Tol, 
				Ask = @Ask,
				Var = @Var,
				Rev = @Rev,
				Spec = @Spec,
				Final = @Final,
				MUser = @ModifiedBy, 
				MDate = @ModifiedDate
			WHERE (SampleRequestSpecID = @SampleRequestSpecID)  
		END
		
	IF @Status = 1 --Resubmit
	BEGIN
		UPDATE pSampleRequestSpecItem SET Rev = Ask
		FROM pSampleRequestSpecItem 
		WHERE (SampleRequestSpecID = @SampleRequestSpecID) AND (Rev = 0)
	END  

	-- Modified by Artemio 
	--  December 5, 2008		
	DECLARE @ApprovedType as INT 
	SELECT @ApprovedType = ApprovedType FROM pSampleRequestSubmitStatus WHERE StatusID = @Status
	IF @ApprovedType IS NULL
		SET @ApprovedType = 0

			

	--IF @Status = 3 OR @Status = 2 --Approved
	IF @ApprovedType = 1 --Approved
		BEGIN
			UPDATE pSampleRequestSpecItem SET Final = Rev
			WHERE (SampleRequestSpecID = @SampleRequestSpecID) AND (Final = 0) AND (Rev <> 0)
				
		/* 
			UPDATE pSampleRequestSpecItem SET 
				pSampleRequestSpecItem.Final = pStyleSpec.Spec
			FROM pSampleRequestSpecItem INNER JOIN
				pStyleSpec ON pSampleRequestSpecItem.StyleID = pStyleSpec.StyleID AND 
				pSampleRequestSpecItem.StyleSet = pStyleSpec.StyleSet AND 
				pSampleRequestSpecItem.POM = pStyleSpec.POM
			WHERE (SampleRequestSpecID = @SampleRequestSpecID) AND
				(pSampleRequestSpecItem.Final = 0) AND (pSampleRequestSpecItem.ASK <> 0)
		
		*/		
		END  






set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleHeaderLocked_SELECT]'
GO
CREATE procedure dbo.spx_StyleHeaderLocked_SELECT (
@StyleID UNIQUEIDENTIFIER, 
@TeamID UNIQUEIDENTIFIER,
@LinePlanItemID UNIQUEIDENTIFIER
)
AS 

	SELECT HeaderLocked FROM pStyleHeader WHERE StyleID = @StyleID





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_LinePlanMaterialItemRollup3_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_LinePlanMaterialItemRollup3_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialTradePartner_SeasonYear_Logic_INSERT]'
GO
CREATE PROCEDURE [dbo].[spx_MaterialTradePartner_SeasonYear_Logic_INSERT] (
@StyleID UNIQUEIDENTIFIER,
@CUser NVARCHAR(200),
@CDate DATETIME 
)
AS


/*
DECLARE @StyleID UNIQUEIDENTIFIER
DECLARE @CUser NVARCHAR(200)
DECLARE @CDate DATETIME 

SET @StyleID = 'f1dc18f3-3ce6-432d-bc71-8012de4d3cf9'
SET @CUser = 'Artemio Gomez'
SET @CDate = GETDATE()
*/

DECLARE @StyleMaterialID UNIQUEIDENTIFIER
DECLARE @Season NVARCHAR(200)
DECLARE @Year  NVARCHAR(200)
DECLARE @TOTAL  INT 
DECLARE @ROW_ID INT 
DECLARE @MaterialSeasonYearID UNIQUEIDENTIFIER 
DECLARE @SeasonYearID UNIQUEIDENTIFIER 
DECLARE @MaterialID UNIQUEIDENTIFIER 


SELECT @Season = ISNULL (CustomField5,''), @Year = ISNULL(CustomField6 , '')  FROM pStyleHeader  
WHERE StyleID = @StyleID

SELECT @SeasonYearID = SeasonYearID FROM pSeasonYear WHERE Season = @Season AND Year = @Year

CREATE TABLE #mat (
ROW_ID INT IDENTITY (1,1),
StyleMaterialID  UNIQUEIDENTIFIER ,
MaterialID UNIQUEIDENTIFIER 
)

INSERT INTO #mat (StyleMaterialID, MaterialID) 
SELECT StyleMaterialID, MaterialID  FROM pStyleMaterials WHERE StyleID = @StyleID

SET @ROW_ID  = 1 
SELECT @TOTAL  = COUNT(*) FROM #mat 



WHILE  @ROW_ID <= @TOTAL AND @SeasonYearID IS NOT NULL 
BEGIN 
	SELECT @StyleMaterialID = StyleMaterialID, @MaterialID = MaterialID FROM #mat WHERE ROW_ID = @ROW_ID


	-- ************************************************************************************************************************
	-- check for the Material / SeasonYear 
	SET @MaterialSeasonYearID = NULL 
	SELECT @MaterialSeasonYearID = MaterialSeasonYearID 
	FROM  pMaterialSeasonYear 	WHERE MaterialID  = @MaterialID  AND SeasonYearID = @SeasonYearID 

	IF @MaterialSeasonYearID IS NULL 
	BEGIN

		SET @MaterialSeasonYearID = NEWID() 
		--SELECT * FROM  dbo.pMaterialSeasonYear 	

		INSERT INTO  pMaterialSeasonYear(MaterialSeasonYearID , SeasonYearID, MaterialID , CUser, CDate ) 
		VALUES ( @MaterialSeasonYearID , @SeasonYearID , @MaterialID , @CUser, @CDate) 

	END 


	-- ************************************************************************************************************************
	-- Material / TradePartner 

	IF  ( SELECT COUNT(*) FROM pMaterialTradePartner WHERE MaterialID = @MaterialID ) > 0 
	BEGIN
		-- CHECK FOR Season / Year

		IF ( SELECT COUNT(*) FROM pMaterialTradePartner WHERE MaterialID = @MaterialID AND SeasonYearID = @SeasonYearID) = 0
		BEGIN

			DECLARE @LastSeasonYearID UNIQUEIDENTIFIER 
			DECLARE @LastMaterialTradePartnerID UNIQUEIDENTIFIER


			-- Insert from last season 
			SELECT top 1 @LastSeasonYearID = a.SeasonYearID, @LastMaterialTradePartnerID = a.MaterialTradePartnerID
			FROM  pMaterialTradePartner a INNER JOIN 
			pSeasonYear b ON a.SeasonYearID =  b.SeasonYearID 
			WHERE  a.MaterialID = @MaterialID -- '29E94E8E-8E29-49EF-9B74-AA83ABADC2C4'
			ORDER BY b.Year DESC, b.Season

			IF  @LastSeasonYearID IS NOT NULL AND @LastMaterialTradePartnerID IS NOT NULL
			BEGIN
				
				INSERT INTO pMaterialTradePartner ( MaterialTradePartnerID , MaterialID , TradePartnerID , TradePartnerVendorID, 
				MaterialTradePartnerCustom1, MaterialTradePartnerCustom2, MaterialTradePartnerCustom3, MaterialTradePartnerCustom4, MaterialTradePartnerCustom5,
				MaterialTradePartnerCustom6, MaterialTradePartnerCustom7, MaterialTradePartnerCustom8, MaterialTradePartnerCustom9, MaterialTradePartnerCustom10,
				MaterialTradePartnerCustom11, MaterialTradePartnerCustom12, MaterialTradePartnerCustom13, MaterialTradePartnerCustom14, MaterialTradePartnerCustom15,
				MaterialTradePartnerCustom16, MaterialTradePartnerCustom17, MaterialTradePartnerCustom18, MaterialTradePartnerCustom19, MaterialTradePartnerCustom20,
				MaterialTradePartnerCustom21, MaterialTradePartnerCustom22, MaterialTradePartnerCustom23, MaterialTradePartnerCustom24, MaterialTradePartnerCustom25,
				CDate,  CUser, MDate, MUser, MChange, MaterialRequestWorkflowTempID, MaterialRequestWorkflowStartDate, MaterialRequestWorkflowDueDate, SeasonYearID ) 
				SELECT NEWID() AS MaterialTradePartnerID, MaterialID , TradePartnerID , TradePartnerVendorID, 
				MaterialTradePartnerCustom1, MaterialTradePartnerCustom2, MaterialTradePartnerCustom3, MaterialTradePartnerCustom4, MaterialTradePartnerCustom5,
				MaterialTradePartnerCustom6, MaterialTradePartnerCustom7, MaterialTradePartnerCustom8, MaterialTradePartnerCustom9, MaterialTradePartnerCustom10,
				MaterialTradePartnerCustom11, MaterialTradePartnerCustom12, MaterialTradePartnerCustom13, MaterialTradePartnerCustom14, MaterialTradePartnerCustom15,
				MaterialTradePartnerCustom16, MaterialTradePartnerCustom17, MaterialTradePartnerCustom18, MaterialTradePartnerCustom19, MaterialTradePartnerCustom20,
				MaterialTradePartnerCustom21, MaterialTradePartnerCustom22, MaterialTradePartnerCustom23, MaterialTradePartnerCustom24, MaterialTradePartnerCustom25,
				@CDate,  @CUser, @CDate, @CUser, NULL AS MChange, MaterialRequestWorkflowTempID, MaterialRequestWorkflowStartDate, MaterialRequestWorkflowDueDate, @SeasonYearID
				FROM pMaterialTradePartner	
				WHERE MaterialTradePartnerID  = @LastMaterialTradePartnerID  
				AND SeasonYearID = @LastSeasonYearID 

				--SELECT * FROM pMaterialTradePartner 				WHERE MaterialID = '29E94E8E-8E29-49EF-9B74-AA83ABADC2C4'
			END 
		END 
	END 



	SET @ROW_ID = @ROW_ID  + 1 
END 


DROP TABLE #mat 







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_SampleRequestQANew_INSERT]'
GO

CREATE PROCEDURE [dbo].[spx_SampleRequestQANew_INSERT]
(
@SampleRequestQAWorksheetID uniqueidentifier,
@POM varchar(5),
@SpecID uniqueidentifier,
@StyleID uniqueidentifier,
@StyleColorID uniqueidentifier,
@StyleSet int,
@TeamID uniqueidentifier,
@SampleRequestTradeID uniqueidentifier,
@SampleRequestWorkflowID uniqueidentifier,
@SampleWorkflowID nvarchar(5),
@Submit int,
@CreatedDate datetime,
@CreatedBy nvarchar(225)
)
AS 

--DECLARE @newSpecID uniqueidentifier
--SET @newSpecID = newid()


INSERT INTO pSampleRequestQAWorksheet
    (SampleRequestQAWorksheetID, SpecID, StyleID, StyleColorID, StyleSet, TradePartnerVendorID, SampleRequestTradeID, SampleRequestWorkflowID, SampleWorkflowID, Submit, POM,
    PointMeasur, TOL, TOLN, CDate, CUser, MDate, 
    MUser)
VALUES     (@SampleRequestQAWorksheetID, @SpecID, @StyleID, @StyleColorID, @StyleSet, @TeamID, @SampleRequestTradeID, @SampleRequestWorkflowID, @SampleWorkflowID, 
    @Submit, @POM, @POM, 0, 0, @CreatedDate, @CreatedBy, @CreatedDate, @CreatedBy)

                      
--Declare @Sample INT
--
--BEGIN
--SELECT  @Sample = (CASE 
--        WHEN Sel0 = 1 THEN 0
--        WHEN Sel1 = 1 THEN 1 
--        WHEN Sel2 = 1 THEN 2 
--        WHEN Sel3 = 1 THEN 3 
--        WHEN Sel4 = 1 THEN 4 
--        WHEN Sel5 = 1 THEN 5 
--        WHEN Sel6 = 1 THEN 6 
--        WHEN Sel7 = 1 THEN 7 
--        WHEN Sel8 = 1 THEN 8 
--        WHEN Sel9 = 1 THEN 9 
--        WHEN Sel10 = 1 THEN 10 
--        WHEN Sel11 = 1 THEN 11 
--        WHEN Sel12 = 1 THEN 12 
--        WHEN Sel13 = 1 THEN 13 
--        WHEN Sel14 = 1 THEN 14 
--        WHEN Sel15 = 1 THEN 15 
--        WHEN Sel16 = 1 THEN 16 
--        WHEN Sel17 = 1 THEN 17 
--        WHEN Sel18 = 1 THEN 18 
--        WHEN Sel19 = 1 THEN 19 
--        END) FROM dbo.pSampleRequestSpecSize WITH (NOLOCK)
--WHERE (StyleID = @StyleID) 
--AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) 
--AND (SampleWorkflowID = @SampleWorkflowID) 
--AND (SampleRequestTradeID = @SampleRequestTradeID) 
--AND (StyleColorID = @StyleColorID)
--END
--
--
--BEGIN
--IF @Sample = 0
--	UPDATE pSampleRequestSpecItem SET Size0 = 1 WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID AND (SampleRequestTradeID = @SampleRequestTradeID) 
--ELSE IF @Sample  = 1
--	UPDATE pSampleRequestSpecItem SET Size1 = 1 WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID AND (SampleRequestTradeID = @SampleRequestTradeID) 
--ELSE IF @Sample = 2
--	UPDATE pSampleRequestSpecItem SET Size2 = 1 WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID AND (SampleRequestTradeID = @SampleRequestTradeID) 
--ELSE IF @Sample = 3
--	UPDATE pSampleRequestSpecItem SET Size3 = 1 WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID AND (SampleRequestTradeID = @SampleRequestTradeID) 
--ELSE IF @Sample = 4
--	UPDATE pSampleRequestSpecItem SET Size4 = 1 WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID AND (SampleRequestTradeID = @SampleRequestTradeID) 
--ELSE IF @Sample = 5
--	UPDATE pSampleRequestSpecItem SET Size5 = 1 WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID AND (SampleRequestTradeID = @SampleRequestTradeID) 
--ELSE IF @Sample = 6
--	UPDATE pSampleRequestSpecItem SET Size6 = 1 WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID AND (SampleRequestTradeID = @SampleRequestTradeID) 
--ELSE IF @Sample = 7
--	UPDATE pSampleRequestSpecItem SET Size7 = 1 WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID AND (SampleRequestTradeID = @SampleRequestTradeID) 
--ELSE IF @Sample = 8
--	UPDATE pSampleRequestSpecItem SET Size8 = 1 WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID AND (SampleRequestTradeID = @SampleRequestTradeID) 
--ELSE IF @Sample = 9
--	UPDATE pSampleRequestSpecItem SET Size9 = 1 WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID AND (SampleRequestTradeID = @SampleRequestTradeID) 
--ELSE IF @Sample = 10
--	UPDATE pSampleRequestSpecItem SET Size10 = 1 WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID AND (SampleRequestTradeID = @SampleRequestTradeID) 
--ELSE IF @Sample = 11
--	UPDATE pSampleRequestSpecItem SET Size11 = 1 WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID AND (SampleRequestTradeID = @SampleRequestTradeID) 
--ELSE IF @Sample = 12
--	UPDATE pSampleRequestSpecItem SET Size12 = 1 WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID AND (SampleRequestTradeID = @SampleRequestTradeID) 
--ELSE IF @Sample = 13
--	UPDATE pSampleRequestSpecItem SET Size13 = 1 WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID AND (SampleRequestTradeID = @SampleRequestTradeID) 
--ELSE IF @Sample = 14
--	UPDATE pSampleRequestSpecItem SET Size14 = 1 WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID AND (SampleRequestTradeID = @SampleRequestTradeID) 
--ELSE IF @Sample = 15
--	UPDATE pSampleRequestSpecItem SET Size15 = 1 WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID AND (SampleRequestTradeID = @SampleRequestTradeID) 
--ELSE IF @Sample = 16
--	UPDATE pSampleRequestSpecItem SET Size16 = 1 WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID AND (SampleRequestTradeID = @SampleRequestTradeID) 
--ELSE IF @Sample = 17
--	UPDATE pSampleRequestSpecItem SET Size17 = 1 WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID AND (SampleRequestTradeID = @SampleRequestTradeID) 
--ELSE IF @Sample = 18
--	UPDATE pSampleRequestSpecItem SET Size18 = 1 WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID AND (SampleRequestTradeID = @SampleRequestTradeID) 
--ELSE IF @Sample = 19
--	UPDATE pSampleRequestSpecItem SET Size19 = 1 WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID AND (SampleRequestTradeID = @SampleRequestTradeID) 
--END
--
--
-- 
--


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pMaterialRequestSubmitItem]'
GO
ALTER TABLE [dbo].[pMaterialRequestSubmitItem] ADD
[MaterialRequestSubmitGroupID] [uniqueidentifier] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialRequestSubmit_CustomSort_UPDATE]'
GO

CREATE  PROCEDURE [dbo].[spx_MaterialRequestSubmit_CustomSort_UPDATE](
@MaterialRequestSubmitID UNIQUEIDENTIFIER,
@SortBy NVARCHAR(200),
@MUser NVARCHAR(200),
@MDate DATETIME
)
AS 

DECLARE @MaterialRequestSubmitItemID UNIQUEIDENTIFIER
DECLARE @SQL NVARCHAR(2000)


CREATE TABLE #tmpMRSI(
RowID INT IDENTITY (1,1),
MaterialRequestSubmitItemID  UNIQUEIDENTIFIER
)

SET @SQL = 'INSERT INTO #tmpMRSI (MaterialRequestSubmitItemID)
SELECT MaterialRequestSubmitItemID FROM pMaterialRequestSubmitItem 
WHERE MaterialRequestSubmitID  = '''  + CAST (@MaterialRequestSubmitID  AS NVARCHAR(40)) + ''' ORDER BY  ' + @SortBy 
EXEC( @SQL )

DECLARE @ROWID INT
DECLARE @TOTAL INT 

SET @ROWID = 1 
SELECT @TOTAL = COUNT(*) FROM #tmpMRSI

WHILE @ROWID <= @TOTAL
BEGIN 
	SELECT @MaterialRequestSubmitItemID = MaterialRequestSubmitItemID FROM #tmpMRSI WHERE RowID = @ROWID 
		
	UPDATE  pMaterialRequestSubmitItem SET MaterialRequestSubmitItemSort = RIGHT ( '000' + CAST( @ROWID AS NVARCHAR(4)), 4 )
	WHERE MaterialRequestSubmitItemID  = @MaterialRequestSubmitItemID 

	SET @ROWID  = @ROWID + 1
END 


DROP TABLE #tmpMRSI
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pImageCatalog]'
GO
ALTER TABLE [dbo].[pImageCatalog] ADD
[ImageMultiPage] [int] NULL CONSTRAINT [DF_pImageCatalog_ImageSingleFile] DEFAULT ((0)),
[ImageID] [uniqueidentifier] NULL,
[ImageVersion] [int] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_TradePartnerLogic_UPDATE]'
GO

ALTER PROCEDURE [dbo].[spx_TradePartnerLogic_UPDATE]
(@TradePartnerID uniqueidentifier)
AS 

DECLARE @TradePartnerType nvarchar(5)
DECLARE @TradePartnerClass varchar(5)

	SELECT @TradePartnerType = TradePartnerType, @TradePartnerClass = TradePartnerClass  FROM uTradePartner WITH (NOLOCK) WHERE TradepartnerID = @TradePartnerID


	--1=Import, 2=Domestic, 3=Indirect, 4=Both
	BEGIN
	IF  @TradePartnerClass = 1
		UPDATE uTradePartner SET CostingTypeID = 1 WHERE TRADEPARTNERID = @TradePartnerId
	ELSE IF  @TradePartnerClass = 2
		UPDATE uTradePartner SET CostingTypeID = 3 WHERE TRADEPARTNERID = @TradePartnerId
	ELSE IF  @TradePartnerClass = 3
		UPDATE uTradePartner SET CostingTypeID = 4 WHERE TRADEPARTNERID = @TradePartnerId
	ELSE IF @TradePartnerClass = 4
		UPDATE uTradePartner SET CostingTypeID = 4 WHERE TRADEPARTNERID = @TradePartnerId

	END
	
	
	IF @TradePartnerType = '2'
		BEGIN
			DELETE uTradePartnerVendor WHERE TradePartnerID = @TradePartnerID
			INSERT INTO dbo.uTradePartnerVendor
			(TradePartnerVendorID, TradePartnerID, VendorCode, VendorName, Address1, Address2, City, State, PostalCode, Country, PhoneNumber, FaxNumber, 
			MUser, MDate, Active)
			SELECT @TradePartnerId AS TradePartnerVendorID, TradePartnerID, TradePartnerCode, TradePartnerName, Address1, Address2, City, State, PostalCode, 
			Country, PhoneNumber, FaxNumber, MUser, MDate, Active
			FROM  uTradePartner WITH (NOLOCK) WHERE TradePartnerID = @TradePartnerID
		END
	ELSE
		BEGIN
			DELETE uTradePartnerVendor WHERE TradePartnerVendorID = @TradePartnerID
		END





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[Users]'
GO
ALTER TABLE [dbo].[Users] ADD
[Division] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[JobRole] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Location] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Floor] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MachineType] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ContractType] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ContractEnd] [datetime] NULL,
[Menswear] [int] NULL,
[Womenswear] [int] NULL,
[Accessories] [int] NULL,
[Divisionless] [int] NULL,
[Prorsum] [int] NULL,
[UnLockHeader] [int] NOT NULL CONSTRAINT [DF_Users_UnLockHeader] DEFAULT ((0)),
[PreferredLang] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanMultiClothColorItemAvail_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_LinePlanMultiClothColorItemAvail_SELECT]
(
@MaterialID uniqueidentifier
)
AS 

BEGIN
	SELECT '00000000-0000-0000-0000-000000000000' AS MaterialColorID, 'TBD' AS ColorCode, 'TBD' AS ColorName, '1' AS ColorCodeName
	UNION 
	SELECT '10000000-0000-0000-0000-000000000001' AS MaterialColorID, '' AS ColorCode, '' AS ColorName, '2' AS ColorCodeName
	UNION 
	SELECT CAST(a.MaterialColorID AS VARCHAR(40)) AS MaterialColorID, b.ColorCode, 
	'(' + b.ColorCode  + ') ' + b.ColorName  AS ColorName, b.ColorName AS ColorCodeName 
	FROM pMaterialColor a
	INNER JOIN pColorPalette b ON a.ColorPaletteID =  b.ColorPaletteID 
	WHERE a.MaterialID = @MaterialID
	--GROUP BY  MaterialColorID, ColorCode, ColorName, ColorName
	ORDER BY ColorCodeName
END


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO

UPDATE Users
   SET PreferredLang = 'en-US'
WHERE PreferredLang is NULL
GO

IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO

PRINT N'Altering [dbo].[spx_SampleRequestSpec_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_SampleRequestSpec_SELECT] 
(@SampleRequestWorkflowID uniqueidentifier,
@SampleWorkflowID nvarchar(5),
@TeamID uniqueidentifier,
@StyleID uniqueidentifier,
@StyleSet nvarchar(5) ,
@SampleRequestTradeID uniqueidentifier
)

AS

DECLARE @samplesize varchar(10), @sql varchar(8000), @selectwhere varchar(8000), @delim varchar(1), @select varchar(8000), @var varchar(100), @ask varchar(100), @spec varchar(100), @rev varchar(100), @fin varchar(100), @pivot varchar(100), @pivotwhere varchar(100), @table varchar(100)
DECLARE @Select02 varchar (8000) 


SET NOCOUNT ON
SET ANSI_WARNINGS OFF



SELECT @ask = 'MAX(Ask)'
SELECT @spec = 'MAX(Spec)'
SELECT @var = 'MAX(Var)'
SELECT @rev = 'MAX(Rev)'
SELECT @fin = 'MAX(Final)'

SELECT @pivot = 'Submit'
SELECT @table = 'pSampleRequestSpecItem '


SELECT Submit AS tb_pivot INTO ##SampleSpec FROM pSampleRequestSpecItem WITH (NOLOCK) WHERE 1=2

INSERT INTO ##SampleSpec 
SELECT DISTINCT Submit 
FROM pSampleRequestSpecItem WITH (NOLOCK) 
WHERE Submit Is Not Null AND  StyleSet = @StyleSet AND StyleID = @StyleID AND SampleRequestWorkflowID = @SampleRequestWorkflowID AND SampleWorkflowID = @SampleWorkflowID

--WHERE Submit Is Not Null AND Spec = 0 AND StyleSet = @StyleSet AND StyleID = @StyleID AND TradePartnerVendorID = @TeamID AND SampleRequestWorkflowID = @SampleRequestWorkflowID AND SampleWorkflowID = @SampleWorkflowID



SELECT @sql='',  @ask=stuff(@ask, len(@ask), 1, ' END)' )
SELECT @sql=@sql + '',  @spec=stuff(@spec, len(@spec), 1, ' END)' )
SELECT @sql=@sql + '',  @var=stuff(@var, len(@var), 1, ' END)' )
SELECT @sql=@sql + '',  @rev=stuff(@rev, len(@rev), 1, ' END)' )
SELECT @sql=@sql + '',  @fin=stuff(@fin, len(@fin), 1, ' END)' )

SELECT @delim=CASE Sign( CharIndex('char', data_type) + CharIndex('date', data_type) ) 
WHEN 0 THEN '''' ELSE '''' END 
FROM tempdb.information_schema.columns 
WHERE table_name='##SampleSpec' AND column_name='tb_pivot'

--print 'SQL=' + @sql
--print  '////////////////////////////////////////////////////////////////////'

SELECT Sort , Submit, SampleRequestSpecID, POM,  PointMeasur, Ask,Spec, Var, Rev , Final --=0  
INTO ##SampleSummary
FROM pSampleRequestSpecItem WITH (NOLOCK)  
WHERE StyleID =  @StyleID
AND StyleSet = @StyleSet
AND SampleRequestTradeID = @SampleRequestTradeID
AND SampleRequestWorkflowID = @SampleRequestWorkflowID
AND SampleWorkflowID = @SampleWorkflowID
ORDER BY Sort, POM, Submit 


SELECT @sql=@sql + '''Ask ' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@ask,charindex( '(', @ask )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
+ '''Spec ' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@spec,charindex( '(', @spec )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
+ '''Var ' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@var,charindex( '(', @var )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
+ '''Rev ' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@rev,charindex( '(', @rev )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
+ '''Final ' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@fin,charindex( '(', @fin )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
FROM ##SampleSpec


--print @sql
--print  '////////////////////////////////////////////////////////////////////'


if  ( @sql is NULL OR len ( @sql  ) <= 0   )

	SELECT @Select02  = 'SELECT POM, PointMeasur AS [Point of Measurement]  '  +  @sql +  ' FROM ##SampleSummary GROUP  BY   POM, PointMeasur, Sort  ORDER BY  Sort'
else
begin 
	SELECT @sql = left(@sql, len(@sql)-1)
	SELECT @Select02  = 'SELECT POM, PointMeasur AS [Point of Measurement] , '  +  @sql +  ' FROM ##SampleSummary GROUP  BY   POM, PointMeasur, Sort  ORDER BY  Sort'
end 



print  '////////////////////////////////////////////////////////////////////'
PRINT @Select02 

EXEC (@Select02 )


DROP TABLE ##SampleSpec
DROP TABLE  ##SampleSummary




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_LinePlanMaterialItemRollup4_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_LinePlanMaterialItemRollup4_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanStyleAttributeAllocationFilter_SELECT]'
GO


CREATE PROCEDURE [dbo].[spx_LinePlanStyleAttributeAllocationFilter_SELECT]
(
@LinePlanId varchar(50),
@LinePlanIndex VARCHAR (1) , 
@LinePlanAttributeItemId1 UNIQUEIDENTIFIER, 
@LinePlanAttributeItemId2 UNIQUEIDENTIFIER, 
@LinePlanAttributeItemId3 UNIQUEIDENTIFIER, 
@LinePlanAttributeItemId4 UNIQUEIDENTIFIER,
@LinePlanStyleAttributeID varchar(50)
)
AS 


IF @LinePlanIndex  = '0' 
BEGIN 
	SELECT pLinePlanRange.LinePlanRangeID, pLinePlanAttributeItem_1.LinePlanAttributeItemID AS LinePlanAttributeItemID1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeItemID AS LinePlanAttributeItemID2, pLinePlanAttributeItem_3.LinePlanAttributeItemID AS LinePlanAttributeItemID3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeItemID AS LinePlanAttributeItemID4, pLinePlanAttributeItem_1.LinePlanAttributeText AS LinePlanAttributeHeader1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeText AS LinePlanAttributeHeader2, pLinePlanAttributeItem_3.LinePlanAttributeText AS LinePlanAttributeHeader3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeText AS LinePlanAttributeHeader4
	FROM dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_3 RIGHT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_1 RIGHT OUTER JOIN
	  dbo.pLinePlanRange ON pLinePlanAttributeItem_1.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID1 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_2 ON dbo.pLinePlanRange.LinePlanAttributeItemID2 = pLinePlanAttributeItem_2.LinePlanAttributeItemID ON 
	  pLinePlanAttributeItem_3.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID3 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_4 ON dbo.pLinePlanRange.LinePlanAttributeItemID4 = pLinePlanAttributeItem_4.LinePlanAttributeItemID
	WHERE pLinePlanAttributeItem_1.LinePlanID = @LinePlanID AND 
	pLinePlanRange.LinePlanFinancialID = '10000000-0000-0000-0000-000000000004' AND 
		pLinePlanRange.LinePlanRangeID NOT IN (
			SELECT LinePlanRangeID FROM pLinePlanStyleAttributeItem WHERE LinePlanStyleAttributeID = @LinePlanStyleAttributeID

		) 
	ORDER BY LinePlanAttributeHeader1, LinePlanAttributeHeader2, LinePlanAttributeHeader3, LinePlanAttributeHeader4
END
ELSE IF @LinePlanIndex  = '1' 
BEGIN 

	SELECT pLinePlanRange.LinePlanRangeID, pLinePlanAttributeItem_1.LinePlanAttributeItemID AS LinePlanAttributeItemID1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeItemID AS LinePlanAttributeItemID2, pLinePlanAttributeItem_3.LinePlanAttributeItemID AS LinePlanAttributeItemID3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeItemID AS LinePlanAttributeItemID4, pLinePlanAttributeItem_1.LinePlanAttributeText AS LinePlanAttributeHeader1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeText AS LinePlanAttributeHeader2, pLinePlanAttributeItem_3.LinePlanAttributeText AS LinePlanAttributeHeader3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeText AS LinePlanAttributeHeader4
	FROM dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_3 RIGHT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_1 RIGHT OUTER JOIN
	  dbo.pLinePlanRange ON pLinePlanAttributeItem_1.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID1 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_2 ON dbo.pLinePlanRange.LinePlanAttributeItemID2 = pLinePlanAttributeItem_2.LinePlanAttributeItemID ON 
	  pLinePlanAttributeItem_3.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID3 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_4 ON dbo.pLinePlanRange.LinePlanAttributeItemID4 = pLinePlanAttributeItem_4.LinePlanAttributeItemID
	WHERE pLinePlanAttributeItem_1.LinePlanID = @LinePlanID 
	AND pLinePlanRange.LinePlanFinancialID = '10000000-0000-0000-0000-000000000004' AND 
		pLinePlanRange.LinePlanRangeID NOT IN (
			SELECT LinePlanRangeID FROM pLinePlanStyleAttributeItem WHERE LinePlanStyleAttributeID = @LinePlanStyleAttributeID
		) 
	AND pLinePlanAttributeItem_1.LinePlanAttributeItemID  = @LinePlanAttributeItemId1
	ORDER BY LinePlanAttributeHeader1, LinePlanAttributeHeader2, LinePlanAttributeHeader3, LinePlanAttributeHeader4

END 
ELSE IF @LinePlanIndex  = '2' 
BEGIN 

	SELECT pLinePlanRange.LinePlanRangeID, pLinePlanAttributeItem_1.LinePlanAttributeItemID AS LinePlanAttributeItemID1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeItemID AS LinePlanAttributeItemID2, pLinePlanAttributeItem_3.LinePlanAttributeItemID AS LinePlanAttributeItemID3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeItemID AS LinePlanAttributeItemID4, pLinePlanAttributeItem_1.LinePlanAttributeText AS LinePlanAttributeHeader1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeText AS LinePlanAttributeHeader2, pLinePlanAttributeItem_3.LinePlanAttributeText AS LinePlanAttributeHeader3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeText AS LinePlanAttributeHeader4
	FROM dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_3 RIGHT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_1 RIGHT OUTER JOIN
	  dbo.pLinePlanRange ON pLinePlanAttributeItem_1.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID1 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_2 ON dbo.pLinePlanRange.LinePlanAttributeItemID2 = pLinePlanAttributeItem_2.LinePlanAttributeItemID ON 
	  pLinePlanAttributeItem_3.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID3 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_4 ON dbo.pLinePlanRange.LinePlanAttributeItemID4 = pLinePlanAttributeItem_4.LinePlanAttributeItemID
	WHERE pLinePlanAttributeItem_1.LinePlanID = @LinePlanID 
	AND pLinePlanRange.LinePlanFinancialID = '10000000-0000-0000-0000-000000000004' AND 
		pLinePlanRange.LinePlanRangeID NOT IN (
			SELECT LinePlanRangeID FROM pLinePlanStyleAttributeItem WHERE LinePlanStyleAttributeID = @LinePlanStyleAttributeID
		) 
	AND pLinePlanAttributeItem_1.LinePlanAttributeItemID  = @LinePlanAttributeItemId1
	AND pLinePlanAttributeItem_2.LinePlanAttributeItemID  = @LinePlanAttributeItemId2
	ORDER BY LinePlanAttributeHeader1, LinePlanAttributeHeader2, LinePlanAttributeHeader3, LinePlanAttributeHeader4

END 
ELSE IF @LinePlanIndex  = '3' 
BEGIN 

	SELECT pLinePlanRange.LinePlanRangeID, pLinePlanAttributeItem_1.LinePlanAttributeItemID AS LinePlanAttributeItemID1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeItemID AS LinePlanAttributeItemID2, pLinePlanAttributeItem_3.LinePlanAttributeItemID AS LinePlanAttributeItemID3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeItemID AS LinePlanAttributeItemID4, pLinePlanAttributeItem_1.LinePlanAttributeText AS LinePlanAttributeHeader1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeText AS LinePlanAttributeHeader2, pLinePlanAttributeItem_3.LinePlanAttributeText AS LinePlanAttributeHeader3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeText AS LinePlanAttributeHeader4
	FROM dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_3 RIGHT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_1 RIGHT OUTER JOIN
	  dbo.pLinePlanRange ON pLinePlanAttributeItem_1.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID1 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_2 ON dbo.pLinePlanRange.LinePlanAttributeItemID2 = pLinePlanAttributeItem_2.LinePlanAttributeItemID ON 
	  pLinePlanAttributeItem_3.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID3 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_4 ON dbo.pLinePlanRange.LinePlanAttributeItemID4 = pLinePlanAttributeItem_4.LinePlanAttributeItemID
	WHERE pLinePlanAttributeItem_1.LinePlanID = @LinePlanID 
	AND pLinePlanRange.LinePlanFinancialID = '10000000-0000-0000-0000-000000000004' AND 
		pLinePlanRange.LinePlanRangeID NOT IN (
			SELECT LinePlanRangeID FROM pLinePlanStyleAttributeItem WHERE LinePlanStyleAttributeID = @LinePlanStyleAttributeID
		) 
	AND pLinePlanAttributeItem_1.LinePlanAttributeItemID  = @LinePlanAttributeItemId1
	AND pLinePlanAttributeItem_2.LinePlanAttributeItemID  = @LinePlanAttributeItemId2
	AND pLinePlanAttributeItem_3.LinePlanAttributeItemID  = @LinePlanAttributeItemId3
	ORDER BY LinePlanAttributeHeader1, LinePlanAttributeHeader2, LinePlanAttributeHeader3, LinePlanAttributeHeader4

END 


















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Style_MaterialSingleImage_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.
*/


ALTER PROCEDURE [dbo].[rpx_Style_MaterialSingleImage_SELECT]
	(@MaterialID AS varchar(50), @StyleID AS varchar(50), 	
	@StyleSet AS int)
AS 


SELECT (dbo.fnx_GetStreamingImagePath(hi.ImageID, hi.[Version])) AS FilePath	--Comment #01
FROM pStyleMaterials sm INNER JOIN pComponentType ct ON
	sm.MaterialType = ct.ComponentTypeID LEFT OUTER JOIN hImage hi ON
	sm.MaterialImageID = hi.ImageID AND sm.MaterialImageVersion = hi.Version 
WHERE ((sm.StyleSet = @StyleSet) AND
	(sm.StyleID = @StyleID) AND (sm.MaterialID = @MaterialID)) 
ORDER BY sm.MaterialSort, sm.MaterialNo



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pSampleRequestQASize]'
GO
CREATE TABLE [dbo].[pSampleRequestQASize]
(
[SampleRequestQASizeID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_pSampleRequestQASize_SampleRequestQASizeID] DEFAULT (newid()),
[SampleRequestTradeID] [uniqueidentifier] NULL,
[SampleRequestWorkflowID] [uniqueidentifier] NULL,
[SampleWorkflowID] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[WorkflowID] [uniqueidentifier] NULL,
[StyleID] [uniqueidentifier] NULL,
[StyleColorID] [uniqueidentifier] NULL,
[StyleSet] [int] NULL,
[SizeRange] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[NumberOfSamples] [int] NULL CONSTRAINT [DF_pSampleRequestQASize_NumberOfSamples] DEFAULT ((1)),
[Size0] [nvarchar] (9) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Size1] [nvarchar] (9) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Size2] [nvarchar] (9) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Size3] [nvarchar] (9) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Size4] [nvarchar] (9) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Size5] [nvarchar] (9) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Size6] [nvarchar] (9) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Size7] [nvarchar] (9) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Size8] [nvarchar] (9) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Size9] [nvarchar] (9) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Size10] [nvarchar] (9) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Size11] [nvarchar] (9) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Size12] [nvarchar] (9) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Size13] [nvarchar] (9) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Size14] [nvarchar] (9) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Size15] [nvarchar] (9) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Size16] [nvarchar] (9) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Size17] [nvarchar] (9) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Size18] [nvarchar] (9) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Size19] [nvarchar] (9) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Sel0] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Sel0] DEFAULT ((0)),
[Sel1] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Sel1] DEFAULT ((0)),
[Sel2] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Sel2] DEFAULT ((0)),
[Sel3] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Sel3] DEFAULT ((0)),
[Sel4] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Sel4] DEFAULT ((0)),
[Sel5] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Sel5] DEFAULT ((0)),
[Sel6] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Sel6] DEFAULT ((0)),
[Sel7] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Sel7] DEFAULT ((0)),
[Sel8] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Sel8] DEFAULT ((0)),
[Sel9] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Sel9] DEFAULT ((0)),
[Sel10] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Sel10] DEFAULT ((0)),
[Sel11] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Sel11] DEFAULT ((0)),
[Sel12] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Sel12] DEFAULT ((0)),
[Sel13] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Sel13] DEFAULT ((0)),
[Sel14] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Sel14] DEFAULT ((0)),
[Sel15] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Sel15] DEFAULT ((0)),
[Sel16] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Sel16] DEFAULT ((0)),
[Sel17] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Sel17] DEFAULT ((0)),
[Sel18] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Sel18] DEFAULT ((0)),
[Sel19] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Sel19] DEFAULT ((0)),
[Col0] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Col0] DEFAULT ((0)),
[Col1] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Col1] DEFAULT ((0)),
[Col2] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Col2] DEFAULT ((0)),
[Col3] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Col3] DEFAULT ((0)),
[Col4] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Col4] DEFAULT ((0)),
[Col5] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Col5] DEFAULT ((0)),
[Col6] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Col6] DEFAULT ((0)),
[Col7] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Col7] DEFAULT ((0)),
[Col8] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Col8] DEFAULT ((0)),
[Col9] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Col9] DEFAULT ((0)),
[Col10] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Col10] DEFAULT ((0)),
[Col11] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Col11] DEFAULT ((0)),
[Col12] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Col12] DEFAULT ((0)),
[Col13] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Col13] DEFAULT ((0)),
[Col14] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Col14] DEFAULT ((0)),
[Col15] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Col15] DEFAULT ((0)),
[Col16] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Col16] DEFAULT ((0)),
[Col17] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Col17] DEFAULT ((0)),
[Col18] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Col18] DEFAULT ((0)),
[Col19] [bit] NOT NULL CONSTRAINT [DF_pSampleRequestQASize_Col19] DEFAULT ((0)),
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[FitComment] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pSampleRequestQASize] on [dbo].[pSampleRequestQASize]'
GO
ALTER TABLE [dbo].[pSampleRequestQASize] ADD CONSTRAINT [PK_pSampleRequestQASize] PRIMARY KEY CLUSTERED  ([SampleRequestQASizeID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pSampleWorkflowItemTemplate]'
GO
ALTER TABLE [dbo].[pSampleWorkflowItemTemplate] ALTER COLUMN [SampleWorkflowRDays] [int] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[dpx_SampleRequestWorkflow_Alerts_SELECT]'
GO








ALTER         PROCEDURE [dbo].[dpx_SampleRequestWorkflow_Alerts_SELECT]
(
	@Flag int
)
AS

/********************************************/
/*@Flag:									*/
/* 1 = Sample workflows alerts for today.	*/
/********************************************/



--Global Variables.
DECLARE @DateTime datetime
DECLARE @ShortStringDate varchar(10)
DECLARE @StringDateBegin varchar(25)
DECLARE @StringDateEnd varchar(25)

--Create Temp tables.
CREATE TABLE #tempSamples
(
	TableRow int identity(1,1),
	AssignedTo nvarchar(100),
	StyleNo nvarchar(20),
	SizeClass nvarchar(50),
	SizeRange nvarchar(50),
	Season nvarchar(200),
	[Year] nvarchar(200),
	GroupName nvarchar(50),
	Status nvarchar(200),
	DueDate datetime,
	AlertDays int,
	AlertDate datetime
)

--Set the current date and time.
SET @DateTime = GETDATE()

--Set current date variable to a short date format.
SET @ShortStringDate = SUBSTRING(CONVERT(varchar(25), @DateTime, 120), 1, 10)

--Set two variables to the beginning and end of the current date.
SET @StringDateBegin = @ShortStringDate + ' 00:00:00.000'

SET @ShortStringDate = SUBSTRING(CONVERT(varchar(25), @DateTime, 120), 1, 10)
SET @StringDateEnd = @ShortStringDate + ' 23:59:59.998' 

--Choose the right output depending on the flag chosen.
IF(@Flag = 1)	--Sample workflows alerts for today.
	BEGIN
		--Get all of the samples.
		INSERT INTO #tempSamples(
			AssignedTo,
			StyleNo,
			SizeClass,
			SizeRange,
			Season,
			[Year],
			GroupName,
			Status,
			DueDate,
			AlertDays,
			AlertDate)
		SELECT
			Users.Firstname + ' ' + Users.LastName AS AssignedTo,
			pStyleHeader.StyleNo,
			pStyleHeader.SizeClass,
			pStyleHeader.SizeRange,
			pStyleHeader.CustomField2 AS Season,
			pStyleHeader.CustomField4 AS [Year],
			pSampleWorkflow.GroupName,
			pSampleRequestSubmitStatus.Status,
			pSampleRequestWorkflow.DueDate,
			pSampleWorkflowItemTemplate.SampleWorkflowAlerts AS AlertDays,
			DATEADD(day, -pSampleWorkflowItemTemplate.SampleWorkflowAlerts, pSampleRequestWorkflow.DueDate) AS AlertDate
		FROM pSampleRequestWorkflow
			INNER JOIN pStyleHeader ON	pSampleRequestWorkflow.StyleID = pStyleHeader.StyleID
			LEFT OUTER JOIN pSampleRequestSubmitStatus ON	pSampleRequestWorkflow.Status = pSampleRequestSubmitStatus.StatusID
			LEFT OUTER JOIN pSampleWorkflow ON	pSampleRequestWorkflow.SampleWorkflowID = pSampleWorkflow.SampleWorkflowID
			LEFT OUTER JOIN Users ON	pSampleRequestWorkflow.AssignedTo = Users.UserID
			LEFT OUTER JOIN pSampleWorkflowItemTemplate ON pSampleRequestWorkflow.SampleWorkflowTempItemID = pSampleWorkflowItemTemplate.SampleWorkflowTempItemID
		WHERE	(pSampleRequestWorkflow.Status = 0)

		--Show all of the samples that have an alert date of today.
		SELECT
			AssignedTo,
			StyleNo,
			SizeClass,
			SizeRange,
			Season,
			[Year],
			GroupName,
			Status,
			DueDate,
			AlertDays,
			AlertDate
		FROM #tempSamples
		WHERE	(AlertDate >= @StringDateBegin
				AND	AlertDate <= @StringDateEnd)
		ORDER BY
			AssignedTo,
			StyleNo,
			SizeClass,
			SizeRange,
			Season,
			[Year],
			GroupName
	END

--Drop Temp tables.
DROP TABLE #tempSamples



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pMaterialTradePartnerColor]'
GO

ALTER TABLE [dbo].[pMaterialTradePartnerColor] ADD
[MaterialRequestShare] [int] NULL CONSTRAINT [DF_pMaterialTradePartnerColor_MaterialRequestShare] DEFAULT ((0))
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
UPDATE [dbo].[pMaterialTradePartnerColor] SET [AgentView]=((0)) WHERE [AgentView] IS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO

UPDATE pMaterialTradePartnerColor
   SET MaterialTradeColor10 = NULL
WHERE IsNUmeric(MaterialTradeColor10) = 0
GO

IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO

UPDATE pMaterialTradePartnerColor
   SET MaterialTradeColor11 = NULL
WHERE IsNUmeric(MaterialTradeColor11) = 0
GO

IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO

UPDATE pMaterialTradePartnerColor
   SET MaterialTradeColor12 = NULL
WHERE IsNUmeric(MaterialTradeColor12) = 0
GO

IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO

UPDATE pMaterialTradePartnerColor
   SET MaterialTradeColor13 = NULL
WHERE IsNUmeric(MaterialTradeColor13) = 0
GO

IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO

UPDATE pMaterialTradePartnerColor
   SET AgentView = 0
WHERE IsNUmeric(AgentView) = 0
GO

IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pMaterialTradePartnerColor] ALTER COLUMN [MaterialTradeColor10] [decimal] (18, 2) NULL
ALTER TABLE [dbo].[pMaterialTradePartnerColor] ALTER COLUMN [MaterialTradeColor11] [decimal] (18, 2) NULL
ALTER TABLE [dbo].[pMaterialTradePartnerColor] ALTER COLUMN [MaterialTradeColor12] [decimal] (18, 2) NULL
ALTER TABLE [dbo].[pMaterialTradePartnerColor] ALTER COLUMN [MaterialTradeColor13] [decimal] (18, 2) NULL
ALTER TABLE [dbo].[pMaterialTradePartnerColor] ALTER COLUMN [AgentView] [int] NOT NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[cCalendarEvent]'
GO
ALTER TABLE [dbo].[cCalendarEvent] ALTER COLUMN [CalendarEventID] DROP ROWGUIDCOL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[cCalendarEvent] ALTER COLUMN [CalendarEventID] [uniqueidentifier] NOT NULL
ALTER TABLE [dbo].[cCalendarEvent] ALTER COLUMN [CDate] [datetime] NULL
ALTER TABLE [dbo].[cCalendarEvent] ALTER COLUMN [MDate] [datetime] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_ImageCatalogArtArchive_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_ImageCatalogArtArchive_SELECT](@ImageCatalogID uniqueidentifier)
AS SELECT     dbo.pImageCatalogItem.ImageCatalogItemID, dbo.pImageCatalogItem.ImageCatalogID, dbo.pImageCatalogItem.ImageID, 
                      dbo.pImageCatalogItem.ImageVersion, dbo.pImage.ImageNo, dbo.pImage.ImageDescription, dbo.pImageCatalogItem.CUser, 
                      dbo.pImageCatalogItem.CDate, dbo.pImageCatalogItem.MUser, dbo.pImageCatalogItem.MDate, dbo.pImage.ImageFile, 
                      dbo.pImageCatalogItem.ImageSort, dbo.pImage.WorkflowID, dbo.pImage.ImageTypeID, dbo.pImage.ImageCode, dbo.pImage.ImageKeywords, 
                      dbo.pImage.ImageLocation, dbo.pImage.ImageDateLastAccessed, dbo.pImage.ImageDateLastModified, dbo.pImage.ImageFileType, 
                      dbo.pImage.ImageSize, dbo.pImage.ImageType, dbo.pImage.ImageMainFolder, dbo.pImage.ImageSubFolder, dbo.pImage.ImageUserFolder, 
                      dbo.pImage.ImageSubFolder1, dbo.pImage.ImageSubFolder2, dbo.pImage.ImageSubFolder3, dbo.pImage.ImageSubFolder4, 
                      dbo.pImage.ImageSubFolder5, dbo.pImage.ImageSubFolder6, dbo.pImage.ImageSubFolder7, dbo.pImage.ImageSubFolder8, 
                      dbo.pImage.ImageSubFolder9, dbo.pImage.ImageSubFolder10, dbo.pImage.ImageSubFolder11, dbo.pImage.ImageSubFolder12, 
                      dbo.pImage.ImageSubFolder13, dbo.pImage.ImageSubFolder14, dbo.pImage.ImageSubFolder15, dbo.pImage.ImageSubFolder16, 
                      dbo.pImage.ImageSubFolder17, dbo.pImage.ImageSubFolder18, dbo.pImage.ImageSubFolder19, dbo.pImage.ImageSubFolder20, 
                      dbo.pImage.ImageSubFolder21, dbo.pImage.ImageSubFolder22, dbo.pImage.ImageSubFolder23, dbo.pImage.ImageSubFolder24, 
                      dbo.pImage.ImageSubFolder25, dbo.pImage.CUser, dbo.pImage.CDate, dbo.pImage.MUser, dbo.pImage.MDate, dbo.pImage.Version
FROM         dbo.pImageCatalogItem WITH (NOLOCK) INNER JOIN
                      dbo.pImage WITH (NOLOCK) ON dbo.pImageCatalogItem.ImageID = dbo.pImage.ImageID
WHERE     (dbo.pImageCatalogItem.ImageCatalogID = @ImageCatalogID)
ORDER BY dbo.pImageCatalogItem.ImageSort



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleHeaderLocking_Logic_UPDATE]'
GO
CREATE procedure [dbo].[spx_StyleHeaderLocking_Logic_UPDATE] (
@StyleID UNIQUEIDENTIFIER ,
@MUser NVARCHAR(200),
@MDate DATETIME 
)
AS 

	UPDATE pStyleHeader 
	SET HeaderLocked = 0 , MUser = @MUser , MDate = @MDate 
	WHERE StyleID = @StyleID







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pLinePlanMultiClothColorTemp]'
GO
CREATE TABLE [dbo].[pLinePlanMultiClothColorTemp]
(
[LinePlanColorItemTempID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_pLinePlanMultiClothColorTemp_LinePlanColorItemTempID] DEFAULT (newsequentialid()),
[LinePlanColorGroupID] [uniqueidentifier] NULL,
[LinePlanColorItemID] [uniqueidentifier] NULL,
[MaterialGroupColorID] [uniqueidentifier] NULL,
[MaterialColorID] [uniqueidentifier] NULL,
[MaterialID] [uniqueidentifier] NULL,
[StyleColorID] [uniqueidentifier] NULL,
[StyleID] [uniqueidentifier] NULL,
[StyleSet] [int] NULL,
[StyleColorStandardID] [uniqueidentifier] NULL,
[StyleColorNo] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleColorName] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MainColor] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Sort] [nvarchar] (10) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Version] [int] NULL CONSTRAINT [DF_pLinePlanMultiClothColorTemp_Version] DEFAULT ((1)),
[CDate] [datetime] NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CopyStyleColorID] [uniqueidentifier] NULL,
[ColorPaletteID] [uniqueidentifier] NULL,
[SAPCode] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleColorDelivery1] [int] NULL CONSTRAINT [DF_pLinePlanMultiClothColorTemp_StyleColorDelivery1] DEFAULT ((0)),
[StyleColorDelivery2] [int] NULL CONSTRAINT [DF_pLinePlanMultiClothColorTemp_StyleColorDelivery2] DEFAULT ((0)),
[StyleColorDelivery3] [int] NULL CONSTRAINT [DF_pLinePlanMultiClothColorTemp_StyleColorDelivery3] DEFAULT ((0)),
[StyleColorDelivery4] [int] NULL CONSTRAINT [DF_pLinePlanMultiClothColorTemp_StyleColorDelivery4] DEFAULT ((0)),
[PLMCode] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleColorStatus] [int] NULL CONSTRAINT [DF_pLinePlanMultiClothColorTemp_StyleColorStatus] DEFAULT ((100)),
[CustomField1] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Units] [int] NULL CONSTRAINT [DF_pLinePlanMultiClothColorTemp_Units] DEFAULT ((1)),
[Yunique] [int] NULL CONSTRAINT [DF_pLinePlanMultiClothColorTemp_Yunique] DEFAULT ((0)),
[ColorType] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pLinePlanMultiClothColorTemp] on [dbo].[pLinePlanMultiClothColorTemp]'
GO
ALTER TABLE [dbo].[pLinePlanMultiClothColorTemp] ADD CONSTRAINT [PK_pLinePlanMultiClothColorTemp] PRIMARY KEY CLUSTERED  ([LinePlanColorItemTempID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanMultiClothColorTemp_INSERT]'
GO


CREATE PROCEDURE [dbo].[spx_LinePlanMultiClothColorTemp_INSERT]
(
	@LinePlanColorGroupID uniqueidentifier
   ,@ColorPaletteID uniqueidentifier
   ,@MaterialGroupColorID uniqueidentifier = NULL
   ,@MaterialColorID uniqueidentifier
   ,@MaterialID uniqueidentifier
)
AS 

IF (SELECT COUNT(*) FROM pLinePlanMultiClothColorTemp 
		WHERE MaterialID = @MaterialID 
		--AND MaterialColorID = @MaterialColorID 
		AND ColorPaletteID = @ColorPaletteID
		AND  LinePlanColorGroupID = @LinePlanColorGroupID  
) = 0
BEGIN
	INSERT INTO pLinePlanMultiClothColorTemp
           (LinePlanColorGroupID
           ,ColorPaletteID
           ,MaterialGroupColorID
           ,MaterialColorID
		   ,MaterialID)
     VALUES
           (@LinePlanColorGroupID
           ,@ColorPaletteID
           ,@MaterialGroupColorID
           ,@MaterialColorID
		   ,@MaterialID)
END
ELSE
BEGIN

	UPDATE pLinePlanMultiClothColorTemp SET
            MaterialGroupColorID = @MaterialGroupColorID
           ,MaterialColorID = @MaterialColorID
	WHERE MaterialID = @MaterialID 
	AND ColorPaletteID = @ColorPaletteID
	AND LinePlanColorGroupID = @LinePlanColorGroupID  
	
END




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pStyleCategory]'
GO
ALTER TABLE [dbo].[pStyleCategory] ALTER COLUMN [StyleCategoryCustom5] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[pStyleCategory] ALTER COLUMN [StyleCategorySchema] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_LinePlanningMaterial_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_LinePlanningMaterial_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlan_StyleAttribute_RangeRollup3_SELECT]'
GO



CREATE  PROCEDURE [dbo].[spx_LinePlan_StyleAttribute_RangeRollup3_SELECT] (
@LinePlanRangeID UNIQUEIDENTIFIER,
@LinePlanStyleAttributeItemID UNIQUEIDENTIFIER
)
AS 


DECLARE
@LinePlanAttributeItemId1 UNIQUEIDENTIFIER,
@LinePlanAttributeItemId2 UNIQUEIDENTIFIER,
@LinePlanAttributeItemId3 UNIQUEIDENTIFIER,
@LinePlanAttributeItemID4 UNIQUEIDENTIFIER,
@LinePlanFinancialSort NVARCHAR(5) ,
@LinePlanRangeAttributeID UNIQUEIDENTIFIER


SELECT @LinePlanAttributeItemID1 = LinePlanAttributeItemID1, @LinePlanAttributeItemID2 = LinePlanAttributeItemID2,
@LinePlanAttributeItemID3 = LinePlanAttributeItemID3, @LinePlanAttributeItemID4 = LinePlanAttributeItemID4	
FROM pLinePlanRange
WHERE LinePlanRangeID = @LinePlanRangeID 

--
--SELECT 
--@LinePlanIndex='1',
--@LinePlanId='ae947238-2670-49dc-baed-9a03353e0a0f',
--@LinePlanAttributeItemId1='d764ab82-5281-4efd-b6f7-e51b36ceff48',
--@LinePlanAttributeItemId2='218a63bf-715c-4d4b-830b-6e45dd922a9a',
--@LinePlanAttributeItemId3='fbc4fa41-bc1b-44f6-91c2-a20c926a0d77',
--@LinePlanAttributeItemId4=''


DECLARE
@SLinePlanRangeDelCO1 int, 	@SLinePlanRangeDelNV1 int, 	@SLinePlanRangeDelN1 int, 	@SLinePlanRangeDelTL1 int,
@SLinePlanRangeDelCO2 int,	@SLinePlanRangeDelNV2 int,	@SLinePlanRangeDelN2 int,	@SLinePlanRangeDelTL2 int,
@SLinePlanRangeDelCO3 int,	@SLinePlanRangeDelNV3 int,	@SLinePlanRangeDelN3 int,	@SLinePlanRangeDelTL3 int,
@SLinePlanRangeDelCO4 int,	@SLinePlanRangeDelNV4 int,	@SLinePlanRangeDelN4 int,	@SLinePlanRangeDelTL4 int,
@SLinePlanRangeDelAVCO int,	@SLinePlanRangeDelAVNV int,	@SLinePlanRangeDelAVN int,	@SLinePlanRange VARCHAR(100),
@SLinePlanRangeID UNIQUEIDENTIFIER 


DECLARE
@FLinePlanRangeDelCO1 int, 	@FLinePlanRangeDelNV1 int,	@FLinePlanRangeDelN1 int,	@FLinePlanRangeDelTL1 int,
@FLinePlanRangeDelCO2 int,	@FLinePlanRangeDelNV2 int,	@FLinePlanRangeDelN2 int,	@FLinePlanRangeDelTL2 int,
@FLinePlanRangeDelCO3 int,	@FLinePlanRangeDelNV3 int,	@FLinePlanRangeDelN3 int,	@FLinePlanRangeDelTL3 int,
@FLinePlanRangeDelCO4 int,	@FLinePlanRangeDelNV4 int,	@FLinePlanRangeDelN4 int,	@FLinePlanRangeDelTL4 int,
@FLinePlanRangeDelAVCO int,	@FLinePlanRangeDelAVNV int,	@FLinePlanRangeDelAVN int,	@FLinePlanRange VARCHAR(100),
@FLinePlanRangeID UNIQUEIDENTIFIER  


DECLARE
@BLinePlanRangeDelCO1 int,	@BLinePlanRangeDelNV1 int,	@BLinePlanRangeDelN1 int,	@BLinePlanRangeDelTL1 int,
@BLinePlanRangeDelCO2 int,	@BLinePlanRangeDelNV2 int,	@BLinePlanRangeDelN2 int,	@BLinePlanRangeDelTL2 int,
@BLinePlanRangeDelCO3 int,	@BLinePlanRangeDelNV3 int,	@BLinePlanRangeDelN3 int,	@BLinePlanRangeDelTL3 int,
@BLinePlanRangeDelCO4 int,	@BLinePlanRangeDelNV4 int,	@BLinePlanRangeDelN4 int,	@BLinePlanRangeDelTL4 int,
@BLinePlanRangeDelAVCO int,	@BLinePlanRangeDelAVNV int,	@BLinePlanRangeDelAVN int,	@BLinePlanRange VARCHAR(100),
@BLinePlanRangeID UNIQUEIDENTIFIER  
	 

DECLARE
@CLinePlanRangeDelCO1 int,	@CLinePlanRangeDelNV1 int,	@CLinePlanRangeDelN1 int,	@CLinePlanRangeDelTL1 int,
@CLinePlanRangeDelCO2 int,	@CLinePlanRangeDelNV2 int,	@CLinePlanRangeDelN2 int,	@CLinePlanRangeDelTL2 int,
@CLinePlanRangeDelCO3 int,	@CLinePlanRangeDelNV3 int,	@CLinePlanRangeDelN3 int,	@CLinePlanRangeDelTL3 int,
@CLinePlanRangeDelCO4 int,	@CLinePlanRangeDelNV4 int,	@CLinePlanRangeDelN4 int,	@CLinePlanRangeDelTL4 int,
@CLinePlanRangeDelAVCO int,	@CLinePlanRangeDelAVNV int,	@CLinePlanRangeDelAVN int,	@CLinePlanRange VARCHAR(100),
@CLinePlanRangeID UNIQUEIDENTIFIER  


DECLARE
@OLinePlanRangeDelCO1 int,	@OLinePlanRangeDelNV1 int,	@OLinePlanRangeDelN1 int,	@OLinePlanRangeDelTL1 int,
@OLinePlanRangeDelCO2 int,	@OLinePlanRangeDelNV2 int,	@OLinePlanRangeDelN2 int,	@OLinePlanRangeDelTL2 int,
@OLinePlanRangeDelCO3 int,	@OLinePlanRangeDelNV3 int,	@OLinePlanRangeDelN3 int,	@OLinePlanRangeDelTL3 int,
@OLinePlanRangeDelCO4 int,	@OLinePlanRangeDelNV4 int,	@OLinePlanRangeDelN4 int,	@OLinePlanRangeDelTL4 int,
@OLinePlanRangeDelAVCO int,	@OLinePlanRangeDelAVNV int,	@OLinePlanRangeDelAVN int,	@OLinePlanRange VARCHAR(100),
@OLinePlanRangeID UNIQUEIDENTIFIER  
 
CREATE TABLE #tmpLinePlanRange(
	LinePlanRangeAttributeID UNIQUEIDENTIFIER , 
	LinePlanRangeID uniqueidentifier NULL,
	LinePlanFinancialID uniqueidentifier NULL,
	LinePlanRange nvarchar(100) NULL,
	LinePlanAttributeItemID1 uniqueidentifier NULL,
	LinePlanAttributeItemID2 uniqueidentifier NULL,
	LinePlanAttributeItemID3 uniqueidentifier NULL,
	LinePlanAttributeItemID4 uniqueidentifier NULL,
	LinePlanAttributeText1 nvarchar(100) NULL,
	LinePlanAttributeText2 nvarchar(100) NULL,
	LinePlanAttributeText3 nvarchar(100) NULL,
	LinePlanAttributeText4 nvarchar(100) NULL,
	LinePlanAttributeItemSort1 varchar(5) NULL,
	LinePlanAttributeItemSort2 varchar(5) NULL,
	LinePlanAttributeItemSort3 varchar(5) NULL,
	LinePlanAttributeItemSort4 varchar(5) NULL,
	LinePlanRangeDelCO1 int NULL,
	LinePlanRangeDelNV1 int NULL,
	LinePlanRangeDelN1 int NULL,
	LinePlanRangeDelTL1 int NULL,
	LinePlanRangeDelCO2 int NULL,
	LinePlanRangeDelNV2 int NULL,
	LinePlanRangeDelN2 int NULL,
	LinePlanRangeDelTL2 int NULL,
	LinePlanRangeDelCO3 int NULL,
	LinePlanRangeDelNV3 int NULL,
	LinePlanRangeDelN3 int NULL,
	LinePlanRangeDelTL3 int NULL,
	LinePlanRangeDelCO4 int NULL,
	LinePlanRangeDelNV4 int NULL,
	LinePlanRangeDelN4 int NULL,
	LinePlanRangeDelTL4 int NULL,
	LinePlanRangeDelAVCO int NULL,
	LinePlanRangeDelAVNV int NULL,
	LinePlanRangeDelAVN int NULL,
	LinePlanFinancialSort varchar(5) NULL)


/***************************************************************************************/
-- STYLES 
SET @LinePlanRangeID =  NULL
SELECT @LinePlanRangeID = LinePlanRangeID FROM pLinePlanRange 
WHERE  LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 


SELECT  @LinePlanRangeAttributeID = LinePlanRangeAttributeID,
@SLinePlanRangeDelCO1 = SUM(LinePlanRangeDelCO1), 	@SLinePlanRangeDelNV1 = SUM(LinePlanRangeDelNV1), 
@SLinePlanRangeDelN1 = SUM(LinePlanRangeDelN1), 	@SLinePlanRangeDelCO2 = SUM(LinePlanRangeDelCO2), 
@SLinePlanRangeDelNV2 = SUM(LinePlanRangeDelNV2), 	@SLinePlanRangeDelN2 = SUM(LinePlanRangeDelN2), 
@SLinePlanRangeDelCO3 = SUM(LinePlanRangeDelCO3), 	@SLinePlanRangeDelNV3 = SUM(LinePlanRangeDelNV3), 
@SLinePlanRangeDelN3 = SUM(LinePlanRangeDelN3), 	@SLinePlanRangeDelCO4 = SUM(LinePlanRangeDelCO4), 
@SLinePlanRangeDelNV4 = SUM(LinePlanRangeDelNV4), 	@SLinePlanRangeDelN4 = SUM(LinePlanRangeDelN4), 
@SLinePlanRangeDelTL1 = SUM(LinePlanRangeDelTL1), 	@SLinePlanRangeDelTL2 = SUM(LinePlanRangeDelTL2), 
@SLinePlanRangeDelTL3 = SUM(LinePlanRangeDelTL3), 	@SLinePlanRangeDelTL4 = SUM(LinePlanRangeDelTL4), 
@SLinePlanRange = LinePlanRange, @LinePlanFinancialSort = LinePlanFinancialSort
FROM pLinePlanRangeAttribute
WHERE LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID 
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'
GROUP BY LinePlanRangeAttributeID, LinePlanRange, LinePlanFinancialSort




INSERT INTO #tmpLinePlanRange (
LinePlanRangeAttributeID ,
LinePlanRangeID,		LinePlanFinancialID, LinePlanRange,
LinePlanRangeDelCO1,	LinePlanRangeDelNV1,	LinePlanRangeDelN1,		LinePlanRangeDelTL1,
LinePlanRangeDelCO2,	LinePlanRangeDelNV2,	LinePlanRangeDelN2,		LinePlanRangeDelTL2,
LinePlanRangeDelCO3,	LinePlanRangeDelNV3,	LinePlanRangeDelN3,		LinePlanRangeDelTL3,
LinePlanRangeDelCO4,	LinePlanRangeDelNV4,	LinePlanRangeDelN4,		LinePlanRangeDelTL4,
LinePlanRangeDelAVCO,	LinePlanRangeDelAVNV,	LinePlanRangeDelAVN,	LinePlanFinancialSort )
VALUES(
@LinePlanRangeAttributeID, 
@LinePlanRangeID ,		'10000000-0000-0000-0000-000000000004', @SLinePlanRange,
@SLinePlanRangeDelCO1,	@SLinePlanRangeDelNV1,	@SLinePlanRangeDelN1,	@SLinePlanRangeDelTL1,
@SLinePlanRangeDelCO2,	@SLinePlanRangeDelNV2,	@SLinePlanRangeDelN2,	@SLinePlanRangeDelTL2,
@SLinePlanRangeDelCO3,	@SLinePlanRangeDelNV3,	@SLinePlanRangeDelN3,	@SLinePlanRangeDelTL3,	
@SLinePlanRangeDelCO4,	@SLinePlanRangeDelNV4,	@SLinePlanRangeDelN4,	@SLinePlanRangeDelTL4,
@SLinePlanRangeDelAVCO,	@SLinePlanRangeDelAVNV,	@SLinePlanRangeDelAVN , @LinePlanFinancialSort)

/*

-- ***************************************************************************************
-- FABRICS
SET @LinePlanRangeID =  NULL
SELECT @LinePlanRangeID = LinePlanRangeID FROM pLinePlanRange 
WHERE  LinePlanFinancialID = '10000000-0000-0000-0000-000000000001'
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 


SELECT @LinePlanRangeAttributeID = LinePlanRangeAttributeID,
@FLinePlanRangeDelCO1 = SUM(LinePlanRangeDelCO1), 	@FLinePlanRangeDelNV1 = SUM(LinePlanRangeDelNV1), 
@FLinePlanRangeDelN1	= SUM(LinePlanRangeDelN1), 	@FLinePlanRangeDelCO2 = SUM(LinePlanRangeDelCO2), 
@FLinePlanRangeDelNV2 = SUM(LinePlanRangeDelNV2), 	@FLinePlanRangeDelN2	= SUM(LinePlanRangeDelN2), 
@FLinePlanRangeDelCO3 = SUM(LinePlanRangeDelCO3), 	@FLinePlanRangeDelNV3 = SUM(LinePlanRangeDelNV3), 
@FLinePlanRangeDelN3	= SUM(LinePlanRangeDelN3), 	@FLinePlanRangeDelCO4 = SUM(LinePlanRangeDelCO4), 
@FLinePlanRangeDelNV4 = SUM(LinePlanRangeDelNV4), 	@FLinePlanRangeDelN4	= SUM(LinePlanRangeDelN4), 
@FLinePlanRangeDelTL1 = SUM(LinePlanRangeDelTL1), 	@FLinePlanRangeDelTL2 = SUM(LinePlanRangeDelTL2), 
@FLinePlanRangeDelTL3 = SUM(LinePlanRangeDelTL3), 	@FLinePlanRangeDelTL4 = SUM(LinePlanRangeDelTL4), 
@FLinePlanRange = LinePlanRange, @LinePlanFinancialSort = LinePlanFinancialSort
FROM   pLinePlanRangeAttribute
WHERE LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID 
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000001'
GROUP BY LinePlanRangeAttributeID, LinePlanRange, LinePlanFinancialSort



INSERT INTO #tmpLinePlanRange(
LinePlanRangeAttributeID ,
LinePlanRangeID, LinePlanFinancialID,	LinePlanRange,
LinePlanRangeDelCO1,	LinePlanRangeDelNV1,	LinePlanRangeDelN1,		LinePlanRangeDelTL1,
LinePlanRangeDelCO2,	LinePlanRangeDelNV2,	LinePlanRangeDelN2,		LinePlanRangeDelTL2,	
LinePlanRangeDelCO3,	LinePlanRangeDelNV3,	LinePlanRangeDelN3,		LinePlanRangeDelTL3,
LinePlanRangeDelCO4,	LinePlanRangeDelNV4,	LinePlanRangeDelN4,		LinePlanRangeDelTL4,
LinePlanRangeDelAVCO,	LinePlanRangeDelAVNV,	LinePlanRangeDelAVN, LinePlanFinancialSort)
VALUES(
@LinePlanRangeAttributeID ,
@LinePlanRangeID,		'10000000-0000-0000-0000-000000000001',	@FLinePlanRange,
@FLinePlanRangeDelCO1,	@FLinePlanRangeDelNV1,	@FLinePlanRangeDelN1,	@FLinePlanRangeDelTL1,
@FLinePlanRangeDelCO2,	@FLinePlanRangeDelNV2,	@FLinePlanRangeDelN2,	@FLinePlanRangeDelTL2,
@FLinePlanRangeDelCO3,	@FLinePlanRangeDelNV3,	@FLinePlanRangeDelN3,	@FLinePlanRangeDelTL3,	
@FLinePlanRangeDelCO4,	@FLinePlanRangeDelNV4,	@FLinePlanRangeDelN4,	@FLinePlanRangeDelTL4,
@FLinePlanRangeDelAVCO,	@FLinePlanRangeDelAVNV,	@FLinePlanRangeDelAVN, @LinePlanFinancialSort)



--***************************************************************************************
-- COLOR
SET @LinePlanRangeID =  NULL
SELECT @LinePlanRangeID = LinePlanRangeID FROM pLinePlanRange 
WHERE  LinePlanFinancialID = '10000000-0000-0000-0000-000000000003'
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 

SELECT @LinePlanRangeAttributeID = LinePlanRangeAttributeID, 
@BLinePlanRangeDelCO1 = SUM(LinePlanRangeDelCO1), 	@BLinePlanRangeDelNV1 = SUM(LinePlanRangeDelNV1), 
@BLinePlanRangeDelN1	= SUM(LinePlanRangeDelN1), 	@BLinePlanRangeDelCO2 = SUM(LinePlanRangeDelCO2), 
@BLinePlanRangeDelNV2 = SUM(LinePlanRangeDelNV2), 	@BLinePlanRangeDelN2	= SUM(LinePlanRangeDelN2), 
@BLinePlanRangeDelCO3 = SUM(LinePlanRangeDelCO3), 	@BLinePlanRangeDelNV3 = SUM(LinePlanRangeDelNV3), 
@BLinePlanRangeDelN3	= SUM(LinePlanRangeDelN3), 	@BLinePlanRangeDelCO4 = SUM(LinePlanRangeDelCO4), 
@BLinePlanRangeDelNV4 = SUM(LinePlanRangeDelNV4), 	@BLinePlanRangeDelN4	= SUM(LinePlanRangeDelN4), 
@BLinePlanRangeDelTL1 = SUM(LinePlanRangeDelTL1), 	@BLinePlanRangeDelTL2 = SUM(LinePlanRangeDelTL2), 
@BLinePlanRangeDelTL3 = SUM(LinePlanRangeDelTL3), 	@BLinePlanRangeDelTL4 = SUM(LinePlanRangeDelTL4), 
@BLinePlanRange = LinePlanRange, @LinePlanFinancialSort = LinePlanFinancialSort
FROM   pLinePlanRangeAttribute
WHERE LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID 
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000003'
GROUP BY LinePlanRangeAttributeID,LinePlanRange, LinePlanFinancialSort



INSERT INTO #tmpLinePlanRange(
LinePlanRangeAttributeID,
LinePlanRangeID, LinePlanFinancialID,	LinePlanRange,
LinePlanRangeDelCO1,	LinePlanRangeDelNV1,	LinePlanRangeDelN1,		LinePlanRangeDelTL1,
LinePlanRangeDelCO2,	LinePlanRangeDelNV2,	LinePlanRangeDelN2,		LinePlanRangeDelTL2,
LinePlanRangeDelCO3,	LinePlanRangeDelNV3,	LinePlanRangeDelN3,		LinePlanRangeDelTL3,
LinePlanRangeDelCO4,	LinePlanRangeDelNV4,	LinePlanRangeDelN4,		LinePlanRangeDelTL4,
LinePlanRangeDelAVCO,	LinePlanRangeDelAVNV,	LinePlanRangeDelAVN,	LinePlanFinancialSort)
VALUES(
@LinePlanRangeAttributeID ,
@LinePlanRangeID,		'10000000-0000-0000-0000-000000000003',	@BLinePlanRange	,
@BLinePlanRangeDelCO1,	@BLinePlanRangeDelNV1,	@BLinePlanRangeDelN1,	@BLinePlanRangeDelTL1,
@BLinePlanRangeDelCO2,	@BLinePlanRangeDelNV2,	@BLinePlanRangeDelN2,	@BLinePlanRangeDelTL2,
@BLinePlanRangeDelCO3,	@BLinePlanRangeDelNV3,	@BLinePlanRangeDelN3,	@BLinePlanRangeDelTL3,
@BLinePlanRangeDelCO4,	@BLinePlanRangeDelNV4,	@BLinePlanRangeDelN4,	@BLinePlanRangeDelTL4,
@BLinePlanRangeDelAVCO,	@BLinePlanRangeDelAVNV,	@BLinePlanRangeDelAVN,	@LinePlanFinancialSort)


--***************************************************************************************
-- BODY

SET @LinePlanRangeID =  NULL
SELECT @LinePlanRangeID = LinePlanRangeID FROM pLinePlanRange 
WHERE  LinePlanFinancialID = '10000000-0000-0000-0000-000000000002'
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 

SELECT @LinePlanRangeAttributeID = LinePlanRangeAttributeID,
@CLinePlanRangeDelCO1 = SUM(LinePlanRangeDelCO1), 	@CLinePlanRangeDelNV1 = SUM(LinePlanRangeDelNV1), 
@CLinePlanRangeDelN1	= SUM(LinePlanRangeDelN1), 	@CLinePlanRangeDelCO2 = SUM(LinePlanRangeDelCO2), 
@CLinePlanRangeDelNV2 = SUM(LinePlanRangeDelNV2), 	@CLinePlanRangeDelN2	= SUM(LinePlanRangeDelN2), 
@CLinePlanRangeDelCO3 = SUM(LinePlanRangeDelCO3), 	@CLinePlanRangeDelNV3 = SUM(LinePlanRangeDelNV3), 
@CLinePlanRangeDelN3	= SUM(LinePlanRangeDelN3), 	@CLinePlanRangeDelCO4 = SUM(LinePlanRangeDelCO4), 
@CLinePlanRangeDelNV4 = SUM(LinePlanRangeDelNV4), 	@CLinePlanRangeDelN4	= SUM(LinePlanRangeDelN4), 
@CLinePlanRangeDelTL1 = SUM(LinePlanRangeDelTL1), 	@CLinePlanRangeDelTL2 = SUM(LinePlanRangeDelTL2), 
@CLinePlanRangeDelTL3 = SUM(LinePlanRangeDelTL3), 	@CLinePlanRangeDelTL4 = SUM(LinePlanRangeDelTL4), 
@CLinePlanRange = LinePlanRange, @LinePlanFinancialSort = LinePlanFinancialSort
FROM   pLinePlanRangeAttribute
WHERE LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID 
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000002'
GROUP BY LinePlanRangeAttributeID,LinePlanRange, LinePlanFinancialSort



INSERT INTO #tmpLinePlanRange(
LinePlanRangeAttributeID,
LinePlanRangeID,		LinePlanFinancialID,	LinePlanRange,
LinePlanRangeDelCO1,	LinePlanRangeDelNV1,	LinePlanRangeDelN1,	LinePlanRangeDelTL1,
LinePlanRangeDelCO2,	LinePlanRangeDelNV2,	LinePlanRangeDelN2,	LinePlanRangeDelTL2,	
LinePlanRangeDelCO3,	LinePlanRangeDelNV3,	LinePlanRangeDelN3,	LinePlanRangeDelTL3,
LinePlanRangeDelCO4,	LinePlanRangeDelNV4,	LinePlanRangeDelN4,	LinePlanRangeDelTL4,
LinePlanRangeDelAVCO,	LinePlanRangeDelAVNV,	LinePlanRangeDelAVN, LinePlanFinancialSort)
VALUES(
@LinePlanRangeAttributeID ,
@LinePlanRangeID,		'10000000-0000-0000-0000-000000000002',	@CLinePlanRange,	
@CLinePlanRangeDelCO1,	@CLinePlanRangeDelNV1,	@CLinePlanRangeDelN1,	@CLinePlanRangeDelTL1,
@CLinePlanRangeDelCO2,	@CLinePlanRangeDelNV2,	@CLinePlanRangeDelN2,	@CLinePlanRangeDelTL2,
@CLinePlanRangeDelCO3,	@CLinePlanRangeDelNV3,	@CLinePlanRangeDelN3,	@CLinePlanRangeDelTL3,
@CLinePlanRangeDelCO4,	@CLinePlanRangeDelNV4,	@CLinePlanRangeDelN4,	@CLinePlanRangeDelTL4,
@CLinePlanRangeDelAVCO,	@CLinePlanRangeDelAVNV,	@CLinePlanRangeDelAVN,	@LinePlanFinancialSort)


--***************************************************************************************
--===  No Of Options 
SET @LinePlanRangeID =  NULL
SELECT @LinePlanRangeID = LinePlanRangeID FROM pLinePlanRange 
WHERE  LinePlanFinancialID = '10000000-0000-0000-0000-000000000005'
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 

SELECT	@LinePlanRangeAttributeID = LinePlanRangeAttributeID,
@OLinePlanRangeDelCO1 = SUM(LinePlanRangeDelCO1), 	@OLinePlanRangeDelNV1 = SUM(LinePlanRangeDelNV1), 
@OLinePlanRangeDelN1	= SUM(LinePlanRangeDelN1), 	@OLinePlanRangeDelCO2 = SUM(LinePlanRangeDelCO2), 
@OLinePlanRangeDelNV2 = SUM(LinePlanRangeDelNV2), 	@OLinePlanRangeDelN2	= SUM(LinePlanRangeDelN2), 
@OLinePlanRangeDelCO3 = SUM(LinePlanRangeDelCO3), 	@OLinePlanRangeDelNV3 = SUM(LinePlanRangeDelNV3), 
@OLinePlanRangeDelN3	= SUM(LinePlanRangeDelN3), 	@OLinePlanRangeDelCO4 = SUM(LinePlanRangeDelCO4), 
@OLinePlanRangeDelNV4 = SUM(LinePlanRangeDelNV4), 	@OLinePlanRangeDelN4	= SUM(LinePlanRangeDelN4), 
@OLinePlanRangeDelTL1 = SUM(LinePlanRangeDelTL1), 	@OLinePlanRangeDelTL2 = SUM(LinePlanRangeDelTL2), 
@OLinePlanRangeDelTL3 = SUM(LinePlanRangeDelTL3), 	@OLinePlanRangeDelTL4 = SUM(LinePlanRangeDelTL4), 
@OLinePlanRange = LinePlanRange, @LinePlanFinancialSort = LinePlanFinancialSort
FROM   pLinePlanRangeAttribute
WHERE LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID 
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000005'
GROUP BY LinePlanRangeAttributeID, LinePlanRange, LinePlanFinancialSort



INSERT INTO #tmpLinePlanRange(
LinePlanRangeAttributeID,
LinePlanRangeID,		LinePlanFinancialID,	LinePlanRange,
LinePlanRangeDelCO1,	LinePlanRangeDelNV1,	LinePlanRangeDelN1,	LinePlanRangeDelTL1,
LinePlanRangeDelCO2,	LinePlanRangeDelNV2,	LinePlanRangeDelN2,	LinePlanRangeDelTL2,
LinePlanRangeDelCO3,	LinePlanRangeDelNV3,	LinePlanRangeDelN3,	LinePlanRangeDelTL3,
LinePlanRangeDelCO4,	LinePlanRangeDelNV4,	LinePlanRangeDelN4,	LinePlanRangeDelTL4,
LinePlanRangeDelAVCO,	LinePlanRangeDelAVNV,	LinePlanRangeDelAVN , LinePlanFinancialSort)
VALUES(
@LinePlanRangeAttributeID ,
@LinePlanRangeID,		'10000000-0000-0000-0000-000000000005',	@OLinePlanRange,	
@OLinePlanRangeDelCO1,	@OLinePlanRangeDelNV1,	@OLinePlanRangeDelN1,	@OLinePlanRangeDelTL1,
@OLinePlanRangeDelCO2,	@OLinePlanRangeDelNV2,	@OLinePlanRangeDelN2,	@OLinePlanRangeDelTL2,
@OLinePlanRangeDelCO3,	@OLinePlanRangeDelNV3,	@OLinePlanRangeDelN3,	@OLinePlanRangeDelTL3,	
@OLinePlanRangeDelCO4,	@OLinePlanRangeDelNV4,	@OLinePlanRangeDelN4,	@OLinePlanRangeDelTL4,
@OLinePlanRangeDelAVCO,	@OLinePlanRangeDelAVNV,	@OLinePlanRangeDelAVN,	@LinePlanFinancialSort)
*/


SELECT #tmpLinePlanRange.*, 
	pLinePlanFinancial.LinePlanFinancialDataType, 
	pLinePlanFinancial.LinePlanFinancialDataFormat, 
	pLinePlanFinancial.LinePlanFinancialCssClass
	FROM #tmpLinePlanRange INNER JOIN
    pLinePlanFinancial ON #tmpLinePlanRange.LinePlanFinancialID = pLinePlanFinancial.LinePlanFinancialID
ORDER BY  #tmpLinePlanRange.LinePlanFinancialSort


DROP TABLE #tmpLinePlanRange








GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleColorway_DELETE]'
GO
ALTER procedure [dbo].[spx_StyleColorway_DELETE] (
@StyleColorID UNIQUEIDENTIFIER 
)
AS 

DELETE FROM pStyleColorwayItem WHERE StyleColorID = @StyleColorID 
DELETE FROM pStyleColorway WHERE StyleColorID = @StyleColorID
DELETE FROM pStyleColorwaySeasonYear WHERE StyleColorwayID = @StyleColorID



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pMaterialRequestContent]'
GO
CREATE TABLE [dbo].[pMaterialRequestContent]
(
[MaterialContentID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_pMaterialRequestContent_MaterialContentID] DEFAULT (newid()),
[MaterialID] [uniqueidentifier] NULL,
[MaterialTradePartnerID] [uniqueidentifier] NULL,
[MaterialContentCode] [varchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MaterialContentPerc] [decimal] (18, 0) NULL,
[MaterialContentName] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pMaterialRequestContent] on [dbo].[pMaterialRequestContent]'
GO
ALTER TABLE [dbo].[pMaterialRequestContent] ADD CONSTRAINT [PK_pMaterialRequestContent] PRIMARY KEY CLUSTERED  ([MaterialContentID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialRequestContent_DELETE]'
GO

CREATE PROCEDURE [dbo].[spx_MaterialRequestContent_DELETE]
(
@MaterialId uniqueidentifier,
@MaterialTradePartnerId uniqueidentifier
)
AS 


DELETE FROM pMaterialRequestContent 
	WHERE MaterialId = @MaterialId 
	AND MaterialTradePartnerID = @MaterialTradePartnerID


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleWorkflowSubmit_UPDATE]'
GO


ALTER PROCEDURE [dbo].[spx_SampleWorkflowSubmit_UPDATE]
(@Status nvarchar(50),
@RevDate nvarchar(50),
@RevBy nvarchar(200),
@RecDate nvarchar(50),
@RecBy nvarchar(200),
@RecCarrier nvarchar(200),
@RecTrackNo nvarchar(50),
@RecWeight nvarchar(50),
@VendorWeight nvarchar(50),
@VendorName nvarchar(200),
@VendorDate nvarchar(50),
@DueDate nvarchar(50),
@EndDate nvarchar(50),
@EndBy nvarchar(200),
@SampleRequestWorkflowID uniqueidentifier,
@SampleWorkflowID nvarchar(5),
@StyleID uniqueidentifier,
@StyleColorID uniqueidentifier,
@StyleSet int,
@SampleRequestTradeID uniqueidentifier,
@Submit int,
@ModifiedBy nvarchar(200),
@ModifiedDate datetime,
@NoTolerance int = 0,
@InternalComment ntext,
@SampleLockVendorFields int = 0
)
AS 

DECLARE @vcDate as varchar (15) 

IF @Status  =  4 
	SET @EndDate =  GetDate()

IF (SELECT COUNT(*) FROM pSampleRequestSpecSize WITH (NOLOCK) WHERE StyleID = @StyleID AND StyleSet = @StyleSet AND SampleRequestTradeID = @SampleRequestTradeID AND SampleRequestWorkflowID = @SampleRequestWorkflowID AND StyleColorID = @StyleColorID) = 0

BEGIN	

	INSERT INTO dbo.pSampleRequestSpecSize
	(SampleRequestSpecSizeID, SampleRequestTradeID, SampleRequestWorkflowID, SampleWorkflowID, WorkflowID, StyleColorID, StyleID, SizeRange, StyleSet, 
	Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13, Size14, Size15, Size16, Size17, Size18, Size19, 
	Col0, Col1, Col2, Col3, Col4, Col5, Col6, Col7, Col8, Col9, Col10, Col11, Col12, Col13, Col14, Col15, Col16, Col17, Col18, Col19, 
	Sel0, Sel1, Sel2, Sel3, Sel4, Sel5, Sel6, Sel7, Sel8, Sel9, Sel10, Sel11, Sel12, Sel13, Sel14, Sel15, Sel16, Sel17, Sel18, Sel19)
	SELECT     NEWID(), @SampleRequestTradeID, @SampleRequestWorkflowID, @SampleWorkflowID, '{40000000-0000-0000-0000-000000000005}', @StyleColorID,
	StyleID, SizeRange, @StyleSet, 
	Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13, Size14, Size15, Size16, Size17, Size18, Size19, 
	0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0 ,0 ,0 ,0 ,0 ,0, 
	Sel0, Sel1, Sel2, Sel3, Sel4, Sel5, Sel6, Sel7, Sel8, Sel9, Sel10, Sel11, Sel12, Sel13, Sel14, Sel15, Sel16, Sel17, Sel18, Sel19
	FROM dbo.pStyleSpecSize WITH (NOLOCK) WHERE (StyleID = @StyleID)

END


BEGIN

	IF @SampleLockVendorFields  =  0
	BEGIN 
		UPDATE    dbo.pSampleRequestSubmit
		SET              Status = @Status, RevDate = @RevDate, RevBy = @RevBy, RecDate = @RecDate, RecBy = @RecBy, RecCarrier = @RecCarrier, RecTrackNo = @RecTrackNo, RecWeight = @RecWeight, 
		                      VendorWeight = @VendorWeight, DueDate = @DueDate, EndDate = @EndDate, EndBy = @EndBy, MUser = @ModifiedBy, 
		                      MDate = @ModifiedDate, VendorDate = @VendorDate, VendorName = @VendorName, InternalComment = @InternalComment, NoTolerance = @NoTolerance  
		WHERE     (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (SampleWorkflowID = @SampleWorkflowID) AND (StyleID = @StyleID) AND 
		                      (StyleColorID = @StyleColorID) AND (StyleSet = @StyleSet) AND (SampleRequestTradeID = @SampleRequestTradeID) AND (Submit = @Submit)
	END
	ELSE 
	BEGIN
		UPDATE    dbo.pSampleRequestSubmit
		SET              Status = @Status, RevDate = @RevDate, RevBy = @RevBy, RecDate = @RecDate, RecBy = @RecBy,  RecWeight = @RecWeight, 
		                      DueDate = @DueDate, EndDate = @EndDate, EndBy = @EndBy, MUser = @ModifiedBy, 
		                      MDate = @ModifiedDate,  InternalComment = @InternalComment, NoTolerance = @NoTolerance  
		WHERE     (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (SampleWorkflowID = @SampleWorkflowID) AND (StyleID = @StyleID) AND 
		                      (StyleColorID = @StyleColorID) AND (StyleSet = @StyleSet) AND (SampleRequestTradeID = @SampleRequestTradeID) AND (Submit = @Submit)
	END
	
END                      



DECLARE @Month NVARCHAR(2) 
DECLARE @nMont INT 

IF @Status = 1
	SET @nMont = @Submit + 1
ELSE 
	SET @nMont = @Submit


IF  @Submit < 10
	SET @Month  = '0' + CAST(@Submit AS VARCHAR(1))
ELSE 
	SET @Month  = CAST(@Submit AS VARCHAR(2))


IF @Status = 0        -- OPEN 
BEGIN

	if @Submit > 1 
		SET @vcDate =  '1900-' + @Month + '-02' -- +  '/2/1900'
	ELSE
		SET @vcDate = '1900-' + @Month + '-01'  -- '/1/1900'

	UPDATE    dbo.pSampleRequestWorkflow
	SET              Submit = @Submit, Status = @Status, DueDate = @DueDate, 
	--EndDate = CONVERT(nvarchar(2),@Submit) +  @vcDate, 
	EndDate = @vcDate, 
	MUser = @ModifiedBy, MDate = @ModifiedDate
	WHERE     (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (SampleWorkflowID = @SampleWorkflowID) AND (StyleID = @StyleID) 
	AND  (StyleColorID = @StyleColorID) AND (StyleSet = @StyleSet) AND (SampleRequestTradeID = @SampleRequestTradeID) 
END
ELSE IF @Status = 1       -- RESUMIT
BEGIN

	SET @vcDate =  '1900-' + @Month + '-02' 

	UPDATE    pSampleRequestWorkflow
	SET              Submit = (@Submit + 1), Status = 0, DueDate = @DueDate, 
	--EndDate = CONVERT(nvarchar(2),(@Submit + 1)) + '/2/1900', 
	EndDate = @vcDate,
	MUser = @ModifiedBy, MDate = @ModifiedDate
	WHERE     (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (SampleWorkflowID = @SampleWorkflowID) AND (StyleID = @StyleID) AND 
						  (StyleColorID = @StyleColorID) AND (StyleSet = @StyleSet) AND (SampleRequestTradeID = @SampleRequestTradeID) 
END
ELSE IF @Status = 4       -- DROPPED 
BEGIN

	SET @vcDate =  '1900-' + @Month + '-03' 

	UPDATE    dbo.pSampleRequestWorkflow
	SET              Submit = @Submit, Status = @Status, DueDate = @DueDate, 
	--EndDate = CONVERT(nvarchar(2),@Submit) + '/3/1900', 
	EndDate = @vcDate,
	MUser = @ModifiedBy, MDate = @ModifiedDate
	WHERE     (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (SampleWorkflowID = @SampleWorkflowID) AND (StyleID = @StyleID) AND 
		  (StyleColorID = @StyleColorID) AND (StyleSet = @StyleSet) AND (SampleRequestTradeID = @SampleRequestTradeID) 
END
ELSE
BEGIN
	UPDATE dbo.pSampleRequestWorkflow
	SET              Submit = @Submit, Status = @Status, DueDate = @DueDate, EndDate = @EndDate, MUser = @ModifiedBy, MDate = @ModifiedDate
	WHERE     (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (SampleWorkflowID = @SampleWorkflowID) AND (StyleID = @StyleID) AND 
						  (StyleColorID = @StyleColorID) AND (StyleSet = @StyleSet) AND (SampleRequestTradeID = @SampleRequestTradeID) 
END




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleMaterialVariation_INSERT]'
GO





ALTER PROCEDURE [dbo].[spx_StyleMaterialVariation_INSERT]
(
@StyleID uniqueidentifier,
@NewStyleID uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate nvarchar(50), 
@ColorsSelected int  = 0 
)
AS


CREATE TABLE #tempStyleMaterials (
RecID int IDENTITY(1,1)  NOT NULL,
StyleMaterialID  uniqueidentifier ROWGUIDCOL  NOT NULL ,
StyleMaterialMasterID uniqueidentifier,
Colorway nvarchar (3),
)


CREATE TABLE #tempCopyStyleMaterials (
	RecID int IDENTITY(1,1)  NOT NULL,
	StyleMaterialID  uniqueidentifier ROWGUIDCOL  NOT NULL ,
	StyleMaterialMasterID uniqueidentifier,
	CopyStyleMaterialID uniqueidentifier,
	MainMaterial int,
	Development bit,
	StyleSet int,
	StyleID uniqueidentifier,
	UOM nvarchar (50),
	Qty nvarchar (18),
	MaterialPrice money,
	Ext money,
	MaterialSize nvarchar (200),
	MaterialID uniqueidentifier,
	MaterialPlacement bit,
	MaterialPlacementCode nvarchar (4),
	MaterialPlacementDetail nvarchar (200),
	MaterialImageID uniqueidentifier,
	MaterialImageVersion int,
	NoColorMatch int,
	SupplierID nvarchar (50),
	ComponentTypeID int,
	MaterialType int,
	MaterialNo nvarchar (50),
	MaterialName nvarchar (200),
	A nvarchar (100),
	B nvarchar (100),
	C nvarchar (100),
	D nvarchar (100),
	E nvarchar (100),
	F nvarchar (100),
	G nvarchar (100),
	H nvarchar (100),
	I nvarchar (100),
	J nvarchar (100),
	K nvarchar (100),
	L nvarchar (100),
	M nvarchar (100),
	N nvarchar (100),
	O nvarchar (100),
	P nvarchar (100),
	Q nvarchar (100),
	R nvarchar (100),
	S nvarchar (100),
	T nvarchar (100),
	U nvarchar (100),
	V nvarchar (100),
	W nvarchar (100),
	X nvarchar (100),
	Y nvarchar (100),
	Z nvarchar (100),
	Source nvarchar (200),
	Notes nvarchar (4000),
	Placement nvarchar (4000),
	VendorPrice decimal(19, 3),
	VolumePrice decimal(19, 3),
	VolumePriceMinimum nvarchar (50),
	VendorProductionMin nvarchar (50),
	VendorProductionLeadTime nvarchar (50),
	DetailYesNo int,
	ImageType nvarchar (50),
	height nvarchar (18),
	width nvarchar (18),
	CDate datetime,
	CUser nvarchar (200),
	MDate datetime,
	MUser nvarchar (200),
	MChange int,
	SChange int,
	DChange int,
	CChange int,
	Action nvarchar (50),
	ColorPlacement nvarchar (4000),
	Artwork nvarchar (3),
	License nvarchar (3),
	Colorway nvarchar (3),
	MaterialSort varchar (5),
	MaterialTrack int,
	MaterialLinked int,
	MaterialLining int,
	MaterialSizeID UNIQUEIDENTIFIER,
	TradePartnerID UNIQUEIDENTIFIER,
	TradePartnerVendorID UNIQUEIDENTIFIER,
	CopyMaterialID UNIQUEIDENTIFIER
)

CREATE TABLE #tempStyleColorway (
	RecID int IDENTITY(1,1)  NOT NULL,
	StyleColorID  uniqueidentifier ROWGUIDCOL  NOT NULL ,
	StyleID uniqueidentifier,
	StyleSet int,
	StyleColorStandardID uniqueidentifier,
	StyleColorNo nvarchar (200) ,						
	StyleColorName nvarchar (200) ,
	MainColor nvarchar (100) ,
	Sort nvarchar (10) ,
	Version int,
	CDate datetime,
	CUser nvarchar (200),
	MDate datetime,
	MUser nvarchar (200),
	CopyStyleColorID UNIQUEIDENTIFIER ,
	ColorPaletteID UNIQUEIDENTIFIER ,
	SAPCode NVARCHAR(200),
	PLMCode NVARCHAR(200)
	
) 

CREATE TABLE #tempCopyStyleColorway (
	RecID int IDENTITY(1,1)  NOT NULL,
	StyleColorID  uniqueidentifier ROWGUIDCOL  NOT NULL ,
	StyleID uniqueidentifier,
	StyleSet int,
	StyleColorStandardID uniqueidentifier,
	StyleColorNo nvarchar (200) ,						
	StyleColorName nvarchar (200) ,
	MainColor nvarchar (100) ,
	Sort nvarchar (10) ,
	Version int,
	CDate datetime,
	CUser nvarchar (200),
	MDate datetime,
	MUser nvarchar (200) ,
	CopyStyleColorID UNIQUEIDENTIFIER , 
	ColorPaletteID UNIQUEIDENTIFIER,
	SAPCode NVARCHAR(200),
	PLMCode NVARCHAR(200)
) 

CREATE TABLE #tempStyleColorwayItem (
	RecID int IDENTITY(1,1)  NOT NULL,
	StyleColorItemID  uniqueidentifier,
	StyleColorItemMasterID uniqueidentifier, 
	StyleColorID uniqueidentifier,
	StyleID uniqueidentifier,
	StyleSet int,
	StyleMaterialID uniqueidentifier,
	MaterialID uniqueidentifier,
	MaterialColorID uniqueidentifier,
	CDate datetime,
	CUser nvarchar (200),
	MDate datetime,
	MUser nvarchar (200)
) 

CREATE TABLE #tempCopyStyleColorwayItem (
	RecID int IDENTITY(1,1)  NOT NULL,
	StyleColorItemID  uniqueidentifier,
	StyleColorItemMasterID uniqueidentifier, 
	StyleColorID uniqueidentifier,
	StyleID uniqueidentifier,
	StyleSet int,
	StyleMaterialID uniqueidentifier,
	MaterialID uniqueidentifier,
	MaterialColorID uniqueidentifier,
	CDate datetime,
	CUser nvarchar (200),
	MDate datetime,
	MUser nvarchar (200)
) 

CREATE TABLE #tempStyleSeasonYear(
RecID INT IDENTITY (1,1),
StyleSeasonYearID UNIQUEIDENTIFIER, 
StyleSeason NVARCHAR(50),  
StyleYear NVARCHAR(50), 
SeasonYearID UNIQUEIDENTIFIER, 
NewStyleSeasonYearID UNIQUEIDENTIFIER
)

CREATE TABLE #tempStyleColorwaySeasonYear (
RecID INT IDENTITY (1,1),
StyleColorwaySeasonYearID UNIQUEIDENTIFIER,
StyleSeasonYearID UNIQUEIDENTIFIER,
StyleColorwayID UNIQUEIDENTIFIER,
StyleColorDelivery1 INT,
StyleColorDelivery2 INT,
StyleColorDelivery3 INT,
StyleColorDelivery4 INT,
StyleColorStatus  INT,
Units  INT,
ColorType NVARCHAR(5) ,
SampleStatus  INT ,
NewStyleColorwayID UNIQUEIDENTIFIER,
NewStyleSeasonYearID UNIQUEIDENTIFIER
)


DECLARE @Row_Count int
DECLARE @Row_Loop int
DECLARE @Row_Color_Count int
DECLARE @Row_Color_Loop int

DECLARE @Season VARCHAR(100)
DECLARE @Year VARCHAR(100)
DECLARE @SeasonYearID UNIQUEIDENTIFIER
DECLARE @StyleCopyType VARCHAR(50)


BEGIN

	-- Original ! 
	IF @ColorsSelected = 1 
		INSERT INTO #tempStyleColorway
    			(StyleColorID, StyleID, StyleSet, StyleColorStandardID, StyleColorNo, StyleColorName, MainColor, Sort, Version, CDate, CUser, MDate, 
				MUser , ColorPaletteID, SAPCode, PLMCode)
		SELECT StyleColorID, StyleID, StyleSet, StyleColorStandardID, StyleColorNo, StyleColorName, MainColor, Sort, Version, @CreatedDate AS CDate, @CreatedBy AS CUser, 
    			@CreatedDate AS MDate, @CreatedBy AS MUser , ColorPaletteID, SAPCode, PLMCode
		FROM pStyleColorway WITH (NOLOCK)
		WHERE (StyleID = @StyleID) 
		AND (StyleColorID IN (SELECT StyleColorwayID FROM pStyleColorwayTemp WITH (NOLOCK) WHERE NewStyleID = @NewStyleID))
	ELSE 
		INSERT INTO #tempStyleColorway
    			(StyleColorID, StyleID, StyleSet, StyleColorStandardID, StyleColorNo, StyleColorName, MainColor, Sort, Version, CDate, CUser, MDate, 
				MUser , ColorPaletteID, SAPCode, PLMCode)
		SELECT StyleColorID, StyleID, StyleSet, StyleColorStandardID, StyleColorNo, StyleColorName, MainColor, Sort, Version, @CreatedDate AS CDate, @CreatedBy AS CUser, 
    			@CreatedDate AS MDate, @CreatedBy AS MUser , ColorPaletteID, SAPCode, PLMCode
		FROM pStyleColorway WITH (NOLOCK)
		WHERE (StyleID = @StyleID) 
		

	DECLARE @StyleColorID uniqueidentifier 	
	DECLARE @NewStyleColorID uniqueidentifier 	
	
	SET @Row_Loop = 1
	SET @Row_Count = (SELECT COUNT(*) FROM #tempStyleColorway)

	WHILE @Row_Loop <= @Row_Count 
	BEGIN
		SELECT @StyleColorID = StyleColorID FROM  #tempStyleColorway WHERE RecID = @Row_Loop
		SET @NewStyleColorID = newid()
	
		-- New Colorways, keeping track of original in CopyStyleColorID 
		INSERT INTO #tempCopyStyleColorway
		(StyleColorID, StyleID, StyleSet, StyleColorStandardID, StyleColorNo, StyleColorName, MainColor, Sort, Version, CDate, CUser, MDate, 
		MUser, CopyStyleColorID, ColorPaletteID , SAPCode, PLMCode)
		SELECT @NewStyleColorID, @NewStyleID, StyleSet, StyleColorStandardID, StyleColorNo, StyleColorName, MainColor, Sort, Version, @CreatedDate AS CDate, @CreatedBy AS CUser, 
		@CreatedDate AS MDate, @CreatedBy AS MUser, StyleColorID, ColorPaletteID, SAPCode, PLMCode
		FROM pStyleColorway WITH (NOLOCK)
		WHERE (StyleColorID = @StyleColorID)
	
		SET @Row_Loop = @Row_Loop + 1
	END
END	
	
-- FIX StyleColorItemMasterID	
BEGIN	
	-- Original Colorway items !!

	IF @ColorsSelected = 1 
		INSERT INTO #tempStyleColorwayItem
		(StyleColorItemID, StyleColorItemMasterID, StyleColorID, StyleID, StyleSet, StyleMaterialID, MaterialID, MaterialColorID, CDate, CUser, MDate, MUser)
		SELECT StyleColorItemID, StyleColorItemMasterID, StyleColorID, StyleID, StyleSet, StyleMaterialID, MaterialID, MaterialColorID, CDate, CUser, MDate, MUser
		FROM  pStyleColorwayItem WITH (NOLOCK)
		WHERE (StyleID = @StyleID) 
		AND (StyleColorID IN (SELECT StyleColorwayID FROM pStyleColorwayTemp WHERE NewStyleID = @NewStyleID))
	ELSE 
		INSERT INTO #tempStyleColorwayItem
		(StyleColorItemID, StyleColorItemMasterID, StyleColorID, StyleID, StyleSet, StyleMaterialID, MaterialID, MaterialColorID, CDate, CUser, MDate, MUser)
		SELECT StyleColorItemID, StyleColorItemMasterID, StyleColorID, StyleID, StyleSet, StyleMaterialID, MaterialID, MaterialColorID, CDate, CUser, MDate, MUser
		FROM  pStyleColorwayItem WITH (NOLOCK)
		WHERE (StyleID = @StyleID) 
		

	
	SET @Row_Loop = 1
	SET @Row_Count = (SELECT COUNT(*) FROM #tempStyleColorwayItem)
	
	DECLARE @StyleColorItemID uniqueidentifier 	
	DECLARE @StyleColorItemMasterID  uniqueidentifier 	

	WHILE @Row_Loop <= @Row_Count 
	BEGIN
		SELECT @StyleColorItemMasterID = StyleColorItemMasterID, @StyleColorItemID = StyleColorItemID 
		FROM  #tempStyleColorwayItem WHERE RecID = @Row_Loop
	
		IF @StyleColorItemMasterID IS NULL
		BEGIN
			UPDATE #tempStyleColorwayItem SET StyleColorItemMasterID = newid() WHERE StyleColorItemID = @StyleColorItemID	
			--UPDATE pStyleColorwayItem SET StyleColorItemMasterID = newid() WHERE StyleColorItemID = @StyleColorItemID
		END	

		SET @Row_Loop = @Row_Loop + 1
	END
END	


		
BEGIN

	INSERT INTO #tempStyleMaterials	(StyleMaterialMasterID, StyleMaterialID, Colorway)
	SELECT StyleMaterialMasterId, StyleMaterialID, Colorway
	FROM pStyleMaterials WITH (NOLOCK)
	WHERE (StyleID = @StyleID)


	DECLARE @StyleMaterialMasterID uniqueidentifier
	DECLARE @StyleMaterialID uniqueidentifier
	DECLARE @NewStyleMaterialID uniqueidentifier
	DECLARE @Colorway nvarchar(3)

	SET @Row_Loop = 1
	SET @Row_Count = (SELECT COUNT(*) FROM #tempStyleMaterials)
	
	WHILE @Row_Loop <= @Row_Count 
	BEGIN
		SELECT @StyleMaterialMasterID = StyleMaterialMasterID, @StyleMaterialID = StyleMaterialID, @Colorway = Colorway 
		FROM #tempStyleMaterials WHERE RecID = @Row_Loop
		
		BEGIN
			-- New StyleMaterial in temp table 
			SET @NewStyleMaterialID = newid()
			INSERT INTO #tempCopyStyleMaterials
				(StyleMaterialID, MainMaterial, StyleSet, StyleID, UOM, Qty, MaterialPrice, Ext, MaterialSize, MaterialID, MaterialImageID, 
				MaterialImageVersion, NoColorMatch, SupplierID, ComponentTypeID, MaterialType, MaterialNo, MaterialName, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O,
				P, Q, R, S, T, U, V, W, X, Y, Z, Source, Notes, Placement, VendorPrice, VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, 
				DetailYesNo, ImageType, ColorPlacement, Artwork, License, Colorway, CDate, CUser, MDate, MUser, MChange,  SChange, DChange, 
				CChange, Action, StyleMaterialMasterID, Development, MaterialTrack, MaterialLinked, MaterialSort, MaterialLining , CopyStyleMaterialID, MaterialSizeID, 
				TradePartnerID, TradePartnerVendorID, CopyMaterialID)
			SELECT @NewStyleMaterialID, MainMaterial, StyleSet, @NewStyleID AS StyleID, UOM, 
				Qty, MaterialPrice, Ext, MaterialSize, MaterialID, MaterialImageID, MaterialImageVersion, NoColorMatch, SupplierID, 
				ComponentTypeID, MaterialType, MaterialNo, MaterialName, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S,  T, U, V, W, X, Y, Z,Source, Notes, 
				Placement AS Placement, VendorPrice, VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, DetailYesNo, 
				ImageType, ColorPlacement, Artwork, License, Colorway, @CreatedDate AS CDate, @CreatedBy AS CUser, 
				@CreatedDate AS MDate, @CreatedBy AS MUser, MChange, SChange, DChange, CChange, Action, newid() AS StyleMaterialMasterId , 
				Development, MaterialTrack, MaterialLinked, MaterialSort, MaterialLining, StyleMaterialID  AS CopyStyleMaterialID, MaterialSizeID, 
				TradePartnerID, TradePartnerVendorID, MaterialID
			FROM pStyleMaterials WITH (NOLOCK)
			WHERE (StyleMaterialID = @StyleMaterialID)
				
			---Style Colorway--------------------------------------------
			
			SET @Row_Color_Loop = 1
			SET @Row_Color_Count = (SELECT COUNT(*) FROM #tempStyleColorway)
														
			IF @Colorway = 1
			BEGIN
				WHILE @Row_Color_Loop <= @Row_Color_Count
				BEGIN
							
					SELECT @StyleColorID = StyleColorID FROM  #tempStyleColorway WHERE RecID = @Row_Color_Loop
					SELECT @NewStyleColorID = StyleColorID FROM  #tempCopyStyleColorway WHERE RecID = @Row_Color_Loop

					
					INSERT INTO #tempCopyStyleColorwayItem
					(StyleColorItemID, StyleColorItemMasterID, StyleColorID, StyleID, StyleSet, StyleMaterialID, MaterialID, MaterialColorID, CDate, CUser, MDate, MUser)
					SELECT newid() AS StyleColorItemID, StyleColorItemMasterID, @NewStyleColorID, @NewStyleID, StyleSet, @NewStyleMaterialID, MaterialID, MaterialColorID, CDate, CUser, MDate, MUser
					FROM  #tempStyleColorwayItem
					WHERE StyleColorID = @StyleColorID AND StyleMaterialID = @StyleMaterialID		
							
					SET @Row_Color_Loop = @Row_Color_Loop + 1
				END
			END
		END			
		SET @Row_Loop = @Row_Loop + 1
	END
END


	INSERT INTO pStyleMaterials (
		StyleMaterialID, MainMaterial, StyleSet, StyleID, UOM, Qty, MaterialPrice, Ext, MaterialSize, MaterialID, MaterialImageID, 
		MaterialImageVersion, NoColorMatch, SupplierID, ComponentTypeID, MaterialType, MaterialNo, MaterialName, 
		A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S,  T, U, V, W, X, Y, Z,
		Source, Notes, Placement, VendorPrice, VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, 
		DetailYesNo, ImageType, ColorPlacement, Artwork, License, Colorway, CDate, CUser, MDate, MUser, MChange,  SChange, DChange, 
		CChange, Action, StyleMaterialMasterID, Development, MaterialTrack, MaterialLinked, MaterialSort, MaterialLining, CopyStyleMaterialID, 
		MaterialSizeID, TradePartnerID, TradePartnerVendorID )
	SELECT 
		StyleMaterialID, MainMaterial, StyleSet, StyleID, UOM, Qty, MaterialPrice, Ext, MaterialSize, MaterialID, MaterialImageID, 
		MaterialImageVersion, NoColorMatch, SupplierID, ComponentTypeID, MaterialType, MaterialNo, MaterialName, 
		A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S,  T, U, V, W, X, Y, Z,
		Source, Notes, Placement, VendorPrice, VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, 
		DetailYesNo, ImageType, ColorPlacement, Artwork, License, Colorway, @CreatedDate, @CreatedBy, @CreatedDate, @CreatedBy, MChange, SChange, DChange, 
		CChange, Action, StyleMaterialMasterID, Development, MaterialTrack, MaterialLinked, MaterialSort, MaterialLining , CopyStyleMaterialID, 
		MaterialSizeID, TradePartnerID, TradePartnerVendorID
	FROM #tempCopyStyleMaterials
	

	INSERT INTO dbo.pStyleColorway
		(StyleColorID, StyleID, StyleSet, StyleColorStandardID, StyleColorNo, StyleColorName, MainColor, Sort, Version, CDate, CUser, MDate, MUser , 
		CopyStyleColorID , ColorPaletteID, SAPCode, PLMCode)
	SELECT StyleColorID, StyleID, StyleSet, StyleColorStandardID, StyleColorNo, StyleColorName, MainColor, Sort, Version, GETDATE(), @CreatedBy, GETDATE(), @CreatedBy, 
		CopyStyleColorID, ColorPaletteID, SAPCode, PLMCode
	FROM #tempCopyStyleColorway
	
	INSERT INTO dbo.pStyleColorwayItem
		(StyleColorItemID, StyleColorItemMasterID, StyleColorID, StyleID, StyleSet, StyleMaterialID, MaterialID, MaterialColorID, CDate, CUser, MDate, MUser)
	SELECT StyleColorItemID, StyleColorItemMasterID, StyleColorID, StyleID, StyleSet, StyleMaterialID, MaterialID, MaterialColorID, GETDATE(), @CreatedBy, GETDATE(), @CreatedBy
	FROM  #tempCopyStyleColorwayItem	

	DECLARE @StyleMaterialIDTmp  AS uniqueidentifier   

	SELECT TOP 1 @StyleMaterialIDTmp = StyleMaterialID FROM pStyleMaterials WITH (NOLOCK) 
	WHERE StyleID = @NewStyleID AND MainMaterial = 1 

	UPDATE pStyleHeader SET StyleMaterialID = @StyleMaterialIDTmp
	WHERE StyleID = @NewStyleID






--*************************************************************************************
-- Season year

DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER 
DECLARE @NewStyleSeasonYearID UNIQUEIDENTIFIER 
DECLARE @StyleNo NVARCHAR(20) 

SELECT @StyleNo = StyleNo, @Season = CustomField5, @Year = CustomField6 
FROM pStyleHeader WHERE StyleID = @NewStyleID

--SELECT StyleNo, CustomField5, CustomField6  FROM pStyleHeader WHERE StyleID = @NewStyleID


INSERT INTO #tempStyleSeasonYear( StyleSeasonYearID , StyleSeason ,StyleYear,SeasonYearID, NewStyleSeasonYearID )
SELECT StyleSeasonYearID,  StyleSeason, StyleYear , SeasonYearID , NEWID() AS StyleSeasonYearID 
FROM pStyleSeasonYear WHERE StyleID = @StyleID


INSERT INTO #tempStyleColorwaySeasonYear (StyleColorwaySeasonYearID, StyleSeasonYearID, StyleColorwayID, 
StyleColorDelivery1,StyleColorDelivery2, StyleColorDelivery3, StyleColorDelivery4, StyleColorStatus,
Units, ColorType, SampleStatus)
SELECT NEWID() AS StyleColorwaySeasonYearID, StyleSeasonYearID, StyleColorwayID, 
StyleColorDelivery1,StyleColorDelivery2, StyleColorDelivery3, StyleColorDelivery4, StyleColorStatus,
Units, ColorType, SampleStatus  -- NewStyleColorwayID, NewStyleSeasonYearID
FROM pStyleColorwaySeasonYear
WHERE StyleID = @StyleID


SET @Row_Loop = 1
SET @Row_Count = (SELECT COUNT(*) FROM #tempStyleSeasonYear)


WHILE @Row_Loop <= @Row_Count 
BEGIN 
	SELECT @StyleSeasonYearID = StyleSeasonYearID, @NewStyleSeasonYearID = NewStyleSeasonYearID
	FROM   #tempStyleSeasonYear WHERE RecID = @Row_Loop
	

	SET @Row_Color_Loop = 1
	SET @Row_Color_Count = (SELECT COUNT(*) FROM #tempCopyStyleColorway)	

	WHILE @Row_Color_Loop <= @Row_Color_Count 
	BEGIN

		SELECT @StyleColorID = CopyStyleColorID , @NewStyleColorID = StyleColorID 
		FROM #tempCopyStyleColorway WHERE RecID = @Row_Color_Loop 

		UPDATE #tempStyleColorwaySeasonYear
		SET NewStyleColorwayID = @NewStyleColorID,
		NewStyleSeasonYearID = @NewStyleSeasonYearID
		WHERE StyleSeasonYearID = @StyleSeasonYearID
		AND StyleColorwayID = @StyleColorID 


		SET @Row_Color_Loop = @Row_Color_Loop + 1

	END 

	SET @Row_Loop = @Row_Loop + 1 

END 
	

DELETE FROM pStyleSeasonYear WHERE StyleID = @NewStyleID

INSERT INTO  pStyleSeasonYear ( StyleSeasonYearID , StyleID , StyleSeason, StyleYear, CUser, CDate, MUser, MDate, 
SeasonYearID , StyleNo, CurrentSeason, MostLikelyVendor )
SELECT NewStyleSeasonYearID , @NewStyleID as StyleID , StyleSeason ,StyleYear, @CreatedBy ,@CreatedDate,  @CreatedBy ,@CreatedDate,
SeasonYearID, @StyleNo,  0 , 0 
FROM  #tempStyleSeasonYear 

INSERT INTO  pStyleColorwaySeasonYear  ( StyleColorwaySeasonYearID, StyleSeasonYearID, StyleColorwayID, StyleID, 
StyleColorDelivery1, StyleColorDelivery2, StyleColorDelivery3, StyleColorDelivery4, StyleColorStatus,
Units, ColorType, SampleStatus)
SELECT StyleColorwaySeasonYearID, NewStyleSeasonYearID, NewStyleColorwayID , @NewStyleID , 
StyleColorDelivery1, StyleColorDelivery2, StyleColorDelivery3, StyleColorDelivery4, StyleColorStatus,
Units, ColorType, SampleStatus 
FROM #tempStyleColorwaySeasonYear 



/********************************************************************************************************************************************************/



-- Create Style, Material, MaterialColor SeasonYearID's
-- #4 MAP SEASON AND YEAR FROM pStyleHeader TABLE
-- DP 7/14/2009


--See Comment #4
--SELECT @StyleCopyType = StyleCopyType FROM pStyleDevelopmentItemTemp WITH (NOLOCK) WHERE NewStyleID = @NewStyleID
--
--
--IF @StyleCopyType = 'CARRYOVER'
--	BEGIN
--
--		DECLARE @MaterialID UNIQUEIDENTIFIER
--		DECLARE @MaterialColorID UNIQUEIDENTIFIER
--
--		DECLARE @CopySeasonYearID UNIQUEIDENTIFIER
--		DECLARE @CopyMaterialSeason VARCHAR(200)
--		DECLARE @CopyMaterialYear VARCHAR(100)
--
--		DECLARE @MaterialSeason VARCHAR(200)
--		DECLARE @MaterialYear VARCHAR(100)
--
--		DECLARE @MaterialTradePartnerID UNIQUEIDENTIFIER
--		DECLARE @TradePartnerID UNIQUEIDENTIFIER
--		DECLARE @TradePartnerVendorID UNIQUEIDENTIFIER
--
--		SELECT @CopySeasonYearID = SeasonYearID,
--			@CopyMaterialSeason = StyleSeason,
--			@CopyMaterialYear = StyleYear
--		FROM pStyleSeasonYear WITH (NOLOCK) WHERE StyleID = @StyleID
--
--		SELECT @MaterialSeason = @Season, @MaterialYear = @Year
--
--		SELECT @SeasonYearID = SeasonYearID
--		FROM pSeasonYear WITH (NOLOCK) 
--		WHERE Season = @MaterialSeason AND Year = @MaterialYear 
--
--
--		--SELECT * FROM pStyleSeasonYear WITH (NOLOCK) WHERE StyleID = @NewStyleID
--
--
--		--- MATERIAL  SEASON/YEAR 
--		SET @Row_Loop = 1
--		SET @Row_Count = (SELECT COUNT(*) FROM #tempCopyStyleMaterials)
--		WHILE @Row_Loop <= @Row_Count 
--		
--		BEGIN
--			SELECT @TradePartnerID = TradePartnerID, @TradePartnerVendorID = TradePartnerVendorID, @MaterialID = MaterialID 
--			FROM #tempCopyStyleMaterials WHERE RecID = @Row_Loop
--			BEGIN				
--				IF (SELECT COUNT(*) FROM pMaterialSeasonYear WITH (NOLOCK) 
--				WHERE MaterialID = @MaterialID AND SeasonYearID = @SeasonYearID) = 0
--				BEGIN
--					INSERT INTO pMaterialSeasonYear(SeasonYearID, MaterialID, CUser, CDate) VALUES (@SeasonYearID, @MaterialID, @CreatedBy, @CreatedDate)
--				END			
--			END
--			SET @Row_Loop = @Row_Loop + 1
--		END	
--		
--
--
--		BEGIN	
--		SET @Row_Color_Loop = 1
--		SET @Row_Color_Count = (SELECT COUNT(*) FROM #tempCopyStyleColorwayItem)
--
--			--IF @Colorway = 1
--			BEGIN
--				WHILE @Row_Color_Loop <= @Row_Color_Count				
--					BEGIN
--						SELECT @MaterialColorID = MaterialColorID, @MaterialID = MaterialID FROM  #tempCopyStyleColorwayItem WHERE RecID = @Row_Color_Loop
--							IF (SELECT COUNT(*) FROM pMaterialColorSeasonYear WITH (NOLOCK) WHERE MaterialID = @MaterialID AND SeasonYearID = @SeasonYearID AND MaterialColorID = @MaterialColorID) = 0
--							BEGIN
--
--								INSERT INTO pMaterialColorSeasonYear(MaterialColorID, SeasonYearID, MaterialID, MaterialSeason, MaterialYear, CUser, CDate, MUser, MDate) 
--								VALUES (@MaterialColorID, @SeasonYearID, @MaterialID, @MaterialSeason, @MaterialYear, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate)
--
--							END								
--						SET @Row_Color_Loop = @Row_Color_Loop + 1						
--					END					
--			END
--		END	
--
--		SET @Row_Loop = 1
--		SET @Row_Count = (SELECT COUNT(*) FROM #tempCopyStyleMaterials)
--		WHILE @Row_Loop <= @Row_Count 
--		BEGIN
--			SELECT @TradePartnerID = TradePartnerID, @TradePartnerVendorID = TradePartnerVendorID, @MaterialID = MaterialID FROM #tempCopyStyleMaterials WHERE RecID = @Row_Loop

--				IF (SELECT COUNT(*) FROM pMaterialTradePartner WITH (NOLOCK) WHERE MaterialID = @MaterialID AND SeasonYearID = @SeasonYearID AND TradePartnerVendorID = @TradePartnerVendorID) = 0
--					BEGIN
--						SET @MaterialTradePartnerID = newid()
--
--						INSERT INTO pMaterialTradePartner(
--							MaterialTradePartnerId,MaterialId,TradepartnerId,TradepartnerVendorId,MaterialTradePartnerCustom1,MaterialTradePartnerCustom2
--						   ,MaterialTradePartnerCustom3,MaterialTradePartnerCustom4,MaterialTradePartnerCustom5
--						   ,MaterialTradePartnerCustom6,MaterialTradePartnerCustom7,MaterialTradePartnerCustom8,MaterialTradePartnerCustom9
--						   ,MaterialTradePartnerCustom10,MaterialTradePartnerCustom11,MaterialTradePartnerCustom12,MaterialTradePartnerCustom13,MaterialTradePartnerCustom14
--						   ,MaterialTradePartnerCustom15,MaterialTradePartnerCustom16,MaterialTradePartnerCustom17,MaterialTradePartnerCustom18
--						   ,MaterialTradePartnerCustom19,MaterialTradePartnerCustom20,MaterialTradePartnerCustom21,MaterialTradePartnerCustom22,MaterialTradePartnerCustom23
--						   ,MaterialTradePartnerCustom24,MaterialTradePartnerCustom25,CDate,CUser,MDate,MUser,MChange,MaterialRequestWorkflowTempID
--						   ,MaterialRequestWorkflowStartDate,MaterialRequestWorkflowDueDate, SeasonYearID)
--						SELECT DISTINCT @MaterialTradePartnerId AS MaterialTradePartnerId, MaterialId,TradepartnerId,TradepartnerVendorId,MaterialTradePartnerCustom1,MaterialTradePartnerCustom2
--						   ,MaterialTradePartnerCustom3,MaterialTradePartnerCustom4,MaterialTradePartnerCustom5
--						   ,MaterialTradePartnerCustom6,MaterialTradePartnerCustom7,MaterialTradePartnerCustom8,MaterialTradePartnerCustom9
--						   ,MaterialTradePartnerCustom10,MaterialTradePartnerCustom11,MaterialTradePartnerCustom12,MaterialTradePartnerCustom13,MaterialTradePartnerCustom14
--						   ,MaterialTradePartnerCustom15,MaterialTradePartnerCustom16,MaterialTradePartnerCustom17,MaterialTradePartnerCustom18
--						   ,MaterialTradePartnerCustom19,MaterialTradePartnerCustom20,MaterialTradePartnerCustom21,MaterialTradePartnerCustom22,MaterialTradePartnerCustom23
--						   ,MaterialTradePartnerCustom24,MaterialTradePartnerCustom25,@CreatedDate,@CreatedBy,@CreatedDate,@CreatedBy,MChange,MaterialRequestWorkflowTempID
--						   ,MaterialRequestWorkflowStartDate,MaterialRequestWorkflowDueDate, @SeasonYearID 
--						FROM pMaterialTradePartner WHERE MaterialID = @MaterialID AND SeasonYearID = @CopySeasonYearID AND TradePartnerVendorID = @TradePartnerVendorID
--					END
--				ELSE
--					BEGIN
--						SELECT DISTINCT @MaterialTradePartnerID = MaterialTradePartnerID 
--						FROM pMaterialTradePartner WITH (NOLOCK) 
--						WHERE MaterialID = @MaterialID AND SeasonYearID = @SeasonYearID AND TradePartnerVendorID = @TradePartnerVendorID
--					END

--
--				BEGIN		
--
--					CREATE TABLE #tempMaterialColorSeasonYear(	
--						RecID int IDENTITY(1,1)  NOT NULL,
--						MaterialColorID uniqueidentifier,
--						MaterialID uniqueidentifier,
--						SeasonYearID uniqueidentifier
--					)
--
--
--					BEGIN
--						INSERT INTO #tempMaterialColorSeasonYear(MaterialColorID, SeasonYearID, MaterialID) 
--						SELECT DISTINCT MaterialColorID, SeasonYearID, MaterialID 
--						FROM pMaterialColorSeasonYear WHERE MaterialID = @MaterialID AND SeasonYearID = @SeasonYearID
--					END
--
--		
--					BEGIN	
--					SET @Row_Color_Loop = 1
--					SET @Row_Color_Count = (SELECT COUNT(*) FROM #tempMaterialColorSeasonYear)
--																	
--						--IF @Colorway = 1
--						BEGIN
--							WHILE @Row_Color_Loop <= @Row_Color_Count				
--								BEGIN
--									SELECT @MaterialColorID = MaterialColorID FROM #tempMaterialColorSeasonYear WHERE RecID = @Row_Color_Loop
--										IF (SELECT COUNT(*) FROM pMaterialTradePartnerColor WITH (NOLOCK) WHERE MaterialID = @MaterialID AND 
--											MaterialTradePartnerID = @MaterialTradePartnerID AND MaterialColorID = @MaterialColorID) = 0
--										BEGIN
--
--											INSERT INTO pMaterialTradePartnerColor (MaterialTradePartnerColorID, MaterialTradePartnerID, 
--												  MaterialColorID, MaterialID, MaterialColorImageID, MaterialColorImageVersion, ColorFolderID, ColorPaletteID, 
--												  ColorID, ColorCode, ColorNo, ColorName, ColorSource, VendorColorCode, 
--												  VendorColorNo, VendorColorName, MaterialColorNote, ColorHex, Hex, R, G, 
--												  B, C, M, Y, K, H, S, L, LAB_L, LAB_A, LAB_B, ColorHexCode, CDate, CUser, 
--												  MDate, MUser, MaterialColorVersion, ColorVersion, Action, Sort, MaterialTradeColor1, MaterialTradeColor2, MaterialTradeColor3, 
--												  MaterialTradeColor4, MaterialTradeColor5, MaterialTradeColor6, MaterialTradeColor7, MaterialTradeColor8, MaterialTradeColor9, 
--												  MaterialTradeColor10, MaterialTradeColor11, MaterialTradeColor12, MaterialTradeColor13, MaterialTradeColor14, MaterialTradeColor15, 
--												  MaterialTradeColor16, MaterialTradeColor17, MaterialTradeColor18, MaterialTradeColor19, MaterialTradeColor20, MaterialTradeColor21, 
--												  MaterialTradeColor22, MaterialTradeColor23, MaterialTradeColor24, MaterialTradeColor25, MaterialSizeID, MaterialPrice, AgentView, Comments)
--											SELECT DISTINCT newid() AS MaterialTradePartnerColorID, @MaterialTradePartnerID AS MaterialTradePartnerId, 
--												  pMaterialTradePartnerColor.MaterialColorID, pMaterialTradePartnerColor.MaterialID, pMaterialTradePartnerColor.MaterialColorImageID, 
--												  pMaterialTradePartnerColor.MaterialColorImageVersion, pMaterialTradePartnerColor.ColorFolderID, pMaterialTradePartnerColor.ColorPaletteID, 
--												  pMaterialTradePartnerColor.ColorID, pMaterialTradePartnerColor.ColorCode, pMaterialTradePartnerColor.ColorNo, 
--												  pMaterialTradePartnerColor.ColorName, pMaterialTradePartnerColor.ColorSource, pMaterialTradePartnerColor.VendorColorCode, 
--												  pMaterialTradePartnerColor.VendorColorNo, pMaterialTradePartnerColor.VendorColorName, pMaterialTradePartnerColor.MaterialColorNote, 
--												  pMaterialTradePartnerColor.ColorHex, pMaterialTradePartnerColor.Hex, pMaterialTradePartnerColor.R, pMaterialTradePartnerColor.G, 
--												  pMaterialTradePartnerColor.B, pMaterialTradePartnerColor.C, pMaterialTradePartnerColor.M, pMaterialTradePartnerColor.Y, 
--												  pMaterialTradePartnerColor.K, pMaterialTradePartnerColor.H, pMaterialTradePartnerColor.S, pMaterialTradePartnerColor.L, 
--												  pMaterialTradePartnerColor.LAB_L, pMaterialTradePartnerColor.LAB_A, pMaterialTradePartnerColor.LAB_B, 
--												  pMaterialTradePartnerColor.ColorHexCode, getdate() AS CDate, pMaterialTradePartnerColor.CUser, 
--												  getdate() AS MDate, pMaterialTradePartnerColor.MUser, pMaterialTradePartnerColor.MaterialColorVersion, 
--												  pMaterialTradePartnerColor.ColorVersion, pMaterialTradePartnerColor.Action, pMaterialTradePartnerColor.Sort, 
--												  pMaterialTradePartnerColor.MaterialTradeColor1, pMaterialTradePartnerColor.MaterialTradeColor2, pMaterialTradePartnerColor.MaterialTradeColor3, 
--												  pMaterialTradePartnerColor.MaterialTradeColor4, pMaterialTradePartnerColor.MaterialTradeColor5, pMaterialTradePartnerColor.MaterialTradeColor6, 
--												  pMaterialTradePartnerColor.MaterialTradeColor7, pMaterialTradePartnerColor.MaterialTradeColor8, pMaterialTradePartnerColor.MaterialTradeColor9, 
--												  pMaterialTradePartnerColor.MaterialTradeColor10, pMaterialTradePartnerColor.MaterialTradeColor11, pMaterialTradePartnerColor.MaterialTradeColor12, 
--												  pMaterialTradePartnerColor.MaterialTradeColor13, pMaterialTradePartnerColor.MaterialTradeColor14, pMaterialTradePartnerColor.MaterialTradeColor15, 
--												  pMaterialTradePartnerColor.MaterialTradeColor16, pMaterialTradePartnerColor.MaterialTradeColor17, pMaterialTradePartnerColor.MaterialTradeColor18, 
--												  pMaterialTradePartnerColor.MaterialTradeColor19, pMaterialTradePartnerColor.MaterialTradeColor20, pMaterialTradePartnerColor.MaterialTradeColor21, 
--												  pMaterialTradePartnerColor.MaterialTradeColor22, pMaterialTradePartnerColor.MaterialTradeColor23, pMaterialTradePartnerColor.MaterialTradeColor24, 
--												  pMaterialTradePartnerColor.MaterialTradeColor25, pMaterialTradePartnerColor.MaterialSizeID, pMaterialTradePartnerColor.MaterialPrice, 
--												  pMaterialTradePartnerColor.AgentView, pMaterialTradePartnerColor.Comments
--											FROM  pMaterialTradePartnerColor INNER JOIN
--													pMaterialTradePartner ON pMaterialTradePartnerColor.MaterialTradePartnerID = pMaterialTradePartner.MaterialTradePartnerId
--											WHERE (pMaterialTradePartner.MaterialID = @MaterialID AND pMaterialTradePartner.SeasonYearID = @CopySeasonYearID AND 
--													pMaterialTradePartnerColor.MaterialColorID = @MaterialColorID)
--
--										END	
--										ELSE
--										BEGIN		
--												INSERT INTO pMaterialTradePartnerColor (MaterialTradePartnerColorID, MaterialTradePartnerID, 
--													MaterialColorID, MaterialID, ColorFolderID, ColorPaletteID, 
--													ColorID, ColorCode, ColorNo, ColorName, ColorSource, ColorHex, Hex, R, G, 
--													B, C, M, Y, K, H, S, L, LAB_L, LAB_A, LAB_B, ColorHexCode, CDate, CUser, 
--													MDate, MUser)
--												SELECT DISTINCT newid() AS MaterialTradePartnerColorID, @MaterialTradePartnerID AS MaterialTradePartnerId, 
--													pMaterialColor.MaterialColorID, @MaterialID, pMaterialColor.ColorFolderID, pMaterialColor.ColorPaletteID, 
--													pMaterialColor.ColorID, pMaterialColor.ColorCode, pMaterialColor.ColorNo, 
--													pMaterialColor.ColorName, pMaterialColor.ColorSource,  
--													pMaterialColor.ColorHex, pMaterialColor.Hex, pMaterialColor.R, pMaterialColor.G, 
--													pMaterialColor.B, pMaterialColor.C, pMaterialColor.M, pMaterialColor.Y, 
--													pMaterialColor.K, pMaterialColor.H, pMaterialColor.S, pMaterialColor.L, 
--													pMaterialColor.LAB_L, pMaterialColor.LAB_A, pMaterialColor.LAB_B, 
--													pMaterialColor.ColorHexCode, getdate() AS CDate, @CreatedBy, 
--													getdate() AS MDate, @CreatedBy
--												FROM  pMaterialColor WHERE MaterialColorID = @MaterialColorID --AND MaterialID = @MaterialID
--										END				
--									SET @Row_Color_Loop = @Row_Color_Loop + 1	
--
--								END					
--						END
--
--						DROP TABLE #tempMaterialColorSeasonYear
--
--
--					END	


--					DELETE FROM pMaterialTradePartnerColor WHERE (MaterialTradePartnerID = @MaterialTradePartnerID) AND
--						 (pMaterialTradePartnerColor.MaterialColorID NOT IN (SELECT MaterialColorID FROM pMaterialColorSeasonYear 
--								WHERE MaterialID = @MaterialID AND SeasonYearID = @SeasonYearID)) 

--
--					UPDATE pMaterialTradePartnerColor SET MaterialSizeID = '00000000-0000-0000-0000-000000000000'
--					WHERE MaterialSizeID IS NULL AND MaterialTradePartnerID = @MaterialTradePartnerID
--
--
--					WITH Cte AS 
--					( 
--					SELECT MaterialTradePartnerID, MaterialColorID, MaterialID, MaterialSizeID, ROW_NUMBER() Over (PARTITION BY MaterialTradePartnerID, MaterialColorID, MaterialID, MaterialSizeID ORDER BY MaterialTradePartnerID) as Seq 
--					FROM pMaterialTradePartnerColor WHERE MaterialTradePartnerID = @MaterialTradePartnerID
--					) 
--					DELETE FROM cte 
--					WHERE Seq > 1 
--										
--			END	
--
--		SET @Row_Loop = @Row_Loop + 1
--		END	
--
--	END
--ELSE
--	BEGIN
--
--		IF @ColorsSelected = 1
--			UPDATE pStyleMaterials SET 
--				  UOM = NULL
--				  ,Qty = NULL
--				  ,MaterialPrice = NULL
--				  ,Ext = NULL
--				  ,MaterialSize = NULL
--				  ,A = NULL
--				  ,B = NULL
--				  ,C = NULL
--				  ,D = NULL
--				  ,E = NULL
--				  ,F = NULL
--				  ,G = NULL
--				  ,H = NULL
--				  ,I = NULL
--				  ,J = NULL
--				  ,K = NULL
--				  ,L = NULL
--				  ,M = NULL
--				  ,N = NULL
--				  ,O = NULL
--				  ,P = NULL
--				  ,Q = NULL
--				  ,R = NULL
--				  ,S = NULL
--				  ,T = NULL
--				  ,U = NULL
--				  ,V = NULL
--				  ,W = NULL
--				  ,X = NULL
--				  ,Y = NULL
--				  ,Z = NULL
--				  ,Source = NULL
--				  ,Notes = NULL
--				  ,Placement = NULL
--				  ,VendorPrice = NULL
--				  ,VolumePrice = NULL
--				  ,VolumePriceMinimum = NULL
--				  ,VendorProductionMin = NULL
--				  ,VendorProductionLeadTime = NULL
--				  ,MaterialSizeID = NULL
--				  ,MaterialPackLabelGroupID = NULL
--				  ,TradePartnerID = NULL
--				  ,TradePartnerVendorID = NULL
--				  ,MaterialBOM = NULL
--				  ,MaterialCode = NULL
--				  --,Duty = NULL
--				  --,Freight = NULL
--				  --,TotalPrice = NULL
--			WHERE StyleID = @NewStyleID
--		ELSE
--			UPDATE pStyleMaterials SET MaterialBOM = NULL WHERE StyleID = @NewStyleID
--	END


BEGIN

	DROP TABLE #tempStyleMaterials
	DROP TABLE #tempCopyStyleMaterials
	DROP TABLE #tempStyleColorway
	DROP TABLE #tempCopyStyleColorway
	DROP TABLE #tempStyleColorwayItem
	DROP TABLE #tempCopyStyleColorwayItem
	DROP TABLE #tempStyleSeasonYear
	DROP TABLE #tempStyleColorwaySeasonYear

END











GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleDevelopmentItemCopy_INSERT]'
GO


ALTER PROCEDURE [dbo].[spx_StyleDevelopmentItemCopy_INSERT]
(@StyleDevelopmentID uniqueidentifier,
@StyleID uniqueidentifier,
@TempID nvarchar(50),
@TempNo nvarchar(50),
@StyleDevelopmentNo nvarchar(50),
@SizeRange nvarchar(50),
@CreatedBy nvarchar(200),
@CreatedDate datetime, 
@Variation int = 1 , 
@StyleDevelopmentName nvarchar (100) = NULL 
)
AS 

BEGIN

--  Replaced INSERT to get styledevelopmentItem from the temp table from runtime
--  DP 7/14/2009 
--	INSERT INTO pStyleDevelopmentItem
--		(StyleDevelopmentID, StyleID, SizeRange, Variation, CUser, CDate, MUser, MDate , StyleDevelopmentName )
--	VALUES  (@StyleDevelopmentID, @StyleID, @SizeRange, @Variation , @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate,  @StyleDevelopmentName)
 

	IF ( SELECT COUNT(*) FROM pStyleDevelopmentItemTemp WHERE NewStyleID = @StyleID ) = 0
	BEGIN

		INSERT INTO pStyleDevelopmentItem
			(StyleDevelopmentID, StyleID, SizeRange, Variation, CUser, CDate, MUser, MDate , StyleDevelopmentName )
		VALUES  (@StyleDevelopmentID, @StyleID, @SizeRange, @Variation , @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate,  @StyleDevelopmentName)

	END
	ELSE
	BEGIN

		INSERT INTO pStyleDevelopmentItem 
			(StyleDevelopmentID, StyleID, SizeRange, Variation, CUser, CDate, MUser, MDate, StyleDevelopmentName)
		SELECT @StyleDevelopmentID, @StyleID, @SizeRange, Variation , @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate, StyleDevelopmentName 
		FROM pStyleDevelopmentItemTemp WHERE NewStyleID = @StyleID

	END 



	UPDATE pStyleHeader SET
		DevelopmentId = @StyleDevelopmentId,
		DevelopmentNo = @StyleDevelopmentNo
	WHERE StyleId = @StyleId
	
END





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[uCountry]'
GO
ALTER TABLE [dbo].[uCountry] DROP
COLUMN [AirTran],
COLUMN [AirRate],
COLUMN [SeaTran],
COLUMN [SeaRate],
COLUMN [TruckTran],
COLUMN [Container40],
COLUMN [Container20],
COLUMN [ContainerLCL],
COLUMN [ContainerVolAir],
COLUMN [co_upload],
COLUMN [co_upduser],
COLUMN [co_upddate],
COLUMN [co_updtime]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[uCountry] ALTER COLUMN [Active] [int] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Rebuilding [dbo].[pStyleQuoteVariation]'
GO

CREATE TABLE [dbo].[tmp_rg_xx_pStyleQuoteVariation]
(
[StyleQuoteVariationID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_pStyleQuoteVariationID_StyleQuoteVariationID] DEFAULT (newid()),
[StyleQuoteID] [uniqueidentifier] NULL,
[StyleDevelopmentID] [uniqueidentifier] NULL,
[StyleID] [uniqueidentifier] NULL,
[TradePartnerID] [uniqueidentifier] NULL,
[TeamComment] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[PartnerComment] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[PdfFileId] [uniqueidentifier] NULL,
[PdfUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[PdfDate] [datetime] NULL,
[StyleQuoteTradePartnerID] [uniqueidentifier] NULL,
[StyleQuotaDutyID] [uniqueidentifier] NULL,
[StyleCostingID] [uniqueidentifier] NULL,
[StyleCostingType] [int] NULL,
[StyleCostingDate] [datetime] NULL,
[StyleCostingStatus] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingFreightTypeID] [int] NULL,
[StyleQuoteItemCustomField1] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField2] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField3] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField4] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField5] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField6] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField7] [uniqueidentifier] NULL,
[StyleQuoteItemCustomField8] [money] NULL,
[StyleQuoteItemCustomField9] [money] NULL,
[StyleQuoteItemCustomField10] [money] NULL,
[StyleQuoteItemCustomField11] [decimal] (18, 4) NULL,
[StyleQuoteItemCustomField12] [decimal] (18, 4) NULL,
[StyleQuoteItemCustomField13] [decimal] (18, 4) NULL,
[StyleQuoteItemCustomField14] [money] NULL,
[StyleQuoteItemCustomField15] [money] NULL,
[StyleQuoteItemCustomField16] [decimal] (18, 4) NULL,
[StyleQuoteItemCustomField17] [money] NULL,
[StyleQuoteItemCustomField18] [money] NULL,
[StyleQuoteItemCustomField19] [money] NULL,
[StyleQuoteItemCustomField20] [money] NULL,
[StyleQuoteItemCustomField21] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField22] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField23] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField24] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField25] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField1] [money] NULL,
[StyleCostingCustomField2] [money] NULL,
[StyleCostingCustomField3] [decimal] (18, 4) NULL,
[StyleCostingCustomField4] [int] NULL,
[StyleCostingCustomField5] [int] NULL,
[StyleCostingCustomField6] [decimal] (18, 3) NULL,
[StyleCostingCustomField7] [decimal] (18, 3) NULL,
[StyleCostingCustomField8] [decimal] (18, 3) NULL,
[StyleCostingCustomField9] [decimal] (18, 3) NULL,
[StyleCostingCustomField10] [decimal] (18, 3) NULL,
[StyleCostingCustomField11] [decimal] (18, 3) NULL,
[StyleCostingCustomField12] [decimal] (18, 3) NULL,
[StyleCostingCustomField13] [decimal] (18, 3) NULL,
[StyleCostingCustomField14] [decimal] (18, 3) NULL,
[StyleCostingCustomField15] [decimal] (18, 3) NULL,
[StyleCostingCustomField16] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField17] [datetime] NULL,
[StyleCostingCustomField18] [decimal] (18, 3) NULL,
[StyleCostingCustomField19] [decimal] (18, 3) NULL,
[StyleCostingCustomField20] [decimal] (18, 3) NULL,
[StyleCostingCustomField21] [decimal] (18, 3) NULL,
[StyleCostingCustomField22] [decimal] (18, 3) NULL,
[StyleCostingCustomField23] [decimal] (18, 3) NULL,
[StyleCostingCustomField24] [decimal] (18, 3) NULL,
[StyleCostingCustomField25] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField26] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField27] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField28] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField29] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField30] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField31] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField32] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField33] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField34] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField35] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[StyleQuoteItemCustomField26] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField27] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField28] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField29] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField30] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO


UPDATE [dbo].[pStyleQuoteVariation]
  set [StyleCostingCustomField20] = NULl
WHERE isnumeric([StyleCostingCustomField20]) = 0
GO

IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO

INSERT INTO [dbo].[tmp_rg_xx_pStyleQuoteVariation]([StyleQuoteVariationID], [StyleQuoteID], [StyleDevelopmentID], [StyleID], [TradePartnerID], [TeamComment], [PartnerComment], [PdfFileId], [PdfUser], [PdfDate], [StyleQuoteTradePartnerID], [StyleQuotaDutyID], [StyleCostingID], [StyleCostingType], [StyleCostingDate], [StyleCostingStatus], [StyleCostingFreightTypeID], [StyleQuoteItemCustomField1], [StyleQuoteItemCustomField2], [StyleQuoteItemCustomField3], [StyleQuoteItemCustomField4], [StyleQuoteItemCustomField5], [StyleQuoteItemCustomField6], [StyleQuoteItemCustomField7], [StyleQuoteItemCustomField8], [StyleQuoteItemCustomField9], [StyleQuoteItemCustomField10], [StyleQuoteItemCustomField11], [StyleQuoteItemCustomField12], [StyleQuoteItemCustomField13], [StyleQuoteItemCustomField14], [StyleQuoteItemCustomField15], [StyleQuoteItemCustomField16], [StyleQuoteItemCustomField17], [StyleQuoteItemCustomField18], [StyleQuoteItemCustomField19], [StyleQuoteItemCustomField20], [StyleQuoteItemCustomField21], [StyleQuoteItemCustomField22], [StyleQuoteItemCustomField23], [StyleQuoteItemCustomField24], [StyleQuoteItemCustomField25], [StyleCostingCustomField1], [StyleCostingCustomField2], [StyleCostingCustomField3], [StyleCostingCustomField4], [StyleCostingCustomField5], [StyleCostingCustomField6], [StyleCostingCustomField7], [StyleCostingCustomField8], [StyleCostingCustomField9], [StyleCostingCustomField10], [StyleCostingCustomField11], [StyleCostingCustomField12], [StyleCostingCustomField13], [StyleCostingCustomField14], [StyleCostingCustomField15], [StyleCostingCustomField16], [StyleCostingCustomField17], [StyleCostingCustomField18], [StyleCostingCustomField19], [StyleCostingCustomField20], [StyleCostingCustomField21], [StyleCostingCustomField22], [StyleCostingCustomField23], [StyleCostingCustomField24], [StyleCostingCustomField25], [StyleCostingCustomField26], [StyleCostingCustomField27], [StyleCostingCustomField28], [StyleCostingCustomField29], [StyleCostingCustomField30], [StyleCostingCustomField31], [StyleCostingCustomField32], [StyleCostingCustomField33], [StyleCostingCustomField34], [StyleCostingCustomField35], [CUser], [CDate], [MUser], [MDate], [StyleQuoteItemCustomField26], [StyleQuoteItemCustomField27], [StyleQuoteItemCustomField28], [StyleQuoteItemCustomField29], [StyleQuoteItemCustomField30]) SELECT [StyleQuoteVariationID], [StyleQuoteID], [StyleDevelopmentID], [StyleID], [TradePartnerID], [TeamComment], [PartnerComment], [PdfFileId], [PdfUser], [PdfDate], [StyleQuoteTradePartnerID], [StyleQuotaDutyID], [StyleCostingID], [StyleCostingType], [StyleCostingDate], [StyleCostingStatus], [StyleCostingFreightTypeID], CAST([StyleQuoteItemCustomField1] AS [nvarchar] (200)) COLLATE SQL_Latin1_General_CP1_CI_AS, CAST([StyleQuoteItemCustomField2] AS [nvarchar] (200)) COLLATE SQL_Latin1_General_CP1_CI_AS, [StyleQuoteItemCustomField3], [StyleQuoteItemCustomField4], [StyleQuoteItemCustomField5], [StyleQuoteItemCustomField6], [StyleQuoteItemCustomField7], CAST([StyleQuoteItemCustomField8] AS [money]), CAST([StyleQuoteItemCustomField9] AS [money]), CAST([StyleQuoteItemCustomField10] AS [money]), [StyleQuoteItemCustomField11], [StyleQuoteItemCustomField12], [StyleQuoteItemCustomField13], CAST([StyleQuoteItemCustomField14] AS [money]), CAST([StyleQuoteItemCustomField15] AS [money]), [StyleQuoteItemCustomField16], CAST([StyleQuoteItemCustomField17] AS [money]), CAST([StyleQuoteItemCustomField18] AS [money]), CAST([StyleQuoteItemCustomField19] AS [money]), CAST([StyleQuoteItemCustomField20] AS [money]), [StyleQuoteItemCustomField21], [StyleQuoteItemCustomField22], [StyleQuoteItemCustomField23], [StyleQuoteItemCustomField24], [StyleQuoteItemCustomField25], [StyleCostingCustomField1], [StyleCostingCustomField2], CAST([StyleCostingCustomField3] AS [decimal] (18, 4)), [StyleCostingCustomField4], [StyleCostingCustomField5], [StyleCostingCustomField6], [StyleCostingCustomField7], CAST([StyleCostingCustomField8] AS [decimal] (18, 3)), [StyleCostingCustomField9], [StyleCostingCustomField10], [StyleCostingCustomField11], [StyleCostingCustomField12], [StyleCostingCustomField13], [StyleCostingCustomField14], [StyleCostingCustomField15], [StyleCostingCustomField16], [StyleCostingCustomField17], CAST([StyleCostingCustomField18] AS [decimal] (18, 3)), [StyleCostingCustomField19], [StyleCostingCustomField20], [StyleCostingCustomField21], [StyleCostingCustomField22], [StyleCostingCustomField23], [StyleCostingCustomField24], [StyleCostingCustomField25], [StyleCostingCustomField26], [StyleCostingCustomField27], [StyleCostingCustomField28], [StyleCostingCustomField29], [StyleCostingCustomField30], [StyleCostingCustomField31], [StyleCostingCustomField32], [StyleCostingCustomField33], [StyleCostingCustomField34], [StyleCostingCustomField35], [CUser], [CDate], [MUser], [MDate], [StyleQuoteItemCustomField26], [StyleQuoteItemCustomField27], [StyleQuoteItemCustomField28], [StyleQuoteItemCustomField29], [StyleQuoteItemCustomField30] FROM [dbo].[pStyleQuoteVariation]
GO

IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO

IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
DROP TABLE [dbo].[pStyleQuoteVariation]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_rename N'[dbo].[tmp_rg_xx_pStyleQuoteVariation]', N'pStyleQuoteVariation'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pStyleType]'
GO
ALTER TABLE [dbo].[pStyleType] ADD
[SampleSearchSchema] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleNonApparel] [int] NULL CONSTRAINT [DF_pStyleType_StyleNonApparel] DEFAULT ((0)),
[LineListSearchSchema] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pLinePlanColorItemTemp]'
GO
CREATE TABLE [dbo].[pLinePlanColorItemTemp]
(
[LinePlanColorItemTempID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_pLinePlanColorItemTemp_LinePlanColorItemTempID] DEFAULT (newid()),
[LinePlanColorItemID] [uniqueidentifier] NULL,
[LinePlanColorGroupID] [uniqueidentifier] NULL,
[LinePlanColorID] [uniqueidentifier] NULL,
[LinePlanRangeID] [uniqueidentifier] NULL,
[LinePlanID] [uniqueidentifier] NULL,
[ColorPaletteID] [uniqueidentifier] NULL,
[ColorFolderID] [uniqueidentifier] NULL,
[ColorID] [uniqueidentifier] NULL,
[ColorCode] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ColorName] [nvarchar] (150) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ColorImage] [int] NULL CONSTRAINT [DF_pLinePlanColorItemTemp_ColorImage] DEFAULT ((0)),
[ColorImageType] [varchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ColorSource] [nvarchar] (150) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ColorNotes] [ntext] COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Hex] [nvarchar] (10) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[Change] [int] NOT NULL CONSTRAINT [DF_pLinePlanColorItemTemp_Change] DEFAULT ((1)),
[Active] [int] NOT NULL CONSTRAINT [DF_pLinePlanColorItemTemp_Active] DEFAULT ((1)),
[Sort] [varchar] (10) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pLinePlanColorItemTemp] on [dbo].[pLinePlanColorItemTemp]'
GO
ALTER TABLE [dbo].[pLinePlanColorItemTemp] ADD CONSTRAINT [PK_pLinePlanColorItemTemp] PRIMARY KEY CLUSTERED  ([LinePlanColorItemTempID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanMultiClothColorTemp_SELECT]'
GO


CREATE PROCEDURE [dbo].[spx_LinePlanMultiClothColorTemp_SELECT](
@LinePlanColorGroupID UNIQUEIDENTIFIER
)
AS

SELECT pColorPalette.ColorPaletteID, pColorPalette.ColorFolderID, pColorPalette.ColorCode, pColorPalette.ColorName, pColorPalette.ColorSource, pColorPalette.ColorNotes, 
      pColorPalette.Hex, pColorPalette.R, pColorPalette.G, pColorPalette.B, pColorPalette.C, pColorPalette.M, pColorPalette.Y, pColorPalette.K, pColorPalette.H, 
      pColorPalette.S, pColorPalette.L, pColorPalette.LAB_L, pColorPalette.LAB_A, pColorPalette.LAB_B, pColorPalette.CUser, pColorPalette.CDate, pColorPalette.MUser, 
      pColorPalette.MDate, pColorPalette.ColorID, pColorPalette.Change, pColorPalette.Action, pColorPalette.Active, pColorPalette.Sort, pColorPalette.ColorImage, 
      pColorPalette.ColorImageType, pColorPalette.CopyColorPaletteID, pLinePlanColorItemTemp.LinePlanID, pLinePlanColorItemTemp.LinePlanColorItemID, 
      pLinePlanColorItemTemp.LinePlanColorID, pLinePlanColorItemTemp.LinePlanRangeID, pLinePlanColorItemTemp.LinePlanColorGroupID,
		'<img src="../System/Control/ColorStream.ashx?S=20&CFID=' + CAST(pColorPalette.ColorFolderID AS NVARCHAR(50)) -- #01
		+ '&CPID=' + CAST(pColorPalette.ColorPaletteID AS NVARCHAR(50)) +  '" border="0" />'     -- #01
		AS ColorUrl,	-- #01
	  0 AS StyleColorDelivery1,
	  0 AS StyleColorDelivery2,
	  0 AS StyleColorDelivery3,
	  1 AS StyleColorDelivery4,
	  0 as Units

FROM  pColorPalette INNER JOIN
      pLinePlanColorItemTemp ON pColorPalette.ColorPaletteID = pLinePlanColorItemTemp.ColorPaletteID
WHERE pLinePlanColorItemTemp.LinePlanColorGroupID = @LinePlanColorGroupID
ORDER BY pColorPalette.ColorName







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleRequestSpecAdHoc_SELECT]'
GO

/*
Comment #01 - Oct 21 2009 - Ryan Cabanas
 Modified Select to grab MAX value instead of COUNT because if you deleted a lower level adhoc POM it would not add the next POM properly.
*/


ALTER PROCEDURE [dbo].[spx_SampleRequestSpecAdHoc_SELECT]
(
	@SampleRequestWorkflowID uniqueidentifier,
	@SampleRequestTradeID uniqueidentifier,	
	@StyleID uniqueidentifier,
	@StyleSet int,
	@Submit int,
	@PomCodeDefault varchar(5)
)
AS 



SELECT MAX(RIGHT(POM, 2)) --#01
FROM  pSampleRequestSpecItem WITH (NOLOCK)
WHERE     
((SampleRequestWorkflowID = @SampleRequestWorkflowID) AND 
(SampleRequestTradeID = @SampleRequestTradeID) AND 
(StyleID = @StyleID) AND 
(StyleSet = @StyleSet) AND
(Submit = @Submit)) AND 
(POM LIKE @PomCodeDefault + '%')



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlan_BodyItem_DELETE]'
GO
CREATE PROCEDURE dbo.spx_LinePlan_BodyItem_DELETE (
@LinePlanBodyItemID UNIQUEIDENTIFIER 
)
AS 


	DELETE FROM pLinePlanBodyItem WHERE LinePlanBodyItemID = @LinePlanBodyItemID




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_SampleRequestQASizeDataSet_SELECT]'
GO


CREATE PROCEDURE [dbo].[spx_SampleRequestQASizeDataSet_SELECT]
(
	@SampleRequestWorkflowID uniqueidentifier,
	@SampleRequestTradeID uniqueidentifier,
	@StyleID uniqueidentifier
)
AS 

BEGIN
	SELECT * FROM ( 
	SELECT 0 AS 'ID', Size0 AS 'Size', Sel0 AS Sel, Col0 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Size0 <> '' AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 1 AS 'ID', Size1 AS 'Size', Sel1 AS Sel, Col1 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Size1 <> '' AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 2 AS 'ID', Size2 AS 'Size', Sel2 AS Sel, Col2 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Size2 <> '' AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 3 AS 'ID', Size3 AS 'Size', Sel3 AS Sel, Col3 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Size3 <> '' AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 4 AS 'ID', Size4 AS 'Size', Sel4 AS Sel, Col4 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Size4 <> '' AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION 
	SELECT 5 AS 'ID', Size5 AS 'Size', Sel5 AS Sel, Col5 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Size5 <> '' AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 6 AS 'ID', Size6 AS 'Size', Sel6 AS Sel, Col6 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Size6 <> '' AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 7 AS 'ID', Size7 AS 'Size', Sel7 AS Sel, Col7 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Size7 <> '' AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 8 AS 'ID', Size8 AS 'Size', Sel8 AS Sel, Col8 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Size8 <> '' AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 9 AS 'ID', Size9 AS 'Size', Sel9 AS Sel, Col9 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Size9 <> '' AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 10 AS 'ID', Size10 AS 'Size', Sel10 AS Sel, Col10 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Size10 <> '' AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 11 AS 'ID', Size11 AS 'Size', Sel11 AS Sel, Col11 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Size11 <> '' AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 12 AS 'ID', Size12 AS 'Size', Sel12 AS Sel, Col12 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Size12 <> '' AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 13 AS 'ID', Size13 AS 'Size', Sel13 AS Sel, Col13 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Size13 <> '' AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 14 AS 'ID', Size14 AS 'Size', Sel14 AS Sel, Col14 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Size14 <> '' AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION 
	SELECT 15 AS 'ID', Size15 AS 'Size', Sel15 AS Sel, Col15 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Size15 <> '' AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 16 AS 'ID', Size16 AS 'Size', Sel16 AS Sel, Col16 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Size16 <> '' AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 17 AS 'ID', Size17 AS 'Size', Sel17 AS Sel, Col17 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Size17 <> '' AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 18 AS 'ID', Size18 AS 'Size', Sel18 AS Sel, Col18 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Size18 <> '' AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 19 AS 'ID', Size19 AS 'Size', Sel19 AS Sel, Col19 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Size19 <> '' AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	) AS tmpSampleRequestQASize 
	WHERE LEN (ID) > 0
END

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleColorwayItem_FIX]'
GO
ALTER PROCEDURE [dbo].[spx_StyleColorwayItem_FIX]
(
@StyleId uniqueidentifier,
@StyleSet int
)
AS 

DELETE FROM pStyleColorwayItem
WHERE (StyleId = @StyleId AND StyleSet = @StyleSet) AND (StyleMaterialID NOT IN
 (SELECT StyleMaterialId FROM pStyleMaterials WITH (NOLOCK) WHERE  StyleId = @StyleId AND StyleSet = @StyleSet))

DELETE FROM pStyleColorwayItem
WHERE (StyleId = @StyleId AND StyleSet = @StyleSet) AND (StyleMaterialID IN
 (SELECT StyleMaterialId FROM pStyleMaterials WITH (NOLOCK) WHERE  StyleId = @StyleId AND StyleSet = @StyleSet AND Colorway <> 1 ))


CREATE TABLE #tempStyleColorway( 
	RecID			int IDENTITY(1,1)  NOT NULL,
	StyleColorID 	 	uniqueidentifier,
	StyleID 		uniqueidentifier,
	StyleSet 		int NULL 
) ON [PRIMARY]

DECLARE @RowStyleLoop 		int
DECLARE @RowStyleCount 		int
DECLARE @tmpStyleColorID	uniqueidentifier

BEGIN
	INSERT INTO #tempStyleColorway (StyleColorID, StyleID, StyleSet)
	SELECT StyleColorID, StyleID, StyleSet FROM pStyleColorway WITH (NOLOCK)
	WHERE StyleId = @StyleId AND StyleSet = 1
END

--SELECT * FROM #tempStyleColorway

SET @RowStyleLoop = 1
SET @RowStyleCount = (SELECT COUNT(*) FROM #tempStyleColorway)

WHILE @RowStyleLoop <= @RowStyleCount 

	BEGIN

		SELECT @tmpStyleColorID = StyleColorID FROM #tempStyleColorway WHERE RecID = @RowStyleLoop

			BEGIN	
			INSERT INTO pStyleColorwayItem (StyleColorId, StyleId, StyleSet, StyleMaterialId, MaterialId)
			SELECT @tmpStyleColorID, StyleId, StyleSet, StyleMaterialId, MaterialId FROM pStyleMaterials WITH (NOLOCK) WHERE (StyleId = @StyleId AND StyleSet = @StyleSet AND Colorway = 1 ) 
			AND (StyleMaterialID NOT IN (SELECT StyleMaterialID FROM pStyleColorwayItem WITH (NOLOCK) WHERE StyleColorID = @tmpStyleColorID AND StyleId = @StyleId AND StyleSet = @StyleSet))
			END	

		SET @RowStyleLoop = @RowStyleLoop + 1

	END

DROP TABLE #tempStyleColorway



















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialRequestContent_INSERT]'
GO


CREATE  PROCEDURE [dbo].[spx_MaterialRequestContent_INSERT]
(
	@MaterialTradePartnerId uniqueidentifier,
	@MaterialID uniqueidentifier, 
	@MaterialContentCode nvarchar(5),
	@MaterialContentPerc decimal(18,0),
	@MUser nvarchar(200),
	@MDate datetime
)
AS 


DECLARE @MaterialContentName nvarchar(200)
DECLARE @MaterialContentId uniqueidentifier

SET @MaterialContentId  = NEWID()
SELECT @MaterialContentName = Custom FROM pMaterialContentType WHERE CustomKey = @MaterialContentCode


INSERT INTO pMaterialRequestContent(MaterialContentId, MaterialID, MaterialTradePartnerId, MaterialContentCode, MaterialContentPerc, MaterialContentName, MUser, MDate  ) 
VALUES ( @MaterialContentId, @MaterialID, @MaterialTradePartnerId, @MaterialContentCode, @MaterialContentPerc, @MaterialContentName, @MUser, @MDate  ) 






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_ImageCatalogItem_INSERT]'
GO
ALTER PROCEDURE [dbo].[spx_ImageCatalogItem_INSERT]
(
@ImageCatalogItemID uniqueidentifier,
@ImageCatalogID uniqueidentifier,
@ImageID uniqueidentifier,
@ImageVersion int,
@UserName nvarchar(100),
@UserDate datetime
)
AS 

DECLARE @Version1 INT  
DECLARE @Version2 INT  


SELECT @Version1 = a.Version  FROM pImage  a  where a.ImageID = @ImageID
SELECT @Version2 =MAX(Version) FROM hImage  where ImageID = @ImageID

IF @Version2 = @Version1
      SET @ImageVersion  = @Version1
ELSE
      SET @ImageVersion = 1 


IF (SELECT COUNT(*)  FROM pImageCatalogItem WHERE ImageID = @ImageID AND ImageCatalogID = @ImageCatalogID )  = 0
BEGIN
      INSERT INTO dbo.pImageCatalogItem
      (ImageCatalogID, ImageID, ImageVersion, CUser, CDate, MUser, MDate)
      VALUES     (@ImageCatalogID, @ImageID, @ImageVersion, @UserName, @UserDate, @UserName, @UserDate)
END

BEGIN
      INSERT INTO dbo.pImageCatalogItemStatus   (ImageCatalogID, ImageCatalogStatus, TeamID, ImageCatalogItemID, ImageID)
      SELECT dbo.pImageCatalogTeam.ImageCatalogID, 'In Preparation' AS ImageCatalogStatus, dbo.pImageCatalogTeam.TeamID, 
      dbo.pImageCatalogItem.ImageCatalogItemID, dbo.pImageCatalogItem.ImageID
      FROM dbo.pImageCatalogTeam INNER JOIN
      dbo.pImageCatalogItem ON dbo.pImageCatalogTeam.ImageCatalogID = dbo.pImageCatalogItem.ImageCatalogID
      WHERE dbo.pImageCatalogItem.ImageID = @ImageID AND dbo.pImageCatalogTeam.ImageCatalogID = @ImageCatalogID
END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleHeaderMainMaterial_REMOVE]'
GO
CREATE PROCEDURE [dbo].[spx_StyleHeaderMainMaterial_REMOVE]
(
	@StyleMaterialID uniqueidentifier
	,@StyleID uniqueidentifier
	,@StyleSet int
	,@MUser nvarchar(200)
	,@MDate datetime
)
AS 

BEGIN
	UPDATE dbo.pStyleHeader
		SET  MaterialID = '00000000-0000-0000-0000-000000000000', 
		MaterialImageID = '00000000-0000-0000-0000-000000000000', 
		MaterialImageVersion = 0, 
		MaterialNo = '00000000-0000-0000-0000-000000000000', 
		MaterialName = '', 
		StyleMaterialID = '00000000-0000-0000-0000-000000000000'
	WHERE  (StyleID = @StyleId)
END	







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanMultiClothMaterialTemp_SELECT]'
GO


CREATE PROCEDURE [dbo].[spx_LinePlanMultiClothMaterialTemp_SELECT](
@LinePlanColorGroupID UNIQUEIDENTIFIER
)
AS

SELECT  pMaterial.MaterialID, pMaterial.MaterialImageID, pMaterial.MaterialImageVersion, pMaterial.MaterialImageDetailID, 
      pMaterial.MaterialImageDetailVersion, pMaterial.MaterialType, pMaterial.MaterialNo, pMaterial.MaterialName, pMaterial.A, 
      pMaterial.B, pMaterial.C, pMaterial.D, pMaterial.E, pMaterial.F, pMaterial.G, pMaterial.H, pMaterial.I, 
      pMaterial.J, pMaterial.K, pMaterial.L, pMaterial.M, pMaterial.N, pMaterial.O, pMaterial.P, pMaterial.Q, 
      pMaterial.R, pMaterial.S, pMaterial.T, pMaterial.U, pMaterial.V, pMaterial.W, pMaterial.X, pMaterial.Y, 
      pMaterial.Z, pMaterial.MaterialPlacement, pLinePlanMaterialItemTemp.LinePlanMaterialItemID, pLinePlanMaterialItemTemp.LinePlanID, pLinePlanMaterialItemTemp.LinePlanColorGroupID, 
      pLinePlanMaterialItemTemp.LinePlanRangeID, pLinePlanMaterialItemTemp.CUser, pLinePlanMaterialItemTemp.CDate, pLinePlanMaterialItemTemp.MUser, 
      pLinePlanMaterialItemTemp.MDate, pMaterial.MaterialCode
FROM   pMaterial INNER JOIN
      pLinePlanMaterialItemTemp ON pMaterial.MaterialID = pLinePlanMaterialItemTemp.MaterialID
WHERE pLinePlanMaterialItemTemp.LinePlanColorGroupID = @LinePlanColorGroupID
ORDER BY pMaterial.MaterialNo







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_SampleRequestQASizeDropDown_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_SampleRequestQASizeDropDown_SELECT]
(
	@SampleRequestWorkflowID uniqueidentifier,
	@SampleRequestTradeID uniqueidentifier,
	@StyleID uniqueidentifier
)
AS 

BEGIN
	SELECT * FROM ( 
	SELECT 0 AS 'ID', Size0 AS 'Size', Sel0 AS Sel, Col0 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel0 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 1 AS 'ID', Size1 AS 'Size', Sel1 AS Sel, Col1 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel1 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 2 AS 'ID', Size2 AS 'Size', Sel2 AS Sel, Col2 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel2 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 3 AS 'ID', Size3 AS 'Size', Sel3 AS Sel, Col3 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel3 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 4 AS 'ID', Size4 AS 'Size', Sel4 AS Sel, Col4 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel4 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION 
	SELECT 5 AS 'ID', Size5 AS 'Size', Sel5 AS Sel, Col5 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel5 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 6 AS 'ID', Size6 AS 'Size', Sel6 AS Sel, Col6 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel6 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 7 AS 'ID', Size7 AS 'Size', Sel7 AS Sel, Col7 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel7 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 8 AS 'ID', Size8 AS 'Size', Sel8 AS Sel, Col8 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel8 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 9 AS 'ID', Size9 AS 'Size', Sel9 AS Sel, Col9 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel9 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 10 AS 'ID', Size10 AS 'Size', Sel10 AS Sel, Col10 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel10 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 11 AS 'ID', Size11 AS 'Size', Sel11 AS Sel, Col11 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel11 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 12 AS 'ID', Size12 AS 'Size', Sel12 AS Sel, Col12 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel12 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 13 AS 'ID', Size13 AS 'Size', Sel13 AS Sel, Col13 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel13 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 14 AS 'ID', Size14 AS 'Size', Sel14 AS Sel, Col14 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel14 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION 
	SELECT 15 AS 'ID', Size15 AS 'Size', Sel15 AS Sel, Col15 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel15 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 16 AS 'ID', Size16 AS 'Size', Sel16 AS Sel, Col16 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel16 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 17 AS 'ID', Size17 AS 'Size', Sel17 AS Sel, Col17 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel17 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 18 AS 'ID', Size18 AS 'Size', Sel18 AS Sel, Col18 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel18 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 19 AS 'ID', Size19 AS 'Size', Sel19 AS Sel, Col19 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel19 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	) AS tmpSampleRequestQASize 
	WHERE LEN (ID) > 0
END

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialRequestContent_SELECT]'
GO


CREATE PROCEDURE [dbo].[spx_MaterialRequestContent_SELECT]
(
@MaterialTradePartnerID uniqueidentifier,
@MaterialID uniqueidentifier
)
AS 


SELECT MaterialContentId, MaterialTradePartnerID, MaterialId, MaterialContentCode, 
	MaterialContentPerc, MaterialContentName, CDate, CUser, MDate, MUser 
FROM pMaterialRequestContent 
WHERE MaterialTradePartnerID = @MaterialTradePartnerID 
	AND MaterialId = @MaterialID 
ORDER BY MaterialContentPerc DESC


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleCostingCopy_INSERT]'
GO



ALTER  PROCEDURE [dbo].[spx_StyleCostingCopy_INSERT]
(
@StyleID uniqueidentifier,
@NewStyleID uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS 

BEGIN
INSERT INTO dbo.pStyleCostingHeader
                      (StyleID, StyleCostingTypeID, StyleQuotaDutyID, StyleCostingDate, StyleCostingStatus, StyleCostingCustomField1, StyleCostingCustomField2, 
                      StyleCostingCustomField3, StyleCostingCustomField4, StyleCostingCustomField5, StyleCostingCustomField6, StyleCostingCustomField7, 
                      StyleCostingCustomField8, StyleCostingCustomField9, StyleCostingCustomField10, StyleCostingCustomField11, StyleCostingCustomField12, 
                      StyleCostingCustomField13, StyleCostingCustomField14, StyleCostingCustomField15, StyleCostingCustomField16, StyleCostingCustomField17, 
                      StyleCostingCustomField18, StyleCostingCustomField19, StyleCostingCustomField20, StyleCostingCustomField21, StyleCostingCustomField22, 
                      StyleCostingCustomField23, StyleCostingCustomField24, StyleCostingCustomField25, StyleCostingCustomField26, StyleCostingCustomField27, 
                      StyleCostingCustomField28, StyleCostingCustomField29, StyleCostingCustomField30, CUser, CDate, MUser, MDate, Active)
SELECT     @NewStyleID AS StyleId, StyleCostingTypeID, StyleQuotaDutyID, StyleCostingDate, StyleCostingStatus, StyleCostingCustomField1, 
                      StyleCostingCustomField2, StyleCostingCustomField3, StyleCostingCustomField4, StyleCostingCustomField5, StyleCostingCustomField6, 
                      StyleCostingCustomField7, StyleCostingCustomField8, StyleCostingCustomField9, StyleCostingCustomField10, StyleCostingCustomField11, 
                      StyleCostingCustomField12, StyleCostingCustomField13, StyleCostingCustomField14, StyleCostingCustomField15, StyleCostingCustomField16, 
                      StyleCostingCustomField17, StyleCostingCustomField18, StyleCostingCustomField19, StyleCostingCustomField20, StyleCostingCustomField21, 
                      StyleCostingCustomField22, StyleCostingCustomField23, StyleCostingCustomField24, StyleCostingCustomField25, StyleCostingCustomField26, 
                      StyleCostingCustomField27, StyleCostingCustomField28, StyleCostingCustomField29, StyleCostingCustomField30, @CreatedBy AS CreatedBy, 
                      @CreatedDate AS CreatedDate, @CreatedBy AS CreatedBy, @CreatedDate AS CreatedDate, Active
FROM         dbo.pStyleCostingHeader WITH (NOLOCK)
WHERE StyleId = @StyleId
END

BEGIN
INSERT INTO dbo.pStyleCosting
                      (StyleID, StyleCostingTypeID, StyleCostingFreightTypeID, StyleQuotaDutyID, StyleCostingDate, StyleCostingStatus, StyleCostingCustomField1, 
                      StyleCostingCustomField2, StyleCostingCustomField3, StyleCostingCustomField4, StyleCostingCustomField5, StyleCostingCustomField6, 
                      StyleCostingCustomField7, StyleCostingCustomField8, StyleCostingCustomField9, StyleCostingCustomField10, StyleCostingCustomField11, 
                      StyleCostingCustomField12, StyleCostingCustomField13, StyleCostingCustomField14, StyleCostingCustomField15, StyleCostingCustomField16, 
                      StyleCostingCustomField17, StyleCostingCustomField18, StyleCostingCustomField19, StyleCostingCustomField20, StyleCostingCustomField21, 
                      StyleCostingCustomField22, StyleCostingCustomField23, StyleCostingCustomField24, StyleCostingCustomField25, StyleCostingCustomField26, 
                      StyleCostingCustomField27, StyleCostingCustomField28, StyleCostingCustomField29, StyleCostingCustomField30, StyleCostingCustomField31, 
                      StyleCostingCustomField32, StyleCostingCustomField33, StyleCostingCustomField34, StyleCostingCustomField35, CUser, CDate, MUser, MDate, 
                      Active)
SELECT     @NewStyleID AS StyleId, StyleCostingTypeID, StyleCostingFreightTypeID, StyleQuotaDutyID, StyleCostingDate, StyleCostingStatus, 
                      StyleCostingCustomField1, StyleCostingCustomField2, StyleCostingCustomField3, StyleCostingCustomField4, StyleCostingCustomField5, 
                      StyleCostingCustomField6, StyleCostingCustomField7, StyleCostingCustomField8, StyleCostingCustomField9, StyleCostingCustomField10, 
                      StyleCostingCustomField11, StyleCostingCustomField12, StyleCostingCustomField13, StyleCostingCustomField14, StyleCostingCustomField15, 
                      StyleCostingCustomField16, StyleCostingCustomField17, StyleCostingCustomField18, StyleCostingCustomField19, StyleCostingCustomField20, 
                      StyleCostingCustomField21, StyleCostingCustomField22, StyleCostingCustomField23, StyleCostingCustomField24, StyleCostingCustomField25, 
                      StyleCostingCustomField26, StyleCostingCustomField27, StyleCostingCustomField28, StyleCostingCustomField29, StyleCostingCustomField30, 
                      StyleCostingCustomField31, StyleCostingCustomField32, StyleCostingCustomField33, StyleCostingCustomField34, StyleCostingCustomField35, 
                      @CreatedBy AS Cuser, @CreatedDate AS Cdate, @CreatedBy AS Muser, @CreatedDate AS Mdate, 1
FROM         dbo.pStyleCosting WITH (NOLOCK)
WHERE StyleId = @StyleId
END






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleWorkflowScheaduleCopy_UPDATE]'
GO


/*
Comments:

#01 - Ryan Cabanas - November 2, 2009
	Due Dates of Style Workflow were all accidentally being set to the same date.
Need to limit the update to only the new StyleID.

#02 - Ryan Cabanas - November 3, 2009
	Updated the UPDATE to include the 'CUser' and 'CDate' information.
*/


ALTER PROCEDURE [dbo].[spx_StyleWorkflowScheaduleCopy_UPDATE] (
@StyleId uniqueidentifier, 
@NewStyleId  uniqueidentifier ,
@CreatedBy nvarchar ( 200 )  , 
@CreatedDate   datetime 
)

AS 


DECLARE @WorkflowTemplateId   UNIQUEIDENTIFIER 
DECLARE @WorkDay int 
DECLARE  @DueDate datetime 

SELECT @WorkflowTemplateId  = WorkflowTemplateId   FROM pStyleWorkflowSchedule WITH (NOLOCK) WHERE StyleId = @StyleID
SELECT @DueDate = DueDate  FROM pStyleHeader WITH (NOLOCK) where StyleId = @NewStyleId  
 

INSERT INTO pStyleWorkflowSchedule (StyleId, WorkflowTemplateId , StyleStartDate, StyleEndDate, StyleDueDate, CDate, CUser)
SELECT @NewStyleId  AS StyleId, WorkflowTemplateId , StyleStartDate, StyleEndDate, StyleDueDate,  @CreatedDate  , @CreatedBy 
FROM  pStyleWorkflowSchedule WITH (NOLOCK)  WHERE StyleId = @StyleID

UPDATE pStyleHeader SET StyleWorkflowId  =  @WorkflowTemplateId  where StyleID = @NewStyleID


--Comment #01, #02
IF  @DueDate IS NOT NULL 
begin 
	UPDATE pStyleWorkflow
	SET WorkDue = DATEADD(DAY, WorkDay, @DueDate)
		,MUser = @CreatedBy
		,MDate = @CreatedDate
	WHERE StyleID = @NewStyleID
end




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleImageDevelopmentSpec_Linked_UPDATE]'
GO
CREATE PROCEDURE [dbo].[spx_StyleImageDevelopmentSpec_Linked_UPDATE]
(
	@StyleId			uniqueidentifier,
	@StyleSet			int,
	@WorkflowID			uniqueidentifier,
	@ImageID			uniqueidentifier,
	@ImageVersion		nvarchar(5),
	@ModifiedBy			nvarchar(200),
	@ModifiedDate		datetime
)

AS 


/************************/
/*Declare variables.	*/
/************************/
DECLARE @StyleID_Param UNIQUEIDENTIFIER			--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT						--Keep a copy of the original parameter value.

DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleImageDevelopmentSpec_UPDATE
			@StyleID_Param
			,@StyleSet_Param
			,@WorkflowID
			,@ImageID
			,@ImageVersion
			,@ModifiedBy
			,@ModifiedDate
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet_Param AS StyleSet
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID
	END

/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Get the 'StyleID' for the insert.*/
		SELECT @StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleImageDevelopmentSpec_UPDATE
			@StyleID
			,@StyleSet
			,@WorkflowID
			,@ImageID
			,@ImageVersion
			,@ModifiedBy
			,@ModifiedDate


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Style_DesignDetail_Image_2_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.
*/


ALTER        PROCEDURE [dbo].[rpx_Style_DesignDetail_Image_2_SELECT] 	 
	@StyleID varchar(255),	
	@StyleSet As int 
AS


SELECT	identity(int,0,1) as RowNumber,
	(dbo.fnx_GetStreamingImagePath(hi.ImageID, hi.[Version])) AS FilePath,	--Comment #01
	CAST(hi.ImageDescription AS varchar(255)) AS ImageDescription 
INTO	#tblTemp
FROM	pStyleImageItem si, hImage hi 
WHERE	((si.ImageID = hi.ImageID) AND
	(si.ImageVersion = hi.Version) AND
	(si.StyleSet = @StyleSet) AND
	(si.StyleID = @StyleID)) 
ORDER BY si.Sort, si.ImageID ASC

SELECT RowNumber % 2 AS RowNumber,
	FilePath,
	ImageDescription
FROM	#tblTemp





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanMultiClothStyle_SELECT]'
GO
CREATE PROCEDURE [dbo].[spx_LinePlanMultiClothStyle_SELECT](
@LinePlanColorGroupID UNIQUEIDENTIFIER ,
@LinePlanID UNIQUEIDENTIFIER
)
AS 

SELECT  a.StyleID , b.LinePlanItemID, b.StyleSeasonYearID
FROM pStyleHeader a
INNER JOIN pStyleSeasonYear  b ON a.StyleID = b.StyleID
WHERE a.StylelinkID = @LinePlanColorGroupID 
AND b.LinePlanID  =  @LinePlanID 




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanStyleAttributeItem_INSERT]'
GO


CREATE PROCEDURE [dbo].[spx_LinePlanStyleAttributeItem_INSERT] (
@LinePlanRangeID UNIQUEIDENTIFIER , 
@LinePlanID UNIQUEIDENTIFIER , 
@LinePlanStyleAttributeID UNIQUEIDENTIFIER , 
@CUser NVARCHAR(200), 
@CDate DATETIME 
)
AS

DECLARE @LinePlanAttributeItemID1 UNIQUEIDENTIFIER 
DECLARE @LinePlanAttributeItemID2 UNIQUEIDENTIFIER 
DECLARE @LinePlanAttributeItemID3 UNIQUEIDENTIFIER 
DECLARE @LinePlanAttributeItemID4 UNIQUEIDENTIFIER 

SELECT @LinePlanAttributeItemID1 = LinePlanAttributeItemID1, @LinePlanAttributeItemID2 = LinePlanAttributeItemID2,
@LinePlanAttributeItemID3 = LinePlanAttributeItemID3, @LinePlanAttributeItemID4 = LinePlanAttributeItemID4
FROM pLinePlanRange
WHERE LinePlanRangeID = @LinePlanRangeID

IF (
	SELECT COUNT(*) FROM pLinePlanStyleAttributeItem 
	WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
	AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanAttributeItemID4 = @LinePlanAttributeItemID4
	AND LinePlanID = @LinePlanID AND LinePlanStyleAttributeID = @LinePlanStyleAttributeID) = 0
BEGIN

	DECLARE @LinePlanStyleAttributeItemID UNIQUEIDENTIFIER  
	SET @LinePlanStyleAttributeItemID = NEWID() 

	INSERT INTO pLinePlanStyleAttributeItem( LinePlanStyleAttributeItemID , LinePlanStyleAttributeID, LinePlanAttributeTypeID , 
	LinePlanID, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3, LinePlanAttributeItemID4, 
	AttributeID , AttributeName, CUser, CDate, MUser, MDate , LinePlanRangeID)
	SELECT @LinePlanStyleAttributeItemID AS LinePlanStyleAttributeItemID, LinePlanStyleAttributeID, LinePlanAttributeTypeID, 
	@LinePlanID, @LinePlanAttributeItemID1, @LinePlanAttributeItemID2, @LinePlanAttributeItemID3, @LinePlanAttributeItemID4,
	AttributeID , AttributeName, @CUser, @CDate, @CUser, @CDate , @LinePlanRangeID AS LinePlanRangeID
	FROM pLinePlanStyleAttribute
	WHERE LinePlanStyleAttributeID =  @LinePlanStyleAttributeID 



	-- INSERT LinePlanRange Attributes
	INSERT INTO pLinePlanRangeAttribute ( LinePlanRangeAttributeID , LinePlanStyleAttributeItemID ,  AttributeID , 
	AttributeName, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3, LinePlanAttributeItemID4,
	LinePlanID , LinePlanFinancialID, LinePlanRange,  CUser, CDate, MUser, MDate ,  LinePlanFinancialSort )
	SELECT NEWID() AS LinePlanRangeAttributeID, 
	@LinePlanStyleAttributeItemID AS LinePlanStyleAttributeItemID, 
	c.AttributeID , c.AttributeName,
	a.LinePlanAttributeItemID1,a.LinePlanAttributeItemID2, a.LinePlanAttributeItemID3, a.LinePlanAttributeItemID4,
	c.LinePlanID, 
	b.LinePlanFinancialID , b.LinePlanFinancialText,  @CUser, @CDate, @CUser, @CDate, b.LinePlanFinancialSort
	FROM vwx_LinePlanItemProduct_SELECT a
	CROSS JOIN pLinePlanFinancial b
	CROSS JOIN pLinePlanStyleAttribute c
	WHERE c.LinePlanStyleAttributeID = @LinePlanStyleAttributeID
	AND b.LinePlanFinancialGroup = 'Range'
	AND a.LinePlanID = @LinePlanID
	and a.LinePlanAttributeITemID1 = @LinePlanAttributeITemID1
	AND a.LinePlanAttributeITemID2 = @LinePlanAttributeITemID2
	AND a.LinePlanAttributeITemID3 = @LinePlanAttributeITemID3



/*
	WHERE c.LinePlanStyleAttributeID = 'F1ECD7CD-EB91-437E-9EEE-A7132B1220DC'
	AND b.LinePlanFinancialGroup = 'Range'
	AND a.LinePlanID = 'cca58ea9-a556-4970-b1a3-75ba41e9e0e8'
	and a.LinePlanAttributeITemID1 = '517C20D6-B421-46E2-9C17-51E60097285B'
	AND a.LinePlanAttributeITemID2 = '54FBE561-E265-47D1-B947-EB21578DC85A'
	AND a.LinePlanAttributeITemID3 = 'EE027885-CD89-454A-88CE-5991DF751714'


*/


END


























GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_SampleRequestQASizeIndex_SELECT]'
GO
CREATE PROCEDURE [dbo].[spx_SampleRequestQASizeIndex_SELECT]
(
	@SampleRequestWorkflowID uniqueidentifier,
	@SampleRequestTradeID uniqueidentifier,
	@StyleID uniqueidentifier
)
AS 

BEGIN
	SELECT TOP 1 ID FROM ( 
	SELECT 0 AS 'ID', Size0 AS 'Size', Sel0 AS Sel, Col0 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel0 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 1 AS 'ID', Size1 AS 'Size', Sel1 AS Sel, Col1 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel1 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 2 AS 'ID', Size2 AS 'Size', Sel2 AS Sel, Col2 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel2 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 3 AS 'ID', Size3 AS 'Size', Sel3 AS Sel, Col3 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel3 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 4 AS 'ID', Size4 AS 'Size', Sel4 AS Sel, Col4 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel4 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION 
	SELECT 5 AS 'ID', Size5 AS 'Size', Sel5 AS Sel, Col5 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel5 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 6 AS 'ID', Size6 AS 'Size', Sel6 AS Sel, Col6 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel6 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 7 AS 'ID', Size7 AS 'Size', Sel7 AS Sel, Col7 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel7 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 8 AS 'ID', Size8 AS 'Size', Sel8 AS Sel, Col8 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel8 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 9 AS 'ID', Size9 AS 'Size', Sel9 AS Sel, Col9 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel9 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 10 AS 'ID', Size10 AS 'Size', Sel10 AS Sel, Col10 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel10 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 11 AS 'ID', Size11 AS 'Size', Sel11 AS Sel, Col11 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel11 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 12 AS 'ID', Size12 AS 'Size', Sel12 AS Sel, Col12 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel12 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 13 AS 'ID', Size13 AS 'Size', Sel13 AS Sel, Col13 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel13 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 14 AS 'ID', Size14 AS 'Size', Sel14 AS Sel, Col14 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel14 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION 
	SELECT 15 AS 'ID', Size15 AS 'Size', Sel15 AS Sel, Col15 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel15 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 16 AS 'ID', Size16 AS 'Size', Sel16 AS Sel, Col16 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel16 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 17 AS 'ID', Size17 AS 'Size', Sel17 AS Sel, Col17 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel17 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 18 AS 'ID', Size18 AS 'Size', Sel18 AS Sel, Col18 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel18 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	UNION
	SELECT 19 AS 'ID', Size19 AS 'Size', Sel19 AS Sel, Col19 AS Col FROM pSampleRequestQASize WITH (NOLOCK) WHERE Sel19 = 1 AND (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID)
	) AS tmpSampleRequestQASize 
	WHERE LEN (ID) > 0
END

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialRequestContentPercent_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_MaterialRequestContentPercent_SELECT]
(
	@MaterialTradePartnerId uniqueidentifier,
	@MaterialID uniqueidentifier
)
AS 

SELECT SUM(MaterialContentPerc) FROM pMaterialRequestContent WITH (NOLOCK) 
WHERE MaterialContentCode <> '0' AND MaterialID = @MaterialID AND MaterialTradePartnerId = @MaterialTradePartnerId



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleImageItem_Linked_COPY]'
GO
CREATE PROCEDURE [dbo].[spx_StyleImageItem_Linked_COPY]
(
	@StyleImageItemID uniqueidentifier,
	@WorkflowID uniqueidentifier,
	@StyleID uniqueidentifier,
	@StyleSet int,
	@ImageID uniqueidentifier,
	@ImageVersion int,
	@CreatedBy nvarchar(100),
	@CreatedDate datetime,
	@CopyStyleID uniqueidentifier,
	@CopyStyleSet int
)

AS 


/************************/
/*Declare variables.	*/
/************************/
DECLARE @StyleID_Param UNIQUEIDENTIFIER			--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT						--Keep a copy of the original parameter value.

DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleImageItem_COPY
			@StyleImageItemID
			,@WorkflowID
			,@StyleID_Param
			,@StyleSet_Param
			,@ImageID
			,@ImageVersion
			,@CreatedBy
			,@CreatedDate
			,@CopyStyleID
			,@CopyStyleSet
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet_Param AS StyleSet
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID
	END

/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Get the 'StyleID' for the insert.*/
		SELECT @StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleImageItem_COPY
			@StyleImageItemID
			,@WorkflowID
			,@StyleID
			,@StyleSet
			,@ImageID
			,@ImageVersion
			,@CreatedBy
			,@CreatedDate
			,@CopyStyleID
			,@CopyStyleSet


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_ColorPalette_SEL]'
GO
ALTER VIEW dbo.vwx_ColorPalette_SEL
AS
SELECT     '<img src=''../System/Control/ColorStream.ashx?S=25&CFID=' + CAST(ISNULL(dbo.pColorPalette.ColorFolderID, 
                      '00000000-0000-0000-0000-000000000000') AS NVARCHAR(50)) + '&CPID=' + CAST(ISNULL(dbo.pColorPalette.ColorPaletteID, 
                      '00000000-0000-0000-0000-000000000000') AS NVARCHAR(50)) + '''  />' AS ColorImagePath, dbo.pColorPalette.ColorPaletteID, 
                      dbo.pColorPalette.ColorFolderID, dbo.pColorPalette.ColorCode, dbo.pColorPalette.ColorName, dbo.pColorPalette.ColorSource, 
                      dbo.pColorPalette.ColorNotes, dbo.pColorPalette.Hex, dbo.pColorPalette.R, dbo.pColorPalette.G, dbo.pColorPalette.B, dbo.pColorPalette.C, 
                      dbo.pColorPalette.M, dbo.pColorPalette.Y, dbo.pColorPalette.K, dbo.pColorPalette.H, dbo.pColorPalette.S, dbo.pColorPalette.L, 
                      dbo.pColorPalette.LAB_L, dbo.pColorPalette.LAB_A, dbo.pColorPalette.LAB_B, dbo.pColorPalette.CUser, dbo.pColorPalette.CDate, 
                      dbo.pColorPalette.MUser, dbo.pColorPalette.MDate, dbo.pColorPalette.ColorID, dbo.pColorPalette.Change, dbo.pColorPalette.Action, 
                      dbo.pColorPalette.Active, dbo.pColorPalette.Sort, dbo.pColorPalette.ColorImage, dbo.pColorPalette.ColorImageType, 
                      dbo.pColorPalette.CopyColorPaletteID, dbo.pColorPalette.SystemServerStorageID, dbo.pColorFolder.ColorTypeID
FROM         dbo.pColorPalette INNER JOIN
                      dbo.pColorFolder ON dbo.pColorPalette.ColorFolderID = dbo.pColorFolder.ColorFolderID
WHERE     (dbo.pColorPalette.CUser <> 'YUNIQUE') OR
                      (dbo.pColorPalette.CUser IS NULL)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pLinePlanMultiClothStyleTemp]'
GO
CREATE TABLE [dbo].[pLinePlanMultiClothStyleTemp]
(
[LinePlanStyleTempID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_pLinePlanMultiClothStyleTemp_StyleID] DEFAULT (newid()),
[LinePlanColorGroupID] [uniqueidentifier] NULL,
[MaterialGroupID] [uniqueidentifier] NULL,
[StyleID] [uniqueidentifier] NULL,
[StyleMasterID] [uniqueidentifier] NULL,
[StyleWorkflowID] [uniqueidentifier] NULL,
[StyleType] [int] NOT NULL CONSTRAINT [DF_pLinePlanMultiClothStyleTemp_StyleType] DEFAULT ((1)),
[WorkflowType] [uniqueidentifier] NULL,
[RefNo] [int] NOT NULL IDENTITY(100, 1),
[StyleNo] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[TempID] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[TempNo] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomerNo] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[DevelopmentID] [uniqueidentifier] NULL,
[DevelopmentNo] [nvarchar] (20) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ConceptID] [uniqueidentifier] NULL,
[ConceptNo] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[SpecNo] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Description] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCategory] [uniqueidentifier] NULL,
[SizeClass] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[SizeRange] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleSet] [int] NULL CONSTRAINT [DF_pLinePlanMultiClothStyleTemp_StyleSet] DEFAULT ((1)),
[TechPackId] [uniqueidentifier] NULL,
[TechPackDate] [datetime] NULL,
[DueDate] [datetime] NULL,
[RecDate] [datetime] NULL,
[Customer] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Buyer] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Designer] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[SampleMaker] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[PatternMaker] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ProductionManager] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[TechnicalDesigner] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleStatus] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleLocation] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[WashType] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Pitch] [int] NULL,
[MaterialID] [uniqueidentifier] NULL,
[MaterialImageID] [uniqueidentifier] NULL,
[MaterialImageVersion] [int] NULL CONSTRAINT [DF_pLinePlanMultiClothStyleTemp_MaterialImageVersion] DEFAULT ((0)),
[MaterialNo] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MaterialName] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[POMTempGroupID1] [uniqueidentifier] NULL,
[POMTempGroupID2] [uniqueidentifier] NULL,
[POMTempGroupID3] [uniqueidentifier] NULL,
[POMTempGroupID4] [uniqueidentifier] NULL,
[POMTempID1] [uniqueidentifier] NULL,
[POMTempVersion1] [int] NULL,
[POMTempSizeClass1] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[POMTempID2] [uniqueidentifier] NULL,
[POMTempVersion2] [int] NULL,
[POMTempSizeClass2] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[POMTempID3] [uniqueidentifier] NULL,
[POMTempVersion3] [int] NULL,
[POMTempSizeClass3] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[POMTempID4] [uniqueidentifier] NULL,
[POMTempVersion4] [int] NULL,
[POMTempSizeClass4] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleMaterialID] [uniqueidentifier] NULL,
[DesignSketchID] [uniqueidentifier] NULL,
[TechSketchID] [uniqueidentifier] NULL,
[ConceptSketchID] [uniqueidentifier] NULL,
[ColorSketchID] [uniqueidentifier] NULL,
[DesignSketchVersion] [int] NULL,
[TechSketchVersion] [int] NULL,
[ConceptSketchVersion] [int] NULL,
[ColorSketchVersion] [int] NULL,
[DetailSketchID1] [uniqueidentifier] NULL,
[DetailSketchID2] [uniqueidentifier] NULL,
[DetailSketchID3] [uniqueidentifier] NULL,
[DetailSketchID4] [uniqueidentifier] NULL,
[DetailSketchVersion1] [int] NULL,
[DetailSketchVersion2] [int] NULL,
[DetailSketchVersion3] [int] NULL,
[DetailSketchVersion4] [int] NULL,
[SpecSketchID1] [uniqueidentifier] NULL,
[SpecSketchID2] [uniqueidentifier] NULL,
[SpecSketchID3] [uniqueidentifier] NULL,
[SpecSketchID4] [uniqueidentifier] NULL,
[SpecSketchVersion1] [int] NULL,
[SpecSketchVersion2] [int] NULL,
[SpecSketchVersion3] [int] NULL,
[SpecSketchVersion4] [int] NULL,
[Markup] [numeric] (18, 0) NULL,
[TargetPrice] [money] NULL,
[SellingPrice] [money] NULL,
[CustomField1] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL CONSTRAINT [DF_pLinePlanMultiClothStyleTemp_CustomField1] DEFAULT (N'Burberry'),
[CustomField2] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField3] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField4] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField5] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField6] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField7] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField8] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField9] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField10] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField11] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField12] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField13] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField14] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField15] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Pc1] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Pc2] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Pc3] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Pc4] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[Active] [int] NOT NULL CONSTRAINT [DF_pLinePlanMultiClothStyleTemp_Active] DEFAULT ((1)),
[Change] [int] NULL,
[Action] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[NoColorCombo] [int] NOT NULL CONSTRAINT [DF_pLinePlanMultiClothStyleTemp_NoColorCombo] DEFAULT ((0)),
[StyleVersion] [int] NULL CONSTRAINT [DF_pLinePlanMultiClothStyleTemp_StyleVersion] DEFAULT ((0)),
[StyleDetail] [nvarchar] (max) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleDetail1] [nvarchar] (max) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleDetail2] [nvarchar] (max) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleAttribute] [nvarchar] (max) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[LinePlanID] [uniqueidentifier] NULL,
[LinePlanNo] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[LinePlanSketchID] [uniqueidentifier] NULL,
[LinePlanSketchVersion] [int] NULL,
[CustomField16] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField17] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField18] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField19] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField20] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField21] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField22] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField23] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField24] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField25] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField26] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField27] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField28] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField29] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField30] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[PackagingNo] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCopyID] [uniqueidentifier] NULL,
[LinePlanItemID] [uniqueidentifier] NULL,
[StyleStatusID] [int] NULL CONSTRAINT [DF_pLinePlanMultiClothStyleTemp_StyleStatusID] DEFAULT ((1)),
[BodyID] [uniqueidentifier] NULL,
[TradePartnerID] [uniqueidentifier] NULL,
[TradePartnerVendorID] [uniqueidentifier] NULL,
[ProdDev] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[HeaderLocked] [int] NOT NULL CONSTRAINT [DF_pLinePlanMultiClothStyleTemp_ApprovalStatus] DEFAULT ((0)),
[ReportingGroup] [varchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanMultiClothStyleTemp_INSERT]'
GO



CREATE PROCEDURE [dbo].[spx_LinePlanMultiClothStyleTemp_INSERT]
(
	 @LinePlanColorGroupID uniqueidentifier
	,@MaterialGroupID uniqueidentifier
	,@MaterialID uniqueidentifier
	,@StyleID uniqueidentifier
	,@BodyID uniqueidentifier
)
AS 

IF (SELECT COUNT(*) FROM pLinePlanMultiClothStyleTemp WHERE StyleId = @StyleId 
	AND  LinePlanColorGroupID = @LinePlanColorGroupID ) = 0
BEGIN
	INSERT INTO pLinePlanMultiClothStyleTemp 
           (LinePlanColorGroupID
           ,MaterialGroupID
           ,StyleID
           ,MaterialID
           ,BodyID)
     VALUES
           (@LinePlanColorGroupID
           ,@MaterialGroupID
		   ,@StyleID
           ,@MaterialID
           ,@BodyID)
END
ELSE
BEGIN
	UPDATE pLinePlanMultiClothStyleTemp SET
            MaterialGroupID = @MaterialGroupID
           ,BodyID = @BodyID
	WHERE LinePlanColorGroupID = @LinePlanColorGroupID 
		AND StyleID = @StyleID
END

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rpx_Style_SeasonalMaterialColorway_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - 6/25/2008 - Feature #313

	Burberry wants to see the SAP Code in the Colorway report.  There is a custom "BB_Style_MaterialColorway_Body_LLT.rdl" that is going to
use this SAP Code.  Just needed to add that field to this query.  There were 3 changes to this procedure.  Parts A, B, and C.  Field "SAPCode"
was added to these three sections.  A - was to add the field to the temp table.  B - was to add the field to the INSERT and SELECT portion
of the statement.  C - was to select the field in the final SELECT statement.

#02 - Ryan Cabanas - 1/15/2009
	When an a chip was added from the Image Folder, the 'ColorName' field was getting updated with the Image Number.  Clay isn't sure why it
was set up this way, but he said it shouldn't be this way.  I've commented it out here.

#03 - Ryan Cabanas - June 8, 2009
	This new procedure has been created 'rpx_Style_SeasonalMaterialColorway_SELECT' for the new Seasonal Colorway
feature that we now have.

#04 - Ryan Cabanas - September 28, 2009
	Need to add new fields to the temp table to hold the sort values that are used so that sorting can be
worked with later when creating the Row and Column values.

#05 - Ryan Cabanas - September 28, 2009
	Create a couple of temp table to handle sorting for the materials and the colors.  These will be used
to do proper sorting at the final SELECT.  Commented out the old sorting in the initial INSERT/SELECT.

#06 - Ryan Cabanas - September 28, 2009
	Need to add a 'Group Color Column' that will keep the colors together in the report as the priority.
Also need to do this for Landscape reports versus Portrait reports.

#07 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.

#08 - Ryan Cabanas - September 23, 2009
	Replace the old color image string with the new color image string using function.
Deleted old code.
*/




CREATE         PROCEDURE [dbo].[rpx_Style_SeasonalMaterialColorway_SELECT]  
(
	@StyleID AS varchar(255), 	
	@StyleSet AS int,
	@SeasonYearID varchar(255)	--Comment #03
)
AS



--/*Testing.*/
--BEGIN
--	DECLARE @StyleID varchar(255)
--	DECLARE @StyleSet int
--	DECLARE @SeasonYearID varchar(255)
--	SET @StyleID = 'f5bc96b7-5dea-4a2b-936b-f8bdea47229e'
--	SET @StyleSet = 1
--	SET @SeasonYearID = 'B2965D2D-2AE5-4B8D-9B77-477728946DD9'
--END




/*****************/
/*Comment #01 - A*/
/*****************/
--Create temp table.
CREATE TABLE #tempTable
(
	TableRow int identity(0,1)
	,MaterialDescription varchar(255)
	,StyleMaterialId varchar(50)
	,Placement nvarchar(1000)
	,MainColor varchar(255)
	,SAPCode varchar(50)
	,Qty varchar(18)
	,MaterialSize varchar(200)
	,ColorName varchar(150)
	,ColorCode varchar(50)
	,FilePath varchar(255)
	,MaterialColorNote nvarchar(1000)
	,MaterialColorImageID varchar(50)
	,MaterialColorImageVersion int
	,StyleColorSort nvarchar(10)		--Comment #04
	,StyleColorName nvarchar(200)		--Comment #04
	,StyleColorID nvarchar(200)			--Comment #04
	,MainMaterial int					--Comment #04
	,MaterialType int					--Comment #04
	,MaterialSort varchar(5)			--Comment #04
	,MaterialNo nvarchar(50)			--Comment #04
	,Row int							--Comment #04
	,[Column] int						--Comment #04
	,GroupColorColumnLandscape int		--Comment #06
	,GroupColorColumnPortrait int		--Comment #06
)

--Comment #05
CREATE TABLE #tempMaterialSort(
	TableRow int identity(0,1)
	,StyleMaterialId varchar(50)
	,MainMaterial int
	,MaterialType int
	,MaterialSort varchar(5)
	,MaterialNo nvarchar(50)
)

--Comment #05
CREATE TABLE #tempColorSort(
	TableRow int identity(0,1)
	,MainColor varchar(50)
	,StyleColorSort nvarchar(10)
	,StyleColorName nvarchar(200)
	,StyleColorID nvarchar(200)
	,GroupColorColumnLandscape int	--Comment #06
	,GroupColorColumnPortrait int	--Comment #06
)


/*****************/
/*Comment #01 - B*/
/*****************/
--Get the material colorway squares and put them in the temp table.
INSERT INTO #tempTable(
	MaterialDescription
	,StyleMaterialId
	,Placement
	,MainColor
	,SAPCode
	,Qty
	,MaterialSize
	,ColorName
	,ColorCode
	,FilePath
	,MaterialColorNote
	,MaterialColorImageID
	,MaterialColorImageVersion
	,StyleColorSort			--Comment #04
	,StyleColorName			--Comment #04
	,StyleColorID			--Comment #04
	,MainMaterial			--Comment #04
	,MaterialType			--Comment #04
	,MaterialSort			--Comment #04
	,MaterialNo				--Comment #04
)
SELECT
	('(' + pStyleMaterials.MaterialNo + ') ' + pStyleMaterials.MaterialName) AS MaterialDescription
	,CAST(pStyleMaterials.StyleMaterialId AS varchar(50)) AS StyleMaterialId
	,pStyleMaterials.Placement
	,isnull('(' + pStyleColorway.StyleColorNo + ') ','') +  pStyleColorway.MainColor AS MainColor
	,pStyleColorway.SAPCode
	,pStyleMaterials.Qty
	,pStyleMaterials.MaterialSize
	,pMaterialColor.ColorName
	,pMaterialColor.ColorCode
	,dbo.fnx_GetStreamingColorImagePath(pMaterialColor.ColorFolderID, pMaterialColor.ColorPaletteID) AS FilePath	--Comment #08
	,pMaterialColor.MaterialColorNote
	,pMaterialColor.MaterialColorImageID
	,pMaterialColor.MaterialColorImageVersion
	,pStyleColorway.Sort AS StyleColorSort						--Comment #04
	,pStyleColorway.StyleColorName								--Comment #04
	,CAST(pStyleColorway.StyleColorID AS nvarchar(200))			--Comment #04
	,pStyleMaterials.MainMaterial								--Comment #04
	,pStyleMaterials.MaterialType								--Comment #04
	,pStyleMaterials.MaterialSort								--Comment #04
	,pStyleMaterials.MaterialNo									--Comment #04
FROM pStyleColorway
	LEFT OUTER JOIN pStyleMaterials ON	pStyleColorway.StyleID = pStyleMaterials.StyleID
										AND pStyleColorway.StyleSet = pStyleMaterials.StyleSet
										AND pStyleMaterials.Colorway = 1
	LEFT OUTER JOIN pStyleColorwayItem ON	pStyleMaterials.StyleMaterialID = pStyleColorwayItem.StyleMaterialID
											AND pStyleColorway.StyleColorID = pStyleColorwayItem.StyleColorID
	LEFT OUTER JOIN pMaterialColor ON pStyleColorwayItem.MaterialColorID = pMaterialColor.MaterialColorID
	INNER JOIN pStyleColorwaySeasonYear ON	pStyleColorway.StyleID = pStyleColorwaySeasonYear.StyleID						--Comment #03
											AND pStyleColorway.StyleColorID = pStyleColorwaySeasonYear.StyleColorwayID		--Comment #03
	INNER JOIN pStyleSeasonYear ON	pStyleColorwaySeasonYear.StyleSeasonYearID = pStyleSeasonYear.StyleSeasonYearID			--Comment #03
									AND pStyleColorwaySeasonYear.StyleID = pStyleSeasonYear.StyleID							--Comment #03
WHERE pStyleColorway.StyleID = @StyleID
	AND pStyleColorway.StyleSet = @StyleSet
	AND pStyleSeasonYear.SeasonYearID = @SeasonYearID
--ORDER BY pStyleColorway.Sort				--Comment #05
--	,pStyleColorway.StyleColorName			--Comment #05
--	,pStyleColorway.StyleColorID			--Comment #05
--	,pStyleMaterials.MainMaterial DESC		--Comment #05
--	,pStyleMaterials.MaterialType			--Comment #05
--	,pStyleMaterials.MaterialSort			--Comment #05
--	,pStyleMaterials.MaterialNo				--Comment #05

--Update the temp folder for the chips that are images from the Image folder.
UPDATE #tempTable
SET FilePath = dbo.fnx_GetStreamingImagePath(hImage.ImageID, hImage.[Version])	--Comment #07
--	ColorName = '(' + hImage.ImageNo + ')'  --Comment #02
FROM #tempTable
	INNER JOIN hImage ON	(#tempTable.MaterialColorImageID = hImage.ImageID
							AND #tempTable.MaterialColorImageVersion = hImage.Version)


--Update the temp table to include the "Die To Match (DTM)" feature request.
UPDATE #tempTable
SET ColorCode = ''
WHERE (ColorName IS NULL)
	AND (ColorCode IS NULL)
	AND (FilePath IS NULL)


--Comment #05
BEGIN
	/*Get the materials and put them in temp table to sort.*/
	INSERT INTO #tempMaterialSort(
		StyleMaterialId
		,MainMaterial
		,MaterialType
		,MaterialSort
		,MaterialNo
	)
	SELECT
		StyleMaterialId
		,MainMaterial
		,MaterialType
		,MaterialSort
		,MaterialNo
	FROM #tempTable
	GROUP BY
		StyleMaterialId
		,MainMaterial
		,MaterialType
		,MaterialSort
		,MaterialNo
	ORDER BY 
		MainMaterial DESC
		,MaterialType
		,MaterialSort
		,MaterialNo

	/*Get the colors and put them in temp table to sort.*/
	INSERT INTO #tempColorSort(
		MainColor
		,StyleColorSort
		,StyleColorName
		,StyleColorID
	)
	SELECT
		MainColor
		,StyleColorSort
		,StyleColorName
		,StyleColorID
	FROM #tempTable
	GROUP BY
		MainColor
		,StyleColorSort
		,StyleColorName
		,StyleColorID
	ORDER BY 
		StyleColorSort
		,StyleColorName
		,StyleColorID

	--Comment #06
	/*Declare variables.*/
	DECLARE @TotalCount int
	DECLARE @RowCounter int
	DECLARE @GroupCountLandscape int
	DECLARE @GroupCutOffLandscape int
	DECLARE @GroupCountPortrait int
	DECLARE @GroupCutOffPortrait int

	--Comment #06
	/*Get counts.*/
	SELECT @TotalCount = COUNT(*) from #tempColorSort
	SET @RowCounter = 0
	SET @GroupCountLandscape = 0
	SET @GroupCutOffLandscape = 6
	SET @GroupCountPortrait = 0
	SET @GroupCutOffPortrait = 3

	--Comment #06
	/*Loop to set 'Group Color Column' values.*/
	WHILE(@RowCounter < @TotalCount)
		BEGIN
			/*Update the 'Group Color Column' value.*/
			UPDATE #tempColorSort
			SET GroupColorColumnLandscape = @GroupCountLandscape
				,GroupColorColumnPortrait = @GroupCountPortrait
			WHERE TableRow = @RowCounter

			/*Up 'Group Color Column' count, if necessary, for landscape.*/
			IF(@RowCounter % @GroupCutOffLandscape = @GroupCutOffLandscape - 1)
				BEGIN
					SET @GroupCountLandscape = @GroupCountLandscape + 1
				END

			/*Up 'Group Color Column' count, if necessary, for portrait.*/
			IF(@RowCounter % @GroupCutOffPortrait = @GroupCutOffPortrait - 1)
				BEGIN
					SET @GroupCountPortrait = @GroupCountPortrait + 1
				END

			/*Up row counter.*/
			SET @RowCounter = @RowCounter + 1
		END

	/*Update main temp table with Row and Column values.*/
	UPDATE #tempTable
	SET Row = #tempMaterialSort.TableRow
		,[Column] = #tempColorSort.TableRow
		,GroupColorColumnLandscape = #tempColorSort.GroupColorColumnLandscape
		,GroupColorColumnPortrait = #tempColorSort.GroupColorColumnPortrait
	FROM #tempTable
		INNER JOIN #tempMaterialSort	ON	#tempTable.StyleMaterialID = #tempMaterialSort.StyleMaterialID
		INNER JOIN #tempColorSort	ON	#tempTable.MainColor = #tempColorSort.MainColor
END


/*****************/
/*Comment #01 - C*/
/*****************/
--Get the desired columns from the original temp table.
SELECT
	Row		--Comment #05
	,[Column]	--Comment #05
	,GroupColorColumnLandscape	--Comment #06
	,GroupColorColumnPortrait	--Comment #06
	,MaterialDescription
	,StyleMaterialId
	,Placement
	,MainColor
	,SAPCode
	,Qty
	,MaterialSize
	,ColorName
	,ColorCode
	,FilePath
	,MaterialColorNote
FROM #tempTable
ORDER BY
	Row		--Comment #05
	,[Column]	--Comment #05


/*
SELECT *
FROM dbo.pStyleColorway INNER JOIN
    dbo.pStyleColorwayItem ON dbo.pStyleColorway.StyleColorID = dbo.pStyleColorwayItem.StyleColorID INNER JOIN
    dbo.pStyleMaterials ON dbo.pStyleColorwayItem.StyleMaterialID = dbo.pStyleMaterials.StyleMaterialID INNER JOIN
    dbo.pMaterialColor ON dbo.pStyleColorwayItem.MaterialColorID = dbo.pMaterialColor.MaterialColorID
*/

--Drop the Temp Table.
DROP TABLE #tempTable
DROP TABLE #tempMaterialSort	--Comment #05
DROP TABLE #tempColorSort		--Comment #05
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_SampleRequestQAWorksheet_SELECT]'
GO


CREATE PROCEDURE [dbo].[spx_SampleRequestQAWorksheet_SELECT] (
	@StyleID uniqueidentifier, 
	@StyleSet int,
	@SampleRequestTradeID uniqueidentifier,
	@SampleRequestWorkflowID uniqueidentifier,
	@SampleWorkflowID varchar (50) ,
	@Submit int
)
AS 



SELECT SampleRequestQAWorksheetID, SampleRequestQAWorksheetSizeID, SampleRequestTradeID, SampleRequestWorkflowID, SampleWorkflowID, TradePartnerVendorID, 
WorkflowID, SpecMasterID, pSampleRequestQAWorksheet.POMTempItemID, pSampleRequestQAWorksheet.POMLibraryID, ModelSpecID, ModelID,  
POMTempID, StyleID, StyleColorID, Submit, Critical, SpecID, StyleSet, pSampleRequestQAWorksheet.POM, 
pSampleRequestQAWorksheet.PointMeasur, TOL, TOLN,      

		pSampleRequestQAWorksheet.Ask000,
		pSampleRequestQAWorksheet.Spec000,
		pSampleRequestQAWorksheet.Spec001,
		pSampleRequestQAWorksheet.Spec002,
		pSampleRequestQAWorksheet.Spec003,
		pSampleRequestQAWorksheet.Spec004,
		pSampleRequestQAWorksheet.Spec005,
		pSampleRequestQAWorksheet.Spec006,
		pSampleRequestQAWorksheet.Spec007,
		pSampleRequestQAWorksheet.Spec008,
		pSampleRequestQAWorksheet.Spec009,		

		pSampleRequestQAWorksheet.Ask001,
		pSampleRequestQAWorksheet.Spec010,
		pSampleRequestQAWorksheet.Spec011,
		pSampleRequestQAWorksheet.Spec012,
		pSampleRequestQAWorksheet.Spec013,
		pSampleRequestQAWorksheet.Spec014,
		pSampleRequestQAWorksheet.Spec015,
		pSampleRequestQAWorksheet.Spec016,
		pSampleRequestQAWorksheet.Spec017,
		pSampleRequestQAWorksheet.Spec018,
		pSampleRequestQAWorksheet.Spec019,		

		pSampleRequestQAWorksheet.Ask002,
		pSampleRequestQAWorksheet.Spec020,
		pSampleRequestQAWorksheet.Spec021,
		pSampleRequestQAWorksheet.Spec022,
		pSampleRequestQAWorksheet.Spec023,
		pSampleRequestQAWorksheet.Spec024,
		pSampleRequestQAWorksheet.Spec025,
		pSampleRequestQAWorksheet.Spec026,
		pSampleRequestQAWorksheet.Spec027,
		pSampleRequestQAWorksheet.Spec028,
		pSampleRequestQAWorksheet.Spec029,		

		pSampleRequestQAWorksheet.Ask003,
		pSampleRequestQAWorksheet.Spec030,
		pSampleRequestQAWorksheet.Spec031,
		pSampleRequestQAWorksheet.Spec032,
		pSampleRequestQAWorksheet.Spec033,
		pSampleRequestQAWorksheet.Spec034,
		pSampleRequestQAWorksheet.Spec035,
		pSampleRequestQAWorksheet.Spec036,
		pSampleRequestQAWorksheet.Spec037,
		pSampleRequestQAWorksheet.Spec038,
		pSampleRequestQAWorksheet.Spec039,		

		pSampleRequestQAWorksheet.Ask004,
		pSampleRequestQAWorksheet.Spec040,
		pSampleRequestQAWorksheet.Spec041,
		pSampleRequestQAWorksheet.Spec042,
		pSampleRequestQAWorksheet.Spec043,
		pSampleRequestQAWorksheet.Spec044,
		pSampleRequestQAWorksheet.Spec045,
		pSampleRequestQAWorksheet.Spec046,
		pSampleRequestQAWorksheet.Spec047,
		pSampleRequestQAWorksheet.Spec048,
		pSampleRequestQAWorksheet.Spec049,		

		pSampleRequestQAWorksheet.Ask005,
		pSampleRequestQAWorksheet.Spec050,
		pSampleRequestQAWorksheet.Spec051,
		pSampleRequestQAWorksheet.Spec052,
		pSampleRequestQAWorksheet.Spec053,
		pSampleRequestQAWorksheet.Spec054,
		pSampleRequestQAWorksheet.Spec055,
		pSampleRequestQAWorksheet.Spec056,
		pSampleRequestQAWorksheet.Spec057,
		pSampleRequestQAWorksheet.Spec058,
		pSampleRequestQAWorksheet.Spec059,		

		pSampleRequestQAWorksheet.Ask006,
		pSampleRequestQAWorksheet.Spec060,
		pSampleRequestQAWorksheet.Spec061,
		pSampleRequestQAWorksheet.Spec062,
		pSampleRequestQAWorksheet.Spec063,
		pSampleRequestQAWorksheet.Spec064,
		pSampleRequestQAWorksheet.Spec065,
		pSampleRequestQAWorksheet.Spec066,
		pSampleRequestQAWorksheet.Spec067,
		pSampleRequestQAWorksheet.Spec068,
		pSampleRequestQAWorksheet.Spec069,		

		pSampleRequestQAWorksheet.Ask007,
		pSampleRequestQAWorksheet.Spec070,
		pSampleRequestQAWorksheet.Spec071,
		pSampleRequestQAWorksheet.Spec072,
		pSampleRequestQAWorksheet.Spec073,
		pSampleRequestQAWorksheet.Spec074,
		pSampleRequestQAWorksheet.Spec075,
		pSampleRequestQAWorksheet.Spec076,
		pSampleRequestQAWorksheet.Spec077,
		pSampleRequestQAWorksheet.Spec078,
		pSampleRequestQAWorksheet.Spec079,		

		pSampleRequestQAWorksheet.Ask008,
		pSampleRequestQAWorksheet.Spec080,
		pSampleRequestQAWorksheet.Spec081,
		pSampleRequestQAWorksheet.Spec082,
		pSampleRequestQAWorksheet.Spec083,
		pSampleRequestQAWorksheet.Spec084,
		pSampleRequestQAWorksheet.Spec085,
		pSampleRequestQAWorksheet.Spec086,
		pSampleRequestQAWorksheet.Spec087,
		pSampleRequestQAWorksheet.Spec088,
		pSampleRequestQAWorksheet.Spec089,		

		pSampleRequestQAWorksheet.Ask009,
		pSampleRequestQAWorksheet.Spec090,
		pSampleRequestQAWorksheet.Spec091,
		pSampleRequestQAWorksheet.Spec092,
		pSampleRequestQAWorksheet.Spec093,
		pSampleRequestQAWorksheet.Spec094,
		pSampleRequestQAWorksheet.Spec095,
		pSampleRequestQAWorksheet.Spec096,
		pSampleRequestQAWorksheet.Spec097,
		pSampleRequestQAWorksheet.Spec098,
		pSampleRequestQAWorksheet.Spec099,		

		pSampleRequestQAWorksheet.Ask010,
		pSampleRequestQAWorksheet.Spec100,
		pSampleRequestQAWorksheet.Spec101,
		pSampleRequestQAWorksheet.Spec102,
		pSampleRequestQAWorksheet.Spec103,
		pSampleRequestQAWorksheet.Spec104,
		pSampleRequestQAWorksheet.Spec105,
		pSampleRequestQAWorksheet.Spec106,
		pSampleRequestQAWorksheet.Spec107,
		pSampleRequestQAWorksheet.Spec108,
		pSampleRequestQAWorksheet.Spec109,		

		pSampleRequestQAWorksheet.Ask011,
		pSampleRequestQAWorksheet.Spec110,
		pSampleRequestQAWorksheet.Spec111,
		pSampleRequestQAWorksheet.Spec112,
		pSampleRequestQAWorksheet.Spec113,
		pSampleRequestQAWorksheet.Spec114,
		pSampleRequestQAWorksheet.Spec115,
		pSampleRequestQAWorksheet.Spec116,
		pSampleRequestQAWorksheet.Spec117,
		pSampleRequestQAWorksheet.Spec118,
		pSampleRequestQAWorksheet.Spec119,		

		pSampleRequestQAWorksheet.Ask012,
		pSampleRequestQAWorksheet.Spec120,
		pSampleRequestQAWorksheet.Spec121,
		pSampleRequestQAWorksheet.Spec122,
		pSampleRequestQAWorksheet.Spec123,
		pSampleRequestQAWorksheet.Spec124,
		pSampleRequestQAWorksheet.Spec125,
		pSampleRequestQAWorksheet.Spec126,
		pSampleRequestQAWorksheet.Spec127,
		pSampleRequestQAWorksheet.Spec128,
		pSampleRequestQAWorksheet.Spec129,		

		pSampleRequestQAWorksheet.Ask013,
		pSampleRequestQAWorksheet.Spec130,
		pSampleRequestQAWorksheet.Spec131,
		pSampleRequestQAWorksheet.Spec132,
		pSampleRequestQAWorksheet.Spec133,
		pSampleRequestQAWorksheet.Spec134,
		pSampleRequestQAWorksheet.Spec135,
		pSampleRequestQAWorksheet.Spec136,
		pSampleRequestQAWorksheet.Spec137,
		pSampleRequestQAWorksheet.Spec138,
		pSampleRequestQAWorksheet.Spec139,		
	
		pSampleRequestQAWorksheet.Ask014,
		pSampleRequestQAWorksheet.Spec140,
		pSampleRequestQAWorksheet.Spec141,
		pSampleRequestQAWorksheet.Spec142,
		pSampleRequestQAWorksheet.Spec143,
		pSampleRequestQAWorksheet.Spec144,
		pSampleRequestQAWorksheet.Spec145,
		pSampleRequestQAWorksheet.Spec146,
		pSampleRequestQAWorksheet.Spec147,
		pSampleRequestQAWorksheet.Spec148,
		pSampleRequestQAWorksheet.Spec149,		

		pSampleRequestQAWorksheet.Ask015,
		pSampleRequestQAWorksheet.Spec150,
		pSampleRequestQAWorksheet.Spec151,
		pSampleRequestQAWorksheet.Spec152,
		pSampleRequestQAWorksheet.Spec153,
		pSampleRequestQAWorksheet.Spec154,
		pSampleRequestQAWorksheet.Spec155,
		pSampleRequestQAWorksheet.Spec156,
		pSampleRequestQAWorksheet.Spec157,
		pSampleRequestQAWorksheet.Spec158,
		pSampleRequestQAWorksheet.Spec159,		
	
		pSampleRequestQAWorksheet.Ask016,
		pSampleRequestQAWorksheet.Spec160,
		pSampleRequestQAWorksheet.Spec161,
		pSampleRequestQAWorksheet.Spec162,
		pSampleRequestQAWorksheet.Spec163,
		pSampleRequestQAWorksheet.Spec164,
		pSampleRequestQAWorksheet.Spec165,
		pSampleRequestQAWorksheet.Spec166,
		pSampleRequestQAWorksheet.Spec167,
		pSampleRequestQAWorksheet.Spec168,
		pSampleRequestQAWorksheet.Spec169,		
	
		pSampleRequestQAWorksheet.Ask017,
		pSampleRequestQAWorksheet.Spec170,
		pSampleRequestQAWorksheet.Spec171,
		pSampleRequestQAWorksheet.Spec172,
		pSampleRequestQAWorksheet.Spec173,
		pSampleRequestQAWorksheet.Spec174,
		pSampleRequestQAWorksheet.Spec175,
		pSampleRequestQAWorksheet.Spec176,
		pSampleRequestQAWorksheet.Spec177,
		pSampleRequestQAWorksheet.Spec178,
		pSampleRequestQAWorksheet.Spec179,		

		pSampleRequestQAWorksheet.Ask018,
		pSampleRequestQAWorksheet.Spec180,
		pSampleRequestQAWorksheet.Spec181,
		pSampleRequestQAWorksheet.Spec182,
		pSampleRequestQAWorksheet.Spec183,
		pSampleRequestQAWorksheet.Spec184,
		pSampleRequestQAWorksheet.Spec185,
		pSampleRequestQAWorksheet.Spec186,
		pSampleRequestQAWorksheet.Spec187,
		pSampleRequestQAWorksheet.Spec188,
		pSampleRequestQAWorksheet.Spec189,		

		pSampleRequestQAWorksheet.Ask019,
		pSampleRequestQAWorksheet.Spec190,
		pSampleRequestQAWorksheet.Spec191,
		pSampleRequestQAWorksheet.Spec192,
		pSampleRequestQAWorksheet.Spec193,
		pSampleRequestQAWorksheet.Spec194,
		pSampleRequestQAWorksheet.Spec195,
		pSampleRequestQAWorksheet.Spec196,
		pSampleRequestQAWorksheet.Spec197,
		pSampleRequestQAWorksheet.Spec198,
		pSampleRequestQAWorksheet.Spec199,		
	

		pSampleRequestQAWorksheet.CDate, pSampleRequestQAWorksheet.CUser, pSampleRequestQAWorksheet.MDate, 
		pSampleRequestQAWorksheet.MUser, pSampleRequestQAWorksheet.Change, pSampleRequestQAWorksheet.Sort, pPOMLibrary.HowToMeasurText, 
		pPOMLibrary.HowToMeasurImage 
		FROM  pSampleRequestQAWorksheet LEFT OUTER JOIN 
		pPOMLibrary ON pSampleRequestQAWorksheet.POMLibraryID = pPOMLibrary.POMLibraryID 
		WHERE pSampleRequestQAWorksheet.StyleID = @StyleID
		AND pSampleRequestQAWorksheet.StyleSet = @StyleSet
		AND pSampleRequestQAWorksheet.SampleRequestTradeID = @SampleRequestTradeID
		AND pSampleRequestQAWorksheet.SampleRequestWorkflowID = @SampleRequestWorkflowID
		AND pSampleRequestQAWorksheet.SampleWorkflowID = @SampleWorkflowID
		AND pSampleRequestQAWorksheet.Submit = @Submit
		ORDER BY pSampleRequestQAWorksheet.Sort, pSampleRequestQAWorksheet.POM, pSampleRequestQAWorksheet.PointMeasur 





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialRequestContentPopup_DELETE]'
GO
CREATE PROCEDURE [dbo].[spx_MaterialRequestContentPopup_DELETE]
(@MaterialContentID uniqueidentifier)
AS 

	BEGIN
		
		DELETE FROM  pMaterialRequestContent WHERE MaterialContentID = @MaterialContentID
	
	END


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_ImageCatalogItemStatus_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_ImageCatalogItemStatus_INSERT]
(@ImageCatalogID uniqueidentifier,
@ImageCatalogItemID uniqueidentifier,
@ImageID uniqueidentifier,
@TeamID uniqueidentifier,
@CreatedBy nvarchar(100),
@CreatedDate nvarchar(100),
@ImageCatalogStatusDate nvarchar(100),
@ImageCatalogStatusID uniqueidentifier)

AS


IF (SELECT COUNT(*)  FROM pImageCatalogItemStatus WITH (NOLOCK) WHERE TeamID = @TeamID AND ImageCatalogItemID = @ImageCatalogItemID)  = 0

	BEGIN
		 INSERT INTO pImageCatalogItemStatus
                    	  (ImageCatalogStatusID,ImageCatalogItemID, ImageCatalogID, ImageID, ImageCatalogStatusDate, TeamID, CUser, CDate, MUser, MDate)
		VALUES     (@ImageCatalogStatusID,@ImageCatalogItemID, @ImageCatalogID,@ImageID, @ImageCatalogStatusDate, @TeamID, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate)
	END

ELSE

               BEGIN

                                 UPDATE dbo.pImageCatalogItemStatus
                                 SET  ImageCatalogStatusDate = @ImageCatalogStatusDate, 
                                 MUser = @CreatedBy, 
                                 MDate = @CreatedDate
                                 WHERE  (ImageCatalogItemID = @ImageCatalogItemID) AND (TeamID = @TeamID)
               END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleImageItem_Linked_DELETE]'
GO
CREATE PROCEDURE [dbo].[spx_StyleImageItem_Linked_DELETE]
(
	@StyleImageItemID uniqueidentifier
)

AS 


/************************/
/*Declare variables.	*/
/************************/
DECLARE @StyleImageItemID_Param UNIQUEIDENTIFIER		--Keep a copy of the original parameter value.

DECLARE @StyleID UNIQUEIDENTIFIER
DECLARE @StyleSet INT
DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @ImageID UNIQUEIDENTIFIER
DECLARE @ImageVersion INT

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleImageItemID_Param = @StyleImageItemID


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	,StyleImageItemID UNIQUEIDENTIFIER
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleID' and 'StyleSet' of the calling Style.*/
SELECT @StyleID = StyleID
	,@StyleSet = StyleSet
FROM pStyleImageItem
WHERE StyleImageItemID = @StyleImageItemID_Param


/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleImageItem_DELETE @StyleImageItemID_Param

	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Clear variables.*/
		SET @ImageID = NULL
		SET @ImageVersion = NULL


		/*Get the 'ImageID' and 'ImageVersion' values of the calling Style.*/
		SELECT @ImageID = ImageID
			,@ImageVersion = ImageVersion
		FROM pStyleImageItem
		WHERE StyleImageItemID = @StyleImageItemID_Param


		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID


		/*Get and set the counts for the Multi-Cloth linked Styles.*/
		SELECT @TotalCount = COUNT(*) FROM #temp_Linked
		SET @RowCounter = 1


		/*Get the 'StyleImageItemID' of the Image for each of the Multi-Cloth linked Styles.*/
		WHILE(@RowCounter <= @TotalCount)
			BEGIN
				/*Clear variables.*/
				SET @StyleID = NULL
				SET @StyleSet = NULL
				SET @StyleImageItemID = NULL


				/*Get 'StyleID'.*/
				SELECT @StyleID = StyleID
					,@StyleSet = StyleSet
				FROM #temp_Linked
				WHERE TableRow = @RowCounter


				/*Get the 'StyleImageItemID'.*/
				SELECT @StyleImageItemID = StyleImageItemID
				FROM pStyleImageItem
				WHERE StyleID = @StyleID
					AND StyleSet = @StyleSet
					AND ImageID = @ImageID
					AND ImageVersion = @ImageVersion


				/*Update the temp table with the 'StyleImageItemID'.*/
				UPDATE #temp_Linked
				SET StyleImageItemID = @StyleImageItemID
				WHERE TableRow = @RowCounter


				/*Up row counter.*/
				SET @RowCounter = @RowCounter + 1
			END
	END


/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @StyleImageItemID = NULL


		/*Get the 'StyleID' for the delete.*/
		SELECT @StyleImageItemID = StyleImageItemID
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleImageItem_DELETE @StyleImageItemID


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanningMenu_SELECTED]'
GO



ALTER PROCEDURE [dbo].[spx_LinePlanningMenu_SELECTED]
(
@LinePlanId varchar(40)
)
AS 

SET NOCOUNT ON;

BEGIN



DECLARE @LinePlanLevel INTEGER
--SET @LinePlanLevel = (SELECT COUNT(*) FROM pLinePlanTemplateItem)

SELECT @LinePlanLevel = COUNT(*)
FROM pLinePlan a
INNER JOIN pLinePlanTemplateItem b ON a.LinePlanTemplateID = b.LinePlanTemplateID 
WHERE LinePlanID = @LinePlanId 


SELECT  pLinePlanAttributeItem.LinePlanAttributeItemID, pLinePlanAttributeItem.LinePlanAttributeItemParentID, pLinePlanAttributeItem.LinePlanAttributeID, 
      pLinePlanAttributeItem.LinePlanTemplateID, pLinePlanAttributeItem.LinePlanTemplateItemID, pLinePlanAttributeItem.LinePlanId, 
      pLinePlanAttributeItem.LinePlanAttributeText, pLinePlanAttributeItem.LinePlanAttributeValue, pLinePlanAttributeItem.CUser, 
      pLinePlanAttributeItem.CDate, pLinePlanAttributeItem.MUser, pLinePlanAttributeItem.MDate, pLinePlanAttributeItem.Sort,
	  CAST(pLinePlanTemplateItem.LinePlanTemplateItemSort AS INT) AS LinePlanTemplateItemSort, @LinePlanLevel AS LinePlanLevel	
FROM pLinePlanAttributeItem WITH (NOLOCK) INNER JOIN
      pLinePlanTemplateItem WITH (NOLOCK) ON pLinePlanAttributeItem.LinePlanTemplateItemID = pLinePlanTemplateItem.LinePlanTemplateItemID
WHERE  (pLinePlanAttributeItem.LinePlanId = @LinePlanId)
ORDER BY pLinePlanTemplateItem.LinePlanTemplateItemSort, pLinePlanAttributeItem.Sort


END















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pMaterialSize]'
GO
ALTER TABLE [dbo].[pMaterialSize] ALTER COLUMN [MaterialSizeID] [uniqueidentifier] NOT NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pMaterialSize] ALTER COLUMN [MaterialSizeID] ADD ROWGUIDCOL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialRequestContentPopup_SELECT]'
GO


CREATE PROCEDURE [dbo].[spx_MaterialRequestContentPopup_SELECT]
(
	@MaterialTradePartnerID uniqueidentifier,
	@MaterialID uniqueidentifier,
	@CreatedBy nvarchar(200),
	@CreatedDate datetime
)
AS 

DELETE FROM  dbo.pMaterialRequestContent  WHERE MaterialTradePartnerID = @MaterialTradePartnerID AND MaterialID = @MaterialID AND MaterialContentPerc < 0 

IF (SELECT COUNT(*) FROM  pMaterialRequestContent WITH (NOLOCK) WHERE MaterialTradePartnerID = @MaterialTradePartnerID AND MaterialID = @MaterialID) = 0
	BEGIN
		INSERT INTO pMaterialRequestContent
			(MaterialTradePartnerID, MaterialId, MaterialContentPerc, MaterialContentCode)
		VALUES (@MaterialTradePartnerID, @MaterialId, 100, 0)
		
--		SELECT MaterialContentId, MaterialId, MaterialContentCode, MaterialContentPerc, MaterialContentName, CDate, CUser, MDate, MUser
--		FROM  pMaterialContent WITH (NOLOCK) WHERE MaterialID = @MaterialID ORDER BY MaterialContentPerc DESC
	END
ELSE
	BEGIN
	
		DECLARE @ContentPerc decimal(18,0)	
		DECLARE @ContentPercTemp decimal(18,0)	

		-- Delete negative values  
		DELETE FROM  pMaterialRequestContent WHERE MaterialTradePartnerID = @MaterialTradePartnerID AND MaterialID = @MaterialID  
		AND ( MaterialContentPerc IS NULL OR MaterialContentPerc <=0 ) 

		SET @ContentPerc = (SELECT SUM(MaterialContentPerc) FROM  pMaterialRequestContent WITH (NOLOCK) WHERE MaterialTradePartnerID = @MaterialTradePartnerID AND MaterialID = @MaterialID)

			IF @ContentPerc >  100
			BEGIN 


				DECLARE @Rows  INT 
				DECLARE @Current INT 
				DECLARE @MaterialContentId  UNIQUEIDENTIFIER  
				DECLARE @MaterialContentPerc  INT 
				DECLARE @Total INT 

				CREATE TABLE #tmpMaterialContent (
					Rec_ID  INT IDENTITY (1,1),
					MaterialContentId UNIQUEIDENTIFIER  , 
					MaterialContentPerc INT
				)

				INSERT INTO #tmpMaterialContent  ( MaterialContentId , MaterialContentPerc )
				SELECT MaterialContentId , MaterialContentPerc 
				FROM  pMaterialRequestContent WITH (NOLOCK) WHERE MaterialTradePartnerID = @MaterialTradePartnerID AND MaterialID = @MaterialID ORDER BY MaterialContentPerc DESC
			
				SET @Total   = 0 
				SET @Current = 1 
				SELECT @Rows  = COUNT (*)  FROM  #tmpMaterialContent

				WHILE @Current <= @Rows 
				BEGIN

					SELECT @MaterialContentId  = MaterialContentId , @MaterialContentPerc  = MaterialContentPerc 
					FROM #tmpMaterialContent  
					WHERE  Rec_ID =  @Current 
					

					IF  @Total + @MaterialContentPerc   > 100 
					BEGIN
						-- DELETE RECORDS 
						DELETE FROM pMaterialRequestContent
						WHERE  MaterialContentId = @MaterialContentId
					
					END 
					ELSE
					BEGIN
						SET @Total   =  @Total  + @MaterialContentPerc
					END 
					
					SET @Current  = @Current + 1 
				END 
				
				DROP TABLE #tmpMaterialContent
				

				SET @ContentPercTemp = 100 - ISNULL(@Total,0)
				IF @ContentPercTemp > 0 
				BEGIN
					INSERT INTO pMaterialRequestContent(MaterialTradePartnerID, MaterialId, MaterialContentPerc, MaterialContentCode)
					VALUES (@MaterialTradePartnerID, @MaterialId, @ContentPercTemp, 0)
				END 
					

			END
		ELSE 
			BEGIN 
				
				IF @ContentPerc <> 100 
				BEGIN 
					SET @ContentPercTemp = 100 - ISNULL(@ContentPerc,0)
					INSERT INTO pMaterialRequestContent(MaterialTradePartnerID, MaterialId, MaterialContentPerc, MaterialContentCode)
					VALUES (@MaterialTradePartnerID, @MaterialId, @ContentPercTemp, 0)	
				END 

			END

			SELECT IDENTITY(int, 1,1) AS ID_Num,MaterialContentId, MaterialTradePartnerID, MaterialId, MaterialContentCode, MaterialContentPerc, MaterialContentName, CDate, CUser, MDate, MUser
			INTO #tmpContent
			FROM  pMaterialRequestContent WITH (NOLOCK) 
			WHERE MaterialTradePartnerID = @MaterialTradePartnerID AND MaterialID = @MaterialID
			AND MaterialContentCode <> '0'
			ORDER BY MaterialContentPerc DESC , MaterialContentName


			insert into  #tmpContent 
			SELECT MaterialContentId, MaterialTradePartnerID, MaterialId, MaterialContentCode, MaterialContentPerc, MaterialContentName, CDate, CUser, MDate, MUser
			FROM  pMaterialRequestContent WITH (NOLOCK) 
			WHERE MaterialTradePartnerID = @MaterialTradePartnerID AND MaterialID = @MaterialID
			AND MaterialContentCode = '0'
			ORDER BY MaterialContentPerc DESC , MaterialContentName

			select * from #tmpContent 
			order by ID_NUM 

			drop table #tmpContent 


		
	END






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_ImageCatalogItemStatus_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_ImageCatalogItemStatus_SELECT](@ImageCatalogID uniqueidentifier,
@TeamID uniqueidentifier)
AS SELECT     dbo.pImage.ImageDescription, dbo.pImage.ImageLocation, dbo.pImage.ImageFile, dbo.pImageCatalogItem.ImageID, 
                      dbo.pImageCatalogItem.ImageVersion, dbo.pImageCatalogItem.ImageSort, dbo.pImageCatalogItem.ImageCatalogItemID, 
                      dbo.pImageCatalogItem.ImageCatalogID, dbo.pImageCatalogTeam.TeamID
FROM         dbo.pImage WITH (NOLOCK) INNER JOIN
                      dbo.pImageCatalogItem WITH (NOLOCK) ON dbo.pImage.ImageID = dbo.pImageCatalogItem.ImageID INNER JOIN
                      dbo.pImageCatalogTeam WITH (NOLOCK) ON dbo.pImageCatalogItem.ImageCatalogID = dbo.pImageCatalogTeam.ImageCatalogID
WHERE     (dbo.pImageCatalogItem.ImageCatalogID = @ImageCatalogID) AND (dbo.pImageCatalogTeam.TeamID = @TeamID)
ORDER BY dbo.pImageCatalogItem.ImageSort, pImage.ImageNo



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleImageItem_Linked_INSERT]'
GO
CREATE PROCEDURE [dbo].[spx_StyleImageItem_Linked_INSERT]
(
	@StyleImageItemID uniqueidentifier,
	@WorkflowID uniqueidentifier,
	@StyleID uniqueidentifier,
	@StyleSet int,
	@ImageID uniqueidentifier,
	@ImageVersion int,
	@CreatedBy nvarchar(100),
	@CreatedDate datetime
)

AS 


/************************/
/*Declare variables.	*/
/************************/
DECLARE @StyleImageItemID_Param UNIQUEIDENTIFIER		--Keep a copy of the original parameter value.
DECLARE @StyleID_Param UNIQUEIDENTIFIER					--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT								--Keep a copy of the original parameter value.


DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleImageItemID_Param = @StyleImageItemID
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	,StyleImageItemID UNIQUEIDENTIFIER
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleImageItem_INSERT
			@StyleImageItemID_Param
			,@WorkflowID
			,@StyleID_Param
			,@StyleSet_Param
			,@ImageID
			,@ImageVersion
			,@CreatedBy
			,@CreatedDate
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Put a copy of the original Style in the temp table first.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet
			,StyleImageItemID)
		SELECT
			@StyleID_Param AS StyleID
			,@StyleLinkID
			,@StyleSet_Param AS StyleSet
			,@StyleImageItemID_Param AS StyleImageItemID


		/*Get the other Styles that are Multi-Cloth linked to this one.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet
			,StyleImageItemID)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet_Param AS StyleSet
			,NEWID() AS StyleImageItemID
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID
			AND StyleID <> @StyleID_Param
	END


/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @StyleImageItemID = NULL
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Get the 'StyleID' for the insert.*/
		SELECT @StyleImageItemID = StyleImageItemID
			,@StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleImageItem_INSERT
			@StyleImageItemID
			,@WorkflowID
			,@StyleID
			,@StyleSet
			,@ImageID
			,@ImageVersion
			,@CreatedBy
			,@CreatedDate


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Style_DesignDetail_Image_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.
*/


ALTER        PROCEDURE [dbo].[rpx_Style_DesignDetail_Image_SELECT] 	 
	@StyleID varchar(255),	
	@StyleSet As int
AS


--/************/
--/*Testing.	*/
--/************/
--BEGIN
--	DECLARE @StyleID varchar(255)
--	DECLARE @StyleSet As int

--	SET @StyleID = '6151b1a3-cedd-4a4b-bf98-0bf8ed6785d8'
--	SET @StyleSet = 1
--END


--Comment #01
SELECT	identity(int,0,1) as RowNumber,
	dbo.fnx_GetStreamingImagePath(si.ImageID, si.ImageVersion) AS FilePath,
	CAST(hi.ImageDescription AS varchar(255)) AS ImageDescription
INTO	#tblTemp
FROM	pStyleImageItem si, hImage hi 
WHERE	((si.ImageID = hi.ImageID) AND
	(si.ImageVersion = hi.Version) AND
	(si.StyleSet = @StyleSet) AND
	(si.StyleID = @StyleID))
ORDER BY si.Sort, si.ImageID ASC

SELECT	RowNumber % 1 AS RowNumber,
	FilePath,
	ImageDescription
FROM	#tblTemp

/*Drop temp table.*/
DROP TABLE #tblTemp
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pColorType]'
GO
ALTER TABLE [dbo].[pColorType] ADD
[CorpColor] [int] NOT NULL CONSTRAINT [DF_pColorType_CorpColor] DEFAULT ((0)),
[ColorLibraryTypeID] [uniqueidentifier] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pColorType] ALTER COLUMN [Sort] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[pColorType] ALTER COLUMN [Active] [int] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanNonApparelCheck_SELECT]'
GO



CREATE PROCEDURE [dbo].[spx_LinePlanNonApparelCheck_SELECT] (
	@StyleTypeID INT 
)
AS

SELECT StyleNonApparel FROM pStyleType WHERE StyleTypeID = @StyleTypeID




















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_SampleRequestQAWorksheetLinked_SELECT]'
GO


CREATE PROCEDURE [dbo].[spx_SampleRequestQAWorksheetLinked_SELECT] (
	@StyleID uniqueidentifier, 
	@StyleSet int,
	@SampleRequestTradeID uniqueidentifier,
	@SampleRequestWorkflowID uniqueidentifier,
	@SampleWorkflowID varchar (50) ,
	@Submit int
)
AS 

BEGIN

	SELECT SampleRequestQAWorksheetID, SampleRequestQAWorksheetSizeID, SampleRequestTradeID, SampleRequestWorkflowID, SampleWorkflowID, TradePartnerVendorID,
		WorkflowID, SpecMasterID, pSampleRequestQAWorksheet.POMTempItemID, pSampleRequestQAWorksheet.POMLibraryID, ModelSpecID, ModelID, POMTempID, StyleID, StyleColorID, Submit, Critical, SpecID, StyleSet, pSampleRequestQAWorksheet.POM, 
		pSampleRequestQAWorksheet.PointMeasur, TOL, TOLN,      
		pSampleRequestQAWorksheet.CDate, pSampleRequestQAWorksheet.CUser, pSampleRequestQAWorksheet.MDate, 
		pSampleRequestQAWorksheet.MUser, pSampleRequestQAWorksheet.Change, pSampleRequestQAWorksheet.Sort, pPOMLibrary.HowToMeasurText, 
		pPOMLibrary.HowToMeasurImage
	FROM  pSampleRequestQAWorksheet LEFT OUTER JOIN
		pPOMLibrary ON pSampleRequestQAWorksheet.POMLibraryID = pPOMLibrary.POMLibraryID
	WHERE pSampleRequestQAWorksheet.StyleID = @StyleID
		AND  pSampleRequestQAWorksheet.StyleSet = @StyleSet
		AND pSampleRequestQAWorksheet.SampleRequestTradeID = @SampleRequestTradeID
		AND pSampleRequestQAWorksheet.SampleRequestWorkflowID = @SampleRequestWorkflowID
		AND pSampleRequestQAWorksheet.SampleWorkflowID = @SampleWorkflowID
		AND pSampleRequestQAWorksheet.Submit = @Submit
		AND POMTempID IS NOT NULL
	ORDER BY pSampleRequestQAWorksheet.Sort, pSampleRequestQAWorksheet.POM, pSampleRequestQAWorksheet.PointMeasur

END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleColorway_LinePlanSelected_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - October 29, 2009
	Modified the select to show not only the color name, but also the
color code.
*/


ALTER PROCEDURE [dbo].[spx_StyleColorway_LinePlanSelected_SELECT](
@StyleID UNIQUEIDENTIFIER,
@SeasonYearID UNIQUEIDENTIFIER
)
AS

DECLARE @LinePlanItemID UNIQUEIDENTIFIER 
DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER 
DECLARE @LinePlanStyleRangeID UNIQUEIDENTIFIER 
DECLARE @LinePlanColorRangeID UNIQUEIDENTIFIER 
DECLARE @LinePlanAttributeItemID1 UNIQUEIDENTIFIER 
DECLARE @LinePlanAttributeItemID2 UNIQUEIDENTIFIER 
DECLARE @LinePlanAttributeItemID3 UNIQUEIDENTIFIER 


SELECT  @LinePlanItemID = LinePlanItemID, @StyleSeasonYearID = StyleSeasonYearID 
FROM pStyleSeasonYear
WHERE StyleID = @StyleID
AND SeasonYearID = @SeasonYearID



SELECT @LinePlanStyleRangeID = LinePlanRangeID 
FROM pLinePlanItem where LinePlanItemId = @LinePlanItemID


SELECT @LinePlanAttributeItemID1 = LinePlanAttributeItemID1, 
@LinePlanAttributeItemID2 = LinePlanAttributeItemID2, 
@LinePlanAttributeItemID3 = LinePlanAttributeItemID3
FROM pLinePlanRange 
WHERE LinePlanRangeID = @LinePlanStyleRangeID


SELECT @LinePlanColorRangeID  = LinePlanRangeID 
FROM pLinePlanRange 
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000002'
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3


SELECT c.ColorPaletteID
	,c.ColorCode
	,c.ColorName + ' (' + c.ColorCode + ')' AS ColorName		--Comment #01
FROM pStyleColorwaySeasonYear a
INNER JOIN pStyleColorway b ON a.StyleColorwayID =  b.StyleColorID 
INNER JOIN pColorpalette c ON c.ColorPaletteID = b.ColorPaletteID 
WHERE a.StyleSeasonYearID = @StyleSeasonYearID
Order BY c.ColorName









GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_ImageCatalogTeam_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_ImageCatalogTeam_INSERT]
(@TeamID uniqueidentifier,
@ImageCatalogID uniqueidentifier,
@TradePartner nvarchar(50))

	AS 


	IF (SELECT COUNT(*)  FROM pImageCatalogTeam WITH (NOLOCK) WHERE TeamID = @TeamID AND ImageCatalogID = @ImageCatalogID )  = 0

	BEGIN

	INSERT INTO dbo.pImageCatalogTeam
    (TeamID, ImageCatalogID,ImageCatalogStatus, TradePartner)
	VALUES (@TeamID, @ImageCatalogID, N'In Preparation', @TradePartner)

	INSERT INTO dbo.pImageCatalogItemStatus
	(ImageCatalogID, ImageCatalogStatus, TeamID, ImageCatalogItemID, ImageID)
	SELECT dbo.pImageCatalogTeam.ImageCatalogID, 'In Preparation' AS ImageCatalogStatus, dbo.pImageCatalogTeam.TeamID, 
	dbo.pImageCatalogItem.ImageCatalogItemID, dbo.pImageCatalogItem.ImageID
	FROM dbo.pImageCatalogTeam WITH (NOLOCK) INNER JOIN
	dbo.pImageCatalogItem WITH (NOLOCK) ON dbo.pImageCatalogTeam.ImageCatalogID = dbo.pImageCatalogItem.ImageCatalogID
	WHERE dbo.pImageCatalogTeam.TeamID = @TeamID AND dbo.pImageCatalogTeam.ImageCatalogID = @ImageCatalogID

	END




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pMaterialCoreItem]'
GO
ALTER TABLE [dbo].[pMaterialCoreItem] ADD
[MaterialCoreItemCopyID] [uniqueidentifier] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleImageItem_Linked_LINK]'
GO
CREATE   PROCEDURE [dbo].[spx_StyleImageItem_Linked_LINK]
(
	@StyleImageItemID uniqueidentifier,
	@StyleID uniqueidentifier,
	@StyleSet int,
	@CopyStyleID nvarchar(50),
	@CopyStyleSet nvarchar(50),
	@WorkflowID nvarchar(50)
)

AS 


/************************/
/*Declare variables.	*/
/************************/
DECLARE @StyleID_Param UNIQUEIDENTIFIER			--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT						--Keep a copy of the original parameter value.

DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleImageItem_LINK
			@StyleImageItemID
			,@StyleID_Param
			,@StyleSet_Param
			,@CopyStyleID
			,@CopyStyleSet
			,@WorkflowID
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet_Param AS StyleSet
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID
	END

/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Get the 'StyleID' for the insert.*/
		SELECT @StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleImageItem_LINK
			@StyleImageItemID
			,@StyleID
			,@StyleSet
			,@CopyStyleID
			,@CopyStyleSet
			,@WorkflowID


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanRange_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_LinePlanRange_SELECT](
@LinePlanAttributeItemID1 VARCHAR(40),
@LinePlanAttributeItemID2 VARCHAR(40),
@LinePlanAttributeItemID3 VARCHAR(40),
@LinePlanAttributeItemID4 VARCHAR(40)
)
AS

IF @LinePlanAttributeItemID4 IS NULL 
	BEGIN
	SELECT LinePlanRangeID, LinePlanFinancialID
	FROM pLinePlanRange
	WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
		AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
		AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
		
	END
ELSE IF @LinePlanAttributeItemID3 IS NULL 
	BEGIN
	SELECT LinePlanRangeID, LinePlanFinancialID
	FROM pLinePlanRange
	WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
		AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
		
	END
ELSE IF @LinePlanAttributeItemID2 IS NULL 
	BEGIN
	SELECT LinePlanRangeID, LinePlanFinancialID
	FROM pLinePlanRange
	WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
		
	END
ELSE  
	BEGIN
	SELECT LinePlanRangeID, LinePlanFinancialID
	FROM pLinePlanRange
	WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
		AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
		AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
		AND (LinePlanAttributeItemID4 = @LinePlanAttributeItemID4)
		
	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pMaterialCoreColorItem]'
GO
CREATE TABLE [dbo].[pMaterialCoreColorItem]
(
[MaterialCoreColorItemID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_pMaterialCoreColorItem_MaterialCoreColorItemID] DEFAULT (newsequentialid()),
[MaterialCoreColorItemMasterID] [uniqueidentifier] NULL,
[MaterialCoreColorID] [uniqueidentifier] NULL,
[MaterialCoreItemID] [uniqueidentifier] NULL,
[MaterialCoreID] [uniqueidentifier] NULL,
[MaterialID] [uniqueidentifier] NOT NULL,
[MaterialColorID] [uniqueidentifier] NULL,
[CDate] [datetime] NULL,
[CUser] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[MUser] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MaterialCoreColorItemCopyID] [uniqueidentifier] NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pMaterialCoreColorItem] on [dbo].[pMaterialCoreColorItem]'
GO
ALTER TABLE [dbo].[pMaterialCoreColorItem] ADD CONSTRAINT [PK_pMaterialCoreColorItem] PRIMARY KEY CLUSTERED  ([MaterialCoreColorItemID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pMaterialCoreColor]'
GO
CREATE TABLE [dbo].[pMaterialCoreColor]
(
[MaterialCoreColorID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_pMaterialCoreColor_MaterialCoreColorID] DEFAULT (newsequentialid()),
[MaterialCoreID] [uniqueidentifier] NULL,
[ColorPaletteID] [uniqueidentifier] NULL,
[ColorCode] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ColorName] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Active] [int] NOT NULL CONSTRAINT [DF_pMaterialCoreColor_Active] DEFAULT ((1)),
[Sort] [varchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pMaterialCoreColor] on [dbo].[pMaterialCoreColor]'
GO
ALTER TABLE [dbo].[pMaterialCoreColor] ADD CONSTRAINT [PK_pMaterialCoreColor] PRIMARY KEY CLUSTERED  ([MaterialCoreColorID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pMaterialRequestSubmit]'
GO
ALTER TABLE [dbo].[pMaterialRequestSubmit] ADD
[MaterialRequestSubmitGroupID] [uniqueidentifier] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleImageItem_Linked_UPDATE]'
GO
CREATE  PROCEDURE [dbo].[spx_StyleImageItem_Linked_UPDATE]
(
	@ImageID nvarchar(50),
	@ImageVersion nvarchar(50),
	@ModifiedBy nvarchar(50),
	@ModifiedDate nvarchar(50),
	@StyleImageItemID uniqueidentifier
)

AS 


/************************/
/*Declare variables.	*/
/************************/
DECLARE @StyleImageItemID_Param UNIQUEIDENTIFIER		--Keep a copy of the original parameter value.

DECLARE @StyleID UNIQUEIDENTIFIER
DECLARE @StyleSet INT
DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @ImageVersion_Previous INT

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleImageItemID_Param = @StyleImageItemID


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	,StyleImageItemID UNIQUEIDENTIFIER
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleID' and 'StyleSet' of the calling Style.*/
SELECT @StyleID = StyleID
	,@StyleSet = StyleSet
FROM pStyleImageItem
WHERE StyleImageItemID = @StyleImageItemID_Param


/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleImageItem_UPDATE
			@ImageID
			,@ImageVersion
			,@ModifiedBy
			,@ModifiedDate
			,@StyleImageItemID_Param
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Clear variables.*/
		SET @ImageVersion_Previous = NULL


		/*Get the old 'ImageVersion' value of the calling Style.*/
		SELECT @ImageVersion_Previous = ImageVersion
		FROM pStyleImageItem
		WHERE StyleImageItemID = @StyleImageItemID_Param


		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID


		/*Get and set the counts for the Multi-Cloth linked Styles.*/
		SELECT @TotalCount = COUNT(*) FROM #temp_Linked
		SET @RowCounter = 1


		/*Get the 'StyleImageItemID' of the Image for each of the Multi-Cloth linked Styles.*/
		WHILE(@RowCounter <= @TotalCount)
			BEGIN
				/*Clear variables.*/
				SET @StyleID = NULL
				SET @StyleSet = NULL
				SET @StyleImageItemID = NULL


				/*Get 'StyleID'.*/
				SELECT @StyleID = StyleID
					,@StyleSet = StyleSet
				FROM #temp_Linked
				WHERE TableRow = @RowCounter


				/*Get the 'StyleImageItemID'.*/
				SELECT @StyleImageItemID = StyleImageItemID
				FROM pStyleImageItem
				WHERE StyleID = @StyleID
					AND StyleSet = @StyleSet
					AND ImageID = @ImageID
					AND ImageVersion = @ImageVersion_Previous


				/*Update the temp table with the 'StyleImageItemID'.*/
				UPDATE #temp_Linked
				SET StyleImageItemID = @StyleImageItemID
				WHERE TableRow = @RowCounter


				/*Up row counter.*/
				SET @RowCounter = @RowCounter + 1
			END
	END


/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @StyleImageItemID = NULL


		/*Get the 'StyleID' for the delete.*/
		SELECT @StyleImageItemID = StyleImageItemID
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleImageItem_UPDATE
			@ImageID
			,@ImageVersion
			,@ModifiedBy
			,@ModifiedDate
			,@StyleImageItemID


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanRangeFromItem_SELECT]'
GO
CREATE PROCEDURE [dbo].[spx_LinePlanRangeFromItem_SELECT] ( 
@LinePlanItemID UNIQUEIDENTIFIER 
) 
AS 

DECLARE @LinePlanAttributeItemID1 UNIQUEIDENTIFIER  
DECLARE @LinePlanAttributeItemID2 UNIQUEIDENTIFIER  
DECLARE @LinePlanAttributeItemID3 UNIQUEIDENTIFIER  
DECLARE @LinePlanAttributeItemID4 UNIQUEIDENTIFIER  
DECLARE @LinePlanID UNIQUEIDENTIFIER  

SELECT @LinePlanID = b1.LinePlanID,
@LinePlanAttributeItemID1 = b1.LinePlanAttributeItemID1,
@LinePlanAttributeItemID2 = b1.LinePlanAttributeItemID2,
@LinePlanAttributeItemID3 = b1.LinePlanAttributeItemID3,
@LinePlanAttributeItemID4 = b1.LinePlanAttributeItemID4
from pLinePlanItem a1
INNER JOIN pLinePlanRange  b1  ON a1.LinePlanRangeID =  b1.LinePlanRangeID 
WHERE a1.LinePlanItemID = @LinePlanItemID

SELECT LinePlanRangeID , LinePlanFinancialID   FROM pLinePlanRange 
WHERE LinePlanID = @LinePlanID 
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleImageItemUnlinked_Linked_UPDATE]'
GO
CREATE PROCEDURE [dbo].[spx_StyleImageItemUnlinked_Linked_UPDATE]
(
	@StyleImageItemID uniqueidentifier,
	@ModifiedBy nvarchar(200),
	@ModifiedDate datetime
)

AS 


/************************/
/*Declare variables.	*/
/************************/
DECLARE @StyleImageItemID_Param UNIQUEIDENTIFIER		--Keep a copy of the original parameter value.

DECLARE @StyleID UNIQUEIDENTIFIER
DECLARE @StyleSet INT
DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @ImageID UNIQUEIDENTIFIER
DECLARE @ImageVersion INT

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleImageItemID_Param = @StyleImageItemID


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	,StyleImageItemID UNIQUEIDENTIFIER
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleID' and 'StyleSet' of the calling Style.*/
SELECT @StyleID = StyleID
	,@StyleSet = StyleSet
FROM pStyleImageItem
WHERE StyleImageItemID = @StyleImageItemID_Param


/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleImageItemUnlinked_UPDATE
			@StyleImageItemID_Param
			,@ModifiedBy
			,@ModifiedDate
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Clear variables.*/
		SET @ImageID = NULL
		SET @ImageVersion = NULL


		/*Get the 'ImageID' and 'ImageVersion' values of the calling Style.*/
		SELECT @ImageID = ImageID
			,@ImageVersion = ImageVersion
		FROM pStyleImageItem
		WHERE StyleImageItemID = @StyleImageItemID_Param


		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID


		/*Get and set the counts for the Multi-Cloth linked Styles.*/
		SELECT @TotalCount = COUNT(*) FROM #temp_Linked
		SET @RowCounter = 1


		/*Get the 'StyleImageItemID' of the Image for each of the Multi-Cloth linked Styles.*/
		WHILE(@RowCounter <= @TotalCount)
			BEGIN
				/*Clear variables.*/
				SET @StyleID = NULL
				SET @StyleSet = NULL
				SET @StyleImageItemID = NULL


				/*Get 'StyleID'.*/
				SELECT @StyleID = StyleID
					,@StyleSet = StyleSet
				FROM #temp_Linked
				WHERE TableRow = @RowCounter


				/*Get the 'StyleImageItemID'.*/
				SELECT @StyleImageItemID = StyleImageItemID
				FROM pStyleImageItem
				WHERE StyleID = @StyleID
					AND StyleSet = @StyleSet
					AND ImageID = @ImageID
					AND ImageVersion = @ImageVersion


				/*Update the temp table with the 'StyleImageItemID'.*/
				UPDATE #temp_Linked
				SET StyleImageItemID = @StyleImageItemID
				WHERE TableRow = @RowCounter


				/*Up row counter.*/
				SET @RowCounter = @RowCounter + 1
			END
	END


/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @StyleImageItemID = NULL


		/*Get the 'StyleID' for the delete.*/
		SELECT @StyleImageItemID = StyleImageItemID
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleImageItemUnlinked_UPDATE
			@StyleImageItemID
			,@ModifiedBy
			,@ModifiedDate


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Style_Sourcing_MaterialColorway_SELECT]'
GO



/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.

#02 - Ryan Cabanas - September 23, 2009
	Replace the old color image string with the new color image string using function.
Deleted old code.
*/


ALTER      PROCEDURE [dbo].[rpx_Style_Sourcing_MaterialColorway_SELECT]
(
	@StyleMaterialID nvarchar(255)
)

AS

-- --Test values
-- DECLARE @StyleMaterialID nvarchar(255)
-- SET @StyleMaterialID = '3b810db7-ed87-4a09-bc04-23e6bfc06bf8'


--Temp tables
CREATE TABLE #tempMaterials(
	ParentMaterialName varchar(100)
	,ParentMaterialColorChipName varchar(100)
	,ParentMaterialColorChipFilePath varchar(255)
	,SubMaterialName varchar(100)
	,SubMaterialColorChipName varchar(100)
	,SubMaterialColorChipFilePath varchar(255)
	,MaterialLinkID varchar(50)
	,ParentMaterialColorImageID varchar(50)
	,ParentMaterialColorImageVersion int
	,SubMaterialColorImageID varchar(50)
	,SubMaterialColorImageVersion int
)


--Get all materials for the style
INSERT INTO #tempMaterials(
	ParentMaterialName
	,ParentMaterialColorChipName
	,ParentMaterialColorChipFilePath
	,SubMaterialName
	,SubMaterialColorChipName
	,SubMaterialColorChipFilePath
	,MaterialLinkID
	,ParentMaterialColorImageID
	,ParentMaterialColorImageVersion
	,SubMaterialColorImageID
	,SubMaterialColorImageVersion
)
SELECT	pStyleMaterials.MaterialNo + ' - ' + pStyleMaterials.MaterialName AS ParentMaterialName,
	'(' + pMaterialColor.ColorCode + ') ' + pMaterialColor.ColorName AS ParentMaterialColorChipName,
	dbo.fnx_GetStreamingColorImagePath(pMaterialColor.ColorFolderID, pMaterialColor.ColorPaletteID) AS ParentMaterialColorChipFilePath,	--Comment #02
	pMaterial_Subs.MaterialNo + ' - ' + pMaterial_Subs.MaterialName AS SubMaterialName,
	'(' + pMaterialColor_Subs.ColorCode + ') ' + pMaterialColor_Subs.ColorName AS SubMaterialColorChipName,
	dbo.fnx_GetStreamingColorImagePath(pMaterialColor_Subs.ColorFolderID, pMaterialColor_Subs.ColorPaletteID) AS SubMaterialColorChipFilePath,	--Comment #02
	CAST(pMaterialLink.MaterialLinkID AS varchar(50)) AS MaterialLinkID,
	pMaterialColor.MaterialColorImageID AS ParentMaterialColorImageID,
	pMaterialColor.MaterialColorImageVersion AS ParentMaterialColorImageVersion,
	pMaterialColor_Subs.MaterialColorImageID AS SubMaterialColorImageID,
	pMaterialColor_Subs.MaterialColorImageVersion AS SubMaterialColorImageVersion
FROM	pStyleMaterials
	INNER JOIN pMaterial ON	pStyleMaterials.MaterialID = pMaterial.MaterialID
	INNER JOIN pStyleColorwayItem ON	pStyleMaterials.StyleMaterialID = pStyleColorwayItem.StyleMaterialID
	INNER JOIN pMaterialColor ON	pStyleColorwayItem.MaterialColorID = pMaterialColor.MaterialColorID
	INNER JOIN pStyleColorway ON	pStyleColorwayItem.StyleColorID = pStyleColorway.StyleColorID
	INNER JOIN pMaterialLink ON	pStyleMaterials.MaterialID = pMaterialLink.MaterialGroupID
	INNER JOIN pMaterial AS pMaterial_Subs ON	pMaterialLink.MaterialID = pMaterial_Subs.MaterialID
	INNER JOIN pMaterialLinkColorway ON	(pStyleColorwayItem.MaterialID = pMaterialLinkColorway.MaterialGroupID
										AND	pStyleColorwayItem.MaterialColorID = pMaterialLinkColorway.MaterialColorID)
	INNER JOIN pMaterialLinkColorwayItem ON	(pMaterialLinkColorway.MaterialLinkColorwayID = pMaterialLinkColorwayItem.MaterialLinkColorwayID
											AND	pMaterial_Subs.MaterialID = pMaterialLinkColorwayItem.MaterialID
											AND pMaterialLink.MaterialLinkID = pMaterialLinkColorwayItem.MaterialLinkID)
	LEFT OUTER JOIN pMaterialColor AS pMaterialColor_Subs ON	pMaterialLinkColorwayItem.MaterialColorID = pMaterialColor_Subs.MaterialColorID
WHERE	(pStyleMaterials.StyleMaterialID = @StyleMaterialID)
	AND	(pStyleMaterials.Colorway = 1 )
	AND	(pMaterial.MultiDimension = 1)
ORDER BY	pStyleColorway.Sort,
	pStyleColorway.MainColor,
	pMaterial_Subs.MaterialType,
	pMaterial_Subs.MaterialNo,
	pMaterial_Subs.MaterialName

--Update the temp table for the Parent Material chips that are images from the Image folder.
UPDATE #tempMaterials
SET ParentMaterialColorChipFilePath = dbo.fnx_GetStreamingImagePath(hImage.ImageID, hImage.[Version])	--Comment #01
FROM #tempMaterials
	INNER JOIN hImage ON	(#tempMaterials.ParentMaterialColorImageID = hImage.ImageID
							AND #tempMaterials.ParentMaterialColorImageVersion = hImage.Version)

--Update the temp table for the Sub Material chips that are images from the Image folder.
UPDATE #tempMaterials
SET SubMaterialColorChipFilePath = dbo.fnx_GetStreamingImagePath(hImage.ImageID, hImage.[Version])	--Comment #01
FROM #tempMaterials
	INNER JOIN hImage ON	(#tempMaterials.SubMaterialColorImageID = hImage.ImageID
							AND #tempMaterials.SubMaterialColorImageVersion = hImage.Version)

--SELECT the records
SELECT
	ParentMaterialName
	,ParentMaterialColorChipName
	,ParentMaterialColorChipFilePath
	,SubMaterialName
	,SubMaterialColorChipName
	,SubMaterialColorChipFilePath
	,MaterialLinkID
	,*
FROM #tempMaterials

--Drop temp tables
DROP TABLE #tempMaterials





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialRequestSubmitColor_PIVOT]'
GO


ALTER PROCEDURE [dbo].[spx_MaterialRequestSubmitColor_PIVOT](
@MaterialTradePartnerID uniqueidentifier
)
AS 


SELECT f.MaterialTradePartnerColorID, g.MaterialTradePartnerId, j.MaterialID, 
      i.TradePartnerID, h.TradePartnerVendorID, j.MaterialNo, j.MaterialName, 
      e.ColorCode, 
      f.ColorNo, 
      e.ColorName, 
      f.VendorColorCode, f.VendorColorNo, f.VendorColorName, 
      i.TradePartnerName, h.VendorName, c.MaterialRequestWorkflowID,  
	  CAST(a.MaterialRequestSubmitWorkflowID AS VARCHAR(40)) AS MaterialRequestSubmitWorkflowID, 
      --c.GroupName, c.GroupID,
	Case  
		WHEN f.MaterialColorImageID IS NULL  THEN 
			'<TABLE cellSpacing=''0'' cellPadding=''0'' width=''100%'' border=''0''><TR><TD width=''18''> 
			<IMG src=''' + '../System/Control/ColorStream.ashx?S=16&CFID=' + CAST(f.ColorFolderID AS VARCHAR(40)) + 
			'&CPID=' + CAST(f.ColorPaletteID AS VARCHAR(40)) + ''' border=0 ALT=''Open''></TD></TR></TABLE>'
		 ELSE  
			'<TABLE cellSpacing=''0'' cellPadding=''0'' width=''100%'' border=''0''><TR><TD width=''18''> 
			<IMG src=''' + '../System/Control/ImageStream.ashx?S=16&V=' + CAST(f.MaterialColorImageVersion AS VARCHAR(40)) + 
			'&IID=' + CAST(f.MaterialColorImageID AS VARCHAR(40)) + ''' border=0 ALT=''Open''></TD></TR></TABLE>'
	END AS ColorUrl, ISNULL(k.MaterialSize,'*NA') AS MaterialSize 
INTO #tmpMaterialRequestSubmitWorkflow
FROM pMaterialRequestSubmitWorkflow a
INNER JOIN pMaterialTradePartner b ON a.MaterialTradePartnerID = b.MaterialTradePartnerId 
INNER JOIN pMaterialRequestWorkflow c ON c.MaterialRequestWorkflowID = a.MaterialRequestWorkflowID
INNER JOIN pMaterialColor d ON d.MaterialColorID = a.MaterialColorID
INNER JOIN pColorPalette e ON e.ColorPaletteID = d.ColorPaletteID 
INNER JOIN pMaterialTradePartnerColor f ON f.MaterialTradePartnerColorID = a.MaterialTradePartnerColorID
INNER JOIN pMaterialTradePartner g ON g.MaterialTradePartnerId =  f.MaterialTradePartnerID
INNER JOIN uTradePartnerVendor h ON h.TradePartnerVendorID = b.TradepartnerVendorId
INNER JOIN uTradePartner i ON i.TradepartnerId = b.TradePartnerID 
INNER JOIN pMaterial j ON j.MaterialID = a.MaterialID
LEFT OUTER JOIN pMaterialSize k ON k.MaterialSizeID = f.MaterialSizeID
WHERE a.MaterialTradePartnerId = @MaterialTradePartnerId
ORDER BY h.VendorName, e.ColorCode



EXECUTE spx_Crosstab 
'SELECT * FROM #tmpMaterialRequestSubmitWorkflow',
NULL,
NULL,
'MaterialRequestWorkflowID',
'MaterialRequestSubmitWorkflowID',
'MAX'



DROP TABLE #tmpMaterialRequestSubmitWorkflow






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Material_Color_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old color image string with the new color image string using function.
Deleted old code.
*/


ALTER      PROCEDURE [dbo].[rpx_Material_Color_SELECT]
(
	@MaterialID varchar(255) 	
)
AS


DECLARE @TotalCount int
DECLARE @RowCounter int


CREATE TABLE #TempColorPaletteIDs
(
	TableRow int identity(1,1),
	ColorFolderID nvarchar(200),
	ColorPaletteID nvarchar(200),
	ColorName nvarchar(150),
	ColorCode nvarchar(50),
	Sort nvarchar(10)
)

CREATE TABLE #TempColorMatrix
(
	TableRow int identity(0,1),
	FilePath nvarchar(255),
	ColorName nvarchar(150),
	ColorCode nvarchar(50),
	Sort nvarchar(10)
)

INSERT INTO #TempColorPaletteIDs (ColorFolderID, ColorPaletteID, ColorName, ColorCode, Sort)
SELECT ColorFolderID, ColorPaletteID, ColorName, ColorCode, Sort
FROM pMaterialColor
WHERE MaterialID = @MaterialID
ORDER BY Sort, ColorCode, ColorName

SELECT @TotalCount = COUNT(*) FROM #TempColorPaletteIDs
SET @RowCounter = 1

WHILE (@RowCounter <= @TotalCount)
	BEGIN

		INSERT INTO #TempColorMatrix (FilePath, ColorName, ColorCode, Sort)
		SELECT
			dbo.fnx_GetStreamingColorImagePath(ColorFolderID, ColorPaletteID) AS FilePath,	--Comment #01
			ColorName,
			ColorCode,
			Sort
		FROM #TempColorPaletteIDs
		WHERE TableRow = @RowCounter

		SET @RowCounter = @RowCounter + 1
	END

SELECT TableRow % 7 AS [Column], FilePath, ColorName, ColorCode, Sort 
FROM #TempColorMatrix 

DROP TABLE #TempColorPaletteIDs
DROP TABLE #TempColorMatrix






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_LinePlanStyleCarryMaterial_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_LinePlanStyleCarryMaterial_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleColorway_SeasonColor_INSERT]'
GO



ALTER PROCEDURE [dbo].[spx_StyleColorway_SeasonColor_INSERT] (
@ColorPaletteID UNIQUEIDENTIFIER, 
@StyleID UNIQUEIDENTIFIER,
@StyleSet INT,
@SeasonYearID UNIQUEIDENTIFIER,
@AllSizeClasses INT,
@CUser NVARCHAR(200), 
@CDate DATETIME 
)
AS


DECLARE @StyleColorID UNIQUEIDENTIFIER 
DECLARE @StyleSeasonYearID  UNIQUEIDENTIFIER

SELECT @StyleColorID = StyleColorID 
FROM pStyleColorway 
WHERE StyleID = @StyleID  
AND ColorPaletteID = @ColorPaletteID 


SELECT @StyleSeasonYearID = StyleSeasonYearID   
FROM pStyleSeasonYear
WHERE StyleId = @StyleID AND SeasonYearID = @SeasonYearID

IF  (  	SELECT  COUNT(*) 
		FROM pStyleColorwaySeasonYear 
		WHERE StyleSeasonYearID = @StyleSeasonYearID 
		AND StyleColorwayID = @StyleColorID
	) = 0 
BEGIN

	INSERT INTO pStyleColorwaySeasonYear ( StyleColorwaySeasonYearID, StyleSeasonYearID , StyleColorwayID , StyleID,   
		StyleColorDelivery1, StyleColorDelivery2, StyleColorDelivery3, StyleColorDelivery4, StyleColorStatus, Units, ColorType )
	VALUES  ( NEWID(), @StyleSeasonYearID , @StyleColorID , @StyleID,   
		1, 1, 1, 1, 800, 0, 'F')

END 
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleLinePlanCheck_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_StyleLinePlanCheck_SELECT] (
@StyleID UNIQUEIDENTIFIER ,
@SeasonYearID  UNIQUEIDENTIFIER  = NULL 
)
AS 


IF @SeasonYearID IS NOT NULL 
BEGIN
	SELECT  Count(*)  FROM pStyleSeasonYear 
	WHERE StyleID = @StyleID
	AND SeasonYearID  = @SeasonYearID 
	AND LinePlanItemID IS NOT NULL 
END 
ELSE 
BEGIN 
	SELECT  Count(*)  FROM pStyleSeasonYear 
	WHERE StyleID = @StyleID
	AND LinePlanItemID IS NOT NULL 
END 












GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanSeasonYearAvailable_Logic_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_LinePlanSeasonYearAvailable_Logic_SELECT](
@StyleID  UNIQUEIDENTIFIER ,
@SeasonYearID UNIQUEIDENTIFIER
)
AS

DECLARE @Season NVARCHAR(200)
DECLARE @Year NVARCHAR(200)

DECLARE @CustomField2 NVARCHAR(200)
DECLARE @StyleType NVARCHAR(200)
DECLARE @StyleCategory NVARCHAR(200)

SELECT @Season = Season, @Year = Year FROM pSeasonYear WHERE SeasonYearID = @SeasonYearID 


SELECT @StyleType = b.StyleTypeDescription,
@StyleCategory  = c.StyleCategory,
@CustomField2 = a.CustomField2
FROM pStyleHeader a
INNER JOIN pStyleType b ON a.StyleType = b.StyleTypeID
LEFT OUTER JOIN pStyleCategory c ON a.StyleCategory  =  c.StyleCategoryID
WHERE StyleID = @StyleID 



	SELECT DISTINCT a.LinePlanID, b.Description
	FROM pLinePlanRange a
	INNER JOIN pLinePlan b ON a.LinePlanID = b.LinePlanID
	WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'
	AND b.Season = @Season 
	AND b.Year  = @Year 
	AND a.LinePlanAttributeText1 = @CustomField2
	AND a.LinePlanAttributeText2 = @StyleType
	AND a.LinePlanAttributeText3 = @StyleCategory



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pMaterialRequestWorkflowItem]'
GO
ALTER TABLE [dbo].[pMaterialRequestWorkflowItem] ADD
[MaterialRequestWorkflowGroupID] [uniqueidentifier] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_LinePlanItem_SELECT]'
GO
EXEC sp_refreshview N'[dbo].[vwx_LinePlanItem_SELECT]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pTradePartnerVendorRate]'
GO
ALTER TABLE [dbo].[pTradePartnerVendorRate] ADD
[ExchangeRate] [uniqueidentifier] NULL,
[CurrencyType] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pTradePartnerVendorRateItem]'
GO
ALTER TABLE [dbo].[pTradePartnerVendorRateItem] ADD
[Margin] [decimal] (18, 6) NULL CONSTRAINT [DF_pTradePartnerVendorRateItem_Margin] DEFAULT ((0)),
[Commission] [decimal] (18, 6) NULL CONSTRAINT [DF_pTradePartnerVendorRateItem_Commission] DEFAULT ((0))
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pTradePartnerVendorRateItem] ALTER COLUMN [TradePartnerVendorRateItemID] [uniqueidentifier] NOT NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pTradePartnerVendorRateItem] on [dbo].[pTradePartnerVendorRateItem]'
GO
ALTER TABLE [dbo].[pTradePartnerVendorRateItem] ADD CONSTRAINT [PK_pTradePartnerVendorRateItem] PRIMARY KEY CLUSTERED  ([TradePartnerVendorRateItemID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pStyleCostingDuty]'
GO
ALTER TABLE [dbo].[pStyleCostingDuty] ALTER COLUMN [DutyId] DROP ROWGUIDCOL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pStyleCostingDuty] ADD
[CustomID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_pStyleCostingDuty_DutyId] DEFAULT (newid()),
[CustomKey] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL CONSTRAINT [DF_pStyleCostingDuty_CustomKey] DEFAULT (N'IDENTITY(1,1)'),
[CustomSort] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[TempNo] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[TempID] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Custom] [nvarchar] (255) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pStyleCostingDuty] ALTER COLUMN [DutyId] [uniqueidentifier] NOT NULL
ALTER TABLE [dbo].[pStyleCostingDuty] ALTER COLUMN [Active] [int] NOT NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pStyleCostingDuty] on [dbo].[pStyleCostingDuty]'
GO
ALTER TABLE [dbo].[pStyleCostingDuty] ADD CONSTRAINT [PK_pStyleCostingDuty] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_LinePlanTradePartner_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_LinePlanTradePartner_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_StyleSourcing_MaterialSummary_SELECT]'
GO

ALTER VIEW [dbo].[vwx_StyleSourcing_MaterialSummary_SELECT]
AS
SELECT     a.StyleSourcingItemID, a.StyleSourcingID, a.CDate, a.CUser, a.MDate, a.MUser, a.StyleMaterialID, a.TradePartnerVendorID, b.UOM AS Expr1, b.Qty, 
                      a.MaterialPrice, a.Sort, a.StyleColorID, a.StyleSet, a.BOM, b.MainMaterial, b.MaterialType, '' AS GroupName, c.ComponentDescription, b.MaterialNo, 
                      b.MaterialName, b.UOM, b.MaterialID, '<img src=''../System/Control/ImageStream.ashx?S=50&V=' + CAST(ISNULL(b.MaterialImageVersion, 0) 
                      AS NVARCHAR(5)) + '&IID=' + CAST(ISNULL(b.MaterialImageID, '00000000-0000-0000-0000-000000000000') AS NVARCHAR(50)) 
                      + ''' />' AS MaterialImage, ISNULL(b.MaterialSize, 'NA*') AS MaterialSize, 
                      '<img src=''../System/Control/ColorStream.ashx?S=40&CFID=' + CAST(ISNULL(e.ColorFolderID, '00000000-0000-0000-0000-000000000000') 
                      AS NVARCHAR(50)) + '&CPID=' + CAST(ISNULL(e.ColorPaletteID, '00000000-0000-0000-0000-000000000000') AS NVARCHAR(50)) + '''  />' AS Color, 
                      e.ColorPaletteID, ISNULL(b.MaterialSizeID, '00000000-0000-0000-0000-000000000000') AS MaterialSizeID, b.StyleID, b.MaterialSort, 
                      CASE WHEN b.MaterialSizeID IS NULL OR
                      b.MaterialSizeID = '00000000-0000-0000-0000-000000000000' THEN '*NA' ELSE f.MaterialSize END AS Expr2, a.CustomField1, h.SeasonYearID, 
                      e.MaterialColorID
FROM         dbo.pStyleSourcingItem AS a INNER JOIN
                      dbo.pStyleSourcing AS g ON g.StyleSourcingID = a.StyleSourcingID INNER JOIN
                      dbo.pStyleSeasonYear AS h ON g.StyleSeasonYearID = h.StyleSeasonYearID INNER JOIN
                      dbo.pStyleMaterials AS b ON a.StyleMaterialID = b.StyleMaterialID INNER JOIN
                      dbo.pComponentType AS c ON b.MaterialType = c.ComponentTypeID LEFT OUTER JOIN
                      dbo.pStyleColorwayItem AS d ON d.StyleColorID = a.StyleColorID AND d.StyleMaterialID = a.StyleMaterialID LEFT OUTER JOIN
                      dbo.pMaterialColor AS e ON e.MaterialColorID = d.MaterialColorID LEFT OUTER JOIN
                      dbo.pMaterialSize AS f ON b.MaterialSizeID = f.MaterialSizeID

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[xCustom64]'
GO
ALTER TABLE [dbo].[xCustom64] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_xCustom64_CustomID] DEFAULT (newid()),
[CustomSort] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_xCustom64] on [dbo].[xCustom64]'
GO
ALTER TABLE [dbo].[xCustom64] ADD CONSTRAINT [PK_xCustom64] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[ACustom12]'
GO
ALTER TABLE [dbo].[ACustom12] ADD
[CustomRelationId] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomSort1] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomSort2] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MRP] [nvarchar] (10) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Label] [nvarchar] (2) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Packaging] [nvarchar] (4) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Purchase] [nvarchar] (3) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ProductPrefix] [nvarchar] (1) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[AccAbrev] [nvarchar] (2) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_ACustom12_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[ACustom12] ALTER COLUMN [Custom] [nvarchar] (255) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[ACustom12] ALTER COLUMN [CustomKey] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[ACustom12] ALTER COLUMN [Active] [bit] NULL
ALTER TABLE [dbo].[ACustom12] ALTER COLUMN [CUser] [nvarchar] (255) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[ACustom12] ALTER COLUMN [CDate] [nvarchar] (255) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[ACustom12] ALTER COLUMN [MUser] [nvarchar] (255) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[ACustom12] ALTER COLUMN [MDate] [nvarchar] (255) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[ACustom12] ALTER COLUMN [CustomSort] [nvarchar] (255) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_ACustom12] on [dbo].[ACustom12]'
GO
ALTER TABLE [dbo].[ACustom12] ADD CONSTRAINT [PK_ACustom12] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_Material_AgentVendorLabDip_SELECT]'
GO

--
-- kj comment out
--

-- EXEC sp_refreshview N'[dbo].[vwx_Material_AgentVendorLabDip_SELECT]'
-- GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleMaterial_Replace_SELECT]'
GO


CREATE PROCEDURE  [dbo].[spx_StyleMaterial_Replace_SELECT](
@StyleID UNIQUEIDENTIFIER,
@StyleSet INT
)
AS

DECLARE @HeaderLocked INT 
SELECT @HeaderLocked  = HeaderLocked  FROM pStyleHeader WHERE StyleID = @StyleID 


IF @HeaderLocked = 0 
BEGIN 

	SELECT StyleMaterialID,
	CASE 
		WHEN MainMaterial = 1 THEN 'Yes'
		ELSE 'No'
	END AS MainMaterial	,MaterialName, MaterialNo, Placement,
	'<img src="../System/Control/ImageStream.ashx?S=50&V=' + CAST(MaterialImageVersion AS NVARCHAR(5)) + 
	'&IID=' + CAST( ISNULL(MaterialImageID,'00000000-0000-0000-0000-000000000000' ) AS NVARCHAR(40))  + '" /> '
	AS MaterialImage
	FROM pStyleMaterials 
	WHERE StyleID = @StyleID  AND StyleSet = @StyleSet 
	ORDER BY MainMaterial DESC , MaterialName
END
ELSE
BEGIN 

	SELECT StyleMaterialID,
	CASE 
		WHEN MainMaterial = 1 THEN 'Yes'
		ELSE 'No'
	END AS MainMaterial	,MaterialName, MaterialNo, Placement,
	'<img src="../System/Control/ImageStream.ashx?S=50&V=' + CAST(MaterialImageVersion AS NVARCHAR(5)) + 
	'&IID=' + CAST( ISNULL(MaterialImageID,'00000000-0000-0000-0000-000000000000' ) AS NVARCHAR(40))  + '" /> '
	AS MaterialImage
	FROM pStyleMaterials 
	WHERE StyleID = @StyleID  AND StyleSet = @StyleSet 
	AND  MainMaterial = 0
	ORDER BY MainMaterial DESC , MaterialName
	
END 






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleMaterialSummaryLink_UPDATE]'
GO
CREATE PROCEDURE [dbo].[spx_StyleMaterialSummaryLink_UPDATE] (
	@StyleMaterialID uniqueidentifier,
	@LinkType varchar(10),
	@ModifiedBy nvarchar(200),
	@ModifiedDate datetime
)
AS 

DECLARE
	@MainMaterial int,
	@StyleId uniqueidentifier,
	@MaterialId uniqueidentifier,
	@MaterialImageId uniqueidentifier,
	@MaterialImageVersion int,
	@MaterialNo nvarchar(50),
	@MaterialName nvarchar(200),
	@MaterialNull nvarchar(50),
	@StyleMaterialMasterID uniqueidentifier


SELECT @MainMaterial = MainMaterial, 
	@StyleMaterialMasterID = StyleMaterialMasterID,
	@StyleId = StyleId,
	@MaterialId = MaterialId,
	@MaterialImageId = MaterialImageId,
	@MaterialImageVersion = MaterialImageVersion,
	@MaterialNo = MaterialNo,
	@MaterialName = MaterialName 
FROM pStyleMaterials WITH (NOLOCK) WHERE (StyleMaterialId = @StyleMaterialid)


--IF @MainMaterial = 1
--BEGIN
--SET @MaterialNull = '{00000000-0000-0000-0000-000000000000}'
--
--	DECLARE @StyleMasterId uniqueidentifier
--	SELECT @StyleMasterId = StyleMasterId FROM pStyleHeader WITH (NOLOCK) WHERE StyleId = @StyleId
--	
--	UPDATE pStyleHeader
--		SET  MaterialID = @MaterialNull, MaterialImageID = @MaterialNull, MaterialImageVersion = 0, MaterialNo = NULL, 
--		MaterialName = NULL, StyleMaterialID = @MaterialNull
--	WHERE  (StyleID = @StyleId)
--	
--	UPDATE pStyleHeader
--		SET  MaterialID = @MaterialNull, MaterialImageID = @MaterialNull, MaterialImageVersion = 0, MaterialNo = NULL, 
--		MaterialName = NULL, StyleMaterialID = @MaterialNull
--	WHERE  (StyleMasterID = @StyleMasterId) 
--	
--END

/*******************************************/
/*Delete the Material from pStyleMaterials.*/
/*******************************************/
BEGIN
	--Declare variables to hold the Variation and DevelopmentID to delete material from only the active variation.
	DECLARE @Variation int
	DECLARE @StyleDevelopmentID uniqueidentifier
	
	--Get the Variation and DevelopmentID information.
	SELECT @Variation = Variation,
		@StyleDevelopmentID = StyleDevelopmentID
	FROM pStyleDevelopmentItem WITH (NOLOCK)
	WHERE StyleID = @StyleID
	
	IF @LinkType = 'UNLINK'
	BEGIN
	--unlink current material
	UPDATE pStyleMaterials SET MaterialLinked = 0, StyleMaterialMasterID = newid() WHERE (StyleMaterialID = @StyleMaterialID)
	
	--unlink any other materials in this variation that were linked to this material.
	UPDATE pStyleMaterials SET MaterialLinked = 0, StyleMaterialMasterID = newid() 
		WHERE (StyleMaterialMasterID = @StyleMaterialMasterID
				AND MaterialLinked = 1
				AND StyleID IN (SELECT StyleID
								FROM pStyleDevelopmentItem WITH (NOLOCK)
								WHERE StyleDevelopmentID = @StyleDevelopmentID
										AND Variation = @Variation))
	END
END




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanShowroomItem_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_LinePlanShowroomItem_SELECT] (
@LinePlanID UNIQUEIDENTIFIER, 
@LinePlanRangeID UNIQUEIDENTIFIER
)
AS 

	SELECT a.LinePlanShowroomStyleColorID , a.StyleColorID , a.ShowroomID , a.Price, a.Qty,   a.TradePartnerVendorID,
	b.StyleColorNo, b.StyleColorName, b.ColorPaletteID , c.ColorFolderID,
	d.StyleID , d.StyleNo, d.Description, d.DesignSketchID , d.DesignSketchVersion,
	e.Custom as ShowroomName, f.LinePlanItemID

	FROM dbo.pLinePlanShowroomStyleColor a  WITH (NOLOCK) 
	INNER JOIN pStyleColorway b  WITH (NOLOCK) ON a.StyleColorID = b.StyleColorID 
	INNER JOIN pColorPalette c   WITH (NOLOCK) ON c.ColorPaletteID =  b.ColorPaletteID 
	INNER JOIN pStyleHeader d WITH (NOLOCK) ON b.StyleID =  d.StyleID
	INNER JOIN pShowroom e  WITH (NOLOCK) ON e.CustomID  = a.ShowroomID
	INNER JOIN pLinePlanItem f  WITH (NOLOCK) ON f.StyleID  =  d.StyleID

	WHERE a.LinePlanRangeID  = @LinePlanRangeID 
	AND a.LinePlanID = @LinePlanID

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pSeason]'
GO
ALTER TABLE [dbo].[pSeason] ALTER COLUMN [CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[pSeason] ALTER COLUMN [MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleMaterialPending_INSERT]'
GO
SET QUOTED_IDENTIFIER OFF
GO




/*
Comments:

#01 - Ryan Cabanas - 2/12/2009
	Added functionality to the procedure so that when a Material is added to the Style, if the 'Colorway' box is checked, a record is added
to the 'pStyleColorwayItem' table for each colorway found in 'pStyleColorway'.  If the Material added is linked, add the same for each
Size Class in the Style.

#02 - Ryan Cabanas - 2/16/2009
	Need to create a new StyleMaterialID for each Material so that the Colorway Item INSERT can use this ID, as well.
	
#03 - Daniel Pak - 2/14/2010
	Added fielld StyleMaterialLinkID on pStyleMaterials to link styles and batch update on linked IDs	
*/


ALTER PROCEDURE [dbo].[spx_StyleMaterialPending_INSERT]
(
@StyleMaterialID uniqueidentifier,
@StyleID uniqueidentifier,
@StyleSet int,
@CreatedDate datetime,
@CreatedBy nvarchar(200)
)
AS 


SET NOCOUNT ON

CREATE TABLE [#tempStyleDevelopmentItem] ( 
	[RecID]						int IDENTITY(1,1)  NOT NULL,
    [StyleDevelopmentItemID]	uniqueidentifier NULL,
    [StyleDevelopmentID]    	uniqueidentifier NULL,
    [StyleID]               	uniqueidentifier NULL,
    [SizeRange]             	nvarchar(50) NULL,
    [Variation]             	int NULL,
    [CUser]                 	nvarchar(200) NULL,
    [CDate]                 	datetime NULL,
    [MUser]                 	nvarchar(200) NULL,
    [MDate]                 	datetime NULL,
)

DECLARE @MaterialLink int, @Colorway int
DECLARE @MainMaterial INT 
DECLARE @MaterialID  UNIQUEIDENTIFIER 
DECLARE @MaterialSizeID  UNIQUEIDENTIFIER 
DECLARE @MaterialSize NVARCHAR(200)

SELECT 
@MaterialLink = MaterialLinked,
@Colorway = Colorway,
@MaterialSizeID = MaterialSizeID,
@MaterialID = MaterialID
FROM pStyleMaterialTemp 
WHERE StyleMaterialId = @StyleMaterialID


IF @MaterialSizeID IS NOT NULL 
BEGIN 
	SELECT @MaterialSize = MaterialSize FROM pMaterialSize WHERE MaterialSizeID = @MaterialSizeID
END 


--Comment #02
DECLARE @NewStyleMaterialID uniqueidentifier


--Comment #01
BEGIN
	/*Declare variables.*/
	--DECLARE @MaterialID uniqueidentifier
	DECLARE @TotalCount int
	DECLARE @RowCounter int
	DECLARE @StyleColorID uniqueidentifier

/*
	/*Get some additional variable values.*/
	SELECT @MaterialID = MaterialID
	FROM pStyleMaterialTemp 
	WHERE StyleMaterialId = @StyleMaterialID
*/
END


IF @MaterialLink = 0
	--If Material is not linked then remove styleMaterialMasterId  
	BEGIN
		--Comment #02
		SET @NewStyleMaterialID = NEWID()
		
		
		SELECT @MainMaterial = MainMaterial FROM pStyleMaterialTemp WHERE  StyleMaterialID = @StyleMaterialID AND StyleID = @StyleID AND StyleSet = @StyleSet

		INSERT INTO pStyleMaterials
			(StyleMaterialID, StyleMaterialMasterID, MainMaterial, Development, MiscColor, StyleSet, StyleID, UOM, Qty, MaterialPrice, Ext, 
			MaterialSize, MaterialID, 
			MaterialPlacement, MaterialPlacementCode, MaterialPlacementDetail, MaterialImageID, MaterialImageVersion, NoColorMatch, SupplierID, 
			ComponentTypeID, MaterialType, MaterialNo, MaterialName, Source, Notes, Placement, VendorPrice, VolumePrice, VolumePriceMinimum, 
			VendorProductionMin, VendorProductionLeadTime, DetailYesNo, ImageType, height, width, CDate, CUser, MDate, MUser, MChange, SChange, 
			DChange, CChange, Action, ColorPlacement, Artwork, License, Colorway, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S, T, U, V, W, X, Y, Z, 
			MaterialLinked, MaterialTrack, TradePartnerID, TradePartnerVendorID, MaterialBOM , MaterialSizeID, StyleMaterialLinkID)
		SELECT @NewStyleMaterialID, '{00000000-0000-0000-0000-000000000000}', MainMaterial, Development, MiscColor, StyleSet, @StyleID, UOM, Qty, MaterialPrice, Ext, 
			@MaterialSize, 
			MaterialID, MaterialPlacement, MaterialPlacementCode, MaterialPlacementDetail, MaterialImageID, MaterialImageVersion, NoColorMatch, SupplierID, 
			ComponentTypeID, MaterialType, MaterialNo, MaterialName, Source, Notes, Placement, VendorPrice, VolumePrice, VolumePriceMinimum, 
			VendorProductionMin, VendorProductionLeadTime, DetailYesNo, ImageType, height, width, 
			@CreatedDate AS CDate, @CreatedBy AS CUser, @CreatedDate AS MDate, @CreatedBy AS MUser, 
			MChange, SChange, DChange, CChange, Action, ColorPlacement, Artwork, License, Colorway, A, B, C, D, E, F, G, H, I, J, K, 
			L, M, N, O, P, Q, R, S, T, U, V, W, X, Y, Z, 0, 0, TradePartnerID, TradePartnerVendorID, MaterialBOM , @MaterialSizeID AS MaterialSizeID, StyleMaterialLinkID
		FROM  pStyleMaterialTemp WITH (NOLOCK)
		WHERE (StyleMaterialID = @StyleMaterialID) AND (StyleID = @StyleID) AND (StyleSet = @StyleSet)
		
		/***
		** Only 1 MainMaterial
		***/
		IF @MainMaterial = 1 
		BEGIN
			UPDATE  pStyleMaterials SET MainMaterial = 0 
			WHERE StyleID = @StyleID AND StyleSet = @StyleSet
			AND StyleMaterialID <> @NewStyleMaterialID
		END 


		--Comment #01
		/********************************************************************************/
		/*Add the records for the Material into 'pStyleColorwayItem' for each Colorway.	*/
		/********************************************************************************/
		IF(@Colorway = 1)	--The colorway check box has been marked off for the Material.
			BEGIN
				/*Create temp table to hold 'StyleID' values and Colorway ('StyleColorID') values.*/
				CREATE TABLE #tempStyleColorways
				(
					TableRow int identity(1,1)
					,StyleID uniqueidentifier
					,StyleColorID uniqueidentifier
				)

				/*Get the Colorway IDs and StyleID for the Size Class.*/
				INSERT INTO #tempStyleColorways(StyleID, StyleColorID)
				SELECT StyleID, StyleColorID
				FROM pStyleColorway
				WHERE StyleID = @StyleID

				/*Set counter variables.*/
				SELECT @TotalCount = COUNT(*) FROM #tempStyleColorways
				SET @RowCounter = 1

				/*Loop to add the 'pStyleColorwayItem' records.*/
				WHILE(@RowCounter <= @TotalCount)
				BEGIN
					/*Get variables to check and make sure that the record doesn't already exist before entering it into 'pStyleColorwayItem'.*/
					SELECT @StyleColorID = StyleColorID
					FROM #tempStyleColorways
					WHERE TableRow = @RowCounter		

					/*Make sure that the record doesn't already exist.*/
					IF((SELECT COUNT(*) FROM pStyleColorwayItem 
						WHERE StyleColorID = @StyleColorID AND StyleID = @StyleID 
						AND StyleSet = @StyleSet AND StyleMaterialID = @NewStyleMaterialID AND MaterialID = @MaterialID) = 0)
					BEGIN
						/*Add the record to 'pStyleColorwayItem'.*/
						INSERT INTO pStyleColorwayItem(StyleColorItemID,StyleColorID,StyleID,
						StyleSet,StyleMaterialID,MaterialID, CUser,CDate, MUser, MDate )
						VALUES ( NEWID(), @StyleColorID, @StyleID, 
						@StyleSet,@NewStyleMaterialID,@MaterialID, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate) 
					END

					/*Up row counter.*/
					SET @RowCounter = @RowCounter + 1
				END

				/*Drop the temp table.*/
				DROP TABLE #tempStyleColorways
			END

	END
ELSE
	--If Material is linked then insert material to all size class
	BEGIN
		DECLARE @StyleDevelopmentId uniqueidentifier
		DECLARE @StyleVariation int

		SELECT @StyleDevelopmentId = StyleDevelopmentId, @StyleVariation = Variation 
		FROM pStyleDevelopmentItem WITH (NOLOCK) 
		WHERE StyleId = @StyleId

		BEGIN
			INSERT INTO #tempStyleDevelopmentItem
			(StyleDevelopmentItemID, StyleDevelopmentID, StyleID, SizeRange, Variation)
			SELECT StyleDevelopmentItemID, StyleDevelopmentID, StyleID, SizeRange, Variation FROM pStyleDevelopmentItem WITH (NOLOCK) 
			WHERE StyleDevelopmentID = @StyleDevelopmentID AND Variation = @StyleVariation
		END

		--SELECT * FROM #tempStyleDevelopmentItem

		DECLARE @StyleMaterialMasterId uniqueidentifier
		SET @StyleMaterialMasterId = newid()

		DECLARE @tmpStyleId uniqueidentifier

		DECLARE @Row_Count int
		DECLARE @Row_Loop int

		SET @Row_Loop = 1
		SET @Row_Count = (SELECT COUNT(*) FROM #tempStyleDevelopmentItem)
		
		WHILE @Row_Loop <= @Row_Count 
			BEGIN
				--Comment #02
				SET @NewStyleMaterialID = NEWID()
			
				SELECT @tmpStyleID = StyleID FROM #tempStyleDevelopmentItem WHERE RecID = @Row_Loop
				
				SELECT @MainMaterial = MainMaterial FROM pStyleMaterialTemp 
				WHERE  StyleMaterialID = @StyleMaterialID AND StyleID = @StyleID AND StyleSet = @StyleSet
						
				INSERT INTO dbo.pStyleMaterials
					(StyleMaterialID, StyleMaterialMasterID, MainMaterial, Development, MiscColor, StyleSet, StyleID, UOM, Qty, MaterialPrice, Ext, 
					MaterialSize, MaterialID, 
					MaterialPlacement, MaterialPlacementCode, MaterialPlacementDetail, MaterialImageID, MaterialImageVersion, NoColorMatch, SupplierID, 
					ComponentTypeID, MaterialType, MaterialNo, MaterialName, Source, Notes, Placement, VendorPrice, VolumePrice, VolumePriceMinimum, 
					VendorProductionMin, VendorProductionLeadTime, DetailYesNo, ImageType, height, width, CDate, CUser, MDate, MUser, MChange, SChange, 
					DChange, CChange, Action, ColorPlacement, Artwork, License, Colorway, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S, T, U, V, W, X, Y, Z,
					MaterialLinked, MaterialTrack , MaterialPackLabelGroupID, TradePartnerID, TradePartnerVendorID, MaterialBOM , MaterialSizeID, StyleMaterialLinkID)
				SELECT @NewStyleMaterialID, @StyleMaterialMasterId AS StyleMaterialMasterID, MainMaterial, Development, MiscColor, StyleSet, @tmpStyleID, UOM, Qty, MaterialPrice, Ext, 
					@MaterialSize, 
					MaterialID, MaterialPlacement, MaterialPlacementCode, MaterialPlacementDetail, MaterialImageID, MaterialImageVersion, NoColorMatch, SupplierID, 
					ComponentTypeID, MaterialType, MaterialNo, MaterialName, Source, Notes, Placement, VendorPrice, VolumePrice, VolumePriceMinimum, 
					VendorProductionMin, VendorProductionLeadTime, DetailYesNo, ImageType, height, width, 
					@CreatedDate AS CDate, @CreatedBy AS CUser, @CreatedDate AS MDate, @CreatedBy AS MUser, 
					MChange, SChange, DChange, CChange, Action, ColorPlacement, Artwork, License, Colorway, A, B, C, D, E, F, G, H, I, J, K, 
					L, M, N, O, P, Q, R, S, T, U, V, W, X, Y, Z, 1, 0 , MaterialPackLabelGroupID, TradePartnerID, TradePartnerVendorID, MaterialBOM, @MaterialSizeID AS MaterialSizeID, StyleMaterialLinkID
				FROM  pStyleMaterialTemp WITH (NOLOCK)
				WHERE (StyleMaterialID = @StyleMaterialID) AND (StyleID = @StyleID) AND (StyleSet = @StyleSet)
				
				/***
				** Only 1 MainMaterial
				***/
				IF @MainMaterial = 1 
				BEGIN
					UPDATE  pStyleMaterials SET MainMaterial = 0 
					WHERE StyleID = @tmpStyleID AND StyleSet = @StyleSet
					AND StyleMaterialID <> @NewStyleMaterialID
				END 					

				--Comment #01
				/********************************************************************************/
				/*Add the records for the Material into 'pStyleColorwayItem' for each Colorway.	*/
				/********************************************************************************/
				IF(@Colorway = 1)	--The colorway check box has been marked off for the Material.
					BEGIN
						/*Create temp table to hold 'StyleID' values and Colorway ('StyleColorID') values.*/
						CREATE TABLE #tempStyleColorwaysLinked
						(
							TableRow int identity(1,1)
							,StyleID uniqueidentifier
							,StyleColorID uniqueidentifier
						)

						/*Get the Colorway IDs and StyleID for the Size Class.*/
						INSERT INTO #tempStyleColorwaysLinked(StyleID,StyleColorID)
						SELECT StyleID, StyleColorID
						FROM pStyleColorway
						WHERE StyleID = @tmpStyleID

						/*Set counter variables.*/
						SELECT @TotalCount = COUNT(*) FROM #tempStyleColorwaysLinked
						SET @RowCounter = 1

						/*Loop to add the 'pStyleColorwayItem' records.*/
						WHILE(@RowCounter <= @TotalCount)
						BEGIN
							/*Get variables to check and make sure that the record doesn't already exist before entering it into 'pStyleColorwayItem'.*/
							SELECT @StyleColorID = StyleColorID
							FROM #tempStyleColorwaysLinked
							WHERE TableRow = @RowCounter		

							/*Make sure that the record doesn't already exist.*/
							IF((SELECT COUNT(*) FROM pStyleColorwayItem 
							WHERE StyleColorID = @StyleColorID AND StyleID = @tmpStyleID AND StyleSet = @StyleSet AND StyleMaterialID = @NewStyleMaterialID AND MaterialID = @MaterialID) = 0)
							BEGIN

								/*Add the record to 'pStyleColorwayItem'.*/
								INSERT INTO pStyleColorwayItem(StyleColorItemID, StyleColorID, StyleID,StyleSet,
								StyleMaterialID,MaterialID, CUser,CDate, MUser, MDate )
								VALUES ( NEWID(), @StyleColorID, @tmpStyleId, @StyleSet, 
								@NewStyleMaterialID, @MaterialID, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate ) 
								
							END

							/*Up row counter.*/
							SET @RowCounter = @RowCounter + 1
						END

						/*Drop the temp table.*/
						DROP TABLE #tempStyleColorwaysLinked
					END
				
				SET @Row_Loop = @Row_Loop + 1
			END
	END




--Clean Table 
DELETE FROM pStyleMaterialTemp  WHERE (StyleMaterialID = @StyleMaterialID) AND (StyleID = @StyleID) AND (StyleSet = @StyleSet)


/*Drop temp table.*/
DROP TABLE #tempStyleDevelopmentItem


SET NOCOUNT OFF



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanShowroomStyle_Logic_CHECK_INSERT]'
GO
SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[spx_LinePlanShowroomStyle_Logic_CHECK_INSERT](
@LinePlanID UNIQUEIDENTIFIER, 
@LinePlanRangeID UNIQUEIDENTIFIER, 
@StyleID UNIQUEIDENTIFIER, 
@CUser NVARCHAR (200),
@CDate DATETIME
)
AS 

DECLARE @Season NVARCHAR(50)
DECLARE @Year NVARCHAR(50)

DECLARE @TOTAL INT 
DECLARE @ROW_ID  INT 
DECLARE @StyleColorID UNIQUEIDENTIFIER 

DECLARE @TOTAL_SR INT 
DECLARE @ROW_ID_SR  INT 
DECLARE @ShowroomID UNIQUEIDENTIFIER 

DECLARE @Price MONEY 
DECLARE @TradePartnerVendorID UNIQUEIDENTIFIER 

CREATE TABLE  #color (
ROW_ID INT IDENTITY (1,1)  ,
StyleColorID UNIQUEIDENTIFIER 
)

CREATE TABLE #showroom (
ROW_ID INT IDENTITY (1,1),
ShowroomID UNIQUEIDENTIFIER 
)


INSERT INTO  #color ( StyleColorID ) 
SELECT DISTINCT d.StyleColorID 
FROM   dbo.pLinePlanItem AS a 
INNER JOIN dbo.pStyleSourcing AS b ON a.StyleID = b.StyleID 
INNER JOIN dbo.pStyleQuoteItem AS c ON a.StyleID = c.StyleID AND c.StyleSourcingID = b.StyleSourcingID 
INNER JOIN dbo.pStyleColorway AS d ON d.StyleColorID = c.StyleColorID 
INNER JOIN dbo.pStyleColorwaySeasonYear AS f ON f.StyleColorwayID = d.StyleColorID 
INNER JOIN dbo.pStyleSeasonYear AS g ON g.StyleSeasonYearID = f.StyleSeasonYearID AND g.LinePlanItemID = a.LinePlanItemID 
INNER JOIN dbo.pStyleHeader AS h ON h.StyleID = a.StyleID
WHERE a.StyleID = @StyleID
AND c.StyleQuoteItemStatusId = 3 AND f.StyleColorStatus = 200
AND a.LinePlanRangeID = @LinePlanRangeID

SET @ROW_ID  = 1 
SELECT @TOTAL = COUNT(*) from #color 

INSERT INTO #showroom  ( ShowroomID ) 
SELECT ShowroomID FROM dbo.pLinePlanShowroomItem WHERE LinePlanRangeID = @LinePlanRangeID


SELECT  @TOTAL_SR = COUNT(*) FROM #showroom 

select @TOTAL , @TOTAL_SR 

select  @Season = b.Season , @Year  = b.Year 
from pLinePlan b WHERE LinePlanID = @LinePlanID



WHILE @ROW_ID <= @TOTAL 
BEGIN
	SELECT @StyleColorID  = StyleColorID FROM #color WHERE ROW_ID =  @ROW_ID 

	SET @ROW_ID_SR = 1 
	WHILE  @ROW_ID_SR <= @TOTAL_SR 
	BEGIN 

		SELECT @ShowroomID = ShowroomID FROM #showroom WHERE ROW_ID = @ROW_ID_SR

		IF  ( SELECT COUNT(*) FROM dbo.pLinePlanShowroomStyleColor  
			WHERE StyleID = @StyleID
			AND  LinePlanRangeID = @LinePlanRangeID
			AND StyleColorID = @StyleColorID
			AND ShowroomID = @ShowroomID ) = 0 
		BEGIN

			SET @TradePartnerVendorID = NULL 
			SET @Price = 0


			IF ( SELECT COUNT(*) FROM dbo.pLinePlanShowroomStyleColor  
				WHERE StyleID = @StyleID 
				AND  LinePlanRangeID = @LinePlanRangeID AND StyleColorID = @StyleColorID ) = 0 
			BEGIN
				-- First showroom for that Stylecolor an LineplanRange 
				-- Get a default TradePartnerVendor 

				
				SELECT @TradePartnerVendorID = b.TradePartnerVendorID
				FROM   dbo.pLinePlanItem AS a 
				INNER JOIN dbo.pStyleSourcing AS b ON a.StyleID = b.StyleID 
				INNER JOIN dbo.pStyleQuoteItem AS c ON a.StyleID = c.StyleID AND c.StyleSourcingID = b.StyleSourcingID 
				INNER JOIN dbo.pStyleColorway AS d ON d.StyleColorID = c.StyleColorID 
				INNER JOIN dbo.pStyleColorwaySeasonYear AS f ON f.StyleColorwayID = d.StyleColorID 
				INNER JOIN dbo.pStyleSeasonYear AS g ON g.StyleSeasonYearID = f.StyleSeasonYearID AND g.LinePlanItemID = a.LinePlanItemID 
				INNER JOIN dbo.pStyleHeader AS h ON h.StyleID = a.StyleID
				WHERE a.StyleID = @StyleID
				AND c.StyleQuoteItemStatusId = 3 AND f.StyleColorStatus = 200
				AND a.LinePlanRangeID = @LinePlanRangeID 
			
				DECLARE @StyleCategoryID UNIQUEIDENTIFIER 
				SELECT @StyleCategoryID  = StyleCategory FROM pStyleHeader WHERE StyleID = @StyleID 

				IF @StyleCategoryID IS NOT NULL AND @TradePartnerVendorID IS NOT NULL 
				BEGIN 
		
					SELECT TOP 1 @Price = b.Rate 
					FROM pTradePartnerVendorRate a
					INNER JOIN  pTradePartnerVendorRateItem  b ON a.TradePartnerVendorRateID = b.TradePartnerVendorRateID
					WHERE a.TradePartnerVendorID = @TradePartnerVendorID
					AND StyleCategoryID = @StyleCategoryID
					AND a.Season = @Season 
					AND a.Year = @Year
		
					--print 'SELECT TOP 1 b.Rate 	FROM pTradePartnerVendorRate a 	INNER JOIN  pTradePartnerVendorRateItem  b ON a.TradePartnerVendorRateID = b.TradePartnerVendorRateID 		WHERE a.TradePartnerVendorID = ''' + Cast(@TradePartnerVendorID as nvarchar(50)) +  ''' AND StyleCategoryID = ''' + Cast(@StyleCategoryID as nvarchar(50)) + ''' AND a.Season = ''' +  @Season  + ''' AND a.Year = ''' + @Year + ''' '
					IF @Price IS NULL SET @Price = 0 
				END 

			END 
			ELSE 
				SELECT TOP 1 @Price = Price, @TradePartnerVendorID  = TradePartnerVendorID 
				FROM dbo.pLinePlanShowroomStyleColor  
				WHERE StyleID = @StyleID
				AND  LinePlanRangeID = @LinePlanRangeID
				AND StyleColorID = @StyleColorID
			

			INSERT INTO pLinePlanShowroomStyleColor ( LinePlanShowroomStyleColorID , LinePlanID , LinePlanRangeID , StyleID , StyleColorID , 
				ShowroomID , CUser, CDate, MUser, MDate, Price, Qty, TradePartnerVendorID ) 
			VALUES (NEWID() , @LinePlanID, @LinePlanRangeID , @StyleID , @StyleColorID , 
				@ShowroomID , @CUser, @CDate, @CUser, @CDate, @Price, 0, @TradePartnerVendorID)

		END 
		SET @ROW_ID_SR = @ROW_ID_SR + 1 
	END 
		
	SET @ROW_ID = @ROW_ID + 1
END 


DROP TABLE #color
DROP TABLE #showroom


--select * from dbo.pLinePlanShowroom where LinePlanID = 'a2e4d875-3e41-4b97-8fa6-6835ca1ce1ba'
--  select * from dbo.pLinePlanShowroomItem    -- RANGEID
--select * from dbo.pLinePlanShowroomStyleColor  







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_LineFolder_Image_8x3_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.  Needed to add the 'Version' field to the temp table for
the image stream and get the 'Version' from 'hImage' to put in the temp table.
*/


ALTER    PROCEDURE [dbo].[rpx_LineFolder_Image_8x3_SELECT]
( 
	@LineFolderID AS varchar(255)
)
AS


CREATE TABLE #tempLineFolderStyles
(
	TableRow int identity(0,1),
	StyleID varchar(50),
	StyleNo varchar(50),
	[Description] nvarchar(255),
	ImageID varchar(50),
	ImageHistoryID varchar(50),
	LineFolderItemDrop varchar(5),
	LineFolderItemDropUser nvarchar(255),
	LineFolderItemDropDate datetime,
	SizeClass nvarchar(50),
	SizeRange nvarchar(50),
	MaterialName nvarchar(100),
	MaterialNo nvarchar(50),
	[Version] int	--Comment #01
)

/*Insert info into temp table.*/
INSERT INTO #tempLineFolderStyles(StyleID, StyleNo, [Description], ImageID, ImageHistoryID,
	LineFolderItemDrop, LineFolderItemDropUser,	LineFolderItemDropDate, SizeClass, SizeRange, MaterialName,
	MaterialNo, [Version])	--Comment #01
SELECT b.StyleID, b.StyleNo, b.[Description], c.ImageID, c.ImageHistoryID,
	a.LineFolderItemDrop, a.LineFolderItemDropUser, a.LineFolderItemDropDate, b.SizeClass, b.SizeRange, d.MaterialName,
	d.MaterialNo, c.[Version]	--Comment #01
FROM pLineFolderItem a INNER JOIN pStyleHeader b ON
a.StyleID = b.StyleID INNER JOIN hImage c ON
b.DesignSketchID = c.ImageID AND b.DesignSketchVersion = c.Version LEFT OUTER JOIN pMaterial d ON
b.MaterialID = d.MaterialID
WHERE LineFolderID = @LineFolderID
ORDER BY a.LineFolderItemSort, b.StyleNo, b.Description


/*Select the information how you want for the report.*/
SELECT
	TableRow % 12 AS [Column],
	StyleID,
	StyleNo,
	[Description],
	dbo.fnx_GetStreamingImagePath(ImageID, [Version]) AS FilePath,	--Comment #01
	@LineFolderID AS LineFolderID,
	LineFolderItemDrop,
	'Dropped By ' + LineFolderItemDropUser + ' - ' + CAST(LineFolderItemDropDate AS varchar(50)) AS DroppedInfo,
	SizeClass,
	SizeRange,
	MaterialName,
	MaterialNo
FROM #tempLineFolderStyles

DROP TABLE #tempLineFolderStyles



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_LinePlanTradePartnerItemRollup1_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_LinePlanTradePartnerItemRollup1_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pSampleRequestSubmitImage]'
GO
ALTER TABLE [dbo].[pSampleRequestSubmitImage] ADD
[SystemServerStorageID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_pSampleRequestSubmitImage_SystemServerStorageID] DEFAULT ('00000000-0000-0000-0000-000000000000')
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanStyle_MoveOptions_Logic_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_LinePlanStyle_MoveOptions_Logic_SELECT] (
	@StyleID UNIQUEIDENTIFIER 
)
AS 





--***
--** Actions :
--** 1 - Move between hierarchies
--** 2 - Move between Lineplans
--***

CREATE TABLE #tmp (
ActionID INT,
Action NVARCHAR(200)
)



IF ( SELECT ISNULL( HeaderLocked, 0 )  FROM pStyleHeader WHERE StyleID = @StyleID ) = 0
BEGIN 

	--***
	--** 1 - Move between hierarchies
	--***
	IF ( SELECT COUNT(*) FROM pStyleSeasonYear a
		WHERE a.StyleID = @StyleID ) = 1 
	BEGIN
	
		--***
		--** Style with 1 season/year 
		--***

		INSERT INTO #tmp ( ActionID, Action ) 
		VALUES ( 1 , 'Move between Hierarchies') 
	END 

	--***
	--** 2 - Move between linePlans 
	--***
	IF  (
		SELECT COUNT(*) FROM pStyleSeasonYear a
		INNER JOIN pLinePlanItem b ON a.LinePlanItemID =  b.LinePlanItemID
		WHERE a.StyleID = @StyleID
	) > 0
	BEGIN
		--***
		--** Style at least in 1 lineplan
		--***
		INSERT INTO #tmp ( ActionID, Action ) 
		VALUES ( 2 , 'Move between Lineplans') 	
	END 

END 

SELECT * FROM #tmp 
DROP TABLE #tmp








GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleRequestSpecSizeIndex_SELECT]'
GO

/*
Comments:

#01 - Ryan Cabanas - November 25, 2009 - Ticket #1498
	Getting error when trying to approve "QA Worksheet" workflow at Sample.  Needed
to provide a default integer if no record found, so used ISNULL() and passed a zero.
*/



ALTER PROCEDURE [dbo].[spx_SampleRequestSpecSizeIndex_SELECT]
(
@SampleRequestTradeID uniqueidentifier,
@SampleRequestWorkflowID uniqueidentifier,
@StyleID uniqueidentifier,
@StyleSet int,
@Submit int
)
AS 

Declare @SampleSizePosition int

BEGIN
	SELECT  @SampleSizePosition = (CASE 
        WHEN Sel0 = 1 THEN 0
        WHEN Sel1 = 1 THEN 1 
        WHEN Sel2 = 1 THEN 2 
        WHEN Sel3 = 1 THEN 3 
        WHEN Sel4 = 1 THEN 4 
        WHEN Sel5 = 1 THEN 5 
        WHEN Sel6 = 1 THEN 6 
        WHEN Sel7 = 1 THEN 7 
        WHEN Sel8 = 1 THEN 8 
        WHEN Sel9 = 1 THEN 9 
        WHEN Sel10 = 1 THEN 10 
        WHEN Sel11 = 1 THEN 11 
        WHEN Sel12 = 1 THEN 12 
        WHEN Sel13 = 1 THEN 13 
        WHEN Sel14 = 1 THEN 14 
        WHEN Sel15 = 1 THEN 15 
        WHEN Sel16 = 1 THEN 16 
        WHEN Sel17 = 1 THEN 17 
        WHEN Sel18 = 1 THEN 18 
        WHEN Sel19 = 1 THEN 19 
        END) FROM pSampleRequestSpecSize WITH (NOLOCK)
	WHERE (SampleRequestTradeID = @SampleRequestTradeID) AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleID = @StyleID) AND (StyleSet = @StyleSet) 
END

BEGIN
	SELECT ISNULL(@SampleSizePosition, 0)	--Comment #01
END




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_LinePlanTradePartnerItemRollup2_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_LinePlanTradePartnerItemRollup2_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_GetUserID_By_Email]'
GO


ALTER PROCEDURE [dbo].[spx_GetUserID_By_Email] (
	@Email as varchar (50)
)
as


	select TeamID from dbo.Users WITH (NOLOCK) where Email like @Email




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleMaterialGlobal_UPDATE]'
GO
ALTER PROCEDURE [dbo].[spx_StyleMaterialGlobal_UPDATE]
(
 @StyleMaterialId uniqueidentifier,
 @StyleId uniqueidentifier,
 @StyleSet int
)
AS 

DECLARE @StyleDevelopmentId 		uniqueidentifier
DECLARE @StyleVariation 		int
DECLARE @Colorway 		INT
DECLARE @StyleMaterialMasterId 		uniqueidentifier
DECLARE @tmpStyleId 			uniqueidentifier
DECLARE @tmpStyleMaterialId 		uniqueidentifier
DECLARE @tmpStyleColorItemMasterId 	uniqueidentifier
DECLARE @tmpMaterialId 			uniqueidentifier
DECLARE	@tmpMaterialNo              	nvarchar(50)
DECLARE @tmpMaterialName            	nvarchar(200)
DECLARE @tmpMaterialImageId 		uniqueidentifier
DECLARE @MaterialNull			varchar(50)
DECLARE @tmpMaterialImageVersion 	int
DECLARE @tmpMaterialMain 		int
DECLARE @tmpColorway 			varchar(3)
DECLARE @tmpStyleColorId 		uniqueidentifier
DECLARE @CountColor 			int
DECLARE @RowStyleCount 			int
DECLARE @RowStyleLoop 			int
DECLARE @Row_Loop 			int
DECLARE @Row_Count 			int

SET NOCOUNT OFF

CREATE TABLE [#tempStyleDevelopmentItem] ( 
	[RecID]						int IDENTITY(1,1)  NOT NULL,
	[StyleDevelopmentItemID]	uniqueidentifier NULL,
	[StyleDevelopmentID]    	uniqueidentifier NULL,
	[StyleID]               	uniqueidentifier NULL,
	[SizeRange]             	nvarchar(50) NULL,
	[Variation]             	int NULL,
	[CUser]                 	nvarchar(200) NULL,
	[CDate]                 	datetime NULL,
	[MUser]                 	nvarchar(200) NULL,
	[MDate]                 	datetime NULL,
)

CREATE TABLE #tmpStyleColor
(
	RowID 						int IDENTITY(1,1)  NOT NULL,
	StyleColorID  				uniqueidentifier NULL,
	StyleMaterialColorMasterID  uniqueidentifier NULL,	
	StyleID 					uniqueidentifier NULL,
	StyleMaterialID  			uniqueidentifier NULL,
	StyleSet 					int NULL,
	MaterialID 					uniqueidentifier NULL

) 

SELECT @StyleMaterialMasterId = StyleMaterialMasterId, @Colorway = Colorway FROM pStyleMaterials WITH (NOLOCK) WHERE StyleMaterialId = @StyleMaterialId
SELECT @StyleDevelopmentId = StyleDevelopmentId, @StyleVariation = Variation FROM pStyleDevelopmentItem WITH (NOLOCK) WHERE StyleId = @StyleId

BEGIN
	INSERT INTO #tempStyleDevelopmentItem
		(StyleDevelopmentItemID, StyleDevelopmentID, StyleID, SizeRange, Variation)
	SELECT StyleDevelopmentItemID, StyleDevelopmentID, StyleID, SizeRange, Variation FROM pStyleDevelopmentItem WITH (NOLOCK) 
	WHERE StyleDevelopmentID = @StyleDevelopmentID AND Variation = @StyleVariation
END

SET @Row_Loop = 1
SET @RowStyleLoop = 1
SET @RowStyleCount = (SELECT COUNT(*) FROM #tempStyleDevelopmentItem)

WHILE @RowStyleLoop <= @RowStyleCount 
BEGIN

	--select @RowStyleCount 

	SELECT @tmpStyleID = StyleID FROM #tempStyleDevelopmentItem WHERE RecID = @RowStyleLoop

	SELECT @tmpStyleMaterialId = StyleMaterialId, @tmpMaterialId = MaterialId, @tmpColorway = Colorway, @tmpMaterialMain = MainMaterial, 
	@tmpMaterialImageId = MaterialImageId, @tmpMaterialImageVersion = MaterialImageversion, @tmpMaterialNo = MaterialNo, 
	@tmpMaterialName = MaterialName 
	FROM pStyleMaterials WITH (NOLOCK) 
	WHERE StyleId = @tmpStyleId AND StyleMaterialMasterId = @StyleMaterialMasterId

	--SELECT @tmpMaterialId AS NewMaterialId
	BEGIN	
		--Update Style Header	
		--SELECT @tmpMaterialMain	AS MainMaterial
		IF @tmpMaterialMain = 1
		BEGIN
			UPDATE pStyleHeader SET  MaterialID = @tmpMaterialId, MaterialImageID = @tmpMaterialImageId, MaterialImageVersion = @tmpMaterialImageVersion, 
			MaterialNo = @tmpMaterialNo, MaterialName = @tmpMaterialName, StyleMaterialID = @tmpStyleMaterialId
			WHERE StyleID = @tmpStyleId
			--SELECT 'Main Material Update'	
		END
	END
				-----------------------

	--Update Colorways
	BEGIN
		IF @Colorway = 1
		BEGIN
			exec spx_StyleColorwayItem_FIX @tmpStyleId, @StyleSet
		END
	END

	SET @RowStyleLoop = @RowStyleLoop + 1


END  --- WHILE 

DROP TABLE #tempStyleDevelopmentItem





















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Style_DevelopmentSpec_HowToMeasure_SELECT]'
GO



/*
Comments:

#01 - Ryan Cabanas - September 25, 2009
	Replace the old pom image string with the new image string using function.
Deleted old code.
*/



ALTER    PROCEDURE [dbo].[rpx_Style_DevelopmentSpec_HowToMeasure_SELECT]
(
	@StyleSet int,
	@StyleID varchar(50)
)
AS


/*Creat temporary table*/
CREATE     TABLE #TempHowTo
(	
	RowNumber int identity(0,1),
	POM nvarchar(5),
	PointMeasur nvarchar(200),
	HowToMeasurText nvarchar(4000),
	FilePath nvarchar(255),
	Sort nvarchar(5)
)


/*Insert values into the temporary table*/
INSERT INTO #TempHowTo(POM, PointMeasur, HowToMeasurText, FilePath, Sort)
SELECT	a.POM,
		a.PointMeasur,
		b.HowToMeasurText,
		dbo.fnx_GetStreamingPOMImageSmallPath(b.POMLibraryID) AS FilePath,	--Comment #01
		a.Sort
FROM pStyleSpec a LEFT OUTER JOIN pPOMLibrary b ON
	a.POM = b.POM
WHERE (a.StyleID = @StyleID) AND (a.StyleSet = @StyleSet)
ORDER BY a.Sort

/*Select the temporary table*/
SELECT	Sort, RowNumber % 3 AS Columns, POM, PointMeasur, HowToMeasurText, FilePath
FROM	#TempHowTo
ORDER BY Sort, Columns DESC

DROP TABLE #TempHowTo




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanStyleAttribueDescription_SELECT]'
GO


CREATE PROCEDURE [dbo].[spx_LinePlanStyleAttribueDescription_SELECT](
@LinePlanItemID UNIQUEIDENTIFIER
)
AS


	DECLARE @AttributeName NVARCHAR(200)	
	DECLARE @LinePlanAttributeType NVARCHAR(200)	

	SELECT @LinePlanAttributeType  = d.LinePlanAttributeType, @AttributeName  = c.AttributeName  
	FROM pLinePlanItem a 
	INNER JOIN pLinePlanStyleAttributeItem  b ON a.LinePlanStyleAttributeItemID   = b.LinePlanStyleAttributeItemID  
	INNER JOIN pLinePlanStyleAttribute  c ON b.LinePlanStyleAttributeID = c.LinePlanStyleAttributeID 
	INNER JOIN pLinePlanAttributeType d ON d.LinePlanAttributeTypeID = c.LinePlanAttributeTypeID 
	WHERE  a.LinePlanItemID = @LinePlanItemID


	IF @LinePlanAttributeType IS NOT NULL  AND @AttributeName  IS NOT NULL 
		SELECT @LinePlanAttributeType + '<span class=''fontHead''>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + @AttributeName  + '</span></br></br>' 
		
	ELSE
		SELECT '' as Description 






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_LinePlanTradePartnerSearch_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_LinePlanTradePartnerSearch_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialRequestTradePartnerVendor_Replace_UPDATE]'
GO
SET QUOTED_IDENTIFIER OFF
GO

                    CREATE PROCEDURE [dbo].[spx_MaterialRequestTradePartnerVendor_Replace_UPDATE](
                                    @MaterialTradePartnerID UNIQUEIDENTIFIER,
                                    @TradePartnerVendorID UNIQUEIDENTIFIER,
                                    @MUser NVARCHAR(200),
                                    @MDate DATETIME 
                                                   )
                        AS 

                           DECLARE @OldTradePartnerVendorID UNIQUEIDENTIFIER
                           DECLARE @SeasonYearID UNIQUEIDENTIFIER
                           DECLARE @MaterialID UNIQUEIDENTIFIER

                            --***
                            --** Get tradePartnervendorID to be replaced, 
                            --** Seasonyear and material IDs
                            --***

                           SELECT @OldTradePartnerVendorID = TradePartnerVendorID,
                                  @SeasonYearID = SeasonYearID, @MaterialID = MaterialID 
                             FROM pMaterialTradePartner  
                            WHERE MaterialTradePartnerID = @MaterialTradePartnerID

                              --***
                              --** update MaterialRequest tables
                              --***

                            UPDATE pMaterialTradePartner SET  TradepartnerVendorId = @TradePartnerVendorID
                             WHERE MaterialTradePartnerId = @MaterialTradePartnerID 

                            UPDATE pMaterialRequestSubmitWorkflow SET  TradepartnerVendorId = @TradePartnerVendorID
                             WHERE MaterialTradePartnerId = @MaterialTradePartnerID 

                             --***
                             --** update Style sourcing 
                             --***

                          UPDATE pStyleSourcingItem
                             SET  TradePartnerVendorID = @TradePartnerVendorID 
                           WHERE StyleSourcingItemID IN ( 
	                          SELECT a.StyleSourcingItemID 
	                          FROM pStyleSourcingItem a 
	                          INNER JOIN pStyleSourcing  b ON a.StyleSourcingID = b.StyleSourcingID 
	                          INNER JOIN pStyleSeasonYear c ON b.StyleSeasonYearID = c.StyleSeasonYearID 
	                          INNER JOIN pStyleMaterials d ON d.StyleMaterialID =  a.StyleMaterialID 
	                           WHERE a.TradePartnerVendorID = @OldTradePartnerVendorID 
	                           AND c.SeasonYearID = @SeasonYearID 
	                           AND d.MaterialID = @MaterialID
                            )
                  
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rpx_srmOn_SampleRequest_Global_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[rpx_srmOn_SampleRequest_Global_SELECT]
	@TradePartnerID uniqueidentifier,
	@Season nvarchar(200) = null,
	@Year nvarchar(200) = null,
	@Category nvarchar(200) = null
AS


select	tp.TradePartnerName, 
		tpv.VendorName,
		cast(sh.StyleID as varchar(50)) as StyleID,
		sh.StyleNo, 
		sh.Description,
		sh.StyleSet, 
		sh.SizeClass,
		sh.SizeRange,
		ISNULL(sc.MainColor,'NA') AS Color, 
		sh.DueDate AS [Tech Pack],
		sw.SampleWorkflowID,
		sw.SampleWorkflow,
		srw.DueDate,
		srw.EndDate,
		dbo.fnx_GetStreamingImagePath(i.ImageID, i.[Version]) AS FilePath	--Comment #01
from	pSampleRequestWorkflow srw
inner join	pSampleWorkflow sw on srw.SampleWorkflowID = sw.SampleWorkflowID
inner join	pStyleHeader sh on srw.StyleID = sh.StyleID
inner join	uTradePartner tp on srw.TradePartnerID = tp.TradePartnerID
inner join	uTradePartnerVendor tpv on srw.TradePartnerVendorID = tpv.TradePartnerVendorID
left outer join	pStyleColorway sc on srw.StyleColorID = sc.StyleColorID
left outer join	hImage i on sh.DesignSketchID = i.ImageID and sh.DesignSketchVersion = i.Version
where	(srw.TradePartnerID = @TradePartnerID)
and 	(@Season is null or sh.CustomField2 = @Season)
and 	(@Year is null or sh.CustomField4 = @Year)
and 	(@Category is null or sh.CustomField5 = @Category)





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleStatus_Logic_UPDATE]'
GO

CREATE PROCEDURE [dbo].[spx_StyleStatus_Logic_UPDATE] (
@StyleID UNIQUEIDENTIFIER,
@StatusID INT,
@MUser NVARCHAR(200), 
@MDate DATETIME,
@OUT INT = 1,
@MSG NVARCHAR(4000) = '' OUTPUT
)
AS

SET NOCOUNT ON

DECLARE @StyleName NVARCHAR(200) --Description
DECLARE @Description NVARCHAR(200) --CustomField14
DECLARE @Company NVARCHAR(200)  -- CustomField1   
DECLARE @Division NVARCHAR(200)  -- CustomField2
DECLARE @Brand NVARCHAR(200) --CustomField3
DECLARE @ProdCategory NVARCHAR(200) --StyleCategory
DECLARE @MerchCategory NVARCHAR(200) --CustomField4
--DECLARE @Group NVARCHAR(200) --CustomField10

--DECLARE @MSG NVARCHAR(4000) 
SET @MSG = ''

IF @StatusID = 1
BEGIN

	-- CHECK FIELDS !! 
	SELECT @StyleName = Description, @Description = CustomField14, @Company = CustomField1, 
		@Division = CustomField2 , @Brand = CustomField3, @ProdCategory = StyleCategory, 
		@MerchCategory = CustomField4 --@Group = CustomField10
	FROM pStyleHeader
	WHERE StyleID = @StyleID  
	
	IF LEN(ISNULL(@StyleName,'')) = 0 
		SET @MSG = @MSG + 'Style Header - Style Name Field is not defined<br>' 
	IF LEN(ISNULL(@Description,'')) = 0 
		SET @MSG = @MSG + 'Style Header - Description Field is not defined<br>'  
	IF LEN(ISNULL(@Company,'')) = 0 
		SET @MSG = @MSG + 'Style Header - Company Field is not defined<br>'  
	IF LEN(ISNULL(@Division,'')) = 0 
		SET @MSG = @MSG + 'Style Header - Division Field is not defined<br>'
	IF LEN(ISNULL(@Brand,'')) = 0 
		SET @MSG = @MSG + 'Style Header - Brand Field is not defined<br>'
	IF LEN(ISNULL(@ProdCategory,'')) = 0 
		SET @MSG = @MSG + 'Style Header - Product Category Field not defined<br>'
	IF LEN(ISNULL(@MerchCategory,'')) = 0 
		SET @MSG = @MSG + 'Style Header - Merch Category Field not defined<br>'
	--IF LEN(ISNULL(@Group,'')) = 0 
		--SET @MSG = @MSG + 'Style Header - Group Field is not defined<br>'	 
	
	/*
	IF LEN(@MSG)=0 
		UPDATE pStyleHeader
		SET HeaderLocked = @StatusID  
		WHERE StyleID = @StyleID 
	*/

END 

/*
ELSE 
BEGIN
	UPDATE pStyleHeader	SET ApprovalStatus = @StatusId
	WHERE StyleID = @StyleID 
END  
*/

SET NOCOUNT OFF

IF @OUT = 1 
	SELECT @MSG as [Message]

	






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialRequestSubmitHeader_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_MaterialRequestSubmitHeader_SELECT] (
@MaterialRequestSubmitID UNIQUEIDENTIFIER 
)
AS 

SELECT pMaterialRequestWorkflow.MaterialRequestWorkflow + ' (' + pSeasonYear.Season + ' ' + pSeasonYear.Year + ')' 
FROM pMaterialTradePartner INNER JOIN
  pSeasonYear ON pMaterialTradePartner.SeasonYearID = pSeasonYear.SeasonYearID INNER JOIN
  pMaterialTradePartnerColor ON pMaterialTradePartner.MaterialTradePartnerId = pMaterialTradePartnerColor.MaterialTradePartnerID INNER JOIN
  pMaterialRequestSubmit ON pMaterialTradePartnerColor.MaterialTradePartnerColorID = pMaterialRequestSubmit.MaterialTradePartnerColorID INNER JOIN
  pMaterialRequestSubmitWorkflow ON 
  pMaterialRequestSubmit.MaterialRequestSubmitWorkflowID = pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID INNER JOIN
  pMaterialRequestWorkflow ON pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID = pMaterialRequestWorkflow.MaterialRequestWorkflowID
WHERE pMaterialRequestSubmit.MaterialRequestSubmitID = @MaterialRequestSubmitID


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleMaterialSeasonLogic_UPDATE]'
GO




ALTER PROCEDURE [dbo].[spx_StyleMaterialSeasonLogic_UPDATE] (
@StyleID UNIQUEIDENTIFIER,
@StyleSet INT,
@CUser NVARCHAR(200),
@CDate DATETIME 
)
AS


DECLARE @SeasonYearID UNIQUEIDENTIFIER 
DECLARE @StyleSeason NVARCHAR(50)
DECLARE @StyleYear NVARCHAR(50)
DECLARE @TOTAL_S INT
DECLARE @ROW_ID_S INT
DECLARE @MaterialID UNIQUEIDENTIFIER 

DECLARE @TOTAL_M INT
DECLARE @ROW_ID_M INT 

CREATE TABLE #season(
ROW_ID INT IDENTITY (1,1),
SeasonYearID UNIQUEIDENTIFIER,
StyleSeason NVARCHAR(50),
StyleYear NVARCHAR(50)
)

CREATE TABLE #material (
ROW_ID INT IDENTITY(1,1), 
MaterialID UNIQUEIDENTIFIER
)

INSERT INTO #season ( SeasonYearID, StyleSeason, StyleYear  ) 
SELECT SeasonYearID, StyleSeason, StyleYear 
FROM  pStyleSeasonYear WHERE StyleID = @StyleID

INSERT INTO #material (MaterialID) 
SELECT MaterialID FROM pStyleMaterials 
WHERE StyleID = @StyleID
AND StyleSet = @StyleSet

SELECT @TOTAL_S = COUNT(*) FROM  #season
SET @ROW_ID_S = 1 

SELECT @TOTAL_M = COUNT(*) FROM #material


WHILE @ROW_ID_S <= @TOTAL_S 
BEGIN
	SELECT @SeasonYearID = SeasonYearID,  @StyleSeason = StyleSeason , @StyleYear = StyleYear
	FROM  #season WHERE ROW_ID = @ROW_ID_S 

	--*****************************************************************************************
	-- Materials 
	SET @ROW_ID_M = 1
	WHILE @ROW_ID_M <= @TOTAL_M
	BEGIN

		SELECT @MaterialID = MaterialID FROM #material WHERE ROW_ID = @ROW_ID_M
		
		IF ( SELECT COUNT(*) FROM pMaterialSeasonYear WHERE MaterialID = @MaterialID  AND SeasonYearID = @SeasonYearID ) = 0 
		BEGIN
			INSERT INTO pMaterialSeasonYear ( MaterialSeasonYearID , SeasonYearID , MaterialID , CUser, CDate ) 
			VALUES ( NEWID(), @SeasonYearID , @MaterialID , @CUser, @CDate ) 
		END
		SET @ROW_ID_M = @ROW_ID_M + 1
	END 
	--*****************************************************************************************
	SET @ROW_ID_S  = @ROW_ID_S + 1
END 



DROP TABLE #season
DROP TABLE #material


--- ******************************************************************************************************************
-- Add SeasonYear to material based on IntraSeasonyear 

EXEC  spx_MaterialTradePartner_SeasonYear_Logic_INSERT  @StyleID = @StyleID, @CUser = @CUser, @CDate = @CDate





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanStyleAttribute_RangeLogic_UPDATE]'
GO

CREATE PROCEDURE [dbo].[spx_LinePlanStyleAttribute_RangeLogic_UPDATE](
@LinePlanRangeId UNIQUEIDENTIFIER,
@CUser NVARCHAR(200),
@CDate DATETIME 
)
AS

DECLARE @LinePlanItemID UNIQUEIDENTIFIER
DECLARE @LinePlanRangeAttributeID UNIQUEIDENTIFIER

DECLARE @LinePlanAttributeItemID1 UNIQUEIDENTIFIER
DECLARE @LinePlanAttributeItemID2 UNIQUEIDENTIFIER
DECLARE @LinePlanAttributeItemID3 UNIQUEIDENTIFIER
DECLARE @LinePlanAttributeItemID4 UNIQUEIDENTIFIER

SELECT @LinePlanAttributeItemID1 = LinePlanAttributeItemID1,
@LinePlanAttributeItemID2 = LinePlanAttributeItemID2,
@LinePlanAttributeItemID3 = LinePlanAttributeItemID3
FROM pLinePlanRange 
WHERE  LinePlanRangeID = @LinePlanRangeID

--===========================================================================================

DECLARE @NoStylesCO INT
DECLARE @NoStylesN INT
DECLARE @LinePlanStyleAttributeItemID UNIQUEIDENTIFIER 
DECLARE @CarryOver INT
DECLARE @New INT 
DECLARE @C_ITEM INT
DECLARE @REC_ID INT 
DECLARE @TOTAL INT 
DECLARE @Msg NVARCHAR(500) 
DECLARE @AttributeName NVARCHAR(200)

SET @Msg = '' 

SELECT  @NoStylesCO =  LinePlanRangeDelCO1, @NoStylesN = LinePlanRangeDelN1
FROM pLinePlanRange 
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'

SELECT IDENTITY(INT,1,1) AS REC_ID,AttributeName,
LinePlanRangeAttributeID, LinePlanStyleAttributeItemID, LinePlanRangeDelCO1, LinePlanRangeDelN1
INTO #tmpStyleItem
FROM pLinePlanRangeAttributeTemp 
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'
ORDER BY LinePlanFinancialSort

SELECT @TOTAL = COUNT(*) FROM #tmpStyleItem
SET @REC_ID = 1 


WHILE @REC_ID <= @TOTAL AND LEN(@Msg) = 0
BEGIN

	SELECT @CarryOver = LinePlanRangeDelCO1, @New = LinePlanRangeDelN1, 
	@LinePlanStyleAttributeItemID = LinePlanStyleAttributeItemID,
	@LinePlanRangeAttributeID = LinePlanRangeAttributeID,
	@AttributeName = AttributeName
	FROM #tmpStyleItem WHERE REC_ID  = @REC_ID

	IF @CarryOver IS NULL 
		SET @CarryOver  = 0 
	IF @New IS NULL
		SET @New = 0 

/******************************************************************/

	IF @CarryOver > 0  
	BEGIN

		SELECT LinePlanItemID, LinePlanStyleAttributeItemID, 0 AS Flag, StyleID
		INTO #styleCO 
		FROM pLinePlanItemTemp 
		WHERE LinePlanRangeID = @LinePlanRangeID 
		AND LinePlanRangeTypeId = '00000000-0000-0000-0000-000000000001'
		AND  ( LinePlanStyleAttributeItemID IS NULL OR  LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID )

		SELECT @C_ITEM = COUNT(*) FROM #styleCO WHERE LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID 
		SET @C_ITEM = @C_ITEM + 1 

		/*
		IF  @C_ITEM > @CarryOver 
		BEGIN
			SET @Msg = 'Please revise your allocation 1111' 
		END 
		*/

		WHILE @C_ITEM <= @CarryOver AND LEN(@Msg) = 0
		BEGIN 
			SET @LinePlanItemID  = NULL
			SELECT TOP 1 @LinePlanItemID = LinePlanItemID	
			FROM #styleCO WHERE LinePlanStyleAttributeItemID IS NULL AND StyleID = '00000000-0000-0000-0000-000000000000'

			IF @LinePlanItemID IS NOT NULL
			BEGIN
				UPDATE #styleCO 
				SET LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID 
				WHERE LinePlanItemID = @LinePlanItemID

				SET @C_ITEM = @C_ITEM + 1
			END 
			ELSE
			BEGIN
				SET @C_ITEM = @CarryOver + 100000
				--SET @Msg = @Msg + 'Please revise your allocation ('  + @AttributeName + ') <br/>' 
				SET @Msg = 'Please revise your allocation '

			END
		END 

		UPDATE pLinePlanItemTemp 
		SET LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID, 
		MUser = @CUser, MDate = @CDate
		WHERE LinePlanItemID IN ( 
			SELECT LinePlanItemID FROM #styleCO WHERE LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID
		)

		DROP TABLE #styleCO		
	END 

	/******************************************************************/
	IF @New > 0  AND LEN(@Msg) = 0
	BEGIN
				
		SELECT LinePlanItemID, LinePlanStyleAttributeItemID, 0 AS Flag , StyleID 
		INTO #styleNEW 
		FROM pLinePlanItemTemp
		WHERE LinePlanRangeID = @LinePlanRangeID 
		AND LinePlanRangeTypeId = '00000000-0000-0000-0000-000000000003'
		AND  ( LinePlanStyleAttributeItemID IS NULL OR  LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID )

		SELECT @C_ITEM = COUNT(*) FROM #styleNEW WHERE LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID 
		SET @C_ITEM = @C_ITEM + 1 


		/*
		--IF NOT ( @C_ITEM <= @New ) 
		IF @C_ITEM > @New  
		BEGIN
			select @C_ITEM , @New  
			SET @Msg = 'Please revise your allocation 333' 
		END 
		*/

		WHILE @C_ITEM <= @New
		BEGIN 
			SET @LinePlanItemID  = NULL
			SELECT TOP 1 @LinePlanItemID = LinePlanItemID	
			FROM #styleNEW WHERE LinePlanStyleAttributeItemID IS NULL AND StyleID = '00000000-0000-0000-0000-000000000000'

			IF @LinePlanItemID IS NOT NULL
			BEGIN
				UPDATE #styleNEW 
				SET LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID 
				WHERE LinePlanItemID = @LinePlanItemID

				SET @C_ITEM = @C_ITEM + 1
			END 
			ELSE
			BEGIN
				SET @C_ITEM = @New + 100000
				--SET @Msg = @Msg + 'Please revise your allocation ('  + @AttributeName + ') <br/>' 
			SET @Msg = 'Please revise your allocation '
			END 
		END 

		UPDATE pLinePlanItemTemp
		SET LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID,
		MUser = @CUser, MDate = @CDate
		WHERE LinePlanItemID IN ( 
			SELECT LinePlanItemID FROM #styleNEW WHERE LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID
		)

		DROP TABLE #styleNEW		
	END   --new styles 

	
	SELECT @CarryOver = COUNT(*) FROM pLinePlanItemTemp 
	WHERE LinePlanRangeID = @LinePlanRangeID 
	AND LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001'
	AND LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID

	SELECT @New = COUNT(*) FROM pLinePlanItemTemp
	WHERE LinePlanRangeID = @LinePlanRangeID 
	AND LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003'
	AND LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID

	UPDATE pLinePlanRangeAttributeTemp
	SET LinePlanRangeDelCO1 = @CarryOver, LinePlanRangeDelN1 = @New
	WHERE LinePlanRangeAttributeID = @LinePlanRangeAttributeID

	SET @REC_ID = @REC_ID +  1

END 



IF LTRIM(RTRIM(@Msg)) = ''
BEGIN

	-- UPDATE Attribute table TABLE from TEMP

	UPDATE pLinePlanRangeAttribute
	SET  LinePlanRangeDelCO1 = pLinePlanRangeAttributeTemp.LinePlanRangeDelCO1 , 
	LinePlanRangeDelN1 = pLinePlanRangeAttributeTemp.LinePlanRangeDelN1
	FROM pLinePlanRangeAttributeTemp INNER JOIN
	pLinePlanRangeAttribute ON pLinePlanRangeAttribute.LinePlanRangeAttributeID = pLinePlanRangeAttributeTemp.LinePlanRangeAttributeID
	WHERE pLinePlanRangeAttributeTemp.LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
	AND	pLinePlanRangeAttributeTemp.LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
	AND	pLinePlanRangeAttributeTemp.LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 
	AND pLinePlanRangeAttributeTemp.LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'	


	DELETE FROM pLinePlanRangeAttributeTemp
	WHERE pLinePlanRangeAttributeTemp.LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
	AND	pLinePlanRangeAttributeTemp.LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
	AND	pLinePlanRangeAttributeTemp.LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 
	AND pLinePlanRangeAttributeTemp.LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'	

	
	--Update pLinePlanItem from TEMP

	UPDATE pLinePlanItem
	SET LinePlanStyleAttributeItemID = pLinePlanItemTemp.LinePlanStyleAttributeItemID, 
	MUser = pLinePlanItemTemp.MUser, MDate = pLinePlanItemTemp.MDate
	FROM pLinePlanItemTemp INNER JOIN	
	pLinePlanItem ON pLinePlanItemTemp.LinePlanItemID =  pLinePlanItem.LinePlanItemID
	WHERE pLinePlanItemTemp.LinePlanRangeID = @LinePlanRangeId


		UPDATE pLinePlanItemTemp 
		SET LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID, 
		MUser = @CUser, MDate = @CDate

	
	DELETE FROM pLinePlanItemTemp WHERE pLinePlanItemTemp.LinePlanRangeID = @LinePlanRangeId

END 
ELSE 
	SET @Msg = '
<table width=''100%'' border=0>
<tr >
<td valign=''center'' align=''right''><img src="../System/Icons/icon_warning_32.gif" /></td>
<td valign=''center'' align=''left''><span style="font-size:14px;font-weight:bold" class=''fontRed'' >' + @Msg  + '</span></td>
</tr></table>
'




SELECT @Msg AS Msg











GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialTradePartnerColorCheck_SELECT]'
GO
SET QUOTED_IDENTIFIER OFF
GO

                    CREATE PROCEDURE [dbo].[spx_MaterialTradePartnerColorCheck_SELECT] (@MaterialTradePartnerColorID UNIQUEIDENTIFIER )
                        AS

                          DECLARE @MaterialTradePartnerID UNIQUEIDENTIFIER 
                          DECLARE @MaterialID UNIQUEIDENTIFIER 
                          DECLARE @MaterialColorID UNIQUEIDENTIFIER 
                          DECLARE @TradepartnerVendorId UNIQUEIDENTIFIER 
                          DECLARE @SeasonYearID UNIQUEIDENTIFIER


                          SELECT @MaterialTradePartnerID = a.MaterialTradePartnerID, @MaterialID = a.MaterialID, 
                                 @TradepartnerVendorId = b.TradepartnerVendorId, @SeasonYearID = b.SeasonYearID ,
                                 @MaterialColorID = MaterialColorID
                            FROM pMaterialTradePartnerColor a
                                 INNER JOIN pMaterialTradePartner b ON a.MaterialTradePartnerID = b.MaterialTradePartnerId
                                 WHERE a.MaterialTradePartnerColorID = @MaterialTradePartnerColorID

                          SELECT  COUNT(*)
                            FROM pStyleSourcingItem a
                                 INNER JOIN pStyleSourcing b ON a.StyleSourcingID = b.StyleSourcingID 
                                 INNER JOIN pStyleSeasonYear c ON c.StyleSeasonYearID = b.StyleSeasonYearID 
                                 INNER JOIN pStyleMaterials d ON d.StyleMaterialID = a.StyleMaterialID 
                                 INNER JOIN pStyleColorway e ON e.StyleColorID = a.StyleColorID 
                                 INNER JOIN pStyleColorwayItem f ON ( f.StyleColorID = a.StyleColorID AND f.StyleMaterialID = a.StyleMaterialID 
		                            AND f.MaterialColorID = @MaterialColorID)
                           WHERE c.SeasonYearID = @SeasonYearID
                             AND d.MaterialID = @MaterialID
                             AND a.TradePartnerVendorID = @TradepartnerVendorId
                  
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialRequestSubmitItem_DELETE]'
GO
SET QUOTED_IDENTIFIER ON
GO


/*
Comments:

#01 - Ryan Cabanas - August 27, 2009
	There's a new feature to the Material Sample Workflow area under a TradePartner
at the Material.  You are now able to have an "all colors" workflow bubble, but
there is still individual color records behind the scenes.  Need to make sure that
they are in sync when something changes.
*/


ALTER PROCEDURE [dbo].[spx_MaterialRequestSubmitItem_DELETE](@MaterialRequestSubmitItemID uniqueidentifier)
AS 


--/************/
--/*Testing.	*/
--/************/
--BEGIN
--	DECLARE @MaterialRequestSubmitItemID uniqueidentifier
--
--	SET @MaterialRequestSubmitItemID = '7841d5dd-338a-46bf-87d8-67cea98eeb85'
--END



--Comment #01
/********************************************************************/
/*Get some pertinent info before the original grid item is deleted.	*/
/********************************************************************/
BEGIN
	/*Declare Variables.*/
	DECLARE @MaterialRequestSubmitID uniqueidentifier
	DECLARE @MaterialRequestWorkflowItemID uniqueidentifier
	DECLARE @MaterialRequestSubmitItemCustom1 nvarchar(200)

	/*Get grid item info.*/
	SELECT @MaterialRequestSubmitID = MaterialRequestSubmitID
		,@MaterialRequestWorkflowItemID = MaterialRequestWorkflowItemID
		,@MaterialRequestSubmitItemCustom1 = MaterialRequestSubmitItemCustom1
	FROM pMaterialRequestSubmitItem
	WHERE MaterialRequestSubmitItemID  = @MaterialRequestSubmitItemID
END



--Comment #01
/********************************************************/
/*Find out if the workflow is a 'no color' workflow.	*/
/********************************************************/
BEGIN
	/*Declare variable.*/
	DECLARE @MaterialRequestWorkflowColor int

	/*Get flag.  If '0', then it's a 'no color' workflow.*/
	SELECT @MaterialRequestWorkflowColor = MaterialRequestWorkflowColor
	FROM pMaterialRequestSubmitItem
		INNER JOIN pMaterialRequestSubmit	ON	pMaterialRequestSubmitItem.MaterialRequestSubmitID = pMaterialRequestSubmit.MaterialRequestSubmitID
		INNER JOIN pMaterialRequestSubmitWorkflow	ON	pMaterialRequestSubmit.MaterialRequestSubmitWorkflowID = pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID
		INNER JOIN pMaterialRequestWorkflow	ON	pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID = pMaterialRequestWorkflow.MaterialRequestWorkflowID
	WHERE pMaterialRequestSubmitItem.MaterialRequestSubmitItemID = @MaterialRequestSubmitItemID
END



DELETE FROM pMaterialRequestSubmitItem 
WHERE MaterialRequestSubmitItemID  = @MaterialRequestSubmitItemID



--Comment #01
/*Delete grid record from other 'no color' workflows, if applicable.*/
IF @MaterialRequestWorkflowColor = 0	--It's a 'no color' grid record.
	BEGIN
		/*Declare variables.*/
		DECLARE @MaterialRequestSubmitID_Original uniqueidentifier
		DECLARE @MaterialRequestSubmitID_Other uniqueidentifier
		DECLARE @TotalCount int
		DECLARE @RowCounter int

		/*Create temp table.*/
		CREATE TABLE #temp_MaterialRequestSubmitIDs(
			TableRow int identity(1,1)
			,MaterialRequestSubmitID uniqueidentifier)

		/*Use my own variable names.*/
		SET @MaterialRequestSubmitID_Original = @MaterialRequestSubmitID

		/*Get IDs of the other 'no color' records.*/
		INSERT INTO #temp_MaterialRequestSubmitIDs(MaterialRequestSubmitID)
		SELECT pMaterialRequestSubmit_OtherColors.MaterialRequestSubmitID
		FROM pMaterialRequestSubmitWorkflow
			INNER JOIN pMaterialRequestSubmit	ON	pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID = pMaterialRequestSubmit.MaterialRequestSubmitWorkflowID
													AND pMaterialRequestSubmitWorkflow.Submit = pMaterialRequestSubmit.Submit
			INNER JOIN pMaterialRequestSubmitWorkflow AS pMaterialRequestSubmitWorkflow_OtherColors	ON	pMaterialRequestSubmitWorkflow.MaterialTradePartnerID = pMaterialRequestSubmitWorkflow_OtherColors.MaterialTradePartnerID
																										AND pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID = pMaterialRequestSubmitWorkflow_OtherColors.MaterialRequestWorkflowID
																										AND pMaterialRequestSubmitWorkflow.Submit = pMaterialRequestSubmitWorkflow_OtherColors.Submit
			INNER JOIN pMaterialRequestSubmit AS pMaterialRequestSubmit_OtherColors	ON	pMaterialRequestSubmitWorkflow_OtherColors.MaterialRequestSubmitWorkflowID = pMaterialRequestSubmit_OtherColors.MaterialRequestSubmitWorkflowID
													AND pMaterialRequestSubmitWorkflow_OtherColors.Submit = pMaterialRequestSubmit_OtherColors.Submit
		WHERE pMaterialRequestSubmit.MaterialRequestSubmitID = @MaterialRequestSubmitID_Original
			AND pMaterialRequestSubmit_OtherColors.MaterialRequestSubmitID <> @MaterialRequestSubmitID_Original

		/*Get and set counts.*/
		SELECT @TotalCount = COUNT(*) FROM #temp_MaterialRequestSubmitIDs
		SET @RowCounter = 1

		/*Loop to add grid records for the other 'no colors'.*/
		WHILE(@RowCounter <= @TotalCount)
			BEGIN
				/*Get a 'MaterialRequestSubmitID'.*/
				SELECT @MaterialRequestSubmitID_Other = MaterialRequestSubmitID
				FROM #temp_MaterialRequestSubmitIDs
				WHERE TableRow = @RowCounter

				/*Delete grid record for other 'no color'.*/
				DELETE
				FROM pMaterialRequestSubmitItem
				WHERE MaterialRequestSubmitID  = @MaterialRequestSubmitID_Other
					AND MaterialRequestWorkflowItemID = @MaterialRequestWorkflowItemID
					AND MaterialRequestSubmitItemCustom1 = @MaterialRequestSubmitItemCustom1

				/*Up row counter.*/
				SET @RowCounter = @RowCounter + 1
			END

		/*Drop temp table.*/
		DROP TABLE #temp_MaterialRequestSubmitIDs
	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LineFolderItemColor_SELECT]'
GO


ALTER PROCEDURE [dbo].[spx_LineFolderItemColor_SELECT]
(
@StyleID uniqueidentifier,
@LineFolderItemID uniqueidentifier
)
AS 

SELECT     dbo.pLineFolderItemColor.LineFolderItemColorID, dbo.pLineFolderItemColor.LineFolderItemID, dbo.pLineFolderItemColor.LineFolderID, 
      dbo.pLineFolderItemColor.LineFolderItemColorDrop, dbo.pLineFolderItemColor.LineFolderItemColorDropUser, 
      dbo.pLineFolderItemColor.LineFolderItemColorDropDate, dbo.pStyleColorway.StyleColorID, dbo.pStyleColorway.StyleID, 
      dbo.pStyleColorway.StyleColorStandardID, dbo.pStyleColorway.StyleColorNo, dbo.pStyleColorway.StyleColorName, dbo.pStyleColorway.Sort, 
      dbo.pLineFolderItemColor.CDate, dbo.pLineFolderItemColor.CUser, dbo.pLineFolderItemColor.MDate, dbo.pLineFolderItemColor.MUser,
      dbo.pStyleColorway.StyleColorName as ColorComboDescription
FROM         dbo.pLineFolderItemColor WITH (NOLOCK) INNER JOIN
      dbo.pStyleColorway WITH (NOLOCK) ON dbo.pLineFolderItemColor.StyleColorID = dbo.pStyleColorway.StyleColorID
WHERE  pLineFolderItemColor.StyleID = @StyleID AND pLineFolderItemColor.LineFolderItemID = @LineFolderItemID
ORDER BY pStyleColorway.Sort, pStyleColorway.StyleColorNo, pStyleColorway.StyleColorName



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanStyleAttribute_RangeLogicReset_UPDATE]'
GO
CREATE PROCEDURE dbo.spx_LinePlanStyleAttribute_RangeLogicReset_UPDATE (
@LinePlanRangeId UNIQUEIDENTIFIER
)
AS 

UPDATE pLinePlanItem
SET LinePlanStyleAttributeItemID =  NULL 
WHERE LinePlanRangeID = @LinePlanRangeID
AND StyleID = '00000000-0000-0000-0000-000000000000'



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_Material_AgentVendorLabDipSubmit_SELECT]'
GO

-- kris j commented out
--EXEC sp_refreshview N'[dbo].[vwx_Material_AgentVendorLabDipSubmit_SELECT]'
--GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialTradePartnerCheck_SELECT]'
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE PROCEDURE [dbo].[spx_MaterialTradePartnerCheck_SELECT] (
@MaterialTradePartnerID UNIQUEIDENTIFIER 
)
AS


DECLARE @MaterialID UNIQUEIDENTIFIER 
DECLARE @TradepartnerVendorId UNIQUEIDENTIFIER 
DECLARE @SeasonYearID UNIQUEIDENTIFIER


SELECT @MaterialID = b.MaterialID, 
@TradepartnerVendorId = b.TradepartnerVendorId, @SeasonYearID = b.SeasonYearID 
FROM pMaterialTradePartner b 
WHERE b.MaterialTradePartnerID = @MaterialTradePartnerID


SELECT  COUNT(*)
FROM pStyleSourcingItem a
INNER JOIN pStyleSourcing b ON a.StyleSourcingID = b.StyleSourcingID 
INNER JOIN pStyleSeasonYear c ON c.StyleSeasonYearID = b.StyleSeasonYearID 
INNER JOIN pStyleMaterials d ON d.StyleMaterialID = a.StyleMaterialID 
INNER JOIN pStyleColorway e ON e.StyleColorID = a.StyleColorID 
INNER JOIN pStyleColorwayItem f ON ( f.StyleColorID = a.StyleColorID AND f.StyleMaterialID = a.StyleMaterialID )
WHERE c.SeasonYearID = @SeasonYearID
AND d.MaterialID = @MaterialID
AND a.TradePartnerVendorID = @TradepartnerVendorId
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[dpx_StyleTypeBreakdown_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[dpx_StyleTypeBreakdown_SELECT]

(
@Season nvarchar(100) = NULL,
@Year nvarchar(100) = NULL
)

AS 

SELECT pStyleHeader.StyleType,COUNT(pStyleHeader.StyleType) AS [Value], pStyleType.StyleTypeDescription,
pStyleType.StyleTypeDescription + ' (' + CAST((CAST(CAST(COUNT(pStyleHeader.StyleType)AS decimal(10,3))/(SELECT CAST(COUNT(*)AS decimal(10,3)) FROM pStyleHeader INNER JOIN pStyleType ON pStyleHeader.StyleType = pStyleType.StyleTypeID)AS decimal(10,2))*100) AS VARCHAR(10)) + '%)' AS [Name] 
FROM pStyleHeader INNER JOIN pStyleType ON pStyleHeader.StyleType = pStyleType.StyleTypeID 
GROUP BY pStyleHeader.StyleType, pStyleType.StyleTypeDescription
ORDER BY [Value] ASC
--HAVING (@Season is null or pStyleHeader.CustomField2 = @Season)
--and (@Year is null or pStyleHeader.CustomField4 = @Year)


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialRequestSubmitItem_INSERT]'
GO


/*
Comments:

#01 - Ryan Cabanas - August 27, 2009
	There's a new feature to the Material Sample Workflow area under a TradePartner
at the Material.  You are now able to have an "all colors" workflow bubble, but
there is still individual color records behind the scenes.  Need to make sure that
they are in sync when something changes.
*/


ALTER PROCEDURE [dbo].[spx_MaterialRequestSubmitItem_INSERT](
	@MaterialRequestSubmitID uniqueidentifier,
	@CUser varchar(200), 
	@CDate datetime,
	@RequestMultiplier INT = 0
) 
AS 


--/************/
--/*Testing.	*/
--/************/
--BEGIN
--	DECLARE @MaterialRequestSubmitID uniqueidentifier
--	DECLARE @CUser varchar(200)
--	DECLARE @CDate datetime
--	DECLARE @RequestMultiplier INT
--
--	SET @MaterialRequestSubmitID = '0C53B7FF-6A84-4576-B781-2EA07306E0BE'
--	SET @CUser = 'Joe Blow'
--	SET @CDate = '2009-08-28 22:22:22:000'
--	SET @RequestMultiplier = 2
--END


DECLARE @counter int
SET @counter = 0
WHILE @counter < @RequestMultiplier
	BEGIN
		SET @counter = @counter + 1

		INSERT INTO pMaterialRequestSubmitItem (
			MaterialRequestSubmitID, 
			MaterialRequestWorkflowItemID, 
			MaterialRequestSubmitItemStatus, 
			CUser, 
			CDate, 
			MUser, 
			MDate) 
		VALUES
			(@MaterialRequestSubmitID, 
			'00000000-0000-0000-0000-000000000000', 
			0, 
			@CUser, 
			@CDate, 
			@CUser, 
			@CDate)


	END

/* DISABLED BY Daniel 10-18-2009
--Comment #01
/*Entirely new section to handle 'no color' workflows.  Update the other 'no colors' information for the workflow.*/
/********************************************************/
/*Find out if the workflow is a 'no color' workflow.	*/
/********************************************************/
BEGIN
	/*Declare variable.*/
	DECLARE @MaterialRequestWorkflowColor int

	/*Get flag.  If '0', then it's a 'no color' workflow.*/
	SELECT @MaterialRequestWorkflowColor = MaterialRequestWorkflowColor
	FROM pMaterialRequestSubmit
		INNER JOIN pMaterialRequestSubmitWorkflow	ON	pMaterialRequestSubmit.MaterialRequestSubmitWorkflowID = pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID
		INNER JOIN pMaterialRequestWorkflow	ON	pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID = pMaterialRequestWorkflow.MaterialRequestWorkflowID
	WHERE pMaterialRequestSubmit.MaterialRequestSubmitID = @MaterialRequestSubmitID
END


IF @MaterialRequestWorkflowColor = 0	--'No color' workflow.	--Comment #01
	BEGIN
		/*Declare variables.*/
		DECLARE @MaterialRequestSubmitID_Original uniqueidentifier
		DECLARE @MaterialRequestSubmitID_Other uniqueidentifier
		DECLARE @TotalCount int
		DECLARE @RowCounter int

		/*Create temp table.*/
		CREATE TABLE #temp_MaterialRequestSubmitIDs(
			TableRow int identity(1,1)
			,MaterialRequestSubmitID uniqueidentifier)

		/*Use my own variable names.*/
		SET @MaterialRequestSubmitID_Original = @MaterialRequestSubmitID

		/*Get IDs of the other 'no color' records.*/
		INSERT INTO #temp_MaterialRequestSubmitIDs(MaterialRequestSubmitID)
		SELECT pMaterialRequestSubmit_OtherColors.MaterialRequestSubmitID
		FROM pMaterialRequestSubmitWorkflow
			INNER JOIN pMaterialRequestSubmit	ON	pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID = pMaterialRequestSubmit.MaterialRequestSubmitWorkflowID
													AND pMaterialRequestSubmitWorkflow.Submit = pMaterialRequestSubmit.Submit
			INNER JOIN pMaterialRequestSubmitWorkflow AS pMaterialRequestSubmitWorkflow_OtherColors	ON	pMaterialRequestSubmitWorkflow.MaterialTradePartnerID = pMaterialRequestSubmitWorkflow_OtherColors.MaterialTradePartnerID
																										AND pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID = pMaterialRequestSubmitWorkflow_OtherColors.MaterialRequestWorkflowID
																										AND pMaterialRequestSubmitWorkflow.Submit = pMaterialRequestSubmitWorkflow_OtherColors.Submit
			INNER JOIN pMaterialRequestSubmit AS pMaterialRequestSubmit_OtherColors	ON	pMaterialRequestSubmitWorkflow_OtherColors.MaterialRequestSubmitWorkflowID = pMaterialRequestSubmit_OtherColors.MaterialRequestSubmitWorkflowID
													AND pMaterialRequestSubmitWorkflow_OtherColors.Submit = pMaterialRequestSubmit_OtherColors.Submit
		WHERE pMaterialRequestSubmit.MaterialRequestSubmitID = @MaterialRequestSubmitID_Original
			AND pMaterialRequestSubmit_OtherColors.MaterialRequestSubmitID <> @MaterialRequestSubmitID_Original

		/*Get and set counts.*/
		SELECT @TotalCount = COUNT(*) FROM #temp_MaterialRequestSubmitIDs
		SET @RowCounter = 1

		/*Loop to add grid records for the other 'no colors'.*/
		WHILE(@RowCounter <= @TotalCount)
			BEGIN
				/*Get a 'MaterialRequestSubmitID'.*/
				SELECT @MaterialRequestSubmitID_Other = MaterialRequestSubmitID
				FROM #temp_MaterialRequestSubmitIDs
				WHERE TableRow = @RowCounter

				/********************************/
				/*Use Daniel's code from above.	*/
				/********************************/
				SET @counter = 0

				WHILE @counter < @RequestMultiplier
					BEGIN
						SET @counter = @counter + 1

						INSERT INTO pMaterialRequestSubmitItem (
							MaterialRequestSubmitID, 
							MaterialRequestWorkflowItemID, 
							MaterialRequestSubmitItemStatus, 
							CUser, 
							CDate, 
							MUser, 
							MDate) 
						VALUES
							(@MaterialRequestSubmitID_Other, 
							'00000000-0000-0000-0000-000000000000', 
							0, 
							@CUser, 
							@CDate, 
							@CUser, 
							@CDate)
					END

				/*Up row counter.*/
				SET @RowCounter = @RowCounter + 1
			END

		/*Drop temp table.*/
		DROP TABLE #temp_MaterialRequestSubmitIDs
	END

*/



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LineFolderItemColorAvailable_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_LineFolderItemColorAvailable_SELECT]
(
@StyleID uniqueidentifier,
@LineFolderItemID uniqueidentifier
)
AS 


SELECT * , StyleColorName as ColorComboDescription
FROM  pStyleColorway WITH (NOLOCK) 
WHERE StyleID = @StyleID AND  StyleColorID NOT IN (SELECT StyleColorID FROM pLineFolderItemColor WITH (NOLOCK)
WHERE LineFolderItemID = @LineFolderItemID)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleMaterialLogic_UPDATE]'
GO

ALTER  PROCEDURE [dbo].[spx_StyleMaterialLogic_UPDATE] (
@StyleID UNIQUEIDENTIFIER,
@StyleSet INT, 
@MDate DATETIME,
@MUser NVARCHAR (200)
)
AS 


DECLARE @MatRow INT
DECLARE @MatCurrent INT
DECLARE @MatTotal INT

DECLARE @StyleMaterialMasterID UNIQUEIDENTIFIER 
DECLARE @MaterialTrack INT
DECLARE @UOM NVARCHAR(50)
DECLARE @Qty NVARCHAR(18)
DECLARE @MaterialPrice MONEY 
DECLARE @MaterialSize NVARCHAR (200)
DECLARE @MaterialSizeID UNIQUEIDENTIFIER 
DECLARE @Colorway INT
DECLARE @Artwork INT
DECLARE @License INT
DECLARE @Placement NVARCHAR(4000)

DECLARE @StyleMaterialID  UNIQUEIDENTIFIER
DECLARE @MaterialID UNIQUEIDENTIFIER

/**********************************************************************/
-- Update MaterialSize 
CREATE TABLE #tmpMat  (
	ROWID INT IDENTITY(1,1),
	StyleMaterialID UNIQUEIDENTIFIER ,
	MaterialID UNIQUEIDENTIFIER ,
	MaterialSizeID UNIQUEIDENTIFIER 
)

INSERT INTO  #tmpMat  ( StyleMaterialID, MaterialID, MaterialSizeID)
SELECT  StyleMaterialID, MaterialID, MaterialSizeID
FROM pStyleMaterials 
WHERE StyleID = @StyleID 
AND StyleSet = @StyleSet 

SET @MatRow = 1
SELECT @MatTotal = COUNT (*)  FROM #tmpMat

WHILE @MatRow <= @MatTotal 
BEGIN
	SELECT @StyleMaterialID =  StyleMaterialID , @MaterialID = MaterialID , @MaterialSizeID = MaterialSizeID
	FROM #tmpMat
	WHERE ROWID = @MatRow

	IF @MaterialSizeID IS NULL OR @MaterialSizeID  = '00000000-0000-0000-0000-000000000000'
		SET @MaterialSize = '*NA'
	ELSE
		SELECT @MaterialSize = MaterialSize FROM pMaterialSize WHERE MaterialSizeID = @MaterialSizeID 

	UPDATE pStyleMaterials SET MaterialSize = @MaterialSize WHERE StyleMaterialID = @StyleMaterialID 
		
	SET @MatRow = @MatRow  + 1 
END 



CREATE TABLE #tmpMaterial  (
	ROWID INT IDENTITY(1,1),
	StyleMaterialMasterID UNIQUEIDENTIFIER , 
	MaterialTrack INT, 
	UOM NVARCHAR(50),
	Qty NVARCHAR(18),
	MaterialPrice MONEY ,
	MaterialSize NVARCHAR (200),
	MaterialSizeID UNIQUEIDENTIFIER , 
	Colorway INT,
	Artwork INT,
	License INT, 
	Placement NVARCHAR(4000)
)

INSERT INTO  #tmpMaterial (StyleMaterialMasterID , MaterialTrack, UOM,Qty, MaterialPrice, MaterialSize, MaterialSizeID , 
Colorway, Artwork, License, Placement )
SELECT StyleMaterialMasterID , MaterialTrack, UOM,Qty, MaterialPrice, MaterialSize, MaterialSizeID , 
Colorway, Artwork, License, Placement
FROM pStyleMaterials 
WHERE StyleID = @StyleID AND StyleSet = @StyleSet 
AND MaterialLinked = 1


DECLARE @DevelopmentID UNIQUEIDENTIFIER 
DECLARE @Variation INT 

SELECT @DevelopmentID = StyleDevelopmentID, @Variation = Variation 
FROM pStyleDevelopmentItem 
WHERE StyleID = @StyleID


SELECT @MatTotal  = COUNT(*) FROM #tmpMaterial
SET @MatCurrent = 1 

WHILE @MatCurrent <= @MatTotal 
BEGIN
	
	SELECT @StyleMaterialMasterID = StyleMaterialMasterID,
	@MaterialTrack = MaterialTrack,
	@UOM = UOM,
	@Qty = Qty,
	@MaterialPrice = MaterialPrice,
	@MaterialSize = MaterialSize,
	@MaterialSizeID = MaterialSizeID,
	@Colorway = Colorway,
	@Artwork = Artwork, 
	@License = License,
	@Placement = Placement
	FROM #tmpMaterial WHERE ROWID = @MatCurrent

	UPDATE pStyleMaterials SET 
	MaterialTrack = @MaterialTrack,
	UOM = @UOM,
	Qty = @Qty,
	MaterialPrice = @MaterialPrice,
	MaterialSize = @MaterialSize,
	MaterialSizeID = @MaterialSizeID,
	Colorway = @Colorway,
	Artwork = @Artwork, 
	License = @License,
	Placement = @Placement ,
	MDate = @MDate,
	MUser  = @MUser 
	WHERE 	StyleMaterialMasterID =  @StyleMaterialMasterID	
	AND MaterialLinked = 1 
	AND StyleID IN ( 
		SELECT StyleID FROM pStyleDevelopmentItem 
		WHERE StyleDevelopmentID = @DevelopmentID
		AND StyleID <>  @StyleID
		AND Variation  = @Variation
	)  

	SET @MatCurrent = @MatCurrent + 1 

END 

DROP TABLE #tmpMaterial 


-------------------------------------------------------------
-- Update pStyleHeader 


DECLARE @MaterialImageID UNIQUEIDENTIFIER
DECLARE @MaterialImageVersion INT
DECLARE @MaterialNo NVARCHAR (50)
DECLARE @MaterialName  NVARCHAR (200)


SELECT TOP  1  
@MaterialID = MaterialID , 
@MaterialImageID = MaterialImageID,
@MaterialImageVersion  = MaterialImageVersion ,
@MaterialNo = MaterialNo ,
@MaterialName = MaterialName ,
@StyleMaterialID = StyleMaterialID
FROM pStyleMaterials 
WHERE StyleID = @StyleID AND MainMaterial = 1

UPDATE pStyleHeader SET 
MaterialID = @MaterialID , 
MaterialImageID = @MaterialImageID,
MaterialImageVersion  = @MaterialImageVersion ,
MaterialNo = @MaterialNo ,
MaterialName = @MaterialName ,
StyleMaterialID = @StyleMaterialID
WHERE StyleID = @StyleID 































GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleMaterialLogic_Linked_UPDATE]'
GO
CREATE PROCEDURE [dbo].[spx_StyleMaterialLogic_Linked_UPDATE]
(
	@StyleID UNIQUEIDENTIFIER,
	@StyleSet INT, 
	@MDate DATETIME,
	@MUser NVARCHAR (200)
)

AS 


/************************/
/*Declare variables.	*/
/************************/
DECLARE @StyleID_Param UNIQUEIDENTIFIER			--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT						--Keep a copy of the original parameter value.

DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleMaterialLogic_UPDATE
			@StyleID_Param
			,@StyleSet_Param
			,@MDate
			,@MUser
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet_Param AS StyleSet
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID
	END


/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Get the 'StyleID' for the update.*/
		SELECT @StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleMaterialLogic_UPDATE
			@StyleID
			,@StyleSet
			,@MDate
			,@MUser


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleCoversheet_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_StyleCoversheet_SELECT](@StyleID uniqueidentifier)
AS SELECT     dbo.Mapping.Map, dbo.Mapping.MapDetail, dbo.pStyleWorkflow.StyleID, dbo.pStyleWorkflow.WorkflowID, 
                      dbo.Users.FirstName + ' ' + dbo.Users.LastName AS FullName, dbo.Users.Title, dbo.Users.Email, dbo.Users.Phone
FROM         dbo.pStyleWorkflow WITH (NOLOCK) INNER JOIN
                      dbo.Mapping WITH (NOLOCK) ON dbo.pStyleWorkflow.WorkflowID = dbo.Mapping.Map INNER JOIN
                      dbo.Users WITH (NOLOCK) ON dbo.pStyleWorkflow.WorkAssignedTo = dbo.Users.UserId
GROUP BY dbo.Mapping.Map, dbo.Mapping.MapDetail, dbo.pStyleWorkflow.StyleID, dbo.pStyleWorkflow.WorkflowID, 
                      dbo.Users.FirstName + ' ' + dbo.Users.LastName, dbo.Users.Title, dbo.Users.Email, dbo.Users.Phone, dbo.pStyleWorkflow.WorkSort
HAVING      (dbo.pStyleWorkflow.StyleID = @StyleID)
ORDER BY dbo.pStyleWorkflow.WorkSort



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanStyleAttribute_RangeLogicResetTemp_UPDATE]'
GO
create  PROCEDURE [dbo].[spx_LinePlanStyleAttribute_RangeLogicResetTemp_UPDATE] (
@LinePlanRangeId UNIQUEIDENTIFIER
)
AS 


DELETE FROM pLinePlanItemTemp  WHERE LinePlanRangeID = @LinePlanRangeID 

INSERT INTO pLinePlanItemTemp (LinePlanItemID, LinePlanRangeID, StyleID ,  LinePlanStyleAttributeItemID, LinePlanRangeTypeID  ) 
SELECT LinePlanItemID, LinePlanRangeID, StyleID, LinePlanStyleAttributeItemID, LinePlanRangeTypeID 
FROM pLinePlanItem
WHERE LinePlanRangeID = @LinePlanRangeID


UPDATE pLinePlanItemTemp
SET LinePlanStyleAttributeItemID =  NULL 
WHERE LinePlanRangeID = @LinePlanRangeID
AND StyleID = '00000000-0000-0000-0000-000000000000'





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pBodyChange]'
GO
CREATE TABLE [dbo].[pBodyChange]
(
[BodyChangeID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_pBodyChange_BodyChangeID] DEFAULT (newid()),
[BodyChangeNo] [int] NOT NULL IDENTITY(1, 1),
[BodyStatus] [bit] NULL CONSTRAINT [DF_pBodyChange_BodyStatus] DEFAULT ((0)),
[WorkflowID] [uniqueidentifier] NULL,
[BodyID] [uniqueidentifier] NULL,
[BodySet] [int] NULL,
[BodyChangeNotifyTo] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[BodyChangeType] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[BodyChangeDescription] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[BodyChangeBy] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[BodyChangeDate] [datetime] NULL,
[ActiveID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_pBodyChange_ActiveID] DEFAULT ('{00000000-0000-0000-0000-000000000000}'),
[Active] [bit] NOT NULL CONSTRAINT [DF_pBodyChange_Active] DEFAULT ((1))
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK__pBodyChange__68487DD7] on [dbo].[pBodyChange]'
GO
ALTER TABLE [dbo].[pBodyChange] ADD CONSTRAINT [PK__pBodyChange__68487DD7] PRIMARY KEY CLUSTERED  ([BodyChangeID], [BodyChangeNo])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_LineFolder_Global_Category_SELECT]'
GO



--- Modified version from rpx_LineFolder_Global_SELECT,   by Paul Kim, 6/5/2008 
--- 1) To give options on selection of category data: from table or  custom field
--- 2) To have sort option : sort by category or  style no




ALTER       procedure [dbo].[rpx_LineFolder_Global_Category_SELECT]
	@Season varchar(50) = null,
	@Year varchar(50) = null,
	@Category varchar(50) = null,

	@CategoryFrom int = -999,   -- Category From Table or custome field
	@SortBy	int = -999
as

/*Test values*/
-- DECLARE	@Season varchar(50)
-- DECLARE	@Year varchar(50)
-- DECLARE	@Category varchar(50)
-- SET @Season = NULL
-- SET @Year = NULL
-- SET @Category = NULL


/*Variables*/
DECLARE @ImageFolder varchar(200)
DECLARE @StrCategory varchar(255)

/*Set default values*/
SET @ImageFolder = (SELECT TOP 1 SettingValue FROM rReportSetting WITH (NOLOCK) WHERE SettingType = 'ImagePath')

/*Get the string version of the StyleCategory for the report header*/
--SELECT @StrCategory = StyleCategory
--FROM pStyleCategory WITH (NOLOCK)
--WHERE CAST(StyleCategoryID AS varchar(50)) = @Category

IF @SortBy IS NULL or @SortBy = -999
BEGIN
 SET @SortBy = 1
END


IF @CategoryFrom IS NULL or @CategoryFrom = -999
BEGIN
 SET @CategoryFrom = 1
END

/*Create temp tables*/
CREATE TABLE #tempLineFolderStyles
(
	TableRow int identity(0,1),
	StyleID nvarchar(50),
	StyleNo nvarchar(50),
	[Description] nvarchar(255),
	ImageID nvarchar(50),
	ImageHistoryID varchar(50),
	SizeClass nvarchar(50),
	SizeRange nvarchar(50),
	MaterialName nvarchar(100),
	MaterialNo nvarchar(50),
	Colorways nvarchar(2000),
	ItemCategory nvarchar(200)
)

IF @CategoryFrom = 1 and @SortBy = 1   --- Category data from the CustomField5 of pStyleHeader and sort by the category
	BEGIN
		/*Insert info into temp table.*/
		INSERT INTO #tempLineFolderStyles(
			StyleID, 
			StyleNo, 
			[Description], 
			ImageID, 
			ImageHistoryID,
			SizeClass, 
			SizeRange, 
			MaterialName,
			MaterialNo,
			ItemCategory
		)
		SELECT 	b.StyleID, 
			b.StyleNo, 
			b.[Description], 
			c.ImageID, 
			c.ImageHistoryID,
			b.SizeClass, 
			b.SizeRange, 
			d.MaterialName,
			d.MaterialNo,
			b.CustomField5 as ItemCategory
		FROM pStyleHeader b WITH (NOLOCK) 
		INNER JOIN hImage c WITH (NOLOCK) ON b.DesignSketchID = c.ImageID AND b.DesignSketchVersion = c.Version 
		LEFT OUTER JOIN pMaterial d WITH (NOLOCK) ON b.MaterialID = d.MaterialID
		--LEFT OUTER JOIN pStyleCategory e WITH (NOLOCK) ON	b.StyleCategory = e.StyleCategoryID
		WHERE (@Season is null or b.CustomField2 = @Season)
		and (@Year is null or b.CustomField4 = @Year)
		and (@Category is null or  b.CustomField5 = @Category)
		ORDER BY --e.StyleCategory, b.StyleNo, b.[Description]
		          b.CustomField5, b.StyleNo, b.[Description]
        END

IF @CategoryFrom = 1 and @SortBy = 2 ---  Category from the CustomField5 of pStyleHeader and sort by StyleNo
	BEGIN
		/*Insert info into temp table.*/
		INSERT INTO #tempLineFolderStyles(
			StyleID, 
			StyleNo, 
			[Description], 
			ImageID, 
			ImageHistoryID,
			SizeClass, 
			SizeRange, 
			MaterialName,
			MaterialNo,
			ItemCategory
		)
		SELECT 	b.StyleID, 
			b.StyleNo, 
			b.[Description], 
			c.ImageID, 
			c.ImageHistoryID,
			b.SizeClass, 
			b.SizeRange, 
			d.MaterialName,
			d.MaterialNo,
			b.CustomField5 as ItemCategory
		FROM pStyleHeader b WITH (NOLOCK) 
		INNER JOIN hImage c WITH (NOLOCK) ON b.DesignSketchID = c.ImageID AND b.DesignSketchVersion = c.Version 
		LEFT OUTER JOIN pMaterial d WITH (NOLOCK) ON b.MaterialID = d.MaterialID
		--LEFT OUTER JOIN pStyleCategory e WITH (NOLOCK) ON	b.StyleCategory = e.StyleCategoryID
		WHERE (@Season is null or b.CustomField2 = @Season)
		and (@Year is null or b.CustomField4 = @Year)
		and (@Category is null or  b.CustomField5 = @Category)
		ORDER BY --e.StyleCategory, b.StyleNo, b.[Description]
		         b.StyleNo, b.[Description],  b.CustomField5
        END


IF @CategoryFrom = 2 and @SortBy = 1  --- Category data from pStyleCategory Table and Sort by category
	BEGIN
		/*Insert info into temp table.*/
		INSERT INTO #tempLineFolderStyles(
			StyleID, 
			StyleNo, 
			[Description], 
			ImageID, 
			ImageHistoryID,
			SizeClass, 
			SizeRange, 
			MaterialName,
			MaterialNo,
			ItemCategory
		)
		SELECT 	b.StyleID, 
			b.StyleNo, 
			b.[Description], 
			c.ImageID, 
			c.ImageHistoryID,
			b.SizeClass, 
			b.SizeRange, 
			d.MaterialName,
			d.MaterialNo,
			e.StyleCategory as ItemCategory
		FROM pStyleHeader b WITH (NOLOCK) 
		INNER JOIN hImage c WITH (NOLOCK) ON b.DesignSketchID = c.ImageID AND b.DesignSketchVersion = c.Version 
		LEFT OUTER JOIN pMaterial d WITH (NOLOCK) ON b.MaterialID = d.MaterialID
		LEFT OUTER JOIN pStyleCategory e WITH (NOLOCK) ON	b.StyleCategory = e.StyleCategoryID
		WHERE (@Season is null or b.CustomField2 = @Season)
		and (@Year is null or b.CustomField4 = @Year)
		and (@Category is null or CAST(b.StyleCategory AS varchar(50)) = @Category)
		ORDER BY e.StyleCategory, b.StyleNo, b.[Description]
		          --b.CustomField5, b.StyleNo, b.[Description]
        END


IF  @CategoryFrom = 2 and @SortBy = 2 --- --- Category data from pStyleCategory Table and Sort by StyleNo
	BEGIN
		/*Insert info into temp table.*/
		INSERT INTO #tempLineFolderStyles(
			StyleID, 
			StyleNo, 
			[Description], 
			ImageID, 
			ImageHistoryID,
			SizeClass, 
			SizeRange, 
			MaterialName,
			MaterialNo,
			ItemCategory
		)
		SELECT 	b.StyleID, 
			b.StyleNo, 
			b.[Description], 
			c.ImageID, 
			c.ImageHistoryID,
			b.SizeClass, 
			b.SizeRange, 
			d.MaterialName,
			d.MaterialNo,
			e.StyleCategory as ItemCategory
		FROM pStyleHeader b WITH (NOLOCK) 
		INNER JOIN hImage c WITH (NOLOCK) ON b.DesignSketchID = c.ImageID AND b.DesignSketchVersion = c.Version 
		LEFT OUTER JOIN pMaterial d WITH (NOLOCK) ON b.MaterialID = d.MaterialID
		LEFT OUTER JOIN pStyleCategory e WITH (NOLOCK) ON	b.StyleCategory = e.StyleCategoryID
		WHERE (@Season is null or b.CustomField2 = @Season)
		and (@Year is null or b.CustomField4 = @Year)
		and (@Category is null or CAST(b.StyleCategory AS varchar(50)) = @Category)
		ORDER BY b.StyleNo, b.[Description], e.StyleCategory
		         
        END





create table #StyleColorways
(
	RowNum int identity(1,1),
	StyleID varchar(50),
	MainColor nvarchar(100)
)

insert #StyleColorways (StyleID, MainColor)
select StyleID, MainColor
from pStyleColorway WITH (NOLOCK)
where StyleID in (select StyleID from #tempLineFolderStyles)

declare @counter int, @maxcount int
set @counter = 1

select @maxcount = max(RowNum)
from #StyleColorways

while (@counter <= @maxcount)
begin
	update s
	set s.Colorways = isnull(s.Colorways, '') + rtrim(c.MainColor) + ', '
	from #tempLineFolderStyles s
	inner join #StyleColorways c on s.StyleID = c.StyleID
	where c.RowNum = @counter

	set @counter = @counter + 1
end

/*Select the information how you want for the report.*/
SELECT
	TableRow % 4 AS [Column],
	@StrCategory AS Category,
	StyleID,
	StyleNo,
	[Description],
	@ImageFolder + '/{' + ImageID + '}/Version/600/{' + ImageHistoryID + '}.png' AS FilePath,
	SizeClass,
	SizeRange,
	MaterialName,
	MaterialNo,
	substring(Colorways, 1, len(Colorways)-1) as Colorways,
	ItemCategory
FROM #tempLineFolderStyles

/*Drop the temp tables*/
drop table #StyleColorways
DROP TABLE #tempLineFolderStyles





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_Material_AgentVendorLabDipSubmitItem_SELECT]'
GO
--
-- kris j commented out.
--
--EXEC sp_refreshview N'[dbo].[vwx_Material_AgentVendorLabDipSubmitItem_SELECT]'
--GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[sAccessBodyFolder]'
GO
CREATE TABLE [dbo].[sAccessBodyFolder]
(
[AccessBodyId] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_sAccessBodyFolder_AccessBodyId] DEFAULT (newid()),
[BodyTypeId] [int] NULL,
[AccessRoleId] [int] NOT NULL CONSTRAINT [DF_sAccessBodyFolder_AccessRoleId] DEFAULT ((0)),
[AccessView] [int] NOT NULL CONSTRAINT [DF_sAccessBodyFolder_AccessView] DEFAULT ((0)),
[AccessCreate] [int] NOT NULL CONSTRAINT [DF_sAccessBodyFolder_AccessCreate] DEFAULT ((0)),
[AccessModify] [int] NOT NULL CONSTRAINT [DF_sAccessBodyFolder_AccessModify] DEFAULT ((0)),
[AccessRemove] [int] NOT NULL CONSTRAINT [DF_sAccessBodyFolder_AccessRemove] DEFAULT ((0)),
[AccessDelete] [int] NOT NULL CONSTRAINT [DF_sAccessBodyFolder_AccessDelete] DEFAULT ((0)),
[AccessPrint] [int] NOT NULL CONSTRAINT [DF_sAccessBodyFolder_AccessPrint] DEFAULT ((0)),
[TeamId] [uniqueidentifier] NOT NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_sAccessBodyFolder] on [dbo].[sAccessBodyFolder]'
GO
ALTER TABLE [dbo].[sAccessBodyFolder] ADD CONSTRAINT [PK_sAccessBodyFolder] PRIMARY KEY CLUSTERED  ([AccessBodyId])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_User_DesktopAccessBodyFolderCheck_INSERT]'
GO

CREATE PROCEDURE [dbo].[spx_User_DesktopAccessBodyFolderCheck_INSERT]
(
@TeamId uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

DECLARE @I as int
DECLARE @Row_Count int
DECLARE @BodyTypeID int 
DECLARE @DeskAccessId int
DECLARE @DeskTableName varchar(100)
DECLARE @DeskTableKey varchar(50)


	BEGIN
	CREATE TABLE #TempUserAccess (
		Id int IDENTITY (1, 1) NOT NULL , 
		BodyTypeID int NOT NULL,
		TeamId uniqueidentifier
	) 
	END

	BEGIN
	
	INSERT INTO #TempUserAccess( BodyTypeID) SELECT BodyTypeID FROM pBodyType WITH (NOLOCK)
	
	
	SET @Row_Count = (SELECT COUNT(*) FROM #TempUserAccess)
	
	SET @I = 1

	WHILE @I <= @Row_Count 
		BEGIN

			SELECT @BodyTypeID = BodyTypeID FROM #TempUserAccess WHERE ID = @I
			IF (SELECT COUNT(*) FROM sAccessBodyFolder WITH (NOLOCK) WHERE BodyTypeId = @BodyTypeID  AND TeamId = @TeamId) = 0
			BEGIN
				INSERT INTO sAccessBodyFolder
					( BodyTypeId, TeamId, CUser, CDate, MUser, MDate)
				SELECT BodyTypeId, @TeamId, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate 
				FROM  #TempUserAccess WHERE Id = @I
			END
				
			SET @I = @I + 1
		END

		SELECT * FROM #tempUserAccess

	END




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialRequestSubmitItem_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_MaterialRequestSubmitItem_SELECT](@MaterialRequestSubmitID uniqueidentifier)
AS 

SELECT  * FROM pMaterialRequestSubmitItem 
WHERE MaterialRequestSubmitID  = @MaterialRequestSubmitID
ORDER BY MaterialRequestSubmitItemSort, MaterialRequestSubmitItemCustom1






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Style_Sourcing_Template_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.

#02 - Ryan Cabanas - September 23, 2009
	Replace the old color image string with the new color image string using function.
Deleted old code.
*/


ALTER    PROCEDURE [dbo].[rpx_Style_Sourcing_Template_SELECT]
(
	@StyleSourcingID nvarchar(255)
)

AS

--Variables.
DECLARE @StyleID uniqueidentifier


--Temp tables.
CREATE TABLE #tempSourcingHeaderInfo
(
	TableRow int identity(1,1),
	SourcingName nvarchar(200),
	Active int,
	Trade_Partner nvarchar(200),
	Vendor nvarchar(200)
)

CREATE TABLE #tempAllSourcingInfo
(
	TableRow int identity(1,1),
	SourcingName nvarchar(200),
	Active int,
	Trade_Partner nvarchar(200),
	Vendor nvarchar(200),
	StyleID uniqueidentifier,
	StyleSet int,
	SetName nvarchar(50),
	Colorway_Name nvarchar(100),
	Material_Image_Path nvarchar(1000),
	Material nvarchar(255),
	Treatment_Size_Guage nvarchar(200),
	Supplier_Mill nvarchar(400),
	Color_Image_Path nvarchar(1000),
	Rating nvarchar(50),
	UOM nvarchar(50),
	Price money
)

--Get StyleID from the pStyleSourcing table.
SELECT	@StyleID = StyleID
FROM	pStyleSourcing
WHERE	StyleSourcingID = @StyleSourcingID


--Get header information for the sourcing template.
INSERT INTO #tempSourcingHeaderInfo(
	SourcingName,
	Active,
	Trade_Partner,
	Vendor)
SELECT	pStyleSourcing.SourcingName,
	pStyleSourcing.Active,
	uTradePartner.TradePartnerName AS Trade_Partner,
	uTradePartnerVendor.VendorName AS Vendor--,
--	pStyleSourcing.*
FROM	pStyleSourcing
	LEFT OUTER JOIN uTradePartner ON	pStyleSourcing.TradePartnerID = uTradePartner.TradePartnerID
	LEFT OUTER JOIN uTradePartnerVendor ON	pStyleSourcing.TradePartnerVendorID = uTradePartnerVendor.TradePartnerVendorID
WHERE	pStyleSourcing.StyleID = @StyleID

--Get individual sourcing material records.
INSERT INTO #tempAllSourcingInfo(
	StyleSet,
	Colorway_Name,
	Material_Image_Path,
	Material,
	Treatment_Size_Guage,
	Supplier_Mill,
	Color_Image_Path,
	Rating,
	UOM,
	Price)
SELECT	pStyleSourcingItem.StyleSet,
	pStyleColorway.MainColor AS Colorway_Name,
	dbo.fnx_GetStreamingImagePath(hImage.ImageID, hImage.[Version]) AS Material_Image_Path,	--Comment #01
	pStyleMaterials.MaterialNo + ' - ' + pStyleMaterials.MaterialName AS Material,
	pStyleMaterials.MaterialSize AS Treatment_Size_Guage,
	uTradePartner.TradePartnerName + ' - ' + uTradePartnerVendor.VendorName AS Supplier_Mill,
	dbo.fnx_GetStreamingColorImagePath(pMaterialColor.ColorFolderID, pMaterialColor.ColorPaletteID) AS Color_Image_Path,	--Comment #02
	pStyleSourcingItem.Qty AS Rating,
	pStyleSourcingItem.UOM,
	pStyleSourcingItem.MaterialPrice AS Price
FROM	pStyleSourcingItem
	INNER JOIN pStyleColorway ON	pStyleSourcingItem.StyleColorID = pStyleColorway.StyleColorID
	LEFT OUTER JOIN pStyleColorwayItem ON	(pStyleSourcingItem.StyleColorID = pStyleColorwayItem.StyleColorID
											AND pStyleSourcingItem.StyleMaterialID = pStyleColorwayItem.StyleMaterialID)
	LEFT OUTER JOIN pMaterialColor ON	pStyleColorwayItem.MaterialColorID = pMaterialColor.MaterialColorID
	INNER JOIN pStyleMaterials ON	pStyleSourcingItem.StyleMaterialID = pStyleMaterials.StyleMaterialID
	LEFT OUTER JOIN	uTradePartnerVendor ON	pStyleSourcingItem.TradePartnerVendorID = uTradePartnerVendor.TradePartnerVendorID
	LEFT OUTER JOIN uTradePartner ON	uTradePartnerVendor.TradePartnerID = uTradePartner.TradePartnerID
	LEFT OUTER JOIN hImage ON	(pStyleMaterials.MaterialImageID = hImage.ImageID
								AND pStyleMaterials.MaterialImageVersion = hImage.Version)
WHERE	pStyleSourcingItem.StyleSourcingID = @StyleSourcingID
ORDER BY	pStyleSourcingItem.StyleSet,
	pStyleColorway.Sort,
	pStyleColorway.MainColor,
	pStyleMaterials.MainMaterial DESC,
	pStyleMaterials.MaterialType,
	pStyleMaterials.MaterialSort,
	pStyleMaterials.MaterialNo,
	pStyleMaterials.MaterialName

--Add the sourcing template header info to the full temp table.
UPDATE	#tempAllSourcingInfo
SET	#tempAllSourcingInfo.SourcingName = #tempSourcingHeaderInfo.SourcingName,
	#tempAllSourcingInfo.Active = #tempSourcingHeaderInfo.Active,
	#tempAllSourcingInfo.Trade_Partner = #tempSourcingHeaderInfo.Trade_Partner,
	#tempAllSourcingInfo.Vendor = #tempSourcingHeaderInfo.Vendor
FROM	#tempSourcingHeaderInfo

--Add the StyleID to the full temp table to do joins.
UPDATE	#tempAllSourcingInfo
SET	#tempAllSourcingInfo.StyleID = @StyleID

--Add the set names from the pStyleHeader table.
UPDATE	#tempAllSourcingInfo
SET	#tempAllSourcingInfo.SetName =	CASE
										WHEN #tempAllSourcingInfo.StyleSet = 1 THEN	PC1
										WHEN #tempAllSourcingInfo.StyleSet = 2 THEN	PC2
										WHEN #tempAllSourcingInfo.StyleSet = 3 THEN	PC3
										WHEN #tempAllSourcingInfo.StyleSet = 4 THEN	PC4
									END
FROM	#tempAllSourcingInfo
	INNER JOIN pStyleHeader ON	#tempAllSourcingInfo.StyleID = pStyleHeader.StyleID

--Set the default set names if the set names were NULL.
UPDATE	#tempAllSourcingInfo
SET	SetName =	CASE
					WHEN StyleSet = 1 THEN	'1st Set'
					WHEN StyleSet = 2 THEN	'2nd Set'
					WHEN StyleSet = 3 THEN	'3rd Set'
					WHEN StyleSet = 4 THEN	'4th Set'
				END
FROM	#tempAllSourcingInfo
WHERE	(SetName IS NULL
		OR SetName = '')

--Select the information for the report.
SELECT	--SourcingName,
--	Active,
--	Trade_Partner,
--	Vendor,
--	StyleID,
	StyleSet,
	SetName,
	Colorway_Name,
	Material_Image_Path,
	Material,
	Treatment_Size_Guage,
	Supplier_Mill,
	Color_Image_Path,
	Rating,
	UOM,
	Price
FROM	#tempAllSourcingInfo

--Drop temp tables.
DROP TABLE #tempSourcingHeaderInfo
DROP TABLE #tempAllSourcingInfo





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pStyleDocument]'
GO
ALTER TABLE [dbo].[pStyleDocument] ALTER COLUMN [SystemServerStorageID] [uniqueidentifier] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pLinePlanItemAttributeType]'
GO
CREATE TABLE [dbo].[pLinePlanItemAttributeType]
(
[LinePlanItemAttribueTypeID] [uniqueidentifier] NOT NULL CONSTRAINT [DF__pLinePlan__LineP__7DB1A7C4] DEFAULT (newid()),
[LinePlanAttributeTypeID] [int] NULL,
[StyleTypeID] [int] NULL,
[LinePlanItemSchema] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanStyleAttribute_Schema_SELECT]'
GO



CREATE PROCEDURE [dbo].[spx_LinePlanStyleAttribute_Schema_SELECT](
@LinePlanItemID UNIQUEIDENTIFIER ,
@StyleTypeID INT 
)
AS 

	DECLARE @LinePlanItemSchema NVARCHAR(200)

	IF @StyleTypeID  IS not NULL 
	BEGIN 
		SELECT @LinePlanItemSchema = c.LinePlanItemSchema
		FROM pLinePlanItem a 
		LEFT OUTER JOIN pLinePlanStyleAttributeItem b ON b.LinePlanStyleAttributeItemID = a.LinePlanStyleAttributeItemID
		LEFT OUTER JOIN pLinePlanItemAttributeType c ON b.LinePlanAttributeTypeID =  c.LinePlanAttributeTypeID 
		WHERE a.LinePlanItemID  = @LinePlanItemID
		AND  c.StyleTypeID = @StyleTypeID 
	END 

	SELECT @LinePlanItemSchema  AS LinePlanItemSchema






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_ImageFolder_Image_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.
*/


ALTER   PROCEDURE [dbo].[rpx_ImageFolder_Image_SELECT] 	 
	@ImageID varchar(255),	
	@Version int
AS


SELECT (dbo.fnx_GetStreamingImagePath(ImageID, [Version])) AS FilePath,	--Comment #01
	'Version: ' + CAST(@Version AS varchar(5)) AS Version,
	'Last Modified: ' + CAST(MDate AS varchar(50)) AS ModifiedDate
FROM	hImage 
WHERE (ImageID  = @ImageID) 
	AND (Version = @Version)


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_Material_Link_SELECT]'
GO
EXEC sp_refreshview N'[dbo].[vwx_Material_Link_SELECT]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_User_AccessBodyFolder_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_User_AccessBodyFolder_SELECT]
(@teamId uniqueidentifier)
AS 


SELECT pBodyType.BodyTypeID, pBodyType.BodyTypeDescription, 
	sAccessBodyFolder.AccessBodyId, 
	sAccessBodyFolder.AccessRoleId, sAccessBodyFolder.AccessView, sAccessBodyFolder.AccessCreate, 
	sAccessBodyFolder.AccessModify, sAccessBodyFolder.AccessDelete, sAccessBodyFolder.AccessPrint, 
	sAccessBodyFolder.TeamId, sAccessBodyFolder.CUser, sAccessBodyFolder.CDate, sAccessBodyFolder.MUser, 
	sAccessBodyFolder.MDate, pBodyType.BodyTypeOrder
FROM  pBodyType WITH (NOLOCK) INNER JOIN
    sAccessBodyFolder WITH (NOLOCK) ON pBodyType.BodyTypeID = sAccessBodyFolder.BodyTypeID
WHERE sAccessBodyFolder.TeamId = @teamId
ORDER BY pBodyType.BodyTypeOrder



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialRequestSubmitLogic_UPDATE]'
GO
ALTER PROCEDURE [dbo].[spx_MaterialRequestSubmitLogic_UPDATE] (
	@MaterialTradePartnerColorID UNIQUEIDENTIFIER,
	@MaterialTradePartnerID UNIQUEIDENTIFIER,  
	@MaterialRequestWorkflowID VARCHAR(10),
	@MaterialSubmit VARCHAR(2)
)
AS

DECLARE @MaterialRequestSubmitID UNIQUEIDENTIFIER,
		@Submit INT,
		@Status INT,
		@AssignedTo VARCHAR(200),
		@StartDate DATETIME,
		@DueDate DATETIME,
		@EndDate DATETIME,
		@MUser VARCHAR(200),
		@MDate DATETIME

SELECT TOP 1 
	@MaterialRequestSubmitID = pMaterialRequestSubmit.MaterialRequestSubmitID,
	@Submit = pMaterialRequestSubmit.Submit, 
	@Status = pMaterialRequestSubmit.Status, 
	@AssignedTo = pMaterialRequestSubmit.AssignedTo, 
	@StartDate = pMaterialRequestSubmit.StartDate, 
	@DueDate = pMaterialRequestSubmit.DueDate, 
	@EndDate = pMaterialRequestSubmit.EndDate,
	@MUser = pMaterialRequestSubmit.MUser,
	@MDate = pMaterialRequestSubmit.MDate 
FROM pMaterialRequestSubmitWorkflow INNER JOIN
	pMaterialRequestSubmit ON 
	pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID = pMaterialRequestSubmit.MaterialRequestSubmitWorkflowID
WHERE pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID = @MaterialTradePartnerColorID
	AND pMaterialRequestSubmitWorkflow.MaterialTradePartnerID = @MaterialTradePartnerID
	AND pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID = @MaterialRequestWorkflowID
	AND pMaterialRequestSubmitWorkflow.Submit = @MaterialSubmit
ORDER BY pMaterialRequestSubmit.Submit DESC


------------ BEGIN ----------
-- Daniel Pak 10/13/2009
-- Validate if ALLCOLORS

DECLARE @MaterialRequestSubmitAllColors int
SELECT @MaterialRequestSubmitAllColors = MaterialRequestSubmitAllColors FROM pMaterialRequestSubmitWorkflow 
	WHERE MaterialTradePartnerID= @MaterialTradePartnerID 
			AND MaterialRequestWorkflowID= @MaterialRequestWorkflowID

------------ END --------------


IF @Status =  1 --If Resubmit Status
	BEGIN
		--Get New MaterialRequestSubmitID
		DECLARE @NewMaterialRequestSubmitID UNIQUEIDENTIFIER,
				@NewSubmit INT

		SELECT @NewMaterialRequestSubmitID = newid(),
				@NewSubmit = @Submit + 1


		--Copy Submit values to new new resubmit
		INSERT INTO pMaterialRequestSubmitItem (
			MaterialRequestSubmitID, MaterialRequestSubmitItemStatus, MaterialRequestSubmitItemCustom1, 
			MaterialRequestSubmitItemCustom2, MaterialRequestSubmitItemCustom3, MaterialRequestSubmitItemCustom4, MaterialRequestSubmitItemCustom5, 
			MaterialRequestSubmitItemCustom6, MaterialRequestSubmitItemCustom7, MaterialRequestSubmitItemCustom8, MaterialRequestSubmitItemCustom9, 
			MaterialRequestSubmitItemCustom10, MaterialRequestSubmitItemSort, CUser, CDate, MUser, MDate
		) 
		SELECT @NewMaterialRequestSubmitID, MaterialRequestSubmitItemStatus, MaterialRequestSubmitItemCustom1, 
			MaterialRequestSubmitItemCustom2, MaterialRequestSubmitItemCustom3, MaterialRequestSubmitItemCustom4, MaterialRequestSubmitItemCustom5, 
			MaterialRequestSubmitItemCustom6, MaterialRequestSubmitItemCustom7, MaterialRequestSubmitItemCustom8, MaterialRequestSubmitItemCustom9, 
			MaterialRequestSubmitItemCustom10, MaterialRequestSubmitItemSort, CUser, CDate, MUser, MDate
		FROM pMaterialRequestSubmitItem 
		WHERE MaterialRequestSubmitID = @MaterialRequestSubmitID

		INSERT INTO pMaterialRequestSubmit (
			MaterialRequestSubmitID, MaterialRequestSubmitWorkflowID, 
			MaterialTradePartnerColorID, MaterialTradePartnerID, 
			Submit, [Status], AssignedTo, StartDate, RecDate, 
			RecBy, RecCarrier, RecTrackNo, RecWeight, VendorWeight, 
			VendorDate, VendorName, SubmitDays, ResubmitDays, DueDate, 
			RevDate, RevBy, EndDate, EndBy, 
			CUser, CDate, MUser, MDate, TUser, TDate, 
			AgentView, VendorComment, InternalComment
		)
		SELECT @NewMaterialRequestSubmitID, MaterialRequestSubmitWorkflowID, 
			MaterialTradePartnerColorID, MaterialTradePartnerID, 
			@NewSubmit AS Submit, 0 AS [Status], AssignedTo, StartDate, RecDate, 
			RecBy, RecCarrier, RecTrackNo, RecWeight, VendorWeight, 
			VendorDate, VendorName, SubmitDays, ResubmitDays, DueDate, 
			RevDate, RevBy, EndDate, EndBy, 
			CUser, CDate, MUser, MDate, TUser, TDate, 
			AgentView, VendorComment, InternalComment
		FROM pMaterialRequestSubmit
		WHERE MaterialRequestSubmitID = @MaterialRequestSubmitID AND Submit <> @NewSubmit

		IF @MaterialRequestSubmitAllColors = 1
			BEGIN
				--Update Workflow with new submit #
				UPDATE pMaterialRequestSubmitWorkflow SET 
					pMaterialRequestSubmitWorkflow.Submit = @NewSubmit, 
					pMaterialRequestSubmitWorkflow.Status = @Status, 
					pMaterialRequestSubmitWorkflow.AssignedTo = @AssignedTo, 
					pMaterialRequestSubmitWorkflow.StartDate = CONVERT(DATETIME, @StartDate, 112), 
					pMaterialRequestSubmitWorkflow.DueDate = CONVERT(DATETIME, @DueDate, 112), 
					pMaterialRequestSubmitWorkflow.EndDate = CONVERT(DATETIME, @EndDate, 112),
					pMaterialRequestSubmitWorkflow.MDate = @MDate,
					pMaterialRequestSubmitWorkflow.MUser = @MUser
				WHERE 
						pMaterialRequestSubmitWorkflow.MaterialTradePartnerID = @MaterialTradePartnerID
					AND pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID = @MaterialRequestWorkflowID
			END
		ELSE
			BEGIN
				--Update Workflow with new submit #
				UPDATE pMaterialRequestSubmitWorkflow SET 
					pMaterialRequestSubmitWorkflow.Submit = @NewSubmit, 
					pMaterialRequestSubmitWorkflow.Status = @Status, 
					pMaterialRequestSubmitWorkflow.AssignedTo = @AssignedTo, 
					pMaterialRequestSubmitWorkflow.StartDate = CONVERT(DATETIME, @StartDate, 112), 
					pMaterialRequestSubmitWorkflow.DueDate = CONVERT(DATETIME, @DueDate, 112), 
					pMaterialRequestSubmitWorkflow.EndDate = CONVERT(DATETIME, @EndDate, 112),
					pMaterialRequestSubmitWorkflow.MDate = @MDate,
					pMaterialRequestSubmitWorkflow.MUser = @MUser
				WHERE pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID = @MaterialTradePartnerColorID
					AND pMaterialRequestSubmitWorkflow.MaterialTradePartnerID = @MaterialTradePartnerID
					AND pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID = @MaterialRequestWorkflowID
					AND pMaterialRequestSubmitWorkflow.Submit = @Submit
			END



		UPDATE pMaterialRequestSubmitItem SET MaterialRequestSubmitItemStatus = 0 
		WHERE MaterialRequestSubmitID = @NewMaterialRequestSubmitID AND MaterialRequestSubmitItemStatus = 1 

	END

ELSE IF @Status = 2 OR @Status = 3 OR @Status = 4 

	BEGIN

			IF @MaterialRequestSubmitAllColors = 1
				BEGIN
					UPDATE pMaterialRequestSubmitWorkflow SET 
						--pMaterialRequestSubmitWorkflow.Submit = @Submit, 
						pMaterialRequestSubmitWorkflow.Status = @Status, 
						pMaterialRequestSubmitWorkflow.AssignedTo = @AssignedTo, 
						pMaterialRequestSubmitWorkflow.StartDate = CONVERT(DATETIME, @StartDate, 112), 
						pMaterialRequestSubmitWorkflow.DueDate = CONVERT(DATETIME, @DueDate, 112), 
						pMaterialRequestSubmitWorkflow.EndDate = CONVERT(DATETIME, getdate(), 112),
						pMaterialRequestSubmitWorkflow.MDate = @MDate,
						pMaterialRequestSubmitWorkflow.MUser = @MUser
					WHERE
							pMaterialRequestSubmitWorkflow.MaterialTradePartnerID = @MaterialTradePartnerID
						AND pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID = @MaterialRequestWorkflowID
						--AND pMaterialRequestSubmitWorkflow.Submit = @Submit

					UPDATE pMaterialRequestSubmit SET 
						EndBy = @MUser, 
						EndDate = CONVERT(DATETIME, getdate(), 112)
					WHERE MaterialRequestSubmitID = @MaterialRequestSubmitID
				END
			ELSE
				BEGIN
					UPDATE pMaterialRequestSubmitWorkflow SET 
						--pMaterialRequestSubmitWorkflow.Submit = @Submit, 
						pMaterialRequestSubmitWorkflow.Status = @Status, 
						pMaterialRequestSubmitWorkflow.AssignedTo = @AssignedTo, 
						pMaterialRequestSubmitWorkflow.StartDate = CONVERT(DATETIME, @StartDate, 112), 
						pMaterialRequestSubmitWorkflow.DueDate = CONVERT(DATETIME, @DueDate, 112), 
						pMaterialRequestSubmitWorkflow.EndDate = CONVERT(DATETIME, getdate(), 112),
						pMaterialRequestSubmitWorkflow.MDate = @MDate,
						pMaterialRequestSubmitWorkflow.MUser = @MUser
					WHERE pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID = @MaterialTradePartnerColorID 
						AND pMaterialRequestSubmitWorkflow.MaterialTradePartnerID = @MaterialTradePartnerID
						AND pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID = @MaterialRequestWorkflowID
						AND pMaterialRequestSubmitWorkflow.Submit = @Submit

					UPDATE pMaterialRequestSubmit SET 
						EndBy = @MUser, 
						EndDate = CONVERT(DATETIME, getdate(), 112)
					WHERE MaterialRequestSubmitID = @MaterialRequestSubmitID
				END
	END

ELSE IF @Status = 99
	BEGIN
		--DROP ALL COLOR
		UPDATE pMaterialRequestSubmitWorkflow SET 
			--pMaterialRequestSubmitWorkflow.Submit = @Submit, 
			pMaterialRequestSubmitWorkflow.Status = @Status, 
			pMaterialRequestSubmitWorkflow.AssignedTo = @AssignedTo, 
			pMaterialRequestSubmitWorkflow.StartDate = CONVERT(DATETIME, @StartDate, 112), 
			pMaterialRequestSubmitWorkflow.DueDate = CONVERT(DATETIME, @DueDate, 112), 
			pMaterialRequestSubmitWorkflow.EndDate = CONVERT(DATETIME, getdate(), 112),
			pMaterialRequestSubmitWorkflow.MDate = @MDate,
			pMaterialRequestSubmitWorkflow.MUser = @MUser
		WHERE pMaterialRequestSubmitWorkflow.MaterialTradePartnerID = @MaterialTradePartnerID
			AND (pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID = @MaterialTradePartnerColorID) 
			AND (pMaterialRequestSubmitWorkflow.Status = 0 OR pMaterialRequestSubmitWorkflow.Status = 99)	

		UPDATE pMaterialRequestSubmit SET pMaterialRequestSubmit.Status = pMaterialRequestSubmitWorkflow.Status
		FROM  pMaterialRequestSubmitWorkflow INNER JOIN
		  pMaterialRequestSubmit ON 
		  pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID = pMaterialRequestSubmit.MaterialRequestSubmitWorkflowID
		WHERE pMaterialRequestSubmitWorkflow.MaterialTradePartnerID = @MaterialTradePartnerID
			AND (pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID = @MaterialTradePartnerColorID) 
			AND (pMaterialRequestSubmitWorkflow.Status = 0 OR pMaterialRequestSubmitWorkflow.Status = 100)	

	END

ELSE IF @Status = 100
	BEGIN
		--DROP ALL WORKFLOW 
		UPDATE pMaterialRequestSubmitWorkflow SET 
			--pMaterialRequestSubmitWorkflow.Submit = @Submit, 
			pMaterialRequestSubmitWorkflow.Status = @Status, 
			pMaterialRequestSubmitWorkflow.AssignedTo = @AssignedTo, 
			pMaterialRequestSubmitWorkflow.StartDate = CONVERT(DATETIME, @StartDate, 112), 
			pMaterialRequestSubmitWorkflow.DueDate = CONVERT(DATETIME, @DueDate, 112), 
			pMaterialRequestSubmitWorkflow.EndDate = CONVERT(DATETIME, getdate(), 112),
			pMaterialRequestSubmitWorkflow.MDate = @MDate,
			pMaterialRequestSubmitWorkflow.MUser = @MUser
		WHERE pMaterialRequestSubmitWorkflow.MaterialTradePartnerID = @MaterialTradePartnerID
			AND (pMaterialRequestSubmitWorkflow.Status = 0 OR pMaterialRequestSubmitWorkflow.Status = 100)	

		UPDATE pMaterialRequestSubmit SET pMaterialRequestSubmit.Status = pMaterialRequestSubmitWorkflow.Status
		FROM  pMaterialRequestSubmitWorkflow INNER JOIN
		  pMaterialRequestSubmit ON 
		  pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID = pMaterialRequestSubmit.MaterialRequestSubmitWorkflowID
		WHERE pMaterialRequestSubmitWorkflow.MaterialTradePartnerID = @MaterialTradePartnerID
			AND (pMaterialRequestSubmitWorkflow.Status = 0 OR pMaterialRequestSubmitWorkflow.Status = 100)	

	END

ELSE

	IF @MaterialRequestSubmitAllColors = 1
		BEGIN
			UPDATE pMaterialRequestSubmitWorkflow SET 
				--pMaterialRequestSubmitWorkflow.Submit = @Submit, 
				pMaterialRequestSubmitWorkflow.Status = @Status, 
				pMaterialRequestSubmitWorkflow.AssignedTo = @AssignedTo, 
				pMaterialRequestSubmitWorkflow.StartDate = CONVERT(DATETIME, @StartDate, 112), 
				pMaterialRequestSubmitWorkflow.DueDate = CONVERT(DATETIME, @DueDate, 112), 
				pMaterialRequestSubmitWorkflow.EndDate = CONVERT(DATETIME, @EndDate, 112),
				pMaterialRequestSubmitWorkflow.MDate = @MDate,
				pMaterialRequestSubmitWorkflow.MUser = @MUser
			WHERE 
					pMaterialRequestSubmitWorkflow.MaterialTradePartnerID = @MaterialTradePartnerID
				AND pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID = @MaterialRequestWorkflowID
				--AND pMaterialRequestSubmitWorkflow.Submit = @Submit
		END
	ELSE		
		BEGIN
			UPDATE pMaterialRequestSubmitWorkflow SET 
				--pMaterialRequestSubmitWorkflow.Submit = @Submit, 
				pMaterialRequestSubmitWorkflow.Status = @Status, 
				pMaterialRequestSubmitWorkflow.AssignedTo = @AssignedTo, 
				pMaterialRequestSubmitWorkflow.StartDate = CONVERT(DATETIME, @StartDate, 112), 
				pMaterialRequestSubmitWorkflow.DueDate = CONVERT(DATETIME, @DueDate, 112), 
				pMaterialRequestSubmitWorkflow.EndDate = CONVERT(DATETIME, @EndDate, 112),
				pMaterialRequestSubmitWorkflow.MDate = @MDate,
				pMaterialRequestSubmitWorkflow.MUser = @MUser
			WHERE pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID = @MaterialTradePartnerColorID
				AND pMaterialRequestSubmitWorkflow.MaterialTradePartnerID = @MaterialTradePartnerID
				AND pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID = @MaterialRequestWorkflowID
				AND pMaterialRequestSubmitWorkflow.Submit = @Submit
		END







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_BodyHistory_SELECT]'
GO

CREATE  PROCEDURE [dbo].[spx_BodyHistory_SELECT]
(@TeamId uniqueidentifier)
AS 

SELECT BodyId, BodyNo, [Description] FROM pBody WITH (NOLOCK) WHERE BodyId IN (SELECT BodyId FROM pBodyHistory WITH (NOLOCK) WHERE TeamID = @TeamID) 
ORDER BY [CDate] DESC
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_SampleRequest_TimeLineSearch_SELECT]'
GO
EXEC sp_refreshview N'[dbo].[vwx_SampleRequest_TimeLineSearch_SELECT]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[sAccessGroupBodyFolder]'
GO
CREATE TABLE [dbo].[sAccessGroupBodyFolder]
(
[AccessBodyId] [uniqueidentifier] NOT NULL CONSTRAINT [DF_sAccessGroupBodyFolder_AccessBodyId] DEFAULT (newid()),
[BodyTypeId] [int] NULL,
[AccessRoleId] [int] NOT NULL CONSTRAINT [DF_sAccessGroupBodyFolder_AccessRoleId] DEFAULT ((0)),
[AccessView] [int] NOT NULL CONSTRAINT [DF_sAccessGroupBodyFolder_AccessView] DEFAULT ((0)),
[AccessCreate] [int] NOT NULL CONSTRAINT [DF_sAccessGroupBodyFolder_AccessCreate] DEFAULT ((0)),
[AccessRemove] [int] NOT NULL CONSTRAINT [DF_sAccessGroupBodyFolder_AccessRemove] DEFAULT ((0)),
[AccessModify] [int] NOT NULL CONSTRAINT [DF_sAccessGroupBodyFolder_AccessModify] DEFAULT ((0)),
[AccessDelete] [int] NOT NULL CONSTRAINT [DF_sAccessGroupBodyFolder_AccessDelete] DEFAULT ((0)),
[AccessPrint] [int] NOT NULL CONSTRAINT [DF_sAccessGroupBodyFolder_AccessPrint] DEFAULT ((0)),
[GroupID] [uniqueidentifier] NOT NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_sAccessGroupBodyFolder] on [dbo].[sAccessGroupBodyFolder]'
GO
ALTER TABLE [dbo].[sAccessGroupBodyFolder] ADD CONSTRAINT [PK_sAccessGroupBodyFolder] PRIMARY KEY CLUSTERED  ([AccessBodyId])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_Group_DesktopAccessBodyFolderCheck_INSERT]'
GO

CREATE PROCEDURE [dbo].[spx_Group_DesktopAccessBodyFolderCheck_INSERT] (
@GroupID uniqueidentifier, 
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

DECLARE @I as int
DECLARE @Row_Count int
DECLARE @BodyTypeID int 
DECLARE @DeskAccessId int
DECLARE @DeskTableName varchar(100)
DECLARE @DeskTableKey varchar(50)


	BEGIN
	CREATE TABLE #TempGroupAccess (
		Id int IDENTITY (1, 1) NOT NULL , 
		BodyTypeID int NOT NULL,
		GroupID uniqueidentifier 
	) 
	END

	BEGIN
	
	INSERT INTO #TempGroupAccess( BodyTypeID) SELECT BodyTypeID FROM pBodyType
	
	
	SET @Row_Count = (SELECT COUNT(*) FROM #TempGroupAccess)
	
	SET @I = 1

	WHILE @I <= @Row_Count 
		BEGIN

			SELECT @BodyTypeID = BodyTypeID FROM #TempGroupAccess WHERE ID = @I
			IF (SELECT COUNT(*) FROM sAccessGroupBodyFolder WITH (NOLOCK) WHERE BodyTypeId = @BodyTypeID  AND GroupID = @GroupID ) = 0
			BEGIN
				INSERT INTO sAccessGroupBodyFolder
					( BodyTypeId, GroupID, CUser, CDate, MUser, MDate)
				SELECT BodyTypeId, @GroupID, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate 
				FROM  #TempGroupAccess WHERE Id = @I
			END
				
			SET @I = @I + 1
		END

		SELECT * FROM #tempGroupAccess

	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleColorwaysAll_DELETE]'
GO




ALTER PROCEDURE [dbo].[spx_StyleColorwaysAll_DELETE](
@StyleID uniqueidentifier
)
AS 
	UPDATE  pStyleQuoteItem  SET StyleColorID = NULL 
	WHERE StyleColorID IN (
		Select StyleColorID FROM pStyleColorway WHERE StyleID = @StyleID 
	)


	DELETE FROM pStyleSourcingItem 
	WHERE StyleColorID IN (
		Select StyleColorID FROM pStyleColorway WHERE StyleID = @StyleID 
	)

	DELETE FROM pStyleColorwayItem WHERE StyleID = @StyleID
	DELETE FROM pStyleColorway WHERE StyleID = @StyleID
	DELETE FROM pStyleColorwaySeasonYear WHERE StyleID = @StyleID













GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialRequestSubmitShare_UPDATE]'
GO

CREATE PROCEDURE [dbo].[spx_MaterialRequestSubmitShare_UPDATE]  ( 
@MaterialRequestShare  INT , 
@MaterialTradePartnerColorID UNIQUEIDENTIFIER ,
@AgentView INT  =  NULL 
)
AS 


UPDATE pMaterialTradePartnerColor SET
	MaterialRequestShare = @MaterialRequestShare,
	AgentView = @AgentView
WHERE MaterialTradePartnerColorID = @MaterialTradePartnerColorID


/*

--Daniel Oct. 15 2009
--Need a new logic for sharing with srmOn
--for now it will just update the tables

DECLARE  @TradePartnerID UNIQUEIDENTIFIER 
DECLARE @StyleID UNIQUEIDENTIFIER 
DECLARE @StyleDevelopmentId UNIQUEIDENTIFIER 



IF @AgentView IS NULL 
	UPDATE pSampleRequestTrade SET SampleRequestShare = @SampleRequestShare 
	WHERE SampleRequestTradeID = @SampleRequestTradeID
ELSE 
	UPDATE pSampleRequestTrade SET SampleRequestShare = @SampleRequestShare  , AgentView = @AgentView
	WHERE SampleRequestTradeID = @SampleRequestTradeID



IF  @MaterialRequestShare   = 0 
BEGIN 
	
	SELECT  @TradePartnerID  =  TradePartnerID  FROM pSampleRequestTrade WITH (NOLOCK) WHERE  SampleRequestTradeID = @SampleRequestTradeID 
	DELETE FROM hSampleHistory  WHERE TeamID = @TradePartnerID   AND  SampleRequestTradeID = @SampleRequestTradeID
	
END
ELSE
BEGIN 

	SELECT @StyleID = StyleID ,  @TradePartnerID  = TradePartnerID  FROM pSampleRequestTrade WITH (NOLOCK) WHERE SampleRequestTradeID = @SampleRequestTradeID 
	IF  ( SELECT COUNT(*)   FROM  pStyleTeam WITH (NOLOCK) WHERE StyleID = @StyleID AND  TeamID = @TradePartnerID  )  =  0
	BEGIN 
		SELECT  @StyleDevelopmentId = DevelopmentId  FROM pStyleHeader WITH (NOLOCK) WHERE StyleID = @StyleID 
	
		INSERT INTO pStyleTeam  (  StyleTeamID , TeamID , StyleDevelopmentId,  StyleID ,  TradePartner  ) 
		VALUES (  NEWID() ,  @TradePartnerID ,   @StyleDevelopmentId ,  @StyleID ,  1 ) 
	
	END

END
*/



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_ImageCatalog_SELECT]'
GO



/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.
*/


ALTER  PROCEDURE [dbo].[rpx_ImageCatalog_SELECT] 
	@ImageCatalogID AS varchar(255)
AS


DECLARE	@tbl TABLE(RowNumb int IDENTITY(0,1), ImageCode nvarchar(100), ImageDescription nvarchar(200), 
	OrgImageName nvarchar(100), Designer nvarchar(100), CadDesigner nvarchar(100), Component nvarchar(100), 
	FilePath varchar(1000), CatalogName nvarchar(100), CatalogDescription nvarchar(250), 
	CUser nvarchar(100), CDate varchar(20), ImageSort varchar(10), ImageNo varchar(10))


INSERT INTO @tbl (ImageCode, ImageDescription, OrgImageName, Designer, CadDesigner, 
		Component, FilePath, CatalogName, CatalogDescription, 
		CUser, CDate, ImageSort, ImageNo)
SELECT	hi.ImageCode, hi.ImageDescription, hi.ImageSubFolder20 AS OrgImageName, 
	hi.ImageSubFolder21 AS Designer, hi.ImageSubFolder22 AS CadDesigner, 
	hi.ImageSubFolder5 AS Component, 
	(dbo.fnx_GetStreamingImagePath(hi.ImageID, hi.[Version])) AS FilePath,	--Comment #01
	ic.CatalogName, ic.CatalogDescription, 
	ic.CUser, CONVERT(varchar(20), ic.CDate, 101) AS CDate, ci.ImageSort, hi.ImageNo
FROM	pImageCatalog ic, pImageCatalogItem ci, hImage hi 
WHERE ((ci.ImageCatalogID = ic.ImageCatalogID) AND (ci.ImageID = hi.ImageID) 
	AND (ci.ImageVersion = hi.Version) 
	AND (ic.ImageCatalogID = @ImageCatalogID))
ORDER BY ci.ImageSort, hi.ImageCode


SELECT	RowNumb%4 AS TableColumn, RowNumb / 4   AS TableRow, ImageCode, ImageDescription, OrgImageName, Designer, CadDesigner, Component, 
	FilePath, CatalogName, CatalogDescription, CUser, CDate, ImageSort, ImageNo
FROM	@tbl  
ORDER BY ImageSort, ImageCode


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[iCustom3]'
GO
ALTER TABLE [dbo].[iCustom3] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_iCustom3_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_iCustom3] on [dbo].[iCustom3]'
GO
ALTER TABLE [dbo].[iCustom3] ADD CONSTRAINT [PK_iCustom3] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Style_MaterialColorwayL_SELECT]'
GO

/*
Comments:

#01 - Ryan Cabanas - 12/2/2008
	Robbie brought up a problem with this procedure, stating that when you rip a Style Colorway workflow page report for a 2nd, 3rd, or 4th set,
the report doesn't get any results, even though there are Materials, Colorways, and color chips.  There turned out to be a couple problems.  
Overall, the problem is that 'pStyleColorway' records never have a value other than '1' for the field 'StyleSet'.  It's the Materials in the
table 'pStyleMaterials' that store the different set numbers in the 'StyleSet' field of the 'pStyleMaterials' table.  Therefore, two changes 
needed to be made to this procedure, to the SELECT statement and it's joins.
	The first problem is that on the third line of the FROM area of the SELECT statement, there was the following condition, 
"pStyleColorway.StyleSet = pStyleMaterials.StyleSet AND".  This needed to be removed because the 'StyleSet' value betweeen these two tables
will never be the same because the 'pStyleColorway' records will never have a 'StyleSet' value other than '1'.  All the colorways are essentially
housed in the first set.  So when you add a colorway to a multi-set Style, the colorways are really only added as belonging to the first set, but
they get added to all other sets when showing on screen.  Therefore, you can never have different colorways from one set to the other.
	The second problem was with the conditional line, "WHERE pStyleColorway.StyleID = @StyleID AND pStyleColorway.StyleSet = @StyleSet".  Since
the 'StyleSet' value in 'pStyleColorway' will never be anything other than '1', this is incorrect.  Therefore, the two references here needed
to be changed from pointing to the table 'pStyleColorway' to 'pStyleMaterials'.

#02 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.

#03 - Ryan Cabanas - September 23, 2009
	Replace the old color image string with the new color image string using function.
Deleted old code.
*/


ALTER   PROCEDURE [dbo].[rpx_Style_MaterialColorwayL_SELECT]  
(
	@StyleID AS varchar(50), 	
	@StyleSet AS int
)
AS


--Create temp table.
CREATE TABLE #tempTable
(
	TableRow int identity(0,1),
	MaterialDescription varchar(255),
	StyleMaterialId varchar(50),
	Placement nvarchar(1000),
	MainColor varchar(255),
	Qty varchar(18),
	MaterialSize varchar(200),
	ColorName varchar(150),
	ColorCode varchar(50),
	FilePath varchar(255),
	MaterialColorNote nvarchar(1000),
	MaterialColorImageID varchar(50),
	MaterialColorImageVersion int
)


--Get the material colorway squares and put them in the temp table.
INSERT INTO #tempTable(
	MaterialDescription,
	StyleMaterialId,
	Placement,
	MainColor,
	Qty,
	MaterialSize,
	ColorName,
	ColorCode,
	FilePath,
	MaterialColorNote,
	MaterialColorImageID,
	MaterialColorImageVersion)
SELECT
	('(' + pStyleMaterials.MaterialNo + ') ' + pStyleMaterials.MaterialName) AS MaterialDescription, 
	CAST(pStyleMaterials.StyleMaterialId AS varchar(50)) AS StyleMaterialId,
	pStyleMaterials.Placement, 
	isnull('(' + pStyleColorway.StyleColorNo + ') ','') +  pStyleColorway.MainColor AS MainColor,
	pStyleMaterials.Qty,
	pStyleMaterials.MaterialSize,
	pMaterialColor.ColorName,
	pMaterialColor.ColorCode,
	dbo.fnx_GetStreamingColorImagePath(pMaterialColor.ColorFolderID, pMaterialColor.ColorPaletteID) AS FilePath,	--Comment #03
	pMaterialColor.MaterialColorNote,
	pMaterialColor.MaterialColorImageID,
	pMaterialColor.MaterialColorImageVersion
FROM pStyleColorway WITH (NOLOCK) LEFT OUTER JOIN pStyleMaterials WITH (NOLOCK) ON
pStyleColorway.StyleID = pStyleMaterials.StyleID AND		--Comment #01
pStyleMaterials.Colorway = '1' LEFT OUTER JOIN pStyleColorwayItem WITH (NOLOCK) ON
pStyleMaterials.StyleMaterialID = pStyleColorwayItem.StyleMaterialID AND
pStyleColorway.StyleColorID = pStyleColorwayItem.StyleColorID LEFT OUTER JOIN pMaterialColor WITH (NOLOCK) ON
pStyleColorwayItem.MaterialColorID = pMaterialColor.MaterialColorID
WHERE pStyleMaterials.StyleID = @StyleID AND pStyleMaterials.StyleSet = @StyleSet		--Comment #01
ORDER BY pStyleColorway.Sort, pStyleColorway.StyleColorName, pStyleColorway.StyleColorID,
pStyleMaterials.MainMaterial DESC, pStyleMaterials.MaterialType,
pStyleMaterials.MaterialSort, pStyleMaterials.MaterialNo

--Update the temp folder for the chips that are images from the Image folder.
UPDATE #tempTable
SET FilePath = dbo.fnx_GetStreamingImagePath(hImage.ImageID, hImage.[Version]),	--Comment #02
	ColorName = '(' + hImage.ImageNo + ')'
FROM #tempTable
	INNER JOIN hImage WITH (NOLOCK) ON	(#tempTable.MaterialColorImageID = hImage.ImageID
							AND #tempTable.MaterialColorImageVersion = hImage.Version)


--Update the temp table to include the "Die To Match (DTM)" feature request.
UPDATE #tempTable
SET ColorCode = 'DTM'
WHERE (ColorName IS NULL)
	AND (ColorCode IS NULL)
	AND (FilePath IS NULL)


--Get the desired columns from the original temp table.
SELECT
	TableRow % 3 AS [Column],
	MaterialDescription, 
	StyleMaterialId,
	Placement, 
	MainColor,
	Qty,
	MaterialSize,
	ColorName,
	ColorCode,
	FilePath,
	MaterialColorNote
FROM #tempTable


/*
SELECT *
FROM dbo.pStyleColorway WITH (NOLOCK) INNER JOIN
    dbo.pStyleColorwayItem WITH (NOLOCK) ON dbo.pStyleColorway.StyleColorID = dbo.pStyleColorwayItem.StyleColorID INNER JOIN
    dbo.pStyleMaterials WITH (NOLOCK) ON dbo.pStyleColorwayItem.StyleMaterialID = dbo.pStyleMaterials.StyleMaterialID INNER JOIN
    dbo.pMaterialColor WITH (NOLOCK) ON dbo.pStyleColorwayItem.MaterialColorID = dbo.pMaterialColor.MaterialColorID
*/

--Drop the Temp Table.
DROP TABLE #tempTable

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_SampleRequest_Wizard_AgentVendor_DEFAULT]'
GO
ALTER VIEW dbo.vwx_SampleRequest_Wizard_AgentVendor_DEFAULT
AS
SELECT     TOP (100) PERCENT dbo.uTradePartnerVendor.TradePartnerVendorID, dbo.uTradePartner.TradePartnerID, dbo.uTradePartner.TradePartnerCode, 
                      dbo.uTradePartner.TradePartnerName, dbo.uTradePartnerVendor.VendorCode, dbo.uTradePartnerVendor.VendorName, 
                      dbo.uTradePartner.Active AS TradePartnerActive, dbo.uTradePartnerVendor.Active AS TradePartnerVendorActive
FROM         dbo.uTradePartner INNER JOIN
                      dbo.uTradePartnerVendor ON dbo.uTradePartner.TradePartnerID = dbo.uTradePartnerVendor.TradePartnerID
WHERE     (dbo.uTradePartner.Active = 1)
ORDER BY dbo.uTradePartner.TradePartnerName
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LineFolderItemStyleWorkflow_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_LineFolderItemStyleWorkflow_SELECT]
(@StyleID uniqueidentifier)
AS 

DECLARE @DevelopmentId uniqueidentifier
SELECT @DevelopmentId = DevelopmentId FROM pStyleHeader WITH (NOLOCK) WHERE StyleId = @StyleId

CREATE TABLE #TempLineWorkflow (
	[LineId] [int] IDENTITY (1, 1) NOT NULL ,
	[Map] [uniqueidentifier] NULL ,
	[MapDetail] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL ,
	[StyleId] [uniqueidentifier] NULL ,
	[DevelopmentId] [uniqueidentifier] NULL ,
	[Sort] [smallint] NULL 
) 


INSERT INTO #TempLineWorkflow
    (Map, MapDetail, Sort, StyleId, DevelopmentId)
SELECT Mapping.Map, Mapping.MapDetail, pStyleWorkflow.WorkSort, @StyleID, @DevelopmentID
FROM pStyleWorkflow WITH (NOLOCK) INNER JOIN
    Mapping WITH (NOLOCK) ON pStyleWorkflow.WorkflowID = Mapping.Map INNER JOIN
    pStyleHeader WITH (NOLOCK) ON pStyleWorkflow.StyleID = pStyleHeader.StyleID
WHERE     (pStyleWorkflow.StyleID = @StyleID) AND (pStyleWorkflow.StyleSet = 1)
ORDER BY pStyleWorkflow.WorkSort


INSERT INTO #TempLineWorkflow
    (Map, MapDetail, StyleId, DevelopmentId)
VALUES
	('{50000000-0000-0000-0000-000000000005}', 'Costing', @StyleId, @DevelopmentId)


SELECT Map, MapDetail, StyleId, DevelopmentId FROM #TempLineWorkflow 



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Style_DevelopmentSpec_Image_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.
*/


ALTER    PROCEDURE [dbo].[rpx_Style_DevelopmentSpec_Image_SELECT] 
	@StyleID AS varchar(255), 
	@StyleSet int
AS
-- For Development Specification 


IF (@StyleSet = 1)
   BEGIN
	SELECT DISTINCT (dbo.fnx_GetStreamingImagePath(hi.ImageID, hi.[Version])) AS FilePath	--Comment #01
	FROM	pStyleImage si, hImage hi 
	WHERE	((si.SpecSketchID1 = hi.ImageID) 
		AND (si.SpecSketchVersion1 = hi.Version) 
		AND (CAST(si.StyleID AS varchar(255)) = @StyleID))
   END
ELSE IF (@StyleSet = 2)
   BEGIN
	SELECT DISTINCT (dbo.fnx_GetStreamingImagePath(hi.ImageID, hi.[Version])) AS FilePath	--Comment #01
	FROM	pStyleImage si, hImage hi 
	WHERE	((si.SpecSketchID2 = hi.ImageID) 
		AND (si.SpecSketchVersion2 = hi.Version) 
		AND (CAST(si.StyleID AS varchar(255)) = @StyleID))
   END
ELSE IF (@StyleSet = 3)
   BEGIN
	SELECT DISTINCT (dbo.fnx_GetStreamingImagePath(hi.ImageID, hi.[Version])) AS FilePath	--Comment #01
	FROM	pStyleImage si, hImage hi 
	WHERE	((si.SpecSketchID3 = hi.ImageID) 
		AND (si.SpecSketchVersion3 = hi.Version) 
		AND (CAST(si.StyleID AS varchar(255)) = @StyleID))
   END
ELSE IF (@StyleSet = 4)
   BEGIN
	SELECT DISTINCT (dbo.fnx_GetStreamingImagePath(hi.ImageID, hi.[Version])) AS FilePath	--Comment #01
	FROM	pStyleImage si, hImage hi 
	WHERE	((si.SpecSketchID4 = hi.ImageID) 
		AND (si.SpecSketchVersion4 = hi.Version) 
		AND (CAST(si.StyleID AS varchar(255)) = @StyleID))
   END
ELSE
   BEGIN
	SELECT 1
   END


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_BreakLink_Update]'
GO

CREATE  PROCEDURE [dbo].[spx_BreakLink_Update]
(@StyleID uniqueidentifier,
@StyleType int,
@StyleStatusID int)
AS 


	BEGIN
		UPDATE  pStyleHeader
		SET StyleLinkID = NULL
		WHERE   (StyleID=@StyleID AND StyleType = @StyleType AND StyleStatusID=@StyleStatusID)
	END	
	






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_SampleRequest_Wizard_AgentVendor_SELECT]'
GO
EXEC sp_refreshview N'[dbo].[vwx_SampleRequest_Wizard_AgentVendor_SELECT]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialRequestSubmitWorkflow_DELETE]'
GO

CREATE PROCEDURE [dbo].[spx_MaterialRequestSubmitWorkflow_DELETE](
@MaterialTradePartnerID UNIQUEIDENTIFIER 
)
AS 

	DELETE FROM dbo.pMaterialRequestSubmitComment 
	WHERE MaterialRequestSubmitID IN ( 
		SELECT MaterialRequestSubmitID FROM dbo.pMaterialRequestSubmit
		WHERE MaterialTradePartnerID = @MaterialTradePartnerID 
	)

	DELETE FROM dbo.pMaterialRequestSubmitDocument
	WHERE MaterialRequestSubmitID IN ( 
		SELECT MaterialRequestSubmitID FROM dbo.pMaterialRequestSubmit
		WHERE MaterialTradePartnerID = @MaterialTradePartnerID 
	)

	DELETE FROM dbo.pMaterialRequestSubmitItem
	WHERE MaterialRequestSubmitID IN ( 
		SELECT MaterialRequestSubmitID FROM dbo.pMaterialRequestSubmit
		WHERE MaterialTradePartnerID = @MaterialTradePartnerID 
	)

		
	DELETE FROM pMaterialTradePartnerColor
	WHERE MaterialTradePartnerID = @MaterialTradePartnerID

	DELETE FROM dbo.pMaterialRequestSubmit 	WHERE MaterialTradePartnerID = @MaterialTradePartnerID 
	DELETE FROM dbo.pMaterialTradePartner WHERE MaterialTradePartnerID = @MaterialTradePartnerID 

	DELETE FROM pMaterialRequestSubmitWorkflow WHERE MaterialTradePartnerID = @MaterialTradePartnerID





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanStyleColorway_SELECT]'
GO

/* Comment #01 -November 9 2009 - Clayton Parker - 
	I modified this procedure so that when you you are on the Lineplanning Thumbnail page it only displays colors from the 
	current season that your lineplan is in. It was displaying every color that was on the style regardless of what season
	and year.
*/

ALTER PROCEDURE [dbo].[spx_LinePlanStyleColorway_SELECT] (
@StyleID UNIQUEIDENTIFIER,
@LinePlanID UNIQUEIDENTIFIER
) 
AS
BEGIN


	SELECT a.StyleColorId ,  a.StyleColorNo, a.StyleColorName,   b.ColorFolderID , b.ColorPaletteID
	FROM pStyleColorway a LEFT OUTER JOIN pColorPalette b  ON  a.ColorPaletteID  = b.ColorPaletteID
	LEFT OUTER JOIN  pStyleColorwaySeasonYear c ON a.StyleColorID = c.StyleColorwayID -- #01
	LEFT OUTER JOIN  pStyleSeasonYear d ON c.StyleSeasonYearID = d.StyleSeasonYearID -- #01
	WHERE a.StyleID = @StyleID AND d.LinePLanID = @LinePlanID -- #01


END 

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Material_MultiLevelColorway_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old color image string with the new color image string using function.
Deleted old code.
*/



ALTER    PROCEDURE [dbo].[rpx_Material_MultiLevelColorway_SELECT]
(
	@MaterialID nvarchar(255)
)

AS


--Show the colors of the material and sub-materials for the material.
SELECT	pMaterial.MaterialNo + ' - ' + pMaterial.MaterialName AS ParentMaterialName,
	'(' + pMaterialColor.ColorCode + ') ' + pMaterialColor.ColorName AS ParentMaterialColorChipName,
	dbo.fnx_GetStreamingColorImagePath(pMaterialColor.ColorFolderID, pMaterialColor.ColorPaletteID) AS ParentMaterialColorChipFilePath,	--Comment #01
	pMaterial_Subs.MaterialNo + ' - ' + pMaterial_Subs.MaterialName AS SubMaterialName,
	'(' + pMaterialColor_Subs.ColorCode + ') ' + pMaterialColor_Subs.ColorName AS SubMaterialColorChipName,
	dbo.fnx_GetStreamingColorImagePath(pMaterialColor_Subs.ColorFolderID, pMaterialColor_Subs.ColorPaletteID) AS SubMaterialColorChipFilePath,	--Comment #01
	CAST(pMaterialLinkColorwayItem.MaterialLinkID AS varchar(50)) AS MaterialLinkID
FROM	pMaterial
	LEFT OUTER JOIN	pMaterialColor	ON	pMaterial.MaterialID = pMaterialColor.MaterialID
 	LEFT OUTER JOIN	pMaterialLinkColorway	ON	(pMaterial.MaterialID = pMaterialLinkColorway.MaterialGroupID
												AND pMaterialColor.MaterialColorID = pMaterialLinkColorway.MaterialColorID)
	LEFT OUTER JOIN	pMaterialLinkColorwayItem	ON	pMaterialLinkColorway.MaterialLinkColorwayID = pMaterialLinkColorwayItem.MaterialLinkColorwayID
 	LEFT OUTER JOIN	pMaterial AS pMaterial_Subs	ON	pMaterialLinkColorwayItem.MaterialID = pMaterial_Subs.MaterialID
 	LEFT OUTER JOIN	pMaterialColor AS pMaterialColor_Subs	ON	(pMaterialLinkColorwayItem.MaterialID = pMaterialColor_Subs.MaterialID
																AND	pMaterialLinkColorwayItem.MaterialColorID = pMaterialColor_Subs.MaterialColorID)
WHERE	(pMaterial.MaterialID = @MaterialID
		AND	pMaterial.MultiDimension = 1)
ORDER BY	pMaterialColor.Sort, pMaterialColor.ColorCode, pMaterialColor.ColorName, pMaterial_Subs.MaterialNo, pMaterial_Subs.MaterialName





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_ColorCorpType_SELECT]'
GO


create  PROCEDURE  dbo.spx_ColorCorpType_SELECT(
@TeamID UNIQUEIDENTIFIER 
)
AS
 
BEGIN
	SELECT * FROM pColorType
	WHERE ColorTypeID IN (
		SELECT ColorTypeID FROM sAccessColorFolder WHERE AccessRoleId <> 0 AND (TeamId = @TeamID)
	) 
	AND CorpColor = 1
	ORDER BY Sort
END







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LineListFolderUser_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_LineListFolderUser_INSERT]
(@TeamID uniqueidentifier,
@TradePartner smallint,
@LineFolderID uniqueidentifier)
AS 

IF (SELECT COUNT(*)  FROM pLineFolderUser WITH (NOLOCK) WHERE  LineFolderID = @LineFolderID AND TeamID = @TeamID) = 0

	INSERT INTO dbo.pLineFolderUser (TeamID, LineFolderID, TradePartner)
	VALUES (@TeamID, @LineFolderID, @TradePartner)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleRequestDataTable_PIVOT]'
GO
/*
Comments:

#01 - Ryan Cabanas - December 4, 2009
	Modified the JOIN between 'pSampleRequestSubmit' and 'pSampleRequestWorkflow' so
that the latest submit is SELECTED.

*/



ALTER PROCEDURE [dbo].[spx_SampleRequestDataTable_PIVOT](
@StyleDevelopmentID	UNIQUEIDENTIFIER, 
@UserID	INT, 
@Filter NVARCHAR (4000) 
)
AS 


CREATE TABLE #tmpSample1 (
SampleRequestTradeID UNIQUEIDENTIFIER,
SampleWorkflow NVARCHAR(200),
StyleID UNIQUEIDENTIFIER,
SampleRequestSubmitID UNIQUEIDENTIFIER, 
TradePartnerID UNIQUEIDENTIFIER, 
TradePartnerVendorID UNIQUEIDENTIFIER,
Link  NVARCHAR(4000), 
AssignedTo INT, 
StyleColorID UNIQUEIDENTIFIER ,
TechPack NVARCHAR(4000),
StyleSet NVARCHAR(200),
SetNo INT,
Season NVARCHAR(200),
Year NVARCHAR(200)
)


CREATE TABLE #tmpSample2 (
SampleRequestTradeID UNIQUEIDENTIFIER,
SampleWorkflow NVARCHAR(200),
StyleID UNIQUEIDENTIFIER,
SampleRequestSubmitID UNIQUEIDENTIFIER, 
TradePartnerName NVARCHAR(200),
VendorName NVARCHAR(200),
TradePartnerID UNIQUEIDENTIFIER, 
TradePartnerVendorID UNIQUEIDENTIFIER,
Link  NVARCHAR(4000),
StyleNo NVARCHAR(50) , 
Description NVARCHAR(100),
SizeClass NVARCHAR(50),
Colorway NVARCHAR (200),
TechPack NVARCHAR(4000) ,
StyleSet NVARCHAR(200),
SetNo INT,
Season NVARCHAR(200),
Year NVARCHAR(200)
)


CREATE TABLE #tmpSample3 (
SampleRequestTradeID UNIQUEIDENTIFIER,
SampleWorkflow NVARCHAR(200),
StyleID UNIQUEIDENTIFIER,
SampleRequestSubmitID UNIQUEIDENTIFIER, 
TradePartnerName NVARCHAR(200),
VendorName NVARCHAR(200),
TradePartnerID UNIQUEIDENTIFIER, 
TradePartnerVendorID UNIQUEIDENTIFIER,
Link  NVARCHAR(4000),
StyleNo NVARCHAR(50) , 
Description NVARCHAR(100),
SizeClass NVARCHAR(50),
Colorway NVARCHAR (200),
TechPack NVARCHAR(4000) ,
StyleSet NVARCHAR(200),
SetNo INT,
Season NVARCHAR(200),
Year NVARCHAR(200)
)



INSERT INTO #tmpSample1 ( 
SampleRequestTradeID, SampleWorkflow, StyleID, SampleRequestSubmitID,
TradePartnerID , TradePartnerVendorID, Link, 
AssignedTo, StyleColorID, TechPack, StyleSet, SetNo, Season, Year  )
SELECT 
a.SampleRequestTradeID , f.SampleWorkflow, a.StyleID, a.SampleRequestSubmitID, 
b.TradePartnerID , b.TradePartnerVendorID, 
'<TABLE cellSpacing=''0'' cellPadding=''0'' width=''100%'' border=''0''><TR><TD width=''18''> 
<IMG src=''' + 
CASE 
	WHEN d.ApprovedType = 1  THEN '../System/Icons/icon_ball_green.gif'
	WHEN a.Status = 4  THEN '../System/Icons/icon_ball_red.gif'
	WHEN a.Submit = 1 THEN '../System/Icons/icon_ball_blue.gif'
	ELSE '../System/Icons/icon_ball_yellow.gif'
END
+ '''  border=0 ALT=''Open''><TD class=''font'' align=center valign=center nowrap>&nbsp; 
<a href=''#'' onclick="javascript:window.open(''../Sample/SampleRequest_Workflow_Redirect.aspx?SRTID=' + 
CAST ( a.SampleRequestTradeID AS NVARCHAR(50)) + '&SWID=' + a.SampleWorkflowID + '&SN='+  CAST(a.StyleSet  as nvarchar(5)) +
''',''' +  
Replace( CAST ( a.SampleRequestTradeID AS NVARCHAR(50)) , '-', '') +
''',''width=1024, height=700, location=yes, menubar=yes, status=yes, toolbar=yes, scrollbars=yes, resizable=yes'');">' 
+
CASE 
	--WHEN d.ApprovedType = 1 Or a.Status = 4 THEN CONVERT ( NVARCHAR(50), a.EndDate , 101)
	WHEN d.ApprovedType = 1 THEN CONVERT ( NVARCHAR(50), a.EndDate , 101) 
	WHEN a.Status = 4 THEN CONVERT ( NVARCHAR(50), a.MDate , 101)
	ELSE CONVERT ( NVARCHAR(50), a.DueDate , 101)
END 
+ '&nbsp;<b>(' 
+  CAST(a.Submit AS NVARCHAR(5)) + ')</b></a></TD></TR></TABLE>'

AS Link, 
a.AssignedTo, b.StyleColorID , 

CASE 
	WHEN  b.TechPackID IS NULL  OR b.TechPackID  = '00000000-0000-0000-0000-000000000000' THEN '<div align=center>-------</div>'
	ELSE 
	'<TABLE>
			<TR>
			<TD width=''18''><IMG src=''../System/Icons/icon_packageok.gif'' border=''0''></TD>
			<TD class=''font'' align=''center'' valign=''center'' nowrap>&nbsp;
			<a href=''#'' onclick="javascript:window.open(''../Sample/SampleRequest_Workflow_Redirect.aspx?SRTID='
			+ CAST (a.SampleRequestTradeID AS NVARCHAR(50))
			+ '&SN=' + CAST(a.StyleSet AS NVARCHAR(10)) 
			+ '&TP=1'' , ''' 
			+ REPLACE ( CAST ( a.SampleRequestTradeID  AS NVARCHAR(50) ), '-', '' ) 

			+ ''',  ''width=1024, height=700, location=yes, menubar=yes, status=yes, toolbar=yes, scrollbars=yes, resizable=yes'' ' 
			+ ' );" >  ' 
			+ CONVERT ( NVARCHAR(50), g.DueDate , 101)  +  '</a></TD></TR></TABLE>'
	END AS TechPack ,

CASE 
	WHEN a.StyleSet = 1 THEN 
		CASE WHEN g.PC1 Is Not Null THEN g.PC1 ELSE '1st Set' END
	WHEN a.StyleSet = 2 THEN 
		CASE WHEN g.PC2 Is Not Null THEN g.PC2 ELSE '2nd Set' END
	WHEN a.StyleSet = 3 THEN 
		CASE WHEN g.PC3 Is Not Null THEN g.PC3 ELSE '3rd Set' END
	WHEN a.StyleSet = 4 THEN 
		CASE WHEN g.PC4 Is Not Null THEN g.PC4 ELSE '4th Set' END 
END AS StyleSet, a.StyleSet as SetNo, i.Season, i.Year 
FROM dbo.pSampleRequestSubmit a
INNER JOIN pSampleRequestTrade b ON a.SampleRequestTradeID  = b.SampleRequestTradeID  
INNER JOIN pSampleWorkflow c ON a.SampleWorkflowId = c.SampleWorkflowID 
INNER JOIN pSampleRequestSubmitStatus d ON a.Status   = d.StatusID	
INNER JOIN pSampleRequestWorkflow e ON e.SampleRequestWorkflowID = a.SampleRequestWorkflowID
										AND e.Submit = a.Submit		--Comment #01
INNER JOIN pSampleWorkflow f ON f.SampleWorkflowID  =  e.SampleWorkflowID 
INNER JOIN pStyleHeader g ON g.StyleID = b.StyleID
LEFT OUTER JOIN pStyleSeasonYear h ON h.StyleSeasonYearID =  b.StyleSeasonyearID 
LEFT OUTER JOIN pSeasonYear i ON i.SeasonYearID =  h.SeasonYearID
WHERE e.StyleID IN ( SELECT StyleID FROM  pStyleDevelopmentItem WHERE StyleDevelopmentID  = @StyleDevelopmentID )



DECLARE @SQL NVARCHAR(4000) 

DECLARE @flag INT  
SET @flag = 0



SET @SQL = 'INSERT INTO #tmpSample2 (SampleRequestTradeID, SampleWorkflow, StyleID, SampleRequestSubmitID,
TradePartnerID, TradePartnerVendorID , TradePartnerName,VendorName,
Link, StyleNo, Description, SizeClass, Colorway, TechPack, StyleSet , SetNo, Season, Year  )
SELECT a.SampleRequestTradeID, a.SampleWorkflow, a.StyleID, a.SampleRequestSubmitID, 
a.TradePartnerID, a.TradePartnerVendorID , b.TradePartnerName,c.VendorName,
a.Link , d.StyleNo, d.Description, d.SizeClass , g.StyleColorName, a.TechPack, a.StyleSet, a.SetNo, a.Season, a.Year
FROM #tmpSample1 a
INNER JOIN uTradePartner b ON b.TradePartnerID = a.TradePartnerID
INNER JOIN uTradePartnerVendor c ON c.TradePartnerVendorID = a.TradePartnerVendorID  
INNER JOIN pStyleHeader d ON d.StyleID = a.StyleID 
LEFT OUTER JOIN pStyleColorway g ON g.StyleColorID = a.StyleColorID
'

IF @UserID IS NOT NULL AND @UserID > 0
BEGIN
	SET @SQL = @SQL + ' WHERE a.AssignedTo = '  + CAST ( @UserID AS NVARCHAR (10)) 
END 

EXEC (@SQL)

IF @Filter IS NOT NULL AND LEN(@Filter) > 0 
	SET @SQL = 'INSERT INTO #tmpSample3  SELECT * FROM #tmpSample2 WHERE ' + @Filter 
ELSE 
	SET @SQL = 'INSERT INTO #tmpSample3  
				SELECT * FROM #tmpSample2 '

EXEC (@SQL) 

/*
PRINT (@SQL)
select * from #tmpSample2
select * from #tmpSample3
*/




EXECUTE spx_Crosstab 
'SELECT SampleWorkflow, Link , SampleRequestTradeID, StyleID, TradePartnerID , TradePartnerVendorID, TradePartnerName, 
VendorName, StyleNo, Description, SizeClass, Colorway, TechPack, StyleSet, SetNo, Season, Year  
FROM #tmpSample3',
NULL,
NULL,
'SampleWorkflow',
'Link',
'MAX'

DROP TABLE #tmpSample1
DROP TABLE #tmpSample2
DROP TABLE #tmpSample3










GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_ColorFolderSeasonYear_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_ColorFolderSeasonYear_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_Style_Quote_Default_SELECT_Backup_REC_9_8_08]'
GO
EXEC sp_refreshview N'[dbo].[vwx_Style_Quote_Default_SELECT_Backup_REC_9_8_08]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleSeasonalYear_SELECT]'
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE PROCEDURE [dbo].[spx_StyleSeasonalYear_SELECT](@StyleId uniqueidentifier)  
AS   
  
SELECT pSeasonYear.Season + ' ' + pSeasonYear.Year AS SeasonYear,   pStyleSeasonYear.StyleSeasonYearID AS StyleSeasonYearID
FROM  pStyleSeasonYear INNER JOIN  
  pSeasonYear ON pStyleSeasonYear.SeasonYearID = pSeasonYear.SeasonYearID  
WHERE StyleID = @StyleID  
ORDER BY pSeasonYear.CurrentSeason DESC, pSeasonYear.Year DESC  , pSeasonYear.Season  
  
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_BodyNewSizeClassAndRange_UPDATE]'
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[spx_BodyNewSizeClassAndRange_UPDATE] 
(
@BodyID UNIQUEIDENTIFIER,  
@NewBodyID UNIQUEIDENTIFIER
) 
AS   

DECLARE @SizeRange VARCHAR(200), @SizeClass VARCHAR(200) 
 
SELECT @SizeClass = SizeClass, @SizeRange = SizeRange FROM pBody 
WHERE BodyID = @BodyId  
   
BEGIN   

UPDATE pBody SET SizeClass = @SizeClass, SizeRange = @SizeRange WHERE BodyID = @NewBodyID  

END                     
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_AccessStyleFolder_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_User_AccessStyleFolder_SELECT]
(@teamId uniqueidentifier)
AS 


SELECT pStyleType.StyleTypeID, pStyleType.StyleTypeDescription, 
	sAccessStyleFolder.AccessStyleId, 
	sAccessStyleFolder.AccessRoleId, sAccessStyleFolder.AccessView, sAccessStyleFolder.AccessCreate, 
	sAccessStyleFolder.AccessModify, sAccessStyleFolder.AccessDelete, sAccessStyleFolder.AccessPrint, 
	sAccessStyleFolder.TeamId, sAccessStyleFolder.CUser, sAccessStyleFolder.CDate, sAccessStyleFolder.MUser, 
	sAccessStyleFolder.MDate, pStyleType.StyleTypeOrder
FROM  pStyleType WITH (NOLOCK) INNER JOIN
    sAccessStyleFolder WITH (NOLOCK) ON pStyleType.StyleTypeID = sAccessStyleFolder.StyleTypeID
WHERE sAccessStyleFolder.TeamId = @teamId
ORDER BY pStyleType.StyleTypeOrder



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_Style_QuoteTrade_Default_SELECT]'
GO
EXEC sp_refreshview N'[dbo].[vwx_Style_QuoteTrade_Default_SELECT]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleColorwaySeasonalYear_PIVOT]'
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE PROCEDURE [dbo].[spx_StyleColorwaySeasonalYear_PIVOT](@StyleId uniqueidentifier, @StyleSeasonYearID NVARCHAR(50)= NULL)    
AS  
SELECT     a.StyleColorwaySeasonYearID, a.StyleSeasonYearID, a.StyleID, a.StyleColorDelivery1, a.StyleColorDelivery2, a.StyleColorDelivery3, 
                      a.StyleColorDelivery4, a.StyleColorStatus, b.StyleColorNo, b.StyleColorName, b.StyleColorID
FROM         pStyleColorwaySeasonYear AS a INNER JOIN
                      pStyleColorway AS b ON a.StyleColorwayID = b.StyleColorID
WHERE     (a.StyleSeasonYearID = @StyleSeasonYearId and b.StyleID=@StyleId)   
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_BodyDevelopmentItemCopy_INSERT]'
GO
SET QUOTED_IDENTIFIER ON
GO
    
      
CREATE PROCEDURE [dbo].[spx_BodyDevelopmentItemCopy_INSERT]      
(@BodyDevelopmentID uniqueidentifier,      
@BodyID uniqueidentifier,      
@TempID nvarchar(50),      
@TempNo nvarchar(50),      
@BodyDevelopmentNo nvarchar(50),      
@SizeRange nvarchar(50),      
@CreatedBy nvarchar(200),      
@CreatedDate datetime,       
@Variation int = 1 ,       
@BodyDevelopmentName nvarchar (100) = NULL       
)      
AS       
      
BEGIN      
      
--  Replaced INSERT to get BodydevelopmentItem from the temp table from runtime      
--  DP 7/14/2009       
-- INSERT INTO pBodyDevelopmentItem      
--  (BodyDevelopmentID, BodyID, SizeRange, Variation, CUser, CDate, MUser, MDate , BodyDevelopmentName )      
-- VALUES  (@BodyDevelopmentID, @BodyID, @SizeRange, @Variation , @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate,  @BodyDevelopmentName)      
       
      
-- IF ( SELECT COUNT(*) FROM pBodyDevelopmentItemTemp WHERE NewBodyID = @BodyID ) = 0      
 BEGIN      
      
  INSERT INTO pBodyDevelopmentItem      
   (BodyDevelopmentItemID, BodyDevelopmentID, BodyID, CUser, CDate, MUser, MDate , DevelopmentName )      
  VALUES  (NEWID() , @BodyDevelopmentID, @BodyID, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate,  @BodyDevelopmentName)      
      
 END      
-- ELSE      
-- BEGIN      
--      
--  INSERT INTO pBodyDevelopmentItem       
--   (BodyDevelopmentID, BodyID, SizeRange, Variation, CUser, CDate, MUser, MDate, BodyDevelopmentName)      
--  SELECT @BodyDevelopmentID, @BodyID, @SizeRange, Variation , @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate, BodyDevelopmentName       
--  FROM pBodyDevelopmentItemTemp WHERE NewBodyID = @BodyID      
--      
-- END       
      
      
      
 UPDATE pBody SET      
  DevelopmentId = @BodyDevelopmentId      
--  DevelopmentNo = @BodyDevelopmentNo      
 WHERE BodyId = @BodyId      
       
END      
      
      
      
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_BodyDevelopmentCopy_INSERT]'
GO
  
CREATE PROCEDURE [dbo].[spx_BodyDevelopmentCopy_INSERT] 
(@BodyDevelopmentID uniqueidentifier, @BodyID uniqueidentifier, @TempID nvarchar(50), 
@TempNo nvarchar(50), @BodyDevelopmentNo nvarchar(50), @SizeRange nvarchar(100), @CreatedBy nvarchar(200), 
@CreatedDate datetime) 
AS   
IF (SELECT COUNT(*) FROM pBodyDevelopment WHERE BodyDevelopmentID = @BodyDevelopmentID) = 0 
BEGIN  
INSERT INTO dbo.pBodyDevelopment      
(BodyDevelopmentID, CUser, CDate, MUser, MDate) 
 VALUES     (@BodyDevelopmentID, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate) 
END         
  
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialRequestSubmitWorkflowColor_DELETE]'
GO


/*
Comments:

#01 - Ryan Cabanas - August 31, 2009
	The procedure needed to be completed so that it doesn't leave orphaned records
upon deleting a color from the Material Vendor area.  Right now it only removes the
color from the 'pMaterialTradePartnerColor' table.  Needs to remove applicable records
from the 'pMaterialRequestSubmitWorkflow', 'pMaterialRequestSubmit', and
'pMaterialRequestSubmitItem' tables.
*/


ALTER PROCEDURE [dbo].[spx_MaterialRequestSubmitWorkflowColor_DELETE] (
@MaterialTradePartnerColorID UNIQUEIDENTIFIER 
)
AS


--/************/
--/*Testing.	*/
--/************/
--BEGIN
--	DECLARE @MaterialTradePartnerColorID UNIQUEIDENTIFIER
--
--	SET @MaterialTradePartnerColorID = '78637C10-89BB-4A24-8639-25DD1FFD330E'
--
--	/*Check the records that will be deleted.*/
--	SELECT pMaterialRequestSubmitItem.*
--	FROM pMaterialTradePartnerColor
--		INNER JOIN pMaterialRequestSubmitWorkflow	ON	pMaterialTradePartnerColor.MaterialTradePartnerColorID = pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID
--														AND pMaterialTradePartnerColor.MaterialTradePartnerID = pMaterialRequestSubmitWorkflow.MaterialTradePartnerID
--		INNER JOIN pMaterialRequestSubmit	ON	pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID = pMaterialRequestSubmit.MaterialRequestSubmitWorkflowID
--												AND pMaterialRequestSubmitWorkflow.MaterialTradePartnerID = pMaterialRequestSubmit.MaterialTradePartnerID
--		INNER JOIN pMaterialRequestSubmitItem	ON	pMaterialRequestSubmit.MaterialRequestSubmitID = pMaterialRequestSubmitItem.MaterialRequestSubmitID
--	WHERE pMaterialTradePartnerColor.MaterialTradePartnerColorID = @MaterialTradePartnerColorID
----	GROUP BY pMaterialRequestSubmit.MaterialRequestSubmitID
--END


--Comment #01
BEGIN
	/*Delete records from 'pMaterialRequestSubmitItem'.*/
	DELETE pMaterialRequestSubmitItem
	FROM pMaterialTradePartnerColor
		INNER JOIN pMaterialRequestSubmitWorkflow	ON	pMaterialTradePartnerColor.MaterialTradePartnerColorID = pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID
														AND pMaterialTradePartnerColor.MaterialTradePartnerID = pMaterialRequestSubmitWorkflow.MaterialTradePartnerID
		INNER JOIN pMaterialRequestSubmit	ON	pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID = pMaterialRequestSubmit.MaterialRequestSubmitWorkflowID
												AND pMaterialRequestSubmitWorkflow.MaterialTradePartnerID = pMaterialRequestSubmit.MaterialTradePartnerID
		INNER JOIN pMaterialRequestSubmitItem	ON	pMaterialRequestSubmit.MaterialRequestSubmitID = pMaterialRequestSubmitItem.MaterialRequestSubmitID
	WHERE pMaterialTradePartnerColor.MaterialTradePartnerColorID = @MaterialTradePartnerColorID

	/*Delete records from 'pMaterialRequestSubmit'.*/
	DELETE pMaterialRequestSubmit
	FROM pMaterialTradePartnerColor
		INNER JOIN pMaterialRequestSubmitWorkflow	ON	pMaterialTradePartnerColor.MaterialTradePartnerColorID = pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID
														AND pMaterialTradePartnerColor.MaterialTradePartnerID = pMaterialRequestSubmitWorkflow.MaterialTradePartnerID
		INNER JOIN pMaterialRequestSubmit	ON	pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID = pMaterialRequestSubmit.MaterialRequestSubmitWorkflowID
												AND pMaterialRequestSubmitWorkflow.MaterialTradePartnerID = pMaterialRequestSubmit.MaterialTradePartnerID
	WHERE pMaterialTradePartnerColor.MaterialTradePartnerColorID = @MaterialTradePartnerColorID

	/*Delete records from 'pMaterialRequestSubmitWorkflow'.*/
	DELETE pMaterialRequestSubmitWorkflow
	FROM pMaterialTradePartnerColor
		INNER JOIN pMaterialRequestSubmitWorkflow	ON	pMaterialTradePartnerColor.MaterialTradePartnerColorID = pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID
														AND pMaterialTradePartnerColor.MaterialTradePartnerID = pMaterialRequestSubmitWorkflow.MaterialTradePartnerID
	WHERE pMaterialTradePartnerColor.MaterialTradePartnerColorID = @MaterialTradePartnerColorID
END



DELETE FROM pMaterialTradePartnerColor
WHERE MaterialTradePartnerColorID  = @MaterialTradePartnerColorID 




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Material_Image_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.
*/


ALTER PROCEDURE [dbo].[rpx_Material_Image_SELECT]
	@MaterialID varchar(255)	
AS


SELECT DISTINCT (dbo.fnx_GetStreamingImagePath(hi.ImageID, hi.[Version])) AS FilePath	--Comment #01
FROM	pMaterial pm, hImage hi 
WHERE ((pm.MaterialImageID = hi.ImageID) AND
	(pm.MaterialImageVersion = hi.Version) AND
	(pm.MaterialID = @MaterialID))


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_ColorFolderColorsCount_SELECT]'
GO
CREATE PROCEDURE [dbo].[spx_ColorFolderColorsCount_SELECT] (
@ColorFolderID UNIQUEIDENTIFIER 
)
AS

	SELECT COUNT(*) FROM pColorPalette WHERE ColorFolderID = @ColorFolderID 
	
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_StyleColorQuoteItem]'
GO
EXEC sp_refreshview N'[dbo].[vwx_StyleColorQuoteItem]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleColorwaySeasonalYear_UPDATE]'
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE PROCEDURE [dbo].[spx_StyleColorwaySeasonalYear_UPDATE](
@StyleColorID uniqueidentifier,
@StyleID uniqueidentifier,
@ModifiedBy nvarchar(200),
@ModifiedDate datetime,
@StyleSeasonYearID NVARCHAR(50)= NULL)

AS 

DECLARE @StyleColorStatus  int,
@StyleColorDelivery1 int,
@StyleColorDelivery2 int,
@StyleColorDelivery3 int,
@StyleColorDelivery4 int


Select @StyleColorStatus = a.StyleColorStatus, @StyleColorDelivery1 = a.StyleColorDelivery1, 
@StyleColorDelivery2 = a.StyleColorDelivery2, @StyleColorDelivery3 = a.StyleColorDelivery3, @StyleColorDelivery4 = a.StyleColorDelivery4 
From pStyleColorway a
Where (a.StyleColorID = @StyleColorID AND a.StyleID = @StyleID)


UPDATE    pStyleColorwaySeasonYear
SET              StyleColorStatus = @StyleColorStatus, StyleColorDelivery1 = @StyleColorDelivery1, 
StyleColorDelivery2 = @StyleColorDelivery2, 
StyleColorDelivery3 = @StyleColorDelivery3,
StyleColorDelivery4 = @StyleColorDelivery4, 
                  MUser = @ModifiedBy, MDate = @ModifiedDate 
WHERE     (StyleColorwayID = @StyleColorID AND StyleID = @StyleID AND StyleSeasonYearID = @StyleSeasonYearID)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialRequestSubmitWorkflowLogic_UPDATE]'
GO
SET QUOTED_IDENTIFIER ON
GO

/*
Comments:

#01 - Ryan Cabanas - August 31, 2009
	Need to handle the 'no color' worklow bubbles, even when adding a new color to the
material, which will add new timelines and new bubbles.  Need to check to see if the same
'no color' bubble already exists.  If so, then I need to take that information from one of
the already existing 'no color' bubbles.
	The way that Daniel wrote the rest of the procedure is good.  When I add these records,
his procedure will already see that they exist and will not enter additional ones.

#02 - Ryan Cabanas - August 31, 2009
	The original INSERT statement into the 'pMaterialRequestSubmitWorkflow' table wasn't
checking to see if the particular 'MaterialRequestWorkflowID' existed in the
'pMaterialRequestWorkflow' table.  Just needed to add an INNER JOIN to make sure that
only valid workflows are added.
*/


ALTER PROCEDURE [dbo].[spx_MaterialRequestSubmitWorkflowLogic_UPDATE] (
	@MaterialTradePartnerID UNIQUEIDENTIFIER,
	@MaterialTradePartnerColorID UNIQUEIDENTIFIER
)
AS





DECLARE
	@TradePartnerID  UNIQUEIDENTIFIER, 
	@MaterialSizeID UNIQUEIDENTIFIER,
	@MaterialID  UNIQUEIDENTIFIER, 
	@MaterialColorID  UNIQUEIDENTIFIER, 
	@TradePartnerVendorID  UNIQUEIDENTIFIER, 
	@CUser NVARCHAR(200),
	@CDate DATETIME,
	@StartDate DATETIME,
	@DueDate DATETIME,
	@EndDate DATETIME
	,@MaterialRequestWorkflowTempID uniqueidentifier	--Comment #01

BEGIN

	SELECT 
		@TradePartnerID  = TradePartnerID,
		@TradePartnerVendorID  = TradePartnerVendorID,
		@StartDate = MaterialRequestWorkflowStartDate,
		@DueDate = MaterialRequestWorkflowDueDate,
		@EndDate = NULL,
		@CUser = CUser,
		@CDate = CDate
		,@MaterialRequestWorkflowTempID = MaterialRequestWorkflowTempID		--Comment #01
	FROM pMaterialTradePartner
	WHERE MaterialTradePartnerID = @MaterialTradePartnerID

	
	SELECT 
		@MaterialSizeID = MaterialSizeID,
		@MaterialID  = MaterialID, 
		@MaterialColorID  = MaterialColorID 	 
	FROM pMaterialTradePartnerColor 
	WHERE MaterialTradePartnerColorID = @MaterialTradePartnerColorID

END


--Comment #01
BEGIN
	/*Declare variables.*/
	DECLARE @TotalCount int
	DECLARE @RowCounter int
	DECLARE @MaterialRequestWorkflowID varchar(5)

	DECLARE @NewMaterialRequestSubmitWorkflowID uniqueidentifier
	DECLARE @MaterialRequestSubmitWorkflowID_Other uniqueidentifier

	DECLARE @TotalCount_2 int
	DECLARE @RowCounter_2 int

	DECLARE @NewMaterialRequestSubmitID uniqueidentifier
	DECLARE @MaterialRequestSubmitID_Other uniqueidentifier

	/*Create temp tables.*/
	CREATE TABLE #tempNoColorMaterialRequestWorkflowIDs(
		TableRow int identity(1,1)
		,MaterialRequestWorkflowID varchar(5) Collate SQL_Latin1_General_CP1_CI_AS)

	CREATE TABLE #tempNoColorMaterialRequestWorkflowIDs_Exist(
		TableRow int identity(1,1)
		,MaterialRequestWorkflowID varchar(5) Collate SQL_Latin1_General_CP1_CI_AS)

	CREATE TABLE #tempMaterialRequestSubmitIDs(
		TableRow int identity(1,1)
		,MaterialRequestSubmitID uniqueidentifier)

	/*Get the IDs of the bubbles that belong to the template and are set to 'no color'.*/
	INSERT INTO #tempNoColorMaterialRequestWorkflowIDs(MaterialRequestWorkflowID)
	SELECT pMaterialRequestWorkflow.MaterialRequestWorkflowID
	FROM pMaterialRequestWorkflowTemplateItem
	INNER JOIN pMaterialRequestWorkflow	ON	pMaterialRequestWorkflowTemplateItem.MaterialRequestWorkflowID = pMaterialRequestWorkflow.MaterialRequestWorkflowID
	WHERE pMaterialRequestWorkflowTemplateItem.MaterialRequestWorkflowTempID = @MaterialRequestWorkflowTempID
	AND pMaterialRequestWorkflow.MaterialRequestWorkflowColor = 0
	

	/*Get the IDs for bubbles that are 'no color' and already have a bubble for that ID.*/
	INSERT INTO #tempNoColorMaterialRequestWorkflowIDs_Exist(MaterialRequestWorkflowID)
	SELECT pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID
	FROM #tempNoColorMaterialRequestWorkflowIDs
	INNER JOIN pMaterialRequestSubmitWorkflow	ON	#tempNoColorMaterialRequestWorkflowIDs.MaterialRequestWorkflowID = pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID
	WHERE pMaterialRequestSubmitWorkflow.MaterialTradePartnerID = @MaterialTradePartnerID
	GROUP BY pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID
	
	
	/*Get counts.*/
	SELECT @TotalCount = COUNT(*) FROM #tempNoColorMaterialRequestWorkflowIDs_Exist
	SET @RowCounter = 1

	/*Loop to get already existing 'no color' bubble info and add it for the new 'no color' bubble.*/
	WHILE(@RowCounter <= @TotalCount)
		BEGIN
			/*Make new ID.*/
			SET @NewMaterialRequestSubmitWorkflowID = NEWID()

			/*Clear variables.*/
			SET @MaterialRequestWorkflowID = NULL

			/*Get a workflow ID to work with.*/
			SELECT @MaterialRequestWorkflowID = MaterialRequestWorkflowID
			FROM #tempNoColorMaterialRequestWorkflowIDs_Exist
			WHERE TableRow = @RowCounter

			/*Check to see that a record already doesn't exist.*/
			IF((SELECT COUNT(*) FROM pMaterialRequestSubmitWorkflow 
				WHERE MaterialTradePartnerID = @MaterialTradePartnerID AND 
				MaterialTradePartnerColorID = @MaterialTradePartnerColorID 
				AND MaterialRequestWorkflowID = @MaterialRequestWorkflowID) = 0)
			BEGIN
				
				/*Get 'MaterialRequestSubmitWorkflowID' of an already existing 'no color' record that will be used as the source to copy info from.*/
				SELECT TOP 1 @MaterialRequestSubmitWorkflowID_Other = MaterialRequestSubmitWorkflowID
				FROM pMaterialRequestSubmitWorkflow
				WHERE MaterialTradePartnerID = @MaterialTradePartnerID
				AND MaterialRequestWorkflowID = @MaterialRequestWorkflowID

				/*Add new 'no color' record to the 'pMaterialRequestSubmitWorkflow' table using mostly source info.*/
				INSERT INTO pMaterialRequestSubmitWorkflow( MaterialRequestSubmitWorkflowID,MaterialTradePartnerID,
				MaterialTradePartnerColorID, MaterialRequestWorkflowTempItemID, MaterialRequestWorkflowID, MaterialID,
				MaterialColorID,TradePartnerID,TradePartnerVendorID,[Status],Submit,SubmitDays,ResubmitDays,
				AssignedTo,StartDate,DueDate,EndDate,CDate,CUser,MDate,MUser,TUser,TDate,FinalDate,AgentView)
				SELECT @NewMaterialRequestSubmitWorkflowID,@MaterialTradePartnerID,
				@MaterialTradePartnerColorID, MaterialRequestWorkflowTempItemID,MaterialRequestWorkflowID, MaterialID,
				@MaterialColorID, TradepartnerId,TradepartnerVendorId,[Status],Submit,SubmitDays,ResubmitDays,
				AssignedTo,StartDate,DueDate,EndDate,CDate,CUser,MDate,MUser,TUser,TDate,FinalDate,AgentView
				FROM pMaterialRequestSubmitWorkflow
				WHERE MaterialRequestSubmitWorkflowID = @MaterialRequestSubmitWorkflowID_Other

				/*Get the individual submit records that belong to the source 'no color'.*/
				INSERT INTO #tempMaterialRequestSubmitIDs(MaterialRequestSubmitID)
				SELECT MaterialRequestSubmitID
				FROM pMaterialRequestSubmit
				WHERE MaterialRequestSubmitWorkflowID = @MaterialRequestSubmitWorkflowID_Other

				/*Get count of submit IDs.*/
				SELECT @TotalCount_2 = COUNT(*) FROM #tempMaterialRequestSubmitIDs
				SET @RowCounter_2 = 1

				/*Loop to add submit tab information from the source, which may have more than one submit.*/
				WHILE(@RowCounter_2 <= @TotalCount_2)
				BEGIN
				
					/*Make new ID for each submit tab to be entered for the new 'no color'.*/
					SET @NewMaterialRequestSubmitID = NEWID()

					/*Clear variables.*/
					SET @MaterialRequestSubmitID_Other = NULL

					/*Get a submit ID.*/
					SELECT @MaterialRequestSubmitID_Other = MaterialRequestSubmitID
					FROM #tempMaterialRequestSubmitIDs
					WHERE TableRow = @RowCounter_2

					/*Add new 'no color' record to the 'pMaterialRequestSubmit' table using mostly source info.*/
					INSERT INTO pMaterialRequestSubmit( MaterialRequestSubmitID,MaterialRequestSubmitWorkflowID,MaterialTradePartnerColorID,
					MaterialTradePartnerID,Submit,[Status],AssignedTo,StartDate,RecDate,RecBy,RecCarrier,RecTrackNo,
					RecWeight,VendorWeight,VendorDate,VendorName,SubmitDays,ResubmitDays,DueDate,RevDate,RevBy,
					EndDate,EndBy,CUser,CDate,MUser,MDate,TUser,TDate,AgentView,SubmitComment,VendorComment,InternalComment)
					SELECT @NewMaterialRequestSubmitID,@NewMaterialRequestSubmitWorkflowID,@MaterialTradePartnerColorID,
					@MaterialTradePartnerID,Submit,[Status],AssignedTo,StartDate,RecDate,RecBy,RecCarrier,RecTrackNo,
					RecWeight,VendorWeight,VendorDate,VendorName,SubmitDays,ResubmitDays,DueDate,RevDate,RevBy,
					EndDate,EndBy,CUser,CDate,MUser,MDate,TUser,TDate,AgentView,SubmitComment,VendorComment,InternalComment
					FROM pMaterialRequestSubmit
					WHERE MaterialRequestSubmitID = @MaterialRequestSubmitID_Other

					/*Add new 'no color' record to the 'pMaterialRequestSubmitItem' table using mostly source info.*/
					INSERT INTO pMaterialRequestSubmitItem( MaterialRequestSubmitID,MaterialRequestWorkflowItemID,MaterialRequestSubmitItemStatus,
					MaterialRequestSubmitItemCustom1,MaterialRequestSubmitItemCustom2,MaterialRequestSubmitItemCustom3,MaterialRequestSubmitItemCustom4,
					MaterialRequestSubmitItemCustom5,MaterialRequestSubmitItemCustom6,MaterialRequestSubmitItemCustom7,MaterialRequestSubmitItemCustom8,
					MaterialRequestSubmitItemCustom9,MaterialRequestSubmitItemCustom10,MaterialRequestSubmitItemSort,
					CUser,CDate,MUser,MDate)
					SELECT @NewMaterialRequestSubmitID,MaterialRequestWorkflowItemID,MaterialRequestSubmitItemStatus,
					MaterialRequestSubmitItemCustom1,MaterialRequestSubmitItemCustom2,MaterialRequestSubmitItemCustom3,MaterialRequestSubmitItemCustom4,
					MaterialRequestSubmitItemCustom5,MaterialRequestSubmitItemCustom6,MaterialRequestSubmitItemCustom7,MaterialRequestSubmitItemCustom8,
					MaterialRequestSubmitItemCustom9,MaterialRequestSubmitItemCustom10,MaterialRequestSubmitItemSort,
					CUser,CDate,MUser,MDate
					FROM pMaterialRequestSubmitItem
					WHERE MaterialRequestSubmitID = @MaterialRequestSubmitID_Other

					/*Up counter.*/
					SET @RowCounter_2 = @RowCounter_2 + 1

				END	--End submit ID looping for the particular 'no color' workflow.

				/*Reset the temp table that holds the submit IDs for the next workflow.*/
				TRUNCATE TABLE #tempMaterialRequestSubmitIDs

			END	--End the 'IF' statement.

			/*Up counter.*/
			SET @RowCounter = @RowCounter + 1

		END	--End the loop of going through the 'no color' workflow bubbles.
END	--End the new section.




BEGIN

	INSERT INTO pMaterialRequestSubmitWorkflow (MaterialTradePartnerID, MaterialTradePartnerColorID, 
		MaterialRequestWorkflowTempItemID, MaterialRequestWorkflowID, MaterialID, MaterialColorID, 
		TradePartnerID, TradePartnerVendorID, [Status], Submit, 
		SubmitDays, ResubmitDays, AssignedTo, 
		StartDate, DueDate, EndDate, CDate, CUser, MDate, MUser)
	SELECT a.MaterialTradePartnerId, b.MaterialTradePartnerColorID, 
		  d.MaterialRequestWorkflowTempItemID, d.MaterialRequestWorkflowID, b.MaterialID, b.MaterialColorID,
		  a.TradepartnerId, a.TradepartnerVendorId, 0 AS Status, 1 AS Submit, 
		  d.MaterialRequestWorkflowDays, d.MaterialRequestWorkflowRDays, d.MaterialRequestWorkflowAssignedTo, 
		  @StartDate, @DueDate, @EndDate, @CDate, @CUser, @CDate, @CUser
	FROM pMaterialTradePartner a 
	INNER JOIN pMaterialTradePartnerColor b ON a.MaterialTradePartnerId = b.MaterialTradePartnerID 
	INNER JOIN pMaterialRequestWorkflowTemplateItem d ON a.MaterialRequestWorkflowTempID = d.MaterialRequestWorkflowTempID
	INNER JOIN pMaterialRequestWorkflow e ON	d.MaterialRequestWorkflowID = e.MaterialRequestWorkflowID		--Comment #02
	WHERE b.MaterialColorID = @MaterialColorID AND b.MaterialSizeID = @MaterialSizeID 
	AND  a.MaterialTradePartnerID = @MaterialTradePartnerID 
	/*AND  d.MaterialRequestWorkflowTempItemID NOT IN ( */
	AND d.MaterialRequestWorkflowID NOT IN (
		SELECT MaterialRequestWorkflowID FROM pMaterialRequestSubmitWorkflow 
		WHERE MaterialTradePartnerColorID = @MaterialTradePartnerColorID --'61D4362E-C68B-4524-8B77-6C46D9EF62D1'
	)
		

	INSERT INTO pMaterialRequestSubmit (MaterialRequestSubmitWorkflowID, MaterialTradePartnerColorID, MaterialTradePartnerID, 
			Submit, [Status], AssignedTo, StartDate, SubmitDays, ResubmitDays, DueDate, EndDate, CDate, CUser, MDate, MUser)
	SELECT  a.MaterialRequestSubmitWorkflowID, c.MaterialTradePartnerColorID, 
		  b.MaterialTradePartnerId, a.Submit, a.Status, 
		  a.AssignedTo, a.StartDate, a.SubmitDays, 
		  a.ResubmitDays, a.DueDate, a.EndDate,
		  @CDate AS CDate, @CUser AS CUser, @CDate AS MDate, @CUser AS MUser
	FROM pMaterialRequestSubmitWorkflow a 
	INNER JOIN pMaterialTradePartner b 
	INNER JOIN pMaterialTradePartnerColor c ON b.MaterialTradePartnerId = c.MaterialTradePartnerID 
		ON a.MaterialTradePartnerColorID = c.MaterialTradePartnerColorID 
	INNER JOIN pMaterialRequestWorkflow d
	INNER JOIN pMaterialRequestWorkflowTemplateItem e ON d.MaterialRequestWorkflowID = e.MaterialRequestWorkflowID 
		ON  a.MaterialRequestWorkflowTempItemID = e.MaterialRequestWorkflowTempItemID
	WHERE c.MaterialColorID = @MaterialColorID AND c.MaterialSizeID = @MaterialSizeID 
	AND b.MaterialTradePartnerID = @MaterialTradePartnerID 
	AND a.MaterialRequestSubmitWorkflowID NOT IN (
		SELECT MaterialRequestSubmitWorkflowID 
		FROM pMaterialRequestSubmit WHERE MaterialTradePartnerColorID = @MaterialTradePartnerColorID
	)
	
	
	INSERT INTO  pMaterialRequestSubmitItem (MaterialRequestSubmitID, MaterialRequestWorkflowItemID, MaterialRequestSubmitItemStatus, MaterialRequestSubmitItemCustom1, 
		MaterialRequestSubmitItemCustom2, MaterialRequestSubmitItemCustom3, MaterialRequestSubmitItemCustom4, MaterialRequestSubmitItemCustom5, 
		MaterialRequestSubmitItemCustom6, MaterialRequestSubmitItemCustom7, MaterialRequestSubmitItemCustom8, MaterialRequestSubmitItemCustom9, 
		MaterialRequestSubmitItemCustom10, MaterialRequestSubmitItemSort, CDate, CUser, MDate, MUser)
	SELECT  c.MaterialRequestSubmitID, a.MaterialRequestWorkflowItemID, 0, a.MaterialRequestWorkflowItemCustom1,
		  a.MaterialRequestWorkflowItemCustom2, a.MaterialRequestWorkflowItemCustom3, 
		  a.MaterialRequestWorkflowItemCustom4, a.MaterialRequestWorkflowItemCustom5, 
		  a.MaterialRequestWorkflowItemCustom6, a.MaterialRequestWorkflowItemCustom7, 
		  a.MaterialRequestWorkflowItemCustom8, a.MaterialRequestWorkflowItemCustom9, 
		  a.MaterialRequestWorkflowItemCustom10, a.MaterialRequestWorkflowItemSort,		
		  @CDate AS CDate, @CUser AS CUser, @CDate AS MDate, @CUser AS MUser
	FROM  pMaterialRequestWorkflowItem a 
	INNER JOIN pMaterialRequestSubmitWorkflow b ON  a.MaterialRequestWorkflowID = b.MaterialRequestWorkflowID 
	INNER JOIN pMaterialRequestSubmit c ON b.MaterialRequestSubmitWorkflowID = c.MaterialRequestSubmitWorkflowID
	WHERE b.MaterialTradePartnerColorID = @MaterialTradePartnerColorID 
	AND b.MaterialTradePartnerID = @MaterialTradePartnerID 
	AND c.MaterialRequestSubmitID NOT IN (
		SELECT m.MaterialRequestSubmitID 
		FROM  pMaterialRequestSubmit n
		INNER JOIN  pMaterialRequestSubmitItem m ON n.MaterialRequestSubmitID = m.MaterialRequestSubmitID 
		WHERE n.MaterialTradePartnerColorID = @MaterialTradePartnerColorID
	)
	

END


--Comment #01
/*Drop temp tables.*/
DROP TABLE #tempNoColorMaterialRequestWorkflowIDs
DROP TABLE #tempNoColorMaterialRequestWorkflowIDs_Exist
DROP TABLE #tempMaterialRequestSubmitIDs








GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[sTempSequentialId]'
GO
CREATE TABLE [dbo].[sTempSequentialId]
(
[SequentialId] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_sTempSequentialId_SequentialId] DEFAULT (newsequentialid()),
[SequentialNo] [int] NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_sTempSequentialId] on [dbo].[sTempSequentialId]'
GO
ALTER TABLE [dbo].[sTempSequentialId] ADD CONSTRAINT [PK_sTempSequentialId] PRIMARY KEY CLUSTERED  ([SequentialId])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_NEWSEQUENTIALID]'
GO

---------------------------------------

CREATE    procedure [dbo].[spx_NEWSEQUENTIALID]
(@SequentialNo int)
AS

--INSERT sTempSequentialId
--OUTPUT inserted.SequentialId
--DEFAULT VALUES


--DECLARE @SequentialNo int
--SET @SequentialNo = Round(((1000000) * Rand() + 1), 0)

DELETE FROM sTempSequentialId WHERE SequentialNo = @SequentialNo

INSERT INTO sTempSequentialId (SequentialNo) 
VALUES (@SequentialNo)

--SELECT SequentialId FROM sTempSequentialId WHERE SequentialNo = @SequentialNo

--DELETE FROM sTempSequentialId WHERE SequentialNo = @SequentialNo




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleMaterialSummary_SELECT]'
GO





ALTER PROCEDURE [dbo].[spx_StyleMaterialSummary_SELECT]
(
@StyleId uniqueidentifier,
@StyleSet int
)
AS

SELECT    pStyleMaterials.StyleMaterialID, pComponentType.ComponentTypeID, pComponentType.ComponentDescription, 
      ISNULL(pStyleMaterials.MainMaterial,0) AS MainMaterial, pStyleMaterials.Development, pStyleMaterials.MiscColor, pStyleMaterials.StyleSet, 
      pStyleMaterials.StyleID, pStyleMaterials.UOM, pStyleMaterials.Qty, pStyleMaterials.MaterialPrice, pStyleMaterials.Ext, 
      pStyleMaterials.MaterialSize, pStyleMaterials.MaterialID, pStyleMaterials.MaterialPlacement, 
      pStyleMaterials.MaterialPlacementCode, pStyleMaterials.MaterialPlacementDetail, pStyleMaterials.MaterialImageID, 
      pStyleMaterials.MaterialImageVersion, pStyleMaterials.NoColorMatch, pStyleMaterials.SupplierID, 
      pStyleMaterials.ComponentTypeID AS Expr1, pStyleMaterials.MaterialType, pStyleMaterials.MaterialNo, 
      pStyleMaterials.MaterialName, pStyleMaterials.A, pStyleMaterials.B, pStyleMaterials.C, pStyleMaterials.D, 
      pStyleMaterials.E, pStyleMaterials.F, pStyleMaterials.G, pStyleMaterials.H, pStyleMaterials.I, pStyleMaterials.J, 
      pStyleMaterials.K, pStyleMaterials.L, pStyleMaterials.M, pStyleMaterials.N, pStyleMaterials.O, pStyleMaterials.P, 
      pStyleMaterials.Q, pStyleMaterials.R, pStyleMaterials.S, pStyleMaterials.T, pStyleMaterials.U, pStyleMaterials.V, 
      pStyleMaterials.W, pStyleMaterials.X, pStyleMaterials.Y, pStyleMaterials.Z, pStyleMaterials.Source, pStyleMaterials.Notes, 
      pStyleMaterials.Placement, pStyleMaterials.VendorPrice, pStyleMaterials.VolumePrice, pStyleMaterials.VolumePriceMinimum, 
      pStyleMaterials.VendorProductionMin, pStyleMaterials.VendorProductionLeadTime, pStyleMaterials.DetailYesNo, 
      pStyleMaterials.ImageType, pStyleMaterials.height, pStyleMaterials.width, pStyleMaterials.CDate, pStyleMaterials.CUser, 
      pStyleMaterials.MDate, pStyleMaterials.MUser, pStyleMaterials.MChange, pStyleMaterials.SChange, pStyleMaterials.DChange, 
      pStyleMaterials.CChange, pStyleMaterials.Action, pStyleMaterials.ColorPlacement, pStyleMaterials.Artwork, 
      pStyleMaterials.License, pStyleMaterials.Colorway, pStyleMaterials.MaterialSort, pStyleMaterials.MaterialTrack, 
      pStyleMaterials.MaterialLinked, pStyleMaterials.MaterialDimension, pStyleMaterials.MaterialLining, pStyleMaterials.MaterialSizeID, 
      pStyleMaterials.MaterialPackLabelGroupID, pStyleMaterials.TradePartnerID, pStyleMaterials.TradePartnerVendorID, 
      pStyleMaterials.MaterialBOM, pComponentType.ComponentOrder, '' AS GroupName, 0 AS MaterialDel, 
	  --pMaterialTradePartner.MaterialTradePartnerCustom1,
	  '<img src=''../System/Control/ImageStream.ashx?S=50&V=' + CAST(ISNULL(pStyleMaterials.MaterialImageVersion, 0) 
      AS NVARCHAR(5)) + '&IID=' + CAST(ISNULL(pStyleMaterials.MaterialImageID, '00000000-0000-0000-0000-000000000000') AS NVARCHAR(50)) 
      + ''' />' AS MaterialImage, pStyleHeader.HeaderLocked
FROM  pStyleMaterials 
	INNER JOIN pMaterial ON pStyleMaterials.MaterialID = pMaterial.MaterialID
	INNER JOIN  pComponentType ON pStyleMaterials.MaterialType = pComponentType.ComponentTypeID 
	INNER JOIN pStyleHeader ON pStyleHeader.StyleID = pStyleMaterials.StyleID
	--LEFT OUTER JOIN pMaterialTradePartner ON ( pStyleMaterials.TradePartnerVendorID = pMaterialTradePartner.TradePartnerVendorID AND pStyleMaterials.MaterialID = pMaterialTradePartner.MaterialID)
WHERE pStyleMaterials.StyleId = @StyleId AND pStyleMaterials.StyleSet = @StyleSet
ORDER BY pStyleMaterials.MainMaterial DESC, pComponentType.ComponentOrder, 
pStyleMaterials.MaterialSort, pStyleMaterials.MaterialNo, pStyleMaterials.MaterialName, pStyleMaterials.StyleMaterialId 












GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleDetail1Variation_UPDATE]'
GO

ALTER PROCEDURE [dbo].[spx_StyleDetail1Variation_UPDATE]
(@StyleID uniqueidentifier,
@StyleDetail nvarchar(MAX))
AS 

--CREATE TABLE #tmpStyleHeader ( 
--    [StyleDetail] nvarchar(4000) NULL
--)

		UPDATE pStyleHeader SET StyleDetail1 = @StyleDetail WHERE StyleID = @StyleID

/*

-----Update all the size range 


INSERT INTO #tmpStyleHeader(StyleDetail)
SELECT  StyleDetail
FROM dbo.pStyleHeader WITH (NOLOCK)
WHERE (StyleID = @StyleID)

CREATE TABLE #tempStyleDevelopmentItem ( 
	[RecID]						int IDENTITY(1,1)  NOT NULL,
	[StyleDevelopmentID]    	uniqueidentifier NULL,
	[StyleID]               	uniqueidentifier NULL,
	[SizeRange]             	nvarchar(50) NULL,
	[Variation]             	int NULL,
	[CUser]                 	nvarchar(200) NULL,
	[CDate]                 	datetime NULL,
	[MUser]                 	nvarchar(200) NULL,
	[MDate]                 	datetime NULL,
)

DECLARE @RowStyleLoop 			int
DECLARE @RowStyleCount 			int
DECLARE @tmpStyleID				uniqueidentifier
DECLARE @tmpStyleVariation		int

DECLARE @StyleDevelopmentId uniqueidentifier
SELECT @tmpStyleVariation = Variation, @StyleDevelopmentId = StyleDevelopmentId FROM pStyleDevelopmentItem WITH (NOLOCK) WHERE StyleId = @StyleId

BEGIN
	INSERT INTO #tempStyleDevelopmentItem (StyleDevelopmentID, StyleID, SizeRange, Variation)
	SELECT StyleDevelopmentID, StyleID, SizeRange, Variation FROM pStyleDevelopmentItem WITH (NOLOCK) 
	WHERE StyleDevelopmentID = @StyleDevelopmentId AND Variation = @tmpStyleVariation
END

--SELECT * FROM #tempStyleDevelopmentItem

SET @RowStyleLoop = 1
SET @RowStyleCount = (SELECT COUNT(*) FROM #tempStyleDevelopmentItem)

WHILE @RowStyleLoop <= @RowStyleCount 

	BEGIN

		SELECT @tmpStyleID = StyleID FROM #tempStyleDevelopmentItem WHERE RecID = @RowStyleLoop

			BEGIN	
			
				UPDATE pStyleHeader
				SET StyleDetail1 = @StyleDetail
				WHERE StyleID = @tmpStyleID
				PRINT @StyleDetail

			END	

		SET @RowStyleLoop = @RowStyleLoop + 1
		
	END
*/


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanStyleColorwayLogic_INSERT]'
GO
CREATE PROCEDURE [dbo].[spx_LinePlanStyleColorwayLogic_INSERT] (
@ColorPaletteID UNIQUEIDENTIFIER ,
@StyleSeasonYearID UNIQUEIDENTIFIER ,
@Params NVARCHAR(4000),
@CUser NVARCHAR(200), 
@CDate DATETIME 
)
AS

DECLARE @SQL NVARCHAR(4000)
DECLARE @StyleID UNIQUEIDENTIFIER 
DECLARE @ColorCode NVARCHAR(200)
DECLARE @ColorName NVARCHAR(200)
DECLARE @StyleColorwayID UNIQUEIDENTIFIER 

SELECT @StyleID = StyleID FROM pStyleSeasonYear  WHERE StyleSeasonyearID = @StyleSeasonYearID
SELECT @ColorCode = a.ColorCode, @ColorName  = a.ColorName  FROM pColorPalette a WHERE ColorPaletteID = @ColorPaletteID 



SELECT TOP 1 @StyleColorwayID = StyleColorID
FROM pStyleColorway a
INNER JOIN pColorPalette b ON a.ColorPaletteID =  b.ColorPaletteID 
WHERE StyleID = @StyleID 
AND b.ColorCode = @ColorCode 
AND b.ColorName = @ColorName 

IF @StyleColorwayID IS NULL 
BEGIN
	SET @StyleColorwayID = NEWID()

	INSERT INTO  pStyleColorway  (StyleColorID, StyleID , StyleSet, StyleColorNo, StyleColorname, Maincolor,  
	Version, CDate,CUser, MDate, MUser, ColorPaletteID )
	VALUES (@StyleColorwayID, @StyleID , 1, @ColorCode, @ColorName, @ColorName,  
	1, @CDate,@CUser, @CDate, @CUser, @ColorPaletteID )

END 

SELECT * FROM pStyleColorwaySeasonYear
DECLARE @StyleColorwaySeasonYearID UNIQUEIDENTIFIER 
SET @StyleColorwaySeasonYearID = NEWID()

INSERT INTO pStyleColorwaySeasonYear ( StyleColorwaySeasonYearID , StyleSeasonYearID , StyleColorwayID , StyleID )
VALUES ( @StyleColorwaySeasonYearID, @StyleSeasonYearID , @StyleColorwayID , @StyleID )


SET @SQL = 'UPDATE pStyleColorwaySeasonYear SET ' + @Params + ' WHERE StyleColorwaySeasonYearID = ''' 
+ CAST(@StyleColorwaySeasonYearID AS NVARCHAR(40)) + ''' '

EXEC (@SQL)

DECLARE @StyleColorDelivery1 INT
DECLARE @StyleColorDelivery2 INT
DECLARE @StyleColorDelivery3 INT
DECLARE @StyleColorDelivery4 INT

SELECT @StyleColorDelivery1=StyleColorDelivery1, @StyleColorDelivery2=StyleColorDelivery2, 
@StyleColorDelivery3=StyleColorDelivery3
FROM pStyleColorwaySeasonYear WHERE StyleColorwaySeasonYearID = @StyleColorwaySeasonYearID

IF @StyleColorDelivery1 = 1 
	SELECT @StyleColorDelivery2 = 1, @StyleColorDelivery3 = 1 
ELSE IF  @StyleColorDelivery2 = 1
	SET @StyleColorDelivery3 = 1 

IF @StyleColorDelivery1 = 1 OR @StyleColorDelivery2 = 1 OR @StyleColorDelivery3 = 1 
	SET @StyleColorDelivery4 = 0 
ELSE
	SET @StyleColorDelivery1 = 1 

UPDATE pStyleColorwaySeasonYear 
SET StyleColorDelivery1 = @StyleColorDelivery1, StyleColorDelivery2 = @StyleColorDelivery2,
StyleColorDelivery3 = @StyleColorDelivery3 , StyleColorDelivery4 = @StyleColorDelivery4,
StyleColorStatus = 100 , SampleStatus = 100
WHERE StyleColorwaySeasonYearID = @StyleColorwaySeasonYearID


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_StyleHeader_SEL]'
GO
ALTER VIEW [dbo].[vwx_StyleHeader_SEL]
AS
SELECT     dbo.pStyleHeader.StyleID, dbo.pStyleHeader.StyleMasterID, dbo.pStyleHeader.StyleWorkflowID, dbo.pStyleHeader.StyleType, 
                      dbo.pStyleHeader.WorkflowType, dbo.pStyleHeader.RefNo, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.TempID, dbo.pStyleHeader.TempNo, 
                      dbo.pStyleHeader.CustomerNo, dbo.pStyleHeader.DevelopmentID, dbo.pStyleHeader.DevelopmentNo, dbo.pStyleHeader.ConceptID, 
                      dbo.pStyleHeader.ConceptNo, dbo.pStyleHeader.SpecNo, dbo.pStyleHeader.Description, dbo.pStyleHeader.StyleCategory, 
                      dbo.pStyleHeader.SizeClass, dbo.pStyleHeader.SizeRange, dbo.pStyleHeader.StyleSet, dbo.pStyleHeader.TechPackId, 
                      dbo.pStyleHeader.TechPackDate, dbo.pStyleHeader.DueDate, dbo.pStyleHeader.RecDate, dbo.pStyleHeader.Customer, dbo.pStyleHeader.Buyer, 
                      dbo.pStyleHeader.Designer, dbo.pStyleHeader.SampleMaker, dbo.pStyleHeader.PatternMaker, dbo.pStyleHeader.ProductionManager, 
                      dbo.pStyleHeader.TechnicalDesigner, dbo.pStyleHeader.StyleStatus, dbo.pStyleHeader.StyleLocation, dbo.pStyleHeader.WashType, 
                      dbo.pStyleHeader.Pitch, dbo.pStyleHeader.MaterialID, dbo.pStyleHeader.MaterialImageID, dbo.pStyleHeader.MaterialImageVersion, 
                      dbo.pStyleHeader.MaterialNo, dbo.pStyleHeader.MaterialName, dbo.pStyleHeader.POMTempGroupID1, dbo.pStyleHeader.POMTempGroupID2, 
                      dbo.pStyleHeader.POMTempGroupID3, dbo.pStyleHeader.POMTempGroupID4, dbo.pStyleHeader.POMTempID1, dbo.pStyleHeader.POMTempVersion1, 
                      dbo.pStyleHeader.POMTempSizeClass1, dbo.pStyleHeader.POMTempID2, dbo.pStyleHeader.POMTempVersion2, 
                      dbo.pStyleHeader.POMTempSizeClass2, dbo.pStyleHeader.POMTempID3, dbo.pStyleHeader.POMTempVersion3, 
                      dbo.pStyleHeader.POMTempSizeClass3, dbo.pStyleHeader.POMTempID4, dbo.pStyleHeader.POMTempVersion4, 
                      dbo.pStyleHeader.POMTempSizeClass4, dbo.pStyleHeader.StyleMaterialID, dbo.pStyleHeader.DesignSketchID, dbo.pStyleHeader.TechSketchID, 
                      dbo.pStyleHeader.ConceptSketchID, dbo.pStyleHeader.ColorSketchID, dbo.pStyleHeader.DesignSketchVersion, dbo.pStyleHeader.TechSketchVersion, 
                      dbo.pStyleHeader.ConceptSketchVersion, dbo.pStyleHeader.ColorSketchVersion, dbo.pStyleHeader.DetailSketchID1, 
                      dbo.pStyleHeader.DetailSketchID2, dbo.pStyleHeader.DetailSketchID3, dbo.pStyleHeader.DetailSketchID4, dbo.pStyleHeader.DetailSketchVersion1, 
                      dbo.pStyleHeader.DetailSketchVersion2, dbo.pStyleHeader.DetailSketchVersion3, dbo.pStyleHeader.DetailSketchVersion4, 
                      dbo.pStyleHeader.SpecSketchID1, dbo.pStyleHeader.SpecSketchID2, dbo.pStyleHeader.SpecSketchID3, dbo.pStyleHeader.SpecSketchID4, 
                      dbo.pStyleHeader.SpecSketchVersion1, dbo.pStyleHeader.SpecSketchVersion2, dbo.pStyleHeader.SpecSketchVersion3, 
                      dbo.pStyleHeader.SpecSketchVersion4, dbo.pStyleHeader.Markup, dbo.pStyleHeader.TargetPrice, dbo.pStyleHeader.SellingPrice, 
                      dbo.pStyleHeader.CustomField1, dbo.pStyleHeader.CustomField2, dbo.pStyleHeader.CustomField3, dbo.pStyleHeader.CustomField4, 
                      dbo.pStyleHeader.CustomField5, dbo.pStyleHeader.CustomField6, dbo.pStyleHeader.CustomField7, dbo.pStyleHeader.CustomField8, 
                      dbo.pStyleHeader.CustomField9, dbo.pStyleHeader.CustomField10, dbo.pStyleHeader.CustomField11, dbo.pStyleHeader.CustomField12, 
                      dbo.pStyleHeader.CustomField13, dbo.pStyleHeader.CustomField14, dbo.pStyleHeader.CustomField15, dbo.pStyleHeader.Pc1, dbo.pStyleHeader.Pc2, 
                      dbo.pStyleHeader.Pc3, dbo.pStyleHeader.Pc4, dbo.pStyleHeader.CUser, dbo.pStyleHeader.CDate, dbo.pStyleHeader.MUser, dbo.pStyleHeader.MDate, 
                      dbo.pStyleHeader.Active, dbo.pStyleHeader.Change, dbo.pStyleHeader.Action, dbo.pStyleHeader.NoColorCombo, dbo.pStyleHeader.StyleVersion, 
                      dbo.pStyleHeader.StyleDetail, dbo.pStyleHeader.StyleDetail1, dbo.pStyleHeader.StyleDetail2, dbo.pStyleHeader.StyleAttribute, 
                      dbo.pStyleHeader.LinePlanID, dbo.pStyleHeader.LinePlanNo, dbo.pStyleHeader.LinePlanSketchID, dbo.pStyleHeader.LinePlanSketchVersion, 
                      dbo.pStyleHeader.CustomField16, dbo.pStyleHeader.CustomField17, dbo.pStyleHeader.CustomField18, dbo.pStyleHeader.CustomField19, 
                      dbo.pStyleHeader.CustomField20, dbo.pStyleHeader.CustomField21, dbo.pStyleHeader.CustomField22, dbo.pStyleHeader.CustomField23, 
                      dbo.pStyleHeader.CustomField24, dbo.pStyleHeader.CustomField25, dbo.pStyleHeader.CustomField26, dbo.pStyleHeader.CustomField27, 
                      dbo.pStyleHeader.CustomField28, dbo.pStyleHeader.CustomField29, dbo.pStyleHeader.CustomField30, dbo.pStyleHeader.PackagingNo, 
                      dbo.pStyleHeader.StyleCopyID, dbo.pStyleHeader.LinePlanItemID, dbo.pStyleHeader.StyleStatusID, dbo.pStyleHeader.BodyID, 
                      dbo.pStyleHeader.TradePartnerID, dbo.pStyleHeader.TradePartnerVendorID, dbo.pSeasonYear.Year, dbo.pSeasonYear.Season, 
                      dbo.pStyleHeader.HeaderLocked, dbo.pStyleSeasonYear.StyleSeasonYearID, dbo.pStyleSeasonYear.SeasonYearID
FROM  dbo.pStyleHeader 
LEFT OUTER JOIN dbo.pStyleSeasonYear ON dbo.pStyleHeader.StyleID = dbo.pStyleSeasonYear.StyleID
LEFT OUTER JOIN dbo.pSeasonYear ON dbo.pSeasonYear.SeasonYearID = dbo.pStyleSeasonYear.SeasonYearID
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rpx_StyleColorwaySeasonalYear_PIVOT]'
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE PROCEDURE [dbo].[rpx_StyleColorwaySeasonalYear_PIVOT] (@StyleId uniqueidentifier, @StyleSeasonYearID NVARCHAR(50)= NULL)    
AS  

SELECT     b.StyleColorName, c.Status, dbo.fnx_int2StrDelivery(a.StyleColorDelivery1) as StyleColorDelivery1, dbo.fnx_int2StrDelivery(a.StyleColorDelivery2) as StyleColorDelivery2, 
dbo.fnx_int2StrDelivery(a.StyleColorDelivery3) as StyleColorDelivery3, dbo.fnx_int2StrDelivery(a.StyleColorDelivery4) as StyleColorDelivery4
FROM         pStyleColorwaySeasonYear AS a INNER JOIN
                      pStyleColorway AS b ON a.StyleColorwayID = b.StyleColorID
LEFT OUTER JOIN pStyleColorwayStatus AS c ON a.StyleColorStatus = c.StatusID
WHERE     (a.StyleSeasonYearID = @StyleSeasonYearId and b.StyleID=@StyleId)   

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialRequestSubmitWorkflowColor_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[spx_MaterialRequestSubmitWorkflowColor_SELECT] (
@MaterialTradePartnerColorID UNIQUEIDENTIFIER,
@MaterialTradePartnerID UNIQUEIDENTIFIER,  
@MaterialRequestWorkflowID VARCHAR(10),
@MaterialSubmit VARCHAR(2)
)
AS

------------ BEGIN ----------
-- Daniel Pak 10/13/2009
-- if request is ALL COLORS, it will create a record on pMaterialRequestSubmitGroup
-- It will group all the colors to a single request (pMaterialRequestSubmitWorkflow, pMaterialRequestSubmit)

DECLARE @MaterialRequestSubmitGroupID uniqueidentifier
DECLARE @MaterialRequestSubmitAllColors int
SELECT @MaterialRequestSubmitAllColors = MaterialRequestSubmitAllColors FROM pMaterialRequestSubmitWorkflow 
	WHERE MaterialTradePartnerID= @MaterialTradePartnerID 
			AND MaterialRequestWorkflowID= @MaterialRequestWorkflowID

IF @MaterialRequestSubmitAllColors = 1
BEGIN

	SELECT TOP 1 @MaterialTradePartnerColorID = MaterialTradePartnerColorID FROM pMaterialTradePartnerColor WHERE MaterialtradePartnerID = @MaterialTradePartnerID ORDER BY CDate ASC
	SET @MaterialRequestSubmitGroupID = newid()

	IF (SELECT COUNT(*) FROM pMaterialRequestSubmitGroup 
		WHERE MaterialTradePartnerID= @MaterialTradePartnerID 
			AND MaterialRequestWorkflowID= @MaterialRequestWorkflowID) = 0
	BEGIN
		INSERT INTO pMaterialRequestSubmitGroup(MaterialRequestSubmitGroupID, MaterialTradePartnerID, MaterialRequestWorkflowID, MaterialTradePartnerColorID)
		VALUES (@MaterialRequestSubmitGroupID, @MaterialTradePartnerID, @MaterialRequestWorkflowID, @MaterialTradePartnerColorID)		

		UPDATE pMaterialRequestSubmitWorkflow SET MaterialRequestSubmitGroupID = @MaterialRequestSubmitGroupID
		WHERE MaterialTradePartnerID= @MaterialTradePartnerID AND
		MaterialRequestWorkflowID= @MaterialRequestWorkflowID	

		UPDATE pMaterialRequestSubmit SET MaterialRequestSubmitGroupID = @MaterialRequestSubmitGroupID
		WHERE MaterialRequestSubmitWorkflowID IN (
			SELECT MaterialRequestSubmitWorkflowID FROM dbo.pMaterialRequestSubmitWorkflow
			WHERE MaterialTradePartnerID= @MaterialTradePartnerID AND
			MaterialRequestWorkflowID= @MaterialRequestWorkflowID)

	END
END

------------ END --------------

SELECT pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID, pMaterialRequestSubmitWorkflow.MaterialTradePartnerID, 
  pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID, pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowTempItemID, 
  pMaterialRequestSubmitWorkflow.MaterialID, pMaterialRequestSubmitWorkflow.MaterialColorID, pMaterialRequestSubmitWorkflow.TradePartnerID, 
  pMaterialRequestSubmitWorkflow.TradePartnerVendorID, pMaterialRequestSubmitWorkflow.FinalDate, 
  pMaterialRequestSubmitWorkflow.Submit AS CurrentSubmit, pMaterialRequestWorkflow.MaterialRequestWorkflow, 
  pMaterialRequestSubmit.MaterialRequestSubmitID, pMaterialRequestWorkflow.MaterialRequestWorkflowID, pMaterialRequestSubmit.Status, 
  pMaterialRequestSubmit.Submit, pMaterialRequestSubmit.SubmitDays, pMaterialRequestSubmit.ResubmitDays, 
  pMaterialRequestSubmit.AssignedTo, pMaterialRequestSubmit.StartDate, pMaterialRequestSubmit.EndDate, pMaterialRequestSubmit.DueDate, 
  pMaterialRequestSubmit.CUser, pMaterialRequestSubmit.CDate, pMaterialRequestSubmit.MUser, pMaterialRequestSubmit.MDate, 
  pMaterialRequestSubmit.AgentView, pMaterialRequestSubmit.VendorComment, pMaterialRequestSubmit.InternalComment, 
  pMaterialRequestSubmit.SubmitComment, pMaterialRequestWorkflow.MaterialRequestWorkflowColor, 
  pMaterialRequestWorkflowTemplateItem.MaterialRequestWorkflowTempID, pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowGroupID,
  pMaterialRequestSubmitWorkflow.MaterialRequestSubmitAllColors
FROM  pMaterialRequestSubmitWorkflow INNER JOIN
  pMaterialRequestWorkflow ON 
  pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID = pMaterialRequestWorkflow.MaterialRequestWorkflowID INNER JOIN
  pMaterialRequestSubmit ON 
  pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID = pMaterialRequestSubmit.MaterialRequestSubmitWorkflowID LEFT OUTER JOIN
  pMaterialRequestWorkflowTemplateItem ON 
  pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowTempItemID = pMaterialRequestWorkflowTemplateItem.MaterialRequestWorkflowTempItemID
WHERE pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID = @MaterialTradePartnerColorID
	AND pMaterialRequestSubmitWorkflow.MaterialTradePartnerID = @MaterialTradePartnerID
	AND pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID = @MaterialRequestWorkflowID
	AND pMaterialRequestSubmit.Submit = @MaterialSubmit





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pStyleColorStandard]'
GO
ALTER TABLE [dbo].[pStyleColorStandard] ALTER COLUMN [StyleColorNo] [nvarchar] (10) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[pStyleColorStandard] ALTER COLUMN [StyleColorName] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
ALTER TABLE [dbo].[pStyleColorStandard] ALTER COLUMN [Active] [int] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleDetail2Variation_UPDATE]'
GO

ALTER PROCEDURE [dbo].[spx_StyleDetail2Variation_UPDATE]
(@StyleID uniqueidentifier,
@StyleDetail nvarchar(MAX))
AS 


DECLARE @Variation int 
DECLARE @StyleDevelopmentId uniqueidentifier 


	SELECT @Variation = Variation,  @StyleDevelopmentId = StyleDevelopmentId 
	FROM dbo.pStyleDevelopmentItem WITH (NOLOCK) 
	WHERE StyleID = @StyleID 


--	UPDATE pStyleHeader SET StyleDetail2 = @StyleDetail WHERE StyleID = @StyleID

	IF @Variation IS NOT NULL AND @StyleDevelopmentId  IS NOT NULL 
	BEGIN 
		
		UPDATE pStyleHeader SET StyleDetail2 = @StyleDetail 
		WHERE StyleID  IN  (
			SELECT StyleID  FROM dbo.pStyleDevelopmentItem WITH (NOLOCK)  WHERE  StyleDevelopmentId  = @StyleDevelopmentId  AND  Variation = @Variation 
		) 
	
	END

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_StyleHeader_SELECT]'
GO
/*
select   * from (

 (
SELECT     pStyleHeader.* , NULL  as AgentVendor
FROM         dbo.pStyleHeader
WHERE  pStyleHeader.StyleId NOT IN (
	SELECT  a.StyleID
	FROM pStyleTeam a , uTradePartner  b
	WHERE  a.TeamID  = b.TradePartnerID
	AND b.Custom1 = 'Agent-Vendor'  
	GROUP BY  a.StyleID
	HAVING COUNT(*) >= 1
	)
)
UNION ALL
(
SELECT  c.* ,   b.TradePartnerName     as AgentVendor
FROM pStyleTeam a , uTradePartner  b, pStyleHeader c
WHERE  a.TeamID  = b.TradePartnerID
AND a.StyleID = c.StyleID
AND b.Custom1 = 'Agent-Vendor'  
) 




UNION 
(
	SELECT  pStyleHeader.* ,  NULL AS AgentVendor
	FROM  pStyleHeader 	
	WHERE StyleID  IN ( 
		SELECT  a.StyleID 
		FROM pStyleTeam a , uTradePartner  b 
		WHERE  a.TeamID  = b.TradePartnerID
		AND ( b.Custom1 not LIKE  '%Agent-Vendor%'   OR b.Custom1 IS NULL  )
		GROUP BY  a.StyleID
	)

)


)as foo */
ALTER VIEW dbo.vwx_StyleHeader_SELECT
AS
SELECT     dbo.pStyleHeader.StyleID, dbo.pStyleHeader.StyleMasterID, dbo.pStyleHeader.StyleWorkflowID, dbo.pStyleHeader.StyleType, dbo.pStyleHeader.WorkflowType, 
                      dbo.pStyleHeader.RefNo, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.TempID, dbo.pStyleHeader.TempNo, dbo.pStyleHeader.CustomerNo, 
                      dbo.pStyleHeader.DevelopmentID, dbo.pStyleHeader.DevelopmentNo, dbo.pStyleHeader.ConceptID, dbo.pStyleHeader.ConceptNo, dbo.pStyleHeader.SpecNo, 
                      dbo.pStyleHeader.Description, dbo.pStyleHeader.StyleCategory, dbo.pStyleHeader.SizeClass, dbo.pStyleHeader.SizeRange, dbo.pStyleHeader.StyleSet, 
                      dbo.pStyleHeader.TechPackId, dbo.pStyleHeader.TechPackDate, dbo.pStyleHeader.DueDate, dbo.pStyleHeader.RecDate, dbo.pStyleHeader.Customer, 
                      dbo.pStyleHeader.Buyer, dbo.pStyleHeader.Designer, dbo.pStyleHeader.SampleMaker, dbo.pStyleHeader.PatternMaker, dbo.pStyleHeader.ProductionManager, 
                      dbo.pStyleHeader.TechnicalDesigner, dbo.pStyleHeader.StyleStatus, dbo.pStyleHeader.StyleLocation, dbo.pStyleHeader.WashType, dbo.pStyleHeader.Pitch, 
                      dbo.pStyleHeader.MaterialID, dbo.pStyleHeader.MaterialImageID, dbo.pStyleHeader.MaterialImageVersion, dbo.pStyleHeader.MaterialNo, 
                      dbo.pStyleHeader.MaterialName, dbo.pStyleHeader.POMTempGroupID1, dbo.pStyleHeader.POMTempGroupID2, dbo.pStyleHeader.POMTempGroupID3, 
                      dbo.pStyleHeader.POMTempGroupID4, dbo.pStyleHeader.POMTempID1, dbo.pStyleHeader.POMTempVersion1, dbo.pStyleHeader.POMTempSizeClass1, 
                      dbo.pStyleHeader.POMTempID2, dbo.pStyleHeader.POMTempVersion2, dbo.pStyleHeader.POMTempSizeClass2, dbo.pStyleHeader.POMTempID3, 
                      dbo.pStyleHeader.POMTempVersion3, dbo.pStyleHeader.POMTempSizeClass3, dbo.pStyleHeader.POMTempID4, dbo.pStyleHeader.POMTempVersion4, 
                      dbo.pStyleHeader.POMTempSizeClass4, dbo.pStyleHeader.StyleMaterialID, dbo.pStyleHeader.DesignSketchID, dbo.pStyleHeader.TechSketchID, 
                      dbo.pStyleHeader.ConceptSketchID, dbo.pStyleHeader.ColorSketchID, dbo.pStyleHeader.DesignSketchVersion, dbo.pStyleHeader.TechSketchVersion, 
                      dbo.pStyleHeader.ConceptSketchVersion, dbo.pStyleHeader.ColorSketchVersion, dbo.pStyleHeader.DetailSketchID1, dbo.pStyleHeader.DetailSketchID2, 
                      dbo.pStyleHeader.DetailSketchID3, dbo.pStyleHeader.DetailSketchID4, dbo.pStyleHeader.DetailSketchVersion1, dbo.pStyleHeader.DetailSketchVersion2, 
                      dbo.pStyleHeader.DetailSketchVersion3, dbo.pStyleHeader.DetailSketchVersion4, dbo.pStyleHeader.SpecSketchID1, dbo.pStyleHeader.SpecSketchID2, 
                      dbo.pStyleHeader.SpecSketchID3, dbo.pStyleHeader.SpecSketchID4, dbo.pStyleHeader.SpecSketchVersion1, dbo.pStyleHeader.SpecSketchVersion2, 
                      dbo.pStyleHeader.SpecSketchVersion3, dbo.pStyleHeader.SpecSketchVersion4, dbo.pStyleHeader.Markup, dbo.pStyleHeader.TargetPrice, 
                      dbo.pStyleHeader.SellingPrice, dbo.pStyleHeader.CustomField1, dbo.pStyleHeader.CustomField2, dbo.pStyleHeader.CustomField3, dbo.pStyleHeader.CustomField4, 
                      dbo.pStyleHeader.CustomField5, dbo.pStyleHeader.CustomField6, dbo.pStyleHeader.CustomField7, dbo.pStyleHeader.CustomField8, dbo.pStyleHeader.CustomField9,
                       dbo.pStyleHeader.CustomField10, dbo.pStyleHeader.CustomField11, dbo.pStyleHeader.CustomField12, dbo.pStyleHeader.CustomField13, 
                      dbo.pStyleHeader.CustomField14, dbo.pStyleHeader.CustomField15, dbo.pStyleHeader.Pc1, dbo.pStyleHeader.Pc2, dbo.pStyleHeader.Pc3, dbo.pStyleHeader.Pc4, 
                      dbo.pStyleHeader.CUser, dbo.pStyleHeader.CDate, dbo.pStyleHeader.MUser, dbo.pStyleHeader.MDate, dbo.pStyleHeader.Active, dbo.pStyleHeader.Change, 
                      dbo.pStyleHeader.Action, dbo.pStyleHeader.NoColorCombo, dbo.pStyleHeader.StyleVersion, dbo.pStyleHeader.StyleDetail, dbo.pStyleHeader.StyleDetail1, 
                      dbo.pStyleHeader.StyleDetail2, dbo.pStyleHeader.StyleAttribute, dbo.pStyleHeader.LinePlanID, dbo.pStyleHeader.LinePlanNo, dbo.pStyleHeader.LinePlanSketchID, 
                      dbo.pStyleHeader.LinePlanSketchVersion, dbo.pStyleHeader.CustomField16, dbo.pStyleHeader.CustomField17, dbo.pStyleHeader.CustomField18, 
                      dbo.pStyleHeader.CustomField19, dbo.pStyleHeader.CustomField20, dbo.pStyleHeader.CustomField21, dbo.pStyleHeader.CustomField22, 
                      dbo.pStyleHeader.CustomField23, dbo.pStyleHeader.CustomField24, dbo.pStyleHeader.CustomField25, dbo.pStyleHeader.CustomField26, 
                      dbo.pStyleHeader.CustomField27, dbo.pStyleHeader.CustomField28, dbo.pStyleHeader.CustomField29, dbo.pStyleHeader.CustomField30, 
                      dbo.pStyleHeader.PackagingNo, dbo.pStyleHeader.StyleCopyID, dbo.pStyleHeader.LinePlanItemID, dbo.pStyleHeader.StyleStatusID, dbo.pStyleHeader.BodyID, 
                      dbo.pStyleHeader.TradePartnerID, dbo.pStyleHeader.TradePartnerVendorID, dbo.pStyleSeasonYear.StyleSeason, dbo.pStyleSeasonYear.StyleYear, 
                      dbo.pStyleHeader.StyleLinkID
FROM         dbo.pStyleHeader LEFT OUTER JOIN
                      dbo.pStyleSeasonYear ON dbo.pStyleHeader.StyleID = dbo.pStyleSeasonYear.StyleID
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanMultiCloth_StyleMaterialColors_INSERT]'
GO
SET QUOTED_IDENTIFIER OFF
GO


/***
Comment #01 - Clayton Parker - March 8 2010
Modified the procedure below to correct an issue with a Latin error when creating a multi cloth style.
*/


CREATE PROCEDURE [dbo].[spx_LinePlanMultiCloth_StyleMaterialColors_INSERT](
@LinePlanColorGroupID UNIQUEIDENTIFIER, 
@LinePlanRangeID  UNIQUEIDENTIFIER, 
@MaterialCoreID UNIQUEIDENTIFIER, 
@CUser NVARCHAR(200),
@CDate DATETIME,
@NewLinePlanItemID UNIQUEIDENTIFIER 
)
AS 

---DECLARE @StyleID UNIQUEIDENTIFIER 
DECLARE @MaterialID UNIQUEIDENTIFIER 
DECLARE @NewStyleID UNIQUEIDENTIFIER 
DECLARE @TOTAL INT
DECLARE @ROWID INT 


-- ***
-- ** Insert styles to Lineplan
-- ***
DECLARE @LinePlanItemID UNIQUEIDENTIFIER 
DECLARE @LinePlanID UNIQUEIDENTIFIER 
DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER 
DECLARE @Season NVARCHAR(200)
DECLARE @Year NVARCHAR(200)
DECLARE @SeasonYearID UNIQUEIDENTIFIER 

--***
--** Get SeasonYear ID
--***
SELECT @LinePlanID = a.LinePlanID, @Season = RTRIM(LTRIM(b.Season)), @Year = RTRIM(LTRIM(b.Year))
FROM pLinePlanRange a
INNER JOIN pLinePlan b ON a.LinePlanID = b.LinePlanID 
WHERE a.LinePlanRangeID = @LinePlanRangeID	


SELECT @SeasonYearID = SeasonYearID
FROM pSeasonYear
WHERE Season = @Season AND Year = @Year 

IF @SeasonYearID IS NULL 
BEGIN
	SET @SeasonYearID  =  NEWID() 
	
	INSERT INTO pSeasonYear ( SeasonYearID, Season, Year )
	VALUES (@SeasonYearID, @Season, @Year )
END 


--***
--** Get Styles
--***
CREATE TABLE  #s(
RowID INT IDENTITY (1,1),
StyleID UNIQUEIDENTIFIER, 
NewStyleID UNIQUEIDENTIFIER DEFAULT NEWID()
)

INSERT INTO #s(StyleID)
SELECT DISTINCT StyleID FROM pLinePlanMultiClothStyleTemp
WHERE LinePlanColorGroupID = @LinePlanColorGroupID

SELECT @TOTAL = COUNT(*) FROM #s 
SET @ROWID = 1

SELECT * FROM #s 

WHILE @ROWID <= @TOTAL
BEGIN
	SELECT @MaterialID = StyleID , @NewStyleID = NewStyleID 
	FROM #s WHERE RowID = @ROWID
	

	CREATE TABLE #sm ( 
		RowID INT IDENTITY(1,1),
		StyleMaterialID UNIQUEIDENTIFIER DEFAULT NEWID(),
		StyleID UNIQUEIDENTIFIER,
		SeasonYearID UNIQUEIDENTIFIER,
		MaterialID UNIQUEIDENTIFIER,
		MainMaterial INT, 
		MaterialCoreItemID UNIQUEIDENTIFIER, 
		[UOM] [nvarchar](50) Collate SQL_Latin1_General_CP1_CI_AS NULL, --#01
		[Qty] [nvarchar](18) Collate SQL_Latin1_General_CP1_CI_AS NULL, --#01
		[MaterialPrice] [money] NULL,
		[Ext] [money] NULL,
		[MaterialSize] [nvarchar](100) Collate SQL_Latin1_General_CP1_CI_AS NULL, --#01
		[Placement] [nvarchar](4000) Collate SQL_Latin1_General_CP1_CI_AS NULL, --#01
		[Artwork] [int] NULL,
		[License] [int] NULL,
		[Colorway] [int] NULL,
		MultiCloth INT DEFAULT(0)	
	)

	CREATE TABLE #scw(
		StyleColorID UNIQUEIDENTIFIER DEFAULT NEWID(),
		StyleID UNIQUEIDENTIFIER, 
		ColorPaletteID UNIQUEIDENTIFIER,
		MaterialCoreColorID UNIQUEIDENTIFIER 
	) 

	CREATE TABLE #scwi (
		RowID INT IDENTITY(1,1),
		MainMaterial INT ,
		StyleColorID UNIQUEIDENTIFIER,
		StyleMaterialID UNIQUEIDENTIFIER,
		MaterialColorID UNIQUEIDENTIFIER,
		ColorPaletteID UNIQUEIDENTIFIER,
		MaterialCoreItemID UNIQUEIDENTIFIER,
		MaterialCoreColorID UNIQUEIDENTIFIER, 
		MaterialCoreColorItemID UNIQUEIDENTIFIER
	)
	
	--***
	--** Insert Style ID 
	--***
	INSERT INTO pStyleHeader (StyleID, StyleLinkID)  VALUES (@NewStyleID, @LinePlanColorGroupID)
	
	--***
	--** Insert Main Style Materials
	--***
	INSERT INTO #sm( StyleMaterialID, StyleID , MaterialID, MainMaterial, MaterialCoreItemID, SeasonYearID, MultiCloth) 
	VALUES (NEWID(), @NewStyleID,@MaterialID, 1 , NULL, @SeasonYearID, 0) 
	
	--*** 
	--**Update pStyleHeader with Main Material, and MaterialGroup 
	--***
	UPDATE pStyleHeader SET 
		MaterialID = pMaterial.MaterialID,
		MaterialNo= pMaterial.MaterialNo,
		MaterialName = pMaterial.MaterialName,
		MaterialImageID = pMaterial.MaterialImageID,
		MaterialImageVersion = pMaterial.MaterialImageVersion,
		MaterialCoreID  = @MaterialCoreID 
	FROM pMaterial WHERE pMaterial.MaterialID = @MaterialID	
		AND pStyleHeader.StyleID = @NewStyleId
		 	
	
	IF @MaterialCoreID IS NOT NULL AND @MaterialCoreID <> '00000000-0000-0000-0000-000000000000'
	BEGIN
		INSERT INTO #sm( StyleID , MaterialID, MainMaterial, MaterialCoreItemID, UOM, Qty, MaterialPrice, Ext, MaterialSize, Placement, Artwork, License, Colorway, SeasonYearID, MultiCloth) 
		SELECT @NewStyleID, MaterialID , 0, MaterialCoreItemID, UOM, Qty, MaterialPrice, Ext, MaterialSize, Placement, Artwork, License, Colorway, @SeasonYearID, 1
		FROM pMaterialCoreItem WHERE MaterialCoreID = @MaterialCoreID
	END 
	
	-- ***
	-- ** Insert Style Colorways
	-- ** LinePlanColorItemID = ColorPaletteID 
	-- ***
	INSERT INTO #scw (StyleID ,ColorPaletteID, MaterialCoreColorID) 
	SELECT DISTINCT @NewStyleID, ColorPaletteID, MaterialGroupColorID 
	FROM  pLinePlanMultiClothColorTemp a
	WHERE a.MaterialID = @MaterialID 
	AND a.LinePlanColorGroupID = @LinePlanColorGroupID

	-- ***
	-- ** Insert Style Colorways Items
	-- ***
	INSERT INTO #scwi ( MainMaterial, StyleMaterialID, StyleColorID, ColorPaletteID, MaterialCoreItemID, MaterialCoreColorID)
	SELECT a.MainMaterial, a.StyleMaterialID, b.StyleColorID, b.ColorPaletteID, a.MaterialCoreItemID, b.MaterialCoreColorID 
	FROM #sm a
	CROSS JOIN #scw b
	
	DECLARE @MainMaterial INT 
	DECLARE @StyleMaterialID UNIQUEIDENTIFIER 
	DECLARE @StyleColorID UNIQUEIDENTIFIER 
	DECLARE @ColorPaletteID UNIQUEIDENTIFIER 
	DECLARE @MaterialCoreItemID  UNIQUEIDENTIFIER 
	DECLARE @MaterialGroupColorID UNIQUEIDENTIFIER
	DECLARE @MaterialColorID  UNIQUEIDENTIFIER
	DECLARE @MaterialCoreColorID  UNIQUEIDENTIFIER
	DECLARE @MaterialCoreColorItemID  UNIQUEIDENTIFIER
	
	DECLARE @iTOTAL INT
	DECLARE @iROW INT
	
	SET @iROW = 1 
	SELECT @iTOTAL = COUNT(*) FROM  #scwi
	
	WHILE @iROW <= @iTOTAL 
	BEGIN
		SELECT @MainMaterial = MainMaterial, @StyleMaterialID = StyleMaterialID, @MaterialCoreColorID = MaterialCoreColorID, 
			@StyleColorID = StyleColorID, @ColorPaletteID = ColorPaletteID, @MaterialCoreItemID = MaterialCoreItemID
		FROM #scwi WHERE RowID = @iROW 
		
		SET @MaterialColorID = NULL
		SET @MaterialCoreColorItemID = (SELECT TOP 1 MaterialCoreColorItemID 
			FROM pMaterialCoreColorItem WHERE MaterialCoreColorID = @MaterialCoreColorID 
				AND MaterialCoreItemID = @MaterialCoreItemID)
		
		IF  @MainMaterial = 1 
			SELECT TOP 1 @MaterialColorID = MaterialColorID FROM pLinePlanMultiClothColorTemp 
			WHERE MaterialID = @MaterialID AND ColorPaletteID = @ColorPaletteID 
				AND LinePlanColorGroupID = @LinePlanColorGroupID 
		ELSE
		BEGIN
		
			SET @MaterialGroupColorID = NULL 
		
			SELECT TOP 1 @MaterialGroupColorID = MaterialGroupColorID 
			FROM pLinePlanMultiClothColorTemp
			WHERE  MaterialID = @MaterialID
					AND ColorPaletteID = @ColorPaletteID
					AND LinePlanColorGroupID = @LinePlanColorGroupID 
			
			IF @MaterialGroupColorID IS NOT NULL
				SELECT TOP 1 @MaterialColorID = MaterialColorID FROM pMaterialCoreColorItem 
				WHERE MaterialCoreColorID = @MaterialGroupColorID
				AND MaterialCoreItemID  = @MaterialCoreItemID
		END 
		
		BEGIN
			UPDATE #scwi SET 
				MaterialColorID = @MaterialColorID, 
				MaterialCoreColorItemID = @MaterialCoreColorItemID 
			WHERE RowID = @iROW
		END
		SET @iROW = @iROW + 1 
	END 
			
	--Insert StyleMaterial from MaterialGroup
	--pStylematerials.MaterialCoreItemId will group style material
	--IF Conversion failed when converting from a character string to uniqueidentifier. Check the MaterialSizeID
	INSERT INTO pStyleMaterials ( StyleMaterialID , StyleMaterialMasterID, MainMaterial,StyleSet, StyleID, 
		MaterialID , MaterialImageID , MaterialImageVersion, MaterialType, MaterialNo, MaterialName, 
		A,B, C, D ,E, F, G,H, I, J , K, L, M , N, O, P, Q, R, S, T, 
		U, V,W, X, Y, Z, Notes, CUser, CDate,MUser,MDate, MChange, Colorway,
		UOM, Qty, MaterialPrice, Ext, MaterialSize, Placement, Artwork, License, StyleMaterialLinkID, MultiCloth, 
		MaterialSizeID)
	SELECT  sm.StyleMaterialID, NEWID() AS StyleMaterialMasterID, sm.MainMaterial, 1 AS StyleSet, sm.StyleID, a.MaterialID, ISNULL(a.MaterialImageID,'00000000-0000-0000-0000-000000000000') AS MaterialImageID, 
	  ISNULL(a.MaterialImageVersion,1) AS MaterialImageVersion, a.MaterialType, a.MaterialNo, a.MaterialName, a.A, a.B, a.C, a.D, a.E, a.F, a.G, a.H, a.I, a.J, a.K, a.L, a.M, a.N, a.O, a.P, a.Q, a.R, a.S, a.T, a.U, 
	  a.V, a.W, a.X, a.Y, a.Z, a.Notes, @CUser AS CreatedBy, @CDate AS CreatedDate, @CUser AS ModifiedBy, @CDate AS ModifiedDate, a.MChange, 1 AS Colorway, 
	  a.UOM, ISNULL(sm.Qty, 0) AS Qty, ISNULL(sm.MaterialPrice, 0) AS MaterialPrice, sm.Ext, sm.MaterialSize, sm.Placement, 
	  ISNULL(sm.Artwork, 0) AS Artwork, ISNULL(sm.License, 0) AS License, sm.MaterialCoreItemID, MultiCloth,
	  b.MaterialSizeID
	FROM #sm sm 
	INNER JOIN pMaterial AS a ON sm.MaterialID = a.MaterialID
	LEFT OUTER JOIN pMaterialSize b ON (b.MaterialID = sm.MaterialID AND b.MaterialSize = sm.MaterialSize)
  
	--***
	--** Insert Stylecolor records
	--***	
	INSERT INTO pStyleColorway ( StyleColorID , StyleID , StyleSet, StyleColorNo, StyleColorName, MainColor, Version, 
	CDate, CUser, MDate, MUser, ColorPaletteID ) 
	SELECT scw.StyleColorID, scw.StyleID , 1, b.ColorCode, b.ColorName, b.ColorName, 1, 
	@CDate ,@CUser,@CDate, @CUser, scw.ColorPaletteID
	FROM #scw scw
	INNER JOIN pColorPalette b ON b.ColorPaletteID =  scw.ColorPaletteID


	INSERT INTO pStyleColorwayItem ( StyleColorItemID, StyleColorID , StyleID , StyleSet, StyleMaterialID, MaterialID, 
	MaterialColorID, CDate, CUser, MDate, MUser, MaterialCoreColorItemID) 
	SELECT NEWID() , a.StyleColorID, b.StyleID , 1, a.StyleMaterialID , c.MaterialID, 
	a.MaterialColorID ,@CDate, @CUser, @CDate, @CUser, a.MaterialCoreColorItemID 
	FROM #scwi a
	INNER JOIN #scw b ON a.StyleColorID = b.StyleColorID 
	INNER JOIN #sm c ON c.StyleMaterialID = a.StyleMaterialID 


	--***
	--** Get Lineplanitem
	--***
	DECLARE @LinePlanStyleAttributeItemID UNIQUEIDENTIFIER 
	SELECT @LinePlanStyleAttributeItemID = LinePlanStyleAttributeItemID FROM pLinePlanItem
	WHERE LinePlanItemID = @NewLinePlanItemID 
	IF @LinePlanStyleAttributeItemID = '00000000-0000-0000-0000-000000000000' 
		SET @LinePlanStyleAttributeItemID = NULL
	
	SET @LinePlanItemID =  NULL
	
	IF @LinePlanStyleAttributeItemID IS NULL 
	BEGIN
		SELECT TOP 1 @LinePlanItemID = a.LinePlanItemID 
		FROM pLinePlanItem a
		WHERE a.LinePlanRangeID = @LinePlanRangeID 
		AND a.StyleID = '00000000-0000-0000-0000-000000000000'
		AND a.LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003'
		AND (a.LinePlanStyleAttributeItemID IS NULL OR a.LinePlanStyleAttributeItemID = '00000000-0000-0000-0000-000000000000')
	END 
	ELSE
	BEGIN
		SELECT TOP 1 @LinePlanItemID = a.LinePlanItemID 
		FROM pLinePlanItem a
		WHERE a.LinePlanRangeID = @LinePlanRangeID 
		AND a.StyleID = '00000000-0000-0000-0000-000000000000'
		AND a.LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003'		
		AND a.LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID
	END 



	IF @LinePlanItemID IS NULL 
	BEGIN
		SET @LinePlanItemID  = NEWID()
	
		INSERT INTO  pLinePlanItem (StyleID, LinePlanItemID , LinePlanRangeID , LinePlanRangeTypeID, LinePlanID,  CUser, CDate, MUser, MDate, LinePlanStyleAttributeItemID )
		SELECT  @NewStyleID, @LinePlanItemID , a.LinePlanRangeID , '00000000-0000-0000-0000-000000000003', a.LinePlanID, @CUser, @CDate, @CUser, @CDate, @LinePlanStyleAttributeItemID
		FROM pLinePlanRange a
		WHERE A.LinePlanRangeID = @LinePlanRangeID 
	END 
	ELSE
	BEGIN 
		UPDATE pLinePlanItem SET StyleID = @NewStyleID, MUser =@CUser, MDate = @CDate 
		WHERE LinePlanItemID = @LinePlanItemID 	
	END 
	


	--***
	--** Insert Style SeasonYear 
	--***
	SET @StyleSeasonYearID = NEWID() 
	
	INSERT INTO pStyleSeasonYear (StyleSeasonYearID , StyleID , StyleSeason, StyleYear, 
		CUser, CDate, MUser, MDate, SeasonYearID,LinePlanID, LinePlanItemID )
	VALUES ( @StyleSeasonYearID , @NewStyleID, @Season, @Year, 
		@CUser, @CDate, @CUser, @CDate, @SeasonYearID, @LinePlanID , @LinePlanItemID )  
	
	--***
	--** Insert StyleColorway / SeasonYear 
	--***	
	SELECT b.StyleColorID, b.StyleID,
		a.StyleColorDelivery1, a.StyleColorDelivery2, a.StyleColorDelivery3, a.StyleColorDelivery4, a.Units, a.ColorType   
	INTO #SCWsy
	FROM pLinePlanMultiClothColorTemp a
	INNER JOIN #scw b ON a.ColorPaletteID  = b.ColorPaletteID
	WHERE a.MaterialID = @MaterialID AND a.LinePlanColorGroupID = @LinePlanColorGroupID 
	GROUP BY b.StyleColorID, b.StyleID,
		a.StyleColorDelivery1, a.StyleColorDelivery2, a.StyleColorDelivery3, a.StyleColorDelivery4, a.Units, a.ColorType  

	INSERT INTO pStyleColorwaySeasonYear ( StyleColorwaySeasonYearID, StyleSeasonYearID , StyleColorwayID , StyleID , 
		StyleColorDelivery1, StyleColorDelivery2, StyleColorDelivery3, StyleColorDelivery4, Units, ColorType)
	SELECT NEWID(), @StyleSeasonYearID, a.StyleColorID, a.StyleID, a.StyleColorDelivery1, 
		a.StyleColorDelivery2, a.StyleColorDelivery3, a.StyleColorDelivery4, a.Units, a.ColorType    
	FROM #SCWsy a
	
	
	--***
	--**  ADD Material / SeasonYear 
	--***
	DECLARE @MaterialSeasonYearID UNIQUEIDENTIFIER 
	DECLARE @MaterialColorSeasonYearID UNIQUEIDENTIFIER 

	CREATE TABLE #m_sy (
		RowID INT IDENTITY(1,1),
		MaterialID UNIQUEIDENTIFIER 
	)

	INSERT INTO #m_sy ( MaterialID ) 
	SELECT DISTINCT MaterialID FROM #sm 
	WHERE MaterialID IS NOT NULL 
	
	
	
	SELECT @iTOTAL = COUNT(*) FROM  #m_sy
	SET @iROW  = 1 
	WHILE @iROW <= @iTOTAL
	BEGIN 
		SELECT @MaterialID  = MaterialID from  #m_sy WHERE  RowID = @iROW 
		SET @MaterialSeasonYearID = NULL

		SELECT @MaterialSeasonYearID = MaterialSeasonYearID 
		FROM pMaterialSeasonYear WHERE MaterialID = @MaterialID AND SeasonYearID = @SeasonYearID 
		
		IF @MaterialSeasonYearID IS NULL
		BEGIN
			SET @MaterialSeasonYearID = NEWID()
			INSERT INTO pMaterialSeasonYear (MaterialSeasonYearID,SeasonYearID, MaterialID, CUser,CDate)
			VALUES (@MaterialSeasonYearID,@SeasonYearID, @MaterialID, 'SYSTEM_MC',GETDATE())
		END 
		
		SET @iROW  = @iROW + 1 
	END 
	
	--***
	--** ADD MaterialColors /SeasonYear 
	--***
	CREATE TABLE #mc_sy(
		RowID INT IDENTITY (1,1),
		MaterialColorID UNIQUEIDENTIFIER, 
		MaterialID UNIQUEIDENTIFIER
	)
		
	INSERT INTO #mc_sy ( MaterialColorID, MaterialID ) 
	SELECT DISTINCT a.MaterialColorID, b.MaterialID 
	FROM #scwi a
	INNER JOIN pMaterialColor b ON a.MaterialColorID =  b.MaterialColorID
		
	SELECT @iTOTAL = COUNT(*) FROM #mc_sy 
	SET @iROW = 1 
		
	WHILE @iROW <= @iTOTAL 
	BEGIN
	
		SELECT @MaterialColorID = MaterialColorID, @MaterialID = MaterialID 
		FROM #mc_sy WHERE RowID = @iROW
		
		SET @MaterialColorSeasonYearID = NULL
		
		SELECT @MaterialColorSeasonYearID = MaterialColorSeasonYearID
		FROM pMaterialColorSeasonYear 
		WHERE MaterialColorID = @MaterialColorID AND SeasonYearID = @SeasonYearID 
		
		IF  @MaterialColorSeasonYearID IS NULL
		BEGIN
			INSERT INTO pMaterialColorSeasonYear (MaterialColorSeasonYearID, MaterialColorID , MaterialID, 
			SeasonYearID, MaterialSeason, MaterialYear , CUser, CDate ) 
			VALUES (NEWID(), @MaterialColorID , @MaterialID ,  @SeasonYearID , @Season, @Year,'SYSTEM_MC' , GETDATE())   
		END 
		
		SET @iROW = @iROW + 1 
		
	END 
				
		
	
	
	
	
/*	
	
	BEGIN
		--Daniel Pak 2/13/2010
		--Add Material Season Year
		--Add Material Color Season Year
		BEGIN
			CREATE TABLE #tmpMaterialColor (
				RowID INT IDENTITY(1,1),
				MaterialColorID UNIQUEIDENTIFIER,
				MaterialID UNIQUEIDENTIFIER
			)
		END
		
		--Insert available material colors from style material colors by season and year
		BEGIN
			INSERT INTO #tmpMaterialColor(MaterialColorID, MaterialID)			
			SELECT MaterialColorID, MaterialID  
				FROM pStyleColorwayItem WHERE StyleID = @NewStyleID AND StyleColorID IN (	
			SELECT StyleColorID FROM pStyleColorwaySeasonYear 
				WHERE StyleID = @NewStyleID AND StyleSeasonYearID IN	
				(SELECT StyleSeasonYearID FROM pStyleSeasonYear 
				WHERE SeasonYearID = @SeasonYearID))	
		END
			
		--Create Material Season & Year
		DECLARE @StyleMaterialCount INT
		DECLARE @StyleMaterialIndex INT
		DECLARE @SM_SeasonYearID uniqueidentifier
		DECLARE @SM_MaterialID uniqueidentifier
		DECLARE @SM_MaterialSeasonYearID uniqueidentifier
		
			SELECT @StyleMaterialCount  = COUNT(*) FROM #sm 
			SET @StyleMaterialIndex = 1

			--Loop style material to add season year
			WHILE @StyleMaterialIndex <= @StyleMaterialCount
			BEGIN
				SELECT @SM_MaterialID = MaterialID, @SM_SeasonYearID = SeasonYearID
				FROM #sm WHERE RowID = @StyleMaterialIndex
					BEGIN
					IF (SELECT COUNT(*) FROM pMaterialSeasonYear WHERE MaterialID = @SM_MaterialID AND SeasonYearID = @SM_SeasonYearID) = 0				
						BEGIN	
							SET @SM_MaterialSeasonYearID = NEWID()
							INSERT INTO pMaterialSeasonYear(MaterialSeasonYearID, MaterialID, SeasonYearID, CUser, CDate)
							VALUES (@SM_MaterialSeasonYearID, @SM_MaterialID, @SM_SeasonYearID, 'SYSTEM_MC', GETDATE())  
						END
					ELSE
						SET @SM_MaterialSeasonYearID = (SELECT TOP 1 MaterialSeasonYearID FROM pMaterialSeasonYear 
								WHERE MaterialID = @SM_MaterialID AND SeasonYearID = @SM_SeasonYearID)
					END	
								
				SET @StyleMaterialIndex = @StyleMaterialIndex + 1 
			END
			
		--Create Material Color  Season & Year
		DECLARE @MaterialColorCount INT
		DECLARE @MaterialColorIndex INT
		DECLARE @MC_MaterialID uniqueidentifier
		DECLARE @MC_MaterialColorID uniqueidentifier
		
		DECLARE @SeasonName varchar(200)
		DECLARE @SeasonYear varchar(4)
		
			--Get Season and Year Names
			SELECT @SeasonName = [Season], @SeasonYear = [Year] FROM pSeasonYear 
			WHERE SeasonYearID = @SeasonYearID 
		
			--Get a total count of available temp material color
			SELECT @MaterialColorCount  = COUNT(*) FROM #tmpMaterialColor 
			SET @MaterialColorIndex = 1

			--Loop style material color to add season year
			WHILE @MaterialColorIndex <= @MaterialColorCount
			BEGIN
				SELECT @MC_MaterialID = MaterialID, @MC_MaterialColorID = MaterialColorID
				FROM #tmpMaterialColor  WHERE RowID = @MaterialColorIndex
					BEGIN
					IF (SELECT COUNT(*) FROM pMaterialColorSeasonYear 
							WHERE SeasonYearID = @SeasonYearID AND MaterialID = @MC_MaterialID 
							AND MaterialColorID = @MC_MaterialColorID) = 0				
						BEGIN	
							INSERT INTO pMaterialColorSeasonYear(SeasonYearID, MaterialID, MaterialColorID, MaterialSeason, MaterialYear, CUser, CDate)
							VALUES (@SeasonYearID, @MC_MaterialID, @MC_MaterialColorID, @SeasonName, @SeasonYear, 'SYSTEM_MC', GETDATE())  
						END
					END	
								
				SET @MaterialColorIndex = @MaterialColorIndex + 1 
			END
			
			--END Daniel Pak 2/13/2010  	
	END		
	
*/	

	BEGIN
		DROP TABLE #SCWsy	
		DROP TABLE #scwi
		DROP TABLE #scw 
		DROP TABLE #sm
--		DROP TABLE #tmpMaterialColor
		DROP TABLE #m_sy
		DROP TABLE #mc_sy
	END
		
	SET @ROWID = @ROWID + 1
END 

DROP TABLE #s


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanStyleHeaderFields_DataSource_Logic_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[spx_LinePlanStyleHeaderFields_DataSource_Logic_SELECT] (
@LinePlanItemID UNIQUEIDENTIFIER,
@FieldName NVARCHAR(200)
)
AS 

--****
--** BURBURY LOGIC  
--** Default StyleType, CustomField2 ONLY !! 
--****

DECLARE @LinePlanTemplateID UNIQUEIDENTIFIER 
DECLARE @VALUE1 NVARCHAR(200) -- CustomField2 (Division)
DECLARE @VALUE2 NVARCHAR(200) -- Styletype
DECLARE @VALUE3 NVARCHAR(200) -- StyleCategory

SELECT 
@LinePlanTemplateID  = d.LinePlanTemplateID, 
@VALUE1 = b.LinePlanAttributeText1, 
@VALUE2 = c2.LinePlanAttributeValue,
@VALUE3 = LOWER( CAST(e.StyleCategoryId AS nvarchar(40)) )
FROM pLinePlanItem a
INNER JOIN pLinePlanRange b ON a.LinePlanRangeID = b.LinePlanRangeID 
INNER JOIN pLinePlanAttributeItem c2 ON b.LinePlanAttributeItemID2 = c2.LinePlanAttributeItemID
INNER JOIN pLinePlanAttributeItem c3 ON b.LinePlanAttributeItemID3 = c3.LinePlanAttributeItemID
INNER JOIN pStyleCategory e ON e.StyleCategoryID = c3.LinePlanAttributeValue
INNER JOIN pLinePlan d ON a.LinePlanID = d.LinePlanID 
WHERE a.LinePlanItemID = @LinePlanItemID 

SET @FieldName = UPPER(@FieldName)

IF @FieldName = 'STYLETYPE'
BEGIN
	SELECT '' AS StyleTypeID, '' as StyleTypeDescription 
	UNION 
	SELECT CAST(StyleTypeID AS NVARCHAR(2)), StyleTypeDescription 
	FROM pStyleType 
	WHERE StyleTypeID = @VALUE2
END 
ELSE IF @FieldName = 'STYLECATEGORY'
BEGIN

	SELECT '' AS StyleCategoryId, '' as StyleCategory 
	UNION
	SELECT lower(CAST(StyleCategoryId AS NVARCHAR(40))) , StyleCategory 
	FROM pStyleCategory
	WHERE StyleCategoryId = @VALUE3

END






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_StyleMaterialSearchNew]'
GO
EXEC sp_refreshview N'[dbo].[vwx_StyleMaterialSearchNew]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rpx_Material_MaterialGroup_SELECT]'
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE PROCEDURE [dbo].[rpx_Material_MaterialGroup_SELECT]
(
	@MaterialCoreID NVARCHAR(50)
)

AS


--/************/
--/*Testing.	*/
--/************/
--DECLARE @MaterialCoreID UNIQUEIDENTIFIER
--SET @MaterialCoreID = '4680ce07-e4c7-4c83-8078-17377ddd697f'


/*Declare variables.*/
DECLARE @MaterialCount INT
DECLARE @ColorwayCount INT


/*Create temp table.*/
CREATE TABLE dbo.#temp_Main
	(
	TableRow int NOT NULL IDENTITY (0, 1)
	,Row INT
	,[Column] INT
	,FolderName NVARCHAR(100)
	,FolderDescription NVARCHAR(4000)
	,Active NVARCHAR(5)
	,MaterialCoreItemID UNIQUEIDENTIFIER
	,ImageFilePath NVARCHAR(255)
	,RecordCode NVARCHAR(50)
	,MaterialName NVARCHAR(200)
	,MaterialCode VARCHAR(50)
	,TreatmentSizeGuage NVARCHAR(100)
	,Qty NVARCHAR(18)
	,UOM NVARCHAR(50)
	,CLR INT
	,IMG INT
	,Placement NVARCHAR(4000)
	,MaterialCoreColorID UNIQUEIDENTIFIER
	,ColorwayName NVARCHAR(200)
	,MaterialCoreColorItemID UNIQUEIDENTIFIER
	,ColorChipName NVARCHAR(150)
	)  ON [PRIMARY]

ALTER TABLE dbo.#temp_Main ADD CONSTRAINT
	PK_#temp_Main PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/*Select items and put in temp table.*/
INSERT INTO #temp_Main
(
	FolderName
	,FolderDescription
	,Active
	,MaterialCoreItemID
	,ImageFilePath
	,RecordCode
	,MaterialName
	,MaterialCode
	,TreatmentSizeGuage
	,Qty
	,UOM
	,CLR
	,IMG
	,Placement
	,MaterialCoreColorID
	,ColorwayName
	,MaterialCoreColorItemID
	,ColorChipName
)
SELECT
	pMaterialCore.MaterialCoreName AS FolderName
	,pMaterialCore.MaterialCoreDescription AS FolderDescription
	,pMaterialCore.Active
	,pMaterialCoreItem.MaterialCoreItemID
	,dbo.fnx_GetStreamingImageSmallPath(pMaterial.MaterialImageID, pMaterial.MaterialImageVersion) AS ImageFilePath
	,pMaterial.MaterialNo AS RecordCode
	,pMaterial.MaterialName
	,pMaterial.MaterialCode
	,pMaterialCoreItem.MaterialSize AS TreatmentSizeGuage
	,pMaterialCoreItem.Qty
	,pMaterial.UOM
	,pMaterialCoreItem.Colorway AS CLR
	,pMaterialCoreItem.Artwork AS IMG
	,pMaterialCoreItem.Placement
	,pMaterialCoreColor.MaterialCoreColorID
	,pMaterialCoreColor.ColorName AS ColorwayName
	,pMaterialCoreColorItem.MaterialCoreColorItemID
	,pMaterialColor.ColorName AS ColorChipName
FROM pMaterialCore
	INNER JOIN pMaterialCoreItem ON	pMaterialCore.MaterialCoreID = pMaterialCoreItem.MaterialCoreID
	INNER JOIN pMaterial ON	pMaterialCoreItem.MaterialID = pMaterial.MaterialID
	INNER JOIN pMaterialCoreColor ON	pMaterialCore.MaterialCoreID = pMaterialCoreColor.MaterialCoreID
	INNER JOIN pMaterialCoreColorItem ON	pMaterialCoreItem.MaterialCoreItemID = pMaterialCoreColorItem.MaterialCoreItemID
											AND pMaterialCoreColor.MaterialCoreColorID = pMaterialCoreColorItem.MaterialCoreColorID
	LEFT OUTER JOIN pMaterialColor ON	pMaterialCoreColorItem.MaterialColorID = pMaterialColor.MaterialColorID
WHERE pMaterialCore.MaterialCoreID = @MaterialCoreID
ORDER BY pMaterial.MaterialName
	,pMaterialCoreColor.ColorName


/*Get the 'MaterialCoreItemID' values for row organizing.*/
SELECT
	IDENTITY(INT, 0, 1) AS TableRow
	,MaterialCoreItemID
	,MaterialName
INTO #temp_Materials
FROM #temp_Main
GROUP BY MaterialCoreItemID, MaterialName
ORDER BY MaterialName


/*Get the 'MaterialCoreItemID' values for row organizing.*/
SELECT
	IDENTITY(INT, 0, 1) AS TableRow
	,MaterialCoreColorID
	,ColorwayName
INTO #temp_Colorways
FROM #temp_Main
GROUP BY MaterialCoreColorID, ColorwayName
ORDER BY ColorwayName


/*Update main temp table with row and column values.*/
UPDATE #temp_Main
SET #temp_Main.Row = #temp_Materials.TableRow
	,#temp_Main.[Column] = #temp_Colorways.TableRow
FROM #temp_Main
	INNER JOIN #temp_Materials ON	#temp_Main.MaterialCoreItemID = #temp_Materials.MaterialCoreItemID
	INNER JOIN #temp_Colorways ON	#temp_Main.MaterialCoreColorID = #temp_Colorways.MaterialCoreColorID


/*Select records with row and column numbers.*/
SELECT
	Row
	,[Column]
	,FolderName
	,FolderDescription
	,Active
	,MaterialCoreItemID
	,ImageFilePath
	,RecordCode
	,MaterialName
	,MaterialCode
	,TreatmentSizeGuage
	,Qty
	,UOM
	,CLR
	,IMG
	,Placement
	,MaterialCoreColorID
	,ColorwayName
	,MaterialCoreColorItemID
	,ColorChipName
FROM #temp_Main


/*Drop temp table.*/
DROP TABLE #temp_Main
DROP TABLE #temp_Materials
DROP TABLE #temp_Colorways

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleNewSizeClassAndRange_UPDATE]'
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[spx_StyleNewSizeClassAndRange_UPDATE] (
@StyleID UNIQUEIDENTIFIER, 
@NewStyleID UNIQUEIDENTIFIER 

)
AS

	DECLARE @SizeRange VARCHAR(200), @SizeClass VARCHAR(200)
	SELECT @SizeClass = SizeClass, @SizeRange = SizeRange FROM pStyleHeader WHERE StyleID = @StyleId		

	BEGIN
		UPDATE pStyleHeader SET SizeClass = @SizeClass, SizeRange = @SizeRange WHERE StyleID = @NewStyleID
	END









GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_StyleSourcing_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_StyleSourcing_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcing_MostLikelyVendor_UPDATE]'
GO


ALTER PROCEDURE [dbo].[spx_StyleSourcing_MostLikelyVendor_UPDATE] (
@StyleSeasonYearID  UNIQUEIDENTIFIER,
@TradePartnerVendorID UNIQUEIDENTIFIER
)
AS

DECLARE @TradePartnerID UNIQUEIDENTIFIER

SELECT @TradePartnerID = TradePartnerID FROM uTradePartnerVendor 
WHERE TradePartnerVendorID = @TradePartnerVendorID

UPDATE pStyleSeasonYear 
SET MostLikelyVendor = 1 ,
TradePartnerVendorID = @TradePartnerVendorID  /***** CDP - Changed from TradePartnerVendorID = @TradePartnerID  ***/
WHERE StyleSeasonYearID = @StyleSeasonYearID









GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[fnx_NEWSEQUENTIALID]'
GO

CREATE FUNCTION [dbo].[fnx_NEWSEQUENTIALID](@SequentialNo int)
RETURNS uniqueidentifier
AS

BEGIN

	DECLARE @NEWSEQUENTIALID UNIQUEIDENTIFIER
	SET @NEWSEQUENTIALID = (SELECT SequentialId FROM sTempSequentialId Where SequentialNo = @SequentialNo)
	RETURN @NEWSEQUENTIALID

END

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleSizeClassNew_Colorways_DELETE]'
GO

CREATE PROCEDURE [dbo].[spx_StyleSizeClassNew_Colorways_DELETE](
@StyleID UNIQUEIDENTIFIER, 
@StyleColorwaySeasonYearID UNIQUEIDENTIFIER,
@CUser NVARCHAR(200), 
@CDate DATETIME 
)
AS 

DECLARE @ColorPaletteID UNIQUEIDENTIFIER
DECLARE @StyleColorID UNIQUEIDENTIFIER

SELECT @ColorPaletteID = b.ColorPaletteID
FROM pStyleColorwaySeasonYear a 
INNER JOIN pStyleColorway b ON a.StyleColorwayID  = b.StyleColorID
WHERE a.StyleColorwaySeasonYearID = @StyleColorwaySeasonYearID

IF @ColorPaletteID IS NOT NULL 
BEGIN 

	SELECT @StyleColorID = a.StyleColorID 
	FROM pStyleColorway a 
	WHERE a.StyleID = @StyleID 
	AND a.ColorPaletteID = @ColorPaletteID 
	
	IF @StyleColorID IS NOT NULL
	BEGIN
		DELETE FROM pStyleColorwayItem WHERE StyleColorID = @StyleColorID 
		DELETE FROM pStyleColorway WHERE StyleColorID = @StyleColorID 
		DELETE FROM pStyleColorwaySeasonYear WHERE StyleColorwayID = @StyleColorID 
	END 
	
END 






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanStyleHeaderFields_NewItem_Logic_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_LinePlanStyleHeaderFields_NewItem_Logic_SELECT] (
@LinePlanItemID UNIQUEIDENTIFIER 
)
AS 


--****
--** BURBURY LOGIC  
--** Default StyleType, CustomField2 ONLY !! 
--****


DECLARE @LinePlanTemplateID UNIQUEIDENTIFIER 
DECLARE @VALUE1 NVARCHAR(200) -- CustomField2 
DECLARE @VALUE2 NVARCHAR(200) -- Styletype


SELECT 
@LinePlanTemplateID  = d.LinePlanTemplateID, 
@VALUE1 = b.LinePlanAttributeText1, 
@VALUE2 = c2.LinePlanAttributeValue
FROM pLinePlanItem a
INNER JOIN pLinePlanRange b ON a.LinePlanRangeID = b.LinePlanRangeID 
INNER JOIN pLinePlanAttributeItem c2 ON b.LinePlanAttributeItemID2 = c2.LinePlanAttributeItemID
INNER JOIN pLinePlanAttributeItem c3 ON b.LinePlanAttributeItemID3 = c3.LinePlanAttributeItemID
INNER JOIN pStyleCategory e ON e.StyleCategoryID = c3.LinePlanAttributeValue
INNER JOIN pLinePlan d ON a.LinePlanID = d.LinePlanID 
WHERE a.LinePlanItemID = @LinePlanItemID 



CREATE TABLE #tmp ( 
RecID INT IDENTITY (1,1),
StyleHeaderField NVARCHAR(200),
DefaultValue NVARCHAR(200)
)

INSERT INTO #tmp ( StyleHeaderField ) 
SELECT TOP 2 c.StyleHeaderField 
FROM pLinePlanItem a
INNER JOIN pLinePlan b ON a.LinePlanID =  b.LinePlanID 
INNER JOIN pLinePlanTemplateItem c ON c.LinePlanTemplateID = b.LinePlanTemplateID 
WHERE a.LinePlanItemID = @LinePlanItemID 
AND c.Active = '1'
AND c.LinePlanTemplateID = @LinePlanTemplateID
ORDER BY CAST( c.LinePlanTemplateItemSort AS INT ) 


DECLARE @ROWID INT 
DECLARE @TOTAL INT 
DECLARE @VALUE NVARCHAR(200)


SET @ROWID =  1
SELECT @TOTAL = COUNT (*) FROM #tmp

WHILE @ROWID <= @TOTAL
BEGIN 

	SET @VALUE = NULL 
	
	IF @ROWID = 1			SET @VALUE  = @VALUE1
	ELSE IF @ROWID = 2		SET @VALUE  = @VALUE2

	IF @VALUE IS NOT NULL 
		UPDATE #tmp SET DefaultValue = @VALUE WHERE RecID = @ROWID 

	SET @ROWID = @ROWID  + 1
END 

SELECT  * FROM #tmp

DROP TABLE #tmp



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pSampleRequestGroupTemp]'
GO
ALTER TABLE [dbo].[pSampleRequestGroupTemp] ADD
[SeasonYearID] [uniqueidentifier] NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleMaterialSummary_Linked_UPDATE]'
GO
SET QUOTED_IDENTIFIER OFF
GO


/*
** Comment #02 
** Artemio Gomez - 3/25/2010 :  Remove Primary Key/Index in Temp table, It is causing problems
***
*/
CREATE PROCEDURE dbo.spx_StyleMaterialSummary_Linked_UPDATE
(
	@StyleMaterialID uniqueidentifier
	,@StyleID uniqueidentifier
	,@StyleSet int
	,@MUser nvarchar(200)
	,@MDate datetime
	,@SQLString varchar(8000)
)

AS


--Daniel Pak 04-14-10
--Comment #1
--Force selected BoM update and disable main material update
--because it will update from original request
BEGIN
	EXEC spx_StyleMaterialSummary_UPDATE
		 @StyleMaterialID
		,@StyleID
		,@StyleSet
		,@MUser
		,@MDate
		,@SqlString		
END



/************************/
/*Declare variables.	*/
/************************/
DECLARE @StyleMaterialID_Param UNIQUEIDENTIFIER		--Keep a copy of the original parameter value.
DECLARE @StyleID_Param UNIQUEIDENTIFIER				--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT							--Keep a copy of the original parameter value.

DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @MainMaterial_Previous INT

DECLARE @StyleMaterialLinkID UNIQUEIDENTIFIER			--To find the the same Material in the other Styles.

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleMaterialID_Param = @StyleMaterialID
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE #temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	,StyleMaterialID UNIQUEIDENTIFIER
	)  ON [PRIMARY]


/* Comment #02 
ALTER TABLE #temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
*/


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'MainMaterial' value for checking later on.*/
SELECT @MainMaterial_Previous = MainMaterial
FROM pStyleMaterials
WHERE StyleMaterialID = @StyleMaterialID_Param


/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000' OR @MainMaterial_Previous = 1)	--Style is not Multi-Cloth linked, or this is a Main Material.
	BEGIN
		/*Execute original procedure with original parameters.*/
		-- Daniel Pak 04-17-10
		--See Comment # 1
		--		EXEC spx_StyleMaterialSummary_UPDATE
		--			@StyleMaterialID_Param
		--			,@StyleID_Param
		--			,@StyleSet_Param
		--			,@MUser
		--			,@MDate
		--			,@SqlString
			
		SELECT 1	
			
	END
	
	
	
ELSE	--Style is Multi-Cloth linked and this is not a Main Material.
	BEGIN
		/*Clear variables.*/
		SET @StyleMaterialLinkID = NULL


		/*Get the 'StyleMaterialLinkID' value of the calling Style.*/
		SELECT @StyleMaterialLinkID = StyleMaterialLinkID
		FROM pStyleMaterials
		WHERE StyleMaterialID = @StyleMaterialID_Param


		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID


		/*Get and set the counts for the Multi-Cloth linked Styles.*/
		SELECT @TotalCount = COUNT(*) FROM #temp_Linked
		SET @RowCounter = 1


		/*Get the 'StyleMaterialID' of the Material for each of the Multi-Cloth linked Styles.*/
		WHILE(@RowCounter <= @TotalCount)
			BEGIN
				/*Clear variables.*/
				SET @StyleID = NULL
				SET @StyleSet = NULL
				SET @StyleMaterialID = NULL


				/*Get 'StyleID'.*/
				SELECT @StyleID = StyleID
					,@StyleSet = StyleSet
				FROM #temp_Linked
				WHERE TableRow = @RowCounter


				/*Get the 'StyleMaterialID'.*/
				SELECT @StyleMaterialID = StyleMaterialID
				FROM pStyleMaterials
				WHERE StyleID = @StyleID
					AND StyleSet = @StyleSet
					AND StyleMaterialLinkID = @StyleMaterialLinkID


				/*Update the temp table with the 'StyleMaterialID'.*/
				UPDATE #temp_Linked
				SET StyleMaterialID = @StyleMaterialID
				WHERE TableRow = @RowCounter


				/*Up row counter.*/
				SET @RowCounter = @RowCounter + 1
			END
	END


/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @StyleMaterialID = NULL
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Get the 'StyleID' for the update.*/
		SELECT @StyleMaterialID = StyleMaterialID
			,@StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter

		/*
			Replace SQL string with STYLEMATERIALID from temp table 
			Daniel Pak 2/13/2010
		*/
		DECLARE @TmpSQLString varchar(8000)
		SET @TmpSQLString = REPLACE(@SQLString, CAST(@StyleMaterialID_Param AS VARCHAR(40)), CAST(@StyleMaterialID AS VARCHAR(40)))	

		SELECT @TmpSQLString 

		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleMaterialSummary_UPDATE
			@StyleMaterialID
			,@StyleID
			,@StyleSet
			,@MUser
			,@MDate
			,@TmpSQLString

		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


--SELECT * FROM #temp_Linked


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_StyleMaterialBOM_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER VIEW [dbo].[vwx_StyleMaterialBOM_SELECT]
AS
SELECT DISTINCT 
                      dbo.pStyleMaterials.Artwork, dbo.pStyleMaterials.License, dbo.pStyleMaterials.Colorway, dbo.uTradePartnerVendor.VendorName, 
                      dbo.pStyleMaterials.StyleMaterialID, dbo.pStyleMaterials.StyleMaterialMasterID, dbo.pStyleMaterials.CopyStyleMaterialID, 
                      dbo.pStyleMaterials.MainMaterial, dbo.pStyleMaterials.Development, dbo.pStyleMaterials.MiscColor, dbo.pStyleMaterials.StyleSet, 
                      dbo.pStyleMaterials.StyleID, dbo.pStyleMaterials.UOM, dbo.pStyleMaterials.Qty, dbo.pStyleMaterials.MaterialPrice, dbo.pStyleMaterials.Ext, 
                      dbo.pStyleMaterials.MaterialSize, dbo.pStyleMaterials.MaterialID, dbo.pStyleMaterials.MaterialPlacement, 
                      dbo.pStyleMaterials.MaterialPlacementCode, dbo.pStyleMaterials.MaterialPlacementDetail, dbo.pStyleMaterials.MaterialImageID, 
                      dbo.pStyleMaterials.MaterialImageVersion, dbo.pStyleMaterials.NoColorMatch, dbo.pStyleMaterials.SupplierID, 
                      dbo.pStyleMaterials.ComponentTypeID, dbo.pStyleMaterials.MaterialType, dbo.pStyleMaterials.MaterialNo, dbo.pStyleMaterials.MaterialName, 
                      dbo.pStyleMaterials.A, dbo.pStyleMaterials.B, dbo.pStyleMaterials.C, dbo.pStyleMaterials.D, dbo.pStyleMaterials.E, dbo.pStyleMaterials.F, 
                      dbo.pStyleMaterials.G, dbo.pStyleMaterials.I, dbo.pStyleMaterials.H, dbo.pStyleMaterials.J, dbo.pStyleMaterials.K, dbo.pStyleMaterials.L, 
                      dbo.pStyleMaterials.M, dbo.pStyleMaterials.N, dbo.pStyleMaterials.O, dbo.pStyleMaterials.P, dbo.pStyleMaterials.Q, dbo.pStyleMaterials.R, 
                      dbo.pStyleMaterials.S, dbo.pStyleMaterials.T, dbo.pStyleMaterials.U, dbo.pStyleMaterials.V, dbo.pStyleMaterials.W, dbo.pStyleMaterials.X, 
                      dbo.pStyleMaterials.Y, dbo.pStyleMaterials.Z, dbo.pStyleMaterials.Source, dbo.pStyleMaterials.Notes, dbo.pStyleMaterials.Placement, 
                      dbo.pStyleMaterials.VendorPrice, dbo.pStyleMaterials.VolumePrice, dbo.pStyleMaterials.VolumePriceMinimum, 
                      dbo.pStyleMaterials.VendorProductionMin, dbo.pStyleMaterials.VendorProductionLeadTime, dbo.pStyleMaterials.DetailYesNo, 
                      dbo.pStyleMaterials.ImageType, dbo.pStyleMaterials.height, dbo.pStyleMaterials.width, dbo.pStyleMaterials.CDate, dbo.pStyleMaterials.CUser, 
                      dbo.pStyleMaterials.MDate, dbo.pStyleMaterials.MUser, dbo.pStyleMaterials.MChange, dbo.pStyleMaterials.SChange, dbo.pStyleMaterials.DChange, 
                      dbo.pStyleMaterials.CChange, dbo.pStyleMaterials.Action, dbo.pStyleMaterials.ColorPlacement, dbo.pStyleMaterials.MaterialSort, 
                      dbo.pStyleMaterials.MaterialTrack, dbo.pStyleMaterials.MaterialLinked, dbo.pStyleMaterials.MaterialDimension, dbo.pStyleMaterials.MaterialSizeA0, 
                      dbo.pStyleMaterials.MaterialSizeA1, dbo.pStyleMaterials.MaterialSizeA2, dbo.pStyleMaterials.MaterialSizeA3, dbo.pStyleMaterials.MaterialSizeA4, 
                      dbo.pStyleMaterials.MaterialSizeA5, dbo.pStyleMaterials.MaterialSizeA6, dbo.pStyleMaterials.MaterialSizeA7, dbo.pStyleMaterials.MaterialSizeA8, 
                      dbo.pStyleMaterials.MaterialSizeA9, dbo.pStyleMaterials.MaterialSizeA10, dbo.pStyleMaterials.MaterialSizeA11, dbo.pStyleMaterials.MaterialSizeA12, 
                      dbo.pStyleMaterials.MaterialSizeA13, dbo.pStyleMaterials.MaterialSizeA14, dbo.pStyleMaterials.MaterialSizeA15, 
                      dbo.pStyleMaterials.MaterialSizeA16, dbo.pStyleMaterials.MaterialSizeA17, dbo.pStyleMaterials.MaterialSizeA18, 
                      dbo.pStyleMaterials.MaterialSizeA19, dbo.pStyleMaterials.MaterialSizeB0, dbo.pStyleMaterials.MaterialSizeB1, dbo.pStyleMaterials.MaterialSizeB2, 
                      dbo.pStyleMaterials.MaterialSizeB3, dbo.pStyleMaterials.MaterialSizeB4, dbo.pStyleMaterials.MaterialSizeB5, dbo.pStyleMaterials.MaterialSizeB6, 
                      dbo.pStyleMaterials.MaterialSizeB7, dbo.pStyleMaterials.MaterialSizeB8, dbo.pStyleMaterials.MaterialSizeB9, dbo.pStyleMaterials.MaterialSizeB10, 
                      dbo.pStyleMaterials.MaterialSizeB11, dbo.pStyleMaterials.MaterialSizeB12, dbo.pStyleMaterials.MaterialSizeB13, 
                      dbo.pStyleMaterials.MaterialSizeB14, dbo.pStyleMaterials.MaterialSizeB15, dbo.pStyleMaterials.MaterialSizeB16, 
                      dbo.pStyleMaterials.MaterialSizeB18, dbo.pStyleMaterials.MaterialSizeB17, dbo.pStyleMaterials.MaterialSizeB19, dbo.pStyleMaterials.MaterialLining,
                       dbo.pStyleMaterials.MaterialSizeID, dbo.pStyleMaterials.MaterialPackLabelGroupID, dbo.pStyleMaterials.MaterialBOM, 
                      dbo.uTradePartnerVendor.TradePartnerID, dbo.pMaterial.MultiDimension, dbo.pComponentType.ComponentPackLabel,
                          (SELECT     COUNT(*) AS NoComments
                            FROM          dbo.pMaterialComment
                            WHERE      (MaterialID = dbo.pStyleMaterials.MaterialID)) AS NoComments, dbo.pMaterial.MaterialColorRequired, dbo.pMaterial.FactorySourced, 
                      dbo.pMaterial.MaterialCode
FROM         dbo.uTradePartnerVendor RIGHT OUTER JOIN
                      dbo.pStyleMaterials INNER JOIN
                      dbo.pMaterial ON dbo.pMaterial.MaterialID = dbo.pStyleMaterials.MaterialID INNER JOIN
                      dbo.pComponentType ON dbo.pStyleMaterials.MaterialType = dbo.pComponentType.ComponentTypeID ON 
                      dbo.uTradePartnerVendor.TradePartnerVendorID = dbo.pStyleMaterials.TradePartnerVendorID

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanShowroom_PIVOT]'
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE PROCEDURE [dbo].[spx_LinePlanShowroom_PIVOT] (
@LinePlanRangeID UNIQUEIDENTIFIER ,
@Filter NVARCHAR(4000)
)
AS



DECLARE @tableX  NVARCHAR(50)
DECLARE @tableTmp NVARCHAR(50)
DECLARE @tableName NVARCHAR(50)
DECLARE @Season NVARCHAR(50)
DECLARE @Year NVARCHAR(50)
DECLARE @DUMMY UNIQUEIDENTIFIER 

select  @Season = b.Season , @Year  = b.Year 
from pLinePlanRange  a
INNER JOIN pLinePlan b ON a.LinePlanID = b.LinePlanID  
WHERE LinePlanRangeID = @LinePlanRangeID


SET @tableX = '##' + REPLACE(CAST ( NEWID()AS NVARCHAR (50)), '-', '')
SET @tableTmp = '##' + REPLACE(CAST ( NEWID()AS NVARCHAR (50)), '-', '')
SET @tableName = '##' + REPLACE(CAST ( NEWID()AS NVARCHAR (50)), '-', '')
SET @DUMMY =  NULL



DECLARE @TMPSQL NVARCHAR(4000)

SET @TMPSQL = 'SELECT a.LinePlanRangeID, a.ShowroomID, a.Qty, a.StyleID, b.Custom as Showroom, a.StyleColorID, 
c.StyleNo, c.Description, d.StyleColorName, d.StyleColorNo, c.MaterialName,
''<img src="../System/Control/ColorStream.ashx?S=25&CFID='' + CAST(e.ColorFolderID AS VARCHAR(50)) + 
''&CPID='' + CAST(e.ColorPaletteID AS VARCHAR(50))      + ''  " > '' as ColorPath,
0 as Units, a.Price as Cost, 0 as TotalCost, a.TradePartnerVendorID,
''<img src=''''../System/Control/ImageStream.ashx?S=50&V='' + CAST(ISNULL(c.DesignSketchVersion, 0) AS NVARCHAR(50)) 
+ ''&IID='' + CAST(ISNULL(c.DesignSketchID, ''00000000-0000-0000-0000-000000000000'') AS NVARCHAR(50)) + ''''''  />'' AS StyleImagePath,
f.LinePlanStyleAttributeItemID

into ' +  @tableX + '
FROM pLinePlanShowroomStyleColor  a
INNER JOIN pShowroom b ON a.ShowroomID = b.CustomID 
INNER JOIN pStyleHeader c ON c.StyleID =  a.StyleID  
INNER JOIN pStyleColorway d ON d.StylecolorID = a.StylecolorID 
INNER JOIN pColorPalette e ON e.ColorPaletteID  = d.ColorPaletteID
INNER JOIN pLinePlanItem f ON f.StyleID = c.StyleID  AND f.LinePlanRangeID = a.LinePlanRangeID 
INNER JOIN pLinePlanShowroomItem m ON m.LinePlanRangeID = a.LinePlanRangeID AND m.ShowroomID = a.ShowroomID
WHERE a.LinePlanRangeID = ''' +  CAST( @LinePlanRangeID  AS NVARCHAR(50)) + '''  '



IF LEN (@Filter) > 0 
BEGIN
	SET @Filter  = REPLACE (@Filter, 'LinePlanRangeID'  , 'a.LinePlanRangeID' )
	SET @Filter  = REPLACE (@Filter, 'Description'  , 'c.Description' )
	SET @TMPSQL = @TMPSQL +  ' AND ' + @Filter
END 


PRINT @TMPSQL  
--PRINT ' '
--PRINT ' '

EXEC sp_executesql @TMPSQL 

SET @TMPSQL = '
SELECT  a.*, g.AttributeName,  h.MaterialCode 
INTO '  + @tableTmp  + '
FROM ' + @tableX  + ' a
LEFT OUTER JOIN pLinePlanStyleAttributeItem g ON g.LinePlanStyleAttributeItemID = a.LinePlanStyleAttributeItemID
LEFT OUTER JOIN pStyleMaterials i ON i.StyleID = a.StyleID AND i.MainMaterial = 1
LEFT OUTER JOIN pMaterial h ON h.MaterialID = i.MaterialID
'

EXEC sp_executesql @TMPSQL 
SET @TMPSQL = 'DROP TABLE ' + @tableX 


SET @TMPSQL = 'SELECT Qty, ShowroomID, StyleID, StyleColorID, StyleNo, Description, StyleColorName, StyleColorNo, MaterialCode, MaterialName, ColorPath,
Units, Cost, TotalCost, TradePartnerVendorID, StyleImagePath, LinePlanRangeID, AttributeName
FROM ' + @tableTmp

EXECUTE spx_Crosstab 
@DBFetch = @TMPSQL,
@DBWhere = NULL,
@DBPivot = NULL,
@DBField = 'ShowroomID',
@PCField = 'Qty',
@PCBuild = 'MAX',
@PCAdmin = NULL,
@DBAdmin = 0,
@DBTable = @tableName ,
@DBWrite = NULL,
@DBUltra = 0



SET @TMPSQL = 'DROP TABLE ' + @tableTmp 
EXEC sp_executesql @TMPSQL 


DECLARE @SQL AS NVARCHAR(300) 

set  @sql = 'ALTER TABLE ' +  @tableName  + ' ADD ROW_ID INT NOT NULL IDENTITY(1,1) ' 
--PRINT @sql 
EXEC sp_executesql @sql 


DECLARE @TOTAL INT
DECLARE @ROW_ID INT 
DECLARE @ParmDefinition nvarchar(500)
DECLARE @StyleID UNIQUEIDENTIFIER
DECLARE @StyleColorID UNIQUEIDENTIFIER
DECLARE @TradePartnerVendorID UNIQUEIDENTIFIER
DECLARE @UNITS INT
--DECLARE @Rate MONEY 
DECLARE @Cost MONEY 

SET @SQL = 'SELECT @pTOTAL = COUNT(*) FROM  ' + @tableName   
SET @ParmDefinition = '@pTotal INT OUTPUT'
EXECUTE sp_executesql @SQL, @ParmDefinition, @pTotal = @Total OUTPUT

SET @ROW_ID = 1



WHILE  @ROW_ID <= @Total 
BEGIN

	
		--set @Rate =  0 

		SET @SQL = 'SELECT @pStyleID  = StyleID, @pStyleColorID = StyleColorID, @pTradePartnerVendorID = TradePartnerVendorID, @pCost = Cost
		FROM ' + @tableName + '	WHERE ROW_ID = ' + Cast (@ROW_ID as NVARCHAR(5))
		SET @ParmDefinition = '@pStyleID UNIQUEIDENTIFIER OUTPUT, @pStyleColorID UNIQUEIDENTIFIER OUTPUT, @pTradePartnerVendorID UNIQUEIDENTIFIER OUTPUT, @pCost MONEY OUTPUT'
		EXECUTE sp_executesql @SQL, @ParmDefinition, @pStyleID = @StyleID OUTPUT, @pStyleColorID = @StyleColorID OUTPUT,  @pTradePartnerVendorID = @TradePartnerVendorID OUTPUT, @pCost = @Cost OUTPUT

		
		
		SELECT @UNITS = SUM (Qty)
		FROM  pLinePlanShowroomStyleColor a
		INNER JOIN pLinePlanShowroomItem b ON a.ShowroomID = b.ShowroomID AND a.LinePlanRangeID = b.LinePlanRangeID 
		INNER JOIN pShowroom c ON a.ShowroomID = c.CustomID
		WHERE a.StyleID = @StyleID AND a.StyleColorID =  @StyleColorID 
		AND a.LinePlanRangeID = @LinePlanRangeID 



		SET @SQL = 'UPDATE  ' + @tableName + ' SET  ' +  --Cost = ' + CAST (@Rate AS NVARCHAR(50)) +  ', ' +
		' Units = ' + CAST (@UNITS AS NVARCHAR(50))  +  ', ' +
		' TotalCost = '+  CAST ((@UNITS * ISNULL(@Cost,0) ) AS  NVARCHAR(50)) +
		' WHERE ROW_ID = ' + CAST (@ROW_ID AS NVARCHAR(50))
		
		EXECUTE sp_executesql @SQL
		
		SET @ROW_ID = @ROW_ID + 1

END 



set  @sql = 'SELECT * FROM  ' + @tableName  + ' ORDER BY StyleNo, Description, StyleColorName, CAST (StyleColorID AS NVARCHAR(50)) ; DROP TABLE ' + @tableName 
PRINT @sql 

EXEC sp_executesql @sql 


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcing_TechPack_COUNT_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [dbo].[spx_StyleSourcing_TechPack_COUNT_SELECT]  (
@StyleID UNIQUEIDENTIFIER  , 
@StyleSourcingID UNIQUEIDENTIFIER  
)
AS
BEGIN

	SELECT COUNT(*)  FROM pTechPack WITH (NOLOCK) WHERE StyleID = @StyleID AND StyleSourcingID = @StyleSourcingID 

END




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialRequestSubmitWorkflowGroup_INSERT]'
GO
CREATE PROCEDURE [dbo].[spx_MaterialRequestSubmitWorkflowGroup_INSERT]
(
@MaterialRequestWorkflowGroupID uniqueidentifier,
@MaterialRequestSubmitID uniqueidentifier,
@CUser nvarchar(200),
@CDate datetime
)
AS 

BEGIN
	DECLARE @MaterialRequestSubmitWorkflowID uniqueidentifier 
	SELECT @MaterialRequestSubmitWorkflowID = MaterialRequestSubmitWorkflowID FROM pMaterialRequestSubmit WHERE MaterialRequestSubmitID = @MaterialRequestSubmitID 
	UPDATE pMaterialRequestSubmitWorkflow SET 
		MaterialRequestWorkflowGroupID = @MaterialRequestWorkflowGroupID 
	WHERE MaterialRequestSubmitWorkflowID = @MaterialRequestSubmitWorkflowID
END

BEGIN
	INSERT INTO  pMaterialRequestSubmitItem (MaterialRequestSubmitID, MaterialRequestWorkflowItemID, MaterialRequestSubmitItemStatus, MaterialRequestSubmitItemCustom1, 
		MaterialRequestSubmitItemCustom2, MaterialRequestSubmitItemCustom3, MaterialRequestSubmitItemCustom4, MaterialRequestSubmitItemCustom5, 
		MaterialRequestSubmitItemCustom6, MaterialRequestSubmitItemCustom7, MaterialRequestSubmitItemCustom8, MaterialRequestSubmitItemCustom9, 
		MaterialRequestSubmitItemCustom10, MaterialRequestSubmitItemSort, CDate, CUser, MDate, MUser)
	SELECT  @MaterialRequestSubmitID, MaterialRequestWorkflowItemID, 0 AS MaterialRequestSubmitItemStatus, 
		MaterialRequestWorkflowItemCustom1, MaterialRequestWorkflowItemCustom2, MaterialRequestWorkflowItemCustom3, 
		MaterialRequestWorkflowItemCustom4, MaterialRequestWorkflowItemCustom5, MaterialRequestWorkflowItemCustom6, MaterialRequestWorkflowItemCustom7, 
		MaterialRequestWorkflowItemCustom8, MaterialRequestWorkflowItemCustom9, MaterialRequestWorkflowItemCustom10, MaterialRequestWorkflowItemSort,
		@CDate AS CDate, @CUser AS CUser, @CDate AS MDate, @CUser AS MUser
	FROM  pMaterialRequestWorkflowItem (NOLOCK)
	WHERE MaterialRequestWorkflowGroupID = @MaterialRequestWorkflowGroupID
END










GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleColorway_DatagridHeaderLogic_SELECT]'
GO


CREATE PROCEDURE [dbo].[spx_StyleColorway_DatagridHeaderLogic_SELECT] (
@StyleColorID UNIQUEIDENTIFIER, 
@SeasonYearID UNIQUEIDENTIFIER = NULL 
)
AS

DECLARE @ColorName NVARCHAR(200)
DECLARE @SAPCode  NVARCHAR(200)
DECLARE @PLMCode NVARCHAR(200)
DECLARE @Header  NVARCHAR(800)

SELECT @ColorName = ISNULL(b.ColorName,''), @SAPCode = ISNULL(a.SAPCode,''), @PLMCode = ISNULL(a.PLMCode,'')
FROM pStyleColorway a
INNER JOIN pColorPalette b ON a.ColorPaletteID = b.ColorPaletteID
WHERE StyleColorID = @StyleColorID 



SET @Header = '<span>Style Combo: ' + @ColorName + '<br/>SAP Code: ' + @SAPCode + '<br/>PLM Code: ' + @PLMCode

IF @SeasonYearID IS NOT NULL 
BEGIN

	DECLARE @Status NVARCHAR(100)
	
	SELECT @Status = ISNULL(c.Status, '')
	FROM pStyleColorwaySeasonYear a
	INNER JOIN pStyleSeasonYear  b ON a.StyleSeasonYearID = b.StyleSeasonYearID 
	INNER JOIN pStyleColorwayStatus c ON c.StatusID = a.StyleColorStatus 
	WHERE a.StyleColorwayID = @StyleColorID  
	AND b.SeasonYearID = @SeasonYearID
	
	SET @Header = @Header + '<br/>Prod Status: ' + @Status

END 
SET @Header = @Header + '</span>'

SELECT @Header AS ColorwayHeader

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanStyleNewLogic_UPDATE]'
GO


/* #01 - Clay Parker - Oct 1 2009
The field Division was not updating from the LinePlan onto the style header of the style. 

   #02 - Clay Parker - Nov 19 2009
Commented out the Delete Costing/Quote information from the style. This was procedure is also being used for Carry Over style
creation. If you carry a style over it deletes the previous costing information from pstyle header and the quotes. Big Big Issue.

	#03 - Clay Parker Nov 23 2009
Commented out StyleCostingCustomField1 from being updated when a style is created. This price should now come from the price grid.
	#04 - Clay Parker Feb 1 2010
Modified the statement to select the development status instead of concept. 0 to 1.
*/



ALTER PROCEDURE [dbo].[spx_LinePlanStyleNewLogic_UPDATE]
(
@LinePlanRangeTypeID uniqueidentifier,
@LinePlanRangeID uniqueidentifier,
@LinePlanItemID uniqueidentifier,
@LinePlanID uniqueidentifier,
@StyleID uniqueidentifier,
@MUser NVARCHAR(200), 
@MDate DATETIME, 
@StyleSeasonYearID UNIQUEIDENTIFIER 
)
AS

UPDATE pLinePlanItem SET 
	LinePlanRangeTypeID = @LinePlanRangeTypeID,
	StyleID = @StyleID,
	MDate = @MDate,
	MUser = @MUser
WHERE LinePlanItemID = @LinePlanItemID 


---- DELETE ALL COSTING /QUOTES 
--DELETE FROM pStylecosting WHERE StyleID = @StyleID   --Comment #02
--DELETE FROM pStylecostingHeader WHERE StyleID = @StyleID	--Comment #02
--DELETE FROM pStyleQuoteItem WHERE StyleID = @StyleID	--Comment #02



DECLARE @StyleSeason VARCHAR(50)
DECLARE @StyleYear VARCHAR(50)
DECLARE @LinePlanAttributeItemId1 VARCHAR(50)
DECLARE @LinePlanAttributeItemId2 VARCHAR(50)
DECLARE @LinePlanAttributeItemId3 VARCHAR(50)
DECLARE @LinePlanAttributeItemId4 VARCHAR(50)
DECLARE @Division NVARCHAR(200) -- #01

-- Start #01 
Select @Division = b.LinePlanAttributeText1 
from pLinePlanItem a
INNER JOIN pLinePlanRange b ON a.LinePlanRangeID = b.LinePlanRangeID
Where LinePlanItemId= @LinePlanItemID
AND b.LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'

UPDATE pStyleHeader
Set CustomField2 = @Division
Where StyleID = @StyleID


-- End #01


--SELECT * FROM pLinePlanAttributeItem WHERE LinePlanAttributeItemId = @LinePlanAttributeItemId1
--SELECT * FROM pLinePlanAttributeItem WHERE LinePlanAttributeItemId = @LinePlanAttributeItemId2
--SELECT * FROM pLinePlanAttributeItem WHERE LinePlanAttributeItemId = @LinePlanAttributeItemId3
--SELECT * FROM pLinePlanAttributeItem WHERE LinePlanAttributeItemId = @LinePlanAttributeItemId4


SELECT  
	@LinePlanAttributeItemId1 = LinePlanAttributeItemId1,
	@LinePlanAttributeItemId2 = LinePlanAttributeItemId2,
	@LinePlanAttributeItemId3 = LinePlanAttributeItemId3,
	@LinePlanAttributeItemId4 = LinePlanAttributeItemId4
FROM pLinePlanRange WHERE LinePlanRangeId = @LinePlanRangeId



SELECT 
	@StyleSeason = Season, 
	@StyleYear = [Year] 
FROM pLinePlan WHERE LinePlanID = @LinePlanID

DECLARE @StyleTypeID INT --BRAND
SELECT @StyleTypeID = StyleTypeID FROM fnx_LinePlanStyleType(@LinePlanRangeID)

DECLARE @StyleCategoryID UNIQUEIDENTIFIER
SELECT @StyleCategoryID = StyleCategoryID FROM fnx_LinePlanStyleCategory(@LinePlanRangeID)

DECLARE @StyleDivision VARCHAR(200)
SELECT @StyleDivision = StyleDivision FROM fnx_LinePlanStyleDivision(@LinePlanRangeID)


DECLARE @PL1_NoOfStyle INTEGER
DECLARE @PL1_NoOfFabric INTEGER
DECLARE @PL1_NoOfBody INTEGER 
DECLARE @PL1_NoOfColor INTEGER
DECLARE @PL1_NoOfOptions INTEGER
DECLARE @PL1_MarkupFactor DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetalPriceHigh DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleLow DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleMed DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @PL1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @PL1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @PL1_SalesUnit DECIMAL(18, 3)
DECLARE @PL1_ProjectedWhs DECIMAL(18, 3)
--DECLARE @PL1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL1_WeightGrossMarginRtl DECIMAL(18, 3)

/*
SELECT TOP 1 
	@PL1_InitialGrossMarginRtl = LinePlanBusPnCh1
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000010'
*/

SELECT TOP 1 
	@PL1_TargetAvgRetailPriceMed = LinePlanBusPnCh1
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000022'

SELECT TOP 1  
	@PL1_MarkupFactor = LinePlanBusPnCh1 
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000005'


--GET Average Target FOB 
SELECT TOP 1  
	@PL1_AvgTargetFOB = LinePlanBusPnCh1 
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000006'


--Calculate Average Target FOB 
--SET @PL1_AvgTargetFOB = (@PL1_TargetAvgRetailPriceMed - (@PL1_TargetAvgRetailPriceMed * @PL1_InitialGrossMarginRtl)) 

--StyleCostingCustomField1 = Target Retail GBP = Manual Input
--StyleCostingCustomField2 = Target First Cost = Average Target FOB
--StyleCostingCustomField3 = Margin Markup = (StyleCostingCustomField1-StyleCostingCustomField2)/StyleCostingCustomField1
--StyleCostingCustomField4 = Units =Manual Input
--StyleCostingCustomField5 = Wholesale Margin = StyleCostingCustomField6-StyleCostingCustomField2/StyleCostingCustomField6
--StyleCostingCustomField6 = Target Wholesale Price = StyleCostingCustomField1/MarkupFactor

DECLARE @StyleCostingCustomField1 DECIMAL(18,3)
DECLARE @StyleCostingCustomField2 DECIMAL(18,3)
DECLARE @StyleCostingCustomField3 DECIMAL(18,3)
DECLARE @StyleCostingCustomField4 DECIMAL(18,3)
DECLARE @StyleCostingCustomField5 DECIMAL(18,3)
DECLARE @StyleCostingCustomField6 DECIMAL(18,3)

--SET @StyleCostingCustomField1 = @PL1_TargetAvgRetailPriceMed -- #03
SET @StyleCostingCustomField2 = @PL1_AvgTargetFOB  
SET @StyleCostingCustomField3 = CASE WHEN @StyleCostingCustomField1 = 0 THEN 0 ELSE (@StyleCostingCustomField1-@StyleCostingCustomField2)/@StyleCostingCustomField1 END
SET @StyleCostingCustomField4 = 0
SET @StyleCostingCustomField6 = CASE WHEN @PL1_MarkupFactor = 0 THEN 0 ELSE @StyleCostingCustomField1/@PL1_MarkupFactor END
SET @StyleCostingCustomField5 = CASE WHEN @StyleCostingCustomField6 = 0 THEN 0 ELSE (@StyleCostingCustomField6-@StyleCostingCustomField2)/@StyleCostingCustomField6 END

IF (SELECT COUNT(*) FROM pStyleCostingHeader WHERE StyleID = @StyleID AND StyleSeasonYearID = @StyleSeasonYearID) = 0
BEGIN
	INSERT INTO dbo.pStyleCostingHeader (StyleID, StyleCostingCustomField1, 
		StyleCostingCustomField2, StyleCostingCustomField3, StyleCostingCustomField4, 
		StyleCostingCustomField5, StyleCostingCustomField6, CUser, MUser, CDate, MDate , StyleSeasonYearID) 
     VALUES  (@StyleID, @StyleCostingCustomField1, @StyleCostingCustomField2, @StyleCostingCustomField3, 
			  @StyleCostingCustomField4, @StyleCostingCustomField5, @StyleCostingCustomField6, 
				@MUser, @MUser, @MDate, @MDate , @StyleSeasonYearID)


	INSERT INTO pStyleCosting(StyleID, StyleCostingTypeID, StyleCostingFreightTypeID, StyleQuotaDutyID, StyleCostingDate, 
	StyleCostingStatus, CUser, CDate, MUser, MDate, Active, StyleSeasonYearID)
	SELECT @StyleID, StyleCostingTypeID, 1, '00000000-0000-0000-0000-000000000000', @MDate, 
	0, @MUser, @MDate, @MUser, @MDate, 1, @StyleSeasonYearID AS StyleSeasonYearID
	FROM pStyleCostingType WHERE Active = 1

END

/***
** Copy MostLikely vendor sourcing data 
***/
DECLARE @StyleSYID UNIQUEIDENTIFIER 
DECLARE @TPVID UNIQUEIDENTIFIER 
DECLARE @SYID UNIQUEIDENTIFIER 

SELECT TOP 1 @StyleSYID  = a.StyleSeasonYearID,  @TPVID  = a.TradePartnerVendorID , @SYID = a.SeasonYearID
FROM pStyleSeasonYear a
INNER JOIN uTradePartnerVendor b ON a.TradepartnerVendorID =  b.TradepartnerVendorID 
WHERE a.StyleID = @StyleID 
AND a.MostLikelyVendor = 1 
ORDER BY a.CDate DESC 

IF  @StyleSYID  IS NOT NULL AND @TPVID  IS NOT NULL AND @SYID IS NOT NULL 
BEGIN 

	DECLARE @StyleSourcingID UNIQUEIDENTIFIER 
	DECLARE @NewSSID UNIQUEIDENTIFIER 
	
	SET @NewSSID = NEWID()
	
	SELECT TOP 1 @StyleSourcingID  = StyleSourcingID  
	FROM pStyleSourcing WHERE StyleID = @StyleID 
	AND TradePartnerVendorID  = @TPVID  
	AND StyleSeasonYearID = @StyleSYID


	/*** 
	** Copy Sourcing and sourcing items 
	***/
	INSERT INTO pStyleSourcing ( StyleSourcingID , StyleID , SourcingName, CDate, CUser, MDate, MUser, 
	Custom1, Custom2, Active, TradePartnerID , TradePartnerVendorID ,StyleSeasonYearID  ) 
	SELECT TOP 1 @NewSSID AS StyleSourcingID , StyleID , SourcingName, @MDate, @MUser, @MDate, @MUser, 
	Custom1, Custom2, Active, TradePartnerID , TradePartnerVendorID , @StyleSeasonYearID 
	FROM pStyleSourcing 
	WHERE StyleSourcingID =  @StyleSourcingID 

	
	INSERT INTO pStyleSourcingItem (StyleSourcingItemID, StyleSourcingID , CDate, CUser, MDate, MUser, StyleMaterialID, 
	StyleColorID,  StyleSet, BOM, CustomField1 ) 
	SELECT NEWID() AS StyleSourcingItemID, @NewSSID AS StyleSourcingID , @MDate, @MUser, @MDate, @MUser, StyleMaterialID, 
	StyleColorID,  StyleSet, BOM, CustomField1 
	FROM pStyleSourcingItem  WHERE StyleSourcingID = @StyleSourcingID 
	AND  StyleColorID IN ( 
		SELECT StyleColorwayID  FROM pStyleColorwaySeasonYear 
		WHERE StyleID = @StyleID  
		AND StyleSeasonyearID = @StyleSeasonYearID
	)

	/***
	** Update Mostlikely vendor in StyleSeasonyear table 
	**/	
	UPDATE pStyleSeasonYear	SET TradePartnerVendorID  = @TPVID,
	MostLikelyVendor = 1 
	WHERE StyleSeasonyearID = @StyleSeasonyearID 
	
END 


--***
--** Burberry Logic 
--***

IF @LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' 
BEGIN
	--***
	--** Define Style workflowtemplate items
	--***
	
	DECLARE @WorkflowTemplateID UNIQUEIDENTIFIER 
	SET @WorkflowTemplateID  = NULL 

	IF @StyleTypeID = 34 OR @StyleTypeID = 36 OR @StyleTypeID = 38 OR @StyleTypeID = 40 OR @StyleTypeID = 42 OR @StyleTypeID = 44
	BEGIN 
		--***
		--** Mens / Womens
		--***	
		SET @WorkflowTemplateID = '7CBDDD58-B08E-4723-9477-C9E791CDF36E'
	END 
	ELSE IF @StyleTypeID = 18 OR @StyleTypeID = 20 OR @StyleTypeID = 22 OR @StyleTypeID = 23 OR @StyleTypeID = 26 OR @StyleTypeID = 30
	BEGIN 
		--***
		--** Non-Apparel
		--***		
		SET @WorkflowTemplateID = 'FA6CFCB1-08E0-46C2-827F-9F481B950613'
	END 
	ELSE
	BEGIN
		--***
		--** LinePlan Template
		--***			
		SET @WorkflowTemplateID = '10000000-1000-1000-1000-100000000000'
	END 
	

		
	--IF  ( SELECT COUNT(*) FROM pStyleHeader WHERE StyleID = @StyleID AND StyleType IN ( 34,36,38,40,42,44)  ) > 0 
	BEGIN 
		
		
		--***
		--** Update Style workflows, copy items from Template 
		--***
		DELETE FROM pStyleWorkflow  WHERE  StyleID = @StyleID 

		CREATE TABLE #pWorkflowTemplateItem  (
			RowID INT IDENTITY (1,1) , 
			WorkflowID UNIQUEIDENTIFIER ,
			WorkflowSort NVARCHAR(2) ,
			WorkflowDays INT, 
			WorkflowAssignedTo INT 
		)

		INSERT INTO #pWorkflowTemplateItem  (WorkflowID, WorkflowSort, WorkflowDays,WorkflowAssignedTo) 
		SELECT WorkflowID, WorkflowSort, WorkflowDays,WorkflowAssignedTo
		FROM pWorkflowTemplateItem 
		WHERE WorkflowTemplateID = @WorkflowTemplateID

		DECLARE @WorkflowID UNIQUEIDENTIFIER  
		DECLARE @WorkflowSort NVARCHAR(2)
		DECLARE @WorkflowDays INT 
		DECLARE @WorkflowAssignedTo INT 

		DECLARE @TOTAL INT
		DECLARE @ROW_ID INT 
		SELECT @TOTAL = COUNT(*) FROM #pWorkflowTemplateItem 
		SET @ROW_ID = 1 

		DECLARE @intWorkflowDays INT 
		DECLARE @WorkDue DATETIME 

		WHILE @ROW_ID <= @TOTAL 
		BEGIN 
			SET @intWorkflowDays = 0 
			
			SELECT @WorkflowID = WorkflowID, @WorkflowSort = WorkflowSort, 
			@WorkflowDays = ISNULL(WorkflowDays,0) , @WorkflowAssignedTo = WorkflowAssignedTo
			FROM #pWorkflowTemplateItem WHERE RowID = @ROW_ID
				
			IF @WorkflowDays > 0
				SET @intWorkflowDays = @WorkflowDays * (-1)
			
			SET @WorkDue = DATEADD(DAY, @intWorkflowDays, @MDate) 
			
			EXEC  spx_StyleWorkflow_INSERT 
			@StyleID = @StyleID,
			@StyleSet = 1 ,
			@WorkflowID = @WorkflowID,
			@WorkflowType = '',
			@WorkDate = @MDate,
			@WorkStart = @MDate,
			@WorkDue = @WorkDue,
			@WorkAssignedTo = @WorkflowAssignedTo,
			@WorkStatus = 6 ,
			@WorkSort = @WorkflowSort,
			@WorkVersion = '',
			@WorkComments = '',
			@UserName = @MUser ,
			@UserDate =@MDate ,
			@WorkDay = @WorkflowDays
					
			SET  @ROW_ID = @ROW_ID + 1 
			
		END		

		EXEC spx_StyleWorkflowSchedule_UPDATE
		@StyleId = @StyleID , 
		@WorkflowTemplateId = @WorkflowTemplateID,
		@DueDate = @MDate,
		@StyleStatusId = 1,		--Comment #04
		@ModifiedBy = @MUser,
		@ModifiedDate = @MDate
	
	END 
END 


















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanStyleHeaderFields_Logic_SELECT]'
GO
SET QUOTED_IDENTIFIER OFF
GO

/*
--***
--** Comment#01 - Artemio Gomez - 3/26/2010
--** Add and extra paramenter to the stored procedure to define if this SP is executed from a page when trying to do a copy style search
--** Default value will be "0", This in case a client wants or not to filter or Loock the hearchy fields.
--***
*/
CREATE PROCEDURE [dbo].[spx_LinePlanStyleHeaderFields_Logic_SELECT] (
@LinePlanItemID UNIQUEIDENTIFIER ,
@StyleCopy INT   = 0  -- Comment#01 
) 
AS 



CREATE TABLE #tmp ( 
RecID INT IDENTITY (1,1),
StyleHeaderField NVARCHAR(200),
DefaultValue NVARCHAR(200),
SetDefault INT DEFAULT 1 
)


IF @StyleCopy = 0 
BEGIN 

	DECLARE @LinePlanTemplateID UNIQUEIDENTIFIER 
	DECLARE @VALUE1 NVARCHAR(200) -- CustomField2 
	DECLARE @VALUE2 NVARCHAR(200) -- Styletype
	DECLARE @VALUE3 NVARCHAR(200) -- StyleCategory

	SELECT 
	@LinePlanTemplateID  = d.LinePlanTemplateID, 
	@VALUE1 = b.LinePlanAttributeText1, 
	@VALUE2 = c2.LinePlanAttributeValue,
	@VALUE3 = LOWER( CAST(e.StyleCategoryId AS nvarchar(40)) )
	FROM pLinePlanItem a
	INNER JOIN pLinePlanRange b ON a.LinePlanRangeID = b.LinePlanRangeID 
	INNER JOIN pLinePlanAttributeItem c2 ON b.LinePlanAttributeItemID2 = c2.LinePlanAttributeItemID
	INNER JOIN pLinePlanAttributeItem c3 ON b.LinePlanAttributeItemID3 = c3.LinePlanAttributeItemID
	INNER JOIN pStyleCategory e ON e.StyleCategoryID = c3.LinePlanAttributeValue
	INNER JOIN pLinePlan d ON a.LinePlanID = d.LinePlanID 
	WHERE a.LinePlanItemID = @LinePlanItemID 

	INSERT INTO #tmp ( StyleHeaderField ) 
	SELECT c.StyleHeaderField 
	FROM pLinePlanItem a
	INNER JOIN pLinePlan b ON a.LinePlanID =  b.LinePlanID 
	INNER JOIN pLinePlanTemplateItem c ON c.LinePlanTemplateID = b.LinePlanTemplateID 
	WHERE a.LinePlanItemID = @LinePlanItemID 
	AND c.Active = '1'
	AND c.LinePlanTemplateID = @LinePlanTemplateID
	ORDER BY CAST( c.LinePlanTemplateItemSort AS INT ) 

	DECLARE @ROWID INT 
	DECLARE @TOTAL INT 
	DECLARE @VALUE NVARCHAR(200)

	SET @ROWID =  1
	SELECT @TOTAL = COUNT (*) FROM #tmp

	WHILE @ROWID <= @TOTAL
	BEGIN 

		SET @VALUE = NULL 
		
		IF @ROWID = 1			SET @VALUE  = @VALUE1
		ELSE IF @ROWID = 2		SET @VALUE  = @VALUE2
		ELSE IF @ROWID = 3 		SET @VALUE  = @VALUE3
		
		
		IF @VALUE IS NOT NULL
		BEGIN  
			IF @ROWID = 3 
				UPDATE #tmp SET DefaultValue = @VALUE, SetDefault = 0  WHERE RecID = @ROWID 
			ELSE 
				UPDATE #tmp SET DefaultValue = @VALUE WHERE RecID = @ROWID 
		END 

		SET @ROWID = @ROWID  + 1
	END 

END 

SELECT  * FROM #tmp

DROP TABLE #tmp

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcing_TechPack_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [dbo].[spx_StyleSourcing_TechPack_SELECT]  (
@StyleID UNIQUEIDENTIFIER  , 
@StyleSourcingID UNIQUEIDENTIFIER  
)
AS
BEGIN


SELECT    
CASE 
	WHEN a.TechPackID = b.TechPackId  THEN	
		CASE 
			WHEN a.StyleVersion = b.Change  THEN '../System/Icons/icon_packageok.gif'
			ELSE '../System/Icons/icon_packagefail.gif'
		END
	ELSE 
		CASE 
			WHEN a.StyleVersion = b.Change  THEN '../System/Icons/icon_packageok.gif'
			ELSE 	'../System/Icons/icon_packagefail.gif'
		END 
END AS ImagePath  ,
a.TechPackID, a.TechPackNo, a.TechPackStatus, a.TechPackName, a.StyleID, 
a.CDate, a.CUser, b.TechPackId AS FinalTechPackId, a.Notes,
b.TechPackDate AS FinalTechPackDate, a.StyleVersion AS TechPackStyleVersion, b.Change AS StyleVersion, 
a.TechPackRelease
FROM dbo.pTechPack a WITH (NOLOCK) INNER JOIN dbo.pStyleHeader b WITH (NOLOCK) ON a.StyleID = b.StyleID
WHERE a.StyleID = @StyleId 
AND a.StyleSourcingID = @StyleSourcingID 
ORDER BY a.TechPackNo DESC


END





set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlan_Item_Header_SELECT]'
GO


ALTER PROCEDURE [dbo].[spx_LinePlan_Item_Header_SELECT]
(@StyleID uniqueidentifier)
AS 


SELECT  * FROM pLinePlanItem WITH (NOLOCK) WHERE StyleID = @StyleID 



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[ColorType]'
GO
ALTER TABLE [dbo].[ColorType] ADD
[ColorTypeName] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CorpColor] [int] NOT NULL CONSTRAINT [DF_ColorType_CorpColor] DEFAULT ((0))
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_ColorLibraryLogic_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_ColorLibraryLogic_SELECT] (
@ColorFolderID UNIQUEIDENTIFIER
)
AS
	DECLARE @CorpColor INT 

	SELECT @CorpColor = b.CorpColor
	FROM pColorFolder a
	INNER JOIN pColorType b ON a.ColorTypeID = b.ColorTypeID
	WHERE ColorFolderID  = @ColorFolderID 

		
	IF @CorpColor  = 0
	BEGIN
		SELECT * from  ColorType WHERE Active = 1		
	END
	ELSE
	BEGIN
		SELECT * from  ColorType WHERE CorpColor = 0 AND Active = 1		
	END 


/*
	IF  @ColorFolderID = '00000000-0000-0000-0000-000000000001'
	BEGIN 
		SELECT * from  ColorType 
		WHERE ColorLibraryTypeID <>  '00000000-0000-0000-0000-000000000001'
		AND Active = 1
	END
	ELSE
	BEGIN
		SELECT * from  ColorType 
		WHERE Active = 1
	END 
*/




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[sSystemPageStrings]'
GO
CREATE TABLE [dbo].[sSystemPageStrings]
(
[sSystemPageString] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_sSystemPageStrings_sSystemPageString] DEFAULT (newid()),
[FormName] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[SystemStringID] [uniqueidentifier] NULL,
[CDate] [datetime] NULL CONSTRAINT [DF_sSystemPageStrings_CDate] DEFAULT (getdate()),
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_sSystemPageStrings] on [dbo].[sSystemPageStrings]'
GO
ALTER TABLE [dbo].[sSystemPageStrings] ADD CONSTRAINT [PK_sSystemPageStrings] PRIMARY KEY CLUSTERED  ([sSystemPageString])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[sSystemStrings]'
GO
CREATE TABLE [dbo].[sSystemStrings]
(
[SystemStringID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_sSystemStrings_SystemStringID] DEFAULT (newsequentialid()),
[DesignString] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[da_DK] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[de_DE] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[en_US] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[en_GB] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[en_CA] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[fr_FR] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[fr_CA] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[es_ES] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[es_MX] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[hi_IN] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[it_IT] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ja_JA] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ko_KR] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[nl_NL] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[pl_PL] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[pt_PT] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[pt_BR] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ru_RU] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[sv_FI] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[sv_SE] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[tr_TR] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[zh_CHS] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[zh_CHT] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL CONSTRAINT [DF_sSystemStrings_CDate] DEFAULT (getdate()),
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_sSystemStrings] on [dbo].[sSystemStrings]'
GO
ALTER TABLE [dbo].[sSystemStrings] ADD CONSTRAINT [PK_sSystemStrings] PRIMARY KEY CLUSTERED  ([SystemStringID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[sUserXMLStrings]'
GO
CREATE TABLE [dbo].[sUserXMLStrings]
(
[UserXMLStringID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_sUserXMLStrings_UserXMLStringID] DEFAULT (newsequentialid()),
[XMLName] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[UserStringID] [uniqueidentifier] NULL,
[CDate] [datetime] NULL CONSTRAINT [DF_sUserXMLStrings_CDate] DEFAULT (getdate()),
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_sUserXMLStrings] on [dbo].[sUserXMLStrings]'
GO
ALTER TABLE [dbo].[sUserXMLStrings] ADD CONSTRAINT [PK_sUserXMLStrings] PRIMARY KEY CLUSTERED  ([UserXMLStringID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[sUserStrings]'
GO
CREATE TABLE [dbo].[sUserStrings]
(
[UserStringID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_sUserStrings_UserStringID] DEFAULT (newsequentialid()),
[DesignString] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[da_DK] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[de_DE] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[en_US] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[en_GB] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[en_CA] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[fr_FR] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[fr_CA] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[es_ES] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[es_MX] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[hi_IN] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[it_IT] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ja_JA] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ko_KR] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[nl_NL] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[pl_PL] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[pt_PT] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[pt_BR] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ru_RU] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[sv_FI] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[sv_SE] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[tr_TR] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[zh_CHS] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[zh_CHT] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL CONSTRAINT [DF_sUserStrings_CDate] DEFAULT (getdate()),
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_sUserStrings] on [dbo].[sUserStrings]'
GO
ALTER TABLE [dbo].[sUserStrings] ADD CONSTRAINT [PK_sUserStrings] PRIMARY KEY CLUSTERED  ([UserStringID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleMaterialLink_SeasonYear_INSERT]'
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE PROCEDURE [dbo].[spx_StyleMaterialLink_SeasonYear_INSERT](
@StyleID UNIQUEIDENTIFIER,
@NewStyleID UNIQUEIDENTIFIER,
@SeasonYearID UNIQUEIDENTIFIER,
@CUser NVARCHAR(200),
@CDate DATETIME
)
AS

DECLARE @NewStyleSeasonYearID UNIQUEIDENTIFIER 
DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER 

SELECT @NewStyleSeasonYearID = StyleSeasonYearID FROM pStyleSeasonYear WHERE StyleID = @NewStyleID AND SeasonYearID = @SeasonYearID 
SELECT @StyleSeasonYearID = StyleSeasonYearID FROM pStyleSeasonYear WHERE StyleID = @StyleID AND SeasonYearID = @SeasonYearID 

IF @NewStyleSeasonYearID IS NULL 
	RETURN ;
	
CREATE TABLE [dbo].[#tempStyleMaterials] (
	[RecID] int IDENTITY(1,1)  NOT NULL,
	[StyleMaterialID]  uniqueidentifier ROWGUIDCOL  NOT NULL ,
	[StyleMaterialMasterID] [uniqueidentifier],
	[Colorway] INT,
)

CREATE TABLE [dbo].[#tempCopyStyleMaterials] (
	[RecID] int IDENTITY(1,1)  NOT NULL,
	[StyleMaterialID]  uniqueidentifier ROWGUIDCOL  NOT NULL ,
	[StyleMaterialMasterID] [uniqueidentifier],
	[CopyStyleMaterialID] [uniqueidentifier],
	[MainMaterial] [int],
	[Development] [bit],
	[StyleSet] [int],
	[StyleID] [uniqueidentifier],
	[UOM] [nvarchar] (50),
	[Qty] [nvarchar] (18),
	[MaterialPrice] [money],
	[Ext] [money],
	[MaterialSize] [nvarchar] (200),
	[MaterialID] [uniqueidentifier],
	[MaterialPlacement] [bit],
	[MaterialPlacementCode] [nvarchar] (4),
	[MaterialPlacementDetail] [nvarchar] (200),
	[MaterialImageID] [uniqueidentifier],
	[MaterialImageVersion] [int],
	[NoColorMatch] [int],
	[SupplierID] [nvarchar] (50),
	[ComponentTypeID] [int],
	[MaterialType] [int],
	[MaterialNo] [nvarchar] (50),
	[MaterialName] [nvarchar] (200),
	[A] [nvarchar] (100),
	[B] [nvarchar] (100),
	[C] [nvarchar] (100),
	[D] [nvarchar] (100),
	[E] [nvarchar] (100),
	[F] [nvarchar] (100),
	[G] [nvarchar] (100),
	[H] [nvarchar] (100),
	[I] [nvarchar] (100),
	[J] [nvarchar] (100),
	[K] [nvarchar] (100),
	[L] [nvarchar] (100),
	[M] [nvarchar] (100),
	[N] [nvarchar] (100),
	[O] [nvarchar] (100),
	[P] [nvarchar] (100),
	[Q] [nvarchar] (100),
	[R] [nvarchar] (100),
	[S] [nvarchar] (100),
	[T] [nvarchar] (100),
	[U] [nvarchar] (100),
	[V] [nvarchar] (100),
	[W] [nvarchar] (100),
	[X] [nvarchar] (100),
	[Y] [nvarchar] (100),
	[Z] [nvarchar] (100),
	[Source] [nvarchar] (200),
	[Notes] [nvarchar] (4000),
	[Placement] [nvarchar] (4000),
	[VendorPrice] [decimal](19, 3),
	[VolumePrice] [decimal](19, 3),
	[VolumePriceMinimum] [nvarchar] (50),
	[VendorProductionMin] [nvarchar] (50),
	[VendorProductionLeadTime] [nvarchar] (50),
	[DetailYesNo] [int],
	[ImageType] [nvarchar] (50),
	[height] [nvarchar] (18),
	[width] [nvarchar] (18),
	[CDate] [datetime],
	[CUser] [nvarchar] (200),
	[MDate] [datetime],
	[MUser] [nvarchar] (200),
	[MChange] [int],
	[SChange] [int],
	[DChange] [int],
	[CChange] [int],
	[Action] [nvarchar] (50),
	[ColorPlacement] [nvarchar] (4000),
	[Artwork] INT,
	[License] INT,
	[Colorway] INT,
	[MaterialSort] [varchar] (5),
	[MaterialTrack] [int],
	[MaterialLinked] [int],
	[MaterialLining] [int]
)

CREATE TABLE [dbo].[#tempStyleColorway] (
	[RecID] int IDENTITY(1,1)  NOT NULL,
	[StyleColorID]  uniqueidentifier ROWGUIDCOL  NOT NULL ,
) 

CREATE TABLE [dbo].[#tempCopyStyleColorway] (
	[RecID] int IDENTITY(1,1)  NOT NULL,
	[StyleColorID]  uniqueidentifier ROWGUIDCOL  NOT NULL ,
	[StyleID] [uniqueidentifier],
	[StyleSet] [int],
	[StyleColorStandardID] [uniqueidentifier],
	[StyleColorNo] [nvarchar] (200) ,		
	[StyleColorName] [nvarchar] (200) ,
	[MainColor] [nvarchar] (100) ,
	[Sort] [nvarchar] (10) ,
	[Version] [int],
	[CDate] [datetime],
	[CUser] [nvarchar] (200),
	[MDate] [datetime],
	[MUser] [nvarchar] (200) ,
	CopyStyleColorID UNIQUEIDENTIFIER , 
	ColorPaletteID UNIQUEIDENTIFIER
) 

CREATE TABLE [dbo].[#tempStyleColorwayItem] (
	[RecID] int IDENTITY(1,1)  NOT NULL,
	[StyleColorItemID]  uniqueidentifier,
	[StyleColorItemMasterID] [uniqueidentifier], 
	[StyleColorID] [uniqueidentifier],
	[StyleID] [uniqueidentifier],
	[StyleSet] [int],
	[StyleMaterialID] [uniqueidentifier],
	[MaterialID] [uniqueidentifier],
	[MaterialColorID] [uniqueidentifier],
	[CDate] [datetime],
	[CUser] [nvarchar] (200),
	[MDate] [datetime],
	[MUser] [nvarchar] (200)
) 

CREATE TABLE [dbo].[#tempCopyStyleColorwayItem] (
	[RecID] int IDENTITY(1,1)  NOT NULL,
	[StyleColorItemID]  uniqueidentifier,
	[StyleColorItemMasterID] [uniqueidentifier], 
	[StyleColorID] [uniqueidentifier],
	[StyleID] [uniqueidentifier],
	[StyleSet] [int],
	[StyleMaterialID] [uniqueidentifier],
	[MaterialID] [uniqueidentifier],
	[MaterialColorID] [uniqueidentifier],
	[CDate] [datetime],
	[CUser] [nvarchar] (200),
	[MDate] [datetime],
	[MUser] [nvarchar] (200)
) 

DECLARE @Row_Count int
DECLARE @Row_Loop int
DECLARE @Row_Color_Count int
DECLARE @Row_Color_Loop int

BEGIN

	INSERT INTO dbo.#tempStyleColorway( StyleColorID )
	SELECT StyleColorwayID
	FROM dbo.pStyleColorwaySeasonYear
	WHERE StyleSeasonYearID = @StyleSeasonYearID 
	
	
	DECLARE @StyleColorID uniqueidentifier 	
	DECLARE @NewStyleColorID uniqueidentifier 	
		
	SET @Row_Loop = 1
	SET @Row_Count = (SELECT COUNT(*) FROM #tempStyleColorway)

	WHILE @Row_Loop <= @Row_Count 
	BEGIN
		
		SELECT @StyleColorID = StyleColorID FROM  #tempStyleColorway WHERE RecID = @Row_Loop
		SET @NewStyleColorID = newid()
	
		INSERT INTO dbo.#tempCopyStyleColorway
		(StyleColorID, StyleID, StyleSet, StyleColorStandardID, StyleColorNo, StyleColorName, MainColor, Sort, Version, CDate, CUser, MDate, MUser , CopyStyleColorID, ColorPaletteID)
		SELECT @NewStyleColorID, @NewStyleID, StyleSet, StyleColorStandardID, StyleColorNo, StyleColorName, MainColor, Sort, Version, @CDate AS CDate, @CUser AS CUser, 
		@CDate AS MDate, @CUser AS MUser , CopyStyleColorID, ColorPaletteID
		FROM dbo.pStyleColorway
		WHERE (StyleColorID = @StyleColorID)
		
		SET @Row_Loop = @Row_Loop + 1
	END
	
END	
	
-- FIX StyleColorItemMasterID	
BEGIN	
	INSERT INTO dbo.#tempStyleColorwayItem
	(StyleColorItemID, StyleColorItemMasterID, StyleColorID, StyleID, StyleSet, StyleMaterialID, MaterialID, MaterialColorID, CDate, CUser, MDate, MUser)
	SELECT StyleColorItemID, StyleColorItemMasterID, StyleColorID, StyleID, StyleSet, StyleMaterialID, MaterialID, MaterialColorID, CDate, CUser, MDate, MUser
	FROM  dbo.pStyleColorwayItem
	WHERE StyleID = @StyleID
	
	--SET @Row_Loop = 1
	--SET @Row_Count = (SELECT COUNT(*) FROM #tempStyleColorwayItem)
	
	--DECLARE @StyleColorItemID uniqueidentifier 	
	--DECLARE @StyleColorItemMasterID  uniqueidentifier 	

	--WHILE @Row_Loop <= @Row_Count 
	--BEGIN
	--	SELECT @StyleColorItemMasterID = StyleColorItemMasterID, @StyleColorItemID = StyleColorItemID 
	--	FROM  #tempStyleColorwayItem WHERE RecID = @Row_Loop
		
	--	IF @StyleColorItemMasterID IS NULL
	--	BEGIN
	--		UPDATE pStyleColorwayItem SET StyleColorItemMasterID = newid() WHERE StyleColorItemID = @StyleColorItemID
	--	END	
	--	SET @Row_Loop = @Row_Loop + 1
	--END
	
	UPDATE  pStyleColorwayItem SET StyleColorItemMasterID = NEWID() 
	WHERE StyleID = @StyleID AND StyleColorItemMasterID IS NULL 
		
END	

		

---Style Material--------------------------------------------
BEGIN

	INSERT INTO dbo.#tempStyleMaterials( StyleMaterialID, StyleMaterialMasterID, Colorway)
	SELECT StyleMaterialID, StyleMaterialMasterID, Colorway
	FROM dbo.pStyleMaterials
	WHERE StyleID = @StyleID

	DECLARE @StyleMaterialMasterID uniqueidentifier
	DECLARE @StyleMaterialID uniqueidentifier
	DECLARE @NewStyleMaterialID uniqueidentifier
	DECLARE @Colorway INT

	SET @Row_Loop = 1
	SELECT @Row_Count  = COUNT(*) FROM #tempStyleMaterials
	
	WHILE @Row_Loop <= @Row_Count 
	BEGIN
		
		SELECT @StyleMaterialMasterID = StyleMaterialMasterID, @StyleMaterialID = StyleMaterialID, @Colorway = Colorway 
		FROM #tempStyleMaterials WHERE RecID = @Row_Loop
			
		IF @StyleMaterialMasterID IS NULL
		BEGIN
			UPDATE pStyleMaterials SET StyleMaterialMasterID = NEWID() WHERE StyleMaterialID = @StyleMaterialID
		END
			
		BEGIN
		
			SET @NewStyleMaterialID = NEWID()
	
			INSERT INTO dbo.#tempCopyStyleMaterials
			(StyleMaterialID, MainMaterial, StyleSet, StyleID, UOM, Qty, MaterialPrice, Ext, MaterialSize, MaterialID, MaterialImageID, 
			MaterialImageVersion, NoColorMatch, SupplierID, ComponentTypeID, MaterialType, MaterialNo, MaterialName, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O,
			P, Q, R, S, T, U, V, W, X, Y, Z,Source, Notes, Placement, VendorPrice, VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, 
			DetailYesNo, ImageType, ColorPlacement, Artwork, License, Colorway, CDate, CUser, MDate, MUser, MChange,  SChange, DChange, 
			CChange, Action, StyleMaterialMasterID, Development, MaterialTrack, MaterialLinked, MaterialSort, MaterialLining)
			SELECT @NewStyleMaterialID, MainMaterial, StyleSet, @NewStyleID AS StyleID, UOM, 
			Qty, MaterialPrice, Ext, MaterialSize, MaterialID, MaterialImageID, MaterialImageVersion, NoColorMatch, SupplierID, 
			ComponentTypeID, MaterialType, MaterialNo, MaterialName, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S,  T, U, V, W, X, Y, Z,Source, Notes, 
			Placement AS Placement, VendorPrice, VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, DetailYesNo, 
			ImageType, ColorPlacement, Artwork, License, Colorway, @CDate AS CDate, @CUser AS CUser, 
			@CDate AS MDate, @CUser AS MUser, MChange, SChange, DChange, CChange, Action, StyleMaterialMasterID, 
			Development, MaterialTrack, MaterialLinked, MaterialSort, MaterialLining
			FROM dbo.pStyleMaterials
			WHERE StyleMaterialID = @StyleMaterialID
				
			
			SET @Row_Color_Loop = 1
			SET @Row_Color_Count = (SELECT COUNT(*) FROM #tempStyleColorway)
															
			IF @Colorway = 1
			BEGIN
				WHILE @Row_Color_Loop <= @Row_Color_Count
				BEGIN
					
					SELECT @StyleColorID = StyleColorID FROM  #tempStyleColorway WHERE RecID = @Row_Color_Loop
					SELECT @NewStyleColorID = StyleColorID FROM  #tempCopyStyleColorway WHERE RecID = @Row_Color_Loop

					INSERT INTO dbo.#tempCopyStyleColorwayItem
					(StyleColorItemID, StyleColorItemMasterID, StyleColorID, StyleID, StyleSet, StyleMaterialID, MaterialID, MaterialColorID, CDate, CUser, MDate, MUser)
					SELECT newid() AS StyleColorItemID, StyleColorItemMasterID, @NewStyleColorID, @NewStyleID, StyleSet, @NewStyleMaterialID, MaterialID, MaterialColorID, CDate, CUser, MDate, MUser
					FROM  #tempStyleColorwayItem
					WHERE StyleColorID = @StyleColorID AND StyleMaterialID = @StyleMaterialID		
							
					SET @Row_Color_Loop = @Row_Color_Loop + 1
					
				END
			END

		END			
			
		SET @Row_Loop = @Row_Loop + 1
	END -- while
END



BEGIN

	INSERT INTO dbo.pStyleMaterials
	(StyleMaterialID, MainMaterial, StyleSet, StyleID, UOM, Qty, MaterialPrice, Ext, MaterialSize, MaterialID, MaterialImageID, 
	MaterialImageVersion, NoColorMatch, SupplierID, ComponentTypeID, MaterialType, MaterialNo, MaterialName, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O,
	P, Q, R, S,  T, U, V, W, X, Y, Z,Source, Notes, Placement, VendorPrice, VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, 
	DetailYesNo, ImageType, ColorPlacement, Artwork, License, Colorway, CDate, CUser, MDate, MUser, MChange,  SChange, DChange, 
	CChange, Action, StyleMaterialMasterID, Development, MaterialTrack, MaterialLinked, MaterialSort, MaterialLining)
	SELECT StyleMaterialID, MainMaterial, StyleSet, StyleID, UOM, 
	Qty, MaterialPrice, Ext, MaterialSize, MaterialID, MaterialImageID, MaterialImageVersion, NoColorMatch, SupplierID, 
	ComponentTypeID, MaterialType, MaterialNo, MaterialName, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S,  T, U, V, W, X, Y, Z,Source, Notes, 
	Placement AS Placement, VendorPrice, VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, DetailYesNo, 
	ImageType, ColorPlacement, Artwork, License, Colorway, CDate, CUser, 
	MDate, MUser, MChange, SChange, DChange, CChange, Action, StyleMaterialMasterID, 
	Development, MaterialTrack, MaterialLinked, MaterialSort, MaterialLining
	FROM dbo.#tempCopyStyleMaterials WHERE MaterialLinked = 1
	
	INSERT INTO dbo.pStyleColorway
	(StyleColorID, StyleID, StyleSet, StyleColorStandardID, StyleColorNo, StyleColorName, MainColor, Sort, Version, CDate, CUser, MDate, MUser , CopyStyleColorID, ColorPaletteID)
	SELECT StyleColorID, StyleID, StyleSet, StyleColorStandardID, StyleColorNo, StyleColorName, MainColor, Sort, Version, CDate, CUser, MDate, MUser , CopyStyleColorID, ColorPaletteID
	FROM dbo.#tempCopyStyleColorway
	
	INSERT INTO dbo.pStyleColorwayItem
	(StyleColorItemID, StyleColorItemMasterID, StyleColorID, StyleID, StyleSet, StyleMaterialID, MaterialID, MaterialColorID, CDate, CUser, MDate, MUser)
	SELECT StyleColorItemID, StyleColorItemMasterID, StyleColorID, StyleID, StyleSet, StyleMaterialID, MaterialID, MaterialColorID, CDate, CUser, MDate, MUser
	FROM  dbo.#tempCopyStyleColorwayItem	
	

	INSERT INTO pStyleColorwaySeasonYear( StyleColorwaySeasonYearID , StyleSeasonYearID , StyleColorwayID , StyleID,  
	MUser, MDate)
	SELECT  NEWID() AS StyleColorwaySeasonYearID, @NewStyleSeasonYearID, StyleColorID , StyleID , 
	@CUser, @CDate 
	FROM  #tempCopyStyleColorway 
	

END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSampleCalendar_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[spx_StyleSampleCalendar_SELECT](@TeamID uniqueidentifier,
@StyleID nvarchar(50),
@BeginDate datetime,
@EndDate datetime)
AS SELECT     dbo.pSampleWorkflow.GroupName, dbo.pSampleRequestWorkflow.Status, dbo.pSampleRequestWorkflow.DueDate, 
                      dbo.pSampleRequestWorkflow.Submit, dbo.pStyleColorway.MainColor, dbo.pSampleWorkflow.GroupID, dbo.pSampleWorkflow.SampleWorkflow, 
                      fnx_StyleSet.StyleNo, fnx_StyleSet.StyleSet AS SetName, dbo.pSampleRequestWorkflow.SampleRequestWorkflowID, 
                      dbo.pSampleRequestWorkflow.SampleWorkflowID, dbo.pSampleRequestWorkflow.SampleRequestTradeID, 
                      dbo.pSampleRequestWorkflow.TradePartnerID, dbo.pSampleRequestWorkflow.StyleID, dbo.pSampleRequestWorkflow.StyleColorID, 
                      dbo.pSampleRequestWorkflow.StyleSet
FROM         dbo.pSampleRequestWorkflow WITH (NOLOCK) INNER JOIN
                      dbo.pSampleWorkflow WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.SampleWorkflowID = dbo.pSampleWorkflow.SampleWorkflowID INNER JOIN
                      dbo.pStyleColorway WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.StyleColorID = dbo.pStyleColorway.StyleColorID INNER JOIN
                      dbo.fnx_StyleSet() fnx_StyleSet ON dbo.pSampleRequestWorkflow.StyleID = fnx_StyleSet.StyleID AND 
                      dbo.pSampleRequestWorkflow.StyleSet = fnx_StyleSet.ID
WHERE     (dbo.pSampleRequestWorkflow.DueDate >= @BeginDate) AND (dbo.pSampleRequestWorkflow.DueDate <= @EndDate) AND 
                      (dbo.pSampleRequestWorkflow.StyleID = @StyleID) AND (dbo.pSampleRequestWorkflow.TradePartnerID = @TeamID)
ORDER BY dbo.pSampleRequestWorkflow.Submit DESC, fnx_StyleSet.StyleNo, dbo.pSampleRequestWorkflow.StyleSet, 
                      dbo.pSampleWorkflow.SampleWorkflowSort, dbo.pSampleRequestWorkflow.Status



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcing_ItemTables_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_StyleSourcing_ItemTables_SELECT] (
@StyleSourcingID UNIQUEIDENTIFIER, 
@StyleColorID UNIQUEIDENTIFIER, 
@StyleSet INT 
)
AS

DECLARE @StyleID UNIQUEIDENTIFIER
SELECT @StyleID  = StyleID FROM pStyleSourcing


SELECT ComponentTypeID, SourcingHeaderSchema, SourcingPrintSchema  
FROM  pComponentType WHERE ComponentTypeID IN  ( 
	SELECT DISTINCT a.MaterialType 
	FROM pStyleMaterials a
	WHERE a.StyleID = @StyleID 
	AND a.StyleSet = @StyleSet 
	AND a.MainMaterial = 0 
)








GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleCostingCopy_SeasonYear_INSERT]'
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE  PROCEDURE [dbo].[spx_StyleCostingCopy_SeasonYear_INSERT](
@StyleID UNIQUEIDENTIFIER,
@NewStyleID UNIQUEIDENTIFIER,
@SeasonYearID UNIQUEIDENTIFIER,
@CreatedBy NVARCHAR(200),
@CreatedDate DATETIME
)
AS 

DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER 
DECLARE @NewStyleSeasonYearID UNIQUEIDENTIFIER 

SELECT @StyleSeasonYearID = StyleSeasonYearID FROM pStyleSeasonYear WHERE StyleID = @StyleID AND SeasonYearID = @SeasonYearID 
SELECT @NewStyleSeasonYearID = StyleSeasonYearID FROM pStyleSeasonYear WHERE StyleID = @NewStyleID AND SeasonYearID = @SeasonYearID 


INSERT INTO dbo.pStyleCostingHeader
                      (StyleID, StyleCostingTypeID, StyleQuotaDutyID, StyleCostingDate, StyleCostingStatus, StyleCostingCustomField1, StyleCostingCustomField2, 
                      StyleCostingCustomField3, StyleCostingCustomField4, StyleCostingCustomField5, StyleCostingCustomField6, StyleCostingCustomField7, 
                      StyleCostingCustomField8, StyleCostingCustomField9, StyleCostingCustomField10, StyleCostingCustomField11, StyleCostingCustomField12, 
                      StyleCostingCustomField13, StyleCostingCustomField14, StyleCostingCustomField15, StyleCostingCustomField16, StyleCostingCustomField17, 
                      StyleCostingCustomField18, StyleCostingCustomField19, StyleCostingCustomField20, StyleCostingCustomField21, StyleCostingCustomField22, 
                      StyleCostingCustomField23, StyleCostingCustomField24, StyleCostingCustomField25, StyleCostingCustomField26, StyleCostingCustomField27, 
                      StyleCostingCustomField28, StyleCostingCustomField29, StyleCostingCustomField30, CUser, CDate, MUser, MDate, Active, 
                      StyleSeasonYearID)
SELECT     @NewStyleID AS StyleId, StyleCostingTypeID, StyleQuotaDutyID, StyleCostingDate, StyleCostingStatus, StyleCostingCustomField1, 
                      StyleCostingCustomField2, StyleCostingCustomField3, StyleCostingCustomField4, StyleCostingCustomField5, StyleCostingCustomField6, 
                      StyleCostingCustomField7, StyleCostingCustomField8, StyleCostingCustomField9, StyleCostingCustomField10, StyleCostingCustomField11, 
                      StyleCostingCustomField12, StyleCostingCustomField13, StyleCostingCustomField14, StyleCostingCustomField15, StyleCostingCustomField16, 
                      StyleCostingCustomField17, StyleCostingCustomField18, StyleCostingCustomField19, StyleCostingCustomField20, StyleCostingCustomField21, 
                      StyleCostingCustomField22, StyleCostingCustomField23, StyleCostingCustomField24, StyleCostingCustomField25, StyleCostingCustomField26, 
                      StyleCostingCustomField27, StyleCostingCustomField28, StyleCostingCustomField29, StyleCostingCustomField30, @CreatedBy AS CreatedBy, 
                      @CreatedDate AS CreatedDate, @CreatedBy AS CreatedBy, @CreatedDate AS CreatedDate, Active,
                      @NewStyleSeasonYearID
FROM         dbo.pStyleCostingHeader WITH (NOLOCK)
WHERE StyleId = @StyleId





INSERT INTO dbo.pStyleCosting
                      (StyleID, StyleCostingTypeID, StyleCostingFreightTypeID, StyleQuotaDutyID, StyleCostingDate, StyleCostingStatus, StyleCostingCustomField1, 
                      StyleCostingCustomField2, StyleCostingCustomField3, StyleCostingCustomField4, StyleCostingCustomField5, StyleCostingCustomField6, 
                      StyleCostingCustomField7, StyleCostingCustomField8, StyleCostingCustomField9, StyleCostingCustomField10, StyleCostingCustomField11, 
                      StyleCostingCustomField12, StyleCostingCustomField13, StyleCostingCustomField14, StyleCostingCustomField15, StyleCostingCustomField16, 
                      StyleCostingCustomField17, StyleCostingCustomField18, StyleCostingCustomField19, StyleCostingCustomField20, StyleCostingCustomField21, 
                      StyleCostingCustomField22, StyleCostingCustomField23, StyleCostingCustomField24, StyleCostingCustomField25, StyleCostingCustomField26, 
                      StyleCostingCustomField27, StyleCostingCustomField28, StyleCostingCustomField29, StyleCostingCustomField30, StyleCostingCustomField31, 
                      StyleCostingCustomField32, StyleCostingCustomField33, StyleCostingCustomField34, StyleCostingCustomField35, CUser, CDate, MUser, MDate, 
                      Active, StyleSeasonYearID)
SELECT     @NewStyleID AS StyleId, StyleCostingTypeID, StyleCostingFreightTypeID, StyleQuotaDutyID, StyleCostingDate, StyleCostingStatus, 
                      StyleCostingCustomField1, StyleCostingCustomField2, StyleCostingCustomField3, StyleCostingCustomField4, StyleCostingCustomField5, 
                      StyleCostingCustomField6, StyleCostingCustomField7, StyleCostingCustomField8, StyleCostingCustomField9, StyleCostingCustomField10, 
                      StyleCostingCustomField11, StyleCostingCustomField12, StyleCostingCustomField13, StyleCostingCustomField14, StyleCostingCustomField15, 
                      StyleCostingCustomField16, StyleCostingCustomField17, StyleCostingCustomField18, StyleCostingCustomField19, StyleCostingCustomField20, 
                      StyleCostingCustomField21, StyleCostingCustomField22, StyleCostingCustomField23, StyleCostingCustomField24, StyleCostingCustomField25, 
                      StyleCostingCustomField26, StyleCostingCustomField27, StyleCostingCustomField28, StyleCostingCustomField29, StyleCostingCustomField30, 
                      StyleCostingCustomField31, StyleCostingCustomField32, StyleCostingCustomField33, StyleCostingCustomField34, StyleCostingCustomField35, 
                      @CreatedBy AS Cuser, @CreatedDate AS Cdate, @CreatedBy AS Muser, @CreatedDate AS Mdate, 1,
                      @NewStyleSeasonYearID
FROM         dbo.pStyleCosting WITH (NOLOCK)
WHERE StyleId = @StyleId




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlan_StyleSeasonYear_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[spx_LinePlan_StyleSeasonYear_SELECT](
@Season NVARCHAR(200),
@Year  NVARCHAR(200),
@StyleID UNIQUEIDENTIFIER, 
@LinePlanID UNIQUEIDENTIFIER, 
@LinePlanItemID UNIQUEIDENTIFIER,
@CUser NVARCHAR (200), 
@CDate DATETIME,
@New INT = 0 
)
AS 

DECLARE @SeasonYearID UNIQUEIDENTIFIER 
DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER 
DECLARE @StyleNo NVARCHAR(20)

SELECT @SeasonYearID = SeasonYearID  FROM pSeasonYear WHERE Season = @Season  AND [Year] = @Year
IF @SeasonYearID IS NULL 
BEGIN
	SET @SeasonYearID = NEWID() 
	INSERT INTO pSeasonYear (SeasonYearID, Season, Year, Active ) 
	VALUES (@SeasonYearID , @Season, @Year, 1) 
END 

SELECT @StyleNo = StyleNo FROM pStyleHeader WHERE StyleID = @StyleID


IF @New = 1 
BEGIN

	SELECT @StyleSeasonYearID = StyleSeasonYearID FROM pStyleSeasonYear WHERE StyleID = @StyleID  
	IF @StyleSeasonYearID IS NOT NULL 
	BEGIN
		UPDATE  pStyleSeasonYear SET SeasonYearID = @SeasonYearID, StyleSeason = @Season,
		StyleYear = @Year , StyleNo = @StyleNo, 
		LinePlanID = @LinePlanID , LinePlanItemID = @LinePlanItemID  
		WHERE StyleSeasonYearID = @StyleSeasonYearID 
	END 
END
ELSE
	SELECT @StyleSeasonYearID = StyleSeasonYearID 
	FROM pStyleSeasonYear 
	WHERE SeasonYearID = @SeasonYearID 
	AND StyleID = @StyleID  
	--AND StyleNo =  @StyleNo 



IF @StyleSeasonYearID IS NULL
BEGIN 
	SET @StyleSeasonYearID  = NEWID()
	INSERT INTO pStyleSeasonYear(StyleSeasonYearID , SeasonYearID, StyleID , StyleNo, StyleSeason, StyleYear, CUSer, CDate, MUser, MDate, CurrentSeason, LinePlanID , LinePlanItemID )
	VALUES ( @StyleSeasonYearID , @SeasonYearID, @StyleID , @StyleNo, @Season, @Year, @CUSer, @CDate, @CUSer, @CDate, 0, @LinePlanID , @LinePlanItemID )
END 



SELECT SeasonYearID = @SeasonYearID, StyleSeasonYearID = @StyleSeasonYearID

 






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialRequestSubmitWorkflowTemplate_DELETE]'
GO


CREATE PROCEDURE [dbo].[spx_MaterialRequestSubmitWorkflowTemplate_DELETE]
(
@MaterialRequestWorkflowID varchar(5),
@MaterialRequestSubmitID uniqueidentifier,
@ModifiedBy nvarchar(200),
@ModifiedDate datetime
)
AS 

BEGIN
	IF (SELECT COUNT(*)
	FROM pMaterialRequestSubmitItem (NOLOCK)
	WHERE MaterialRequestSubmitID = @MaterialRequestSubmitID) = 0
	BEGIN

		DECLARE @MaterialRequestSubmitWorkflowID uniqueidentifier
		SELECT @MaterialRequestSubmitWorkflowID = MaterialRequestSubmitWorkflowID FROM
			pMaterialRequestSubmit WHERE MaterialRequestSubmitID = @MaterialRequestSubmitID
	
		UPDATE pMaterialRequestSubmitWorkflow SET 
				MaterialRequestWorkflowTempItemID = NULL,
				MaterialRequestWorkflowGroupID = NULL	
		WHERE MaterialRequestSubmitWorkflowID = @MaterialRequestSubmitWorkflowID 

	END	
END










GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Material_WhereUsed_SELECT]'
GO


--STORED PROCEDURE

ALTER       PROCEDURE [dbo].[rpx_Material_WhereUsed_SELECT]
(
	@Season nvarchar(100),
	@Year   nvarchar(100)
)
AS 
SELECT
	pMaterial.B AS Season,
	pMaterial.D AS [Year],
	pMaterial.MaterialNo as MaterialsCode,	
	pMaterial.MaterialName,
 	pMaterial.Q AS VendorMill,
	pMaterial.R AS VendorMillRefNO, 
	pMaterial.G AS Content,
	pMaterial.H AS Construction,
	pMaterial.I AS YarnSizeCount,
	pMaterial.K AS Weight,
	CAST (pStyleMaterials.QTY AS Decimal(18,4)) AS Quantity,	
	pStyleMaterials.Placement,
	pComponentType.ComponentDescription AS [MaterialType],
	pStyleHeader.StyleNo,
	pStyleHeader.[Description],
	pStyleHeader.STYLENO AS StylesWhereUsed,
	pStyleHeader.SizeClass
FROM  pMaterial 
	INNER  JOIN	pStyleMaterials ON  pMaterial.MaterialID     = pStyleMaterials.MaterialID
	INNER  JOIN pComponentType	ON  pMaterial.MaterialType 	 = pComponentType.ComponentTypeID	
	INNER  JOIN pStyleHeader 	ON  pStyleMaterials.StyleID  = pStyleHeader.StyleID
WHERE pMaterial.B = @Season and pMaterial.D = @Year 
ORDER BY pMaterial.MaterialNo, pMaterial.MaterialName, pStyleHeader.StyleNo 







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlan_StyleItem_DELETE]'
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE PROCEDURE [dbo].[spx_LinePlan_StyleItem_DELETE] (
@LinePlanItemID UNIQUEIDENTIFIER,
@StyleSeasonYearID UNIQUEIDENTIFIER 
)
AS

BEGIN
   UPDATE pLinePlanItem Set StyleID = '00000000-0000-0000-0000-000000000000' WHERE LinePlanItemID = @LinePlanItemID
END

BEGIN
   UPDATE pStyleSeasonYear Set LinePlanID = NULL, LinePlanItemID = NULL WHERE StyleSeasonYearID = @StyleSeasonYearID
END

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_ColorPalette_SELECT]'
GO


ALTER      PROCEDURE [dbo].[rpx_ColorPalette_SELECT]
(
	@ColorFolderID nvarchar(255)
)

AS

DECLARE @ImageFolder varchar(200)
SET @ImageFolder = (SELECT TOP 1 SettingValue FROM rReportSetting WHERE SettingType = 'ImageColorPath')


SELECT 
0 AS TableRow,
0 AS [Column],
IDENTITY(INT,1,1) AS RowID  ,
@ImageFolder + '/' + CAST(ColorFolderID AS NVARCHAR(40)) + '/' + CAST(ColorPaletteID AS NVARCHAR(40)) + '/600.jpg' AS FilePath,
ColorName,
ColorCode,
Sort
INTO #tmpColor
FROM pColorPalette 
WHERE ColorFolderID = @ColorFolderID
ORDER BY Sort, ColorCode, ColorName

UPDATE #tmpColor SET [Column] = RowID % 7 

DECLARE @ROWID INT
DECLARE @TOTAL INT 
DECLARE @TABLEROW INT 

SELECT @TOTAL = COUNT(*) FROM #tmpColor 
SET @ROWID = 1
SET @TABLEROW  = 1

DECLARE @CONT INT 
SET @CONT = 1


WHILE @ROWID <= @TOTAL 
BEGIN

	UPDATE #tmpColor SET  TableRow = @TABLEROW  WHERE RowID = @ROWID 

	SET @CONT = @CONT + 1 
	IF @CONT > 7
	BEGIN
		SET  @CONT  = 1 
		SET @TABLEROW = @TABLEROW + 1
	END 
	
	SET @ROWID = @ROWID  + 1 
END 

select * from #tmpColor 

DROP TABLE #tmpColor


/*For Test Run*/
-- DECLARE @ColorFolderID nvarchar(255)
-- SET @ColorFolderID = '25d32611-49c7-44f2-bb7a-02d191a3aeb2'
/*
DECLARE @ImageFolder varchar(200)
DECLARE @TotalCount int
DECLARE @RowCounter int
 
SET @ImageFolder = (SELECT TOP 1 SettingValue FROM rReportSetting WHERE SettingType = 'ImageColorPath')

CREATE TABLE #TempColorPaletteIDs
(
	TableRow int identity(1,1),
	ColorFolderID nvarchar(200),
	ColorPaletteID nvarchar(200),
	ColorName nvarchar(150),
	ColorCode nvarchar(50),
	Sort nvarchar(10)
)

CREATE TABLE #TempColorMatrix
(
	TableRow int identity(0,1),
	FilePath nvarchar(255),
	ColorName nvarchar(150),
	ColorCode nvarchar(50),
	Sort nvarchar(10)
)

INSERT INTO #TempColorPaletteIDs (ColorFolderID, ColorPaletteID, ColorName, ColorCode, Sort)
SELECT   ColorFolderID, ColorPaletteID, ColorName, ColorCode, Sort
FROM pColorPalette
WHERE ColorFolderID = @ColorFolderID
ORDER BY Sort, ColorCode, ColorName

SELECT @TotalCount = COUNT(*) FROM #TempColorPaletteIDs
SET @RowCounter = 1

WHILE (@RowCounter <= @TotalCount)
	BEGIN

		INSERT INTO #TempColorMatrix (FilePath, ColorName, ColorCode, Sort)
		SELECT
			@ImageFolder + '/' + ColorFolderID + '/' + ColorPaletteID + '/600.jpg' AS FilePath,
			ColorName,
			ColorCode,
			Sort
		FROM #TempColorPaletteIDs
		WHERE TableRow = @RowCounter

		SET @RowCounter = @RowCounter + 1
	END

SELECT TableRow % 7 AS [Column], FilePath, ColorName, ColorCode, Sort 
FROM #TempColorMatrix 

DROP TABLE #TempColorPaletteIDs
DROP TABLE #TempColorMatrix

*/

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcing_MostLikelyVendor_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER  PROCEDURE [dbo].[spx_StyleSourcing_MostLikelyVendor_SELECT] (
@StyleID UNIQUEIDENTIFIER 
)
AS 

	SELECT a.StyleSeasonYearID , a.StyleSeason, a.StyleYear, a.TradePartnerVendorID, a.MostlikelyVendor, a.StyleID
	--, b.HeaderLocked
	FROM pStyleSeasonYear a
	INNER JOIN pStyleHeader b ON a.StyleID =  b.StyleID 
	WHERE a.StyleID = @StyleID   





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanItemColorName_SELECT]'
GO


CREATE PROCEDURE [dbo].[spx_LinePlanItemColorName_SELECT](@ColorPaletteID uniqueidentifier)
AS 

SELECT 
		'<table><tr><td>
		<img src="../System/Control/ColorStream.ashx?S=16&CFID=' + CAST(pColorPalette.ColorFolderID AS NVARCHAR(50)) -- #01
		+ '&CPID=' + CAST(pColorPalette.ColorPaletteID AS NVARCHAR(50)) +  '" border="0" /></td><td class="fontHead">' + pColorPalette.ColorName + '</td></tr></table>'  
		AS ColorUrl	

FROM  pColorPalette 
WHERE pColorPalette.ColorPaletteID = @ColorPaletteID
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_LinePlanShowroom_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_LinePlanShowroom_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlan_StyleShowRoomItem_DELETE]'
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE PROCEDURE [dbo].[spx_LinePlan_StyleShowRoomItem_DELETE] (  
@StyleID UNIQUEIDENTIFIER,  
@LinePlanID UNIQUEIDENTIFIER,   
@LinePlanRangeID UNIQUEIDENTIFIER
)  
AS  

BEGIN
 DELETE FROM pLinePlanShowroomStyleColor WHERE StyleID=@StyleID AND LinePlanID=@LinePlanID AND LinePlanRangeID=@LinePlanRangeID 
END 

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialRequestSubmitWorkflowTreeWithColors_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[spx_MaterialRequestSubmitWorkflowTreeWithColors_SELECT](@MaterialTradePartnerColorID uniqueidentifier)
AS 

DECLARE @MaterialTradePartnerID UNIQUEIDENTIFIER

SELECT TOP 1 @MaterialTradePartnerID = MaterialTradePartnerID FROM pMaterialRequestSubmitWorkflow 
WHERE MaterialTradePartnerColorID = @MaterialTradePartnerColorID


SELECT pMaterialTradePartnerColor.MaterialTradePartnerColorID, pMaterialTradePartnerColor.ColorCode, pMaterialRequestSubmit.MaterialRequestSubmitID, 
  pMaterialTradePartnerColor.ColorNo, pMaterialTradePartnerColor.ColorName, pMaterialTradePartnerColor.VendorColorCode, 
  pMaterialTradePartnerColor.VendorColorNo, pMaterialTradePartnerColor.VendorColorName, pMaterialRequestWorkflow.MaterialRequestWorkflowID, 
  pMaterialRequestWorkflow.GroupName, pMaterialRequestWorkflow.GroupID, pMaterialRequestSubmitStatus.Status, 
  pMaterialRequestSubmitWorkflow.Submit, pMaterialRequestSubmitWorkflow.DueDate, pMaterialRequestSubmitWorkflow.EndDate, 
  pMaterialRequestWorkflow.MaterialRequestWorkflow, pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID, 
  pMaterialRequestWorkflow.MaterialRequestWorkflowSort, pMaterialTradePartnerColor.MaterialID, 
  '../System/Icons/' + pMaterialRequestSubmitStatus.StatusIcon AS Icon, 
	pMaterialRequestSubmitWorkflow.MaterialTradePartnerID, pMaterialRequestWorkflow.MaterialRequestWorkflowColor, pMaterialTradePartnerColor.ColorFolderID, pMaterialTradePartnerColor.ColorPaletteID,
	pMaterialTradePartnerColor.MaterialColorImageID, pMaterialTradePartnerColor.MaterialColorImageVersion, pMaterialRequestSubmitWorkflow.MaterialRequestSubmitAllColors
FROM pMaterialRequestSubmitStatus INNER JOIN
  pMaterialRequestWorkflow INNER JOIN
  pMaterialRequestSubmitWorkflow ON 
  pMaterialRequestWorkflow.MaterialRequestWorkflowID = pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID ON 
  pMaterialRequestSubmitStatus.StatusID = pMaterialRequestSubmitWorkflow.Status INNER JOIN
  pMaterialTradePartnerColor ON 
  pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID = pMaterialTradePartnerColor.MaterialTradePartnerColorID INNER JOIN
  pMaterialRequestSubmit ON 
  pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID = pMaterialRequestSubmit.MaterialRequestSubmitWorkflowID
WHERE pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID = @MaterialTradePartnerColorID AND pMaterialRequestSubmitWorkflow.MaterialRequestSubmitAllColors = 0
AND pMaterialRequestSubmitWorkflow.Active = 1 
ORDER BY pMaterialRequestWorkflow.MaterialRequestWorkflowSort



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Style_GradedRules_SELECT]'
GO



ALTER        PROCEDURE [dbo].[rpx_Style_GradedRules_SELECT]  
	@StyleID varchar(255), 
	@StyleSet int 
AS
 
SELECT	sz.Sel0 AS Sample0,
	sz.Sel1 AS Sample1,
	sz.Sel2 AS Sample2,
	sz.Sel3 AS Sample3,
	sz.Sel4 AS Sample4,
	sz.Sel5 AS Sample5,
	sz.Sel6 AS Sample6,
	sz.Sel7 AS Sample7,
	sz.Sel8 AS Sample8,
	sz.Sel9 AS Sample9,
	sz.Sel10 AS Sample10,
	sz.Sel11 AS Sample11,
	sz.Sel12 AS Sample12,
	sz.Sel13 AS Sample13,
	sz.Sel14 AS Sample14,
	sz.Sel15 AS Sample15,
	sz.Sel16 AS Sample16,
	sz.Sel17 AS Sample17,
	sz.Sel18 AS Sample18,
	sz.Sel19 AS Sample19,
	sz.Size0 AS Range0,
	sz.Size1 AS Range1,
	sz.Size2 AS Range2,
	sz.Size3 AS Range3,
	sz.Size4 AS Range4,
	sz.Size5 AS Range5,
	sz.Size6 AS Range6,
	sz.Size7 AS Range7,
	sz.Size8 AS Range8,
	sz.Size9 AS Range9,
      	sz.Size10 AS Range10,
	sz.Size11 AS Range11,
	sz.Size12 AS Range12,
	sz.Size13 AS Range13,
	sz.Size14 AS Range14,
	sz.Size15 AS Range15,
	sz.Size16 AS Range16,
	sz.Size17 AS Range17,
	sz.Size18 AS Range18,
	sz.Size19 AS Range19,
	CAST(ps.Size0 AS Decimal(8,3)) AS Size0,
	CAST(ps.Size1 AS Decimal(8,3)) AS Size1,
	CAST(ps.Size2 AS Decimal(8,3)) AS Size2,
	CAST(ps.Size3 AS Decimal(8,3)) AS Size3,
	CAST(ps.Size4 AS Decimal(8,3)) AS Size4,
	CAST(ps.Size5 AS Decimal(8,3)) AS Size5,
	CAST(ps.Size6 AS Decimal(8,3)) AS Size6,
	CAST(ps.Size7 AS Decimal(8,3)) AS Size7,
	CAST(ps.Size8 AS Decimal(8,3)) AS Size8,
	CAST(ps.Size9 AS Decimal(8,3)) AS Size9,
	CAST(ps.Size10 AS Decimal(8,3)) AS Size10,
	CAST(ps.Size11 AS Decimal(8,3)) AS Size11,
	CAST(ps.Size12 AS Decimal(8,3)) AS Size12,
	CAST(ps.Size13 AS Decimal(8,3)) AS Size13,
	CAST(ps.Size14 AS Decimal(8,3)) AS Size14,
	CAST(ps.Size15 AS Decimal(8,3)) AS Size15,
	CAST(ps.Size16 AS Decimal(8,3)) AS Size16,
	CAST(ps.Size17 AS Decimal(8,3)) AS Size17,
	CAST(ps.Size18 AS Decimal(8,3)) AS Size18,
	CAST(ps.Size19 AS Decimal(8,3)) AS Size19,
	CAST(ps.Grade0 AS Decimal(8,3)) AS Grade0, 
	CAST(ps.Grade1 AS Decimal(8,3)) AS Grade1, 
	CAST(ps.Grade2 AS Decimal(8,3)) AS Grade2,  
	CAST(ps.Grade3 AS Decimal(8,3)) AS Grade3, 
	CAST(ps.Grade4 AS Decimal(8,3)) AS Grade4, 
	CAST(ps.Grade5 AS Decimal(8,3)) AS Grade5, 
	CAST(ps.Grade6 AS Decimal(8,3)) AS Grade6, 
	CAST(ps.Grade7 AS Decimal(8,3)) AS Grade7, 
	CAST(ps.Grade8 AS Decimal(8,3)) AS Grade8, 
	CAST(ps.Grade9 AS Decimal(8,3)) AS Grade9, 
	CAST(ps.Grade10 AS Decimal(8,3)) AS Grade10, 
	CAST(ps.Grade11 AS Decimal(8,3)) AS Grade11, 
	CAST(ps.Grade12 AS Decimal(8,3)) AS Grade12, 
	CAST(ps.Grade13 AS Decimal(8,3)) AS Grade13, 
	CAST(ps.Grade14 AS Decimal(8,3)) AS Grade14, 
	CAST(ps.Grade15 AS Decimal(8,3)) AS Grade15, 
	CAST(ps.Grade16 AS Decimal(8,3)) AS Grade16, 
	CAST(ps.Grade17 AS Decimal(8,3)) AS Grade17, 
	CAST(ps.Grade18 AS Decimal(8,3)) AS Grade18, 
	CAST(ps.Grade19 AS Decimal(8,3)) AS Grade19, 
	CAST(ps.Proto0 AS Decimal(8,3)) AS Proto0, 
	CAST(ps.Proto1 AS Decimal(8,3)) AS Proto1, 
	CAST(ps.Proto2 AS Decimal(8,3)) AS Proto2,  
	CAST(ps.Proto3 AS Decimal(8,3)) AS Proto3, 
	CAST(ps.Proto4 AS Decimal(8,3)) AS Proto4, 
	CAST(ps.Proto5 AS Decimal(8,3)) AS Proto5, 
	CAST(ps.Proto6 AS Decimal(8,3)) AS Proto6, 
	CAST(ps.Proto7 AS Decimal(8,3)) AS Proto7, 
	CAST(ps.Proto8 AS Decimal(8,3)) AS Proto8, 
	CAST(ps.Proto9 AS Decimal(8,3)) AS Proto9, 
	CAST(ps.Proto10 AS Decimal(8,3)) AS Proto10, 
	CAST(ps.Proto11 AS Decimal(8,3)) AS Proto11, 
	CAST(ps.Proto12 AS Decimal(8,3)) AS Proto12, 
	CAST(ps.Proto13 AS Decimal(8,3)) AS Proto13, 
	CAST(ps.Proto14 AS Decimal(8,3)) AS Proto14, 
	CAST(ps.Proto15 AS Decimal(8,3)) AS Proto15, 
	CAST(ps.Proto16 AS Decimal(8,3)) AS Proto16, 
	CAST(ps.Proto17 AS Decimal(8,3)) AS Proto17, 
	CAST(ps.Proto18 AS Decimal(8,3)) AS Proto18, 
	CAST(ps.Proto19 AS Decimal(8,3)) AS Proto19, 	
	ps.POM, ps.PointMeasur, 
	CAST(ps.TOL AS Decimal(8,3)) AS TOL, 
	CAST(ps.TOLN AS Decimal(8,3)) AS TOLN, 
	WashType = 
		CASE 
			WHEN UPPER(ph.WashType) IS NULL THEN 'TOL'
			WHEN UPPER(ph.WashType) = '' THEN 'TOL'
			WHEN UPPER(ph.WashType) = 'WASH' THEN 'TOL'
			ELSE 'TOLN'
		END 
FROM	pStyleSpecSize sz INNER JOIN pStyleSpec AS ps ON
	sz.StyleID = ps.StyleID INNER JOIN pStyleHeader AS ph ON
	ps.StyleID = ph.StyleID 
WHERE	(ps.StyleID = @StyleID)	AND
		(ps.StyleSet = @StyleSet) AND
		(ps.Spec <> 0)
ORDER BY Sort, POM, PointMeasur


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[vwx_LinePlanStyleItem_SEL_Remove]'
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE VIEW [dbo].[vwx_LinePlanStyleItem_SEL_Remove]
AS
SELECT     a.LinePlanItemID, a.LinePlanRangeID, a.LinePlanRangeTypeID, a.LinePlanID, a.CUser, a.CDate, a.MUser, a.MDate, a.StyleTypeID, b.StyleID, 
                      b.StyleType, b.StyleNo, b.TempID, b.TempNo, b.ConceptNo, b.SpecNo, b.Description, b.SizeClass, b.SizeRange, b.StyleSet, b.MaterialID, 
                      b.MaterialImageID, b.MaterialImageVersion, b.MaterialNo, b.MaterialName, b.DesignSketchID, b.DesignSketchVersion, b.CustomField1, 
                      b.CustomField2, b.CustomField3, b.CustomField4, b.CustomField5, b.CustomField6, b.CustomField7, b.CustomField8, b.CustomField9, 
                      b.CustomField10, b.CustomField11, b.CustomField12, b.CustomField13, b.CustomField14, b.CustomField15, d.StyleCostingTypeID, d.StyleQuotaDutyID,
                       d.StyleCostingDate, d.StyleCostingStatus, CASE WHEN d .StyleCostingCustomField1 IS NULL 
                      THEN 0 ELSE d .StyleCostingCustomField1 END AS StyleCostingCustomField1, d.StyleCostingCustomField2, d.StyleCostingCustomField3, 
                      d.StyleCostingCustomField4, d.StyleCostingCustomField5, d.StyleCostingCustomField6, d.StyleCostingCustomField7, d.StyleCostingCustomField8, 
                      d.StyleCostingCustomField9, d.StyleCostingCustomField10, d.StyleCostingCustomField11, d.StyleCostingCustomField12, 
                      d.StyleCostingCustomField13, d.StyleCostingCustomField14, d.StyleCostingCustomField15, d.StyleCostingCustomField16, 
                      d.StyleCostingCustomField17, d.StyleCostingCustomField18, d.StyleCostingCustomField19, d.StyleCostingCustomField20, 
                      d.StyleCostingCustomField21, d.StyleCostingCustomField22, d.StyleCostingCustomField23, d.StyleCostingCustomField24, 
                      d.StyleCostingCustomField25, d.StyleCostingCustomField26, d.StyleCostingCustomField27, d.StyleCostingCustomField28, 
                      d.StyleCostingCustomField29, d.StyleCostingCustomField30, d.Active, d.StyleCostingCustomField31, d.StyleCostingCustomField32, 
                      d.StyleCostingCustomField33, d.StyleCostingCustomField34, d.StyleCostingCustomField35, c.SeasonYearID, e.AttributeName,c.StyleSeasonYearID
FROM         dbo.pLinePlanItem AS a LEFT OUTER JOIN
dbo.pStyleHeader AS b ON a.StyleID = b.StyleID LEFT OUTER JOIN
dbo.pStyleSeasonYear AS c ON a.StyleID = c.StyleID AND a.LinePlanItemID = c.LinePlanItemID LEFT OUTER JOIN
dbo.pStyleCostingHeader AS d ON d.StyleSeasonYearID = c.StyleSeasonYearID 
LEFT OUTER JOIN pLinePlanStyleAttributeItem e ON e.LinePlanStyleAttributeItemID = a.LinePlanStyleAttributeItemID 
WHERE a.StyleID != '00000000-0000-0000-0000-000000000000'

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialRequestSubmitWorkflowTreeWithoutColors_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[spx_MaterialRequestSubmitWorkflowTreeWithoutColors_SELECT](@MaterialTradePartnerColorID uniqueidentifier)
AS 

DECLARE @MaterialTradePartnerID UNIQUEIDENTIFIER

SELECT TOP 1 @MaterialTradePartnerID = MaterialTradePartnerID FROM pMaterialRequestSubmitWorkflow 
WHERE MaterialTradePartnerColorID = @MaterialTradePartnerColorID


SELECT pMaterialTradePartnerColor.MaterialTradePartnerColorID, pMaterialTradePartnerColor.ColorCode, pMaterialRequestSubmit.MaterialRequestSubmitID, 
  pMaterialTradePartnerColor.ColorNo, pMaterialTradePartnerColor.ColorName, pMaterialTradePartnerColor.VendorColorCode, 
  pMaterialTradePartnerColor.VendorColorNo, pMaterialTradePartnerColor.VendorColorName, pMaterialRequestWorkflow.MaterialRequestWorkflowID, 
  pMaterialRequestWorkflow.GroupName, pMaterialRequestWorkflow.GroupID, pMaterialRequestSubmitStatus.Status, 
  pMaterialRequestSubmitWorkflow.Submit, pMaterialRequestSubmitWorkflow.DueDate, pMaterialRequestSubmitWorkflow.EndDate, 
  pMaterialRequestWorkflow.MaterialRequestWorkflow, pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID, 
  pMaterialRequestWorkflow.MaterialRequestWorkflowSort, pMaterialTradePartnerColor.MaterialID, 
  '../System/Icons/' + pMaterialRequestSubmitStatus.StatusIcon AS Icon,  
	pMaterialRequestSubmitWorkflow.MaterialTradePartnerID, pMaterialRequestWorkflow.MaterialRequestWorkflowColor, pMaterialTradePartnerColor.ColorFolderID, pMaterialTradePartnerColor.ColorPaletteID,
	pMaterialTradePartnerColor.MaterialColorImageID, pMaterialTradePartnerColor.MaterialColorImageVersion, pMaterialRequestSubmitWorkflow.MaterialRequestSubmitAllColors
FROM pMaterialRequestSubmitStatus INNER JOIN
  pMaterialRequestWorkflow INNER JOIN
  pMaterialRequestSubmitWorkflow ON 
  pMaterialRequestWorkflow.MaterialRequestWorkflowID = pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID ON 
  pMaterialRequestSubmitStatus.StatusID = pMaterialRequestSubmitWorkflow.Status INNER JOIN
  pMaterialTradePartnerColor ON 
  pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID = pMaterialTradePartnerColor.MaterialTradePartnerColorID INNER JOIN
  pMaterialRequestSubmit ON 
  pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID = pMaterialRequestSubmit.MaterialRequestSubmitWorkflowID
WHERE pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID = @MaterialTradePartnerColorID AND pMaterialRequestSubmitWorkflow.MaterialRequestSubmitAllColors = 1
AND pMaterialRequestSubmitWorkflow.Active = 1 
--AND pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowTempItemID IN (
--	SELECT MaterialRequestWorkflowTempItemID
--	FROM pMaterialTradePartner a
--	INNER JOIN pMaterialRequestWorkflowTemplateItem b ON a.MaterialRequestWorkflowTempID = b.MaterialRequestWorkflowTempID
--	WHERE MaterialTradePartnerID  = @MaterialTradePartnerID 
--)
ORDER BY pMaterialRequestWorkflow.MaterialRequestWorkflowSort





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_StyleSearchMaterial_Select]'
GO
EXEC sp_refreshview N'[dbo].[vwx_StyleSearchMaterial_Select]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcingAgentVendor_SELECT]'
GO


ALTER PROCEDURE [dbo].[spx_StyleSourcingAgentVendor_SELECT]  (
@StyleMaterialID UNIQUEIDENTIFIER ,
@StyleColorID UNIQUEIDENTIFIER ,
@StyleSourcingID UNIQUEIDENTIFIER ,
@ShowCount INT =  0  OUTPUT
)
AS


DECLARE @MaterialColorID UNIQUEIDENTIFIER 
DECLARE @MaterialID  UNIQUEIDENTIFIER 
DECLARE @MaterialSize NVARCHAR (100)
DECLARE @MaterialSizeID UNIQUEIDENTIFIER 
DECLARE @ColorWay as INT



SELECT @MaterialColorID  = a.MaterialColorID , @MaterialID  = a.MaterialID ,
@MaterialSizeID = b.MaterialSizeID , @MaterialSize = b.MaterialSize , @ColorWay = b.Colorway
FROM pStyleColorwayItem a  INNER JOIN pStyleMaterials b  ON a.StyleMaterialID =  b.StyleMaterialID 
WHERE a.StyleColorId = @StyleColorID 
AND a.StyleMaterialID = @StyleMaterialID


--SELECT MaterialColorID = @MaterialColorID  , MaterialID =@MaterialID   , MaterialSizeID = @MaterialSizeID  ,   MaterialSize = @MaterialSize 
--SELECT @MaterialSize


UPDATE pMaterialTradePartnerColor SET MaterialSizeID = '00000000-0000-0000-0000-000000000000'
WHERE  MaterialID = @MaterialID
AND MaterialSizeID  IS NULL



IF  LOWER ( @MaterialSize ) = '*na'  
BEGIN 
	
	IF @MaterialSizeID  IS NULL
		SET @MaterialSizeID  =  '00000000-0000-0000-0000-000000000000'

	UPDATE pStyleMaterials SET MaterialSizeID =  '00000000-0000-0000-0000-000000000000'   WHERE StyleMaterialID = @StyleMaterialID 

END
ELSE 
BEGIN 
	IF @MaterialSizeID  IS NULL 
	BEGIN 
		SELECT @MaterialSizeID = MaterialSizeID FROM pMaterialSize WHERE MaterialID = @MaterialID  AND MaterialSize = @MaterialSize
		IF @MaterialSizeID IS NOT NULL
		BEGIN
			UPDATE pStyleMaterials SET MaterialSizeID = @MaterialSizeID WHERE StyleMaterialID = @StyleMaterialID 
		END
	END 
END 


--SELECT @ColorWay AS COLORWAY 

DECLARE @COUNT AS INT 

set @COUNT = 0 


IF @ColorWay  = 1 
BEGIN 

		IF  @ShowCount = 1  
		BEGIN
			SELECT @COUNT  = COUNT(*) 
			FROM pMaterialTradePartnerColor a INNER JOIN pMaterialTradePartner b ON a.MaterialTradePartnerID =  b.MaterialTradePartnerID 
			INNER JOIN  uTradePartnerVendor c   ON  b.TradepartnerVendorId = c.TradePartnerVendorID 
			INNER JOIN  uTradePartner d ON  c.TradePartnerID =  d.TradePartnerID   
			WHERE a.MaterialID = @MaterialID
			AND a.MaterialColorID = @MaterialColorID  
			AND a.MaterialSizeID  = @MaterialSizeID 
			GROUP BY  d.TradePartnerName + ' - ' +  c.VendorName   , c.TradePartnerVendorID
		END 
		ELSE 
		BEGIN 

			SELECT d.TradePartnerName + ' - ' +  c.VendorName   as TextValue ,  c.TradePartnerVendorID 
			,a.MaterialtradeColor5 as ColorCode , a.MaterialTradeColor6 AS ColorName
			FROM pMaterialTradePartnerColor a INNER JOIN pMaterialTradePartner b ON a.MaterialTradePartnerID =  b.MaterialTradePartnerID 
			INNER JOIN  uTradePartnerVendor c   ON  b.TradepartnerVendorId = c.TradePartnerVendorID 
			INNER JOIN  uTradePartner d ON  c.TradePartnerID =  d.TradePartnerID   
			WHERE a.MaterialID = @MaterialID
			AND a.MaterialColorID = @MaterialColorID  
			AND a.MaterialSizeID  = @MaterialSizeID 
			GROUP BY  d.TradePartnerName + ' - ' +  c.VendorName   , c.TradePartnerVendorID
			,a.MaterialtradeColor5, a.MaterialTradeColor6

		END 

END



SET  @ShowCount  =  @COUNT

PRINT 'showcount = ' + CAST ( @ShowCount  AS NVARCHAR(50))









GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_LinePlanShowroomSearch_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_LinePlanShowroomSearch_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[vwx_LinePlanShowroomItem_SEL_Remove]'
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE VIEW [dbo].[vwx_LinePlanShowroomItem_SEL_Remove]
AS
SELECT     a.LinePlanItemID, a.LinePlanRangeID, a.LinePlanRangeTypeID, a.LinePlanID, a.CUser, a.CDate, a.MUser, a.MDate, a.StyleTypeID, b.StyleID, 
                      b.StyleType, b.StyleNo, b.TempID, b.TempNo, b.ConceptNo, b.SpecNo, b.Description, b.SizeClass, b.SizeRange, b.StyleSet, b.MaterialID, 
                      b.MaterialImageID, b.MaterialImageVersion, b.MaterialNo, b.MaterialName, b.DesignSketchID, b.DesignSketchVersion, b.CustomField1, 
                      b.CustomField2, b.CustomField3, b.CustomField4, b.CustomField5, b.CustomField6, b.CustomField7, b.CustomField8, b.CustomField9, 
                      b.CustomField10, b.CustomField11, b.CustomField12, b.CustomField13, b.CustomField14, b.CustomField15, d.StyleCostingTypeID, d.StyleQuotaDutyID,
                       d.StyleCostingDate, d.StyleCostingStatus, CASE WHEN d .StyleCostingCustomField1 IS NULL 
                      THEN 0 ELSE d .StyleCostingCustomField1 END AS StyleCostingCustomField1, d.StyleCostingCustomField2, d.StyleCostingCustomField3, 
                      d.StyleCostingCustomField4, d.StyleCostingCustomField5, d.StyleCostingCustomField6, d.StyleCostingCustomField7, d.StyleCostingCustomField8, 
                      d.StyleCostingCustomField9, d.StyleCostingCustomField10, d.StyleCostingCustomField11, d.StyleCostingCustomField12, 
                      d.StyleCostingCustomField13, d.StyleCostingCustomField14, d.StyleCostingCustomField15, d.StyleCostingCustomField16, 
                      d.StyleCostingCustomField17, d.StyleCostingCustomField18, d.StyleCostingCustomField19, d.StyleCostingCustomField20, 
                      d.StyleCostingCustomField21, d.StyleCostingCustomField22, d.StyleCostingCustomField23, d.StyleCostingCustomField24, 
                      d.StyleCostingCustomField25, d.StyleCostingCustomField26, d.StyleCostingCustomField27, d.StyleCostingCustomField28, 
                      d.StyleCostingCustomField29, d.StyleCostingCustomField30, d.Active, d.StyleCostingCustomField31, d.StyleCostingCustomField32, 
                      d.StyleCostingCustomField33, d.StyleCostingCustomField34, d.StyleCostingCustomField35, c.SeasonYearID, e.AttributeName,c.StyleSeasonYearID
FROM         dbo.pLinePlanItem AS a LEFT OUTER JOIN
dbo.pStyleHeader AS b ON a.StyleID = b.StyleID LEFT OUTER JOIN
dbo.pStyleSeasonYear AS c ON a.StyleID = c.StyleID AND a.LinePlanItemID = c.LinePlanItemID LEFT OUTER JOIN
dbo.pStyleCostingHeader AS d ON d.StyleSeasonYearID = c.StyleSeasonYearID 
LEFT OUTER JOIN pLinePlanStyleAttributeItem e ON e.LinePlanStyleAttributeItemID = a.LinePlanStyleAttributeItemID 
--INNER JOIN dbo.pLinePlanShowroomStyleColor AS f ON f.StyleID = a.StyleID
WHERE a.StyleID != '00000000-0000-0000-0000-000000000000' and a.StyleID in (Select StyleID FROM pLinePlanShowroomStyleColor)


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_TechPack_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_TechPack_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pMaterialRequestWorkflowGroup]'
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[pMaterialRequestWorkflowGroup]
(
[MaterialRequestWorkflowGroupID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_pMaterialRequestWorkflowGroup_MaterialRequestWorkflowGroupID] DEFAULT (newsequentialid()),
[MaterialRequestWorkflowID] [varchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MaterialRequestWorkflowGroup] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MaterialRequestWorkflowGroupSort] [varchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pMaterialRequestWorkflowGroup] on [dbo].[pMaterialRequestWorkflowGroup]'
GO
ALTER TABLE [dbo].[pMaterialRequestWorkflowGroup] ADD CONSTRAINT [PK_pMaterialRequestWorkflowGroup] PRIMARY KEY CLUSTERED  ([MaterialRequestWorkflowGroupID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[vwx_MaterialRequestWorkflowGroup_SEL]'
GO
CREATE VIEW dbo.vwx_MaterialRequestWorkflowGroup_SEL
AS
SELECT     TOP (100) PERCENT dbo.pMaterialRequestWorkflowGroup.MaterialRequestWorkflowGroupID, dbo.pMaterialRequestWorkflow.MaterialRequestWorkflowID, 
                      CAST(dbo.pMaterialRequestWorkflow.MaterialRequestWorkflow AS CHAR(15)) 
                      + ': ' + dbo.pMaterialRequestWorkflowGroup.MaterialRequestWorkflowGroup AS MaterialRequestWorkflowGroup, 
                      dbo.pMaterialRequestWorkflow.MaterialRequestWorkflowSort, dbo.pMaterialRequestWorkflowGroup.MaterialRequestWorkflowGroupSort
FROM         dbo.pMaterialRequestWorkflow INNER JOIN
                      dbo.pMaterialRequestWorkflowGroup ON 
                      dbo.pMaterialRequestWorkflow.MaterialRequestWorkflowID = dbo.pMaterialRequestWorkflowGroup.MaterialRequestWorkflowID
ORDER BY dbo.pMaterialRequestWorkflow.MaterialRequestWorkflowSort, dbo.pMaterialRequestWorkflowGroup.MaterialRequestWorkflowGroupSort
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_LinePlanStyleItemRollup_SEL]'
GO
ALTER VIEW dbo.vwx_LinePlanStyleItemRollup_SEL
AS
SELECT     dbo.pLinePlanItem.LinePlanItemID, dbo.pLinePlanItem.LinePlanRangeID, dbo.pLinePlanItem.LinePlanRangeTypeID, dbo.pLinePlanItem.LinePlanID, 
                      dbo.pStyleHeader.StyleID, dbo.pStyleHeader.StyleType, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.TempID, dbo.pStyleHeader.TempNo, 
                      dbo.pStyleHeader.ConceptNo, dbo.pStyleHeader.SpecNo, dbo.pStyleHeader.Description, dbo.pStyleHeader.SizeClass, dbo.pStyleHeader.SizeRange, 
                      dbo.pStyleHeader.StyleSet, dbo.pStyleHeader.MaterialID, dbo.pStyleHeader.MaterialImageID, dbo.pStyleHeader.MaterialImageVersion, 
                      dbo.pStyleHeader.MaterialNo, dbo.pStyleHeader.MaterialName, dbo.pStyleHeader.DesignSketchID, dbo.pStyleHeader.DesignSketchVersion, 
                      dbo.pStyleHeader.CustomField1, dbo.pStyleHeader.CustomField2, dbo.pStyleHeader.CustomField3, dbo.pStyleHeader.CustomField4, 
                      dbo.pStyleHeader.CustomField5, dbo.pStyleHeader.CustomField6, dbo.pStyleHeader.CustomField7, dbo.pStyleHeader.CustomField8, 
                      dbo.pStyleHeader.CustomField9, dbo.pStyleHeader.CustomField10, dbo.pStyleHeader.CustomField11, dbo.pStyleHeader.CustomField12, 
                      dbo.pStyleHeader.CustomField13, dbo.pStyleHeader.CustomField14, dbo.pStyleHeader.CustomField15, dbo.pLinePlanItem.CUser, 
                      dbo.pLinePlanItem.CDate, dbo.pLinePlanItem.MUser, dbo.pLinePlanItem.MDate, dbo.pLinePlanItem.StyleTypeID, 
                      dbo.pLinePlanRange.LinePlanAttributeItemID1, dbo.pLinePlanRange.LinePlanAttributeItemID2, dbo.pLinePlanRange.LinePlanAttributeItemID3, 
                      dbo.pLinePlanRange.LinePlanAttributeItemID4, dbo.pLinePlanRange.LinePlanFinancialID, dbo.pStyleCostingHeader.StyleCostingCustomField1
FROM         dbo.pLinePlanItem INNER JOIN
                      dbo.pLinePlanRange ON dbo.pLinePlanItem.LinePlanRangeID = dbo.pLinePlanRange.LinePlanRangeID LEFT OUTER JOIN
                      dbo.pStyleSeasonYear ON dbo.pLinePlanItem.LinePlanItemID = dbo.pStyleSeasonYear.LinePlanItemID AND 
                      dbo.pLinePlanItem.StyleID = dbo.pStyleSeasonYear.StyleID LEFT OUTER JOIN
                      dbo.pStyleCostingHeader ON dbo.pStyleSeasonYear.StyleSeasonYearID = dbo.pStyleCostingHeader.StyleSeasonYearID AND 
                      dbo.pLinePlanItem.StyleID = dbo.pStyleCostingHeader.StyleID LEFT OUTER JOIN
                      dbo.pStyleHeader ON dbo.pLinePlanItem.StyleID = dbo.pStyleHeader.StyleID
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleRequestTradeAllocation_INSERT]'
GO





ALTER PROCEDURE [dbo].[spx_SampleRequestTradeAllocation_INSERT]

(
@SampleRequestGroupID nvarchar(50),
@TradePartnerVendorID nvarchar(50),
@TradePartnerID nvarchar(50),
@StyleID nvarchar(50),
@SampleRequestShare nvarchar(2) , 
@StyleColorID nvarchar(50),
@CreatedBy nvarchar(200),
@CreatedDate datetime , 
@StyleSourcingID UNIQUEIDENTIFIER  =  NULL 
)

AS


DECLARE @I as int, @ISet int,  @Row_Count int
DECLARE @ISet_Curr int  , @ISet_Max  int ,
@SampleRequestWorkflowID nvarchar(50),
@NewSampleRequestWorkflowID nvarchar(50),
@StyleRequestWorkflowSetItemID uniqueidentifier,
@SampleRequestTradeID uniqueidentifier,
@TechPackID nvarchar(50)

DECLARE  @StyleSeasonYearID UNIQUEIDENTIFIER 

SET @I = 1
SET @ISet = 1
SET @ISet_Curr = 1 
SET NOCOUNT ON


BEGIN TRANSACTION
	BEGIN

		SET @SampleRequestTradeID = newid()
		--PRINT '@SampleRequestTradeID= '  +  CAST ( @SampleRequestTradeID  as NVARCHAR (50) ) 
	

		SELECT @SampleRequestTradeID AS SampleRequestTradeID
		
		BEGIN	
		
			SELECT @TechPackID = TechPackID FROM pstyleHeader WHERE StyleId = @StyleId
			IF @TechPackID IS NULL 
			BEGIN
				SET @Techpackid = '00000000-0000-0000-0000-000000000000'
			END

			SELECT TOP 1 @StyleSeasonYearID = b.StyleSeasonYearID 
			FROM pSampleRequestGroupTemp a 
			LEFT OUTER JOIN pStyleSeasonYear b ON a.StyleID = b.StyleID AND a.SeasonYearID =b.SeasonYearID
			WHERE @SampleRequestGroupID = SampleRequestGroupID
			

			INSERT INTO pSampleRequestTrade
				(SampleRequestTradeID, TradePartnerVendorID, TradePartnerID, StyleID, 
				StyleColorID, TechPackID, CUser, CDate, MUser, MDate, MessageSent, SampleRequestShare, StyleSourcingID , StyleSeasonYearID   )
			VALUES (@SampleRequestTradeID, @TradePartnerVendorID, @TradePartnerID, @StyleID, 
				@StyleColorID, @TechPackID, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate, 0, @SampleRequestShare  , @StyleSourcingID , @StyleSeasonYearID )	

				
			INSERT INTO pSampleRequestActivity
				(SampleRequestTradeId, TradePartnerId, TradePartnerVendorId, StyleId, StyleColorId, TechPackId, CUser, CDate, SampleActivity, ActivityType)
			VALUES  (@SampleRequestTradeId, @TradePartnerId, @TradepartnerVendorId, @StyleId, @StyleColorId, @TechPackId, @CreatedBy, @CreatedDate, N'New Sample Request', 'N')					
		

			SELECT * FROM pSampleRequestTrade WHERE SampleRequestTradeID = @SampleRequestTradeID
			IF @@ERROR <> 0
			BEGIN
			ROLLBACK TRANSACTION
			RETURN
			END
				
		END
		

		BEGIN	

			--SET @ISet_Count = (SELECT COUNT(*) FROM pSampleRequestSetItemTemp WHERE (SampleRequestGroupID = @SampleRequestGroupID))
	
			SELECT @ISet_Max  = Max ( StyleSet )  FROM pSampleRequestSetItemTemp WHERE (SampleRequestGroupID = @SampleRequestGroupID)

			if  @ISet_Max is null 
				SET @ISet_Max = 0 
			else
				SELECT @ISet = Min (StyleSet ) FROM pSampleRequestSetItemTemp WHERE (SampleRequestGroupID = @SampleRequestGroupID)



			--WHILE @ISet <= @ISet_Count 
			WHILE @ISet <= @ISet_Max
				BEGIN

					PRINT  'SET = ' +  CAST  ( @ISet  AS VARCHAR (10) )
					SET  @ISet_Curr = @ISet 		
					SET @StyleRequestWorkflowSetItemID = newid()
	
				
					BEGIN
				
						SELECT IDENTITY(int, 1,1) AS ID_Num, SampleRequestWorkflowID, StyleRequestWorkflowSetItemID, SampleRequestGroupID, SampleWorkflowTempItemID, 
							SampleWorkflowID, StyleID, @StyleColorID AS StyleColorID , StyleSet, Status, Submit, SubmitDays, ResubmitDays, AssignedTo, TechPackID, StartDate, DueDate, EndDate, CUser, CDate, 
							MUser, MDate INTO ##SampleRequestWorkflowTemp FROM pSampleRequestWorkflowTemp
						WHERE (SampleRequestGroupID = @SampleRequestGroupID) AND (StyleSet = @ISet)

						SET @Row_Count = (SELECT COUNT(*) FROM ##SampleRequestWorkflowTemp WHERE (SampleRequestGroupID = @SampleRequestGroupID))
						
						SET @I = 1

						WHILE @I <= @Row_Count 
						BEGIN
							
							SET @NewSampleRequestWorkflowID = newid()
							
							SELECT @SampleRequestWorkflowID = SampleRequestWorkflowID FROM ##SampleRequestWorkflowTemp WHERE ID_Num = @I
								BEGIN
			
									INSERT INTO pSampleRequestWorkflow
										(TradePartnerVendorID, TradePartnerID, SampleRequestWorkflowID, StyleRequestWorkflowSetItemID, SampleRequestTradeID, SampleWorkflowTempItemID, SampleWorkflowID, StyleID, 
										StyleColorID, StyleSet, Status, Submit, SubmitDays, ResubmitDays, AssignedTo, TechPackID, StartDate, DueDate, FinalDate, EndDate, CUser, CDate, MUser, MDate , SampleWorkflowFinalDate )
									SELECT @TradePartnerVendorID, @TradePartnerID, @NewSampleRequestWorkflowID AS SampleRequestWorkflowID, @StyleRequestWorkflowSetItemID, @SampleRequestTradeID AS SampleRequestTradeID, SampleWorkflowTempItemID, 
										SampleWorkflowID, StyleID, @StyleColorID AS StyleColorID, StyleSet, 0 AS Status, 1 AS Submit, SubmitDays, ResubmitDays, AssignedTo, TechPackID, StartDate, DueDate, FinalDate, '1/1/1900', CUser, CDate, 
										MUser, MDate , SampleWorkflowFinalDate 
									FROM dbo.pSampleRequestWorkflowTemp
									WHERE (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (StyleSet = @ISet)

									/*==================================================
									=  New FinalDate 
									==================================================*/
									
/*
									SELECT  @SampleWorkflowFinalDate = SampleWorkflowFinalDate FROM  pSampleRequestWorkflowTemp 
									WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID AND StyleSet = @ISet
						
									UPDATE 	pSampleRequestWorkflow SET 
									SampleWorkflowFinalDate	= DATEADD ( 'day' , @SampleWorkflowFinalDate , SampleWorkflowFinalDate)
									WHERE SampleRequestWorkflowID = @NewSampleRequestWorkflowID
	
									*/
								
									IF @@ERROR <> 0
									BEGIN
										print 'Error 1 ' 
										ROLLBACK TRANSACTION
										RETURN
									END	
								END
								
								BEGIN
			
									INSERT INTO dbo.pSampleRequestSubmit
										(TradePartnerVendorID, TradePartnerID, SampleRequestTradeID, SampleRequestWorkflowID, SampleWorkflowID, StyleID, StyleColorID, StyleSet, WorkflowID, Submit, Status, AssignedTo, 
										StartDate, RecDate, RecBy, RecCarrier, RecTrackNo, RecWeight, VendorWeight, VendorDate, VendorName, SubmitDays, ResubmitDays, DueDate, EndDate, EndBy, 
										CUser, CDate, MUser, MDate, Comment, InternalComment )
									SELECT @TradePartnerVendorID, @TradePartnerID, @SampleRequestTradeID AS SampleRequestTradeID, @NewSampleRequestWorkflowID AS SampleRequestWorkflowID, SampleWorkflowID, StyleID, @StyleColorID AS StyleColorID, StyleSet, WorkflowID, 
										1 AS Submit, 0 AS Status, AssignedTo, StartDate, RecDate, RecBy, RecCarrier, RecTrackNo, RecWeight, VendorWeight, VendorDate, VendorName, SubmitDays, ResubmitDays,  
										DueDate, EndDate, EndBy, CUser, CDate, MUser, MDate, Comment, InternalComment 									 
									FROM  dbo.pSampleRequestSubmitTemp
									WHERE (SampleRequestWorkflowID = @SampleRequestWorkflowID)  AND (StyleSet = @ISet)
									IF @@ERROR <> 0
									BEGIN
									ROLLBACK TRANSACTION
									RETURN
									END	
								END
								--PRINT @I
						
							SET @I = @I + 1

						END

						DROP TABLE ##SampleRequestWorkflowTemp	

						IF @@ERROR <> 0
						BEGIN
						ROLLBACK TRANSACTION
						RETURN
						END
				
					END					
					
					

					SET @ISet   = NULL

					SET @ISet  = ( SELECT top 1 StyleSet  FROM pSampleRequestSetItemTemp  WHERE ( SampleRequestGroupID = @SampleRequestGroupID  )  AND (StyleSet  > @ISet_Curr )  order by StyleSet   )

	
					IF  @ISet  IS NULL 
						SET  @ISet  = @ISet_Max + 1 

					--  SET @ISet = @ISet + 1

				END
					
			IF @@ERROR <> 0
			BEGIN
			ROLLBACK TRANSACTION
			RETURN
			END	
			
		END

		print ' No ERROR 1 ' 


		BEGIN
			
			INSERT INTO dbo.pSampleRequestSpecSize
				(SampleRequestTradeID, SampleRequestWorkflowID, SampleWorkflowID, WorkflowID, StyleID, StyleColorID, StyleSet, SizeRange, Size0, Size1, Size2, 
				Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13, Size14, Size15, Size16, Size17, Size18, Size19, Sel12, Sel13, Sel14, 
				Sel15, Sel16, Sel17, Sel18, Sel19, Sel0, Sel1, Sel2, Sel3, Sel4, Sel5, Sel6, Sel7, Sel8, Sel9, Sel10, Sel11, Col0, Col1, Col2, Col3, Col4, Col5, Col6, Col7, 
				Col8, Col9, Col10, Col11, Col12, Col13, Col14, Col15, Col16, Col17, Col18, Col19, MUser, MDate)
			SELECT     @SampleRequestTradeID AS SampleRequestTradeID, dbo.pSampleRequestWorkflow.SampleRequestWorkflowID, 
				dbo.pSampleRequestSpecSizeTemp.SampleWorkflowID, dbo.pSampleRequestSpecSizeTemp.WorkflowID, 
				dbo.pSampleRequestSpecSizeTemp.StyleID, @StyleColorID AS StyleColorID, dbo.pSampleRequestSpecSizeTemp.StyleSet, 
				dbo.pSampleRequestSpecSizeTemp.SizeRange, dbo.pSampleRequestSpecSizeTemp.Size0, dbo.pSampleRequestSpecSizeTemp.Size1, 
				dbo.pSampleRequestSpecSizeTemp.Size2, dbo.pSampleRequestSpecSizeTemp.Size3, dbo.pSampleRequestSpecSizeTemp.Size4, 
				dbo.pSampleRequestSpecSizeTemp.Size5, dbo.pSampleRequestSpecSizeTemp.Size6, dbo.pSampleRequestSpecSizeTemp.Size7, 
				dbo.pSampleRequestSpecSizeTemp.Size8, dbo.pSampleRequestSpecSizeTemp.Size9, dbo.pSampleRequestSpecSizeTemp.Size10, 
				dbo.pSampleRequestSpecSizeTemp.Size11, dbo.pSampleRequestSpecSizeTemp.Size12, dbo.pSampleRequestSpecSizeTemp.Size13, 
				dbo.pSampleRequestSpecSizeTemp.Size14, dbo.pSampleRequestSpecSizeTemp.Size15, dbo.pSampleRequestSpecSizeTemp.Size16, 
				dbo.pSampleRequestSpecSizeTemp.Size17, dbo.pSampleRequestSpecSizeTemp.Size18, dbo.pSampleRequestSpecSizeTemp.Size19, 
				dbo.pSampleRequestSpecSizeTemp.Sel12, dbo.pSampleRequestSpecSizeTemp.Sel13, dbo.pSampleRequestSpecSizeTemp.Sel14, 
			dbo.pSampleRequestSpecSizeTemp.Sel15, dbo.pSampleRequestSpecSizeTemp.Sel16, dbo.pSampleRequestSpecSizeTemp.Sel17, 
				dbo.pSampleRequestSpecSizeTemp.Sel18, dbo.pSampleRequestSpecSizeTemp.Sel19, dbo.pSampleRequestSpecSizeTemp.Sel0, 
			dbo.pSampleRequestSpecSizeTemp.Sel1, dbo.pSampleRequestSpecSizeTemp.Sel2, dbo.pSampleRequestSpecSizeTemp.Sel3, 
				dbo.pSampleRequestSpecSizeTemp.Sel4, dbo.pSampleRequestSpecSizeTemp.Sel5, dbo.pSampleRequestSpecSizeTemp.Sel6, 
			dbo.pSampleRequestSpecSizeTemp.Sel7, dbo.pSampleRequestSpecSizeTemp.Sel8, dbo.pSampleRequestSpecSizeTemp.Sel9, 
				dbo.pSampleRequestSpecSizeTemp.Sel10, dbo.pSampleRequestSpecSizeTemp.Sel11, dbo.pSampleRequestSpecSizeTemp.Col0, 
				dbo.pSampleRequestSpecSizeTemp.Col1, dbo.pSampleRequestSpecSizeTemp.Col2, dbo.pSampleRequestSpecSizeTemp.Col3, 
				dbo.pSampleRequestSpecSizeTemp.Col4, dbo.pSampleRequestSpecSizeTemp.Col5, dbo.pSampleRequestSpecSizeTemp.Col6, 
				dbo.pSampleRequestSpecSizeTemp.Col7, dbo.pSampleRequestSpecSizeTemp.Col8, dbo.pSampleRequestSpecSizeTemp.Col9, 
				dbo.pSampleRequestSpecSizeTemp.Col10, dbo.pSampleRequestSpecSizeTemp.Col11, dbo.pSampleRequestSpecSizeTemp.Col12, 
				dbo.pSampleRequestSpecSizeTemp.Col13, dbo.pSampleRequestSpecSizeTemp.Col14, dbo.pSampleRequestSpecSizeTemp.Col15, 
				dbo.pSampleRequestSpecSizeTemp.Col16, dbo.pSampleRequestSpecSizeTemp.Col17, dbo.pSampleRequestSpecSizeTemp.Col18, 
				dbo.pSampleRequestSpecSizeTemp.Col19, dbo.pSampleRequestSpecSizeTemp.MUser, dbo.pSampleRequestSpecSizeTemp.MDate
			FROM         dbo.pSampleRequestWorkflow INNER JOIN
				dbo.pSampleRequestSpecSizeTemp ON 
				dbo.pSampleRequestWorkflow.SampleWorkflowID = dbo.pSampleRequestSpecSizeTemp.SampleWorkflowID AND 
				dbo.pSampleRequestWorkflow.StyleID = dbo.pSampleRequestSpecSizeTemp.StyleID AND 
				dbo.pSampleRequestWorkflow.StyleColorID = dbo.pSampleRequestSpecSizeTemp.StyleColorID AND 
				dbo.pSampleRequestWorkflow.StyleSet = dbo.pSampleRequestSpecSizeTemp.StyleSet
			WHERE (dbo.pSampleRequestSpecSizeTemp.SampleRequestGroupID = @SampleRequestGroupID)
			IF @@ERROR <> 0
			BEGIN
			ROLLBACK TRANSACTION
			RETURN
			END	
		END
		
		BEGIN
		
			--DELETE dbo.pSampleRequestStyle
			--WHERE SampleRequestGroupID = @SampleRequestGroupID
		
			INSERT INTO dbo.pSampleRequestStyle
				(SampleRequestTradeID, TradePartnerVendorID, StyleColorID, StyleColorName, StyleID, StyleSet, Submit, StyleType, WorkflowType, RefNo, 
				StyleNo, TempID, TempNo, CustomerNo, ConceptID, ConceptNo, SpecNo, Description, SizeRange, DueDate, RecDate, Customer, Buyer, Designer, 
				SampleMaker, PatternMaker, ProductionManager, TechnicalDesigner, StyleStatus, StyleLocation, Pitch, MaterialID, MaterialImageID, 
				MaterialImageVersion, MaterialNo, MaterialName, StyleMaterialID, DesignSketchID, DesignSketchVersion, Markup, TargetPrice, SellingPrice, 
				CustomField1, CustomField2, CustomField3, CustomField4, CustomField5, CustomField6, CustomField7, CustomField8, CustomField9, CustomField10, 
				CustomField11, CustomField12, CustomField13, CustomField14, CustomField15, Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, 
				Size10, Size11, Sel0, Sel1, Sel2, Sel3, Sel4, Sel5, Sel6, Sel7, Sel8, Sel9, Sel10, Sel11, Pc1, Pc2, Pc3, Pc4, CUser, CDate, MUser, MDate, Active, 
				Change, Action, NoColorCombo,
				CustomField16, CustomField17, CustomField18, CustomField19, CustomField20, CustomField21, CustomField22,  CustomField23, CustomField24,  CustomField25, 
				CustomField26, CustomField27, CustomField28,  CustomField29,  CustomField30 , StyleSourcingID 
				)
			SELECT @SampleRequestTradeID AS SampleRequestTradeID, @TradePartnerVendorID AS TradePartnerVendorID, @StyleColorID, StyleColorName, StyleID, StyleSet, 
				Submit, StyleType, WorkflowType, RefNo, StyleNo, TempID, TempNo, CustomerNo, ConceptID, ConceptNo, SpecNo, Description, SizeRange, DueDate, 
				RecDate, Customer, Buyer, Designer, SampleMaker, PatternMaker, ProductionManager, TechnicalDesigner, StyleStatus, StyleLocation, Pitch, 
				MaterialID, MaterialImageID, MaterialImageVersion, MaterialNo, MaterialName, StyleMaterialID, DesignSketchID, DesignSketchVersion, Markup, 
				TargetPrice, SellingPrice, CustomField1, CustomField2, CustomField3, CustomField4, CustomField5, CustomField6, CustomField7, CustomField8, 
				CustomField9, CustomField10, CustomField11, CustomField12, CustomField13, CustomField14, CustomField15, Size0, Size1, Size2, Size3, Size4, 
				Size5, Size6, Size7, Size8, Size9, Size10, Size11, Sel0, Sel1, Sel2, Sel3, Sel4, Sel5, Sel6, Sel7, Sel8, Sel9, Sel10, Sel11, Pc1, Pc2, Pc3, Pc4, CUser, 
				CDate, MUser, MDate, Active, Change, Action, NoColorCombo,
				CustomField16, CustomField17, CustomField18, CustomField19, CustomField20, CustomField21, CustomField22,  CustomField23, CustomField24,  CustomField25, 
				CustomField26, CustomField27, CustomField28,  CustomField29,  CustomField30 , @StyleSourcingID
			FROM   dbo.pSampleRequestStyleTemp
			WHERE (SampleRequestGroupID = @SampleRequestGroupID)
			IF @@ERROR <> 0
			BEGIN
			ROLLBACK TRANSACTION
			RETURN
			END	
		END			

		BEGIN
			
			INSERT INTO dbo.pSampleRequestMaterial
				(SampleRequestTradeID, SampleRequestWorkflowID, Submit, StartDate, RecDate, DueDate, EndDate, Status, SampleWorkflowID, StyleID, 
				StyleColorID, StyleSet, WorkflowID, TradePartnerVendorID, StyleMaterialID, MainMaterial, Development, MiscColor, UOM, Qty, MaterialPrice, Ext, MaterialSize, 
				MaterialID, MaterialPlacement, MaterialPlacementCode, MaterialPlacementDetail, MaterialImageID, MaterialImageVersion, NoColorMatch, SupplierID, 
				ComponentTypeID, MaterialType, MaterialNo, MaterialName, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S, T, U, V, W, X, Y, Z,  Source, Notes, Placement, VendorPrice, 
				VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, DetailYesNo, ImageType, height, width, CDate, CUser, MDate, 
				MUser, MChange, SChange, DChange, CChange, Action, ColorPlacement, Artwork, License, Colorway, MaterialComment)
			SELECT  @SampleRequestTradeID AS SampleRequestTradeID, dbo.pSampleRequestWorkflow.SampleRequestWorkflowID, 
				dbo.pSampleRequestMaterialTemp.Submit, dbo.pSampleRequestMaterialTemp.StartDate, dbo.pSampleRequestMaterialTemp.RecDate, 
				dbo.pSampleRequestMaterialTemp.DueDate, dbo.pSampleRequestMaterialTemp.EndDate, dbo.pSampleRequestMaterialTemp.Status, 
				dbo.pSampleRequestMaterialTemp.SampleWorkflowID, dbo.pSampleRequestMaterialTemp.StyleID, dbo.pSampleRequestMaterialTemp.StyleColorID, 
				dbo.pSampleRequestMaterialTemp.StyleSet, dbo.pSampleRequestMaterialTemp.WorkflowID, dbo.pSampleRequestMaterialTemp.TradePartnerVendorID, 
				dbo.pSampleRequestMaterialTemp.StyleMaterialID, dbo.pSampleRequestMaterialTemp.MainMaterial, 
				dbo.pSampleRequestMaterialTemp.Development, dbo.pSampleRequestMaterialTemp.MiscColor, dbo.pSampleRequestMaterialTemp.UOM, 
				dbo.pSampleRequestMaterialTemp.Qty, dbo.pSampleRequestMaterialTemp.MaterialPrice, dbo.pSampleRequestMaterialTemp.Ext, 
				dbo.pSampleRequestMaterialTemp.MaterialSize, dbo.pSampleRequestMaterialTemp.MaterialID, 
				dbo.pSampleRequestMaterialTemp.MaterialPlacement, dbo.pSampleRequestMaterialTemp.MaterialPlacementCode, 
				dbo.pSampleRequestMaterialTemp.MaterialPlacementDetail, dbo.pSampleRequestMaterialTemp.MaterialImageID, 
				dbo.pSampleRequestMaterialTemp.MaterialImageVersion, dbo.pSampleRequestMaterialTemp.NoColorMatch, 
				dbo.pSampleRequestMaterialTemp.SupplierID, dbo.pSampleRequestMaterialTemp.ComponentTypeID, 
				dbo.pSampleRequestMaterialTemp.MaterialType, dbo.pSampleRequestMaterialTemp.MaterialNo, dbo.pSampleRequestMaterialTemp.MaterialName, 
				dbo.pSampleRequestMaterialTemp.A, dbo.pSampleRequestMaterialTemp.B, dbo.pSampleRequestMaterialTemp.C, 
				dbo.pSampleRequestMaterialTemp.D, dbo.pSampleRequestMaterialTemp.E, dbo.pSampleRequestMaterialTemp.F, 
				dbo.pSampleRequestMaterialTemp.G, dbo.pSampleRequestMaterialTemp.H, dbo.pSampleRequestMaterialTemp.I, 
				dbo.pSampleRequestMaterialTemp.J, dbo.pSampleRequestMaterialTemp.K, dbo.pSampleRequestMaterialTemp.L, 
				dbo.pSampleRequestMaterialTemp.M, dbo.pSampleRequestMaterialTemp.N, dbo.pSampleRequestMaterialTemp.O, 
				dbo.pSampleRequestMaterialTemp.P, dbo.pSampleRequestMaterialTemp.Q, dbo.pSampleRequestMaterialTemp.R, 
				dbo.pSampleRequestMaterialTemp.S,  dbo.pSampleRequestMaterialTemp.T, dbo.pSampleRequestMaterialTemp.U, 
				dbo.pSampleRequestMaterialTemp.V, dbo.pSampleRequestMaterialTemp.W, dbo.pSampleRequestMaterialTemp.X, 
				dbo.pSampleRequestMaterialTemp.Y, dbo.pSampleRequestMaterialTemp.Z ,
				dbo.pSampleRequestMaterialTemp.Source, dbo.pSampleRequestMaterialTemp.Notes, 
				dbo.pSampleRequestMaterialTemp.Placement, dbo.pSampleRequestMaterialTemp.VendorPrice, dbo.pSampleRequestMaterialTemp.VolumePrice, 
				dbo.pSampleRequestMaterialTemp.VolumePriceMinimum, dbo.pSampleRequestMaterialTemp.VendorProductionMin, 
				dbo.pSampleRequestMaterialTemp.VendorProductionLeadTime, dbo.pSampleRequestMaterialTemp.DetailYesNo, 
				dbo.pSampleRequestMaterialTemp.ImageType, dbo.pSampleRequestMaterialTemp.height, dbo.pSampleRequestMaterialTemp.width, 
				dbo.pSampleRequestMaterialTemp.CDate, dbo.pSampleRequestMaterialTemp.CUser, dbo.pSampleRequestMaterialTemp.MDate, 
				dbo.pSampleRequestMaterialTemp.MUser, dbo.pSampleRequestMaterialTemp.MChange, dbo.pSampleRequestMaterialTemp.SChange, 
				dbo.pSampleRequestMaterialTemp.DChange, dbo.pSampleRequestMaterialTemp.CChange, dbo.pSampleRequestMaterialTemp.Action, 
				dbo.pSampleRequestMaterialTemp.ColorPlacement, dbo.pSampleRequestMaterialTemp.Artwork, dbo.pSampleRequestMaterialTemp.License, 
				dbo.pSampleRequestMaterialTemp.Colorway, dbo.pSampleRequestMaterialTemp.MaterialComment
			FROM  dbo.pSampleRequestMaterialTemp INNER JOIN
				dbo.pSampleRequestWorkflow ON dbo.pSampleRequestMaterialTemp.StyleID = dbo.pSampleRequestWorkflow.StyleID AND 
				dbo.pSampleRequestMaterialTemp.StyleColorID = dbo.pSampleRequestWorkflow.StyleColorID AND 
				dbo.pSampleRequestMaterialTemp.StyleSet = dbo.pSampleRequestWorkflow.StyleSet AND 
				dbo.pSampleRequestMaterialTemp.SampleWorkflowID = dbo.pSampleRequestWorkflow.SampleWorkflowID
			WHERE (dbo.pSampleRequestMaterialTemp.SampleRequestGroupID = @SampleRequestGroupID)
			IF @@ERROR <> 0
			BEGIN
			ROLLBACK TRANSACTION
			RETURN
			END	
		END		
		
	END

	SET NOCOUNT OFF		
	
COMMIT TRANSACTION






/******************************************************************************************************************/
/******************************************************************************************************************/
/******************************************************************************************************************/
/******************************************************************************************************************/




set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_ColorPalette_DELETE]'
GO

ALTER PROCEDURE [dbo].[spx_ColorPalette_DELETE]
(@ColorPaletteId  uniqueidentifier
)
AS 


DECLARE @Msg NVARCHAR(4000)
SET @Msg  = ''

IF ( SELECT COUNT(*) FROM pStyleColorway WHERE ColorPaletteID  = @ColorPaletteId ) > 0
	SET @Msg = 'Color is in use as a stylecolorway' 
ELSE IF ( SELECT COUNT(*) FROM pMaterialColor WHERE ColorPaletteID  = @ColorPaletteId) > 0
	SET @Msg = 'Color is in use in a Material' 
ELSE IF ( SELECT COUNT(*) FROM pLinePlanColor WHERE ColorPaletteID  = @ColorPaletteId) > 0	
	SET @Msg = 'Color is in use in a LinePlan' 

IF LEN(@Msg) = 0
BEGIN 

	DELETE FROM ColorLibrary WHERE ColorPaletteID  = @ColorPaletteId
	DELETE FROM pColorPalette WHERE ColorPaletteID  = @ColorPaletteId

END 


SELECT @Msg as Msg
 


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_Material_Where_SELECT]'
GO
SET QUOTED_IDENTIFIER OFF
GO



CREATE PROCEDURE dbo.spx_Material_Where_SELECT(
@MaterialID UNIQUEIDENTIFIER, 
@TeamID UNIQUEIDENTIFIER 
) 
AS 


	SELECT a.MaterialID, a.MChange 
    FROM pStyleMaterials a , pStyleHeader b  
    WHERE a.StyleID = b.StyleID 
	AND b.StyleType IN ( 
		SELECT StyleTypeID FROM sAccessStyleFolder 
		WHERE ( AccessRoleId =3 OR AccessView = 1 )  
		AND TeamId = @TeamId  
	) 
    GROUP BY a.MChange, a.MaterialID
    HAVING a.MaterialID = @MaterialID  
    ORDER BY a.MChange DESC 

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Fix_SampleRequest_Comments]'
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[spx_Fix_SampleRequest_Comments]
AS



DECLARE @SampleRequestTradeID uniqueidentifier 
DECLARE @SampleRequestWorkflowID uniqueidentifier 
DECLARE @SampleWorkflowID VARCHAR (20) 
DECLARE @Submit int 
DECLARE @StyleID uniqueidentifier 
DECLARE @StyleSet int
DECLARE @CUser nvarchar (200)
DECLARE @CDate datetime	
DECLARE @MUser nvarchar (200) 
DECLARE @MDate datetime 
DECLARE @VendorComment  varchar (8000)
DECLARE @InternalComment  varchar (8000)
DECLARE @CTeamID  uniqueidentifier 


DECLARE cursor_comments  CURSOR for 
select   SampleRequestTradeID , SampleRequestWorkflowID , SampleWorkflowID , Submit,  StyleID, StyleSet ,
CUser, CDate,  MUser, MDate  , Cast ( VendorComment  as varchar(8000) ) as VendorComment , Cast (InternalComment as varchar (8000)) as InternalComment
from pSampleRequestSubmit WITH (NOLOCK)  where 
Datalength ( VendorComment ) > 0 OR  Datalength (InternalComment ) > 0 
open cursor_comments 


FETCH NEXT FROM cursor_comments INTO   @SampleRequestTradeID , @SampleRequestWorkflowID , @SampleWorkflowID , @Submit,  @StyleID, @StyleSet ,
@CUser, @CDate,  @MUser, @MDate , @VendorComment, @InternalComment


declare @cont as int  
set @cont = 0 
WHILE @@FETCH_STATUS  = 0 
BEGIN

	Set  @CTeamID   = null 
	select  @CTeamID = TeamID  from users WITH (NOLOCK) WHERE FirstName + ' ' + LastName = @CUser

	set @cont = @cont + 1 

	--print  '-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------'
	--print 'Comment_'  +  Cast (  @cont  as varchar (10) ) 

	-- internal comment 
	IF len ( @InternalComment ) > 0 
	BEGIN
	--	print  'internal_' +   Cast (  @cont  as varchar (10) )   + ' = ' + @InternalComment 
		INSERT INTO pSampleRequestComment  ( SampleRequestCommentID , SampleRequestTradeID , SampleRequestWorkflowID ,  SampleCommentType,  SampleSubmit, StyleID, StyleSet, CTeamID ,  CUser, CDate, MUser, MDate, MChange , SampleRequestComment ) 	
		Values  ( newid() ,   @SampleRequestTradeID , @SampleRequestWorkflowID ,  'I',  @Submit, @StyleID, @StyleSet,  
		@CTeamID ,  @CUser, @CDate, @MUser, @MDate, NULL , @InternalComment ) 	
	END 

	-- Shared Comment 
	IF len ( @VendorComment  ) > 0 
	BEGIN
---		print  'Vendor_'  + Cast (  @cont  as varchar (10) )  + '   = ' + @VendorComment  
		INSERT INTO pSampleRequestComment  ( SampleRequestCommentID , SampleRequestTradeID , SampleRequestWorkflowID ,  SampleCommentType,  SampleSubmit, StyleID, StyleSet, CTeamID ,  CUser, CDate, MUser, MDate, MChange, SampleRequestComment ) 	
		Values  ( newid() ,   @SampleRequestTradeID , @SampleRequestWorkflowID ,  'S',  @Submit, @StyleID, @StyleSet,  
		@CTeamID,  @CUser, @CDate, @MUser, @MDate, NULL , @VendorComment ) 	
	END 


	FETCH NEXT FROM cursor_comments INTO  @SampleRequestTradeID , @SampleRequestWorkflowID , @SampleWorkflowID , @Submit,  @StyleID, @StyleSet ,
	@CUser, @CDate,  @MUser, @MDate  , @VendorComment, @InternalComment

END 

CLOSE  cursor_comments
DEALLOCATE cursor_comments









GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_ColorLogic_UPDATE]'
GO

/* 
Comment #01 - Clay Parker Oct 13 2009 - Modified Update after Material to also update pstylecolorway 
		to update the StyleColorNo, StyleColorName, and MainColor Fields when a color chips code and name have 
		been modified in a palette.
*/

ALTER PROCEDURE [dbo].[spx_ColorLogic_UPDATE](
@ColorPaletteID UNIQUEIDENTIFIER ,
@MUser NVARCHAR (200),
@MDate DATETIME 
)
AS 

DECLARE @ColorCode NVARCHAR (200) 
DECLARE @ColorName NVARCHAR (200) 
DECLARE @Sort NVARCHAR(10) 



SELECT 	@ColorCode = ColorCode, @ColorName = ColorName , @Sort = Sort
FROM pColorPalette 
WHERE ColorPaletteID = @ColorPaletteID

DECLARE @nSort INT 


BEGIN TRY
	SET @nSort  =  CAST ( @Sort AS INT ) 
END TRY
BEGIN CATCH
	SET @nSort = 0 
END CATCH 

DECLARE @SortTmp NVARCHAR(15) 

SET @SortTmp = '0000' + CAST(@nSort as NVARCHAR(10))
SET @SortTmp = RIGHT( @SortTmp , 4) 


UPDATE pColorPalette SET Sort = @SortTmp WHERE ColorPaletteID = @ColorPaletteID

UPDATE pMaterialColor SET   ColorCode  = @ColorCode, 
ColorName = @ColorName, 	MUser = @MUser, MDate = @MDate 
WHERE ColorPaletteID = @ColorPaletteID 

-- UPDATE Style Colorway -- #01

UPDATE pStyleColorway Set StyleColorNo = @ColorCode,
StyleColorName = @ColorName, MainColor = @ColorName, MUser = @MUser, MDate = @MDate 
WHERE ColorPaletteID = @ColorPaletteID 

-- UPDATE COLOR LIBRARY

IF (SELECT COUNT(*) FROM ColorLibrary WHERE ColorPaletteID = @ColorPaletteID) = 0
BEGIN

		INSERT INTO ColorLibrary(PantoneType, PantoneNumber, PantoneName, Hex, R, G, B, C, M, Y, K, H, S, L, 
			LAB_L, LAB_A, LAB_B, CUser, CDate, MUser, MDate, ColorPaletteID, ColorSource)
		SELECT 'Burberry Default' AS ColorType, ColorCode, ColorName, Hex, R, G, B, C, M, Y, K, H, S, L, 
			LAB_L, LAB_A, LAB_B, CUser, CDate, MUser, MDate, ColorPaletteId, ColorSource 
		FROM pColorPalette WHERE ColorPaletteID = @ColorPaletteId

END
ELSE
BEGIN

		UPDATE ColorLibrary SET 
			PantoneNumber = b.ColorCode, PantoneName = b.ColorName, Hex = RIGHT(b.Hex,6)  , 
			R = b.R, G = b.G, B = b.B, C = b.C, M = b.M, 
			Y = b.Y, K = b.K, H = b.H, S = b.S, L = b.L, 
			LAB_L = b.Lab_L, LAB_A = b.LAB_A, LAB_B = b.LAB_B, 
			MUser = b.MUser, MDate = b.MDate , ColorSource = b.ColorSource
		FROM ColorLibrary a
		INNER JOIN pColorPalette b ON b.ColorPaletteID = a.ColorPaletteID
		WHERE b.ColorPaletteID = @ColorPaletteId 
		AND  a.PantoneType = 'Burberry Default'

END







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialRequestTemp_CREATE_INSERT]'
GO




ALTER PROCEDURE [dbo].[spx_MaterialRequestTemp_CREATE_INSERT] (
@MaterialRequestGroupID UNIQUEIDENTIFIER,
@CUser NVARCHAR(200), 
@CDate DATETIME  
)
AS

DECLARE @Row_V INT 
DECLARE @Total_V INT 

DECLARE @Row_C INT 
DECLARE @Total_C INT 

DECLARE @TradePartnerVendorID  UNIQUEIDENTIFIER 
DECLARE @MaterialTradePartnerID UNIQUEIDENTIFIER
DECLARE @MaterialID UNIQUEIDENTIFIER
DECLARE @MaterialSizeID UNIQUEIDENTIFIER

DECLARE @MaterialRequestWorkflowTempID UNIQUEIDENTIFIER  
DECLARE @MaterialRequestWorkflowStartDate DATETIME
DECLARE @MaterialRequestWorkflowDueDate DATETIME

DECLARE @MaterialColorSeasonYearID UNIQUEIDENTIFIER  
DECLARE @MaterialColorID UNIQUEIDENTIFIER  
DECLARE @SeasonYearID UNIQUEIDENTIFIER  

SELECT @MaterialID =  MaterialID,
@MaterialRequestWorkflowTempID = MaterialRequestWorkflowTempID, 
@MaterialRequestWorkflowStartDate = MaterialRequestWorkflowStartDate,
@MaterialRequestWorkflowDueDate = MaterialRequestWorkflowDueDate,
@SeasonYearID = SeasonYearID
FROM pMaterialRequestTemp
WHERE MaterialRequestGroupID =  @MaterialRequestGroupID




CREATE TABLE  #vendor(
ROW_ID INT IDENTITY  (1,1),
TradePartnerVendorID UNIQUEIDENTIFIER
)

CREATE TABLE #color (
ROW_ID INT IDENTITY  (1,1),
MaterialColorSeasonYearID UNIQUEIDENTIFIER ,
MaterialSizeID UNIQUEIDENTIFIER 
)


INSERT INTO #vendor (TradePartnerVendorID) 
SELECT  TradePartnerVendorID FROM pMaterialRequestAgentVendorTemp WHERE MaterialRequestGroupID = @MaterialRequestGroupID 

INSERT INTO #color (MaterialColorSeasonYearID , MaterialSizeID ) 
SELECT MaterialColorSeasonYearID , MaterialSizeID  FROM pMaterialRequestSeasonColorTemp WHERE MaterialRequestGroupID = @MaterialRequestGroupID 

SELECT @Total_V = COUNT(*) FROM #vendor  
SET @Row_V = 1

SELECT @Total_C = COUNT(*) FROM #color

WHILE @Row_V <= @Total_V
BEGIN 


	SELECT  @TradePartnerVendorID = TradePartnerVendorID  FROM #vendor WHERE ROW_ID = @Row_V

	-- MaterialTradePartner record 
	SET @MaterialTradePartnerID  =  NULL
	
	SELECT @MaterialTradePartnerID = MaterialTradePartnerID 
	FROM pMaterialTradePartner 
	WHERE MaterialID = @MaterialID AND TradePartnerVendorID = @TradePartnerVendorID 
	AND SeasonYearID = @SeasonYearID


	IF  @MaterialTradePartnerID IS NULL 
	BEGIN

		SET @MaterialTradePartnerID = NEWID()



		 -- INSERT Material - Vendor 
		INSERT INTO pMaterialTradePartner  (MaterialTradePartnerID , MaterialID, TradePartnerID , TradePartnerVendorID , 
		CUser, CDate, MUser, Mdate,  MaterialRequestWorkflowTempID , MaterialRequestWorkflowStartDate, MaterialRequestWorkflowDueDate, SeasonYearID ) 
		SELECT @MaterialTradePartnerID, @MaterialID , uTradePartnerVendor.TradePartnerID,  @TradePartnerVendorID,
		@CUser, @CDate, @CUser, @CDate, @MaterialRequestWorkflowTempID , @MaterialRequestWorkflowStartDate, @MaterialRequestWorkflowDueDate, @SeasonYearID
		FROM uTradePartnerVendor 
		WHERE TradePartnerVendorID = @TradePartnerVendorID

		--LOGIC: It will copy all the values from a prev. season 
		DECLARE @tmpMaterialTradePartnerId uniqueidentifier, 
			@tmpMaterialId uniqueidentifier, 
			@tmpTradepartnerId uniqueidentifier, 
			@tmpTradepartnerVendorId uniqueidentifier, 
			@tmpMaterialTradePartnerCustom1 nvarchar(200), 
			@tmpMaterialTradePartnerCustom2 nvarchar(200), 
			@tmpMaterialTradePartnerCustom3 nvarchar(200), 
			@tmpMaterialTradePartnerCustom4 nvarchar(200), 
			@tmpMaterialTradePartnerCustom5 nvarchar(200), 
			@tmpMaterialTradePartnerCustom6 nvarchar(200), 
			@tmpMaterialTradePartnerCustom7 nvarchar(200), 
			@tmpMaterialTradePartnerCustom8 nvarchar(200), 
			@tmpMaterialTradePartnerCustom9 nvarchar(200), 
			@tmpMaterialTradePartnerCustom10 nvarchar(200), 
			@tmpMaterialTradePartnerCustom11 nvarchar(200), 
			@tmpMaterialTradePartnerCustom12 nvarchar(200), 
			@tmpMaterialTradePartnerCustom13 nvarchar(200), 
			@tmpMaterialTradePartnerCustom14 nvarchar(200), 
			@tmpMaterialTradePartnerCustom15 nvarchar(200), 
			@tmpMaterialTradePartnerCustom16 nvarchar(200), 
			@tmpMaterialTradePartnerCustom17 nvarchar(200), 
			@tmpMaterialTradePartnerCustom18 nvarchar(200), 
			@tmpMaterialTradePartnerCustom19 nvarchar(200), 
			@tmpMaterialTradePartnerCustom20 nvarchar(200), 
			@tmpMaterialTradePartnerCustom21 nvarchar(200), 
			@tmpMaterialTradePartnerCustom22 nvarchar(200), 
			@tmpMaterialTradePartnerCustom23 nvarchar(200), 
			@tmpMaterialTradePartnerCustom24 nvarchar(200), 
			@tmpMaterialTradePartnerCustom25 nvarchar(200), 
			@tmpMaterialRequestWorkflowTempID uniqueidentifier 


		SELECT TOP 1 
			@tmpMaterialTradePartnerId = pMaterialTradePartner.MaterialTradePartnerId, 
			@tmpMaterialId = pMaterialTradePartner.MaterialId, 
			@tmpTradepartnerId = pMaterialTradePartner.TradepartnerId, 
			@tmpTradepartnerVendorId = pMaterialTradePartner.TradepartnerVendorId, 
			@tmpMaterialTradePartnerCustom1 = pMaterialTradePartner.MaterialTradePartnerCustom1, 
			@tmpMaterialTradePartnerCustom2 = pMaterialTradePartner.MaterialTradePartnerCustom2, 
			@tmpMaterialTradePartnerCustom3 = pMaterialTradePartner.MaterialTradePartnerCustom3, 
			@tmpMaterialTradePartnerCustom4 = pMaterialTradePartner.MaterialTradePartnerCustom4, 
			@tmpMaterialTradePartnerCustom5 = pMaterialTradePartner.MaterialTradePartnerCustom5, 
			@tmpMaterialTradePartnerCustom6 = pMaterialTradePartner.MaterialTradePartnerCustom6, 
			@tmpMaterialTradePartnerCustom7 = pMaterialTradePartner.MaterialTradePartnerCustom7, 
			@tmpMaterialTradePartnerCustom8 = pMaterialTradePartner.MaterialTradePartnerCustom8, 
			@tmpMaterialTradePartnerCustom9 = pMaterialTradePartner.MaterialTradePartnerCustom9, 
			@tmpMaterialTradePartnerCustom10 = pMaterialTradePartner.MaterialTradePartnerCustom10, 
			@tmpMaterialTradePartnerCustom11 = pMaterialTradePartner.MaterialTradePartnerCustom11, 
			@tmpMaterialTradePartnerCustom12 = pMaterialTradePartner.MaterialTradePartnerCustom12, 
			@tmpMaterialTradePartnerCustom13 = pMaterialTradePartner.MaterialTradePartnerCustom13, 
			@tmpMaterialTradePartnerCustom14 = pMaterialTradePartner.MaterialTradePartnerCustom14, 
			@tmpMaterialTradePartnerCustom15 = pMaterialTradePartner.MaterialTradePartnerCustom15, 
			@tmpMaterialTradePartnerCustom16 = pMaterialTradePartner.MaterialTradePartnerCustom16, 
			@tmpMaterialTradePartnerCustom17 = pMaterialTradePartner.MaterialTradePartnerCustom17, 
			@tmpMaterialTradePartnerCustom18 = pMaterialTradePartner.MaterialTradePartnerCustom18, 
			@tmpMaterialTradePartnerCustom19 = pMaterialTradePartner.MaterialTradePartnerCustom19, 
			@tmpMaterialTradePartnerCustom20 = pMaterialTradePartner.MaterialTradePartnerCustom20, 
			@tmpMaterialTradePartnerCustom21 = pMaterialTradePartner.MaterialTradePartnerCustom21, 
			@tmpMaterialTradePartnerCustom22 = pMaterialTradePartner.MaterialTradePartnerCustom22, 
			@tmpMaterialTradePartnerCustom23 = pMaterialTradePartner.MaterialTradePartnerCustom23, 
			@tmpMaterialTradePartnerCustom24 = pMaterialTradePartner.MaterialTradePartnerCustom24, 
			@tmpMaterialTradePartnerCustom25 = pMaterialTradePartner.MaterialTradePartnerCustom25, 
			@tmpMaterialRequestWorkflowTempID = pMaterialTradePartner.MaterialRequestWorkflowTempID
		FROM pMaterialTradePartner INNER JOIN
			  pSeasonYear ON pMaterialTradePartner.SeasonYearID = pSeasonYear.SeasonYearID
		WHERE pMaterialTradePartner.TradePartnerVendorID = @TradePartnerVendorID AND pMaterialTradePartner.MaterialID = @MaterialID
		ORDER BY pSeasonYear.Sort DESC

		UPDATE pMaterialTradePartner SET 			
			MaterialTradePartnerCustom1 = @tmpMaterialTradePartnerCustom1, 
			MaterialTradePartnerCustom2 = @tmpMaterialTradePartnerCustom2, 
			MaterialTradePartnerCustom3 = @tmpMaterialTradePartnerCustom3, 
			MaterialTradePartnerCustom4 = @tmpMaterialTradePartnerCustom4, 
			MaterialTradePartnerCustom5 = @tmpMaterialTradePartnerCustom5, 
			MaterialTradePartnerCustom6 = @tmpMaterialTradePartnerCustom6, 
			MaterialTradePartnerCustom7 = @tmpMaterialTradePartnerCustom7, 
			MaterialTradePartnerCustom8 = @tmpMaterialTradePartnerCustom8, 
			MaterialTradePartnerCustom9 = @tmpMaterialTradePartnerCustom9, 
			MaterialTradePartnerCustom10 = @tmpMaterialTradePartnerCustom10, 
			MaterialTradePartnerCustom11 = @tmpMaterialTradePartnerCustom11, 
			MaterialTradePartnerCustom12 = @tmpMaterialTradePartnerCustom12, 
			MaterialTradePartnerCustom13 = @tmpMaterialTradePartnerCustom13, 
			MaterialTradePartnerCustom14 = @tmpMaterialTradePartnerCustom14, 
			MaterialTradePartnerCustom15 = @tmpMaterialTradePartnerCustom15, 
			MaterialTradePartnerCustom16 = @tmpMaterialTradePartnerCustom16, 
			MaterialTradePartnerCustom17 = @tmpMaterialTradePartnerCustom17, 
			MaterialTradePartnerCustom18 = @tmpMaterialTradePartnerCustom18, 
			MaterialTradePartnerCustom19 = @tmpMaterialTradePartnerCustom19, 
			MaterialTradePartnerCustom20 = @tmpMaterialTradePartnerCustom20, 
			MaterialTradePartnerCustom21 = @tmpMaterialTradePartnerCustom21, 
			MaterialTradePartnerCustom22 = @tmpMaterialTradePartnerCustom22, 
			MaterialTradePartnerCustom23 = @tmpMaterialTradePartnerCustom23, 
			MaterialTradePartnerCustom24 = @tmpMaterialTradePartnerCustom24, 
			MaterialTradePartnerCustom25 = @tmpMaterialTradePartnerCustom25, 
			MaterialRequestWorkflowTempID = @tmpMaterialRequestWorkflowTempID
		WHERE MaterialTradePartnerId = @MaterialTradePartnerId

	
	END

	

	--********************************************************
	-- insert colors
	SET @Row_C = 1 	

	WHILE @Row_C <= @Total_C
	BEGIN
		SELECT @MaterialColorSeasonYearID = a.MaterialColorSeasonYearID, @MaterialSizeID = a.MaterialSizeID,
		@MaterialColorID  = b.MaterialColorID 
		FROM  #color a
		INNER JOIN pMaterialColorSeasonYear b ON a.MaterialColorSeasonYearID = b.MaterialColorSeasonYearID
		WHERE ROW_ID = @Row_C 


		IF (  SELECT COUNT(*) FROM pMaterialTradePartnerColor
			WHERE MaterialTradePartnerID = @MaterialTradePartnerID AND MaterialSizeID = @MaterialSizeID
			AND MaterialColorID  = @MaterialColorID  ) = 0 
		BEGIN 
			
			DECLARE @MaterialTradePartnerColorID UNIQUEIDENTIFIER 
			SET @MaterialTradePartnerColorID = NEWID() 

			--SELECT * FROM dbo.pMaterialTradePartnerColor
			INSERT INTO pMaterialTradePartnerColor ( MaterialTradePartnerColorID , MaterialTradePartnerID , MaterialColorID , 
			MaterialID , ColorFolderID , ColorPaletteID , ColorName, ColorSource, VendorColorName, 
			Hex, R, G, B, H, S, L,
			CDate, CUser, MDate, MUser,  MaterialColorVersion ,  ColorVersion, MaterialSizeID ) 
			SELECT  @MaterialTradePartnerColorID AS MaterialTradePartnerColorID,	@MaterialTradePartnerID , a.MaterialColorID ,	 
			a.MaterialID , b.ColorFolderID , b.ColorPaletteID ,  b.ColorName, b.ColorSource, b.VendorColorName,  
			b.Hex, b.R, b.G, b.B, b.H, b.S, b.L, 
			@CDate, @CUser, @CDate, @CUser, 1, 0 , @MaterialSizeID 
			FROM pMaterialColorSeasonYear a
			INNER JOIN  pMaterialColor b ON a.MaterialColorID  = b.MaterialColorID
			WHERE MaterialColorSeasonYearID  = @MaterialColorSeasonYearID 

			EXEC dbo.spx_MaterialRequestSubmitWorkflowLogic_UPDATE @MaterialTradePartnerID = @MaterialTradePartnerID,
			@MaterialTradePartnerColorID = @MaterialTradePartnerColorID

		END 

		SET @Row_C  = @Row_C  + 1 
	END 
	--********************************************************

	SET @Row_V = @Row_V + 1 
END 


DROP TABLE  #vendor
DROP TABLE #color 

DELETE FROM pMaterialRequestTemp WHERE MaterialRequestGroupID = @MaterialRequestGroupID 
DELETE FROM pMaterialRequestSeasonColorTemp WHERE MaterialRequestGroupID = @MaterialRequestGroupID 
DELETE FROM pMaterialRequestAgentVendorTemp WHERE MaterialRequestGroupID = @MaterialRequestGroupID 







	







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_MaterialTradePartnerSEARCH]'
GO
EXEC sp_refreshview N'[dbo].[vwx_MaterialTradePartnerSEARCH]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[iCustom2]'
GO
ALTER TABLE [dbo].[iCustom2] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_iCustom2_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_iCustom2] on [dbo].[iCustom2]'
GO
ALTER TABLE [dbo].[iCustom2] ADD CONSTRAINT [PK_iCustom2] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleColorwayITEMS_SELECT]'
GO
SET QUOTED_IDENTIFIER OFF
GO


/*
Comments:

#01 - Ryan Cabanas (for Artemio Gomez) - September 10, 2009
	There is sometimes a problem with the 'MaterialID' values stored in the 'pStyleColorWayItem' table.
To ensure that the proper 'MaterialID' is retrieved, need to make sure that the 'MaterialID' value is
grabbed from the 'pMaterial' and 'pMaterialColor' tables in the JOINS used below.

#02 - Artemio Gomez -  For Colorways, it doesn't matter what's the StyleSet. In a style with 2 sets, set 1 and 2 have the 
	same colorways.
*/


ALTER PROCEDURE [dbo].[spx_StyleColorwayITEMS_SELECT] (
@StyleID UNIQUEIDENTIFIER ,
@StyleSet INT,
@SeasonYearID NVARCHAR(50)= NULL
)
AS 

DECLARE @TOTAL INT
DECLARE @ROW1 INT 
DECLARE @ROW2 INT 

CREATE TABLE #tmpStyleColorway (
Rec_ID INT IDENTITY (1,1) ,
StyleColorID UNIQUEIDENTIFIER , 
StyleColorNo NVARCHAR(50) , 
StyleColorName NVARCHAR(200) ,
MainColor NVARCHAR(100),
SAPCode NVARCHAR(50) , 
PLMCode NVARCHAR(200)
)



IF @SeasonYearID IS NOT NULL AND LEN(@SeasonYearID) > 0
BEGIN 

	DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER 

	SELECT @StyleSeasonYearID  = StyleSeasonYearID 
	FROM pStyleSeasonYear
	WHERE SeasonYearID = @SeasonYearID AND StyleID = @StyleID 

	INSERT INTO #tmpStyleColorway (StyleColorID , StyleColorNo, StyleColorName, MainColor, SAPCode , PLMCode)
	
	SELECT b.StyleColorID , b.StyleColorNo, c.ColorName, c.ColorName, b.SAPCode, b.PLMCode 
	FROM pStyleColorwaySeasonYear a 
	INNER JOIN pStyleColorway b ON a.StyleColorwayID = b.StyleColorID
	INNER JOIN pColorPalette c ON c.ColorPaletteID = b.ColorPaletteID 
	WHERE  a.StyleID = @StyleID
	AND a.StyleSeasonYearID = @StyleSeasonYearID
	--AND b.StyleSet = @StyleSet  #02
	ORDER BY b.Sort, b.MainColor
	
END
ELSE 
BEGIN

	INSERT INTO #tmpStyleColorway (StyleColorID , StyleColorNo, StyleColorName, MainColor, SAPCode , PLMCode)
	SELECT StyleColorID , StyleColorNo, b.ColorName AS StyleColorName, b.ColorName AS MainColor, SAPCode, PLMCode 
	FROM pStyleColorway a 
	INNER JOIN pColorPalette b ON a.ColorPaletteID = b.ColorPaletteID 
	WHERE StyleID = @StyleID 
	--AND StyleSet = @StyleSet #02
	ORDER BY a.Sort, a.MainColor

END



SELECT @TOTAL  = COUNT(*) FROM #tmpStyleColorway 
SET @ROW1 = 1

DECLARE @NUMBER_COLUMNS INT
SET @NUMBER_COLUMNS = 3 

DECLARE @StyleColorID1 UNIQUEIDENTIFIER 
DECLARE @StyleColorID2 UNIQUEIDENTIFIER 
DECLARE @StyleColorID3 UNIQUEIDENTIFIER 

SELECT * FROM #tmpStyleColorway


DECLARE @SQL NVARCHAR(4000)

WHILE @ROW1 <= @TOTAL
BEGIN

	IF @ROW1 + @NUMBER_COLUMNS - 1  >  @TOTAL 
		SET @ROW2  = @TOTAL		
	ELSE
		SET @ROW2 = @ROW1 + @NUMBER_COLUMNS - 1


	SET @StyleColorID1 =  NULL
	SET @StyleColorID2 =  NULL
	SET @StyleColorID3 =  NULL


	SELECT @StyleColorID1 = StyleColorID FROM #tmpStyleColorway WHERE Rec_ID = @Row1
	SELECT @StyleColorID2 = StyleColorID FROM #tmpStyleColorway WHERE Rec_ID = @Row1 + 1 
	SELECT @StyleColorID3 = StyleColorID FROM #tmpStyleColorway WHERE Rec_ID = @Row1 + 2 


	IF	@StyleColorID1 IS NOT NULL 
	BEGIN
		SELECT d.MaterialNo, d.MaterialName , d.MainMaterial, e.MultiDimension , d.StyleMaterialID, d.MaterialType, d.Placement, 
		e.MaterialID AS MaterialID1, a.StyleColorItemID AS StyleColorItemID1, a.StyleMaterialID AS StyleMaterialID1 , a.MaterialColorID  AS MaterialColorID1 ,		--Comment #01
		b.MaterialColorImageID AS MaterialColorImageID1 , b.MaterialColorImageVersion AS MaterialColorImageVersion1, b.ColorFolderId AS ColorFolderId1,  b.ColorPaletteID AS ColorPaletteID1, 
		CASE 
			WHEN b.ColorCode IS NULL THEN ''
			ELSE b.ColorCode 
		END 
		AS ColorCode1, b.ColorName AS ColorName1,
		b.MaterialColorNote AS MaterialColorNote1 , d.MaterialSort, f.ComponentOrder
		INTO #tmp1
		FROM pStyleColorWayItem  a LEFT OUTER  JOIN  pMaterialColor b ON a.MaterialColorID = b.MaterialColorID 
		INNER JOIN pStyleMaterials d ON d.StyleMaterialID  =  a.StyleMaterialID  
		INNER JOIN pMaterial e ON d.MaterialID = e.MaterialID 
		INNER JOIN pComponentType f ON d.MaterialType = f.ComponentTypeID 
		WHERE a.StyleColorID = @StyleColorID1
		AND a.StyleSet = @StyleSet 
	END


	IF	@StyleColorID2 IS NOT NULL 
	BEGIN
		SELECT b.MaterialID AS MaterialID2, a.StyleColorItemID AS StyleColorItemID2, a.StyleMaterialID AS StyleMaterialID2 , a.MaterialColorID  AS MaterialColorID2 ,	--Comment #01
		b.MaterialColorImageID AS MaterialColorImageID2 , b.MaterialColorImageVersion AS MaterialColorImageVersion2, b.ColorFolderId AS ColorFolderId2,  b.ColorPaletteID AS ColorPaletteID2, 
		CASE 
			WHEN b.ColorCode IS NULL THEN ''
			ELSE b.ColorCode 
		END 
		AS ColorCode2, b.ColorName AS ColorName2, 
		b.MaterialColorNote AS MaterialColorNote2
		INTO #tmp2
		FROM pStyleColorWayItem  a LEFT OUTER  JOIN  pMaterialColor b ON a.MaterialColorID = b.MaterialColorID 
		WHERE a.StyleColorID = @StyleColorID2
		AND a.StyleSet = @StyleSet 
	END 


	IF @StyleColorID3 IS NOT NULL
	BEGIN 
		SELECT b.MaterialID AS MaterialID3, a.StyleColorItemID AS StyleColorItemID3, a.StyleMaterialID AS StyleMaterialID3 , a.MaterialColorID  AS MaterialColorID3 ,		--Comment #01
		b.MaterialColorImageID AS MaterialColorImageID3 , b.MaterialColorImageVersion AS MaterialColorImageVersion3, b.ColorFolderId AS ColorFolderId3,  b.ColorPaletteID AS ColorPaletteID3, 
		CASE 
			WHEN b.ColorCode IS NULL THEN ''
			ELSE b.ColorCode 
		END 
		AS ColorCode3, b.ColorName AS ColorName3, 
		b.MaterialColorNote AS MaterialColorNote3
		INTO #tmp3
		FROM pStyleColorWayItem  a LEFT OUTER  JOIN  pMaterialColor b ON a.MaterialColorID = b.MaterialColorID 
		WHERE a.StyleColorID = @StyleColorID3	
		AND a.StyleSet = @StyleSet 
	END


	IF @StyleColorID3 IS NOT NULL 
	BEGIN 
			select a.*, b.*, c.*
			from #tmp1 a INNER JOIN #tmp2  b ON a.StyleMaterialID1 = b.StyleMaterialID2  
			INNER JOIN #tmp3 c ON a.StyleMaterialID1 = c.StyleMaterialID3  
			ORDER BY a.MainMaterial DESC, a.ComponentOrder, 
			a.MaterialSort, a.MaterialNo, a.MaterialName, a.StyleMaterialId  

			DROP TABLE  #tmp1
			DROP TABLE  #tmp2
			DROP TABLE  #tmp3
	END
	ELSE 
	BEGIN 

		IF ( @StyleColorID1 IS NOT NULL ) AND ( @StyleColorID2 IS NOT NULL  ) 
		BEGIN
			select a.*, b.*
			from #tmp1 a INNER JOIN #tmp2  b ON a.StyleMaterialID1 = b.StyleMaterialID2  
			ORDER BY a.MainMaterial DESC, a.ComponentOrder, 
			a.MaterialSort, a.MaterialNo, a.MaterialName, a.StyleMaterialId  

			DROP TABLE  #tmp1
			DROP TABLE  #tmp2
		END 
		ELSE
		BEGIN 
			select a.* 
			from #tmp1 a 
			ORDER BY a.MainMaterial DESC, a.ComponentOrder, 
			a.MaterialSort, a.MaterialNo, a.MaterialName, a.StyleMaterialId  

			DROP TABLE  #tmp1
		END
	END
	SET @ROW1  = @ROW2 + 1 
END 

DROP TABLE #tmpStyleColorway




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcingItem_Logic_UPDATE]'
GO
SET QUOTED_IDENTIFIER ON
GO
/*
Comments: 

#01 - Clay - April 23 2009
	Adding Vendor Ref to the Sourcing Page
*/

ALTER PROCEDURE [dbo].[spx_StyleSourcingItem_Logic_UPDATE]   ( 
@StyleSourcingItemID uniqueidentifier
) 
AS

DECLARE @TradePartnerVendorID UNIQUEIDENTIFIER 
DECLARE @StyleColorID UNIQUEIDENTIFIER 
DECLARE @StyleMaterialID  UNIQUEIDENTIFIER 
DECLARE @MaterialSizeID UNIQUEIDENTIFIER 
DECLARE @MaterialColorID UNIQUEIDENTIFIER 
DECLARE @MaterialPrice MONEY 
DECLARE @MaterialID UNIQUEIDENTIFIER 
DECLARE @Qty NVARCHAR (50) 

DECLARE @StyleSourcingID UNIQUEIDENTIFIER 
DECLARE @ExchangeRateID  UNIQUEIDENTIFIER 
DECLARE @CurrencyType NVARCHAR(200)
DECLARE @COO NVARCHAR(200)
DECLARE @SeasonYearID UNIQUEIDENTIFIER 

DECLARE @VendorRefNo NVARCHAR(200)	-- Comment #01





SELECT @TradePartnerVendorID  = a.TradePartnerVendorID, @StyleColorID = a.StyleColorID,
@StyleMaterialID  = a.StyleMaterialID, @StyleSourcingID = a.StyleSourcingID, 
@ExchangeRateID  = b.Custom2, @SeasonYearID =  c.SeasonYearID 
FROM pStyleSourcingItem a
INNER JOIN pStyleSourcing b ON a.StyleSourcingID = b.StyleSourcingID 
INNER JOIN pStyleSeasonYear c ON c.StyleSeasonYearID = b.StyleSeasonYearID
WHERE a.StyleSourcingItemID = @StyleSourcingItemID


IF NOT @TradePartnerVendorID IS NULL 
BEGIN

	-- Get MaterialPrice FROM pMaterialTradePartnerColor
	SELECT  @MaterialColorID = a.MaterialColorID, @MaterialSizeID = b.MaterialSizeID,
	@MaterialID = b.MaterialID, @Qty = b.Qty
	FROM pStyleColorwayItem a INNER JOIN  pStyleMaterials b ON a.StyleMaterialID = b.StyleMaterialID
	WHERE a.StylecolorID = @StylecolorID 
	and a.StyleMaterialID = @StyleMaterialID 


	IF @MaterialSizeID IS NULL 
	BEGIN
		SET @MaterialSizeID = '00000000-0000-0000-0000-000000000000'
		UPDATE pStyleMaterials SET MaterialSizeID = '00000000-0000-0000-0000-000000000000' 
		WHERE StyleMaterialID = @StyleMaterialID AND MaterialSizeID IS NULL
	END 



	--SELECT @MaterialPrice = MaterialTradeColor15 FROM pMaterialTradePartnerColor
/*
	SELECT @MaterialPrice = a.MaterialPrice 
	FROM pMaterialTradePartnerColor a
	WHERE a.MaterialColorID = @MaterialColorID 
	AND a.MaterialSizeID = @MaterialSizeID 
	AND a.MaterialTradePartnerID  =  ( 
		SELECT MaterialTradePartnerID  FROM pMaterialTradePartner 
		WHERE MaterialID = @MaterialID  AND TradePartnerVendorID  = @TradePartnerVendorID
	)
*/


	SELECT @MaterialPrice = a.MaterialPrice, 
	@CurrencyType = b.MaterialTradePartnerCustom2 , 
	@COO = b.MaterialTradePartnerCustom3 ,	
	@VendorRefNo = b.MaterialTradePartnerCustom1	-- Comment #01
	FROM pMaterialTradePartnerColor a 
	INNER JOIN pMaterialTradePartner b ON a.MaterialTradePartnerID = b.MaterialTradePartnerID
	WHERE a.MaterialColorID = @MaterialColorID 
	AND a.MaterialSizeID = @MaterialSizeID 
	AND b.TradePartnerVendorID = @TradePartnerVendorID
	AND b.SeasonYearID  = @SeasonYearID


END
ELSE
	SELECT  @MaterialPrice = MaterialPrice,  @Qty = Qty 
	FROM pStyleMaterials WHERE StyleMaterialID = @StyleMaterialID



IF @Qty IS NULL 
	SET @Qty = '0'
IF @MaterialPrice IS NULL
	SET @MaterialPrice = 0 



-- APPLY EXCHANGE RATE TO MaterialPrice 
IF @ExchangeRateID IS NOT NULL AND @CurrencyType IS NOT NULL  -- AND @COO IS NOT NULL 
BEGIN

	DECLARE @Rate DECIMAL(18,3)

	SELECT @Rate = a.Rate  
	FROM sExchangeRateItem a
	WHERE a.ExchangeRateID = @ExchangeRateID
	AND a.CurrencyType  = @CurrencyType
	--AND a.CountryCode =  (SELECT  CountryCode FROM  uCountry WHERE CountryName = @COO)

	IF @Rate IS NOT NULL 
		SET @MaterialPrice = @MaterialPrice / @Rate

END 


UPDATE pStyleSourcingItem  
SET MaterialPrice = @MaterialPrice,
Qty = @Qty,
CustomField1 = @VendorRefNo		-- Comment #01
WHERE StyleSourcingItemID = @StyleSourcingItemID
















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_Style_BOM_SELECT]'
GO
EXEC sp_refreshview N'[dbo].[vwx_Style_BOM_SELECT]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_ColorPalette_Logic_INSERT]'
GO




ALTER PROCEDURE  [dbo].[spx_ColorPalette_Logic_INSERT](
@ColorPaletteID UNIQUEIDENTIFIER, 
@CUser NVARCHAR(200), 
@CDate DATETIME 
)
AS

DECLARE @CorpColor INT 
DECLARE @ColorLibraryTypeID UNIQUEIDENTIFIER
DECLARE @ColorType NVARCHAR(200)

SELECT @CorpColor = c.CorpColor, @ColorLibraryTypeID = c.ColorLibraryTypeID
FROM pColorPalette a 
INNER JOIN pColorFolder b ON a.ColorFolderID = b.ColorFolderID 
INNER JOIN pColorType c ON b.ColorTypeID = c.ColorTypeID 
WHERE ColorPaletteID = @ColorPaletteID


SELECT * FROM ColorLibrary

--IF ( SELECT a.ColorFolderID FROM pColorPalette a WHERE ColorPaletteID = @ColorPaletteID ) = '00000000-0000-0000-0000-000000000001' 
IF @CorpColor = 1  AND @ColorLibraryTypeID IS NOT NULL 
BEGIN
 
	SELECT @ColorType = ColorType FROM ColorType WHERE ColorLibraryTypeID =  @ColorLibraryTypeID 

	IF ( SELECT COUNT(*) FROM ColorLibrary WHERE PantoneType = @ColorType AND  ColorPaletteID = @ColorPaletteID ) = 0
	BEGIN 		
		INSERT INTO ColorLibrary ( PantoneType, PantoneNumber, PantoneName, R, G, B, 
		H, S , L, LAB_L, LAB_B, LAB_A , Hex, Active, CUser, CDate, MUser, MDate, ColorPaletteID , ColorSource, ColorLibraryTypeID  )
		SELECT @ColorType, ColorCode, Colorname, R, G, B,  
		H, S, L, LAB_L, LAB_B, LAB_A, RIGHT(HEX ,6), 1, @CUser, @CDate, @CUser, @CDate, @ColorPaletteID, ColorSource, @ColorLibraryTypeID as ColorLibraryTypeID
		FROM pColorPalette 
		WHERE ColorPaletteID  = @ColorPaletteID

	END 
	ELSE
	BEGIN

		DECLARE @PantoneType NVARCHAR(50)
		DECLARE @PantoneNumber NVARCHAR(50)
		DECLARE @PantoneName NVARCHAR(50)
		DECLARE @R INT
		DECLARE @G INT 
		DECLARE @B INT
		DECLARE @H INT
		DECLARE @S INT
		DECLARE @L INT 
		DECLARE @LAB_L NVARCHAR(10)
		DECLARE @LAB_B NVARCHAR(10)
		DECLARE @LAB_A NVARCHAR(10)
		DECLARE @Hex NVARCHAR(50)
		DECLARE @ColorSource NVARCHAR(50)


		SELECT @PantoneType = @ColorType, @PantoneNumber = ColorCode, 
		@PantoneName = Colorname, @R = R, @G = G, @B = B,  
		@H = H, @S = S, @L = L, @LAB_L = LAB_L, @LAB_A = LAB_A, @LAB_B = LAB_B, 
		@Hex = RIGHT(HEX ,6), @ColorSource = ColorSource
		FROM pColorPalette 
		WHERE ColorPaletteID  = @ColorPaletteID


		UPDATE ColorLibrary 
		SET PantoneNumber = @PantoneNumber, PantoneName = @PantoneName, R = @R, G = @G, B = @B,  
		H = @H, S = @S, L = @L, 
		LAB_L = @LAB_L, LAB_A = @LAB_A, LAB_B = @LAB_B, 
		Hex = RIGHT(@HEX ,6), ColorSource = @ColorSource
		WHERE PantoneType = @ColorType
		AND ColorPaletteID = @ColorPaletteID

	END

END 






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_ImageCatalog_Customer_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.
*/


ALTER  PROCEDURE [dbo].[rpx_ImageCatalog_Customer_SELECT] 	 
	@ImageCatalogID AS varchar(255)
AS


SELECT identity(int,0,1) AS RowNumber, hi.ImageDescription, hi.ImageSubFolder3 AS Customer, 
	hi.ImageSubFolder4 AS Brand, hi.ImageSubFolder5 AS Component, hi.ImageCode AS ProjectNo, 
	(dbo.fnx_GetStreamingImagePath(hi.ImageID, hi.[Version])) AS FilePath,	--Comment #01
	ic.CatalogName, ic.CUser, CONVERT(varchar(20), ic.CDate, 101) AS CDate, ci.ImageSort  
INTO	#TblTemp
FROM	pImageCatalog ic, pImageCatalogItem ci, hImage hi 
WHERE	((ci.ImageCatalogID = ic.ImageCatalogID) AND (ci.ImageID = hi.ImageID) 
	AND (ci.ImageVersion = hi.Version) 
	AND (ic.ImageCatalogID = @ImageCatalogID))
ORDER BY ci.ImageSort, hi.ImageCode 

SELECT	RowNumber % 4 AS Row, ImageDescription, Customer, Brand, Component, ProjectNo, 
	FilePath, CatalogName, CUser, CDate, ImageSort 
FROM #TblTemp ORDER BY ImageSort, ProjectNo

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[View_1]'
GO
EXEC sp_refreshview N'[dbo].[View_1]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LineFolderItemColor_INSERT]'
GO


/************************************************************************************************************************/
/*Comments:																												*/
/*																														*/
/*8/9/07 - Ryan added the LineFolderItemColorDrop entry into the INSERT/SELECT.  It was defaulting to a NULL before,	*/
/*which was causing problems.  Defult it to a 0 now.																	*/
/************************************************************************************************************************/


ALTER  PROCEDURE [dbo].[spx_LineFolderItemColor_INSERT]
(@StyleID uniqueidentifier,
@StyleColorID uniqueidentifier,
@LineFolderItemID uniqueidentifier,
@LineFolderID uniqueidentifier,
@ModifiedDate datetime,
@ModifiedBy nvarchar(200))
AS INSERT INTO dbo.pLineFolderItemColor
                      (LineFolderItemID, LineFolderID, StyleColorID, StyleID, StyleColorStandardID, StyleColorNo, StyleColorName, MainColor, Sort, Version, CDate, CUser, 
                      MDate, MUser, LineFolderItemColorDrop)
SELECT     @LineFolderItemID, @LineFolderID, StyleColorID, StyleID, StyleColorStandardID, StyleColorNo, StyleColorName, MainColor, Sort, Version, CDate, 
                      CUser, @ModifiedDate, @ModifiedBy, 0 AS LineFolderItemColorDrop
FROM         dbo.pStyleColorway WITH (NOLOCK)
WHERE     (StyleID = @StyleID) AND  (StyleColorID = @StyleColorID)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleMaterialSeasonLogic_Linked_UPDATE]'
GO
SET QUOTED_IDENTIFIER OFF
GO



CREATE PROCEDURE [dbo].[spx_StyleMaterialSeasonLogic_Linked_UPDATE]
(
	@StyleID UNIQUEIDENTIFIER,
	@StyleSet INT,
	@CUser NVARCHAR(200),
	@CDate DATETIME
)

AS


/************************/
/*Declare variables.	*/
/************************/
DECLARE @StyleID_Param UNIQUEIDENTIFIER			--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT						--Keep a copy of the original parameter value.

DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	)  ON [PRIMARY]


/*
ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
*/

/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC dbo.spx_StyleMaterialSeasonLogic_UPDATE
			@StyleID_Param
			,@StyleSet_Param
			,@CUser
			,@CDate
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet_Param AS StyleSet
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID
	END


/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Get the 'StyleID' for the update.*/
		SELECT @StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC dbo.spx_StyleMaterialSeasonLogic_UPDATE
			@StyleID
			,@StyleSet
			,@CUser
			,@CDate


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO

PRINT N'Creating [dbo].[spx_ReportMaterialRequestSubmitItem_INSERT]'
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[spx_ReportMaterialRequestSubmitItem_INSERT]
(
	@DataXmlID varchar(40),
	@MaterialRequestWorkflowID varchar(5),
	@MaterialRequestSubmitID varchar(40),
	@DataXmlFile xml
)
AS 

--DECLARE @MaterialRequestWorkflowID varchar(5)
--DECLARE @MaterialRequestSubmitID uniqueidentifier
--DECLARE @DataXmlID varchar(36)

DECLARE @XmlPath varchar(400)
DECLARE @XmlFileName VARCHAR(200)
DECLARE @XmlFolderName varchar(200)

--SET @MaterialRequestSubmitID = '97dc2fc9-74a7-4530-b4fd-edceab1114e5' 
--SET @MaterialRequestWorkflowID = 'A90'
--SET @DataXmlID = newId()


BEGIN
	-- Select Schema File
-- kj	SELECT @XmlFolderName = XmlSchemaPath FROM sSystemServerStorageSetting WHERE CurrentServerStorage = 1
	SELECT @XmlFileName = MaterialRequestWorkflowSchema FROM dbo.pMaterialRequestWorkflow WHERE MaterialRequestWorkflowID = @MaterialRequestWorkflowID
	SELECT @XmlPath = @XmlFolderName + '\' + @XmlFileName
END

BEGIN
	-- Import Schema File to #tmpXmlImportFile
	CREATE TABLE #tmpXmlImportFile(
		[xmlFileName] VARCHAR(300) NULL,
		[xmlData] XML NOT NULL
	)

	INSERT INTO #tmpXmlImportFile([xmlData]) VALUES (@DataXmlFile)

--	EXEC('INSERT INTO #tmpXmlImportFile(xmlFileName, xmlData)
--		SELECT ''' + @XmlPath + ''', xmlData
--		FROM(
--		SELECT *
--		FROM OPENROWSET (BULK ''' + @XmlPath + ''' , SINGLE_BLOB) AS XMLDATA
--		) AS FileImport (XMLDATA)
--		')
END

BEGIN
	-- Import table schema values to #tmpXmlDocTable
	CREATE TABLE #tmpXmlDocTable(
					[XmlDocId] [int] IDENTITY(1,1) NOT NULL,
					[Name] [nvarchar](200) NULL,
					[Alias] [nvarchar](200) NULL,	
					[Type] varchar(200),
					[datatype] varchar(200),
					[lookupquery] varchar(800),
					[ValueField] varchar(200),
					[Visible] [varchar](5) NULL,
					[CDate] [datetime])


	DECLARE @idoc int
	DECLARE @doc XML
	SELECT @doc = xmlData FROM #tmpXmlImportFile

	EXEC sp_xml_preparedocument @idoc OUTPUT, @doc
	INSERT INTO #tmpXmlDocTable([Name], alias, Visible, CDate, [Type], datatype, lookupquery, ValueField)
	SELECT [Name], alias, Visible, getdate(), [Type], datatype, lookupquery, ValueField
	FROM       OPENXML (@idoc, '/Table/column',1)
				WITH (	[Name]  varchar(200),
						alias varchar(200),
						[Type] varchar(200),
						datatype varchar(200),
						lookupquery varchar(800),
						ValueField varchar(200),
						Visible varchar(200)				
				)
	WHERE Visible='true'
	EXEC sp_xml_removedocument @idoc --Clean Cache
	--SELECT * FROM #tmpXmlDocTable

END

BEGIN
	--Import pMaterialRequestSubmitItem values to temp table
	SELECT * INTO #tmpMaterialRequest
	FROM pMaterialRequestSubmitItem WHERE MaterialRequestSubmitID = @MaterialRequestSubmitID
	ORDER BY MaterialRequestSubmitItemSort ASC

	ALTER TABLE #tmpMaterialRequest ADD
	RecID int NOT NULL IDENTITY (1, 1)
	--SELECT * FROM #tmpMaterialRequest
END

BEGIN
		
	DECLARE @TotalCountM int
	DECLARE @RowCounterM int

	SELECT @TotalCountM = COUNT(*) FROM #tmpMaterialRequest
	SET @RowCounterM = 1

	DECLARE @tmpMaterialRequestSubmitItemID varchar(40)

	WHILE(@RowCounterM <= @TotalCountM)
		BEGIN

			SELECT @tmpMaterialRequestSubmitItemID = MaterialRequestSubmitItemID
						FROM #tmpMaterialRequest WHERE RecID = @RowCounterM

			DECLARE @TotalCount int
			DECLARE @RowCounter int

			SELECT @TotalCount = COUNT(*) FROM #tmpXmlDocTable
			SET @RowCounter = 1

			DECLARE @tmpName varchar(200)
			DECLARE @tmpAlias varchar(200)	
			DECLARE @tmpType varchar(200)
			DECLARE @tmpDataType varchar(200)
			DECLARE @tmpLookup varchar(800)
			DECLARE @tmpValueField varchar(200)

			WHILE(@RowCounter <= @TotalCount)
				BEGIN

					SELECT @tmpAlias = Alias, @tmpName = [Name], @tmpType = [Type], @tmpDataType = datatype, @tmpLookup = lookupquery, @tmpValueField = ValueField
						FROM #tmpXmlDocTable WHERE XmlDocId = @RowCounter
					
					IF @tmpDataType = 'query'
						BEGIN

							CREATE TABLE #tmpTable (FieldID varchar(200), FieldValue varchar(200))
							CREATE TABLE #tmpVar (FieldValue varchar(200))

							DECLARE @tmpReturnValue varchar(100)

							EXEC ('INSERT INTO #tmpTable (FieldID, FieldValue) ' + @tmpLookup) 
							EXEC ('INSERT INTO #tmpVar(FieldValue) SELECT ' + @tmpName + ' FROM pMaterialRequestSubmitItem WHERE MaterialRequestSubmitItemID = ''' + @tmpMaterialRequestSubmitItemID + '''')

							SET @tmpReturnValue = (SELECT FieldValue FROM #tmpTable WHERE FieldID = (SELECT FieldValue FROM #tmpVar))

							DROP TABLE #tmpTable
							DROP TABLE #tmpVar

							EXEC('
								INSERT INTO rReportMaterialRequestItemTemp(DataXmlId, MaterialRequestSubmitItemID, MaterialRequestSubmitID, DataColumnNumber, DataColumnName, DataColumnValue, DataSort)
								SELECT ''' + @DataXmlId + ''', MaterialRequestSubmitItemID, MaterialRequestSubmitID, ' + @RowCounter + ',''' + @tmpAlias + ''', ''' + @tmpReturnValue + ''', MaterialRequestSubmitItemSort FROM pMaterialRequestSubmitItem WHERE MaterialRequestSubmitItemID = ''' + @tmpMaterialRequestSubmitItemID + ''' 
								')

						END
					ELSE
						BEGIN
							EXEC('
								INSERT INTO rReportMaterialRequestItemTemp(DataXmlId, MaterialRequestSubmitItemID, MaterialRequestSubmitID, DataColumnNumber, DataColumnName, DataColumnValue, DataSort)
								SELECT ''' + @DataXmlId + ''', MaterialRequestSubmitItemID, MaterialRequestSubmitID, ' + @RowCounter + ',''' + @tmpAlias + ''', ' + @tmpName + ', MaterialRequestSubmitItemSort FROM pMaterialRequestSubmitItem WHERE MaterialRequestSubmitItemID = ''' + @tmpMaterialRequestSubmitItemID + ''' 
								')
						END
					

					SET @RowCounter = @RowCounter + 1
				END
		SET @RowCounterM = @RowCounterM + 1

	END
END

--BEGIN
--	SELECT * FROM rReportMaterialRequestItemTemp WHERE DataColumnName <> 'Sort'
--END

BEGIN
	--Clean up
	--DELETE FROM rReportMaterialRequestItemTemp WHERE DataXmlID = @DataXmlID
	DROP TABLE #tmpMaterialRequest
	DROP TABLE #tmpXmlDocTable
	DROP TABLE #tmpXmlImportFile
END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_MaterialWizardRequest_ColorSeasonYear_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_MaterialWizardRequest_ColorSeasonYear_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_ControlPanel_POMLibrary_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 25, 2009
	Replace the old pom image string with the new image string using function.
Deleted old code.
*/



ALTER  PROCEDURE [dbo].[rpx_ControlPanel_POMLibrary_SELECT]

AS


/*Creat temporary table*/
CREATE     TABLE #TempHowTo
(	
	RowNumber int identity(0,1),
	POM nvarchar(5),
	PointMeasur nvarchar(200),
	HowToMeasurText nvarchar(4000),
	FilePath nvarchar(255)
)


/*Insert values into the temporary table*/
INSERT INTO #TempHowTo(POM, PointMeasur, HowToMeasurText, FilePath)
SELECT	POM,
		PointMeasur,
		HowToMeasurText,
		dbo.fnx_GetStreamingPOMImagePath(POMLibraryID) AS FilePath	--Comment #01
FROM pPOMLibrary
ORDER BY POM

/*Select the temporary table*/
SELECT	RowNumber % 4 AS Columns, POM, PointMeasur, HowToMeasurText, FilePath
FROM	#TempHowTo
ORDER BY POM, Columns DESC

DROP TABLE #TempHowTo


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleColorway_LinePlanColor_DELETE]'
GO
SET QUOTED_IDENTIFIER OFF
GO


ALTER PROCEDURE [dbo].[spx_StyleColorway_LinePlanColor_DELETE](
@ColorPaletteID UNIQUEIDENTIFIER, 
@StyleID UNIQUEIDENTIFIER,
@StyleSet INT,
@SeasonYearID UNIQUEIDENTIFIER
)
AS


DECLARE @StyleColorID UNIQUEIDENTIFIER 
DECLARE @StyleSeasonYearID  UNIQUEIDENTIFIER

SELECT @StyleSeasonYearID = StyleSeasonYearID   
FROM pStyleSeasonYear
WHERE StyleId = @StyleID AND SeasonYearID = @SeasonYearID


SELECT @StyleColorID = StyleColorID 
FROM pStyleColorway 
WHERE StyleID = @StyleID  
AND ColorPaletteID = @ColorPaletteID 


--***
--** DELETE Colorway / SeasonYear 
--***
DELETE FROM pStyleColorwaySeasonYear 
WHERE StyleColorwaySeasonYearID IN ( 
	SELECT  a.StyleColorwaySeasonYearID
	FROM pStyleColorwaySeasonYear a
	INNER JOIN pStyleColorway b ON a.StyleColorwayID = b.StyleColorID 
	WHERE a.StyleSeasonYearID = @StyleSeasonYearID
	AND b.ColorPaletteID = @ColorPaletteID
)

--***
--**DELETE SourcingItems
--***
DELETE FROM pStyleSourcingItem
WHERE StyleSourcingItemID IN ( 
	SELECT  b.StyleSourcingItemID 
	FROM pStyleSourcing a
	INNER JOIN pStyleSourcingItem  b ON a.StyleSourcingID =  b.StyleSourcingID 
	INNER JOIN pStyleColorway c ON c.StyleColorID  =  b.StyleColorID 
	WHERE StyleSeasonYearID = @StyleSeasonYearID
	AND c.ColorPaletteID = @ColorPaletteID
)

--***
--** DELETE QuoteItems 
--***
DELETE FROM pStyleQuoteItem
WHERE StyleQuoteItemID IN ( 
	SELECT a.StyleQuoteItemID
	FROM pStyleQuoteItem a
	INNER JOIN pStyleSourcing c ON a.StyleSourcingID = c.StyleSourcingID 
	INNER JOIN pStyleColorway d ON d.StyleColorID = a.StyleColorID 
	WHERE c.StyleSeasonYearID = @StyleSeasonYearID
	AND d.ColorPaletteID = @ColorPaletteID
)


--***
--** Check if the colorway is being used in a different SeasonYear 
--***
IF ( SELECT COUNT(*) FROM pStyleColorwaySeasonYear WHERE StyleColorwayID = @StyleColorID ) = 0
BEGIN
	DELETE FROM pStyleColorway WHERE StyleColorID = @StyleColorID 
END 





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_TechPackStyleDevelopment_INSERT]'
GO
SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [dbo].[spx_TechPackStyleDevelopment_INSERT](
@StyleID uniqueidentifier,
@DataXmlId uniqueidentifier,
@CreatedBy varchar(200),
@CreatedDate datetime,
@StyleColorwaySeasonYearID UNIQUEIDENTIFIER
)
AS 

DECLARE @StyleDevelopmentID uniqueidentifier
DECLARE @StyleVariation int

SELECT @StyleDevelopmentId = StyleDevelopmentId, @StyleVariation = ISNULL(Variation,1) FROM pStyleDevelopmentItem WITH (NOLOCK) WHERE StyleID = @StyleID

BEGIN
	INSERT INTO rReportStyleTemp (DataXmlId, StyleDevelopmentId, StyleId, CUser, CDate , StyleColorwaySeasonYearID)
	SELECT @DataXmlId, StyleDevelopmentID, StyleID, @CreatedBy, @CreatedDate, @StyleColorwaySeasonYearID
	FROM pStyleDevelopmentItem WITH (NOLOCK)
	WHERE StyleDevelopmentId = @StyleDevelopmentId AND Variation = @StyleVariation
END






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_StyleSourcing_SELECT]'
GO
EXEC sp_refreshview N'[dbo].[vwx_StyleSourcing_SELECT]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialRequestTemp_UPDATE]'
GO


CREATE PROCEDURE [dbo].[spx_MaterialRequestTemp_UPDATE] (
@MaterialRequestGroupID UNIQUEIDENTIFIER,
@MaterialRequestWorkflowTempID UNIQUEIDENTIFIER,
@MaterialID  UNIQUEIDENTIFIER,
@CUser NVARCHAR(200),
@CDate DATETIME 
)
AS


DECLARE @StarDate datetime
DECLARE @DueDate datetime

SELECT  @StarDate = MaterialRequestWorkflowTempStartDate, @DueDate = MaterialRequestWorkflowTempDueDate
FROM  pMaterialRequestWorkflowTemplate WHERE MaterialRequestWorkflowTempID = @MaterialRequestWorkflowTempID
	
	IF (SELECT COUNT(*) FROM pMaterialRequestTemp  WHERE MaterialRequestGroupID = @MaterialRequestGroupID) <> 0 	
		BEGIN
			UPDATE pMaterialRequestTemp  SET 
				MaterialRequestWorkflowTempID = @MaterialRequestWorkflowTempID,
				MaterialID = @MaterialID, 
				MaterialRequestWorkflowStartDate = getdate(),
				MaterialRequestWorkflowDueDate = @DueDate
			WHERE MaterialRequestGroupID = @MaterialRequestGroupID
		END 
	ELSE
		BEGIN
			INSERT INTO  pMaterialRequestTemp  (MaterialRequestGroupID, MaterialID, MaterialRequestWorkflowTempID, 
				MaterialRequestWorkflowStartDate, MaterialRequestWorkflowDueDate, CUser, CDate) 
			VALUES (@MaterialRequestGroupID, @MaterialID, @MaterialRequestWorkflowTempID, 
				getdate(), @DueDate, @CUser, @CDate ) 
		END 

	


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_MaterialWizardRequest_AgentVendor_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_MaterialWizardRequest_AgentVendor_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleDetailVariation_UPDATE]'
GO

ALTER PROCEDURE [dbo].[spx_StyleDetailVariation_UPDATE]
(@StyleID uniqueidentifier,
@StyleDetail nvarchar(max))
AS 


	UPDATE pStyleHeader SET StyleDetail = @StyleDetail WHERE StyleID = @StyleID

/*
CREATE TABLE #tmpStyleHeader ( 
    [StyleDetail] nvarchar(4000) NULL
)

INSERT INTO #tmpStyleHeader(StyleDetail)
SELECT  StyleDetail
FROM dbo.pStyleHeader WITH (NOLOCK)
WHERE (StyleID = @StyleID)

CREATE TABLE #tempStyleDevelopmentItem ( 
	[RecID]						int IDENTITY(1,1)  NOT NULL,
	[StyleDevelopmentID]    	uniqueidentifier NULL,
	[StyleID]               	uniqueidentifier NULL,
	[SizeRange]             	nvarchar(50) NULL,
	[Variation]             	int NULL,
	[CUser]                 	nvarchar(200) NULL,
	[CDate]                 	datetime NULL,
	[MUser]                 	nvarchar(200) NULL,
	[MDate]                 	datetime NULL,
)

DECLARE @RowStyleLoop 			int
DECLARE @RowStyleCount 			int
DECLARE @tmpStyleID				uniqueidentifier
DECLARE @tmpStyleVariation		int

DECLARE @StyleDevelopmentId uniqueidentifier
SELECT @tmpStyleVariation = Variation, @StyleDevelopmentId = StyleDevelopmentId FROM pStyleDevelopmentItem WITH (NOLOCK) WHERE StyleId = @StyleId

BEGIN
	INSERT INTO #tempStyleDevelopmentItem (StyleDevelopmentID, StyleID, SizeRange, Variation)
	SELECT StyleDevelopmentID, StyleID, SizeRange, Variation FROM pStyleDevelopmentItem WITH (NOLOCK) 
	WHERE StyleDevelopmentID = @StyleDevelopmentId AND Variation = @tmpStyleVariation
END

--SELECT * FROM #tempStyleDevelopmentItem

SET @RowStyleLoop = 1
SET @RowStyleCount = (SELECT COUNT(*) FROM #tempStyleDevelopmentItem)

WHILE @RowStyleLoop <= @RowStyleCount 

	BEGIN

		SELECT @tmpStyleID = StyleID FROM #tempStyleDevelopmentItem WHERE RecID = @RowStyleLoop

			BEGIN	
			
				UPDATE pStyleHeader
				SET StyleDetail = @StyleDetail
				WHERE StyleID = @tmpStyleID
				PRINT @StyleDetail

			END	

		SET @RowStyleLoop = @RowStyleLoop + 1
		
	END
*/


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleColorway_SeasonColor_DELETE]'
GO
SET QUOTED_IDENTIFIER OFF
GO


ALTER PROCEDURE [dbo].[spx_StyleColorway_SeasonColor_DELETE](
@ColorPaletteID UNIQUEIDENTIFIER, 
@StyleID UNIQUEIDENTIFIER,
@StyleSet INT,
@SeasonYearID UNIQUEIDENTIFIER
)
AS


DECLARE @StyleColorID UNIQUEIDENTIFIER 
DECLARE @StyleSeasonYearID  UNIQUEIDENTIFIER

SELECT @StyleSeasonYearID = StyleSeasonYearID   
FROM pStyleSeasonYear
WHERE StyleId = @StyleID AND SeasonYearID = @SeasonYearID

SELECT @StyleColorID = StyleColorID 
FROM pStyleColorway 
WHERE StyleID = @StyleID  
AND ColorPaletteID = @ColorPaletteID 


--***
--** DELETE Colorway / SeasonYear 
--***
DELETE FROM pStyleColorwaySeasonYear 
WHERE StyleColorwaySeasonYearID IN ( 
	SELECT  a.StyleColorwaySeasonYearID
	FROM pStyleColorwaySeasonYear a
	INNER JOIN pStyleColorway b ON a.StyleColorwayID = b.StyleColorID 
	WHERE a.StyleSeasonYearID = @StyleSeasonYearID
	AND b.ColorPaletteID = @ColorPaletteID
)


--***
--**DELETE SourcingItems
--***
DELETE FROM pStyleSourcingItem
WHERE StyleSourcingItemID IN ( 
	SELECT  b.StyleSourcingItemID 
	FROM pStyleSourcing a
	INNER JOIN pStyleSourcingItem  b ON a.StyleSourcingID =  b.StyleSourcingID 
	INNER JOIN pStyleColorway c ON c.StyleColorID  =  b.StyleColorID 
	WHERE StyleSeasonYearID = @StyleSeasonYearID
	AND c.ColorPaletteID = @ColorPaletteID
)

--***
--** DELETE QuoteItems 
--***
DELETE FROM pStyleQuoteItem
WHERE StyleQuoteItemID IN ( 
	SELECT a.StyleQuoteItemID
	FROM pStyleQuoteItem a
	INNER JOIN pStyleSourcing c ON a.StyleSourcingID = c.StyleSourcingID 
	INNER JOIN pStyleColorway d ON d.StyleColorID = a.StyleColorID 
	WHERE c.StyleSeasonYearID = @StyleSeasonYearID
	AND d.ColorPaletteID = @ColorPaletteID
)


/*

DECLARE @StyleColorID UNIQUEIDENTIFIER
DECLARE @StyleColorwaySeasonYearID UNIQUEIDENTIFIER

SELECT  @StyleColorID = StyleColorID, @StyleColorwaySeasonYearID = a.StyleColorwaySeasonYearID
FROM pStyleColorwaySeasonYear a
INNER JOIN pStyleSeasonYear b ON a.StyleSeasonyearID = b.StyleSeasonYearID 
INNER JOIN pStyleColorway c ON c.StyleColorID =  a.StyleColorwayID
WHERE b.StyleID =  @StyleID
AND ColorPaletteID =  @ColorPaletteID
AND SeasonYearID  = @SeasonYearID


DELETE FROM pStyleColorwaySeasonYear 
WHERE StyleColorwaySeasonYearID  = @StyleColorwaySeasonYearID 
*/




--***
--** Check if the colorway is being used in a different SeasonYear 
--***
IF ( SELECT COUNT(*) FROM pStyleColorwaySeasonYear WHERE StyleColorwayID = @StyleColorID ) = 0
	DELETE FROM pStyleColorway WHERE StyleColorID = @StyleColorID 



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Quotation_Calendar_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[spx_Quotation_Calendar_SELECT](@BeginDate datetime,
@EndDate datetime)
AS SELECT     QuoteFolderNo, QuoteFolderType, QuoteFolderStatus, QuoteGroupCost, QuoteCustomField1, QuoteCustomField2, QuoteCustomField3, 
                      QuoteCustomField4, QuoteCustomField5, QuoteCustomField6, QuoteCustomField7, QuoteCustomField8, QuoteCustomField9, QuoteCustomField10, 
                      QuoteDueDate, QuoteStartDate, QuoteFolderID
FROM         dbo.pQuoteFolder WITH (NOLOCK)
WHERE     (QuoteDueDate >= @BeginDate) AND (QuoteDueDate <= @EndDate)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_ReportMaterialHeader_INSERT]'
GO

CREATE PROCEDURE [dbo].[spx_ReportMaterialHeader_INSERT]
(
	@DataXmlID varchar(40),
	@MaterialID uniqueidentifier,
	@MaterialTradePartnerID varchar(40),
	@MaterialRequestSubmitID varchar(40),
	@DataXmlFile xml
)
AS 

BEGIN
	-- Import Schema File to #tmpXmlImportFile
	CREATE TABLE #tmpXmlImportFile(
		[xmlFileName] VARCHAR(300) NULL,
		[xmlData] XML NOT NULL
	)

	INSERT INTO #tmpXmlImportFile([xmlData]) VALUES (@DataXmlFile)

--	EXEC('INSERT INTO #tmpXmlImportFile(xmlFileName, xmlData)
--		SELECT ''' + @XmlPath + ''', xmlData
--		FROM(
--		SELECT *
--		FROM OPENROWSET (BULK ''' + @XmlPath + ''' , SINGLE_BLOB) AS XMLDATA
--		) AS FileImport (XMLDATA)
--		')
END

BEGIN
	-- Import table schema values to #tmpXmlDocTable

	CREATE TABLE #tmpXmlDoc(
					[XmlDocId] [int] IDENTITY(1,1) NOT NULL,
					[Name] [nvarchar](200) NULL,
					[formcolumns] VARCHAR(5),
					[gridcolumns] varchar(5),
					[FormSQL] varchar(2000),	
					[GridReadSQL] varchar(2000),
					[GridSQL] varchar(2000),
					[CDate] [datetime]
					)


	CREATE TABLE #tmpXmlDocTable(
					[XmlDocId] [int] IDENTITY(1,1) NOT NULL,
					[Name] [nvarchar](200) NULL,
					[Alias] [nvarchar](200) NULL,	
					[Type] varchar(200),
					[datatype] varchar(200),
					[column] VARCHAR(2),
					[order] varchar(3),
					[lookupquery] varchar(800),
					[ValueField] varchar(200),
					[Visible] [varchar](5) NULL,
					[CDate] [datetime]
					)


	DECLARE @idoc int
	DECLARE @idoc1 int
	DECLARE @doc XML
	SELECT @doc = xmlData FROM #tmpXmlImportFile

	EXEC sp_xml_preparedocument @idoc OUTPUT, @doc
	INSERT INTO #tmpXmlDocTable([Name], alias, Visible, CDate, [Type], datatype, lookupquery, ValueField, [column], [order])
	SELECT [Name], alias, Visible, getdate(), [Type], datatype, lookupquery, ValueField, [column], [order]
	FROM       OPENXML (@idoc, '/Table/column',1)
				WITH (	[Name]  varchar(200),
						alias varchar(200),
						[Type] varchar(200),
						[column] VARCHAR(2),
						[order] varchar(3),
						datatype varchar(200),
						lookupquery varchar(800),
						ValueField varchar(200),
						Visible varchar(200)				
				)
	WHERE Visible='true'
	EXEC sp_xml_removedocument @idoc --Clean Cache
	SELECT * FROM #tmpXmlDocTable


	EXEC sp_xml_preparedocument @idoc1 OUTPUT, @doc
	INSERT INTO #tmpXmlDoc([Name], FormSQL, GridReadSQL, GridSQL)
	SELECT [Name], FormSQL, GridReadSQL, GridSQL
	FROM       OPENXML (@idoc1, '/Table', 0)
				WITH (	[Name]  varchar(200),
						FormSQL VARCHAR(2000),
						GridReadSQL varchar(2000),
						GridSQL varchar(2000)				
				)
	WHERE FormSQL <> ''
	EXEC sp_xml_removedocument @idoc1 --Clean Cache
	SELECT * FROM #tmpXmlDoc

END

BEGIN
	--Select table to import
	SELECT * INTO #tmpMaterialHeader
	FROM pMaterialTradePartner WHERE MaterialTradePartnerID = @MaterialTradePartnerID

	ALTER TABLE #tmpMaterialHeader ADD
	RecID int NOT NULL IDENTITY (1, 1)
	--SELECT * FROM #tmpMaterialHeader
END

BEGIN
		
	DECLARE @TotalCountM int
	DECLARE @RowCounterM int

	SELECT @TotalCountM = COUNT(*) FROM #tmpMaterialHeader
	SET @RowCounterM = 1

	DECLARE @tmpMaterialID varchar(40)

	WHILE(@RowCounterM <= @TotalCountM)
		BEGIN

			SELECT @tmpMaterialID = MaterialID
						FROM #tmpMaterialHeader WHERE RecID = @RowCounterM

			DECLARE @TotalCount int
			DECLARE @RowCounter int

			SELECT @TotalCount = COUNT(*) FROM #tmpXmlDocTable
			SET @RowCounter = 1

			DECLARE @tmpName varchar(200)
			DECLARE @tmpAlias varchar(200)	
			DECLARE @tmpType varchar(200)
			DECLARE @tmpDataType varchar(200)
			DECLARE @tmpLookup varchar(800)
			DECLARE @tmpValueField varchar(200)
			DECLARE @tmpColumn varchar(2)
			DECLARE @tmpOrder varchar(3)

			WHILE(@RowCounter <= @TotalCount)
				BEGIN

					SELECT @tmpAlias = REPLACE(Alias,'''',''''''), @tmpName = [Name], @tmpType = [Type], @tmpDataType = datatype, 
						@tmpLookup = lookupquery, @tmpValueField = ValueField, @tmpColumn = [column], @tmpOrder = [order]
						FROM #tmpXmlDocTable WHERE XmlDocId = @RowCounter
					
					IF @tmpDataType = 'query'
						BEGIN

							CREATE TABLE #tmpTable (FieldID varchar(200), FieldValue varchar(200))
							CREATE TABLE #tmpVar (FieldValue varchar(200))

							DECLARE @tmpReturnValue varchar(100)

							EXEC ('INSERT INTO #tmpTable (FieldID, FieldValue) ' + @tmpLookup) 
							EXEC ('INSERT INTO #tmpVar(FieldValue) SELECT ' + @tmpName + ' FROM pMaterial WHERE MaterialID = ''' + @tmpMaterialID + '''')

							SET @tmpReturnValue = (SELECT Replace(FieldValue,'''','''''') FROM #tmpTable WHERE FieldID = (SELECT FieldValue FROM #tmpVar))

							DROP TABLE #tmpTable
							DROP TABLE #tmpVar

							EXEC('
								INSERT INTO rReportMaterialHeaderTemp(DataXmlId, DataColumnNumber, DataColumnName, DataHeader, DataValue, DataSort)
								SELECT ''' + @DataXmlId + ''', ' + @tmpColumn + ',''' + @tmpName + ''',''' + @tmpAlias + ''', ''' + @tmpReturnValue + ''', ''' + @tmpOrder + ''' FROM pMaterialTradePartner WHERE MaterialTradePartnerID = ''' + @MaterialTradePartnerID + ''' 
								')

						END
					ELSE
						BEGIN
							
							EXEC('
								INSERT INTO rReportMaterialHeaderTemp(DataXmlId, DataColumnNumber, DataColumnName, DataHeader, DataValue, DataSort)
								SELECT ''' + @DataXmlId + ''', ' + @tmpColumn + ',''' + @tmpName + ''', ''' + @tmpAlias + ''', ' + @tmpName + ', ''' + @tmpOrder + ''' FROM pMaterialTradePartner WHERE MaterialTradePartnerID = ''' + @MaterialTradePartnerID + ''' 
								')
						END
					

					SET @RowCounter = @RowCounter + 1
				END
		SET @RowCounterM = @RowCounterM + 1

	END
END

--BEGIN
--	SELECT * FROM rReportMaterialHeaderTemp WHERE DataXmlId = @DataXmlId ORDER BY DataColumnNumber, DataSort
--END

BEGIN
	--Clean up
	--DELETE FROM rReportMaterialHeaderTemp WHERE DataXmlID = @DataXmlID
	DROP TABLE #tmpMaterialHeader
	DROP TABLE #tmpXmlDocTable
	DROP TABLE #tmpXmlDoc
	DROP TABLE #tmpXmlImportFile
END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleDetailVariationLogic_UPDATE]'
GO



ALTER   PROCEDURE [dbo].[spx_StyleDetailVariationLogic_UPDATE]
(@StyleID uniqueidentifier,
@StyleDetail nvarchar(max))
AS 

DECLARE @StyleDetail1 varchar(8000)

SELECT @StyleDetail1 = StyleDetail1 FROM pStyleHeader WITH (NOLOCK) WHERE StyleID = @StyleId

UPDATE pStyleHeader SET StyleDetail = @StyleDetail WHERE StyleID = @StyleId

/*(Commented out by Ryan Cabanas so that the default is to not copy tab information from first to second.*/
-- IF @StyleDetail1 IS NULL OR LEN(@StyleDetail1) = 0
-- BEGIN
-- 	UPDATE pStyleHeader SET StyleDetail1 = @StyleDetail WHERE StyleID = @StyleId
-- END



/*
CREATE TABLE #tmpStyleHeader ( 
    [StyleDetail] nvarchar(4000) NULL
)

INSERT INTO #tmpStyleHeader(StyleDetail)
SELECT  StyleDetail
FROM dbo.pStyleHeader WITH (NOLOCK)
WHERE (StyleID = @StyleID)

CREATE TABLE #tempStyleDevelopmentItem ( 
	[RecID]						int IDENTITY(1,1)  NOT NULL,
	[StyleDevelopmentID]    	uniqueidentifier NULL,
	[StyleID]               	uniqueidentifier NULL,
	[SizeRange]             	nvarchar(50) NULL,
	[Variation]             	int NULL,
	[CUser]                 	nvarchar(200) NULL,
	[CDate]                 	datetime NULL,
	[MUser]                 	nvarchar(200) NULL,
	[MDate]                 	datetime NULL,
)

DECLARE @RowStyleLoop 			int
DECLARE @RowStyleCount 			int
DECLARE @tmpStyleID				uniqueidentifier
DECLARE @tmpStyleVariation		int

DECLARE @StyleDevelopmentId uniqueidentifier
SELECT @tmpStyleVariation = Variation, @StyleDevelopmentId = StyleDevelopmentId FROM pStyleDevelopmentItem WITH (NOLOCK) WHERE StyleId = @StyleId

BEGIN
	INSERT INTO #tempStyleDevelopmentItem (StyleDevelopmentID, StyleID, SizeRange, Variation)
	SELECT StyleDevelopmentID, StyleID, SizeRange, Variation FROM pStyleDevelopmentItem WITH (NOLOCK) 
	WHERE StyleDevelopmentID = @StyleDevelopmentId AND Variation = @tmpStyleVariation
END

--SELECT * FROM #tempStyleDevelopmentItem

SET @RowStyleLoop = 1
SET @RowStyleCount = (SELECT COUNT(*) FROM #tempStyleDevelopmentItem)

WHILE @RowStyleLoop <= @RowStyleCount 

	BEGIN

		SELECT @tmpStyleID = StyleID FROM #tempStyleDevelopmentItem WHERE RecID = @RowStyleLoop

			BEGIN	
			
				UPDATE pStyleHeader
				SET StyleDetail = @StyleDetail
				WHERE StyleID = @tmpStyleID
				PRINT @StyleDetail

			END	

		SET @RowStyleLoop = @RowStyleLoop + 1
		
	END
*/




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleColorwayItem_UPDATE]'
GO

CREATE PROCEDURE [dbo].[spx_StyleColorwayItem_UPDATE]  (
	@MaterialColorID uniqueidentifier,
	@StyleMaterialID uniqueidentifier = NULL,
	@StyleColorItemID uniqueidentifier = NULL,	
	@StyleID uniqueidentifier = NULL,
	@StyleSet int = 1,
	@SeasonYearID uniqueidentifier = NULL,
	@AllColor int = 0,
	@MUser nvarchar(200),
	@MDate datetime 
) 
AS 

--Daniel Pak
--2/12/2010

IF @AllColor = 1 
--It will update all colorways 
	BEGIN 
		UPDATE pStyleColorwayItem SET 
			MaterialColorID = @MaterialColorID,
			MUser = @MUser,
			MDate = @MDate
		WHERE StyleMaterialID = @StyleMaterialID 
			AND StyleID = @StyleID 
			AND StyleSet = @StyleSet 
	END 
ELSE
--It will update individual colorway with selected color chip (@MaterialColorID)
	BEGIN 
		UPDATE pStyleColorwayItem SET 
			MaterialColorID = @MaterialColorID,
			MUser = @MUser,
			MDate = @MDate
		WHERE StyleColorItemID = @StyleColorItemID 
	END 







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcingItemLogic_SELECT]'
GO



/*Comments:

#01 - Ryan Cabanas - 2/16/2009
	Added code to the procedure so that when you go to the Sourcing_BOM.aspx page, the Sourcing Item records needed to match the Materials for
all Size Classes are added to the 'pStyleSourcingItem' table.  If any lingering records are sitting in 'pStyleSourcingItem' and there is no
matching Material, remove these records from 'pStyleSourcingItem' to clean things up.

*/



ALTER PROCEDURE [dbo].[spx_StyleSourcingItemLogic_SELECT]   ( 
@StyleSourcingID  UNIQUEIDENTIFIER  ,  
@StyleColorID   UNIQUEIDENTIFIER = NULL, 
@StyleID   UNIQUEIDENTIFIER = NULL, 
@StyleSet INT = NULL
) 
AS


--Comment #01
BEGIN
	/*Create temp tables.*/
	CREATE TABLE #tempAdd(	--Table to hold records that will be added to 'pStyleSourcingItem'.
		TableRow int identity(1,1)
		,StyleSourcingID uniqueidentifier
		,StyleMaterialID uniqueidentifier
		,UOM nvarchar(50)
		,Qty nvarchar(50)
		,MaterialPrice money
		,Sort varchar(5)
		,StyleColorID uniqueidentifier
		,StyleSet int)

	CREATE TABLE #tempDelete(	--Table to hold records that will be removed from 'pStyleSourcingItem' if no matching Material in 'pStyleMaterials'.
		TableRow int identity(1,1)
		,StyleSourcingItemID uniqueidentifier)


	/************************************************/
	/*Inserting records to 'pStyleSourcingItem'.	*/
	/************************************************/
	BEGIN
		/*Get records that need to be added to 'pStyleSourcingItem'.*/
		INSERT INTO #tempAdd(
			StyleSourcingID
			,StyleMaterialID
			,UOM
			,Qty
			,MaterialPrice
			,Sort
			,StyleColorID
			,StyleSet)
		SELECT
			pStyleSourcing.StyleSourcingID
			,pStyleMaterials.StyleMaterialID
			,pStyleMaterials.UOM
			,pStyleMaterials.Qty
			,pStyleMaterials.MaterialPrice
			,pStyleMaterials.MaterialSort AS Sort
			,pStyleColorway.StyleColorID
			,pStyleMaterials.StyleSet
		FROM pStyleSourcing
			INNER JOIN pStyleMaterials ON	pStyleSourcing.StyleID = pStyleMaterials.StyleID
			INNER JOIN pStyleColorway ON	pStyleMaterials.StyleID = pStyleColorway.StyleID
			LEFT OUTER JOIN pStyleSourcingItem ON	pStyleMaterials.StyleMaterialID = pStyleSourcingItem.StyleMaterialID
													AND pStyleColorway.StyleColorID = pStyleSourcingItem.StyleColorID
													AND pStyleSourcing.StyleSourcingID = pStyleSourcingItem.StyleSourcingID
		WHERE pStyleSourcing.StyleSourcingID = @StyleSourcingID
			AND pStyleSourcingItem.StyleSourcingItemID IS NULL
			AND pStyleColorway.StyleColorID IN  (
				SELECT  DISTINCT StyleColorID FROM pStyleSourcingItem where StyleSourcingID = @StyleSourcingID
			) 

		/*Add the records to 'pStyleSourcingItem'.*/
		INSERT INTO pStyleSourcingItem(
			StyleSourcingItemID
			,StyleSourcingID
			,StyleMaterialID
			,UOM
			,Qty
			,MaterialPrice
			,Sort
			,StyleColorID
			,StyleSet
			,BOM)
		SELECT
			NEWID()
			,StyleSourcingID
			,StyleMaterialID
			,UOM
			,Qty
			,MaterialPrice
			,Sort
			,StyleColorID
			,StyleSet
			,1
		FROM #tempAdd
	END


	/********************************************/
	/*Deleting records to 'pStyleSourcingItem'.	*/
	/********************************************/
	BEGIN
		/*Get records that need to be deleted from 'pStyleSourcingItem'.*/
		INSERT INTO #tempDelete(
			StyleSourcingItemID)
		SELECT
			pStyleSourcingItem.StyleSourcingItemID
		FROM pStyleSourcingItem
			INNER JOIN pStyleSourcing ON pStyleSourcingItem.StyleSourcingID = pStyleSourcing.StyleSourcingID
			LEFT OUTER JOIN pStyleMaterials ON	pStyleSourcingItem.StyleMaterialID = pStyleMaterials.StyleMaterialID
		WHERE pStyleSourcing.StyleSourcingID = @StyleSourcingID
			AND pStyleMaterials.StyleMaterialID IS NULL

		/*Delete the records from 'pStyleSourcingItem'.*/
		DELETE
		FROM pStyleSourcingItem
		WHERE StyleSourcingItemID IN (SELECT StyleSourcingItemID FROM #tempDelete)
	END


	/*Drop temp tables.*/
	DROP TABLE #tempAdd
	DROP TABLE #tempDelete
END



DECLARE @BOMRollUP MONEY 
DECLARE @StyleQuoteItemID UNIQUEIDENTIFIER 

SELECT @StyleQuoteItemID = StyleQuoteItemID FROM pStyleQuoteItem 
WHERE StyleSourcingId = @StyleSourcingID
AND StylecolorID = @StylecolorID

IF @StyleQuoteItemID IS NOT NULL
BEGIN
	SELECT @BOMRollUP = SUM (Qty * MaterialPrice )
	FROM pStyleSourcingItem 
	where StyleSourcingId = @StyleSourcingID
	AND StylecolorID = @StylecolorID
	AND StyleSet = 1 
	AND BOM = 1

	UPDATE pStyleQuoteItem  
	SET StyleQuoteItemCustomField10 = @BOMRollUP
	WHERE StyleQuoteItemID = @StyleQuoteItemID
END 



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleSpec_Linked_DELETE]'
GO
CREATE PROCEDURE [dbo].[spx_StyleSpec_Linked_DELETE]
(
	@StyleID UNIQUEIDENTIFIER
	,@StyleSet INT
	,@SpecID UNIQUEIDENTIFIER
)

AS


/************************/
/*Declare variables.	*/
/************************/
DECLARE @StyleID_Param UNIQUEIDENTIFIER		--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT					--Keep a copy of the original parameter value.
DECLARE @SpecID_Param UNIQUEIDENTIFIER		--Keep a copy of the original parameter value.

DECLARE @StyleLinkID UNIQUEIDENTIFIER
DECLARE @POM NVARCHAR(10)
DECLARE @PointMeasure NVARCHAR(225)

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet
SET @SpecID_Param = @SpecID


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,SpecID UNIQUEIDENTIFIER
	,StyleSet INT
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleSpec_DELETE
			@StyleID_Param
			,@StyleSet_Param
			,@SpecID_Param
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Clear variables.*/
		SET @POM = NULL
		SET @PointMeasure = NULL


		/*Get the 'POM' and 'PointMeasure' values of the calling Style.*/
		SELECT @POM = POM
			,@PointMeasure = PointMeasur
		FROM pStyleSpec
		WHERE SpecID = @SpecID_Param


		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet_Param AS StyleSet
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID


		/*Get and set the counts for the Multi-Cloth linked Styles.*/
		SELECT @TotalCount = COUNT(*) FROM #temp_Linked
		SET @RowCounter = 1


		/*Get the 'SpecID' of the POM for each of the Multi-Cloth linked Styles.*/
		WHILE(@RowCounter <= @TotalCount)
			BEGIN
				/*Clear variables.*/
				SET @StyleID = NULL
				SET @SpecID = NULL
				SET @StyleSet = NULL


				/*Get 'StyleID'.*/
				SELECT @StyleID = StyleID
					,@StyleSet = StyleSet
				FROM #temp_Linked
				WHERE TableRow = @RowCounter


				/*Get the 'SpecID'.*/
				SELECT @SpecID = SpecID
				FROM pStyleSpec
				WHERE StyleID = @StyleID
					AND StyleSet = @StyleSet
					AND POM = @POM
					AND PointMeasur = @PointMeasure


				/*Update the temp table with the 'SpecID'.*/
				UPDATE #temp_Linked
				SET SpecID = @SpecID
				WHERE TableRow = @RowCounter


				/*Up row counter.*/
				SET @RowCounter = @RowCounter + 1
			END
	END

/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'SpecID' of the POM for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @SpecID = NULL
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Get the 'SpecID' for the update.*/
		SELECT @SpecID = SpecID
			,@StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleSpec_DELETE
			@StyleID
			,@StyleSet
			,@SpecID


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleDevelopment_CHECK]'
GO

ALTER PROCEDURE [dbo].[spx_StyleDevelopment_CHECK]
(@StyleDevelopmentID uniqueidentifier,
@StyleID uniqueidentifier,
@TempID nvarchar(50),
@TempNo nvarchar(50),
@StyleDevelopmentNo nvarchar(50),
@SizeRange nvarchar(50),
@CreatedBy nvarchar(200),
@CreatedDate datetime)
AS 

--BEGIN
--
--	--Robbie type your comments here...
--
--	DECLARE @tmpStyleNo VARCHAR(50), @tmpTempID VARCHAR(50)
--
--	SELECT TOP 1 
--	@tmpStyleNo = SUBSTRING(StyleNo,2,len(StyleNo)-1),
--	@tmpTempID = SUBSTRING(TempID,2,len(TempID)-1)
--	FROM pStyleHeader 
--	WHERE StyleID IN (SELECT StyleID FROM pStyleDevelopmentItem WHERE StyleDevelopmentID = @StyleDevelopmentID)
--	ORDER BY CDate ASC
--
--	UPDATE pStyleHeader SET 
--	StyleNo = SUBSTRING(StyleNo,1,1) + @tmpStyleNo, 
--	TempID = SUBSTRING(StyleNo,1,1) + @tmpTempID 
--	WHERE StyleID IN (SELECT StyleID FROM pStyleDevelopmentItem WHERE StyleDevelopmentID = @StyleDevelopmentID)
--
--END

IF (SELECT COUNT(*) FROM pStyleDevelopmentItem WITH (NOLOCK) WHERE StyleID = @StyleID) = 0
BEGIN

	INSERT INTO dbo.pStyleDevelopment
                 (StyleDevelopmentID, StyleDevelopmentNo, TempID, TempNo, CUser, CDate, MUser, MDate)
	VALUES     (@StyleDevelopmentID, @StyleDevelopmentNo, @TempID, @TempNo, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate)

	INSERT INTO dbo.pStyleDevelopmentItem
                 (StyleDevelopmentID, StyleID, SizeRange, Variation, CUser, CDate, MUser, MDate)
	VALUES     (@StyleDevelopmentID, @StyleID, @SizeRange, 1, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate)

END 

BEGIN

	DECLARE @DevelopmentID uniqueidentifier
	DECLARE @DevelopmentNo varchar(50)
	SELECT @DevelopmentID = StyleDevelopmentID FROM pStyleDevelopmentItem WITH (NOLOCK) WHERE StyleID = @StyleID
	SELECT @DevelopmentNo = StyleDevelopmentNo FROM pStyleDevelopment WITH (NOLOCK) WHERE StyleDevelopmentID = @DevelopmentID

	UPDATE    dbo.pStyleHeader
	SET     DevelopmentID = @DevelopmentID, DevelopmentNo = @DevelopmentNo
	WHERE     (StyleID = @StyleID)
END

BEGIN
	SELECT StyleDevelopmentID, StyleID, SizeRange, Variation, CUser, CDate, MUser, MDate FROM dbo.pStyleDevelopmentItem WITH (NOLOCK) WHERE StyleID = @StyleID
END

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleMaterialSummaryColorwayItem_INSERT]'
GO
SET QUOTED_IDENTIFIER OFF
GO



ALTER PROCEDURE [dbo].[spx_StyleMaterialSummaryColorwayItem_INSERT]
(
@StyleColorId uniqueidentifier,
@StyleSet int,
@StyleMaterialId uniqueidentifier
)
AS 


IF  (SELECT COUNT(*) FROM pStyleColorwayItem WHERE StyleColorID = @StyleColorId AND StyleMaterialID = @StyleMaterialId
	AND StyleSet = @StyleSet ) = 0
	INSERT INTO pStyleColorwayItem (StyleColorID, StyleMaterialID, StyleID, StyleSet, MaterialID )  
	SELECT @StyleColorID, StyleMaterialID, StyleID, @StyleSet, MaterialID FROM pStyleMaterials WITH (NOLOCK) 
	WHERE  (StyleMaterialID = @StyleMaterialId)

 
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_TradePartnerLogin_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[spx_TradePartnerLogin_SELECT]
(@UserName nvarchar(25),
@Password nvarchar(25),
@Email varchar(100))
AS 

SELECT uTradePartner.TradePartnerID, uTradePartner.TradePartnerCode, uTradePartner.TradePartnerName, uTradePartner.Address1, 
    uTradePartner.Address2, uTradePartner.City, uTradePartner.State, uTradePartner.PostalCode, uTradePartner.Country, 
    uTradePartner.Username, uTradePartner.Password, uTradePartnerContact.TradePartnerContactid, uTradePartnerContact.FirstName, uTradePartnerContact.MiddleName, 
    uTradePartnerContact.LastName, uTradePartnerContact.Title, uTradePartnerContact.Email, 
    uTradePartnerContact.FirstName + ' ' + uTradePartnerContact.LastName AS FullName
FROM uTradePartner WITH (NOLOCK) INNER JOIN
     uTradePartnerContact WITH (NOLOCK) ON uTradePartner.TradePartnerID = uTradePartnerContact.TradePartnerID
WHERE     (uTradePartner.Username = @UserName) AND (uTradePartner.Password = @Password) AND (uTradePartnerContact.Email = @Email)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcingItemRollup_SELECT]'
GO







ALTER PROCEDURE [dbo].[spx_StyleSourcingItemRollup_SELECT]  (
@StyleSourcingID  UNIQUEIDENTIFIER,
@StyleColorID UNIQUEIDENTIFIER 
)
AS


DECLARE @BOMCosting as NVARCHAR(10)
DECLARE @TotalCosting as NVARCHAR(10)


SELECT @BOMCosting = CAST (SUM ( (MaterialPrice ) * Qty ) AS DECIMAL (18,2) ) 
FROM  pStyleSourcingItem
WHERE StyleSourcingID = @StyleSourcingID 
AND BOM = 1
AND StyleColorID = @StyleColorID


IF @BOMCosting IS NULL OR LEN (@BOMCosting) = 0 
	SET @BOMCosting = '0.00' 


SELECT @TotalCosting = CAST ( SUM ( (MaterialPrice ) * Qty)  AS DECIMAL (18,2) ) 
FROM  pStyleSourcingItem
WHERE StyleSourcingID = @StyleSourcingID
AND StyleColorID = @StyleColorID


IF @TotalCosting IS NULL OR LEN (@TotalCosting) = 0 
	SET @TotalCosting = '0.00' 


SELECT '   ' AS cellSpace, 'BOM RollUp ' AS [Cost Type ], '' + @BOMCosting AS [Total Cost], '   ' AS cellSpace1
UNION ALL 
SELECT '   ' AS cellSpace, 'Total Cost ' AS [Cost Type ], '' + @TotalCosting AS [Total Cost], '   ' AS cellSpace1


/*

	SELECT '   ' AS cellSpace, 'BOM Costing  ' AS [Cost Type ], '$' + CAST(CAST(SUM(ISNULL(Qty,1) * MaterialPrice) AS DECIMAL(18,2)) AS VARCHAR(10)) + '' AS [Total Cost], '   ' AS cellSpace1
	FROM  pStyleSourcingItem
	WHERE pStyleSourcingItem.StyleSourcingID = @StyleSourcingID AND BOM = 1
	GROUP BY StyleSourcingID, BOM
	UNION ALL
	SELECT '   ' AS cellSpace, 'Total Costing  ' AS [Cost Type ], '$' +  CAST(CAST(SUM(ISNULL(Qty,1) * MaterialPrice) AS DECIMAL(18,2)) AS VARCHAR(10)) + '' AS Total, '   ' AS cellSpace1
	FROM  pStyleSourcingItem
	WHERE pStyleSourcingItem.StyleSourcingID = @StyleSourcingID
	GROUP BY StyleSourcingID
*/
















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleSpec_Linked_INSERT]'
GO
CREATE PROCEDURE [dbo].[spx_StyleSpec_Linked_INSERT]
(
	@SpecID uniqueidentifier,
	@POM nvarchar(10),
	@StyleID nvarchar(50),
	@StyleSet nvarchar(50),
	@MUser nvarchar(200),
	@MDate datetime
)

AS 


/************************/
/*Declare variables.	*/
/************************/
DECLARE @SpecID_Param UNIQUEIDENTIFIER			--Keep a copy of the original parameter value.
DECLARE @POM_Param NVARCHAR(10)					--Keep a copy of the original parameter value.
DECLARE @StyleID_Param UNIQUEIDENTIFIER			--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT						--Keep a copy of the original parameter value.

DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @SpecID_Param = @SpecID
SET @POM_Param = @POM
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	,POM NVARCHAR(10)
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleSpec_INSERT
			@SpecID_Param
			,@POM_Param
			,@StyleID_Param
			,@StyleSet_Param
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet
			,POM)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet_Param AS StyleSet
			,@POM_Param AS POM
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID
	END

/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles to add the POM to.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @POM = NULL
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Generate a new 'SpecID' for the insert.*/
		SET @SpecID = NEWID()


		/*Get the 'StyleID' for the insert.*/
		SELECT @POM = POM
			,@StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleSpec_INSERT
			@SpecID
			,@POM
			,@StyleID
			,@StyleSet


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcingColorWays_SELECT]'
GO
SET QUOTED_IDENTIFIER OFF
GO


ALTER PROCEDURE [dbo].[spx_StyleSourcingColorWays_SELECT] (
@StyleSourcingID UNIQUEIDENTIFIER
)
AS 
BEGIN 

	DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER 
	SELECT @StyleSeasonYearID = StyleSeasonYearID FROM pStyleSourcing WHERE StyleSourcingID = @StyleSourcingID

	SELECT a.StyleColorID ,  a.StyleColorName, a.MainColor , a.Sort , c.StyleQuoteItemID, c.StyleCostingType, 
	d.StyleSourcingQuoteSchema, d.StyleCostingType 
	FROM pStyleColorway a 
	INNER JOIN pStyleSourcingItem b ON a.StyleColorID = b.StyleColorID 
	INNER JOIN pStyleColorwaySeasonYear e ON e.StyleColorwayID = a.StyleColorID
	LEFT OUTER JOIN pStyleQuoteItem c ON  (b.StyleColorID = c.StyleColorID AND  b.StyleSourcingID  =  c.StyleSourcingID) 
	LEFT OUTER JOIN pStyleCostingType d ON c.StyleCostingType = d.StyleCostingTypeID
	WHERE b.StyleSourcingID =  @StyleSourcingID  
	AND e.StyleSeasonYearID =  @StyleSeasonYearID
	AND b.StyleSet = 1  
	GROUP BY a.StyleColorID ,  a.StyleColorName, a.MainColor , a.Sort , c.StyleQuoteItemID, c.StyleCostingType, d.StyleSourcingQuoteSchema, d.StyleCostingType  
	ORDER BY a.Sort, a.StyleColorName 

END 



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Quote_Message_Style_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[spx_Quote_Message_Style_SELECT]
(
@QuoteFolderID uniqueidentifier = '00000000-0000-0000-0000-000000000000'
)
AS 

IF (@QuoteFolderID <> '00000000-0000-0000-0000-000000000000')

	BEGIN

		SELECT  dbo.pQuoteFolderItem.QuoteFolderItemID, dbo.pQuoteFolderItem.QuoteFolderID, dbo.pQuoteFolderItem.StyleID, dbo.pQuoteFolderItem.CustomField1, 
                     	 dbo.pQuoteFolderItem.CustomField2, dbo.pQuoteFolderItem.CustomField3, dbo.pQuoteFolderItem.CustomField4, dbo.pQuoteFolderItem.CustomField5, 
                     	 dbo.pQuoteFolderItem.CustomField6, dbo.pQuoteFolderItem.CustomField7, dbo.pQuoteFolderItem.CustomField8, dbo.pQuoteFolderItem.CustomField9, 
                      	dbo.pQuoteFolderItem.CustomField10, dbo.pQuoteFolderItem.CustomField11, dbo.pQuoteFolderItem.CustomField12, 
                      	dbo.pQuoteFolderItem.CustomField13, dbo.pQuoteFolderItem.CustomField14, dbo.pQuoteFolderItem.CustomField15, dbo.pQuoteFolderItem.CUser, 
                     	 dbo.pQuoteFolderItem.CDate, dbo.pQuoteFolderItem.MUser, dbo.pQuoteFolderItem.MDate, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.Description, 
                      	dbo.pStyleHeader.DesignSketchID, dbo.pStyleHeader.DesignSketchVersion, dbo.pStyleHeader.StyleStatus, dbo.pQuoteFolderItem.PDFFile
		FROM         dbo.pQuoteFolderItem WITH (NOLOCK) INNER JOIN
                     	 dbo.pStyleHeader WITH (NOLOCK) ON dbo.pQuoteFolderItem.StyleID = dbo.pStyleHeader.StyleID
		WHERE   (dbo.pQuoteFolderItem.QuoteFolderID = @QuoteFolderID)
		ORDER BY dbo.pStyleHeader.StyleNo

	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialRequestWorkflowColors_SELECT]'
GO
/*
Comments:

01 - Ryan Cabanas - May 21, 2009
	Field "pMaterialRequestSubmitWorkflow.SampleWorkflowFinalDate" was removed from SELECT statement.
*/

ALTER PROCEDURE [dbo].[spx_MaterialRequestWorkflowColors_SELECT](
	@MaterialTradePartnerID uniqueidentifier, 
	@MaterialRequestWorkflowID varchar(10))
AS 

SELECT pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID, pMaterialRequestSubmitWorkflow.MaterialTradePartnerID, 
  pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowTempItemID, pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID, 
  pMaterialRequestSubmitWorkflow.MaterialID, pMaterialRequestSubmitWorkflow.MaterialColorID, pMaterialRequestSubmitWorkflow.TradePartnerID, 
  pMaterialRequestSubmitWorkflow.TradePartnerVendorID, pMaterialRequestSubmitWorkflow.Status, pMaterialRequestSubmitWorkflow.Submit, 
  pMaterialRequestSubmitWorkflow.SubmitDays, pMaterialRequestSubmitWorkflow.ResubmitDays, pMaterialRequestSubmitWorkflow.AssignedTo, 
  pMaterialRequestSubmitWorkflow.StartDate, pMaterialRequestSubmitWorkflow.DueDate, pMaterialRequestSubmitWorkflow.EndDate, 
  pMaterialRequestSubmitWorkflow.CUser, pMaterialRequestSubmitWorkflow.CDate, pMaterialRequestSubmitWorkflow.MUser, 
  pMaterialRequestSubmitWorkflow.MDate, pMaterialRequestSubmitWorkflow.TUser, pMaterialRequestSubmitWorkflow.TDate, 
  pMaterialRequestSubmitWorkflow.FinalDate, pMaterialTradePartnerColor.MaterialTradePartnerColorID, 
  pMaterialTradePartnerColor.MaterialColorID, pMaterialTradePartnerColor.MaterialColorImageID, pMaterialTradePartnerColor.MaterialColorImageVersion, 
  pMaterialTradePartnerColor.ColorFolderID, pMaterialTradePartnerColor.ColorPaletteID, pMaterialTradePartnerColor.ColorID, pMaterialTradePartnerColor.ColorCode, 
  pMaterialTradePartnerColor.ColorNo, pMaterialTradePartnerColor.ColorName, pMaterialTradePartnerColor.ColorSource, pMaterialTradePartnerColor.VendorColorCode, 
  pMaterialTradePartnerColor.VendorColorNo, pMaterialTradePartnerColor.VendorColorName, 		
CASE 
	WHEN ColorCode IS NULL THEN ColorName 
	ELSE '(' + ColorCode + ')' + ColorName 
END
AS Color, 
CASE 
	WHEN pMaterialRequestSubmitStatus.ApprovedType = 1  THEN '../System/Icons/icon_ball_green.gif'
	WHEN pMaterialRequestSubmitStatus.StatusID = 4  THEN '../System/Icons/icon_ball_red.gif'
	WHEN pMaterialRequestSubmitWorkflow.Submit = 1 THEN '../System/Icons/icon_ball_blue.gif'
	ELSE '../System/Icons/icon_ball_yellow.gif'
END
AS Icon
FROM pMaterialRequestSubmitWorkflow INNER JOIN
  pMaterialTradePartnerColor ON pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID = pMaterialTradePartnerColor.MaterialTradePartnerColorID INNER JOIN
  pMaterialRequestSubmitStatus ON pMaterialRequestSubmitWorkflow.Status = pMaterialRequestSubmitStatus.StatusID
WHERE pMaterialRequestSubmitWorkflow.MaterialTradePartnerID = @MaterialTradePartnerID AND 
	pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID = @MaterialRequestWorkflowID








GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleSpec_Linked_UPDATE]'
GO
CREATE PROCEDURE [dbo].[spx_StyleSpec_Linked_UPDATE]
(
	@SpecID				uniqueidentifier,
	@POM				nvarchar(10),
	@PointMeasure		nvarchar(225),
	@TOL				numeric(18,4),
	@TOLN				numeric(18,4),
	@Spec				numeric(18,4),
	@Proto0				numeric(18,4),
	@Proto1				numeric(18,4),
	@Proto2				numeric(18,4),
	@Proto3				numeric(18,4),
	@Proto4				numeric(18,4),
	@Proto5				numeric(18,4),
	@Proto6				numeric(18,4),
	@Proto7				numeric(18,4),
	@Proto8				numeric(18,4),
	@Proto9				numeric(18,4),
	@Proto10			numeric(18,4),
	@Proto11			numeric(18,4),
	@Proto12			numeric(18,4),
	@Proto13			numeric(18,4),
	@Proto14			numeric(18,4),
	@Proto15			numeric(18,4),
	@Proto16			numeric(18,4),
	@Proto17			numeric(18,4),
	@Proto18			numeric(18,4),
	@Proto19			numeric(18,4),
	@ModifiedBy			nvarchar(200),
	@ModifiedDate		datetime
)

AS


/************************/
/*Declare variables.	*/
/************************/
DECLARE @SpecID_Param UNIQUEIDENTIFIER		--Keep a copy of the original parameter value.

DECLARE @StyleID UNIQUEIDENTIFIER
DECLARE @StyleLinkID UNIQUEIDENTIFIER
DECLARE @StyleSet INT

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @SpecID_Param = @SpecID


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,SpecID UNIQUEIDENTIFIER
	,StyleSet INT
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleID' and 'StyleSet' of the calling Style.*/
SELECT @StyleID = StyleID
	,@StyleSet = StyleSet
FROM pStyleSpec
WHERE SpecID = @SpecID_Param


/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleSpec_UPDATE
			@SpecID_Param
			,@POM
			,@PointMeasure
			,@TOL
			,@TOLN
			,@Spec
			,@Proto0
			,@Proto1
			,@Proto2
			,@Proto3
			,@Proto4
			,@Proto5
			,@Proto6
			,@Proto7
			,@Proto8
			,@Proto9
			,@Proto10
			,@Proto11
			,@Proto12
			,@Proto13
			,@Proto14
			,@Proto15
			,@Proto16
			,@Proto17
			,@Proto18
			,@Proto19
			,@ModifiedBy
			,@ModifiedDate
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID


		/*Get and set the counts for the Multi-Cloth linked Styles.*/
		SELECT @TotalCount = COUNT(*) FROM #temp_Linked
		SET @RowCounter = 1


		/*Get the 'SpecID' of the POM for each of the Multi-Cloth linked Styles.*/
		WHILE(@RowCounter <= @TotalCount)
			BEGIN
				/*Clear variables.*/
				SET @StyleID = NULL
				SET @SpecID = NULL
				SET @StyleSet = NULL


				/*Get 'StyleID'.*/
				SELECT @StyleID = StyleID
					,@StyleSet = StyleSet
				FROM #temp_Linked
				WHERE TableRow = @RowCounter


				/*Get the 'SpecID'.*/
				SELECT @SpecID = SpecID
				FROM pStyleSpec
				WHERE StyleID = @StyleID
					AND StyleSet = @StyleSet
					AND POM = @POM
					AND PointMeasur = @PointMeasure


				/*Update the temp table with the 'SpecID'.*/
				UPDATE #temp_Linked
				SET SpecID = @SpecID
				WHERE TableRow = @RowCounter


				/*Up row counter.*/
				SET @RowCounter = @RowCounter + 1
			END
	END

/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'SpecID' of the POM for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @SpecID = NULL


		/*Get the 'SpecID' for the update.*/
		SELECT @SpecID = SpecID
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleSpec_UPDATE
			@SpecID
			,@POM
			,@PointMeasure
			,@TOL
			,@TOLN
			,@Spec
			,@Proto0
			,@Proto1
			,@Proto2
			,@Proto3
			,@Proto4
			,@Proto5
			,@Proto6
			,@Proto7
			,@Proto8
			,@Proto9
			,@Proto10
			,@Proto11
			,@Proto12
			,@Proto13
			,@Proto14
			,@Proto15
			,@Proto16
			,@Proto17
			,@Proto18
			,@Proto19
			,@ModifiedBy
			,@ModifiedDate


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_ColorPaletteLogic_UPDATE]'
GO


ALTER PROCEDURE [dbo].[spx_ColorPaletteLogic_UPDATE]
(@ColorPaletteId  uniqueidentifier
)
AS 

IF (SELECT COUNT(*) FROM ColorLibrary WHERE ColorPaletteID = @ColorPaletteID) = 0
BEGIN

		INSERT INTO ColorLibrary(PantoneType, PantoneNumber, PantoneName, Hex, R, G, B, C, M, Y, K, H, S, L, 
			LAB_L, LAB_A, LAB_B, CUser, CDate, MUser, MDate, ColorPaletteID, ColorSource)
		SELECT 'Burberry Default' AS ColorType, ColorCode, ColorName, Hex, R, G, B, C, M, Y, K, H, S, L, 
			LAB_L, LAB_A, LAB_B, CUser, CDate, MUser, MDate, ColorPaletteId, ColorSource 
		FROM pColorPalette WHERE ColorPaletteID = @ColorPaletteID

END
ELSE
BEGIN

		UPDATE ColorLibrary SET 
			PantoneNumber = b.ColorCode, PantoneName = b.ColorName, Hex = RIGHT(b.Hex,6)  , 
			R = b.R, G = b.G, B = b.B, C = b.C, M = b.M, 
			Y = b.Y, K = b.K, H = b.H, S = b.S, L = b.L, 
			LAB_L = b.Lab_L, LAB_A = b.LAB_A, LAB_B = b.LAB_B, 
			MUser = b.MUser, MDate = b.MDate , ColorSource = b.ColorSource
		FROM ColorLibrary a
		INNER JOIN pColorPalette b ON b.ColorPaletteID = a.ColorPaletteID
		WHERE b.ColorPaletteID = @ColorPaletteID 
		AND  a.PantoneType = 'Burberry Default'

END






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Quote_Message_Team_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_Quote_Message_Team_SELECT](@QuoteFolderID uniqueidentifier,
@TeamID uniqueidentifier)
AS SELECT     dbo.pQuoteFolderItem.QuoteFolderItemID, dbo.pQuoteFolderItemTeam.QuoteFolderID, dbo.pQuoteFolderItem.StyleID, 
                      dbo.pQuoteFolderItem.CustomField1, dbo.pQuoteFolderItem.CustomField2, dbo.pQuoteFolderItem.CustomField3, dbo.pQuoteFolderItem.CustomField4, 
                      dbo.pQuoteFolderItem.CustomField5, dbo.pQuoteFolderItem.CustomField6, dbo.pQuoteFolderItem.CustomField7, dbo.pQuoteFolderItem.CustomField8, 
                      dbo.pQuoteFolderItem.CustomField9, dbo.pQuoteFolderItem.CustomField10, dbo.pQuoteFolderItem.CustomField11, 
                      dbo.pQuoteFolderItem.CustomField12, dbo.pQuoteFolderItem.CustomField13, dbo.pQuoteFolderItem.CustomField14, 
                      dbo.pQuoteFolderItem.CustomField15, dbo.pQuoteFolderItem.CUser, dbo.pQuoteFolderItem.CDate, dbo.pQuoteFolderItem.MUser, 
                      dbo.pQuoteFolderItem.MDate, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.Description, dbo.pStyleHeader.DesignSketchID, 
                      dbo.pStyleHeader.DesignSketchVersion, dbo.pStyleHeader.StyleStatus, dbo.pQuoteFolderItem.PDFFile, dbo.pQuoteFolderItemTeam.TeamID, 
                      dbo.pQuoteFolderItemTeam.EstimatedCostType, dbo.pQuoteFolderItemTeam.EstimatedCost, dbo.pQuoteFolderItemTeam.EstimatedCostCur, 
                      dbo.pQuoteFolderItemTeam.VendorCostType, dbo.pQuoteFolderItemTeam.VendorCost, dbo.pQuoteFolderItemTeam.VendorCostCur, 
                      dbo.pQuoteFolderItemTeam.FinalCostType, dbo.pQuoteFolderItemTeam.FinalCost, dbo.pQuoteFolderItemTeam.FinalCostCur, 
                      dbo.pQuoteFolderItem.PDFDate, dbo.pQuoteFolderItem.PDFUser, dbo.pQuoteFolderItem.QuoteComments, 
                      dbo.pQuoteFolderItemTeam.QuoteFolderTeamID, dbo.pQuoteFolderItemTeam.QuoteFolderItemStatus
FROM         dbo.pQuoteFolderItem WITH (NOLOCK) INNER JOIN
                      dbo.pStyleHeader WITH (NOLOCK) ON dbo.pQuoteFolderItem.StyleID = dbo.pStyleHeader.StyleID INNER JOIN
                      dbo.pQuoteFolderItemTeam WITH (NOLOCK) ON dbo.pQuoteFolderItem.QuoteFolderItemID = dbo.pQuoteFolderItemTeam.QuoteFolderItemID
WHERE     (dbo.pQuoteFolderItemTeam.TeamID = @TeamID) AND (dbo.pQuoteFolderItemTeam.QuoteFolderID = @QuoteFolderID)
ORDER BY dbo.pQuoteFolderItem.PDFFile DESC, dbo.pStyleHeader.StyleNo



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialRequestWorkflowColorTree_SELECT]'
GO
/*
Comments:

01 - Ryan Cabanas - May 21, 2009
	Field "pMaterialRequestSubmitWorkflow.SampleWorkflowFinalDate" was removed from SELECT statement.
*/

ALTER PROCEDURE [dbo].[spx_MaterialRequestWorkflowColorTree_SELECT](
	@MaterialTradePartnerColorID uniqueidentifier, 
	@MaterialRequestWorkflowID varchar(10))
AS 

SELECT pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID, pMaterialRequestSubmitWorkflow.MaterialTradePartnerID, 
  pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowTempItemID, pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID, 
  pMaterialRequestSubmitWorkflow.MaterialID, pMaterialRequestSubmitWorkflow.MaterialColorID, pMaterialRequestSubmitWorkflow.TradePartnerID, 
  pMaterialRequestSubmitWorkflow.TradePartnerVendorID, pMaterialRequestSubmitWorkflow.Status, pMaterialRequestSubmitWorkflow.Submit, 
  pMaterialRequestSubmitWorkflow.SubmitDays, pMaterialRequestSubmitWorkflow.ResubmitDays, pMaterialRequestSubmitWorkflow.AssignedTo, 
  pMaterialRequestSubmitWorkflow.StartDate, pMaterialRequestSubmitWorkflow.DueDate, pMaterialRequestSubmitWorkflow.EndDate, 
  pMaterialRequestSubmitWorkflow.CUser, pMaterialRequestSubmitWorkflow.CDate, pMaterialRequestSubmitWorkflow.MUser, 
  pMaterialRequestSubmitWorkflow.MDate, pMaterialRequestSubmitWorkflow.TUser, pMaterialRequestSubmitWorkflow.TDate, 
  pMaterialRequestSubmitWorkflow.FinalDate, pMaterialTradePartnerColor.MaterialTradePartnerColorID, 
  pMaterialTradePartnerColor.MaterialColorID, pMaterialTradePartnerColor.MaterialColorImageID, pMaterialTradePartnerColor.MaterialColorImageVersion, 
  pMaterialTradePartnerColor.ColorFolderID, pMaterialTradePartnerColor.ColorPaletteID, pMaterialTradePartnerColor.ColorID, pMaterialTradePartnerColor.ColorCode, 
  pMaterialTradePartnerColor.ColorNo, pMaterialTradePartnerColor.ColorName, pMaterialTradePartnerColor.ColorSource, pMaterialTradePartnerColor.VendorColorCode, 
  pMaterialTradePartnerColor.VendorColorNo, pMaterialTradePartnerColor.VendorColorName, 		
CASE 
	WHEN ColorCode IS NULL THEN ColorName 
	ELSE '(' + ColorCode + ')' + ColorName 
END
AS Color, 
CASE 
	WHEN pMaterialRequestSubmitStatus.ApprovedType = 1  THEN '../System/Icons/icon_ball_green.gif'
	WHEN pMaterialRequestSubmitStatus.StatusID = 4  THEN '../System/Icons/icon_ball_red.gif'
	WHEN pMaterialRequestSubmitWorkflow.Submit = 1 THEN '../System/Icons/icon_ball_blue.gif'
	ELSE '../System/Icons/icon_ball_yellow.gif'
END
AS Icon
FROM pMaterialRequestSubmitWorkflow INNER JOIN
  pMaterialTradePartnerColor ON pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID = pMaterialTradePartnerColor.MaterialTradePartnerColorID INNER JOIN
  pMaterialRequestSubmitStatus ON pMaterialRequestSubmitWorkflow.Status = pMaterialRequestSubmitStatus.StatusID
WHERE pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID = @MaterialTradePartnerColorID AND 
	pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID = @MaterialRequestWorkflowID









GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_StyleMaterialSearch]'
GO
EXEC sp_refreshview N'[dbo].[vwx_StyleMaterialSearch]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleSpecCritical_Linked_UPDATE]'
GO
CREATE PROCEDURE [dbo].[spx_StyleSpecCritical_Linked_UPDATE]
(
	@SpecID uniqueidentifier
	,@Critical int
)
AS




/************************/
/*Declare variables.	*/
/************************/
DECLARE @SpecID_Param UNIQUEIDENTIFIER		--Keep a copy of the original parameter value.

DECLARE @StyleID UNIQUEIDENTIFIER
DECLARE @StyleSet INT
DECLARE @StyleLinkID UNIQUEIDENTIFIER
DECLARE @POM NVARCHAR(10)
DECLARE @PointMeasure NVARCHAR(225)

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @SpecID_Param = @SpecID


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,SpecID UNIQUEIDENTIFIER
	,StyleSet INT
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleID' and 'StyleSet' of the calling Style.*/
SELECT @StyleID = StyleID
	,@StyleSet = StyleSet
FROM pStyleSpec
WHERE SpecID = @SpecID_Param


/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleSpecCritical_UPDATE
			@SpecID_Param
			,@Critical
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Clear variables.*/
		SET @POM = NULL
		SET @PointMeasure = NULL


		/*Get the 'POM' and 'PointMeasure' values of the calling Style.*/
		SELECT @POM = POM
			,@PointMeasure = PointMeasur
		FROM pStyleSpec
		WHERE SpecID = @SpecID_Param


		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet AS StyleSet
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID


		/*Get and set the counts for the Multi-Cloth linked Styles.*/
		SELECT @TotalCount = COUNT(*) FROM #temp_Linked
		SET @RowCounter = 1


		/*Get the 'SpecID' of the POM for each of the Multi-Cloth linked Styles.*/
		WHILE(@RowCounter <= @TotalCount)
			BEGIN
				/*Clear variables.*/
				SET @StyleID = NULL
				SET @SpecID = NULL
				SET @StyleSet = NULL


				/*Get 'StyleID'.*/
				SELECT @StyleID = StyleID
					,@StyleSet = StyleSet
				FROM #temp_Linked
				WHERE TableRow = @RowCounter


				/*Get the 'SpecID'.*/
				SELECT @SpecID = SpecID
				FROM pStyleSpec
				WHERE StyleID = @StyleID
					AND StyleSet = @StyleSet
					AND POM = @POM
					AND PointMeasur = @PointMeasure


				/*Update the temp table with the 'SpecID'.*/
				UPDATE #temp_Linked
				SET SpecID = @SpecID
				WHERE TableRow = @RowCounter


				/*Up row counter.*/
				SET @RowCounter = @RowCounter + 1
			END
	END

/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'SpecID' of the POM for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @SpecID = NULL


		/*Get the 'SpecID' for the update.*/
		SELECT @SpecID = SpecID
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleSpecCritical_UPDATE
			@SpecID
			,@Critical


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Style_MaterialArtwork_2_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.
*/


ALTER     PROCEDURE [dbo].[rpx_Style_MaterialArtwork_2_SELECT] 
	@StyleID AS varchar(255), 
	@StyleSet As int
AS

 
CREATE TABLE #tempArtworkImages
(
	TableRow int identity(0,1),
	MaterialDescription nvarchar(255),
	FilePath nvarchar(255)
)


/*Insert the images into the temp table so that they can be arranged for a matrix.*/
INSERT INTO #tempArtworkImages (MaterialDescription, FilePath)
SELECT ('(' + sm.MaterialNo + ') ' + sm.MaterialName) AS MaterialDescription, 
	(dbo.fnx_GetStreamingImagePath(hi.ImageID, hi.[Version])) AS FilePath	--Comment #01
FROM	pStyleMaterials sm, hImage hi 
WHERE ((sm.MaterialImageID = hi.ImageID) 
	AND (sm.MaterialImageVersion = hi.Version) 
	AND (sm.StyleSet =  @StyleSet) 
	AND (sm.StyleID = @StyleID))
	AND (sm.Artwork = 1)
ORDER BY sm.MainMaterial DESC, sm.MaterialType, sm.MaterialSort, sm.MaterialNo

SELECT
	TableRow % 2 AS [Column],
	MaterialDescription,
	FilePath
FROM #tempArtworkImages

DROP TABLE #tempArtworkImages






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_ColorPaletteRGB_UPDATE]'
GO
ALTER PROCEDURE [dbo].[spx_ColorPaletteRGB_UPDATE]
(
	@ColorPaletteId  uniqueidentifier,
	@ColorRed int,
	@ColorGreen int,
	@ColorBlue int,
	@ColorHue int,
	@ColorSat int,
	@ColorLum int,
	@ColorHex varchar(6),
	@MUser nvarchar(200),
	@MDate datetime
)
AS 

IF @ColorPaletteID IS NOT NULL 
BEGIN 

	UPDATE pColorPalette SET 
		R = @ColorRed, 
		G = @ColorGreen, 
		B = @ColorBlue, 
		H = @ColorHue, 
		S = @ColorSat, 
		L = @ColorLum, 
		Hex = @ColorHex, 
		ColorImage = 0, 
		MUser = @MUser, 
		MDate = @MDate 
	WHERE 
		ColorPaletteID = @ColorPaletteID

	UPDATE ColorLibrary SET 
		R = @ColorRed, 
		G = @ColorGreen, 
		B = @ColorBlue, 
		H = @ColorHue, 
		S = @ColorSat, 
		L = @ColorLum, 
		Hex = @ColorHex, 
		MUser = @MUser, 
		MDate = @MDate 
	WHERE ColorPaletteID = @ColorPaletteID

END 


	



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Style_Component_Where]'
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[spx_Style_Component_Where](
@MaterialID uniqueidentifier,
@MaterialVersion int,
@FieldSeason varchar (100), 
@FieldYear varchar (100),
@TeamID UNIQUEIDENTIFIER 
)

AS 

CREATE TABLE #tmp (
	StyleID UNIQUEIDENTIFIER 
)

INSERT INTO #tmp (StyleID)
SELECT DISTINCT StyleID 
FROM pStyleMaterials a
WHERE a.MaterialID =  @MaterialID -- 
and MChange =  @MaterialVersion -- 


SELECT a.StyleSeasonYearID , a.StyleID ,c.StyleNo ,c.DesignSketchVersion, c.DesignSketchID 
FROM pStyleSeasonYear a 
INNER JOIN #tmp b ON a.StyleID = b.StyleID 
INNER JOIN pStyleHeader c ON c.StyleID = b.StyleID 


DROP TABLE #tmp



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Quote_Message_Trade_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[spx_Quote_Message_Trade_SELECT](@QuoteFolderItemID uniqueidentifier = '00000000-0000-0000-0000-000000000000')
AS SELECT     dbo.Users.UserId, dbo.Users.UserCode, dbo.Users.TeamID, dbo.Users.FirstName, dbo.Users.MiddleName, dbo.Users.LastName, dbo.Users.Title, 
                      dbo.Users.Birthday, dbo.Users.Company, dbo.Users.Street1, dbo.Users.Street2, dbo.Users.City, dbo.Users.State, dbo.Users.Zip, dbo.Users.Country, 
                      dbo.Users.Phone, dbo.Users.Fax, dbo.Users.Mobile, dbo.Users.UserName, dbo.Users.PassWord, dbo.Users.Email, dbo.Users.ContactName1, 
                      dbo.Users.ContactTitle1, dbo.Users.ContactEmail1, dbo.Users.ContactName2, dbo.Users.ContactTitle2, dbo.Users.ContactEmail2, 
                      dbo.Users.ContactName3, dbo.Users.ContactTitle3, dbo.Users.ContactEmail3, dbo.Users.ContactName4, dbo.Users.ContactTitle4, 
                      dbo.Users.ContactEmail4, dbo.Users.Active, dbo.pQuoteFolderItem.PDFFile, dbo.pQuoteFolderItemTeam.QuoteFolderItemID, 
                      dbo.pQuoteFolderItemTeam.QuoteFolderTeamID, dbo.pQuoteFolderItemTeam.QuoteFolderID
FROM         dbo.pQuoteFolderItemTeam WITH (NOLOCK) INNER JOIN
                      dbo.pQuoteFolderItem WITH (NOLOCK) ON dbo.pQuoteFolderItemTeam.QuoteFolderItemID = dbo.pQuoteFolderItem.QuoteFolderItemID INNER JOIN
                      dbo.Users WITH (NOLOCK) ON dbo.pQuoteFolderItemTeam.TeamID = dbo.Users.TeamID
WHERE     (dbo.pQuoteFolderItemTeam.QuoteFolderTeamID NOT IN
                          (SELECT     QuoteFolderTeamID
                            FROM          pQuoteFolderItemMessage WITH (NOLOCK)
                            WHERE      QuoteFolderItemID = @QuoteFolderItemID)) AND (dbo.pQuoteFolderItemTeam.QuoteFolderItemID = @QuoteFolderItemID) AND 
                      (dbo.Users.Active = 1) AND (dbo.pQuoteFolderItem.PDFFile = 1)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_TradePartnerVendor_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_TradePartnerVendor_SELECT](@TradePartnerVendorID uniqueidentifier)
AS SELECT     TradePartnerVendorID, VendorCode, VendorName, Address1, Address2, City, State, PostalCode, Country, PhoneNumber, FaxNumber, Username, [Password], Active, 
                      CUser, CDate, MUser, MDate, Comments, VendorCode, Agent, TradePartnerID
FROM         dbo.uTradePartnerVendor WITH (NOLOCK)
WHERE     (TradePartnerVendorID = @TradePartnerVendorID)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialRequestWorkflowID_SELECT]'
GO
CREATE PROCEDURE [dbo].[spx_MaterialRequestWorkflowID_SELECT] (
@MaterialRequestWorkflow nvarchar(200)
)
AS 

DECLARE @MaterialRequestWorkflowCode varchar(1)
DECLARE @MaterialRequestWorkflowNo int

IF @MaterialRequestWorkflow = '' 
BEGIN
	SET @MaterialRequestWorkflow = 'A' 
END

SET @MaterialRequestWorkflowCode = ISNULL(@MaterialRequestWorkflow,'A')
SET @MaterialRequestWorkflowNo =(SELECT COUNT(*) FROM pMaterialRequestWorkflow 
	WHERE MaterialRequestWorkflowID LIKE @MaterialRequestWorkflowCode + '%' 
	OR MaterialRequestWorkflow LIKE @MaterialRequestWorkflowCode + '%')
BEGIN
	SELECT @MaterialRequestWorkflowCode + (REPLACE(STR(@MaterialRequestWorkflowNo + 1, 2), SPACE(1), '0') )
END


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleSpecLink_Linked_REMOVE]'
GO
CREATE PROCEDURE [dbo].[spx_StyleSpecLink_Linked_REMOVE]
(
	@StyleID uniqueidentifier,
	@StyleSet int
)

AS 


/************************/
/*Declare variables.	*/
/************************/
DECLARE @StyleID_Param UNIQUEIDENTIFIER		--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT					--Keep a copy of the original parameter value.

DECLARE @StyleLinkID UNIQUEIDENTIFIER
DECLARE @POM NVARCHAR(10)
DECLARE @PointMeasure NVARCHAR(225)

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleSpecLink_REMOVE
			@StyleID_Param
			,@StyleSet_Param
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet_Param AS StyleSet
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID
	END

/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' of the POM for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Get the 'StyleID' for the reset.*/
		SELECT @StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleSpecLink_REMOVE
			@StyleID
			,@StyleSet


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[vwx_StyleSampleRequest_Search_SEL]'
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE VIEW [dbo].[vwx_StyleSampleRequest_Search_SEL] 
AS

SELECT b.*, a.StyleSeasonYearID, a.SeasonYearID
FROM pStyleSeasonYear a 
RIGHT OUTER JOIN pStyleHeader b ON a.StyleID  = b.StyleID 

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_TradePartnerVendor_UPDATE]'
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[spx_TradePartnerVendor_UPDATE]
(
@TradePartnerVendorID uniqueidentifier,
@TradePartnerID uniqueidentifier,
@VendorCode nvarchar(200),
@VendorName nvarchar(200),
@Address1 nvarchar(200),
@Address2 nvarchar(200),
@City nvarchar(100),
@State nvarchar(50),
@PostalCode nvarchar(50),
@Country nvarchar(100),
@PhoneNumber nvarchar(50),
@FaxNumber nvarchar(50),
@Active nvarchar(10),
@ModifiedBy nvarchar(50),
@Modifieddate datetime,
@Comments nvarchar(4000)
)
AS 


IF (SELECT COUNT(*) FROM dbo.uTradePartnerVendor WITH (NOLOCK) WHERE (TradePartnerVendorID = @TradePartnerVendorID)) = 0
	INSERT INTO dbo.uTradePartnerVendor
	(VendorCode,VendorName, Address1, Address2, City, State, PostalCode, Country, PhoneNumber, FaxNumber, Active, MUser, MDate, Comments, TradePartnerID, 
	CUser, CDate, TradePartnerVendorID)
	VALUES (@VendorCode,@VendorName, @Address1, @Address2, @City, @State, @PostalCode, @Country, @PhoneNumber, @FaxNumber, @Active, @ModifiedBy, 
	@ModifiedDate, @Comments, @TradePartnerID, @ModifiedBy, @ModifiedDate, @TradePartnerVendorID)
ELSE
	UPDATE dbo.uTradePartnerVendor
	SET VendorCode = @VendorCode ,VendorName = @VendorName, Address1 = @Address1, Address2 = @Address2, City = @City, State = @State, PostalCode = @PostalCode, 
	Country = @Country, PhoneNumber = @PhoneNumber, FaxNumber = @FaxNumber, Active = @Active, MUser = @ModifiedBy, MDate = @ModifiedDate,
	Comments = @Comments
	WHERE (TradePartnerVendorID = @TradePartnerVendorID)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcingMaterialColorway_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_StyleSourcingMaterialColorway_SELECT] (
@StyleSourcingID UNIQUEIDENTIFIER
)
AS 
BEGIN 

--COUNT, SUM, MIN, MAX or AVG

DECLARE @StyleID varchar(40)
DECLARE @StyleSet CHAR(1)


SELECT @StyleID = StyleID FROM pStyleSourcing WHERE StyleSourcingID = @StyleSourcingID
SET @StyleSet = '1'

INSERT INTO [dbo].[pStyleSourcingItem]
           ([StyleSourcingItemID]
		   ,[StyleSourcingID]
           ,[StyleMaterialID]
           ,[TradePartnerVendorID]
           ,[UOM]
           ,[Qty]
           ,[MaterialPrice]
           ,[Sort]
           ,[StyleColorID]
           ,[StyleSet]
           ,[BOM])
SELECT      newid()
			,@StyleSourcingID
			,pStyleMaterials.StyleMaterialID
			,'00000000-0000-0000-0000-000000000000'
			,pStyleMaterials.UOM
			,pStyleMaterials.Qty
			,pStyleMaterials.MaterialPrice 
			,pStyleMaterials.MaterialSort
			,pStyleColorway.StyleColorID
			,pStyleColorway.StyleSet
			,1
FROM pStyleMaterials INNER JOIN
	pStyleColorway ON pStyleMaterials.StyleID = pStyleColorway.StyleID AND 
	pStyleMaterials.StyleSet = pStyleColorway.StyleSet
WHERE pStyleMaterials.StyleID = @StyleID AND 
	(CAST(pStyleColorway.StyleColorID AS VARCHAR(40)) + CAST(pStyleMaterials.StyleMaterialID AS VARCHAR(40)) NOT IN (
	SELECT CAST(StyleColorID AS VARCHAR(40)) + CAST(StyleMaterialID AS VARCHAR(40)) FROM pStyleSourcingItem WHERE StyleSourcingID = @StyleSourcingID))

SELECT 
CASE 
	WHEN pStyleMaterials.MainMaterial = 0 THEN  2
	ELSE pStyleMaterials.MainMaterial
END AS MainMaterial,  dbo.pComponentType.ComponentOrder, dbo.pStyleMaterials.StyleMaterialID, dbo.pStyleMaterials.Placement, 
      dbo.pStyleMaterials.MaterialNo, dbo.pStyleMaterials.MaterialName, dbo.pStyleMaterials.MaterialType, dbo.pStyleMaterials.Development, 
      dbo.pStyleMaterials.MiscColor, dbo.pStyleMaterials.StyleSet, dbo.pStyleMaterials.StyleID, dbo.pStyleMaterials.UOM, dbo.pStyleMaterials.Qty, 
      dbo.pStyleMaterials.Ext, dbo.pStyleMaterials.MaterialSize, dbo.pStyleMaterials.MaterialID, dbo.pStyleMaterials.MaterialPlacement, 
      dbo.pStyleMaterials.MaterialPlacementCode, dbo.pStyleMaterials.MaterialPlacementDetail, dbo.pStyleMaterials.MaterialImageID, 
      dbo.pStyleMaterials.MaterialImageVersion, dbo.pStyleMaterials.NoColorMatch, dbo.pStyleMaterials.SupplierID, dbo.pStyleMaterials.ComponentTypeID, 
      dbo.pStyleMaterials.A, dbo.pStyleMaterials.B, dbo.pStyleMaterials.C, dbo.pStyleMaterials.D, dbo.pStyleMaterials.E, dbo.pStyleMaterials.F, dbo.pStyleMaterials.G, 
      dbo.pStyleMaterials.H, dbo.pStyleMaterials.I, dbo.pStyleMaterials.J, dbo.pStyleMaterials.K, dbo.pStyleMaterials.L, dbo.pStyleMaterials.M, dbo.pStyleMaterials.N, 
      dbo.pStyleMaterials.O, dbo.pStyleMaterials.P, dbo.pStyleMaterials.Q, dbo.pStyleMaterials.R, dbo.pStyleMaterials.S, dbo.pStyleMaterials.T, dbo.pStyleMaterials.U, 
      dbo.pStyleMaterials.V, dbo.pStyleMaterials.W, dbo.pStyleMaterials.X, dbo.pStyleMaterials.Y, dbo.pStyleMaterials.Z, dbo.pStyleMaterials.Source, 
      dbo.pStyleMaterials.Notes, dbo.pStyleMaterials.VendorPrice, dbo.pStyleMaterials.VolumePrice, dbo.pStyleMaterials.VolumePriceMinimum, 
      dbo.pStyleMaterials.VendorProductionMin, dbo.pStyleMaterials.VendorProductionLeadTime, dbo.pStyleMaterials.DetailYesNo, dbo.pStyleMaterials.ImageType, 
      dbo.pStyleMaterials.height, dbo.pStyleMaterials.width, dbo.pStyleMaterials.CDate, dbo.pStyleMaterials.CUser, dbo.pStyleMaterials.MDate, 
      dbo.pStyleMaterials.MUser, dbo.pStyleMaterials.MChange, dbo.pStyleMaterials.SChange, dbo.pStyleMaterials.DChange, dbo.pStyleMaterials.CChange, 
      dbo.pStyleMaterials.ColorPlacement, dbo.pStyleMaterials.Artwork, dbo.pStyleMaterials.License, dbo.pStyleMaterials.Colorway, dbo.pStyleMaterials.MaterialSort, 
      dbo.pStyleMaterials.MaterialLining, dbo.pStyleMaterials.MaterialSizeID, 
      RTRIM(dbo.pStyleColorway.MainColor) AS MainColor, dbo.pStyleSourcingItem.TradePartnerVendorID, dbo.pStyleSourcingItem.BOM, 
      dbo.pComponentType.ComponentDescription, ISNULL(CAST(pStyleColorwayItem.StyleColorItemID AS VARCHAR(40)),'00000000-0000-0000-0000-000000000000') AS StyleColorItemID 
INTO #StyleMaterial 
FROM         dbo.pStyleColorway WITH (NOLOCK) INNER JOIN
      dbo.pStyleSourcingItem WITH (NOLOCK) ON dbo.pStyleColorway.StyleColorID = dbo.pStyleSourcingItem.StyleColorID INNER JOIN
      dbo.pStyleMaterials WITH (NOLOCK) ON dbo.pStyleSourcingItem.StyleMaterialID = dbo.pStyleMaterials.StyleMaterialID INNER JOIN
      dbo.pComponentType WITH (NOLOCK) ON dbo.pStyleMaterials.MaterialType = dbo.pComponentType.ComponentTypeID LEFT OUTER JOIN
      dbo.pStyleColorwayItem ON dbo.pStyleColorway.StyleColorID = dbo.pStyleColorwayItem.StyleColorID AND 
      dbo.pStyleMaterials.StyleMaterialID = dbo.pStyleColorwayItem.StyleMaterialID
WHERE pStyleSourcingItem.StyleSourcingID = @StyleSourcingID AND pStyleMaterials.StyleID = @StyleID AND pStyleMaterials.StyleSet = @StyleSet 

EXECUTE spx_Crosstab 
'SELECT * FROM #StyleMaterial',
NULL,
NULL,
'MainColor',
'StyleColorItemID',
'MAX'

DROP TABLE #StyleMaterial

END 









GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialRequestWorkflowItem_DELETE]'
GO

CREATE PROCEDURE [dbo].[spx_MaterialRequestWorkflowItem_DELETE]
(
	@MaterialRequestSubmitWorkflowID uniqueidentifier
)

AS

DECLARE @MaterialTradePartnerID varchar(40)
DECLARE @MaterialRequestWorkflowID varchar(4)
DECLARE @MaterialRequestSubmitAllColors int

SELECT 
	@MaterialRequestSubmitAllColors = MaterialRequestSubmitAllColors, 
	@MaterialTradePartnerID= MaterialTradePartnerID,
	@MaterialRequestWorkflowID= MaterialRequestWorkflowID
FROM pMaterialRequestSubmitWorkflow 
WHERE MaterialRequestSubmitWorkflowID = @MaterialRequestSubmitWorkflowID

IF @MaterialRequestSubmitAllColors = 1
BEGIN
	DELETE FROM pMaterialRequestSubmitItem WHERE MaterialRequestSubmitID IN 
		(SELECT MaterialRequestSubmitID FROM pMaterialRequestSubmit 
			WHERE MaterialRequestSubmitWorkflowID = @MaterialRequestSubmitWorkflowID)

	DELETE FROM pMaterialRequestSubmit WHERE MaterialRequestSubmitWorkflowID IN (
		SELECT MaterialRequestSubmitWorkflowID FROM dbo.pMaterialRequestSubmitWorkflow
		WHERE MaterialTradePartnerID= @MaterialTradePartnerID AND
		MaterialRequestWorkflowID= @MaterialRequestWorkflowID)

	DELETE FROM pMaterialRequestSubmitWorkflow 	WHERE MaterialTradePartnerID= @MaterialTradePartnerID AND
		MaterialRequestWorkflowID= @MaterialRequestWorkflowID	
END
ELSE
BEGIN
	DELETE FROM pMaterialRequestSubmitItem WHERE MaterialRequestSubmitID IN 
		(SELECT MaterialRequestSubmitID FROM pMaterialRequestSubmit 
			WHERE MaterialRequestSubmitWorkflowID = @MaterialRequestSubmitWorkflowID)

	DELETE FROM pMaterialRequestSubmit WHERE MaterialRequestSubmitWorkflowID = @MaterialRequestSubmitWorkflowID
	DELETE FROM pMaterialRequestSubmitWorkflow WHERE MaterialRequestSubmitWorkflowID = @MaterialRequestSubmitWorkflowID

END


/* 
Daniel 9/15/2009
This will be replaced with UPDATE pMaterialRequestSubmitWorkflow table with Active = 0 
*/
--BEGIN
--	DELETE FROM pMaterialRequestSubmitItem WHERE MaterialRequestSubmitID IN 
--		(SELECT MaterialRequestSubmitID FROM pMaterialRequestSubmit 
--			WHERE MaterialRequestSubmitWorkflowID = @MaterialRequestSubmitWorkflowID)
--
--	DELETE FROM pMaterialRequestSubmit WHERE MaterialRequestSubmitWorkflowID = @MaterialRequestSubmitWorkflowID
--	DELETE FROM pMaterialRequestSubmitWorkflow WHERE MaterialRequestSubmitWorkflowID = @MaterialRequestSubmitWorkflowID
--END

--BEGIN 
--
--	UPDATE pMaterialRequestSubmitWorkflow SET Active = 0 
--	WHERE MaterialRequestSubmitWorkflowID = @MaterialRequestSubmitWorkflowID
--
--END






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_StyleMaterial_SubComponent_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_StyleMaterial_SubComponent_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleSpecLink_Linked_UPDATE]'
GO
CREATE    PROCEDURE [dbo].[spx_StyleSpecLink_Linked_UPDATE]
(
	@StyleID uniqueidentifier,
	@StyleSet int,
	@POMTempID uniqueidentifier
)

AS 


/************************/
/*Declare variables.	*/
/************************/
DECLARE @StyleID_Param UNIQUEIDENTIFIER			--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT						--Keep a copy of the original parameter value.
DECLARE @POMTempID_Param UNIQUEIDENTIFIER		--Keep a copy of the original parameter value.

DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet
SET @POMTempID_Param = @POMTempID


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	,POMTempID UNIQUEIDENTIFIER
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleSpecLink_UPDATE
			@StyleID_Param
			,@StyleSet_Param
			,@POMTempID_Param
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet
			,POMTempID)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet_Param AS StyleSet
			,@POMTempID_Param AS POMTempID
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID
	END

/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @POMTempID = NULL
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Get the 'StyleID' for the insert.*/
		SELECT @POMTempID = POMTempID
			,@StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleSpecLink_UPDATE
			@StyleID
			,@StyleSet
			,@POMTempID


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_ColorPaletteSeasonYear_AVAILABLE]'
GO
SET QUOTED_IDENTIFIER OFF
GO


ALTER PROCEDURE [dbo].[spx_ColorPaletteSeasonYear_AVAILABLE]  (
@ColorPaletteID UNIQUEIDENTIFIER
)
AS 

--***
--** Modified by Artemio Gomez, 3/9/2010
--** Display only the seasonyears available in the ColorFolder 
--***

/*
SELECT  SeasonYearID , [Season] + ' ' + [Year] AS SeasonYear FROM  pSeasonYear 
WHERE SeasonYearID NOT IN (SELECT SeasonYearID FROM pColorPaletteSeasonYear WHERE ColorPaletteID = @ColorPaletteID)
*/

SELECT b.SeasonYearID , b.Season + ' ' + b.Year AS SeasonYear 
FROM pColorFolderSeasonYear a
INNER JOIN pSeasonYear b ON a.SeasonYearID =  b.SeasonYearID 
WHERE a.SeasonYearID NOT IN ( 
	SELECT DISTINCT SeasonYearID FROM pColorPaletteSeasonYear WHERE ColorPaletteID = @ColorPaletteID
)
AND ColorFolderID =  ( SELECT ColorFolderID FROM pColorPalette WHERE ColorPaletteID = @ColorPaletteID )
ORDER BY Sort

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Quote_Style_Team_INSERT]'
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[spx_Quote_Style_Team_INSERT]
(@TeamID uniqueidentifier,
@StyleID uniqueidentifier,
@QuoteFolderID uniqueidentifier,
@QuoteFolderItemID uniqueidentifier,
@TradePartner nvarchar(50))

	AS 


	IF (SELECT COUNT(*)  FROM pQuoteFolderItemTeam WITH (NOLOCK) WHERE StyleID = @StyleID AND TeamID = @TeamID AND QuoteFolderID = @QuoteFolderID )  = 0

	BEGIN


	INSERT INTO dbo.pQuoteFolderItemTeam
                      (QuoteFolderID, QuoteFolderItemID, StyleID, TeamID, QuoteFolderItemStatus, TradePartner)
	VALUES     (@QuoteFolderID, @QuoteFolderItemID, @StyleID, @TeamID, N'In Progress', @TradePartner)

	
	END




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcingMaterialCosting_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_StyleSourcingMaterialCosting_SELECT] (
@StyleSourcingID UNIQUEIDENTIFIER
)
AS 
BEGIN 

--COUNT, SUM, MIN, MAX or AVG

DECLARE @StyleID varchar(40)
DECLARE @StyleSet CHAR(1)


SELECT @StyleID = StyleID FROM pStyleSourcing WHERE StyleSourcingID = @StyleSourcingID
SET @StyleSet = '1'

INSERT INTO [dbo].[pStyleSourcingItem]
           ([StyleSourcingItemID]
		   ,[StyleSourcingID]
           ,[StyleMaterialID]
           ,[TradePartnerVendorID]
           ,[UOM]
           ,[Qty]
           ,[MaterialPrice]
           ,[Sort]
           ,[StyleColorID]
           ,[StyleSet]
           ,[BOM])
SELECT      newid()
			,@StyleSourcingID
			,pStyleMaterials.StyleMaterialID
			,'00000000-0000-0000-0000-000000000000'
			,pStyleMaterials.UOM
			,pStyleMaterials.Qty
			,pStyleMaterials.MaterialPrice 
			,pStyleMaterials.MaterialSort
			,pStyleColorway.StyleColorID
			,pStyleColorway.StyleSet
			,1
FROM pStyleMaterials INNER JOIN
	pStyleColorway ON pStyleMaterials.StyleID = pStyleColorway.StyleID AND 
	pStyleMaterials.StyleSet = pStyleColorway.StyleSet
WHERE pStyleMaterials.StyleID = @StyleID AND 
	(CAST(pStyleColorway.StyleColorID AS VARCHAR(40)) + CAST(pStyleMaterials.StyleMaterialID AS VARCHAR(40)) NOT IN (
	SELECT CAST(StyleColorID AS VARCHAR(40)) + CAST(StyleMaterialID AS VARCHAR(40)) FROM pStyleSourcingItem WHERE StyleSourcingID = @StyleSourcingID))


SELECT dbo.pStyleMaterials.MainMaterial, pComponentType.ComponentOrder, dbo.pStyleMaterials.StyleMaterialID,  dbo.pStyleMaterials.Placement, dbo.pStyleMaterials.MaterialNo, 
      dbo.pStyleMaterials.MaterialName, dbo.pStyleMaterials.MaterialType, dbo.pStyleMaterials.StyleMaterialMasterID, dbo.pStyleMaterials.CopyStyleMaterialID, 
      dbo.pStyleMaterials.Development, dbo.pStyleMaterials.MiscColor, dbo.pStyleMaterials.StyleSet, dbo.pStyleMaterials.StyleID, dbo.pStyleMaterials.UOM, 
      dbo.pStyleMaterials.Qty, dbo.pStyleMaterials.Ext, dbo.pStyleMaterials.MaterialSize, dbo.pStyleMaterials.MaterialID, dbo.pStyleMaterials.MaterialPlacement, 
      dbo.pStyleMaterials.MaterialPlacementCode, dbo.pStyleMaterials.MaterialPlacementDetail, dbo.pStyleMaterials.MaterialImageID, 
      dbo.pStyleMaterials.MaterialImageVersion, dbo.pStyleMaterials.NoColorMatch, dbo.pStyleMaterials.SupplierID, dbo.pStyleMaterials.ComponentTypeID, 
      dbo.pStyleMaterials.A, dbo.pStyleMaterials.B, dbo.pStyleMaterials.C, dbo.pStyleMaterials.D, dbo.pStyleMaterials.E, dbo.pStyleMaterials.F, dbo.pStyleMaterials.G, 
      dbo.pStyleMaterials.H, dbo.pStyleMaterials.I, dbo.pStyleMaterials.J, dbo.pStyleMaterials.K, dbo.pStyleMaterials.L, dbo.pStyleMaterials.M, dbo.pStyleMaterials.N, 
      dbo.pStyleMaterials.O, dbo.pStyleMaterials.P, dbo.pStyleMaterials.Q, dbo.pStyleMaterials.R, dbo.pStyleMaterials.S, dbo.pStyleMaterials.T, dbo.pStyleMaterials.U, 
      dbo.pStyleMaterials.V, dbo.pStyleMaterials.W, dbo.pStyleMaterials.X, dbo.pStyleMaterials.Y, dbo.pStyleMaterials.Z, dbo.pStyleMaterials.Source, 
      dbo.pStyleMaterials.Notes, dbo.pStyleMaterials.VendorPrice, dbo.pStyleMaterials.VolumePrice, dbo.pStyleMaterials.VolumePriceMinimum, 
      dbo.pStyleMaterials.VendorProductionMin, dbo.pStyleMaterials.VendorProductionLeadTime, dbo.pStyleMaterials.DetailYesNo, dbo.pStyleMaterials.ImageType, 
      dbo.pStyleMaterials.height, dbo.pStyleMaterials.width, dbo.pStyleMaterials.CDate, dbo.pStyleMaterials.CUser, dbo.pStyleMaterials.MDate, 
      dbo.pStyleMaterials.MUser, dbo.pStyleMaterials.MChange, dbo.pStyleMaterials.SChange, dbo.pStyleMaterials.DChange, dbo.pStyleMaterials.CChange, 
      dbo.pStyleMaterials.ColorPlacement, dbo.pStyleMaterials.Artwork, dbo.pStyleMaterials.License, dbo.pStyleMaterials.Colorway, 
      dbo.pStyleMaterials.MaterialSort,
      dbo.pStyleMaterials.MaterialLining, dbo.pStyleMaterials.MaterialSizeID, dbo.pStyleSourcingItem.MaterialPrice, 
      RTRIM(pStyleColorway.MainColor) AS MainColor, dbo.pStyleSourcingItem.TradePartnerVendorID, dbo.pStyleSourcingItem.BOM,
	  dbo.pComponentType.ComponentDescription
INTO #StyleMaterial 
FROM  dbo.pStyleColorway WITH (NOLOCK) INNER JOIN
      dbo.pStyleSourcingItem WITH (NOLOCK) ON dbo.pStyleColorway.StyleColorID = dbo.pStyleSourcingItem.StyleColorID INNER JOIN
      dbo.pStyleMaterials WITH (NOLOCK) ON dbo.pStyleSourcingItem.StyleMaterialID = dbo.pStyleMaterials.StyleMaterialID INNER JOIN
      dbo.pComponentType WITH (NOLOCK) ON dbo.pStyleMaterials.MaterialType = dbo.pComponentType.ComponentTypeID
WHERE pStyleSourcingItem.StyleSourcingID = @StyleSourcingID AND pStyleMaterials.StyleID = @StyleID AND pStyleMaterials.StyleSet = @StyleSet  

EXECUTE spx_Crosstab 
'SELECT * FROM #StyleMaterial',
NULL,
NULL,
'MainColor',
'MaterialPrice',
'MAX'


DROP TABLE #StyleMaterial

END 











GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialRequestWorkflowItem_INSERT]'
GO


CREATE PROCEDURE [dbo].[spx_MaterialRequestWorkflowItem_INSERT]
(
	@MaterialTradePartnerColorID uniqueidentifier,
	@MaterialTradePartnerID uniqueidentifier,
	@MaterialRequestWorkflowID varchar(4),
	@MaterialRequestWorkflowGroupID uniqueidentifier,
	@CreatedBy nvarchar(200),
	@CreatedDate datetime
)

AS

--
--DECLARE @MaterialTradePartnerColorID varchar(40)
--DECLARE @MaterialTradePartnerID varchar(40)
--DECLARE @MaterialRequestWorkflowID varchar(4)
--DECLARE @MaterialRequestWorkflowGroupID varchar(40)
--DECLARE @CreatedBy varchar(200)
--DECLARE @CreatedDate datetime
----
--SELECT
--	@CreatedBy=N'Daniel Pak',
--	@CreatedDate='2009-10-19 15:12:28:000',
--	@MaterialTradePartnerColorID='58cc23c9-9bcb-4b05-9de0-8ed8c3baa237',
--	@MaterialTradePartnerID='0dcb4ad6-b453-49e9-b2bb-65e7a03f5142',
--	@MaterialRequestWorkflowGroupID='b4ff5dc2-e551-412e-a6de-3a5f7c2f4a62',
--	@MaterialRequestWorkflowID='A90'

BEGIN TRY
	BEGIN TRAN
		DECLARE @MaterialRequestSubmitGroupID uniqueidentifier
		DECLARE @MaterialRequestSubmitAllColors int
		DECLARE @MaterialRequestWorkflowTempID uniqueidentifier
		DECLARE @MaterialRequestWorkflowStartDate datetime
		DECLARE @MaterialRequestWorkflowDueDate datetime
		DECLARE @MaterialRequestWorkflowTempItemID uniqueidentifier
		DECLARE @MaterialRequestWorkflowAssignedTo int
		DECLARE @MaterialRequestWorkflowAlerts int
		DECLARE @MaterialRequestWorkflowSort varchar(5)
		DECLARE @MaterialRequestWorkflowDays int
		DECLARE @MaterialRequestWorkflowRDays int
		DECLARE @MaterialRequestWorkflowFinalDate datetime
		DECLARE @MaterialID uniqueidentifier
		DECLARE @MaterialColorID uniqueidentifier
		DECLARE @TradePartnerID uniqueidentifier
		DECLARE @TradePartnerVendorID uniqueidentifier

		DECLARE @MaterialRequestSubmitID uniqueidentifier
		DECLARE @MaterialRequestSubmitWorkflowID uniqueidentifier

		--SELECT ID's
		SELECT @MaterialRequestWorkflowTempID = MaterialRequestWorkflowTempID,
				@MaterialRequestWorkflowStartDate = MaterialRequestWorkflowStartDate,
				@MaterialRequestWorkflowDueDate = MaterialRequestWorkflowDueDate,
				@MaterialID = MaterialID,
				@TradePartnerID = TradePartnerID, 
				@TradePartnerVendorID = TradePartnerVendorID 
		FROM pMaterialTradePartner WHERE MaterialTradePartnerID = @MaterialTradePartnerID

		--Check if ALLCOLORS it will group all the colors to one submit
		SELECT @MaterialRequestSubmitAllColors = MaterialRequestWorkflowColor FROM pMaterialRequestWorkflow 
			WHERE MaterialRequestWorkflowID= @MaterialRequestWorkflowID

		--INSERT All color across all submits
		CREATE TABLE #tmpMaterialTradePartnerColor(
			[RecID]	int IDENTITY(1,1)  NOT NULL,
			[MaterialTradePartnerColorID] [uniqueidentifier] NULL,
			[MaterialTradePartnerID] [uniqueidentifier] NULL,
			[MaterialColorID] [uniqueidentifier] NULL,
			[MaterialID] [uniqueidentifier] NULL
		) 

		DECLARE @RowMaterialTradeColorLoop int
		DECLARE @RowMaterialTradeColorCount int
		DECLARE @tmpMaterialTradePartnerColorID	uniqueidentifier
		DECLARE @tmpMaterialColorID	uniqueidentifier

		BEGIN
			INSERT INTO #tmpMaterialTradePartnerColor
				(MaterialTradePartnerColorID, MaterialTradePartnerID, MaterialColorID, MaterialID)
			SELECT MaterialTradePartnerColorID, MaterialTradePartnerID, MaterialColorID, MaterialID 
			FROM pMaterialTradePartnerColor WHERE MaterialtradePartnerID = @MaterialTradePartnerID
		END
		-------------------------------------------
		
		IF @MaterialRequestSubmitAllColors = 1
		BEGIN
			SET @RowMaterialTradeColorLoop = 1
			SET @RowMaterialTradeColorCount = (SELECT COUNT(*) FROM #tmpMaterialTradePartnerColor)
			
			--GET Main MaterialTradePartnerColorID
			SELECT TOP 1 @MaterialTradePartnerColorID = MaterialTradePartnerColorID FROM pMaterialTradePartnerColor WHERE MaterialtradePartnerID = @MaterialTradePartnerID ORDER BY CDate ASC				
			IF (SELECT COUNT(*) FROM pMaterialRequestSubmitGroup WHERE MaterialTradePartnerID = @MaterialTradePartnerID AND MaterialRequestWorkflowID= @MaterialRequestWorkflowID) = 0
				BEGIN
					SELECT @MaterialRequestSubmitGroupID = newid()
					INSERT INTO pMaterialRequestSubmitGroup(MaterialRequestSubmitGroupID, MaterialTradePartnerID, MaterialRequestWorkflowID, MaterialTradePartnerColorID)
					VALUES (@MaterialRequestSubmitGroupID, @MaterialTradePartnerID, @MaterialRequestWorkflowID, @MaterialTradePartnerColorID)		
				END
			ELSE
				BEGIN
					SELECT @MaterialRequestSubmitGroupID = MaterialRequestSubmitGroupID FROM pMaterialRequestSubmitGroup
					WHERE MaterialTradePartnerID  = @MaterialTradePartnerID 
						AND MaterialRequestWorkflowID = @MaterialRequestWorkflowID
						AND MaterialTradePartnerColorID = @MaterialTradePartnerColorID
				END

			WHILE @RowMaterialTradeColorLoop <= @RowMaterialTradeColorCount 
				BEGIN
					SELECT @tmpMaterialTradePartnerColorID = MaterialTradePartnerColorID, @tmpMaterialColorID = MaterialColorID 
						FROM #tmpMaterialTradePartnerColor WHERE RecID = @RowMaterialTradeColorLoop

						--DON'T INSERT SELECTED MarterialTradePartnerColorID 
						IF @tmpMaterialTradePartnerColorID <> @MaterialTradePartnerColorID
						BEGIN				
						SELECT 
							@MaterialRequestWorkflowTempItemID = MaterialRequestWorkflowTempItemID, 
							@MaterialRequestWorkflowAssignedTo = MaterialRequestWorkflowAssignedTo, 
							@MaterialRequestWorkflowDays = ISNULL(MaterialRequestWorkflowDays, 0), 
							@MaterialRequestWorkflowRDays = ISNULL(MaterialRequestWorkflowRDays, 0), 
							@MaterialRequestWorkflowFinalDate = MaterialRequestWorkflowFinalDate, 
							@MaterialRequestWorkflowAlerts = ISNULL(MaterialRequestWorkflowAlerts, 0),  
							@MaterialRequestWorkflowSort = ISNULL(MaterialRequestWorkflowSort, '0000')
						FROM pMaterialRequestWorkflowTemplateItem
						WHERE MaterialRequestWorkflowTempID = @MaterialRequestWorkflowTempID
							AND MaterialRequestWorkflowID = @MaterialRequestWorkflowID

							SET @MaterialRequestSubmitID = newid()
							SET @MaterialRequestSubmitWorkflowID = newid()

							INSERT INTO pMaterialRequestSubmit (MaterialRequestSubmitID, MaterialRequestSubmitWorkflowID, MaterialTradePartnerColorID, 
								MaterialTradePartnerID, MaterialRequestSubmitGroupID, Submit, Status, 
								AssignedTo, StartDate, SubmitDays, ResubmitDays, DueDate, CUser, CDate, MUser, MDate) 
							VALUES (@MaterialRequestSubmitID, @MaterialRequestSubmitWorkflowID, @tmpMaterialTradePartnerColorID,
								@MaterialTradePartnerID, @MaterialRequestSubmitGroupID, 1, 0,
								@MaterialRequestWorkflowAssignedTo, @MaterialRequestWorkflowStartDate + @MaterialRequestWorkflowDays, @MaterialRequestWorkflowDays, 
								@MaterialRequestWorkflowRDays, @MaterialRequestWorkflowDueDate, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate)  
									
							INSERT INTO pMaterialRequestSubmitWorkflow(MaterialRequestSubmitWorkflowID, MaterialRequestSubmitGroupID, MaterialTradePartnerID, 
								MaterialTradePartnerColorID, MaterialRequestWorkflowTempItemID, 
								MaterialRequestWorkflowGroupID, MaterialRequestWorkflowID, MaterialRequestSubmitAllColors, 
								MaterialID, MaterialColorID, TradePartnerID, TradePartnerVendorID, 
								Status, Submit, SubmitDays, ResubmitDays, AssignedTo, 
								StartDate, DueDate, CUser, CDate, MUser, MDate, AgentView, Active)
							VALUES (@MaterialRequestSubmitWorkflowID, @MaterialRequestSubmitGroupID, @MaterialTradePartnerID, 
								@tmpMaterialTradePartnerColorID, @MaterialRequestWorkflowTempItemID, 
								@MaterialRequestWorkflowGroupID, @MaterialRequestWorkflowID, @MaterialRequestSubmitAllColors, 
								@MaterialID, @tmpMaterialColorID, @TradePartnerID, @TradePartnerVendorID, 
								0, 1, @MaterialRequestWorkflowDays, @MaterialRequestWorkflowRDays, @MaterialRequestWorkflowAssignedTo, 
								@MaterialRequestWorkflowStartDate + @MaterialRequestWorkflowDays, @MaterialRequestWorkflowDueDate, 
								@CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate, 0, 1)
						END
					SET @RowMaterialTradeColorLoop = @RowMaterialTradeColorLoop + 1	
					END
	
					BEGIN

		
						SELECT @MaterialRequestSubmitID = newid()
						SELECT @MaterialRequestSubmitWorkflowID = newid()

						BEGIN
							UPDATE pMaterialRequestSubmitWorkflow SET MaterialRequestSubmitGroupID = @MaterialRequestSubmitGroupID
							WHERE MaterialTradePartnerID= @MaterialTradePartnerID AND
							MaterialRequestWorkflowID= @MaterialRequestWorkflowID	

							UPDATE pMaterialRequestSubmit SET MaterialRequestSubmitGroupID = @MaterialRequestSubmitGroupID
							WHERE MaterialRequestSubmitWorkflowID IN (
								SELECT MaterialRequestSubmitWorkflowID FROM dbo.pMaterialRequestSubmitWorkflow
								WHERE MaterialTradePartnerID= @MaterialTradePartnerID AND
								MaterialRequestWorkflowID= @MaterialRequestWorkflowID)

							SELECT @MaterialRequestWorkflowTempID = MaterialRequestWorkflowTempID,
									@MaterialRequestWorkflowStartDate = MaterialRequestWorkflowStartDate,
									@MaterialRequestWorkflowDueDate = MaterialRequestWorkflowDueDate,
									@MaterialID = MaterialID,
									@TradePartnerID = TradePartnerID, 
									@TradePartnerVendorID = TradePartnerVendorID 
							FROM pMaterialTradePartner WHERE MaterialTradePartnerID = @MaterialTradePartnerID

							SELECT @MaterialColorID = MaterialColorID
							FROM pMaterialTradePartnerColor 
							WHERE MaterialTradePartnerID = @MaterialTradePartnerID AND MaterialTradePartnerColorID = @MaterialTradePartnerColorID 

							INSERT INTO pMaterialRequestSubmit (MaterialRequestSubmitID, MaterialRequestSubmitWorkflowID, MaterialTradePartnerColorID, 
								MaterialTradePartnerID, MaterialRequestSubmitGroupID, Submit, Status, 
								AssignedTo, StartDate, SubmitDays, ResubmitDays, DueDate, CUser, CDate, MUser, MDate) 
							VALUES (@MaterialRequestSubmitID, @MaterialRequestSubmitWorkflowID, @MaterialTradePartnerColorID,
								@MaterialTradePartnerID, @MaterialRequestSubmitGroupID, 1, 0,
								@MaterialRequestWorkflowAssignedTo, @MaterialRequestWorkflowStartDate + @MaterialRequestWorkflowDays, @MaterialRequestWorkflowDays, 
								@MaterialRequestWorkflowRDays, @MaterialRequestWorkflowDueDate, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate)  
									
							INSERT INTO pMaterialRequestSubmitWorkflow(MaterialRequestSubmitWorkflowID, MaterialRequestSubmitGroupID, MaterialTradePartnerID, 
								MaterialTradePartnerColorID, MaterialRequestWorkflowTempItemID, 
								MaterialRequestWorkflowGroupID, MaterialRequestWorkflowID, MaterialRequestSubmitAllColors, 
								MaterialID, MaterialColorID, TradePartnerID, TradePartnerVendorID, 
								Status, Submit, SubmitDays, ResubmitDays, AssignedTo, 
								StartDate, DueDate, CUser, CDate, MUser, MDate, AgentView, Active)
							VALUES (@MaterialRequestSubmitWorkflowID, @MaterialRequestSubmitGroupID, @MaterialTradePartnerID, 
								@MaterialTradePartnerColorID, @MaterialRequestWorkflowTempItemID, 
								@MaterialRequestWorkflowGroupID, @MaterialRequestWorkflowID, @MaterialRequestSubmitAllColors, 
								@MaterialID, @MaterialColorID, @TradePartnerID, @TradePartnerVendorID, 
								0, 1, @MaterialRequestWorkflowDays, @MaterialRequestWorkflowRDays, @MaterialRequestWorkflowAssignedTo, 
								@MaterialRequestWorkflowStartDate + @MaterialRequestWorkflowDays, @MaterialRequestWorkflowDueDate, 
								@CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate, 0, 1)

							INSERT INTO pMaterialRequestSubmitItem (
								MaterialRequestSubmitID, MaterialRequestSubmitItemStatus, MaterialRequestSubmitItemCustom1, 
								MaterialRequestSubmitItemCustom2, MaterialRequestSubmitItemCustom3, MaterialRequestSubmitItemCustom4, MaterialRequestSubmitItemCustom5, 
								MaterialRequestSubmitItemCustom6, MaterialRequestSubmitItemCustom7, MaterialRequestSubmitItemCustom8, MaterialRequestSubmitItemCustom9, 
								MaterialRequestSubmitItemCustom10, MaterialRequestSubmitItemSort, CUser, CDate, MUser, MDate
							) 
							SELECT @MaterialRequestSubmitID, 0, MaterialRequestWorkflowItemCustom1, 
								  MaterialRequestWorkflowItemCustom2, MaterialRequestWorkflowItemCustom3, MaterialRequestWorkflowItemCustom4, MaterialRequestWorkflowItemCustom5, 
								  MaterialRequestWorkflowItemCustom6, MaterialRequestWorkflowItemCustom7, MaterialRequestWorkflowItemCustom8, MaterialRequestWorkflowItemCustom9, 
								  MaterialRequestWorkflowItemCustom10, MaterialRequestWorkflowItemSort, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate
							FROM pMaterialRequestWorkflowItem
							WHERE MaterialRequestWorkflowGroupID = @MaterialRequestWorkflowGroupID 
								AND MaterialRequestWorkflowID = @MaterialRequestWorkflowID

						END
				END
			END

		ELSE

			BEGIN

				SELECT @MaterialColorID = MaterialColorID
				FROM pMaterialTradePartnerColor 
				WHERE MaterialTradePartnerID = @MaterialTradePartnerID AND MaterialTradePartnerColorID = @MaterialTradePartnerColorID 

				SELECT 
					@MaterialRequestWorkflowTempItemID = MaterialRequestWorkflowTempItemID, 
					@MaterialRequestWorkflowAssignedTo = MaterialRequestWorkflowAssignedTo, 
					@MaterialRequestWorkflowDays = ISNULL(MaterialRequestWorkflowDays, 0), 
					@MaterialRequestWorkflowRDays = ISNULL(MaterialRequestWorkflowRDays, 0), 
					@MaterialRequestWorkflowFinalDate = MaterialRequestWorkflowFinalDate, 
					@MaterialRequestWorkflowAlerts = ISNULL(MaterialRequestWorkflowAlerts, 0),  
					@MaterialRequestWorkflowSort = ISNULL(MaterialRequestWorkflowSort, '0000')
				FROM pMaterialRequestWorkflowTemplateItem
				WHERE MaterialRequestWorkflowTempID = @MaterialRequestWorkflowTempID
					--AND MaterialRequestWorkflowGroupID = @MaterialRequestWorkflowGroupID 
					AND MaterialRequestWorkflowID = @MaterialRequestWorkflowID

				SET @MaterialRequestSubmitID = newid()
				SET @MaterialRequestSubmitWorkflowID = newid()

				INSERT INTO pMaterialRequestSubmit (MaterialRequestSubmitID, MaterialRequestSubmitWorkflowID, MaterialTradePartnerColorID, 
					MaterialTradePartnerID, MaterialRequestSubmitGroupID, Submit, Status, 
					AssignedTo, StartDate, SubmitDays, ResubmitDays, DueDate, CUser, CDate, MUser, MDate) 
				VALUES (@MaterialRequestSubmitID, @MaterialRequestSubmitWorkflowID, @MaterialTradePartnerColorID,
					@MaterialTradePartnerID, @MaterialRequestSubmitGroupID, 1, 0,
					@MaterialRequestWorkflowAssignedTo, @MaterialRequestWorkflowStartDate + @MaterialRequestWorkflowDays, @MaterialRequestWorkflowDays, 
					@MaterialRequestWorkflowRDays, @MaterialRequestWorkflowDueDate, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate)  
						
				INSERT INTO pMaterialRequestSubmitWorkflow(MaterialRequestSubmitWorkflowID, MaterialRequestSubmitGroupID, MaterialTradePartnerID, 
					MaterialTradePartnerColorID, MaterialRequestWorkflowTempItemID, 
					MaterialRequestWorkflowGroupID, MaterialRequestWorkflowID, MaterialRequestSubmitAllColors, 
					MaterialID, MaterialColorID, TradePartnerID, TradePartnerVendorID, 
					Status, Submit, SubmitDays, ResubmitDays, AssignedTo, 
					StartDate, DueDate, CUser, CDate, MUser, MDate, AgentView, Active)
				VALUES (@MaterialRequestSubmitWorkflowID, @MaterialRequestSubmitGroupID, @MaterialTradePartnerID, 
					@MaterialTradePartnerColorID, @MaterialRequestWorkflowTempItemID, 
					@MaterialRequestWorkflowGroupID, @MaterialRequestWorkflowID, @MaterialRequestSubmitAllColors, 
					@MaterialID, @MaterialColorID, @TradePartnerID, @TradePartnerVendorID, 
					0, 1, @MaterialRequestWorkflowDays, @MaterialRequestWorkflowRDays, @MaterialRequestWorkflowAssignedTo, 
					@MaterialRequestWorkflowStartDate + @MaterialRequestWorkflowDays, @MaterialRequestWorkflowDueDate, 
					@CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate, 0, 1)

				INSERT INTO pMaterialRequestSubmitItem (
					MaterialRequestSubmitID, MaterialRequestSubmitItemStatus, MaterialRequestSubmitItemCustom1, 
					MaterialRequestSubmitItemCustom2, MaterialRequestSubmitItemCustom3, MaterialRequestSubmitItemCustom4, MaterialRequestSubmitItemCustom5, 
					MaterialRequestSubmitItemCustom6, MaterialRequestSubmitItemCustom7, MaterialRequestSubmitItemCustom8, MaterialRequestSubmitItemCustom9, 
					MaterialRequestSubmitItemCustom10, MaterialRequestSubmitItemSort, CUser, CDate, MUser, MDate
				) 
				SELECT @MaterialRequestSubmitID, 0, MaterialRequestWorkflowItemCustom1, 
					  MaterialRequestWorkflowItemCustom2, MaterialRequestWorkflowItemCustom3, MaterialRequestWorkflowItemCustom4, MaterialRequestWorkflowItemCustom5, 
					  MaterialRequestWorkflowItemCustom6, MaterialRequestWorkflowItemCustom7, MaterialRequestWorkflowItemCustom8, MaterialRequestWorkflowItemCustom9, 
					  MaterialRequestWorkflowItemCustom10, MaterialRequestWorkflowItemSort, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate
				FROM pMaterialRequestWorkflowItem
				WHERE MaterialRequestWorkflowGroupID = @MaterialRequestWorkflowGroupID 
					AND MaterialRequestWorkflowID = @MaterialRequestWorkflowID

			END

--		SELECT * FROM pMaterialRequestSubmitWorkflow 
--							WHERE MaterialTradePartnerID= @MaterialTradePartnerID AND
--							MaterialRequestWorkflowID= @MaterialRequestWorkflowID	

		DROP TABLE #tmpMaterialTradePartnerColor

	--ROLLBACK TRAN;
	COMMIT TRAN;
END TRY

BEGIN CATCH
		DECLARE @ERROR_MESSAGE VARCHAR(MAX)
		DECLARE @ERROR_LINE VARCHAR(10)
		DECLARE @ERROR_PROCEDURE VARCHAR(MAX)
		DECLARE @ERROR_STATE VARCHAR(200)
		DECLARE @ERROR_SEVERITY VARCHAR(10)
		DECLARE @ERROR_NUMBER VARCHAR(10)
		DECLARE @ERROR_RETURN VARCHAR(MAX)

		SELECT ERROR_PROCEDURE()

		SELECT  @ERROR_NUMBER = ERROR_NUMBER(),  
		@ERROR_SEVERITY = ERROR_SEVERITY(),  
		@ERROR_STATE = ERROR_STATE(),  
		@ERROR_PROCEDURE = ERROR_PROCEDURE(),  
		@ERROR_LINE = ERROR_LINE(),  
		@ERROR_MESSAGE = ERROR_MESSAGE();
		SET @ERROR_RETURN = @ERROR_MESSAGE + ' LINE:' + @ERROR_LINE + ' PROC:' + ISNULL(@ERROR_PROCEDURE, 'UNKNOWN')
		RAISERROR(@ERROR_RETURN ,14,1)
	ROLLBACK TRAN
END CATCH






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_Style_Search_Default_SELECT]'
GO
EXEC sp_refreshview N'[dbo].[vwx_Style_Search_Default_SELECT]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleSpecLinked_Linked_UPDATE]'
GO
CREATE PROCEDURE [dbo].[spx_StyleSpecLinked_Linked_UPDATE]
(
	@SpecID UNIQUEIDENTIFIER
)

AS


/************************/
/*Declare variables.	*/
/************************/
DECLARE @SpecID_Param UNIQUEIDENTIFIER		--Keep a copy of the original parameter value.

DECLARE @StyleID UNIQUEIDENTIFIER
DECLARE @StyleSet INT
DECLARE @StyleLinkID UNIQUEIDENTIFIER
DECLARE @POM NVARCHAR(10)
DECLARE @PointMeasure NVARCHAR(225)

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @SpecID_Param = @SpecID


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,SpecID UNIQUEIDENTIFIER
	,StyleSet INT
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleID' and 'StyleSet' of the calling Style.*/
SELECT @StyleID = StyleID
	,@StyleSet = StyleSet
FROM pStyleSpec
WHERE SpecID = @SpecID_Param


/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleSpecLinked_UPDATE @SpecID_Param
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Clear variables.*/
		SET @POM = NULL
		SET @PointMeasure = NULL


		/*Get the 'POM' and 'PointMeasure' values of the calling Style.*/
		SELECT @POM = POM
			,@PointMeasure = PointMeasur
		FROM pStyleSpec
		WHERE SpecID = @SpecID_Param


		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet AS StyleSet
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID


		/*Get and set the counts for the Multi-Cloth linked Styles.*/
		SELECT @TotalCount = COUNT(*) FROM #temp_Linked
		SET @RowCounter = 1


		/*Get the 'SpecID' of the POM for each of the Multi-Cloth linked Styles.*/
		WHILE(@RowCounter <= @TotalCount)
			BEGIN
				/*Clear variables.*/
				SET @StyleID = NULL
				SET @SpecID = NULL
				SET @StyleSet = NULL


				/*Get 'StyleID'.*/
				SELECT @StyleID = StyleID
					,@StyleSet = StyleSet
				FROM #temp_Linked
				WHERE TableRow = @RowCounter


				/*Get the 'SpecID'.*/
				SELECT @SpecID = SpecID
				FROM pStyleSpec
				WHERE StyleID = @StyleID
					AND StyleSet = @StyleSet
					AND POM = @POM
					AND PointMeasur = @PointMeasure


				/*Update the temp table with the 'SpecID'.*/
				UPDATE #temp_Linked
				SET SpecID = @SpecID
				WHERE TableRow = @RowCounter


				/*Up row counter.*/
				SET @RowCounter = @RowCounter + 1
			END
	END

/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'SpecID' of the POM for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @SpecID = NULL


		/*Get the 'SpecID' for the update.*/
		SELECT @SpecID = SpecID
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleSpecLinked_UPDATE @SpecID


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Material_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_Material_SELECT](@MaterialID uniqueidentifier)
AS 

SELECT ComponentDescription ,  MaterialID, TempID, TempNo, MaterialImageID, MaterialImageVersion, MaterialImageDetailID, MaterialImageDetailVersion, NoColorMatch, SupplierID, MaterialType, MaterialNo, 
   MaterialName, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S, T, U, V, W, X, Y, Z, Source, Notes, VendorPrice, VolumePrice, VolumePriceMinimum, VendorProductionMin, 
   VendorProductionLeadTime, MaterialPlacement, DetailYesNo, ImageType1, height, width, CDate, CUser, MDate, MUser, MChange, DChange, Action, Status, a.Active, MultiDimension, 
   UOM, MaterialCode, MaterialCodeNo, SAPCode, SAPControl, MaterialColorRequired, FactorySourced, TradePartnerID, TradePartnerVendorID, HeaderLocked
FROM   pMaterial a WITH (NOLOCK) ,  pComponentType b WITH (NOLOCK)
WHERE     a.MaterialID = @MaterialID 
AND a.MaterialType = b.ComponentTypeID






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Session_Data]'
GO


ALTER PROCEDURE [dbo].[spx_Session_Data] ( 
	@SESSION  int 

)
as 


	DECLARE @TeamID as uniqueidentifier 

	 SELECT   @TeamID = TeamID 
	 FROM  Users  a WITH (NOLOCK) , eMailAccounts b WITH (NOLOCK)  WHERE a.SESSION = @SESSION AND a.Email  = b.FromAddress
	

	IF  (  @TeamID is not null ) 
	BEGIN
		update Users set SessionDate = getdate()
		where TeamID = @TeamID 

		SELECT  a.*, b.MailAccountID, c.StartHour, c.EndHour 
		FROM  Users  a WITH (NOLOCK) , eMailAccounts b WITH (NOLOCK) , cCalendarTemplate c WITH (NOLOCK)
	             WHERE a.TeamID = @TeamID  and a.Email  = b.FromAddress
		and a.CalendarTemplateID = c.TemplateID

	END




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleDevelopmentItems_SELECT]'
GO
CREATE PROCEDURE [dbo].[spx_StyleDevelopmentItems_SELECT]
(@StyleDevelopmentID uniqueidentifier)
AS 

SELECT pStyleDevelopmentItem.StyleDevelopmentItemID, pStyleDevelopmentItem.StyleDevelopmentID, pStyleHeader.StyleID, 
      pStyleDevelopmentItem.Variation, pStyleHeader.DevelopmentNo, pStyleHeader.StyleNo, pStyleHeader.SizeClass, 
      pStyleHeader.SizeRange, 'VAR #: ' + CAST(pStyleDevelopmentItem.Variation AS VARCHAR(4)) + ' Style #: ' + pStyleHeader.StyleNo + ' - ' 
	+ pStyleHeader.SizeClass + ' (' +  CAST(pStyleHeader.SizeRange AS VARCHAR(200)) + ')' AS VariationName
FROM  pStyleDevelopmentItem INNER JOIN
      pStyleHeader ON pStyleDevelopmentItem.StyleID = pStyleHeader.StyleID
WHERE pStyleDevelopmentItem.StyleDevelopmentID = @StyleDevelopmentID
ORDER BY pStyleDevelopmentItem.Variation, pStyleHeader.StyleNo
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanAttribute_DELETE]'
GO
SET QUOTED_IDENTIFIER OFF
GO


ALTER PROCEDURE [dbo].[spx_LinePlanAttribute_DELETE]
(@LinePlanId nvarchar(50),
@LinePlanTemplateItemId nvarchar(50),
@CustomKey nvarchar(50))
AS 




IF  (SELECT COUNT(*) FROM pLinePlanAttributeItem WHERE LinePlanAttributeID IN ( 
	SELECT LinePlanAttributeId FROM pLinePlanAttribute 
	WHERE LinePlanID = @LinePlanID 
	AND	LinePlanTemplateItemId = @LinePlanTemplateItemId 
	AND	LinePlanAttributeValue = @CustomKey ) ) = 0
BEGIN

	--***
	--** Attribute not used in the hierarchy => delete it 
	--***
	DELETE FROM pLinePlanAttribute 
	WHERE LinePlanID = @LinePlanID 
	AND	LinePlanTemplateItemId = @LinePlanTemplateItemId 
	AND	LinePlanAttributeValue = @CustomKey

END 

	
--***
--** REMOVE orphaned records 
--***
DELETE FROM  pLinePlanAttributeItem  	
WHERE LinePlanId = @LinePlanId 
AND  LinePlanAttributeID NOT IN (
	SELECT LinePlanAttributeID FROM pLinePlanAttribute 
	WHERE LinePlanID = @LinePlanID 
)



/*
DELETE FROM  pLinePlanAttributeItem  
WHERE  LinePlanAttributeItemID IN (
	SELECT LinePlanAttributeItemID
	FROM  pLinePlanAttributeItem 
	WHERE LinePlanID = @LinePlanID
	AND LinePlanAttributeValue = @CustomKey
	AND LinePlanAttributeItemParentID = '00000000-0000-0000-0000-000000000000'
)
*/

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialRequestWorkflowItem_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[spx_MaterialRequestWorkflowItem_SELECT]
(
	@MaterialRequestSubmitID uniqueidentifier,
	@MaterialRequestWorkflowID varchar(5)
)

AS

--	DECLARE @MaterialRequestSubmitWorkflowID uniqueidentifier
--	SELECT @MaterialRequestSubmitWorkflowID = MaterialRequestSubmitWorkflowID FROM
--		pMaterialRequestSubmit WHERE MaterialRequestSubmitID = @MaterialRequestSubmitID
--
--	IF (SELECT MaterialRequestWorkflowTempItemID FROM pMaterialRequestSubmitWorkflow
--		WHERE MaterialRequestSubmitWorkflowID = @MaterialRequestSubmitWorkflowID) <> NULL 
--		BEGIN
--			SELECT * FROM pMaterialRequestWorkflowItem WHERE MaterialRequestWorkflowID = @MaterialRequestWorkflowID
--			AND (MaterialRequestWorkflowItemID NOT IN 
--			(SELECT MaterialRequestWorkflowItemID FROM pMaterialRequestSubmitItem 
--			WHERE MaterialRequestSubmitID = @MaterialRequestSubmitID))
--		END	
--	ELSE
--		BEGIN
--			SELECT * FROM pMaterialRequestWorkflowItem WHERE MaterialRequestWorkflowID = NULL
--		END


	SELECT * FROM pMaterialRequestWorkflowItem WHERE MaterialRequestWorkflowID = @MaterialRequestWorkflowID
	AND (MaterialRequestWorkflowItemID NOT IN 
	(SELECT MaterialRequestWorkflowItemID FROM pMaterialRequestSubmitItem 
	WHERE MaterialRequestSubmitID = @MaterialRequestSubmitID))

--
--













GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_StyleSourcing_SeasonYear_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_StyleSourcing_SeasonYear_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleSpecLinkTemplate_Linked_UPDATE]'
GO
CREATE  PROCEDURE [dbo].[spx_StyleSpecLinkTemplate_Linked_UPDATE]
(
	@POMTempID uniqueidentifier, 
	@StyleID uniqueidentifier,
	@StyleSet nvarchar(5),
	@ModifiedBy nvarchar(200),
	@ModifiedDate datetime
)

AS 


/************************/
/*Declare variables.	*/
/************************/
DECLARE @POMTempID_Param UNIQUEIDENTIFIER		--Keep a copy of the original parameter value.
DECLARE @StyleID_Param UNIQUEIDENTIFIER			--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT						--Keep a copy of the original parameter value.


DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet
SET @POMTempID_Param = @POMTempID


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	,POMTempID UNIQUEIDENTIFIER
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleSpecLinkTemplate_UPDATE
			@POMTempID_Param
			,@StyleID_Param
			,@StyleSet_Param
			,@ModifiedBy
			,@ModifiedDate
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet
			,POMTempID)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet_Param AS StyleSet
			,@POMTempID_Param AS POMTempID
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID
	END

/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @POMTempID = NULL
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Get the 'StyleID' for the insert.*/
		SELECT @POMTempID = POMTempID
			,@StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleSpecLinkTemplate_UPDATE
			@POMTempID
			,@StyleID
			,@StyleSet
			,@ModifiedBy
			,@ModifiedDate


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Material_Color_INSERT]'
GO
SET QUOTED_IDENTIFIER OFF
GO


ALTER PROCEDURE [dbo].[spx_Material_Color_INSERT]  (

@MaterialColorID UNIQUEIDENTIFIER,

@MaterialID UNIQUEIDENTIFIER,

@ColorPaletteID UNIQUEIDENTIFIER,

@CUser VARCHAR(200),

@CDate DATETIME 

)

AS

BEGIN 



	DECLARE @ColorCode NVARCHAR(200)

	DECLARE @ColorName NVARCHAR(200)

	SELECT @ColorCode = ColorCode,  @ColorName = ColorName FROM pColorPalette WHERE ColorPaletteID = @ColorPaletteID

	

	IF (SELECT COUNT(*) FROM pMaterialColor WHERE ColorCode = @ColorCode) = 0 

	BEGIN

		 INSERT INTO dbo.pMaterialColor 

			 (MaterialColorID, MaterialID, ColorFolderID, ColorPaletteID, ColorCode, ColorName, ColorSource, 

			 Hex, R, G, B, C, M, Y, K, H, S, L, LAB_L, LAB_A, LAB_B, MaterialColorVersion, 

		 CDate, CUser , MDate, MUser, Sort, VendorColorCode, VendorColorName) 

		 SELECT @MaterialColorID  AS  MaterialColorID ,  @MaterialID  as MaterialID  , ColorFolderID, ColorPaletteID, ColorCode, ColorName, ColorSource,  

			 Hex, R, G, B, C, M, Y, K, H, S, L, LAB_L, LAB_A, LAB_B, Change,  

			 @CDate as CDate,  @CUser as CUSer, @CDate as MDate,  @CUser as MUSer,  Sort, ColorCode, ColorName 

		 FROM  dbo.pColorPalette  WHERE ColorPaletteID = @ColorPaletteID  

	END 



END 



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_QuoteFolder_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[spx_QuoteFolder_SELECT](@QuoteFolderID uniqueidentifier)
AS SELECT     QuoteFolderID, QuoteFolderNo, QuoteFolderType, QuoteStartDate, QuoteDueDate, QuoteFolderStatus, QuoteGroupCost, QuoteCustomField1, 
                      QuoteCustomField2, QuoteCustomField3, QuoteCustomField4, QuoteCustomField5, QuoteCustomField6, QuoteCustomField7, QuoteCustomField8, 
                      QuoteCustomField9, QuoteCustomField10, CUser, CDate, MUser, MDate
FROM         dbo.pQuoteFolder WITH (NOLOCK)
WHERE     (QuoteFolderID = @QuoteFolderID)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialRequestWorkflows_SELECT]'
GO


CREATE PROCEDURE [dbo].[spx_MaterialRequestWorkflows_SELECT] (
@MaterialID UNIQUEIDENTIFIER
)
AS 


SELECT MaterialRequestWorkflowID, MaterialRequestWorkflow, GroupName, MaterialRequestWorkflowSort
FROM  pMaterialRequestWorkflow WHERE MaterialRequestWorkflowID IN (SELECT MaterialRequestWorkflowID FROM
	pMaterialRequestSubmitWorkflow WHERE MaterialID = @MaterialID)
ORDER BY pMaterialRequestWorkflow.MaterialRequestWorkflowSort


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_MaterialTradePartnerVendorSourcing_SELECT]'
GO

ALTER VIEW [dbo].[vwx_MaterialTradePartnerVendorSourcing_SELECT]
AS
SELECT     a.MaterialID, b.TradepartnerVendorId, c.VendorName, a.MaterialSizeID, a.ColorFolderID, a.ColorPaletteID, b.SeasonYearID, a.MaterialColorID
FROM         dbo.pMaterialTradePartnerColor AS a INNER JOIN
                      dbo.pMaterialTradePartner AS b ON a.MaterialTradePartnerID = b.MaterialTradePartnerId INNER JOIN
                      dbo.uTradePartnerVendor AS c ON c.TradePartnerVendorID = b.TradepartnerVendorId

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_SampleWorkflowSubmitQA_UPDATE]'
GO


CREATE PROCEDURE [dbo].[spx_SampleWorkflowSubmitQA_UPDATE]
(@Status nvarchar(50),
@RevDate nvarchar(50),
@RevBy nvarchar(200),
@RecDate nvarchar(50),
@RecBy nvarchar(200),
@RecCarrier nvarchar(200),
@RecTrackNo nvarchar(50),
@RecWeight nvarchar(50),
@VendorWeight nvarchar(50),
@VendorName nvarchar(200),
@VendorDate nvarchar(50),
@DueDate nvarchar(50),
@EndDate nvarchar(50),
@EndBy nvarchar(200),
@SampleRequestWorkflowID uniqueidentifier,
@SampleWorkflowID nvarchar(5),
@StyleID uniqueidentifier,
@StyleColorID uniqueidentifier,
@StyleSet int,
@SampleRequestTradeID uniqueidentifier,
@Submit int,
@ModifiedBy nvarchar(200),
@ModifiedDate datetime,
@NoTolerance int = 0,
@InternalComment ntext,
@SampleLockVendorFields int = 0
)
AS 

DECLARE @vcDate as varchar (15) 


BEGIN

	IF @SampleLockVendorFields  =  0
	BEGIN 
		UPDATE    dbo.pSampleRequestSubmit
		SET              Status = @Status, RevDate = @RevDate, RevBy = @RevBy, RecDate = @RecDate, RecBy = @RecBy, RecCarrier = @RecCarrier, RecTrackNo = @RecTrackNo, RecWeight = @RecWeight, 
		                      VendorWeight = @VendorWeight, DueDate = @DueDate, EndDate = @EndDate, EndBy = @EndBy, MUser = @ModifiedBy, 
		                      MDate = @ModifiedDate, VendorDate = @VendorDate, VendorName = @VendorName, InternalComment = @InternalComment, NoTolerance = @NoTolerance  
		WHERE     (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (SampleWorkflowID = @SampleWorkflowID) AND (StyleID = @StyleID) AND 
		                      (StyleColorID = @StyleColorID) AND (StyleSet = @StyleSet) AND (SampleRequestTradeID = @SampleRequestTradeID) AND (Submit = @Submit)
	END
	ELSE 
	BEGIN
		UPDATE    dbo.pSampleRequestSubmit
		SET              Status = @Status, RevDate = @RevDate, RevBy = @RevBy, RecDate = @RecDate, RecBy = @RecBy,  RecWeight = @RecWeight, 
		                      DueDate = @DueDate, EndDate = @EndDate, EndBy = @EndBy, MUser = @ModifiedBy, 
		                      MDate = @ModifiedDate,  InternalComment = @InternalComment, NoTolerance = @NoTolerance  
		WHERE     (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (SampleWorkflowID = @SampleWorkflowID) AND (StyleID = @StyleID) AND 
		                      (StyleColorID = @StyleColorID) AND (StyleSet = @StyleSet) AND (SampleRequestTradeID = @SampleRequestTradeID) AND (Submit = @Submit)
	END
	
END                      




IF @Status = 0        -- OPEN 
BEGIN

	if @Submit > 1 
		SET @vcDate = '/2/1900'
	ELSE
		SET @vcDate = '/1/1900'


	UPDATE    dbo.pSampleRequestWorkflow
	SET              Submit = @Submit, Status = @Status, DueDate = @DueDate, EndDate = CONVERT(nvarchar(2),@Submit) +  @vcDate   , MUser = @ModifiedBy, MDate = @ModifiedDate
	WHERE     (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (SampleWorkflowID = @SampleWorkflowID) AND (StyleID = @StyleID) 
	AND  (StyleColorID = @StyleColorID) AND (StyleSet = @StyleSet) AND (SampleRequestTradeID = @SampleRequestTradeID) 
END
ELSE IF @Status = 1       -- RESUMIT
BEGIN
	--PRINT DATEADD(day,7,GETDATE())
	UPDATE    pSampleRequestWorkflow
	SET              Submit = @Submit, Status = 0, DueDate = @DueDate, EndDate = CONVERT(nvarchar(2),(@Submit)) + '/2/1900', MUser = @ModifiedBy, MDate = @ModifiedDate
	WHERE     (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (SampleWorkflowID = @SampleWorkflowID) AND (StyleID = @StyleID) AND 
						  (StyleColorID = @StyleColorID) AND (StyleSet = @StyleSet) AND (SampleRequestTradeID = @SampleRequestTradeID) 
END
ELSE IF @Status = 4       -- DROPPED 
BEGIN
	UPDATE    dbo.pSampleRequestWorkflow
	SET              Submit = @Submit, Status = @Status, DueDate = @DueDate, EndDate = CONVERT(nvarchar(2),@Submit) + '/3/1900', MUser = @ModifiedBy, MDate = @ModifiedDate
	WHERE     (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (SampleWorkflowID = @SampleWorkflowID) AND (StyleID = @StyleID) AND 
		  (StyleColorID = @StyleColorID) AND (StyleSet = @StyleSet) AND (SampleRequestTradeID = @SampleRequestTradeID) 
END
ELSE
BEGIN
	UPDATE dbo.pSampleRequestWorkflow
	SET              Submit = @Submit, Status = @Status, DueDate = @DueDate, EndDate = @EndDate, MUser = @ModifiedBy, MDate = @ModifiedDate
	WHERE     (SampleRequestWorkflowID = @SampleRequestWorkflowID) AND (SampleWorkflowID = @SampleWorkflowID) AND (StyleID = @StyleID) AND 
						  (StyleColorID = @StyleColorID) AND (StyleSet = @StyleSet) AND (SampleRequestTradeID = @SampleRequestTradeID) 
END


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_TradePartner_AgentSearch_SELECT]'
GO
EXEC sp_refreshview N'[dbo].[vwx_TradePartner_AgentSearch_SELECT]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialColor_FromPending_INSERT]'
GO
SET QUOTED_IDENTIFIER OFF
GO


ALTER PROCEDURE  [dbo].[spx_MaterialColor_FromPending_INSERT] (
@ColorPaletteID UNIQUEIDENTIFIER,
@MaterialID UNIQUEIDENTIFIER,
@SeasonYearID UNIQUEIDENTIFIER,
@CUser NVARCHAR(200) ,
@CDate DATETIME
)
AS 

DECLARE @MaterialColorID UNIQUEIDENTIFIER 
DECLARE @ColorCode NVARCHAR(200)
DECLARE @ColorName NVARCHAR(200)

SELECT  @ColorCode = ColorCode, @ColorName = ColorName FROM pColorPalette WHERE ColorPaletteID = @ColorPaletteID 

SELECT TOP 1 @MaterialColorID = MaterialColorID  
FROM pMaterialColor	a 
INNER JOIN pColorPalette b ON a.ColorPaletteID =  b.ColorPaletteID 
WHERE a.MaterialID = @MaterialID
AND b.ColorCode = @ColorCode 


/*
SELECT @MaterialColorID = MaterialColorID  
FROM pMaterialColor 
WHERE ColorPaletteID = @ColorPaletteID AND MaterialID = @MaterialID  
*/

IF @MaterialColorID IS NULL 
BEGIN 
	SET @MaterialColorID =  NEWID() 

	INSERT INTO pMaterialColor ( MaterialColorID , MaterialID,  ColorFolderID , ColorPaletteID ,ColorCode, ColorName, ColorSource, Hex, R, G, B, C, M,Y,K, H, S, L ,LAB_L, LAB_A, LAB_B, CDate , CUser, MDate, MUser, MaterialColorVersion, ColorVersion )  
	SELECT  @MaterialColorID , @MaterialID , ColorFolderID , ColorPaletteID, ColorCode, ColorName, ColorSource, Hex, R, G, B, C, M, Y, K, H, S, L ,LAB_L, LAB_A, LAB_B, @CDate, @CUser, @CDate, @CUser, 1,  0 
	FROM pColorPalette
	WHERE ColorPaletteID = @ColorPaletteID
END 

-- Materialcolor / SeasonYear
IF @SeasonYearID IS NOT NULL 
BEGIN
	IF ( SELECT COUNT (*)  FROM pMaterialColorSeasonYear WHERE MaterialColorID = @MaterialColorID AND SeasonYearID  = @SeasonYearID ) = 0
	BEGIN
		INSERT INTO pMaterialColorSeasonYear (MaterialColorSeasonYearID , MaterialColorID , MaterialID , SeasonYearID , MaterialSeason, MaterialYear, CUser, CDate, MUser, MDate ) 
		SELECT NEWID() , @MaterialColorID,  @MaterialID, @SeasonYearID , Season, Year, @CUser, @CDate, @CUser, @CDate
		FROM pSeasonYear WHERE SeasonYearID = @SeasonYearID
	END 
END 

DELETE FROM pMaterialColorPending  WHERE ColorPaletteID = @ColorPaletteID AND MaterialID = @MaterialID AND CUser = @CUser 


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rpx_ReportMaterialRequestSubmitItem_INSERT]'
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[rpx_ReportMaterialRequestSubmitItem_INSERT]
(
	@DataXmlID varchar(40),
	@MaterialRequestWorkflowID varchar(5),
	@MaterialRequestSubmitID varchar(40)
)
AS 

--DECLARE @MaterialRequestWorkflowID varchar(5)
--DECLARE @MaterialRequestSubmitID uniqueidentifier
--DECLARE @DataXmlID varchar(36)

DECLARE @XmlPath varchar(400)
DECLARE @XmlFileName VARCHAR(200)
DECLARE @XmlFolderName varchar(200)

--SET @MaterialRequestSubmitID = '97dc2fc9-74a7-4530-b4fd-edceab1114e5' 
--SET @MaterialRequestWorkflowID = 'A90'
--SET @DataXmlID = newId()


BEGIN
	-- Select Schema File
--kj	SELECT @XmlFolderName = XmlSchemaPath FROM sSystemServerStorageSetting WHERE CurrentServerStorage = 1
	SELECT @XmlFileName = MaterialRequestWorkflowSchema FROM dbo.pMaterialRequestWorkflow WHERE MaterialRequestWorkflowID = @MaterialRequestWorkflowID
	SELECT @XmlPath = @XmlFolderName + '\' + @XmlFileName
END

BEGIN
	-- Import Schema File to #tmpXmlImportFile
	CREATE TABLE #tmpXmlImportFile(
		[xmlFileName] VARCHAR(300) NOT NULL,
		[xmlData] XML NOT NULL
	)

	EXEC('INSERT INTO #tmpXmlImportFile(xmlFileName, xmlData)
		SELECT ''' + @XmlPath + ''', xmlData
		FROM(
		SELECT *
		FROM OPENROWSET (BULK ''' + @XmlPath + ''' , SINGLE_BLOB) AS XMLDATA
		) AS FileImport (XMLDATA)
		')
END

BEGIN
	-- Import table schema values to #tmpXmlDocTable
	CREATE TABLE #tmpXmlDocTable(
					[XmlDocId] [int] IDENTITY(1,1) NOT NULL,
					[Name] [nvarchar](200) NULL,
					[Alias] [nvarchar](200) NULL,	
					[Type] varchar(200),
					[datatype] varchar(200),
					[lookupquery] varchar(800),
					[ValueField] varchar(200),
					[Visible] [varchar](5) NULL,
					[CDate] [datetime])


	DECLARE @idoc int
	DECLARE @doc XML
	SELECT @doc = xmlData FROM #tmpXmlImportFile

	EXEC sp_xml_preparedocument @idoc OUTPUT, @doc
	INSERT INTO #tmpXmlDocTable([Name], alias, Visible, CDate, [Type], datatype, lookupquery, ValueField)
	SELECT [Name], alias, Visible, getdate(), [Type], datatype, lookupquery, ValueField
	FROM       OPENXML (@idoc, '/Table/column',1)
				WITH (	[Name]  varchar(200),
						alias varchar(200),
						[Type] varchar(200),
						datatype varchar(200),
						lookupquery varchar(800),
						ValueField varchar(200),
						Visible varchar(200)				
				)
	WHERE Visible='true'
	EXEC sp_xml_removedocument @idoc --Clean Cache
	--SELECT * FROM #tmpXmlDocTable

END

BEGIN
	--Import pMaterialRequestSubmitItem values to temp table
	SELECT * INTO #tmpMaterialRequest
	FROM pMaterialRequestSubmitItem WHERE MaterialRequestSubmitID = @MaterialRequestSubmitID
	ORDER BY MaterialRequestSubmitItemSort ASC

	ALTER TABLE #tmpMaterialRequest ADD
	RecID int NOT NULL IDENTITY (1, 1)
	--SELECT * FROM #tmpMaterialRequest
END

BEGIN
		
	DECLARE @TotalCountM int
	DECLARE @RowCounterM int

	SELECT @TotalCountM = COUNT(*) FROM #tmpMaterialRequest
	SET @RowCounterM = 1

	DECLARE @tmpMaterialRequestSubmitItemID varchar(40)

	WHILE(@RowCounterM <= @TotalCountM)
		BEGIN

			SELECT @tmpMaterialRequestSubmitItemID = MaterialRequestSubmitItemID
						FROM #tmpMaterialRequest WHERE RecID = @RowCounterM

			DECLARE @TotalCount int
			DECLARE @RowCounter int

			SELECT @TotalCount = COUNT(*) FROM #tmpXmlDocTable
			SET @RowCounter = 1

			DECLARE @tmpName varchar(200)
			DECLARE @tmpAlias varchar(200)	
			DECLARE @tmpType varchar(200)
			DECLARE @tmpDataType varchar(200)
			DECLARE @tmpLookup varchar(800)
			DECLARE @tmpValueField varchar(200)

			WHILE(@RowCounter <= @TotalCount)
				BEGIN

					SELECT @tmpAlias = Alias, @tmpName = [Name], @tmpType = [Type], @tmpDataType = datatype, @tmpLookup = lookupquery, @tmpValueField = ValueField
						FROM #tmpXmlDocTable WHERE XmlDocId = @RowCounter
					
					IF @tmpDataType = 'query'
						BEGIN

							CREATE TABLE #tmpTable (FieldID varchar(200), FieldValue varchar(200))
							CREATE TABLE #tmpVar (FieldValue varchar(200))

							DECLARE @tmpReturnValue varchar(100)

							EXEC ('INSERT INTO #tmpTable (FieldID, FieldValue) ' + @tmpLookup) 
							EXEC ('INSERT INTO #tmpVar(FieldValue) SELECT ' + @tmpName + ' FROM pMaterialRequestSubmitItem WHERE MaterialRequestSubmitItemID = ''' + @tmpMaterialRequestSubmitItemID + '''')

							SET @tmpReturnValue = (SELECT FieldValue FROM #tmpTable WHERE FieldID = (SELECT FieldValue FROM #tmpVar))

							DROP TABLE #tmpTable
							DROP TABLE #tmpVar

							EXEC('
								INSERT INTO rReportMaterialRequestItemTemp(DataXmlId, MaterialRequestSubmitItemID, MaterialRequestSubmitID, DataColumnNumber, DataColumnName, DataColumnValue, DataSort)
								SELECT ''' + @DataXmlId + ''', MaterialRequestSubmitItemID, MaterialRequestSubmitID, ' + @RowCounter + ',''' + @tmpAlias + ''', ''' + @tmpReturnValue + ''', MaterialRequestSubmitItemSort FROM pMaterialRequestSubmitItem WHERE MaterialRequestSubmitItemID = ''' + @tmpMaterialRequestSubmitItemID + ''' 
								')

						END
					ELSE
						BEGIN
							EXEC('
								INSERT INTO rReportMaterialRequestItemTemp(DataXmlId, MaterialRequestSubmitItemID, MaterialRequestSubmitID, DataColumnNumber, DataColumnName, DataColumnValue, DataSort)
								SELECT ''' + @DataXmlId + ''', MaterialRequestSubmitItemID, MaterialRequestSubmitID, ' + @RowCounter + ',''' + @tmpAlias + ''', ' + @tmpName + ', MaterialRequestSubmitItemSort FROM pMaterialRequestSubmitItem WHERE MaterialRequestSubmitItemID = ''' + @tmpMaterialRequestSubmitItemID + ''' 
								')
						END
					

					SET @RowCounter = @RowCounter + 1
				END
		SET @RowCounterM = @RowCounterM + 1

	END
END

--BEGIN
--	SELECT * FROM rReportMaterialRequestItemTemp WHERE DataColumnName <> 'Sort'
--END

BEGIN
	--Clean up
	--DELETE FROM rReportMaterialRequestItemTemp WHERE DataXmlID = @DataXmlID
	DROP TABLE #tmpMaterialRequest
	DROP TABLE #tmpXmlDocTable
	DROP TABLE #tmpXmlImportFile
END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleSpecSizeRange_Linked_UPDATE]'
GO
CREATE PROCEDURE [dbo].[spx_StyleSpecSizeRange_Linked_UPDATE]
(
	@POMTempID uniqueidentifier, 
	@StyleID uniqueidentifier,
	@StyleSet NVARCHAR(5),
	@ModifiedBy NVARCHAR(200),
	@ModifiedDate datetime
)

AS 


/************************/
/*Declare variables.	*/
/************************/
DECLARE @POMTempID_Param UNIQUEIDENTIFIER		--Keep a copy of the original parameter value.
DECLARE @StyleID_Param UNIQUEIDENTIFIER			--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT						--Keep a copy of the original parameter value.


DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet
SET @POMTempID_Param = @POMTempID


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	,POMTempID UNIQUEIDENTIFIER
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleSpecSizeRange_UPDATE
			@POMTempID_Param
			,@StyleID_Param
			,@StyleSet_Param
			,@ModifiedBy
			,@ModifiedDate
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet
			,POMTempID)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet_Param AS StyleSet
			,@POMTempID_Param AS POMTempID
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID
	END

/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @POMTempID = NULL
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Get the 'StyleID' for the insert.*/
		SELECT @POMTempID = POMTempID
			,@StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleSpecSizeRange_UPDATE
			@POMTempID
			,@StyleID
			,@StyleSet
			,@ModifiedBy
			,@ModifiedDate


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_ImageCatalog_Single_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.
*/



ALTER PROCEDURE [dbo].[rpx_ImageCatalog_Single_SELECT] 
	@ImageCatalogID varchar(255)
AS


SELECT pi.ImageKeywords, 
	(dbo.fnx_GetStreamingImagePath(hi.ImageID, hi.[Version])) AS FilePath	--Comment #01
FROM	pImageCatalog ic INNER JOIN pImageCatalogItem ci ON
	ic.ImageCatalogID = ci.ImageCatalogID INNER JOIN pImage pi ON
	ci.ImageID = pi.ImageID INNER JOIN hImage hi ON
	ci.ImageID = hi.ImageID AND ci.ImageVersion = hi.Version
WHERE (ic.ImageCatalogID = @ImageCatalogID)

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_QuoteFolderItem_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_QuoteFolderItem_INSERT]
(@QuoteFolderID uniqueidentifier,
@StyleID uniqueidentifier,
@CreatedBy nvarchar(100),
@CreatedDate nvarchar(100),
@QuoteFolderItemID uniqueidentifier)

AS


IF (SELECT COUNT(*)  FROM pQuoteFolderItem WITH (NOLOCK) WHERE StyleID = @StyleID AND QuoteFolderID = @QuoteFolderID)  = 0

	BEGIN
		 INSERT INTO dbo.pQuoteFolderItem
                    	  (QuoteFolderItemID, QuoteFolderID, StyleID, CUser, CDate, MUser, MDate)
		VALUES     (@QuoteFolderItemID, @QuoteFolderID, @StyleID, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate)
	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rReportMaterialRequestItemTemp]'
GO
CREATE TABLE [dbo].[rReportMaterialRequestItemTemp]
(
[ReportTempId] [int] NOT NULL IDENTITY(1, 1),
[DataXmlId] [uniqueidentifier] NULL,
[MaterialRequestSubmitItemID] [uniqueidentifier] NOT NULL,
[MaterialRequestSubmitID] [uniqueidentifier] NOT NULL,
[DataColumnNumber] [int] NULL,
[DataColumnName] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[DataColumnValue] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[DataSort] [varchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL CONSTRAINT [DF_rReportMaterialRequestItemTemp_CDate] DEFAULT (getdate())
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_rReportMaterialRequestItemTemp] on [dbo].[rReportMaterialRequestItemTemp]'
GO
ALTER TABLE [dbo].[rReportMaterialRequestItemTemp] ADD CONSTRAINT [PK_rReportMaterialRequestItemTemp] PRIMARY KEY CLUSTERED  ([ReportTempId])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rpx_MaterialRequestSubmitItem_SELECT]'
GO


CREATE PROCEDURE [dbo].[rpx_MaterialRequestSubmitItem_SELECT]
(
	@DataXmlID varchar(40),
	@MaterialRequestWorkflowID varchar(5),
	@MaterialRequestSubmitID varchar(40)
)
AS 

BEGIN
	SELECT * FROM rReportMaterialRequestItemTemp WHERE DataColumnName <> 'Sort' AND DataXmlId = @DataXmlId
END

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcingQuote_CHECK_INSERT]'
GO
/*
'***********************************************************************
' Object name	   : spx_StyleSourcingQuote_CHECK_INSERT
' Author           : 
' Created          : 
'
' Last Modified By : Artemio Gomez
' Last Modified On : 12-11-2009
' Description      : Insert the StyleSourcing quote variation,
' Comments		   :
		#01  -	Artemio Gomez - December 11, 2009
				Add Parameter @OUTPUT INT with default = 1
				Add Parameter @@StyleQuoteID UNIQUEIDENTIFIER as an Output parameter
' Copyright        : (c) Yunique Solutions, Inc. All rights reserved.
'***********************************************************************
*/
ALTER PROCEDURE [dbo].[spx_StyleSourcingQuote_CHECK_INSERT] (
@TradePartnerID UNIQUEIDENTIFIER,
@StyleDevelopmentID UNIQUEIDENTIFIER,
@CreatedDate DATETIME, 
@CreatedBy NVARCHAR (200),
@OUTPUT INT = 1,
@StyleQuoteID UNIQUEIDENTIFIER = NULL OUTPUT
)
AS

--DECLARE @StyleQuoteID UNIQUEIDENTIFIER

SELECT @StyleQuoteID = StyleQuoteID FROM pStyleQuote 
WHERE TradePartnerId= @TradePartnerId 
AND StyleDevelopmentID= @StyleDevelopmentID 

IF @StyleQuoteID IS NULL 
BEGIN
	SET @StyleQuoteID  = NEWID()
	INSERT INTO pStyleQuote (TradePartnerId, StyleQuoteID, StyleDevelopmentID, CUser, CDate, MUser, MDate) 
	VALUES (@TradePartnerId, @StyleQuoteID, @StyleDevelopmentID, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate)

END 

IF @OUTPUT = 1
	SELECT StyleQuoteID  = @StyleQuoteID








GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSpecSizeRangeLogic_UPDATE]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 9, 2009
	For some reason, when updating the Size Range at the Style Development Spec page, if there are
Sourcing Quotes existing, when you change the Size Range, three custom fields in 'pStyleQuoteItem'
get overwritten, but there fields are being used in Quote equations.  Going to comment out this
update here and hope that it doesn't break anything related to the Size Range.
*/


ALTER  PROCEDURE [dbo].[spx_StyleSpecSizeRangeLogic_UPDATE]
(
@POMTempID uniqueidentifier, 
@StyleID uniqueidentifier,
@StyleSet NVARCHAR(5),
@ModifiedBy NVARCHAR(200),
@ModifiedDate datetime
)
AS 

DECLARE @tmpSizeRange	varchar(50)
DECLARE @POMTempVersion varchar(5)

BEGIN

	SELECT @POMTempID = POMTempID, @POMTempVersion = POMTempVersion, @tmpSizeRange = SizeRange FROM pPOMTemplate WITH (NOLOCK) WHERE POMTempID = @POMTempID 

	IF @StyleSet = 1 UPDATE pStyleHeader SET POMTempID1 = @POMTempID, POMTempVersion1 = @POMTempVersion, SizeRange = @tmpSizeRange  WHERE (StyleID = @StyleID)  
	IF @StyleSet = 2 UPDATE pStyleHeader SET POMTempID2 = @POMTempID, POMTempVersion2 = @POMTempVersion, SizeRange = @tmpSizeRange  WHERE (StyleID = @StyleID)  
	IF @StyleSet = 3 UPDATE pStyleHeader SET POMTempID3 = @POMTempID, POMTempVersion3 = @POMTempVersion, SizeRange = @tmpSizeRange  WHERE (StyleID = @StyleID)  
	IF @StyleSet = 4 UPDATE pStyleHeader SET POMTempID4 = @POMTempID, POMTempVersion4 = @POMTempVersion, SizeRange = @tmpSizeRange  WHERE (StyleID = @StyleID)  

END

BEGIN

	DECLARE @Size0  NVARCHAR(5)
	DECLARE @Size1  NVARCHAR(5)
	DECLARE @Size2  NVARCHAR(5)
	DECLARE @Size3  NVARCHAR(5)
	DECLARE @Size4  NVARCHAR(5)
	DECLARE @Size5  NVARCHAR(5)
	DECLARE @Size6  NVARCHAR(5)
	DECLARE @Size7  NVARCHAR(5)
	DECLARE @Size8  NVARCHAR(5)
	DECLARE @Size9  NVARCHAR(5)
	DECLARE @Size10  NVARCHAR(5)
	DECLARE @Size11  NVARCHAR(5)
	DECLARE @Size12  NVARCHAR(5)
	DECLARE @Size13  NVARCHAR(5)
	DECLARE @Size14  NVARCHAR(5)
	DECLARE @Size15  NVARCHAR(5)
	DECLARE @Size16  NVARCHAR(5)
	DECLARE @Size17  NVARCHAR(5)
	DECLARE @Size18  NVARCHAR(5)
	DECLARE @Size19  NVARCHAR(5)

	DECLARE @Sel0 BIT
	DECLARE @Sel1 BIT
	DECLARE @Sel2 BIT
	DECLARE @Sel3 BIT
	DECLARE @Sel4 BIT
	DECLARE @Sel5 BIT
	DECLARE @Sel6 BIT
	DECLARE @Sel7 BIT
	DECLARE @Sel8 BIT
	DECLARE @Sel9 BIT
	DECLARE @Sel10 BIT
	DECLARE @Sel11 BIT
	DECLARE @Sel12 BIT
	DECLARE @Sel13 BIT
	DECLARE @Sel14 BIT
	DECLARE @Sel15 BIT
	DECLARE @Sel16 BIT
	DECLARE @Sel17 BIT
	DECLARE @Sel18 BIT
	DECLARE @Sel19 BIT

	DECLARE @Col0 BIT 
	DECLARE @Col1 BIT
	DECLARE @Col2 BIT
	DECLARE @Col3 BIT
	DECLARE @Col4 BIT
	DECLARE @Col5 BIT
	DECLARE @Col6 BIT
	DECLARE @Col7 BIT
	DECLARE @Col8 BIT
	DECLARE @Col9 BIT
	DECLARE @Col10 BIT
	DECLARE @Col11 BIT
	DECLARE @Col12 BIT
	DECLARE @Col13 BIT
	DECLARE @Col14 BIT
	DECLARE @Col15 BIT
	DECLARE @Col16 BIT
	DECLARE @Col17 BIT
	DECLARE @Col18 BIT
	DECLARE @Col19 BIT

	SELECT 
		@Size0 = Size0, @Size1 = Size1, @Size2 = Size2, @Size3 = Size3, @Size4 = Size4, @Size5 = Size5, @Size6 = Size6, @Size7 = Size7, @Size8 = Size8, @Size9 = Size9, 
		@Size10 = Size10, @Size11 = Size11, @Size12 = Size12, @Size13 = Size13, @Size14 = Size14, @Size15 = Size15, @Size16 = Size16, @Size17 = Size17, @Size18 = Size18, @Size19 = Size19, 
		@Sel0 = Sel0, @Sel1 = Sel1, @Sel2 = Sel2, @Sel3 = Sel3, @Sel4 = Sel4, @Sel5 = Sel5, @Sel6 = Sel6, @Sel7 = Sel7, @Sel8 = Sel8, @Sel9 = Sel9, 
		@Sel10 = Sel10, @Sel11 = Sel11, @Sel12 = Sel12, @Sel13 = Sel13, @Sel14 = Sel14, @Sel15 = Sel15, @Sel16 = Sel16, @Sel17 = Sel17, @Sel18 = Sel18, @Sel19 = Sel19
	FROM pSizeRange WITH (NOLOCK)
	WHERE SizeRangeCode = @tmpSizeRange


	IF  (SELECT @Size0) IS NULL  
		SELECT @Col0 = 0
	ELSE
		SELECT @Col0 = 1

	IF  (SELECT @Size1) IS NULL  
		SELECT @Col1 = 0
	ELSE
		SELECT @Col1 = 1

	IF  (SELECT @Size2) IS NULL   
		SELECT @Col2 = 0
	ELSE
		SELECT @Col2 = 1

	IF  (SELECT @Size3) IS NULL   
		SELECT @Col3 = 0
	ELSE
		SELECT @Col3 = 1

	IF  (SELECT @Size4) IS NULL   
		SELECT @Col4 = 0
	ELSE
		SELECT @Col4 = 1

	IF  (SELECT @Size5) IS NULL   
		SELECT @Col5 = 0
	ELSE
		SELECT @Col5 = 1

	IF  (SELECT @Size6) IS NULL   
		SELECT @Col6 = 0
	ELSE
		SELECT @Col6 = 1

	IF  (SELECT @Size7) IS NULL  
		SELECT @Col7 = 0
	ELSE
		SELECT @Col7 = 1

	IF  (SELECT @Size8) IS NULL   
		SELECT @Col8 = 0
	ELSE
		SELECT @Col8 = 1

	IF  (SELECT @Size9) IS NULL   
		SELECT @Col9 = 0
	ELSE
		SELECT @Col9 = 1

	IF  (SELECT @Size10) IS NULL   
		SELECT @Col10 = 0
	ELSE
		SELECT @Col10 = 1

	IF  (SELECT @Size11) IS NULL   
		SELECT @Col11 = 0
	ELSE
		SELECT @Col11 = 1

	IF  (SELECT @Size12) IS NULL   
		SELECT @Col12 = 0
	ELSE
		SELECT @Col12 = 1

	IF  (SELECT @Size13) IS NULL   
		SELECT @Col13 = 0
	ELSE
		SELECT @Col13 = 1

	IF  (SELECT @Size14) IS NULL  
		SELECT @Col14 = 0
	ELSE
		SELECT @Col14 = 1

	IF  (SELECT @Size15) IS NULL   
		SELECT @Col15 = 0
	ELSE
		SELECT @Col15 = 1

	IF  (SELECT @Size16) IS NULL   
		SELECT @Col16 = 0
	ELSE
		SELECT @Col16 = 1

	IF  (SELECT @Size17) IS NULL   
		SELECT @Col17 = 0
	ELSE
		SELECT @Col17 = 1

	IF  (SELECT @Size18) IS NULL   
		SELECT @Col18 = 0
	ELSE
		SELECT @Col18 = 1

	IF  (SELECT @Size19) IS NULL   
		SELECT @Col19 = 0
	ELSE
		SELECT @Col19 = 1

END

BEGIN
	UPDATE pStyleSpecSize
	SET  SizeRange = @tmpSizeRange, Size0 = @Size0, Size1 = @Size1, Size2 = @Size2, Size3 = @Size3, Size4 = @Size4, Size5 = @Size5, Size6 = @Size6, Size7 = @Size7, Size8 = @Size8, Size9 = @Size9, Size10 = @Size10, Size11 = @Size11, Size12 = @Size12, Size13 = @Size13, Size14 = @Size14, Size15 = @Size15, Size16 = @Size16, Size17 = @Size17, Size18 = @Size18, Size19 = @Size19,
		 Sel0 = @Sel0, Sel1 = @Sel1, Sel2 = @Sel2, Sel3 = @Sel3, Sel4 = @Sel4, Sel5 = @Sel5, Sel6 = @Sel6, Sel7 = @Sel7, Sel8 = @Sel8, Sel9 = @Sel9, Sel10 = @Sel10, Sel11 = @Sel11, Sel12 = @Sel12, Sel13 = @Sel13, Sel14 = @Sel14, Sel15 = @Sel15, Sel16 = @Sel16, Sel17 = @Sel17, Sel18 = @Sel18, Sel19 = @Sel19
	WHERE (StyleID = @StyleID)
END


BEGIN
	UPDATE pStyleSpec SET   
		pStyleSpec.POMTempID = @POMTempID,	
		pStyleSpec.POMTempItemID = pPOMTemplateItem.POMTempItemID,	
		pStyleSpec.TOL = pPOMTemplateItem.TOL, 
		pStyleSpec.TOLN = pPOMTemplateItem.TOLN, 
		pStyleSpec.Grade0 = pPOMTemplateItem.Grade0, 
		pStyleSpec.Grade1 = pPOMTemplateItem.Grade1, 
		pStyleSpec.Grade2 = pPOMTemplateItem.Grade2, 
		pStyleSpec.Grade3 = pPOMTemplateItem.Grade3, 
		pStyleSpec.Grade4 = pPOMTemplateItem.Grade4, 
		pStyleSpec.Grade5 = pPOMTemplateItem.Grade5, 
		pStyleSpec.Grade6 = pPOMTemplateItem.Grade6, 
		pStyleSpec.Grade7 = pPOMTemplateItem.Grade7, 
		pStyleSpec.Grade8 = pPOMTemplateItem.Grade8, 
		pStyleSpec.Grade9 = pPOMTemplateItem.Grade9, 
		pStyleSpec.Grade10 = pPOMTemplateItem.Grade10, 
		pStyleSpec.Grade11 = pPOMTemplateItem.Grade11, 
		pStyleSpec.Grade12 = pPOMTemplateItem.Grade12, 
		pStyleSpec.Grade13 = pPOMTemplateItem.Grade13, 
		pStyleSpec.Grade14 = pPOMTemplateItem.Grade14, 
		pStyleSpec.Grade15 = pPOMTemplateItem.Grade15, 
		pStyleSpec.Grade16 = pPOMTemplateItem.Grade16, 
		pStyleSpec.Grade17 = pPOMTemplateItem.Grade17, 
		pStyleSpec.Grade18 = pPOMTemplateItem.Grade18, 
		pStyleSpec.Grade19 = pPOMTemplateItem.Grade19, 
		pStyleSpec.Sort = pPOMTemplateItem.Sort
	FROM pPOMTemplateItem INNER JOIN
		pStyleSpec ON pPOMTemplateItem.POM = pStyleSpec.POM 
	WHERE 
		(pStyleSpec.StyleID = @StyleID) AND 
		(pStyleSpec.StyleSet = @StyleSet) AND
		(pPOMTemplateItem.POMTempID = @POMTempID)
END


--Comment #01
--BEGIN
--
--	UPDATE pStyleQuoteItem SET
--		StyleQuoteItemCustomField28 = @tmpSizeRange,
--		StyleQuoteItemCustomField29 = @ModifiedBy,
--		StyleQuoteItemCustomField30 = @ModifiedDate 
--	WHERE StyleId = @StyleId
--
--END

BEGIN

	UPDATE pSampleRequestSpecSize SET pSampleRequestSpecSize.SizeRange = pStyleSpecSize.SizeRange, pSampleRequestSpecSize.Size0 = pStyleSpecSize.Size0, 
	      pSampleRequestSpecSize.Size1 = pStyleSpecSize.Size1, pSampleRequestSpecSize.Size2 = pStyleSpecSize.Size2, 
	      pSampleRequestSpecSize.Size3 = pStyleSpecSize.Size3, pSampleRequestSpecSize.Size4 = pStyleSpecSize.Size4, 
	      pSampleRequestSpecSize.Size5 = pStyleSpecSize.Size5, pSampleRequestSpecSize.Size6 = pStyleSpecSize.Size6, 
	      pSampleRequestSpecSize.Size7 = pStyleSpecSize.Size7, pSampleRequestSpecSize.Size8 = pStyleSpecSize.Size8, 
	      pSampleRequestSpecSize.Size9 = pStyleSpecSize.Size9, pSampleRequestSpecSize.Size10 = pStyleSpecSize.Size10, 
	      pSampleRequestSpecSize.Size11 = pStyleSpecSize.Size11, pSampleRequestSpecSize.Size12 = pStyleSpecSize.Size12, 
	      pSampleRequestSpecSize.Size13 = pStyleSpecSize.Size13, pSampleRequestSpecSize.Size14 = pStyleSpecSize.Size14, 
	      pSampleRequestSpecSize.Size15 = pStyleSpecSize.Size15, pSampleRequestSpecSize.Size16 = pStyleSpecSize.Size16, 
	      pSampleRequestSpecSize.Size17 = pStyleSpecSize.Size17, pSampleRequestSpecSize.Size18 = pStyleSpecSize.Size18, 
	      pSampleRequestSpecSize.Size19 = pStyleSpecSize.Size19, pSampleRequestSpecSize.Sel0 = pStyleSpecSize.Sel0, 
	      pSampleRequestSpecSize.Sel1 = pStyleSpecSize.Sel1, pSampleRequestSpecSize.Sel2 = pStyleSpecSize.Sel2, 
	      pSampleRequestSpecSize.Sel3 = pStyleSpecSize.Sel3, pSampleRequestSpecSize.Sel4 = pStyleSpecSize.Sel4, 
	      pSampleRequestSpecSize.Sel5 = pStyleSpecSize.Sel5, pSampleRequestSpecSize.Sel6 = pStyleSpecSize.Sel6, 
	      pSampleRequestSpecSize.Sel7 = pStyleSpecSize.Sel7, pSampleRequestSpecSize.Sel8 = pStyleSpecSize.Sel8, 
	      pSampleRequestSpecSize.Sel9 = pStyleSpecSize.Sel9, pSampleRequestSpecSize.Sel10 = pStyleSpecSize.Sel10, 
	      pSampleRequestSpecSize.Sel11 = pStyleSpecSize.Sel11, pSampleRequestSpecSize.Sel12 = pStyleSpecSize.Sel12, 
	      pSampleRequestSpecSize.Sel13 = pStyleSpecSize.Sel13, pSampleRequestSpecSize.Sel14 = pStyleSpecSize.Sel14, 
	      pSampleRequestSpecSize.Sel15 = pStyleSpecSize.Sel15, pSampleRequestSpecSize.Sel16 = pStyleSpecSize.Sel16, 
	      pSampleRequestSpecSize.Sel17 = pStyleSpecSize.Sel17, pSampleRequestSpecSize.Sel18 = pStyleSpecSize.Sel18, 
	      pSampleRequestSpecSize.Sel19 = pStyleSpecSize.Sel19, pSampleRequestSpecSize.Col0 = pStyleSpecSize.Col0, 
	      pSampleRequestSpecSize.Col1 = pStyleSpecSize.Col1, pSampleRequestSpecSize.Col2 = pStyleSpecSize.Col2, 
	      pSampleRequestSpecSize.Col3 = pStyleSpecSize.Col3, pSampleRequestSpecSize.Col4 = pStyleSpecSize.Col4, 
	      pSampleRequestSpecSize.Col5 = pStyleSpecSize.Col5, pSampleRequestSpecSize.Col6 = pStyleSpecSize.Col6, 
	      pSampleRequestSpecSize.Col7 = pStyleSpecSize.Col7, pSampleRequestSpecSize.Col8 = pStyleSpecSize.Col8, 
	      pSampleRequestSpecSize.Col9 = pStyleSpecSize.Col9, pSampleRequestSpecSize.Col10 = pStyleSpecSize.Col10, 
	      pSampleRequestSpecSize.Col11 = pStyleSpecSize.Col11, pSampleRequestSpecSize.Col12 = pStyleSpecSize.Col12, 
	      pSampleRequestSpecSize.Col13 = pStyleSpecSize.Col13, pSampleRequestSpecSize.Col14 = pStyleSpecSize.Col14, 
	      pSampleRequestSpecSize.Col15 = pStyleSpecSize.Col15, pSampleRequestSpecSize.Col16 = pStyleSpecSize.Col16, 
	      pSampleRequestSpecSize.Col17 = pStyleSpecSize.Col17, pSampleRequestSpecSize.Col18 = pStyleSpecSize.Col18, 
	      pSampleRequestSpecSize.Col19 = pStyleSpecSize.Col19
	FROM         pSampleRequestSpecSize INNER JOIN
	      pStyleSpecSize ON pSampleRequestSpecSize.StyleID = pStyleSpecSize.StyleID


END


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleSpecSizeRangeLogic_Linked_UPDATE]'
GO
CREATE  PROCEDURE [dbo].[spx_StyleSpecSizeRangeLogic_Linked_UPDATE]
(
	@POMTempID uniqueidentifier, 
	@StyleID uniqueidentifier,
	@StyleSet NVARCHAR(5),
	@ModifiedBy NVARCHAR(200),
	@ModifiedDate datetime
)

AS 


/************************/
/*Declare variables.	*/
/************************/
DECLARE @POMTempID_Param UNIQUEIDENTIFIER		--Keep a copy of the original parameter value.
DECLARE @StyleID_Param UNIQUEIDENTIFIER			--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT						--Keep a copy of the original parameter value.


DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet
SET @POMTempID_Param = @POMTempID


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	,POMTempID UNIQUEIDENTIFIER
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleSpecSizeRangeLogic_UPDATE
			@POMTempID_Param
			,@StyleID_Param
			,@StyleSet_Param
			,@ModifiedBy
			,@ModifiedDate
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet
			,POMTempID)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet_Param AS StyleSet
			,@POMTempID_Param AS POMTempID
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID
	END

/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @POMTempID = NULL
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Get the 'StyleID' for the insert.*/
		SELECT @POMTempID = POMTempID
			,@StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleSpecSizeRangeLogic_UPDATE
			@POMTempID
			,@StyleID
			,@StyleSet
			,@ModifiedBy
			,@ModifiedDate


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Style_MaterialArtwork_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.
*/


ALTER  PROCEDURE [dbo].[rpx_Style_MaterialArtwork_SELECT] 
	@StyleID AS varchar(255), 
	@StyleSet As int
AS


SELECT ('(' + sm.MaterialNo + ') ' + sm.MaterialName) AS MaterialDescription, 
	(dbo.fnx_GetStreamingImagePath(hi.ImageID, hi.[Version])) AS FilePath	--Comment #01
FROM	pStyleMaterials sm, hImage hi 
WHERE ((sm.MaterialImageID = hi.ImageID) 
	AND (sm.MaterialImageVersion = hi.Version) 
	AND (sm.StyleSet =  @StyleSet) 
	AND (sm.StyleID = @StyleID))
	AND (sm.Artwork = 1)
ORDER BY sm.MainMaterial DESC, sm.MaterialType, sm.MaterialSort, sm.MaterialNo


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_QuoteFolderItem_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_QuoteFolderItem_SELECT](@QuoteFolderItemID uniqueidentifier)
AS SELECT     QuoteFolderItemID, QuoteFolderID, StyleID, CustomField1, CustomField2, CustomField3, CustomField4, CustomField5, CustomField6, CustomField7, 
                      CustomField8, CustomField9, CustomField10, CustomField11, CustomField12, CustomField13, CustomField14, CustomField15, QuoteComments, 
                      PDFFile, PDFDate, PDFUser, CUser, CDate, MUser, MDate, QuoteFolderSort
FROM         dbo.pQuoteFolderItem WITH (NOLOCK)
WHERE     (QuoteFolderItemID = @QuoteFolderItemID)
ORDER BY QuoteFolderSort



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[View_2]'
GO
EXEC sp_refreshview N'[dbo].[View_2]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleSpecTemplate_Linked_INSERT]'
GO
CREATE  PROCEDURE [dbo].[spx_StyleSpecTemplate_Linked_INSERT]
(
	@POMTempID nvarchar(50),
	@StyleID nvarchar(50),
	@StyleSet nvarchar(50),
	@ModifiedDate datetime,
	@ModifiedBy nvarchar(50)
)

AS 


/************************/
/*Declare variables.	*/
/************************/
DECLARE @POMTempID_Param UNIQUEIDENTIFIER		--Keep a copy of the original parameter value.
DECLARE @StyleID_Param UNIQUEIDENTIFIER			--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT						--Keep a copy of the original parameter value.


DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet
SET @POMTempID_Param = @POMTempID


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	,POMTempID UNIQUEIDENTIFIER
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleSpecTemplate_INSERT
			@POMTempID_Param
			,@StyleID_Param
			,@StyleSet_Param
			,@ModifiedDate
			,@ModifiedBy
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet
			,POMTempID)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet_Param AS StyleSet
			,@POMTempID_Param AS POMTempID
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID
	END

/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @POMTempID = NULL
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Get the 'StyleID' for the insert.*/
		SELECT @POMTempID = POMTempID
			,@StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleSpecTemplate_INSERT
			@POMTempID
			,@StyleID
			,@StyleSet
			,@ModifiedDate
			,@ModifiedBy


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_ColorType_SELECT]'
GO




ALTER PROCEDURE  [dbo].[spx_ColorType_SELECT]
(
@TeamID UNIQUEIDENTIFIER 
)
AS
 
BEGIN
	SELECT * FROM pColorType
	WHERE ColorTypeID IN (
		SELECT ColorTypeID FROM sAccessColorFolder WHERE AccessRoleId <> 0 AND (TeamId = @TeamID)
	) 
	AND CorpColor  = 0
	ORDER BY Sort
END







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSpecSizeIndex_SELECT]'
GO
SET QUOTED_IDENTIFIER OFF
GO


ALTER PROCEDURE [dbo].[spx_StyleSpecSizeIndex_SELECT]
(
@StyleID uniqueidentifier
)
AS 

Declare @SampleSizePosition int


BEGIN

	SELECT  @SampleSizePosition = (CASE 

        WHEN Sel0 = 1 THEN 0

        WHEN Sel1 = 1 THEN 1 

        WHEN Sel2 = 1 THEN 2 

        WHEN Sel3 = 1 THEN 3 

        WHEN Sel4 = 1 THEN 4 

        WHEN Sel5 = 1 THEN 5 

        WHEN Sel6 = 1 THEN 6 

        WHEN Sel7 = 1 THEN 7 

        WHEN Sel8 = 1 THEN 8 

        WHEN Sel9 = 1 THEN 9 

        WHEN Sel10 = 1 THEN 10 

        WHEN Sel11 = 1 THEN 11 

        WHEN Sel12 = 1 THEN 12 

        WHEN Sel13 = 1 THEN 13 

        WHEN Sel14 = 1 THEN 14 

        WHEN Sel15 = 1 THEN 15 

        WHEN Sel16 = 1 THEN 16 

        WHEN Sel17 = 1 THEN 17 

        WHEN Sel18 = 1 THEN 18 

        WHEN Sel19 = 1 THEN 19 

        END) FROM pStyleSpecSize WITH (NOLOCK)

	WHERE (StyleID = @StyleID) 

END

BEGIN

	SELECT ISNULL(@SampleSizePosition,-1)

END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_ReportMaterialRequestSubmitLogic_INSERT]'
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[spx_ReportMaterialRequestSubmitLogic_INSERT]
(
	@DataXmlID varchar(40),
	@MaterialID varchar(40),
	@MaterialTradePartnerColorID varchar(40),
	@MaterialRequestSubmitID varchar(40),
	@MaterialRequestWorkflowID varchar(5),
	@MaterialRequestHeaderXml xml,
	@MaterialRequestBodyXml xml		
)
AS 

DECLARE @MaterialTradePartnerID varchar(40)
BEGIN
	SELECT  @MaterialTradePartnerID = MaterialTradePartnerID FROM pMaterialTradePartnerColor WHERE MaterialTradePartnerColorID =  @MaterialTradePartnerColorID
END

BEGIN
	EXEC spx_ReportMaterialHeader_INSERT @DataXmlId, @MaterialID, @MaterialTradePartnerID, @MaterialRequestSubmitID, @MaterialRequestHeaderXml
	EXEC spx_ReportMaterialRequestSubmitItem_INSERT @DataXmlId, @MaterialRequestWorkflowID, @MaterialRequestSubmitID, @MaterialRequestBodyXml   
END 



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleSpecTemplate_Linked_REMOVE]'
GO
CREATE PROCEDURE [dbo].[spx_StyleSpecTemplate_Linked_REMOVE]
(
	@StyleID uniqueidentifier,
	@StyleSet int
)

AS 


/************************/
/*Declare variables.	*/
/************************/
DECLARE @StyleID_Param UNIQUEIDENTIFIER			--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT						--Keep a copy of the original parameter value.

DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleSpecTemplate_REMOVE
			@StyleID_Param
			,@StyleSet_Param

	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet_Param AS StyleSet
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID
	END

/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Get the 'StyleID' for the update.*/
		SELECT @StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleSpecTemplate_REMOVE
			@StyleID
			,@StyleSet


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_ColorPaletteCopy_INSERT]'
GO


/* Comment #1  - Clayton Parker Oct 29 2009 .
	Burberry wants to be able to copy a chip into a palette even if the names are the same. 
	This is because they will create chips with the same name but with a different ColorCode. 
		I removed from the statement:
			OR ColorName = @ColorName   
*/


ALTER PROCEDURE [dbo].[spx_ColorPaletteCopy_INSERT]  ( 
@ColorPaletteNewID uniqueidentifier, 
@ColorPaletteCopyID uniqueidentifier, 
@ColorFolderID uniqueidentifier, 
@CUser nVarchar (200) , 
@CDate datetime 
) 
AS

DECLARE @ColorCode NVARCHAR(200)
DECLARE @ColorName NVARCHAR(200)

SELECT @ColorCode  = ColorCode, @ColorName = ColorName 
FROM pColorPalette WHERE ColorPaletteID =  @ColorPaletteCopyID

IF ( 
	SELECT COUNT(*) FROM pColorPalette WITH (NOLOCK) 
	WHERE ColorFolderID = @ColorFolderID  
	AND  (  CopyColorPaletteID = @ColorPaletteCopyID OR ColorCode = @ColorCode  )  -- #01
	)  = 0 
BEGIN 


	INSERT INTO pColorPalette ( ColorPaletteID , ColorFolderID , ColorCode, ColorName , ColorSource, ColorNotes, Hex, R, G, B,  C, M, Y, K, H, S, L, LAB_L, LAB_A, LAB_B, 
	CUser, CDate,  MUser, MDate, ColorID, Change, [Action], Active, Sort, ColorImage, CopyColorPaletteID)
	SELECT ColorPaletteID = @ColorPaletteNewID , ColorFolderID = @ColorFolderID , ColorCode, ColorName , ColorSource, ColorNotes, Hex, R, G, B,  C, M, Y, K, H, S, L, LAB_L, LAB_A, LAB_B, 
	CUser = @CUser, CDate = @CDate,  MUser = @CUser, MDate = @CDate, ColorID, Change, [Action], Active, Sort , ColorImage, CopyColorPaletteID = @ColorPaletteCopyID
	FROM pColorPalette WITH (NOLOCK) WHERE ColorPaletteID = @ColorPaletteCopyID
END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleDevelopmentSpecLink_INSERT]'
GO







ALTER      PROCEDURE [dbo].[spx_StyleDevelopmentSpecLink_INSERT]
(
@StyleID uniqueidentifier,
@NewStyleID nvarchar(50),
@SizeClass nvarchar(50),
@SizeRange nvarchar(50),
@CreatedBy nvarchar(50),
@CreatedDate nvarchar(50)
)
AS

SET NOCOUNT ON
--SET ANSI_WARNINGS OFF

DECLARE @POMTempItemID	varchar(50)
DECLARE @POMTempID	varchar(50)
DECLARE @Row_Count int
DECLARE @Row_Loop int
DECLARE	@Size0 nvarchar (7),
@Size1 nvarchar (7), @Size2 nvarchar (7), @Size3 nvarchar (7),@Size4 nvarchar (7),
@Size5 nvarchar (7), @Size6 nvarchar (7), @Size7 nvarchar (7),@Size8 nvarchar (7), 
@Size9 nvarchar (7), @Size10 nvarchar (7), @Size11 nvarchar (7), @Size12 nvarchar (7),
@Size13 nvarchar (7), @Size14 nvarchar (7), @Size15 nvarchar (7), @Size16 nvarchar (7),
@Size17 nvarchar (7), @Size18 nvarchar (7), @Size19 nvarchar (7)

-- *****************************************************************************************
-- Temporary tables
-- *****************************************************************************************
--if exists (select * from sysobjects where id = object_id(N'#tempStyleSpec') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
--drop table #tempStyleSpec


--if not exists (select * from sysobjects where id = object_id(N'#tempStyleSpec') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
BEGIN
CREATE TABLE #tempStyleSpec1 (
	RecID int IDENTITY(1,1)  NOT NULL,
	SpecID  uniqueidentifier,
	SpecMasterID uniqueidentifier,
	StyleID uniqueidentifier,
	POMTempItemID uniqueidentifier,
	POMLibraryID uniqueidentifier,
	POMTempID uniqueidentifier,
	StyleSet int,
	Critical int,
	POM nvarchar (10),
	PointMeasur nvarchar (225),
	TOL numeric(18, 4) NOT NULL ,
	TOLN numeric(18, 4) NOT NULL ,
	Spec decimal(18, 4) NOT NULL ,
	Conv decimal(18, 4) NOT NULL ,
	Proto0 numeric(18, 4) NOT NULL ,
	Proto1 numeric(18, 4) NOT NULL ,
	Proto2 numeric(18, 4) NOT NULL ,
	Proto3 numeric(18, 4) NOT NULL ,
	Proto4 numeric(18, 4) NOT NULL ,
	Proto5 numeric(18, 4) NOT NULL ,
	Proto6 numeric(18, 4) NOT NULL ,
	Proto7 numeric(18, 4) NOT NULL ,
	Proto8 numeric(18, 4) NOT NULL ,
	Proto9 numeric(18, 4) NOT NULL ,
	Proto10 numeric(18, 4) NOT NULL ,
	Proto11 numeric(18, 4) NOT NULL ,
	Proto12 numeric(18, 4) NOT NULL ,
	Proto13 numeric(18, 4) NOT NULL ,
	Proto14 numeric(18, 4) NOT NULL ,
	Proto15 numeric(18, 4) NOT NULL ,
	Proto16 numeric(18, 4) NOT NULL ,
	Proto17 numeric(18, 4) NOT NULL ,
	Proto18 numeric(18, 4) NOT NULL ,
	Proto19 numeric(18, 4) NOT NULL ,
	Grade0 numeric(18, 4) NOT NULL ,
	Grade1 numeric(18, 4) NOT NULL ,
	Grade2 numeric(18, 4) NOT NULL ,
	Grade3 numeric(18, 4) NOT NULL ,
	Grade4 numeric(18, 4) NOT NULL ,
	Grade5 numeric(18, 4) NOT NULL ,
	Grade6 numeric(18, 4) NOT NULL ,
	Grade7 numeric(18, 4) NOT NULL ,
	Grade8 numeric(18, 4) NOT NULL ,
	Grade9 numeric(18, 4) NOT NULL ,
	Grade10 numeric(18, 4) NOT NULL ,
	Grade11 numeric(18, 4) NOT NULL ,
	Grade12 numeric(18, 4) NOT NULL ,
	Grade13 numeric(18, 4) NOT NULL ,
	Grade14 numeric(18, 4) NOT NULL ,
	Grade15 numeric(18, 4) NOT NULL ,
	Grade16 numeric(18, 4) NOT NULL ,
	Grade17 numeric(18, 4) NOT NULL ,
	Grade18 numeric(18, 4) NOT NULL ,
	Grade19 numeric(18, 4) NOT NULL ,
	Size0 numeric(18, 4) NOT NULL ,
	Size1 numeric(18, 4) NOT NULL ,
	Size2 numeric(18, 4) NOT NULL ,
	Size3 numeric(18, 4) NOT NULL ,
	Size4 numeric(18, 4) NOT NULL ,
	Size5 numeric(18, 4) NOT NULL ,
	Size6 numeric(18, 4) NOT NULL ,
	Size7 numeric(18, 4) NOT NULL ,
	Size8 numeric(18, 4) NOT NULL ,
	Size9 numeric(18, 4) NOT NULL ,
	Size10 numeric(18, 4) NOT NULL ,
	Size11 numeric(18, 4) NOT NULL ,
	Size12 numeric(18, 4) NOT NULL ,
	Size13 numeric(18, 4) NOT NULL ,
	Size14 numeric(18, 4) NOT NULL ,
	Size15 numeric(18, 4) NOT NULL ,
	Size16 numeric(18, 4) NOT NULL ,
	Size17 numeric(18, 4) NOT NULL ,
	Size18 numeric(18, 4) NOT NULL ,
	Size19 numeric(18, 4) NOT NULL ,
	CDate datetime,
	CUser nvarchar (200),
	MDate datetime,
	MUser nvarchar (200),
	Change int,
	Sort nvarchar (5),
	HowToMeasurText nvarchar (4000),
	HowToMeasurImage nvarchar (100)  
) 
END

BEGIN
CREATE TABLE #tempStyleSpec2 (
	RecID int IDENTITY(1,1)  NOT NULL,
	SpecID  uniqueidentifier,
	SpecMasterID uniqueidentifier,
	StyleID uniqueidentifier,
	POMTempItemID uniqueidentifier,
	POMLibraryID uniqueidentifier,
	POMTempID uniqueidentifier,
	StyleSet int,
	Critical int,
	POM nvarchar (10),
	PointMeasur nvarchar (225),
	TOL numeric(18, 4) NOT NULL ,
	TOLN numeric(18, 4) NOT NULL ,
	Spec decimal(18, 4) NOT NULL ,
	Conv decimal(18, 4) NOT NULL ,
	Proto0 numeric(18, 4) NOT NULL ,
	Proto1 numeric(18, 4) NOT NULL ,
	Proto2 numeric(18, 4) NOT NULL ,
	Proto3 numeric(18, 4) NOT NULL ,
	Proto4 numeric(18, 4) NOT NULL ,
	Proto5 numeric(18, 4) NOT NULL ,
	Proto6 numeric(18, 4) NOT NULL ,
	Proto7 numeric(18, 4) NOT NULL ,
	Proto8 numeric(18, 4) NOT NULL ,
	Proto9 numeric(18, 4) NOT NULL ,
	Proto10 numeric(18, 4) NOT NULL ,
	Proto11 numeric(18, 4) NOT NULL ,
	Proto12 numeric(18, 4) NOT NULL ,
	Proto13 numeric(18, 4) NOT NULL ,
	Proto14 numeric(18, 4) NOT NULL ,
	Proto15 numeric(18, 4) NOT NULL ,
	Proto16 numeric(18, 4) NOT NULL ,
	Proto17 numeric(18, 4) NOT NULL ,
	Proto18 numeric(18, 4) NOT NULL ,
	Proto19 numeric(18, 4) NOT NULL ,
	Grade0 numeric(18, 4) NOT NULL ,
	Grade1 numeric(18, 4) NOT NULL ,
	Grade2 numeric(18, 4) NOT NULL ,
	Grade3 numeric(18, 4) NOT NULL ,
	Grade4 numeric(18, 4) NOT NULL ,
	Grade5 numeric(18, 4) NOT NULL ,
	Grade6 numeric(18, 4) NOT NULL ,
	Grade7 numeric(18, 4) NOT NULL ,
	Grade8 numeric(18, 4) NOT NULL ,
	Grade9 numeric(18, 4) NOT NULL ,
	Grade10 numeric(18, 4) NOT NULL ,
	Grade11 numeric(18, 4) NOT NULL ,
	Grade12 numeric(18, 4) NOT NULL ,
	Grade13 numeric(18, 4) NOT NULL ,
	Grade14 numeric(18, 4) NOT NULL ,
	Grade15 numeric(18, 4) NOT NULL ,
	Grade16 numeric(18, 4) NOT NULL ,
	Grade17 numeric(18, 4) NOT NULL ,
	Grade18 numeric(18, 4) NOT NULL ,
	Grade19 numeric(18, 4) NOT NULL ,
	Size0 numeric(18, 4) NOT NULL ,
	Size1 numeric(18, 4) NOT NULL ,
	Size2 numeric(18, 4) NOT NULL ,
	Size3 numeric(18, 4) NOT NULL ,
	Size4 numeric(18, 4) NOT NULL ,
	Size5 numeric(18, 4) NOT NULL ,
	Size6 numeric(18, 4) NOT NULL ,
	Size7 numeric(18, 4) NOT NULL ,
	Size8 numeric(18, 4) NOT NULL ,
	Size9 numeric(18, 4) NOT NULL ,
	Size10 numeric(18, 4) NOT NULL ,
	Size11 numeric(18, 4) NOT NULL ,
	Size12 numeric(18, 4) NOT NULL ,
	Size13 numeric(18, 4) NOT NULL ,
	Size14 numeric(18, 4) NOT NULL ,
	Size15 numeric(18, 4) NOT NULL ,
	Size16 numeric(18, 4) NOT NULL ,
	Size17 numeric(18, 4) NOT NULL ,
	Size18 numeric(18, 4) NOT NULL ,
	Size19 numeric(18, 4) NOT NULL ,
	CDate datetime,
	CUser nvarchar (200),
	MDate datetime,
	MUser nvarchar (200),
	Change int,
	Sort nvarchar (5),
	HowToMeasurText nvarchar (4000),
	HowToMeasurImage nvarchar (100)  
) 
END

BEGIN
CREATE TABLE #tempStyleSpec3 (
	RecID int IDENTITY(1,1)  NOT NULL,
	SpecID  uniqueidentifier,
	SpecMasterID uniqueidentifier,
	StyleID uniqueidentifier,
	POMTempItemID uniqueidentifier,
	POMLibraryID uniqueidentifier,
	POMTempID uniqueidentifier,
	StyleSet int,
	Critical int,
	POM nvarchar (10),
	PointMeasur nvarchar (225),
	TOL numeric(18, 4) NOT NULL ,
	TOLN numeric(18, 4) NOT NULL ,
	Spec decimal(18, 4) NOT NULL ,
	Conv decimal(18, 4) NOT NULL ,
	Proto0 numeric(18, 4) NOT NULL ,
	Proto1 numeric(18, 4) NOT NULL ,
	Proto2 numeric(18, 4) NOT NULL ,
	Proto3 numeric(18, 4) NOT NULL ,
	Proto4 numeric(18, 4) NOT NULL ,
	Proto5 numeric(18, 4) NOT NULL ,
	Proto6 numeric(18, 4) NOT NULL ,
	Proto7 numeric(18, 4) NOT NULL ,
	Proto8 numeric(18, 4) NOT NULL ,
	Proto9 numeric(18, 4) NOT NULL ,
	Proto10 numeric(18, 4) NOT NULL ,
	Proto11 numeric(18, 4) NOT NULL ,
	Proto12 numeric(18, 4) NOT NULL ,
	Proto13 numeric(18, 4) NOT NULL ,
	Proto14 numeric(18, 4) NOT NULL ,
	Proto15 numeric(18, 4) NOT NULL ,
	Proto16 numeric(18, 4) NOT NULL ,
	Proto17 numeric(18, 4) NOT NULL ,
	Proto18 numeric(18, 4) NOT NULL ,
	Proto19 numeric(18, 4) NOT NULL ,
	Grade0 numeric(18, 4) NOT NULL ,
	Grade1 numeric(18, 4) NOT NULL ,
	Grade2 numeric(18, 4) NOT NULL ,
	Grade3 numeric(18, 4) NOT NULL ,
	Grade4 numeric(18, 4) NOT NULL ,
	Grade5 numeric(18, 4) NOT NULL ,
	Grade6 numeric(18, 4) NOT NULL ,
	Grade7 numeric(18, 4) NOT NULL ,
	Grade8 numeric(18, 4) NOT NULL ,
	Grade9 numeric(18, 4) NOT NULL ,
	Grade10 numeric(18, 4) NOT NULL ,
	Grade11 numeric(18, 4) NOT NULL ,
	Grade12 numeric(18, 4) NOT NULL ,
	Grade13 numeric(18, 4) NOT NULL ,
	Grade14 numeric(18, 4) NOT NULL ,
	Grade15 numeric(18, 4) NOT NULL ,
	Grade16 numeric(18, 4) NOT NULL ,
	Grade17 numeric(18, 4) NOT NULL ,
	Grade18 numeric(18, 4) NOT NULL ,
	Grade19 numeric(18, 4) NOT NULL ,
	Size0 numeric(18, 4) NOT NULL ,
	Size1 numeric(18, 4) NOT NULL ,
	Size2 numeric(18, 4) NOT NULL ,
	Size3 numeric(18, 4) NOT NULL ,
	Size4 numeric(18, 4) NOT NULL ,
	Size5 numeric(18, 4) NOT NULL ,
	Size6 numeric(18, 4) NOT NULL ,
	Size7 numeric(18, 4) NOT NULL ,
	Size8 numeric(18, 4) NOT NULL ,
	Size9 numeric(18, 4) NOT NULL ,
	Size10 numeric(18, 4) NOT NULL ,
	Size11 numeric(18, 4) NOT NULL ,
	Size12 numeric(18, 4) NOT NULL ,
	Size13 numeric(18, 4) NOT NULL ,
	Size14 numeric(18, 4) NOT NULL ,
	Size15 numeric(18, 4) NOT NULL ,
	Size16 numeric(18, 4) NOT NULL ,
	Size17 numeric(18, 4) NOT NULL ,
	Size18 numeric(18, 4) NOT NULL ,
	Size19 numeric(18, 4) NOT NULL ,
	CDate datetime,
	CUser nvarchar (200),
	MDate datetime,
	MUser nvarchar (200),
	Change int,
	Sort nvarchar (5),
	HowToMeasurText nvarchar (4000),
	HowToMeasurImage nvarchar (100)  
) 
END

BEGIN
CREATE TABLE #tempStyleSpec4 (
	RecID int IDENTITY(1,1)  NOT NULL,
	SpecID  uniqueidentifier,
	SpecMasterID uniqueidentifier,
	StyleID uniqueidentifier,
	POMTempItemID uniqueidentifier,
	POMLibraryID uniqueidentifier,
	POMTempID uniqueidentifier,
	StyleSet int,
	Critical int,
	POM nvarchar (10),
	PointMeasur nvarchar (225),
	TOL numeric(18, 4) NOT NULL ,
	TOLN numeric(18, 4) NOT NULL ,
	Spec decimal(18, 4) NOT NULL ,
	Conv decimal(18, 4) NOT NULL ,
	Proto0 numeric(18, 4) NOT NULL ,
	Proto1 numeric(18, 4) NOT NULL ,
	Proto2 numeric(18, 4) NOT NULL ,
	Proto3 numeric(18, 4) NOT NULL ,
	Proto4 numeric(18, 4) NOT NULL ,
	Proto5 numeric(18, 4) NOT NULL ,
	Proto6 numeric(18, 4) NOT NULL ,
	Proto7 numeric(18, 4) NOT NULL ,
	Proto8 numeric(18, 4) NOT NULL ,
	Proto9 numeric(18, 4) NOT NULL ,
	Proto10 numeric(18, 4) NOT NULL ,
	Proto11 numeric(18, 4) NOT NULL ,
	Proto12 numeric(18, 4) NOT NULL ,
	Proto13 numeric(18, 4) NOT NULL ,
	Proto14 numeric(18, 4) NOT NULL ,
	Proto15 numeric(18, 4) NOT NULL ,
	Proto16 numeric(18, 4) NOT NULL ,
	Proto17 numeric(18, 4) NOT NULL ,
	Proto18 numeric(18, 4) NOT NULL ,
	Proto19 numeric(18, 4) NOT NULL ,
	Grade0 numeric(18, 4) NOT NULL ,
	Grade1 numeric(18, 4) NOT NULL ,
	Grade2 numeric(18, 4) NOT NULL ,
	Grade3 numeric(18, 4) NOT NULL ,
	Grade4 numeric(18, 4) NOT NULL ,
	Grade5 numeric(18, 4) NOT NULL ,
	Grade6 numeric(18, 4) NOT NULL ,
	Grade7 numeric(18, 4) NOT NULL ,
	Grade8 numeric(18, 4) NOT NULL ,
	Grade9 numeric(18, 4) NOT NULL ,
	Grade10 numeric(18, 4) NOT NULL ,
	Grade11 numeric(18, 4) NOT NULL ,
	Grade12 numeric(18, 4) NOT NULL ,
	Grade13 numeric(18, 4) NOT NULL ,
	Grade14 numeric(18, 4) NOT NULL ,
	Grade15 numeric(18, 4) NOT NULL ,
	Grade16 numeric(18, 4) NOT NULL ,
	Grade17 numeric(18, 4) NOT NULL ,
	Grade18 numeric(18, 4) NOT NULL ,
	Grade19 numeric(18, 4) NOT NULL ,
	Size0 numeric(18, 4) NOT NULL ,
	Size1 numeric(18, 4) NOT NULL ,
	Size2 numeric(18, 4) NOT NULL ,
	Size3 numeric(18, 4) NOT NULL ,
	Size4 numeric(18, 4) NOT NULL ,
	Size5 numeric(18, 4) NOT NULL ,
	Size6 numeric(18, 4) NOT NULL ,
	Size7 numeric(18, 4) NOT NULL ,
	Size8 numeric(18, 4) NOT NULL ,
	Size9 numeric(18, 4) NOT NULL ,
	Size10 numeric(18, 4) NOT NULL ,
	Size11 numeric(18, 4) NOT NULL ,
	Size12 numeric(18, 4) NOT NULL ,
	Size13 numeric(18, 4) NOT NULL ,
	Size14 numeric(18, 4) NOT NULL ,
	Size15 numeric(18, 4) NOT NULL ,
	Size16 numeric(18, 4) NOT NULL ,
	Size17 numeric(18, 4) NOT NULL ,
	Size18 numeric(18, 4) NOT NULL ,
	Size19 numeric(18, 4) NOT NULL ,
	CDate datetime,
	CUser nvarchar (200),
	MDate datetime,
	MUser nvarchar (200),
	Change int,
	Sort nvarchar (5),
	HowToMeasurText nvarchar (4000),
	HowToMeasurImage nvarchar (100)  
) 
END

BEGIN
	INSERT INTO #tempStyleSpec1
		(SpecID, StyleID, StyleSet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur, TOL, TOLN, Grade0, Grade1, 
		Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14, Grade15, Grade16, Grade17, 
		Grade18, Grade19, Spec, Conv, Proto0, Proto1, Proto2, Proto3, Proto4, Proto5, Proto6, Proto7, Proto8, Proto9, Proto10, Proto11, Proto12, Proto13, Proto14, 
		Proto15, Proto16, Proto17, Proto18, Proto19, Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13, 
		Size14, Size15, Size16, Size17, Size18, Size19, Change, CDate, CUser, MDate, MUser, Sort)
	SELECT NEWID() AS SpecID, @NewStyleID AS StyleID, StyleSet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur, 
		TOL, TOLN, Grade0, Grade1, Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14, 
		Grade15, Grade16, Grade17, Grade18, Grade19, Spec AS Spec, 0 AS Conv, Spec AS P0, Spec AS P1, Spec AS P2, Spec AS P3, Spec AS P4, Spec AS P5, Spec AS P6,
		Spec AS P7, Spec AS P8, Spec AS P9, Spec AS P10, Spec AS P11, Spec AS P12, Spec AS P13, Spec AS P14, Spec AS P15, Spec AS P16, Spec AS P17, 
		Spec AS P18, Spec AS P19, 0 AS S0, 0 AS S1, 0 AS S2, 0 AS S3, 0 AS S4, 0 AS S5, 0 AS S6, 0 AS S7, 0 AS S8, 0 AS S9, 0 AS S10, 0 AS S11, 0 AS S12, 
		0 AS S13, 0 AS S14, 0 AS S15, 0 AS S16, 0 AS S17, 0 AS S18, 0 AS S19, Change, CDate, CUser, @CreatedDate AS MUser, @CreatedBy AS MDate, 
		Sort
	FROM pStyleSpec WITH (NOLOCK)
	WHERE (StyleID = @StyleID) AND (StyleSet = 1)
	ORDER BY Sort
END

BEGIN
	INSERT INTO #tempStyleSpec2
		(SpecID, StyleID, StyleSet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur, TOL, TOLN, Grade0, Grade1, 
		Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14, Grade15, Grade16, Grade17, 
		Grade18, Grade19, Spec, Conv, Proto0, Proto1, Proto2, Proto3, Proto4, Proto5, Proto6, Proto7, Proto8, Proto9, Proto10, Proto11, Proto12, Proto13, Proto14, 
		Proto15, Proto16, Proto17, Proto18, Proto19, Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13, 
		Size14, Size15, Size16, Size17, Size18, Size19, Change, CDate, CUser, MDate, MUser, Sort)
	SELECT NEWID() AS SpecID, @NewStyleID AS StyleID, StyleSet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur, 
		TOL, TOLN, Grade0, Grade1, Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14, 
		Grade15, Grade16, Grade17, Grade18, Grade19, Spec AS Spec, 0 AS Conv, Spec AS P0, Spec AS P1, Spec AS P2, Spec AS P3, Spec AS P4, Spec AS P5, Spec AS P6,
		Spec AS P7, Spec AS P8, Spec AS P9, Spec AS P10, Spec AS P11, Spec AS P12, Spec AS P13, Spec AS P14, Spec AS P15, Spec AS P16, Spec AS P17, 
		Spec AS P18, Spec AS P19, 0 AS S0, 0 AS S1, 0 AS S2, 0 AS S3, 0 AS S4, 0 AS S5, 0 AS S6, 0 AS S7, 0 AS S8, 0 AS S9, 0 AS S10, 0 AS S11, 0 AS S12, 
		0 AS S13, 0 AS S14, 0 AS S15, 0 AS S16, 0 AS S17, 0 AS S18, 0 AS S19, Change, CDate, CUser, @CreatedDate AS MUser, @CreatedBy AS MDate, 
		Sort
	FROM pStyleSpec WITH (NOLOCK)
	WHERE (StyleID = @StyleID) AND (StyleSet = 2)
	ORDER BY Sort
END

BEGIN
	INSERT INTO #tempStyleSpec3
		(SpecID, StyleID, StyleSet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur, TOL, TOLN, Grade0, Grade1, 
		Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14, Grade15, Grade16, Grade17, 
		Grade18, Grade19, Spec, Conv, Proto0, Proto1, Proto2, Proto3, Proto4, Proto5, Proto6, Proto7, Proto8, Proto9, Proto10, Proto11, Proto12, Proto13, Proto14, 
		Proto15, Proto16, Proto17, Proto18, Proto19, Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13, 
		Size14, Size15, Size16, Size17, Size18, Size19, Change, CDate, CUser, MDate, MUser, Sort)
	SELECT NEWID() AS SpecID, @NewStyleID AS StyleID, StyleSet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur, 
		TOL, TOLN, Grade0, Grade1, Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14, 
		Grade15, Grade16, Grade17, Grade18, Grade19, Spec AS Spec, 0 AS Conv, Spec AS P0, Spec AS P1, Spec AS P2, Spec AS P3, Spec AS P4, Spec AS P5, Spec AS P6,
		Spec AS P7, Spec AS P8, Spec AS P9, Spec AS P10, Spec AS P11, Spec AS P12, Spec AS P13, Spec AS P14, Spec AS P15, Spec AS P16, Spec AS P17, 
		Spec AS P18, Spec AS P19, 0 AS S0, 0 AS S1, 0 AS S2, 0 AS S3, 0 AS S4, 0 AS S5, 0 AS S6, 0 AS S7, 0 AS S8, 0 AS S9, 0 AS S10, 0 AS S11, 0 AS S12, 
		0 AS S13, 0 AS S14, 0 AS S15, 0 AS S16, 0 AS S17, 0 AS S18, 0 AS S19, Change, CDate, CUser, @CreatedDate AS MUser, @CreatedBy AS MDate, 
		Sort
	FROM pStyleSpec WITH (NOLOCK)
	WHERE (StyleID = @StyleID) AND (StyleSet = 3)
	ORDER BY Sort
END

BEGIN
	INSERT INTO #tempStyleSpec4
		(SpecID, StyleID, StyleSet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur, TOL, TOLN, Grade0, Grade1, 
		Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14, Grade15, Grade16, Grade17, 
		Grade18, Grade19, Spec, Conv, Proto0, Proto1, Proto2, Proto3, Proto4, Proto5, Proto6, Proto7, Proto8, Proto9, Proto10, Proto11, Proto12, Proto13, Proto14, 
		Proto15, Proto16, Proto17, Proto18, Proto19, Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13, 
		Size14, Size15, Size16, Size17, Size18, Size19, Change, CDate, CUser, MDate, MUser, Sort)
	SELECT NEWID() AS SpecID, @NewStyleID AS StyleID, StyleSet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur, 
		TOL, TOLN, Grade0, Grade1, Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14, 
		Grade15, Grade16, Grade17, Grade18, Grade19, Spec AS Spec, 0 AS Conv, Spec AS P0, Spec AS P1, Spec AS P2, Spec AS P3, Spec AS P4, Spec AS P5, Spec AS P6,
		Spec AS P7, Spec AS P8, Spec AS P9, Spec AS P10, Spec AS P11, Spec AS P12, Spec AS P13, Spec AS P14, Spec AS P15, Spec AS P16, Spec AS P17, 
		Spec AS P18, Spec AS P19, 0 AS S0, 0 AS S1, 0 AS S2, 0 AS S3, 0 AS S4, 0 AS S5, 0 AS S6, 0 AS S7, 0 AS S8, 0 AS S9, 0 AS S10, 0 AS S11, 0 AS S12, 
		0 AS S13, 0 AS S14, 0 AS S15, 0 AS S16, 0 AS S17, 0 AS S18, 0 AS S19, Change, CDate, CUser, @CreatedDate AS MUser, @CreatedBy AS MDate, 
		Sort
	FROM pStyleSpec WITH (NOLOCK)
	WHERE (StyleID = @StyleID) AND (StyleSet = 4)
	ORDER BY Sort
END

DECLARE @POMTempGroupID varchar(50)
DECLARE @StyleSpecID uniqueidentifier
DECLARE @StyleSpecMasterID uniqueidentifier
DECLARE @NewStyleSpecMasterID uniqueidentifier
DECLARE @POM varchar(10)
DECLARE @PointMeasur varchar(225)
DECLARE @TOL numeric(18, 4), @TOLN numeric(18, 4), @Spec decimal(18, 4),
@Grade0 numeric(18, 4), @Grade1 numeric(18, 4), @Grade2 numeric(18, 4),
@Grade3 numeric(18, 4), @Grade4 numeric(18, 4), @Grade5 numeric(18, 4),
@Grade6 numeric(18, 4), @Grade7 numeric(18, 4), @Grade8 numeric(18, 4),
@Grade9 numeric(18, 4), @Grade10 numeric(18, 4), @Grade11 numeric(18, 4),
@Grade12 numeric(18, 4), @Grade13 numeric(18, 4), @Grade14 numeric(18, 4),
@Grade15 numeric(18, 4), @Grade16 numeric(18, 4), @Grade17 numeric(18, 4),
@Grade18 numeric(18, 4), @Grade19 numeric(18, 4), @Conv numeric(18, 4)


BEGIN

SELECT @POMTempID = POMTempID FROM pStyleSpec WHERE (StyleID = @StyleID) AND
(StyleSet = 1) AND (POMTempID IS NOT NULL)
SELECT @POMTempGroupID = POMTempGroupID FROM pPOMTemplate WHERE POMTempID = @POMTempID 
SELECT @POMTempID = POMTempID, @Size0 = Size0, @Size1 = Size1, @Size2 = Size2,
@Size3 = Size3, @Size4 = Size4, @Size5 = Size5, @Size6 = Size6, @Size7 = Size7, @Size8 = Size8,
@Size9 = Size9, @Size10 = Size10, @Size11 = Size11, @Size12 = Size12, @Size13 = Size13, @Size14 = Size14, 
@Size15 = Size15, @Size16 = Size16, @Size17 = Size17, @Size18 = Size18, @Size19 = Size19
FROM pPOMTemplate WITH (NOLOCK) WHERE POMTempGroupID = @POMTempGroupID AND SizeRange = @SizeRange AND SizeClass = @SizeClass

--INSERT pStyleSpecSize

SELECT * FROM pPOMTemplate WITH (NOLOCK) WHERE POMTempGroupID = @POMTempGroupID AND SizeRange = @SizeRange AND SizeClass = @SizeClass

SELECT * FROM #tempStyleSpec1

SET @Row_Loop = 1
SET @Row_Count = (SELECT COUNT(*) FROM #tempStyleSpec1)

IF @Row_Count <> 0
	BEGIN
	WHILE @Row_Loop <= @Row_Count 
		BEGIN
		
			SELECT @StyleSpecMasterID = SpecMasterID, @StyleSpecID = SpecID, 
			 @POM = POM, @PointMeasur = PointMeasur 
			FROM #tempStyleSpec1 WHERE RecID = @Row_Loop
			
			IF @StyleSpecMasterID IS NULL
			BEGIN
				SET @NewStyleSpecMasterID = newid()
				UPDATE pStyleSpec SET SpecMasterID = @NewStyleSpecMasterID WHERE SpecID = @StyleSpecID
				SET @StyleSpecMasterID = @NewStyleSpecMasterID
			END	
		
			/*Check to see if there is a matching POM in the template before updating AND if the original size class' POM was still linked.*/
			IF (((SELECT COUNT(*) FROM pPOMTemplateItem WITH (NOLOCK) WHERE POM = @POM AND PointMeasur = @PointMeasur AND POMTempID = @POMTempID) = 1) AND
				((SELECT POMTempID FROM #tempStyleSpec1 WHERE RecID = @Row_Loop) IS NOT NULL))
				BEGIN
					SELECT @POMTempItemID = POMTempItemID, @TOL = TOL, @TOLN = TOLN, @Spec = Spec, @Conv = Conv, 
					@Grade0 = Grade0, @Grade1 = Grade1, @Grade2 = Grade2, @Grade3 = Grade3, @Grade4 = Grade4, 
					@Grade5 = Grade5, @Grade6 = Grade6, @Grade7 = Grade7, @Grade8 = Grade8, @Grade9 = Grade9, 
					@Grade10 = Grade10, @Grade11 = Grade11, @Grade12 = Grade12, @Grade13 = Grade13, @Grade14 = Grade14,
					@Grade15 = Grade15, @Grade16 = Grade16, @Grade17 = Grade17, @Grade18 = Grade18, @Grade19 = Grade19 
					--FROM pPOMTemplateItem WITH (NOLOCK) WHERE POM = @POM AND PointMeasur = @PointMeasur AND POMTempGroupID = @POMTempGroupID AND  POMTempID = @POMTempID 
					FROM pPOMTemplateItem WITH (NOLOCK) WHERE POM = @POM AND PointMeasur = @PointMeasur AND POMTempID = @POMTempID 
				
					UPDATE  #tempStyleSpec1 SET 
					SpecMasterID = @StyleSpecMasterID, POMTempItemID = @POMTempItemID, TOL = @TOL, TOLN = @TOLN, Spec = @Spec, Conv = @Conv, 
					Grade0 = @Grade0, Grade1 = @Grade1, Grade2 = @Grade2, Grade3 = @Grade3, Grade4 = @Grade4, 
					Grade5 = @Grade5, Grade6 = @Grade6, Grade7 = @Grade7, Grade8 = @Grade8, Grade9 = @Grade9, 
					Grade10 = @Grade10, Grade11 = @Grade11, Grade12 = @Grade12, Grade13 = @Grade13, Grade14 = @Grade14,
					Grade15 = @Grade15, Grade16 = @Grade16, Grade17 = @Grade17, Grade18 = @Grade18, Grade19 = @Grade19, POMTempID = @POMTempID
					WHERE RecID = @Row_Loop
				END
			/*Else set the unlinked POM's spec value, grades, etc. to zeros.*/
			ELSE
				BEGIN
					UPDATE  #tempStyleSpec1 SET 
					Spec = 0, Conv = 0, Grade0 = 0, Grade1 = 0, Grade2 = 0, Grade3 = 0, Grade4 = 0,	Grade5 = 0, Grade6 = 0, Grade7 = 0,
					Grade8 = 0, Grade9 = 0,	Grade10 = 0, Grade11 = 0, Grade12 = 0, Grade13 = 0, Grade14 = 0, Grade15 = 0, Grade16 = 0,
					Grade17 = 0, Grade18 = 0, Grade19 = 0, Proto0 = 0, Proto1 = 0, Proto2 = 0, Proto3 = 0, Proto4 = 0, Proto5 = 0,
					Proto6 = 0, Proto7 = 0, Proto8 = 0, Proto9 = 0, Proto10 = 0, Proto11 = 0, Proto12 = 0, Proto13 = 0, Proto14 = 0,
					Proto15 = 0, Proto16 = 0, Proto17 = 0, Proto18 = 0, Proto19 = 0, Size0 = 0, Size1 = 0, Size2 = 0, Size3 = 0, Size4 = 0,
					Size5 = 0, Size6 = 0, Size7 = 0, Size8 = 0, Size9 = 0, Size10 = 0, Size11 = 0, Size12 = 0, Size13 = 0, Size14 = 0,
					Size15 = 0, Size16 = 0, Size17 = 0, Size18 = 0, Size19 = 0
					WHERE RecID = @Row_Loop
				END

			--SELECT * FROM #tempStyleSpec1 WHERE RecID = @Row_Loop

			SET @Row_Loop = @Row_Loop + 1
		END
		
		UPDATE pStyleHeader SET POMTempID1 = @POMTempID, SizeClass = @SizeClass, Sizerange = @SizeRange WHERE StyleID = @NewStyleID

		INSERT INTO pStyleSpec
			(SpecID, StyleID, StyleSet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur, TOL, TOLN, Grade0, Grade1, 
			Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14, Grade15, Grade16, Grade17, 
			Grade18, Grade19, Proto0, Proto1, Proto2, Proto3, Proto4, Proto5, Proto6, Proto7, Proto8, Proto9, Proto10, Proto11, Proto12, Proto13, Proto14, Proto15, 
			Proto16, Proto17, Proto18, Proto19, Spec, Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13, 
			Size14, Size15, Size16, Size17, Size18, Size19, CDate, CUser, MDate, MUser, Change, Sort, Conv)
		SELECT NEWID() AS SpecID, @NewStyleID AS StyleID, StyleSet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, 
			PointMeasur, TOL, TOLN, Grade0, Grade1, Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, 
			Grade14, Grade15, Grade16, Grade17, Grade18, Grade19, Spec AS Proto0, Spec AS Proto1, Spec AS Proto2, Spec AS Proto3, Spec AS Proto4, 
			Spec AS Proto5, Spec AS Proto6, Spec AS Proto7, Spec AS Proto8, Spec AS Proto9, Spec AS Proto10, Spec AS Proto11, Spec AS Proto12, 
			Spec AS Proto13, Spec AS Proto19, Spec AS Proto18, Spec AS Proto17, Spec AS Proto16, Spec AS Proto15, Spec AS Proto14, Spec AS Spec, 0 AS Size0, 
			0 AS Size1, 0 AS Size2, 0 AS Size3, 0 AS Size4, 0 AS Size5, 0 AS Size6, 0 AS Size7, 0 AS Size8, 0 AS Size9, 0 AS Size10, 0 AS Size11, 0 AS Size12, 
			0 AS Size13, 0 AS Size14, 0 AS Size15, 0 AS Size16, 0 AS Size17, 0 AS Size18, 0 AS Size19, CDate, CUser, @CreatedDate AS MUser, 
			@CreatedBy AS MDate, Change, Sort, Conv
		FROM  #tempStyleSpec1		
	END	
END


BEGIN

SELECT @POMTempID = POMTempID FROM pStyleSpec WHERE (StyleID = @StyleID) AND StyleSet = 2
SELECT @POMTempGroupID = POMTempGroupID FROM pPOMTemplate WHERE POMTempID = @POMTempID 
SELECT @POMTempID = POMTempID, @Size0 = Size0, @Size1 = Size1, @Size2 = Size2,
@Size3 = Size3, @Size4 = Size4, @Size5 = Size5, @Size6 = Size6, @Size7 = Size7, @Size8 = Size8,
@Size9 = Size9, @Size10 = Size10, @Size11 = Size11, @Size12 = Size12, @Size13 = Size13, @Size14 = Size14, 
@Size15 = Size15, @Size16 = Size16, @Size17 = Size17, @Size18 = Size18, @Size19 = Size19
FROM pPOMTemplate WITH (NOLOCK) WHERE POMTempGroupID = @POMTempGroupID AND SizeRange = @SizeRange AND SizeClass = @SizeClass

--INSERT pStyleSpecSize

SET @Row_Loop = 1
SET @Row_Count = (SELECT COUNT(*) FROM #tempStyleSpec2)

IF @Row_Count <> 0
	BEGIN
	WHILE @Row_Loop <= @Row_Count 
		BEGIN
		
			SELECT @StyleSpecMasterID = SpecMasterID, @StyleSpecID = SpecID, 
			 @POM = POM, @PointMeasur = PointMeasur 
			FROM #tempStyleSpec2 WHERE RecID = @Row_Loop
			
			IF @StyleSpecMasterID IS NULL
			BEGIN
				SET @NewStyleSpecMasterID = newid()
				UPDATE pStyleSpec SET SpecMasterID = @NewStyleSpecMasterID WHERE SpecID = @StyleSpecID
				SET @StyleSpecMasterID = @NewStyleSpecMasterID
			END	
		
			/*Check to see if there is a matching POM in the template before updating AND if the original size class' POM was still linked.*/
			IF (((SELECT COUNT(*) FROM pPOMTemplateItem WITH (NOLOCK) WHERE POM = @POM AND PointMeasur = @PointMeasur AND POMTempID = @POMTempID) = 1) AND
				((SELECT POMTempID FROM #tempStyleSpec2 WHERE RecID = @Row_Loop) IS NOT NULL))
				BEGIN
					SELECT @POMTempItemID = POMTempItemID, @TOL = TOL, @TOLN = TOLN, @Spec = Spec,  @Conv = Conv, 
					@Grade0 = Grade0, @Grade1 = Grade1, @Grade2 = Grade2, @Grade3 = Grade3, @Grade4 = Grade4, 
					@Grade5 = Grade5, @Grade6 = Grade6, @Grade7 = Grade7, @Grade8 = Grade8, @Grade9 = Grade9, 
					@Grade10 = Grade10, @Grade11 = Grade11, @Grade12 = Grade12, @Grade13 = Grade13, @Grade14 = Grade14,
					@Grade15 = Grade15, @Grade16 = Grade16, @Grade17 = Grade17, @Grade18 = Grade18, @Grade19 = Grade19 
					--FROM pPOMTemplateItem WITH (NOLOCK) WHERE POM = @POM AND PointMeasur = @PointMeasur AND POMTempGroupID = @POMTempGroupID AND  POMTempID = @POMTempID 
					FROM pPOMTemplateItem WITH (NOLOCK) WHERE POM = @POM AND PointMeasur = @PointMeasur AND POMTempID = @POMTempID 
				
					UPDATE  #tempStyleSpec2 SET 
					SpecMasterID = @StyleSpecMasterID, POMTempItemID = @POMTempItemID, TOL = @TOL, TOLN = @TOLN, Spec = @Spec, Conv = @Conv, 
					Grade0 = @Grade0, Grade1 = @Grade1, Grade2 = @Grade2, Grade3 = @Grade3, Grade4 = @Grade4, 
					Grade5 = @Grade5, Grade6 = @Grade6, Grade7 = @Grade7, Grade8 = @Grade8, Grade9 = @Grade9, 
					Grade10 = @Grade10, Grade11 = @Grade11, Grade12 = @Grade12, Grade13 = @Grade13, Grade14 = @Grade14,
					Grade15 = @Grade15, Grade16 = @Grade16, Grade17 = @Grade17, Grade18 = @Grade18, Grade19 = @Grade19, POMTempID = @POMTempID
					WHERE RecID = @Row_Loop
				END
			/*Else set the unlinked POM's spec value, grades, etc. to zeros.*/
			ELSE
				BEGIN
					UPDATE  #tempStyleSpec2 SET 
					Spec = 0, Conv = 0, Grade0 = 0, Grade1 = 0, Grade2 = 0, Grade3 = 0, Grade4 = 0,	Grade5 = 0, Grade6 = 0, Grade7 = 0,
					Grade8 = 0, Grade9 = 0,	Grade10 = 0, Grade11 = 0, Grade12 = 0, Grade13 = 0, Grade14 = 0, Grade15 = 0, Grade16 = 0,
					Grade17 = 0, Grade18 = 0, Grade19 = 0, Proto0 = 0, Proto1 = 0, Proto2 = 0, Proto3 = 0, Proto4 = 0, Proto5 = 0,
					Proto6 = 0, Proto7 = 0, Proto8 = 0, Proto9 = 0, Proto10 = 0, Proto11 = 0, Proto12 = 0, Proto13 = 0, Proto14 = 0,
					Proto15 = 0, Proto16 = 0, Proto17 = 0, Proto18 = 0, Proto19 = 0, Size0 = 0, Size1 = 0, Size2 = 0, Size3 = 0, Size4 = 0,
					Size5 = 0, Size6 = 0, Size7 = 0, Size8 = 0, Size9 = 0, Size10 = 0, Size11 = 0, Size12 = 0, Size13 = 0, Size14 = 0,
					Size15 = 0, Size16 = 0, Size17 = 0, Size18 = 0, Size19 = 0
					WHERE RecID = @Row_Loop
				END

			SET @Row_Loop = @Row_Loop + 1
		END
		
	UPDATE pStyleHeader SET POMTempID2 = @POMTempID, SizeClass = @SizeClass, Sizerange = @SizeRange WHERE StyleID = @NewStyleID

		INSERT INTO pStyleSpec
			(SpecID, StyleID, StyleSet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur, TOL, TOLN, Grade0, Grade1, 
			Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14, Grade15, Grade16, Grade17, 
			Grade18, Grade19, Proto0, Proto1, Proto2, Proto3, Proto4, Proto5, Proto6, Proto7, Proto8, Proto9, Proto10, Proto11, Proto12, Proto13, Proto14, Proto15, 
			Proto16, Proto17, Proto18, Proto19, Spec, Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13, 
			Size14, Size15, Size16, Size17, Size18, Size19, CDate, CUser, MDate, MUser, Change, Sort, Conv)
		SELECT NEWID() AS SpecID, @NewStyleID AS StyleID, StyleSet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, 
			PointMeasur, TOL, TOLN, Grade0, Grade1, Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, 
			Grade14, Grade15, Grade16, Grade17, Grade18, Grade19, Spec AS Proto0, Spec AS Proto1, Spec AS Proto2, Spec AS Proto3, Spec AS Proto4, 
			Spec AS Proto5, Spec AS Proto6, Spec AS Proto7, Spec AS Proto8, Spec AS Proto9, Spec AS Proto10, Spec AS Proto11, Spec AS Proto12, 
			Spec AS Proto13, Spec AS Proto19, Spec AS Proto18, Spec AS Proto17, Spec AS Proto16, Spec AS Proto15, Spec AS Proto14, Spec AS Spec, 0 AS Size0, 
			0 AS Size1, 0 AS Size2, 0 AS Size3, 0 AS Size4, 0 AS Size5, 0 AS Size6, 0 AS Size7, 0 AS Size8, 0 AS Size9, 0 AS Size10, 0 AS Size11, 0 AS Size12, 
			0 AS Size13, 0 AS Size14, 0 AS Size15, 0 AS Size16, 0 AS Size17, 0 AS Size18, 0 AS Size19, CDate, CUser, @CreatedDate AS MUser, 
			@CreatedBy AS MDate, Change, Sort, Conv
		FROM  #tempStyleSpec2		
	END	
END


BEGIN

SELECT @POMTempID = POMTempID FROM pStyleSpec WITH (NOLOCK) WHERE (StyleID = @StyleID) AND StyleSet = 3
SELECT @POMTempGroupID = POMTempGroupID FROM pPOMTemplate WITH (NOLOCK) WHERE POMTempID = @POMTempID 
SELECT @POMTempID = POMTempID, @Size0 = Size0, @Size1 = Size1, @Size2 = Size2,
@Size3 = Size3, @Size4 = Size4, @Size5 = Size5, @Size6 = Size6, @Size7 = Size7, @Size8 = Size8,
@Size9 = Size9, @Size10 = Size10, @Size11 = Size11, @Size12 = Size12, @Size13 = Size13, @Size14 = Size14, 
@Size15 = Size15, @Size16 = Size16, @Size17 = Size17, @Size18 = Size18, @Size19 = Size19
FROM pPOMTemplate WITH (NOLOCK) WHERE POMTempGroupID = @POMTempGroupID AND SizeRange = @SizeRange AND SizeClass = @SizeClass

--INSERT pStyleSpecSize

SET @Row_Loop = 1
SET @Row_Count = (SELECT COUNT(*) FROM #tempStyleSpec3)

IF @Row_Count <> 0
	BEGIN
	WHILE @Row_Loop <= @Row_Count 
		BEGIN
		
			SELECT @StyleSpecMasterID = SpecMasterID, @StyleSpecID = SpecID, 
			 @POM = POM, @PointMeasur = PointMeasur 
			FROM #tempStyleSpec3 WHERE RecID = @Row_Loop
			
			IF @StyleSpecMasterID IS NULL
			BEGIN
				SET @NewStyleSpecMasterID = newid()
				UPDATE pStyleSpec SET SpecMasterID = @NewStyleSpecMasterID WHERE SpecID = @StyleSpecID
				SET @StyleSpecMasterID = @NewStyleSpecMasterID
			END	
		
			/*Check to see if there is a matching POM in the template before updating AND if the original size class' POM was still linked.*/
			IF (((SELECT COUNT(*) FROM pPOMTemplateItem WITH (NOLOCK) WHERE POM = @POM AND PointMeasur = @PointMeasur AND POMTempID = @POMTempID) = 1) AND
				((SELECT POMTempID FROM #tempStyleSpec3 WHERE RecID = @Row_Loop) IS NOT NULL))
				BEGIN
					SELECT @POMTempItemID = POMTempItemID, @TOL = TOL, @TOLN = TOLN, @Spec = Spec,  @Conv = Conv,  
					@Grade0 = Grade0, @Grade1 = Grade1, @Grade2 = Grade2, @Grade3 = Grade3, @Grade4 = Grade4, 
					@Grade5 = Grade5, @Grade6 = Grade6, @Grade7 = Grade7, @Grade8 = Grade8, @Grade9 = Grade9, 
					@Grade10 = Grade10, @Grade11 = Grade11, @Grade12 = Grade12, @Grade13 = Grade13, @Grade14 = Grade14,
					@Grade15 = Grade15, @Grade16 = Grade16, @Grade17 = Grade17, @Grade18 = Grade18, @Grade19 = Grade19 
					FROM pPOMTemplateItem WITH (NOLOCK) WHERE POM = @POM AND PointMeasur = @PointMeasur AND POMTempID = @POMTempID 
					--FROM pPOMTemplateItem WITH (NOLOCK) WHERE POM = @POM AND PointMeasur = @PointMeasur AND POMTempGroupID = @POMTempGroupID AND  POMTempID = @POMTempID 
				
					UPDATE  #tempStyleSpec3 SET 
					SpecMasterID = @StyleSpecMasterID, POMTempItemID = @POMTempItemID, TOL = @TOL, TOLN = @TOLN, Spec = @Spec, Conv = @Conv, 
					Grade0 = @Grade0, Grade1 = @Grade1, Grade2 = @Grade2, Grade3 = @Grade3, Grade4 = @Grade4, 
					Grade5 = @Grade5, Grade6 = @Grade6, Grade7 = @Grade7, Grade8 = @Grade8, Grade9 = @Grade9, 
					Grade10 = @Grade10, Grade11 = @Grade11, Grade12 = @Grade12, Grade13 = @Grade13, Grade14 = @Grade14,
					Grade15 = @Grade15, Grade16 = @Grade16, Grade17 = @Grade17, Grade18 = @Grade18, Grade19 = @Grade19, POMTempID = @POMTempID
					WHERE RecID = @Row_Loop
				END
			/*Else set the unlinked POM's spec value, grades, etc. to zeros.*/
			ELSE
				BEGIN
					UPDATE  #tempStyleSpec3 SET 
					Spec = 0, Conv = 0, Grade0 = 0, Grade1 = 0, Grade2 = 0, Grade3 = 0, Grade4 = 0,	Grade5 = 0, Grade6 = 0, Grade7 = 0,
					Grade8 = 0, Grade9 = 0,	Grade10 = 0, Grade11 = 0, Grade12 = 0, Grade13 = 0, Grade14 = 0, Grade15 = 0, Grade16 = 0,
					Grade17 = 0, Grade18 = 0, Grade19 = 0, Proto0 = 0, Proto1 = 0, Proto2 = 0, Proto3 = 0, Proto4 = 0, Proto5 = 0,
					Proto6 = 0, Proto7 = 0, Proto8 = 0, Proto9 = 0, Proto10 = 0, Proto11 = 0, Proto12 = 0, Proto13 = 0, Proto14 = 0,
					Proto15 = 0, Proto16 = 0, Proto17 = 0, Proto18 = 0, Proto19 = 0, Size0 = 0, Size1 = 0, Size2 = 0, Size3 = 0, Size4 = 0,
					Size5 = 0, Size6 = 0, Size7 = 0, Size8 = 0, Size9 = 0, Size10 = 0, Size11 = 0, Size12 = 0, Size13 = 0, Size14 = 0,
					Size15 = 0, Size16 = 0, Size17 = 0, Size18 = 0, Size19 = 0
					WHERE RecID = @Row_Loop
				END

			SET @Row_Loop = @Row_Loop + 1
		END
		
	UPDATE pStyleHeader SET POMTempID3 = @POMTempID, SizeClass = @SizeClass, Sizerange = @SizeRange WHERE StyleID = @NewStyleID

		INSERT INTO pStyleSpec
			(SpecID, StyleID, StyleSet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur, TOL, TOLN, Grade0, Grade1, 
			Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14, Grade15, Grade16, Grade17, 
			Grade18, Grade19, Proto0, Proto1, Proto2, Proto3, Proto4, Proto5, Proto6, Proto7, Proto8, Proto9, Proto10, Proto11, Proto12, Proto13, Proto14, Proto15, 
			Proto16, Proto17, Proto18, Proto19, Spec, Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13, 
			Size14, Size15, Size16, Size17, Size18, Size19, CDate, CUser, MDate, MUser, Change, Sort, Conv)
		SELECT NEWID() AS SpecID, @NewStyleID AS StyleID, StyleSet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, 
			PointMeasur, TOL, TOLN, Grade0, Grade1, Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, 
			Grade14, Grade15, Grade16, Grade17, Grade18, Grade19, Spec AS Proto0, Spec AS Proto1, Spec AS Proto2, Spec AS Proto3, Spec AS Proto4, 
			Spec AS Proto5, Spec AS Proto6, Spec AS Proto7, Spec AS Proto8, Spec AS Proto9, Spec AS Proto10, Spec AS Proto11, Spec AS Proto12, 
			Spec AS Proto13, Spec AS Proto19, Spec AS Proto18, Spec AS Proto17, Spec AS Proto16, Spec AS Proto15, Spec AS Proto14, Spec AS Spec, 0 AS Size0, 
			0 AS Size1, 0 AS Size2, 0 AS Size3, 0 AS Size4, 0 AS Size5, 0 AS Size6, 0 AS Size7, 0 AS Size8, 0 AS Size9, 0 AS Size10, 0 AS Size11, 0 AS Size12, 
			0 AS Size13, 0 AS Size14, 0 AS Size15, 0 AS Size16, 0 AS Size17, 0 AS Size18, 0 AS Size19, CDate, CUser, @CreatedDate AS MUser, 
			@CreatedBy AS MDate, Change, Sort, Conv
		FROM  #tempStyleSpec3		
	END	
END


BEGIN

SELECT @POMTempID = POMTempID FROM pStyleSpec WHERE (StyleID = @StyleID) AND StyleSet = 4
SELECT @POMTempGroupID = POMTempGroupID FROM pPOMTemplate WHERE POMTempID = @POMTempID 
SELECT @POMTempID = POMTempID, @Size0 = Size0, @Size1 = Size1, @Size2 = Size2,
@Size3 = Size3, @Size4 = Size4, @Size5 = Size5, @Size6 = Size6, @Size7 = Size7, @Size8 = Size8,
@Size9 = Size9, @Size10 = Size10, @Size11 = Size11, @Size12 = Size12, @Size13 = Size13, @Size14 = Size14, 
@Size15 = Size15, @Size16 = Size16, @Size17 = Size17, @Size18 = Size18, @Size19 = Size19
FROM pPOMTemplate WITH (NOLOCK) WHERE POMTempGroupID = @POMTempGroupID AND SizeRange = @SizeRange AND SizeClass = @SizeClass

--INSERT pStyleSpecSize

SET @Row_Loop = 1
SET @Row_Count = (SELECT COUNT(*) FROM #tempStyleSpec4)

IF @Row_Count <> 0
	BEGIN
	WHILE @Row_Loop <= @Row_Count 
		BEGIN
		
			SELECT @StyleSpecMasterID = SpecMasterID, @StyleSpecID = SpecID, 
			 @POM = POM, @PointMeasur = PointMeasur 
			FROM #tempStyleSpec4 WHERE RecID = @Row_Loop
			
			IF @StyleSpecMasterID IS NULL
			BEGIN
				SET @NewStyleSpecMasterID = newid()
				UPDATE pStyleSpec SET SpecMasterID = @NewStyleSpecMasterID WHERE SpecID = @StyleSpecID
				SET @StyleSpecMasterID = @NewStyleSpecMasterID
			END	
		
			/*Check to see if there is a matching POM in the template before updating AND if the original size class' POM was still linked.*/
			IF (((SELECT COUNT(*) FROM pPOMTemplateItem WITH (NOLOCK) WHERE POM = @POM AND PointMeasur = @PointMeasur AND POMTempID = @POMTempID) = 1) AND
				((SELECT POMTempID FROM #tempStyleSpec4 WHERE RecID = @Row_Loop) IS NOT NULL))
				BEGIN
					SELECT @POMTempItemID = POMTempItemID, @TOL = TOL, @TOLN = TOLN, @Spec = Spec, @Conv = Conv,  
					@Grade0 = Grade0, @Grade1 = Grade1, @Grade2 = Grade2, @Grade3 = Grade3, @Grade4 = Grade4, 
					@Grade5 = Grade5, @Grade6 = Grade6, @Grade7 = Grade7, @Grade8 = Grade8, @Grade9 = Grade9, 
					@Grade10 = Grade10, @Grade11 = Grade11, @Grade12 = Grade12, @Grade13 = Grade13, @Grade14 = Grade14,
					@Grade15 = Grade15, @Grade16 = Grade16, @Grade17 = Grade17, @Grade18 = Grade18, @Grade19 = Grade19 
					FROM pPOMTemplateItem WITH (NOLOCK) WHERE POM = @POM AND PointMeasur = @PointMeasur AND POMTempID = @POMTempID 
					--FROM pPOMTemplateItem WITH (NOLOCK) WHERE POM = @POM AND PointMeasur = @PointMeasur AND POMTempGroupID = @POMTempGroupID AND  POMTempID = @POMTempID 
				
					UPDATE  #tempStyleSpec4 SET 
					SpecMasterID = @StyleSpecMasterID, POMTempItemID = @POMTempItemID, TOL = @TOL, TOLN = @TOLN, Spec = @Spec, Conv = @Conv,  
					Grade0 = @Grade0, Grade1 = @Grade1, Grade2 = @Grade2, Grade3 = @Grade3, Grade4 = @Grade4, 
					Grade5 = @Grade5, Grade6 = @Grade6, Grade7 = @Grade7, Grade8 = @Grade8, Grade9 = @Grade9, 
					Grade10 = @Grade10, Grade11 = @Grade11, Grade12 = @Grade12, Grade13 = @Grade13, Grade14 = @Grade14,
					Grade15 = @Grade15, Grade16 = @Grade16, Grade17 = @Grade17, Grade18 = @Grade18, Grade19 = @Grade19, POMTempID = @POMTempID
					WHERE RecID = @Row_Loop
				END
			/*Else set the unlinked POM's spec value, grades, etc. to zeros.*/
			ELSE
				BEGIN
					UPDATE  #tempStyleSpec4 SET 
					Spec = 0, Conv = 0, Grade0 = 0, Grade1 = 0, Grade2 = 0, Grade3 = 0, Grade4 = 0,	Grade5 = 0, Grade6 = 0, Grade7 = 0,
					Grade8 = 0, Grade9 = 0,	Grade10 = 0, Grade11 = 0, Grade12 = 0, Grade13 = 0, Grade14 = 0, Grade15 = 0, Grade16 = 0,
					Grade17 = 0, Grade18 = 0, Grade19 = 0, Proto0 = 0, Proto1 = 0, Proto2 = 0, Proto3 = 0, Proto4 = 0, Proto5 = 0,
					Proto6 = 0, Proto7 = 0, Proto8 = 0, Proto9 = 0, Proto10 = 0, Proto11 = 0, Proto12 = 0, Proto13 = 0, Proto14 = 0,
					Proto15 = 0, Proto16 = 0, Proto17 = 0, Proto18 = 0, Proto19 = 0, Size0 = 0, Size1 = 0, Size2 = 0, Size3 = 0, Size4 = 0,
					Size5 = 0, Size6 = 0, Size7 = 0, Size8 = 0, Size9 = 0, Size10 = 0, Size11 = 0, Size12 = 0, Size13 = 0, Size14 = 0,
					Size15 = 0, Size16 = 0, Size17 = 0, Size18 = 0, Size19 = 0
					WHERE RecID = @Row_Loop
				END

			SET @Row_Loop = @Row_Loop + 1
		END
		
	UPDATE pStyleHeader SET POMTempID4 = @POMTempID, SizeClass = @SizeClass, Sizerange = @SizeRange WHERE StyleID = @NewStyleID

		INSERT INTO pStyleSpec
			(SpecID, StyleID, StyleSet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur, TOL, TOLN, Grade0, Grade1, 
			Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14, Grade15, Grade16, Grade17, 
			Grade18, Grade19, Proto0, Proto1, Proto2, Proto3, Proto4, Proto5, Proto6, Proto7, Proto8, Proto9, Proto10, Proto11, Proto12, Proto13, Proto14, Proto15, 
			Proto16, Proto17, Proto18, Proto19, Spec, Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13, 
			Size14, Size15, Size16, Size17, Size18, Size19, CDate, CUser, MDate, MUser, Change, Sort, Conv)
		SELECT NEWID() AS SpecID, @NewStyleID AS StyleID, StyleSet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, 
			PointMeasur, TOL, TOLN, Grade0, Grade1, Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, 
			Grade14, Grade15, Grade16, Grade17, Grade18, Grade19, Spec AS Proto0, Spec AS Proto1, Spec AS Proto2, Spec AS Proto3, Spec AS Proto4, 
			Spec AS Proto5, Spec AS Proto6, Spec AS Proto7, Spec AS Proto8, Spec AS Proto9, Spec AS Proto10, Spec AS Proto11, Spec AS Proto12, 
			Spec AS Proto13, Spec AS Proto19, Spec AS Proto18, Spec AS Proto17, Spec AS Proto16, Spec AS Proto15, Spec AS Proto14, Spec AS Spec, 0 AS Size0, 
			0 AS Size1, 0 AS Size2, 0 AS Size3, 0 AS Size4, 0 AS Size5, 0 AS Size6, 0 AS Size7, 0 AS Size8, 0 AS Size9, 0 AS Size10, 0 AS Size11, 0 AS Size12, 
			0 AS Size13, 0 AS Size14, 0 AS Size15, 0 AS Size16, 0 AS Size17, 0 AS Size18, 0 AS Size19, CDate, CUser, @CreatedDate AS MUser, 
			@CreatedBy AS MDate, Change, Sort, Conv
	FROM  #tempStyleSpec4		
	END	
END











GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[sServiceQueue]'
GO
CREATE TABLE [dbo].[sServiceQueue]
(
[ServiceQueueID] [bigint] NOT NULL IDENTITY(1, 1),
[ServiceQueueSql] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ServiceQueuePriority] [int] NULL,
[ServiceQueueDate] [datetime] NULL CONSTRAINT [DF_sServiceQueue_ServiceQueueDate] DEFAULT (getdate())
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_sServiceQueue] on [dbo].[sServiceQueue]'
GO
ALTER TABLE [dbo].[sServiceQueue] ADD CONSTRAINT [PK_sServiceQueue] PRIMARY KEY CLUSTERED  ([ServiceQueueID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[sServiceQueueRunning]'
GO
CREATE TABLE [dbo].[sServiceQueueRunning]
(
[ServiceQueueID] [bigint] NOT NULL,
[ServiceQueueSql] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ServiceQueuePriority] [int] NULL,
[ServiceQueueRunningDate] [datetime] NULL CONSTRAINT [DF_sServiceQueue_ServiceQueueRunningDate] DEFAULT (getdate()),
[Attempt] [int] NOT NULL CONSTRAINT [DF_sServiceQueueRunning_Tries] DEFAULT ((0))
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_sServiceQueueRunning] on [dbo].[sServiceQueueRunning]'
GO
ALTER TABLE [dbo].[sServiceQueueRunning] ADD CONSTRAINT [PK_sServiceQueueRunning] PRIMARY KEY CLUSTERED  ([ServiceQueueID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_ColorTypeData_SELECT]'
GO


CREATE PROCEDURE  dbo.spx_ColorTypeData_SELECT (
@ColorTypeID INT
)
AS

	SELECT * FROM pColorType WHERE ColorTypeID = @ColorTypeID

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_QuoteFolderItemLog_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_QuoteFolderItemLog_SELECT]
(@QuoteFolderItemID uniqueidentifier,@QuoteFolderID uniqueidentifier,@TeamID uniqueidentifier)
AS SELECT     dbo.pQuoteFolderItemLog.QuoteFolderLogID, dbo.pQuoteFolderItemLog.QuoteFolderTeamID, dbo.pQuoteFolderItemLog.QuoteFolderID, 
                      dbo.pQuoteFolderItemLog.QuoteFolderItemID, dbo.pQuoteFolderItemLog.StyleID, dbo.pQuoteFolderItemLog.TeamID, 
                      dbo.pQuoteFolderItemLog.QuoteFolderItemStatus, dbo.pQuoteFolderItemLog.QuoteMessageTo, dbo.pQuoteFolderItemLog.QuoteMessageLog, 
                      dbo.pQuoteFolderItemLog.CUser, dbo.pQuoteFolderItemLog.CDate, dbo.MessageStatus.MessageStatus, dbo.MessageStatus.MessageStatusDetail, 
                      dbo.MessageStatus.QuotationStatusDetail, dbo.MessageStatus.MessageIcon
FROM         dbo.pQuoteFolderItemLog WITH (NOLOCK) INNER JOIN
                      dbo.MessageStatus WITH (NOLOCK) ON dbo.pQuoteFolderItemLog.QuoteFolderItemStatus = dbo.MessageStatus.MessageStatusID
WHERE     (dbo.pQuoteFolderItemLog.QuoteFolderItemID = @QuoteFolderItemID)
ORDER BY dbo.pQuoteFolderItemLog.CDate DESC



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rpx_MaterialRequestSubmit_SELECT]'
GO

CREATE PROCEDURE [dbo].[rpx_MaterialRequestSubmit_SELECT]
(
	@MaterialRequestSubmitID uniqueidentifier
)
AS 


SELECT pMaterialRequestSubmit.MaterialRequestSubmitID, pMaterialRequestSubmit.MaterialRequestSubmitWorkflowID, 
  pMaterialRequestSubmit.MaterialTradePartnerColorID, pMaterialRequestSubmit.MaterialTradePartnerID, 
  pMaterialRequestSubmit.MaterialRequestSubmitGroupID, pMaterialRequestSubmit.Submit, pMaterialRequestSubmit.AssignedTo, 
  pMaterialRequestSubmit.StartDate, pMaterialRequestSubmit.RecDate, pMaterialRequestSubmit.RecBy, pMaterialRequestSubmit.RecCarrier, 
  pMaterialRequestSubmit.RecTrackNo, pMaterialRequestSubmit.RecWeight, pMaterialRequestSubmit.VendorWeight, 
  pMaterialRequestSubmit.VendorDate, pMaterialRequestSubmit.VendorName, pMaterialRequestSubmit.SubmitDays, 
  pMaterialRequestSubmit.ResubmitDays, pMaterialRequestSubmit.DueDate, pMaterialRequestSubmit.RevDate, pMaterialRequestSubmit.RevBy, 
  pMaterialRequestSubmit.EndDate, pMaterialRequestSubmit.EndBy, pMaterialRequestSubmit.CUser, pMaterialRequestSubmit.CDate, 
  pMaterialRequestSubmit.MUser, pMaterialRequestSubmit.MDate, pMaterialRequestSubmit.TUser, pMaterialRequestSubmit.TDate, 
  pMaterialRequestSubmit.AgentView, pMaterialRequestSubmit.SubmitComment, pMaterialRequestSubmit.VendorComment, 
  pMaterialRequestSubmit.InternalComment, pMaterialRequestSubmitStatus.Status
FROM         pMaterialRequestSubmit INNER JOIN
  pMaterialRequestSubmitStatus ON pMaterialRequestSubmit.Status = pMaterialRequestSubmitStatus.StatusID
WHERE pMaterialRequestSubmit.MaterialRequestSubmitID = @MaterialRequestSubmitID
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialRequestWorkflowTemplateItem_INSERT]'
GO


ALTER PROCEDURE [dbo].[spx_MaterialRequestWorkflowTemplateItem_INSERT]
(
@MaterialRequestWorkflowTempID uniqueidentifier,
@MaterialRequestWorkflowID varchar(5),
@MaterialRequestWorkflowSort varchar(5)
)

AS

IF (SELECT COUNT(*) FROM pMaterialRequestWorkflowTemplateItem WITH (NOLOCK) 
	WHERE MaterialRequestWorkflowTempID = @MaterialRequestWorkflowTempID AND MaterialRequestWorkflowID = @MaterialRequestWorkflowID) = 0 
	BEGIN
   		INSERT INTO pMaterialRequestWorkflowTemplateItem(MaterialRequestWorkflowTempID, MaterialRequestWorkflowID, 
				MaterialRequestWorkflowSort, MaterialRequestWorkflowAlerts, MaterialRequestWorkflowDays, MaterialRequestWorkflowGroupID)
		VALUES (@MaterialRequestWorkflowTempID, @MaterialRequestWorkflowID, @MaterialRequestWorkflowSort, 0, 1, NULL) 
	END
ELSE
	BEGIN
		UPDATE pMaterialRequestWorkflowTemplateItem SET MaterialRequestWorkflowSort = @MaterialRequestWorkflowSort 
		WHERE MaterialRequestWorkflowTempID = @MaterialRequestWorkflowTempID AND MaterialRequestWorkflowID = @MaterialRequestWorkflowID 
	END




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteActivityCalendarAgent_INSERT]'
GO



ALTER PROCEDURE [dbo].[spx_StyleQuoteActivityCalendarAgent_INSERT]
(@Teamid uniqueidentifier,
@TradePartnerId uniqueidentifier,
@CalendarId uniqueidentifier,
@StartDate datetime,
@EndDate datetime)
AS 

BEGIN
INSERT INTO dbo.pStyleCalendarTemp
      (CalendarId, PKeyId, CalendarLinkId, CalendarLinkSubId, CalendarDate, CalendarType, CalendarStatus, CalendarDescription, CalendarView)
SELECT   @CalendarId AS CalendarId,  pStyleQuoteItem.StyleQuoteItemId, pStyleQuoteItem.StyleId, 
    pStyleQuoteItem.styleQuoteId AS CalendarLinkSubId, 
    pStyleQuoteItemActivity.CDate, 'QuoteActivity' AS CalendarType, pStyleQuoteItemActivity.ActivityType, 
    '<b>A: </b>' + dbo.uTradePartner.TradePartnerCode + ' / <b>V: </b>' + dbo.uTradePartnerVendor.VendorCode + '<BR>' + dbo.pStyleHeader.StyleNo + ' (' +
    dbo.pStyleHeader.SizeClass + ') ' + dbo.pStyleHeader.Description AS CalendarDescription, pStyleQuoteItem.AgentView
FROM         pStyleQuoteItem WITH (NOLOCK) INNER JOIN
    dbo.pStyleHeader WITH (NOLOCK) ON pStyleQuoteItem.StyleID = dbo.pStyleHeader.StyleID INNER JOIN
    pStyleQuoteItemActivity WITH (NOLOCK) ON 
    pStyleQuoteItem.StyleQuoteItemId = pStyleQuoteItemActivity.StyleQuoteItemId INNER JOIN
    dbo.uTradePartner WITH (NOLOCK) ON pStyleQuoteItem.TradePartnerId = dbo.uTradePartner.TradePartnerID INNER JOIN
    dbo.uTradePartnerVendor WITH (NOLOCK) ON pStyleQuoteItem.TradePartnerVendorId = dbo.uTradePartnerVendor.TradePartnerVendorID
WHERE     (pStyleQuoteItemActivity.TeamId = @TradePartnerId) 
AND (pStyleQuoteItemActivity.TradePartner = 1)
AND     (pStyleQuoteItemActivity.CDate BETWEEN @StartDate AND @EndDate) 
AND pStyleQuoteItemActivity.ActivityType <> 'V'
AND pStyleHeader.StyleType  in  (  SELECT  StyleTypeId from sAccessQuotationFolder WITH (NOLOCK) where TeamID = @Teamid  AND ( AccessRoleId =  3 OR AccessView = 1) ) 
ORDER BY  dbo.pStyleHeader.StyleNo, pStyleQuoteItemActivity.ActivityType, pStyleQuoteItemActivity.Cdate ASC	
END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_QuoteFolderItemTeam_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_QuoteFolderItemTeam_INSERT]
(
@QuoteFolderID uniqueidentifier,
@StyleID uniqueidentifier,
@TeamID uniqueidentifier,
@TradePartner smallint
)


AS 

DECLARE @QuoteFolderItemID nvarchar(50) 


IF (SELECT COUNT(*)  FROM pQuoteFolderItemTeam WITH (NOLOCK) WHERE StyleID = @StyleID AND TeamID = @TeamID AND QuoteFolderID = @QuoteFolderID)  = 0

	BEGIN
	
	SET @QuoteFolderItemID = (SELECT QuoteFolderItemID FROM pQuoteFolderItem WITH (NOLOCK) WHERE StyleID = @StyleID AND QuoteFolderID = @QuoteFolderID)
	
		INSERT INTO dbo.pQuoteFolderItemTeam
                    	 (QuoteFolderItemID,QuoteFolderID, StyleID, TeamID, TradePartner)
		VALUES     (@QuoteFolderItemID, @QuoteFolderID,  @StyleID, @TeamID, @TradePartner)

	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteItemLogic_UPDATE]'
GO



/*
Comments:

#01 - Ryan Cabanas - July 31, 2009
	Burberry has changed the 'Landed Duty Price' calculation.

#02 - Ryan Cabanas - July 31, 2009
	Burberry has changed the 'Act Flow Through Margin' calculation.

#03 - Ryan Cabanas - July 31, 2009
	Burberry has changed the 'Retail Price GBP' calculation.

#04 - Ryan Cabanas - July 31, 2009
	Burberry has added a new 'Target Ex-Factory Local' calculation.

#05 - Ryan Cabanas - August 17, 2009
	Burberry wants to change the logic of where to pull Currency Type.
If the Agent is of Partner Type "Vendor", pull the Currency type from
'uTradePartner.CurrencyType'.  If the Agent is of Partner Type "Agent", pull the
Currency type from 'uTradePartnerVendor.CurrencyType'.

#06 - Ryan Cabanas - August 17, 2009
	Burberry wants to change the whole update logic of 'Currency', 'Agent Commission %',
'Freight Rate %', and 'Duty %'.

#07 - Ryan Cabanas - August 17, 2009
	Since Burberry changed a calculation, I need to check for another "divide by zero" case.

#08 - Ryan Cabanas - August 17, 2009
	Burberry wants to auto-populate the "Vendor Target Margin" field.  It's
'pStyleQuoteItem.StyleQuoteItemCustomField24'.

#09 - Ryan Cabanas - August 19, 2009
	Burberry has changed their mind about the 'UK Wholesale' field.  They now want this field,
which is 'pStyleQuoteItem.StyleQuoteItemCustomField26', to be pulled from the costing header
area and now longer updated here.  Commenting out the update here.

#10 - Ryan Cabanas - August 19, 2009
	Burberry also wants the 'UK Wholesale' field value to pull from the costing header area
when you click the "Save" button here at the quote page.  Need to make a variable to grab
the value and then update it to the quote area.

#11 - Ryan Cabanas - August 21, 2009
	Burberry has changed calculations again.  These changes actually occurred on, or prior,
to July 31, 2009 because the calculations that were in this procedure before July 31, 2009
no longer matched the calculations given to us in the Excel Spreadsheet on July 31, 2009.
	Need to make a variable for field "StyleQuoteItemCustomField26" for easier reading and
use.

#12 - Ryan Cabanas - August 21, 2009
	The calc for "Act Wholesale Margin" has changed.

#13 - Ryan Cabanas - August 21, 2009
	The variable used to hold the results for the "Act Wholesale Margin" was set to decimal(18, 3),
but should be decimal(18,4) because it's a percentage.  Needed to change this in the table field
settings too.

#14 - Clayton Parker - August 25, 2009
	Burberry would like the Wholesale Target Margin(pStyleQuoteItem.StyleQuoteItemCustomField25)
in the quote to pull from the style costings Wholesale Margin at the costing header
(pStyleCostingHeader.StyleCostingCustomField5).

#15 - Ryan Cabanas - September 1, 2009
	Need to fix a couple of 'divide by zero' errors.

#16 - Ryan Cabanas - September 3, 2009
	The 'Freight Rate %' and 'Duty%' need to pull from either 'uTradePartner' or 'uTradePartnerVendor',
based on if the Agent is of Partner Type "Agent", or "Vendor".  Same logic as Comment #05 above.
Added CASE to do this.

#17 - Ryan Cabanas - September 8, 2009
	Burberry wants the 'Target Ex-Factory Local' equation changed again.  The "IF" condition that was
added for this equation in Comment #15 is no longer needed, but the Comment #15 notation will be left
behind.  Commenting out the original equation/work that was there.

#18 - Ryan Cabanas - September 23, 2009
	Do 'divide by zero' error checking for all division calculations.

#19 - Ryan Cabanas - October 8, 2009
	For some reason, the '@TargetRetailFOB' variable was being used in the IF statement, but it's not
being used in the calculation, so I'm commenting out this variable because it shouldn't be included
in the IF.

#20 - Ryan Cabanas - October 8, 2009
	Burberry wants the 'Target Ex Factory Local' calculation changed.  Commented out the old
calculation.

#21 - Artemio Gomez - October 20, 2009
	Another divide by zero error that needed to be handled.

#22 - Ryan Cabanas - October 21, 2009
	Update procedure to pull costing values from the correct seasonal costing header record.
*/


ALTER PROCEDURE [dbo].[spx_StyleQuoteItemLogic_UPDATE]
(
	@StyleQuoteItemID uniqueidentifier,
	@StyleID uniqueidentifier = NULL, 
	@LinePlanID uniqueidentifier = NULL, 
	@LinePlanRangeID uniqueidentifier = NULL, 
	@LinePlanAttributeItemID1 uniqueidentifier = NULL, 
	@LinePlanAttributeItemID2 uniqueidentifier= NULL, 
	@LinePlanAttributeItemID3 uniqueidentifier= NULL, 
	@LinePlanAttributeItemID4 uniqueidentifier = NULL
)
AS 



--/**************/
--/*Testing.	*/
--/**************/
--DECLARE @StyleQuoteItemID uniqueidentifier
--DECLARE @StyleID uniqueidentifier
--DECLARE @LinePlanID uniqueidentifier
--DECLARE @LinePlanRangeID uniqueidentifier
--DECLARE @LinePlanAttributeItemID1 uniqueidentifier
--DECLARE @LinePlanAttributeItemID2 uniqueidentifier
--DECLARE @LinePlanAttributeItemID3 uniqueidentifier
--DECLARE @LinePlanAttributeItemID4 uniqueidentifier
--
--SET @StyleQuoteItemID = '66EFDC57-6D24-43E9-8B69-47F9094B31A3'
--SET @StyleID = '0C14ABB5-770B-41A7-BF76-D1539C375B38'
--SET @LinePlanID = 'CAF55604-5505-46F6-B499-91B6B7842212'
--SET @LinePlanRangeID = '523B3844-BECB-4B86-99B7-795A5451341F'
--SET @LinePlanAttributeItemID1 = '285A8A56-BE1C-4FE4-A38D-1C84547A1526'
--SET @LinePlanAttributeItemID2 = '5378A0FD-F52B-4489-BF13-DE39C290F583'
--SET @LinePlanAttributeItemID3 = 'F1F9C1AB-FF4D-4CE4-9707-836456D888F5'
--SET @LinePlanAttributeItemID4 = NULL



--DECLARE @StyleQuoteItemID uniqueidentifier
--SET @StyleQuoteItemID = '213f3bdd-ac6c-42f6-960c-67075a36d003'

/***********************************************
New statements added by Ryan Cabanas on 8/26/08.
************************************************/

/*****Update 'Auto Pull' values.*****/

/*Variables.*/
DECLARE @StyleSet int
DECLARE @StyleSourcingID uniqueidentifier
DECLARE @StyleColorID uniqueidentifier
DECLARE @StyleQuoteItemCustomField6 nvarchar(200)		--Currenty Type
DECLARE @StyleQuoteItemCustomField7_Rate decimal(18,3)	--Exhange Rate template (Value), not uniqieidentifier
DECLARE @StyleQuoteItemCustomField8	money				--Vendor Quote
DECLARE @StyleQuoteItemCustomField9 money				--Vendor Quote in GBP
DECLARE @StyleQuoteItemCustomField10 money				--BOM Rollup Price
DECLARE @StyleQuoteItemCustomField11 decimal(18,4)		--Agent Commission %
DECLARE @StyleQuoteItemCustomField12 decimal(18,4)		--Freight Rate %
DECLARE @StyleQuoteItemCustomField13 decimal(18,4)		--Duty %
--DECLARE @StyleQuoteItemCustomField14 decimal(18,4)		--Target FirstCost
DECLARE @StyleQuoteItemCustomField14 decimal(18,4)		--Average Target FOB GBP
DECLARE @StyleQuoteItemCustomField15 money				--Landed Duty Price
DECLARE @StyleQuoteItemCustomField16 decimal(18,4)		--Margin Markup
DECLARE @StyleQuoteItemCustomField17 money				--Retail Price GBP
DECLARE @StyleQuoteItemCustomField18 money				--Retail Price USD
DECLARE @StyleQuoteItemCustomField19 money				--Retail Price HKD
DECLARE @StyleQuoteItemCustomField20 money				--Retail Price EUR
DECLARE @StyleQuoteItemCustomField27 money				--Retail Price GBP USER
DECLARE @StyleQuoteItemCustomField28 money				--Retail Price USD USER
DECLARE @StyleQuoteItemCustomField29 money				--Retail Price HKD USER
DECLARE @StyleQuoteItemCustomField30 money				--Retail Price EUR USER
DECLARE @ExchangeRate_USD decimal(18,3)					--USD Exchange Rate
DECLARE @ExchangeRate_HKD decimal(18,3)					--HKD Exchange Rate
DECLARE @ExchangeRate_EUR decimal(18,3)					--EUR Exchange Rate

--DECLARE @StyleID UNIQUEIDENTIFIER
--DECLARE @LinePlanID UNIQUEIDENTIFIER
--DECLARE @LinePlanItemID UNIQUEIDENTIFIER
--DECLARE @StyleCategoryId UNIQUEIDENTIFIER

DECLARE @AverageTargetFOB DECIMAL(18,3)
DECLARE @InitialGrossMarginWHS DECIMAL(18,3)
DECLARE @TargetRetailFOB DECIMAL(18,3)
DECLARE @WhsPriceGBP DECIMAL(18,3)

--Comment #03, 04
DECLARE @StyleQuoteItemCustomField24 decimal(18,4)		--Vendor Margin		--Comment #03
DECLARE @StyleQuoteItemCustomField31 decimal(18,3)		--Target Ex Factory Local	--Comment #04


--Comment #05
DECLARE @TradePartnerID uniqueidentifier
DECLARE @TradePartnerVendorID uniqueidentifier
DECLARE @TradePartnerType int
DECLARE @CurrencyType nvarchar(5)

--Comment #10
DECLARE @StyleCostingCustomField6 decimal(18,3)	--Target Wholesale Price (pStyleCostingHeader.StyleCostingCustomField6)

--Comment #11
DECLARE @StyleQuoteItemCustomField26 decimal(18,3)	--UK Wholesale

--Comment #14
DECLARE @StyleCostingCustomField5 decimal (18,3) --Wholesale Margin

--Comment #22
DECLARE @StyleCostingID uniqueidentifier
DECLARE @StyleSeasonYearID uniqueidentifier



--Comment #05
BEGIN
	--Get the Agent and Vendor IDs.
	SELECT @TradePartnerID = TradePartnerID
		,@TradePartnerVendorID = TradePartnerVendorID
	FROM pStyleQuoteItem
	WHERE StyleQuoteItemID = @StyleQuoteItemID

	--Get 'Partner Type' for Agent.
	SELECT @TradePartnerType = TradePartnerType
	FROM uTradePartner
	WHERE TradePartnerID = @TradePartnerID

	IF(@TradePartnerType = 2)	--"Vendor" Partner Type
		BEGIN
			SELECT @CurrencyType = CurrencyType
			FROM uTradePartner
			WHERE TradePartnerID = @TradePartnerID
		END
	ELSE IF(@TradePartnerType = 1)	--"Agent" Partner Type
		BEGIN
			SELECT @CurrencyType = CurrencyType
			FROM uTradePartnerVendor
			WHERE TradePartnerVendorID = @TradePartnerVendorID
		END
END


--SELECT 
--	@StyleID = StyleID
--FROM pStyleQuoteItem 
--WHERE StyleQuoteItemID = @StyleQuoteItemID

--SELECT 
--	@LinePlanID = LinePlanID, 
--	@LinePlanItemID = LinePlanItemID , 
--	@StyleCategoryID = StyleCategory 
--FROM pStyleHeader 
--WHERE StyleID = @StyleID


SELECT @StyleID = StyleID
	,@StyleCostingID = StyleCostingID		--Comment #22
FROM pStyleQuoteItem
WHERE StyleQuoteItemID = @StyleQuoteItemID


--Comment #22
/*Get the '@StyleSeasonYearID' from 'pStyleCosting'.*/
SELECT @StyleSeasonYearID = StyleSeasonYearID
FROM pStyleCosting
WHERE StyleCostingID = @StyleCostingID


IF @LinePlanID IS NULL
BEGIN

	SELECT @LinePlanRangeID = LinePlanRangeID  FROM pLinePlanItem  WHERE StyleID = @StyleID 

	SELECT @LinePlanID = LinePlanID, 
	@LinePlanAttributeItemID1 = LinePlanAttributeItemID1, @LinePlanAttributeItemID2 = LinePlanAttributeItemID2,
	@LinePlanAttributeItemID3 = LinePlanAttributeItemID3, @LinePlanAttributeItemID4 = LinePlanAttributeItemID4
	from pLineplanrange 
	WHERE LinePlanRangeID = @LinePlanRangeID 
	AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'

END 


IF @LinePlanID IS NOT NULL 
BEGIN 

	-- Average Target FOB
	SELECT @AverageTargetFOB = LinePlanBusPnCh1 FROM pLinePlanBusiness 
	WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
		AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
		AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
		AND (LinePlanID = @LinePlanID) 
		AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000006'
	ORDER BY LinePlanFinancialSort 

	-- Initial Gross Margin WHS %
	SELECT @InitialGrossMarginWHS = LinePlanBusPnCh1 FROM pLinePlanBusiness 
	WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
		AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
		AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
		AND (LinePlanID = @LinePlanID) 
		AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000013'
	ORDER BY LinePlanFinancialSort 

END 



--SELECT @InitialGrossMarginWHS AS InitialGrossMarginWHS


--Retail Price GBP USER -- CDP 3/6/09
SELECT 
@StyleQuoteItemCustomField27 = StyleCostingCustomField1, --Retail Price GBP User
@StyleQuoteItemCustomField28 = StyleCostingCustomField7, --Retail Price USD User
@StyleQuoteItemCustomField29 = StyleCostingCustomField8, --Retail Price HKD User
@StyleQuoteItemCustomField30 = StyleCostingCustomField9, --Retail Price EUR User
@StyleCostingCustomField6 = StyleCostingCustomField6,		--Comment #10
@StyleCostingCustomField5 = StyleCostingCustomField5	 --Comment #14
FROM pStyleCostingHeader
WHERE StyleID = @StyleID
	AND StyleSeasonYearID = @StyleSeasonYearID			--Comment #22


--Target Retail FOB
SELECT 
	@TargetRetailFOB = StyleCostingCustomField1
	,@StyleQuoteItemCustomField14 = StyleCostingCustomField2
	,@StyleQuoteItemCustomField16 = StyleCostingCustomField3
FROM pStyleCostingHeader
WHERE StyleID = @StyleID
	AND StyleSeasonYearID = @StyleSeasonYearID			--Comment #22


--SELECT * FROM pStyleCostingHeader WHERE StyleID = @styleID
--SELECT @TargetRetailFOB, @StyleQuoteItemCustomField14, @StyleQuoteItemCustomField16

--SELECT * FROM pLinePlanBusiness 
--WHERE LinePlanID = @LinePlanID AND 
--LinePlanAttributeItemID3 = @StyleCategoryID 
--ORDER BY LinePlanFinancialSort 


--Comment #06 (This whole update has been changed by Comment #06.)
/*Set the 'Agent Commission %', 'Freight Rate %', 'Duty %', and 'Currency'  fields.*/
UPDATE pStyleQuoteItem
SET	pStyleQuoteItem.StyleQuoteItemCustomField11 = pTradePartnerVendorRateItem.Commission
	,pStyleQuoteItem.StyleQuoteItemCustomField12 =
		CASE	--Comment #16
			WHEN	@TradePartnerType = 2	THEN	uTradePartner.Freight		--"Vendor" Partner Type
			ELSE									uTradePartnerVendor.Freight	--"Agent" Partner Type
		END
	,pStyleQuoteItem.StyleQuoteItemCustomField13 =
		CASE	--Comment #16
			WHEN	@TradePartnerType = 2	THEN	uTradePartner.Duty			--"Vendor" Partner Type
			ELSE									uTradePartnerVendor.Duty	--"Agent" Partner Type
		END
	,pStyleQuoteItem.StyleQuoteItemCustomField6 = @CurrencyType		--Comment #05
	,pStyleQuoteItem.StyleQuoteItemCustomField24 = pTradePartnerVendorRateItem.Margin		--Comment #08
FROM pStyleQuoteItem
	LEFT OUTER JOIN pStyleHeader ON	pStyleQuoteItem.StyleID = pStyleHeader.StyleID
	LEFT OUTER JOIN pStyleSourcing ON	pStyleQuoteItem.StyleSourcingID = pStyleSourcing.StyleSourcingID
	LEFT OUTER JOIN pStyleSeasonYear ON	pStyleSourcing.StyleSeasonYearID = pStyleSeasonYear.StyleSeasonYearID
	LEFT OUTER JOIN pTradePartnerVendorRate ON	pStyleSeasonYear.StyleSeason = pTradePartnerVendorRate.Season
												AND pStyleSeasonYear.StyleYear = pTradePartnerVendorRate.[Year]
												AND pStyleQuoteItem.TradePartnerVendorID = pTradePartnerVendorRate.TradePartnerVendorID
	LEFT OUTER JOIN pTradePartnerVendorRateItem ON	pTradePartnerVendorRate.TradePartnerVendorRateID = pTradePartnerVendorRateItem.TradePartnerVendorRateID
													AND pStyleHeader.StyleCategory = pTradePartnerVendorRateItem.StyleCategoryID
	LEFT OUTER JOIN uTradePartner ON	pStyleQuoteItem.TradePartnerID = uTradePartner.TradePartnerID
	LEFT OUTER JOIN uTradePartnerVendor	ON	pStyleQuoteItem.TradePartnerVendorID = uTradePartnerVendor.TradePartnerVendorID	--Comment #16
WHERE pStyleQuoteItem.StyleQuoteItemID = @StyleQuoteItemID


/*Set the 'BOM Rollup Price'.*/
BEGIN
	/*Get the necessary IDs to call another procedure that calculates the BOM Rollup.*/
	SELECT TOP 1
		@StyleSet = pStyleSourcingItem.StyleSet
		,@StyleSourcingID = pStyleQuoteItem.StyleSourcingID
		,@StyleColorID = pStyleQuoteItem.StyleColorID
	FROM pStyleQuoteItem
		LEFT OUTER JOIN pStyleSourcingItem ON	pStyleQuoteItem.StyleSourcingID = pStyleSourcingItem.StyleSourcingID
	WHERE pStyleQuoteItem.StyleQuoteItemID = @StyleQuoteItemID

	/*Get the total of the materials and their quantity times price.*/
	--EXEC spx_StyleSourcingRollUp_SELECT @StyleSourcingID, @StyleColorID, @StyleSet, @StyleQuoteItemCustomField10 OUTPUT

	SELECT @StyleQuoteItemCustomField10 = SUM (Qty * MaterialPrice )
	FROM pStyleSourcingItem 
	where StyleSourcingId = @StyleSourcingID
	AND StylecolorID = @StylecolorID
	AND StyleSet = 1 
	AND BOM = 1

	IF @StyleQuoteItemCustomField10 IS NULL 
		SET @StyleQuoteItemCustomField10 = 0 

	/*Update the 'pStyleQuoteItem' table with the caculated BOM Rollup value.*/
	UPDATE pStyleQuoteItem
	SET StyleQuoteItemCustomField10 = @StyleQuoteItemCustomField10
	WHERE StyleQuoteItemID = @StyleQuoteItemID
END


/*Set the 'Target First Cost' and 'Margin Markup' from the Costing Header section.*/
-- pStyleQuoteItem.StyleQuoteItemCustomField14 = StyleQuoteItemCustomField14
UPDATE pStyleQuoteItem
SET pStyleQuoteItem.StyleQuoteItemCustomField14 =  @StyleQuoteItemCustomField14 --@AverageTargetFOB
	,pStyleQuoteItem.StyleQuoteItemCustomField16 = @StyleQuoteItemCustomField16 
	,pStyleQuoteItem.StyleQuoteItemCustomField27 = @StyleQuoteItemCustomField27 --CDP 3/6/09
	,pStyleQuoteItem.StyleQuoteItemCustomField28 = @StyleQuoteItemCustomField28 --CDP 3/6/09
	,pStyleQuoteItem.StyleQuoteItemCustomField29 = @StyleQuoteItemCustomField29 --CDP 3/6/09
	,pStyleQuoteItem.StyleQuoteItemCustomField30 = @StyleQuoteItemCustomField30 --CDP 3/6/09
FROM pStyleQuoteItem
WHERE pStyleQuoteItem.StyleQuoteItemID = @StyleQuoteItemID


/*****Begin formula calculations.*****/

/*Get some values for calculations.*/
SELECT
	@StyleQuoteItemCustomField10 = StyleQuoteItemCustomField10		--BOM Rollup Price
	,@StyleQuoteItemCustomField11 = StyleQuoteItemCustomField11		--Agent Commission %
	,@StyleQuoteItemCustomField12 = StyleQuoteItemCustomField12		--Freight Rate %
	,@StyleQuoteItemCustomField13 = StyleQuoteItemCustomField13		--Duty %
	,@StyleQuoteItemCustomField16 = StyleQuoteItemCustomField16		--Margin Markup
	,@StyleQuoteItemCustomField24 = StyleQuoteItemCustomField24		--Vendor Margin		--Comment #03
FROM pStyleQuoteItem
WHERE StyleQuoteItemID = @StyleQuoteItemID


/*Calculate the 'Vendor Quote in GBP' value.*/
BEGIN
	/*Get the 'Currency Type' and 'Vendor Quote' values.*/
	SELECT
		@StyleQuoteItemCustomField6 = StyleQuoteItemCustomField6	--Currenty Type
		,@StyleQuoteItemCustomField8 = StyleQuoteItemCustomField8	--Vendor Quote
	FROM pStyleQuoteItem
	WHERE StyleQuoteItemID = @StyleQuoteItemID

	/*Get the 'Exchange Rate' value.*/
	SELECT @StyleQuoteItemCustomField7_Rate = sExchangeRateItem.Rate
	FROM pStyleQuoteItem
		LEFT OUTER JOIN sExchangeRateItem ON	pStyleQuoteItem.StyleQuoteItemCustomField7 = sExchangeRateItem.ExchangeRateID
	WHERE pStyleQuoteItem.StyleQuoteItemID = @StyleQuoteItemID
		AND sExchangeRateItem.CurrencyType = @StyleQuoteItemCustomField6

	--Comment #18
	/*Calculate the 'Vendor Quote in GBP'.*/
	IF(@StyleQuoteItemCustomField7_Rate IS NOT NULL AND @StyleQuoteItemCustomField7_Rate > 0)
		BEGIN
			SET @StyleQuoteItemCustomField9 = @StyleQuoteItemCustomField8 / @StyleQuoteItemCustomField7_Rate
		END
	ELSE
		BEGIN
			SET @StyleQuoteItemCustomField9 = 0
		END
END


--Comment #01
/*Calculate the 'Landed Duty Price' field.*/
SET @StyleQuoteItemCustomField15 =
	@StyleQuoteItemCustomField9 +
	(@StyleQuoteItemCustomField9 * @StyleQuoteItemCustomField11) +
	(@StyleQuoteItemCustomField9 * @StyleQuoteItemCustomField12) +
	(@StyleQuoteItemCustomField9 * @StyleQuoteItemCustomField13)


--Comment #03, #18
/*Calculate the 'Retail Price GBP' field.*/
IF(@StyleQuoteItemCustomField16 IS NOT NULL AND @StyleQuoteItemCustomField16 < 1)
	BEGIN
		SET	@StyleQuoteItemCustomField17 = @StyleQuoteItemCustomField15	/ (1 - @StyleQuoteItemCustomField16)	--Comment #03
	END
ELSE
	BEGIN
		SET	@StyleQuoteItemCustomField17 = 0
	END


/*Calculate the 'Retail Price' for the three other currency types: 'USD', 'HKD', and 'EUR'.*/
BEGIN
	/*Get the exchange rate for the 'USD'.*/
	SELECT @ExchangeRate_USD = sExchangeRateItem.Rate
	FROM pStyleQuoteItem
		LEFT OUTER JOIN sExchangeRateItem ON	pStyleQuoteItem.StyleQuoteItemCustomField7 = sExchangeRateItem.ExchangeRateID
	WHERE pStyleQuoteItem.StyleQuoteItemID = @StyleQuoteItemID
		AND sExchangeRateItem.CurrencyType = 'USD'

	/*Get the exchange rate for the 'HKD'.*/
	SELECT @ExchangeRate_HKD = sExchangeRateItem.Rate
	FROM pStyleQuoteItem
		LEFT OUTER JOIN sExchangeRateItem ON	pStyleQuoteItem.StyleQuoteItemCustomField7 = sExchangeRateItem.ExchangeRateID
	WHERE pStyleQuoteItem.StyleQuoteItemID = @StyleQuoteItemID
		AND sExchangeRateItem.CurrencyType = 'HKD'

	/*Get the exchange rate for the 'EUR'.*/
	SELECT @ExchangeRate_EUR = sExchangeRateItem.Rate
	FROM pStyleQuoteItem
		LEFT OUTER JOIN sExchangeRateItem ON	pStyleQuoteItem.StyleQuoteItemCustomField7 = sExchangeRateItem.ExchangeRateID
	WHERE pStyleQuoteItem.StyleQuoteItemID = @StyleQuoteItemID
		AND sExchangeRateItem.CurrencyType = 'EUR'

	--Comment #18
	/*Calculate 'Retail Prices'.*/
	IF(@StyleQuoteItemCustomField16 IS NOT NULL AND @StyleQuoteItemCustomField16 < 1)
		BEGIN
			SET @StyleQuoteItemCustomField18 = (@StyleQuoteItemCustomField15 * @ExchangeRate_USD) / (1 - @StyleQuoteItemCustomField16)	--USD
			SET @StyleQuoteItemCustomField19 = (@StyleQuoteItemCustomField15 * @ExchangeRate_HKD) / (1 - @StyleQuoteItemCustomField16)	--HKD
			SET @StyleQuoteItemCustomField20 = (@StyleQuoteItemCustomField15 * @ExchangeRate_EUR) / (1 - @StyleQuoteItemCustomField16)	--EUR
		END
	ELSE
		BEGIN
			SET @StyleQuoteItemCustomField18 = 0
			SET @StyleQuoteItemCustomField19 = 0
			SET @StyleQuoteItemCustomField20 = 0
		END
END


--Comment #18
/*Update the calculated values back to the 'pStyleQuoteItem' table.*/
IF(@InitialGrossMarginWHS IS NOT NULL AND @InitialGrossMarginWHS < 1)
	BEGIN
		SET @WhsPriceGBP = @StyleQuoteItemCustomField15/(1-@InitialGrossMarginWHS)
	END
ELSE
	BEGIN
		SET @WhsPriceGBP = 0
	END


DECLARE @VAL1 DECIMAL(18,3)
DECLARE @VAL2 DECIMAL(18,4)	--Comment #13


--Comment #11
SET @StyleQuoteItemCustomField26 = @StyleCostingCustomField6	--@StyleQuoteItemCustomField26 is "UK Wholesale".


--Comment #02, #18, #19, #21
IF (/*@TargetRetailFOB > 0  AND*/ @StyleQuoteItemCustomField27 IS NOT NULL 
		AND @StyleQuoteItemCustomField15 IS NOT NULL
		AND @StyleQuoteItemCustomField27 > 0)
	SET @VAL1 = ((@StyleQuoteItemCustomField27 / 1.175) - @StyleQuoteItemCustomField15) / (@StyleQuoteItemCustomField27 / 1.175)	--Comment #02
ELSE 
	SET @VAL1 = 0


--Comment #12, #18
IF (@StyleQuoteItemCustomField26 > 0  AND @StyleQuoteItemCustomField26 IS NOT NULL)
	SET  @VAL2 = (@StyleQuoteItemCustomField26-@StyleQuoteItemCustomField15)/@StyleQuoteItemCustomField26
ELSE 
	SET  @VAL2 = 0 


----Comment #04, #11, #17
--/*Calculate Target Ex-Factory Local*/
--IF((@StyleQuoteItemCustomField8 > 0) AND (@StyleQuoteItemCustomField11 > 0 OR @StyleQuoteItemCustomField12 > 0 OR @StyleQuoteItemCustomField13 > 0))	--Comment #15
--	BEGIN
--		SET @StyleQuoteItemCustomField31 =	((@StyleQuoteItemCustomField26 * (1 - @StyleQuoteItemCustomField24)) * @StyleQuoteItemCustomField7_Rate) /
--											((@StyleQuoteItemCustomField8 * @StyleQuoteItemCustomField11) +
--											(@StyleQuoteItemCustomField8 * @StyleQuoteItemCustomField12) +
--											(@StyleQuoteItemCustomField8 * @StyleQuoteItemCustomField13))
--	END
--ELSE
--	BEGIN
--		SET @StyleQuoteItemCustomField31 = 0
--	END


--Comment #17, #18
/*Calculate Target Ex-Factory Local*/
IF(@StyleQuoteItemCustomField11 IS NOT NULL 
	AND @StyleQuoteItemCustomField12 IS NOT NULL
	AND @StyleQuoteItemCustomField13 IS NOT NULL)
	BEGIN
		--Comment #20 (old calculation - new calculation is below)
		--SET @StyleQuoteItemCustomField31 =	((@StyleQuoteItemCustomField26 * (1 - @StyleQuoteItemCustomField24)) * @StyleQuoteItemCustomField7_Rate) / (1 + @StyleQuoteItemCustomField11 + @StyleQuoteItemCustomField12 + @StyleQuoteItemCustomField13)

		--Comment #20
		SET @StyleQuoteItemCustomField31 =	((((@StyleQuoteItemCustomField26 * (1 - @StyleQuoteItemCustomField24)) * @StyleQuoteItemCustomField7_Rate) / (1 + @StyleQuoteItemCustomField12)) / (1 + @StyleQuoteItemCustomField13)) / (1 + @StyleQuoteItemCustomField11)
	END
ELSE
	BEGIN
		SET @StyleQuoteItemCustomField31 = 0
	END


/*Update quote.*/
UPDATE pStyleQuoteItem
SET	StyleQuoteItemCustomField9 = @StyleQuoteItemCustomField9
	,StyleQuoteItemCustomField15 = @StyleQuoteItemCustomField15
	,StyleQuoteItemCustomField17 = @StyleQuoteItemCustomField17
	,StyleQuoteItemCustomField18 = @StyleQuoteItemCustomField18
	,StyleQuoteItemCustomField19 = @StyleQuoteItemCustomField19
	,StyleQuoteItemCustomField20 = @StyleQuoteItemCustomField20
	,StyleQuoteItemCustomField21 = @TargetRetailFOB
	,StyleQuoteItemCustomField22 = @VAL1
	,StyleQuoteItemCustomField25 = @StyleCostingCustomField5	--Comment #14
	,StyleQuoteItemCustomField26 = @StyleCostingCustomField6		--Comment #09, #10
	,StyleQuoteItemCustomField23 = @VAL2
	,StyleQuoteItemCustomField31 = @StyleQuoteItemCustomField31		--Target Ex-Factory Local	--Comment #04, #11
WHERE StyleQuoteItemID = @StyleQuoteItemID





















/************************************************************
Original statements commented out by Ryan Cabanas on 8/26/08.
*************************************************************/

--DECLARE @StyleId uniqueidentifier
--DECLARE @StyleCostingId uniqueidentifier
--DECLARE @StyleQuoteDutyId uniqueidentifier
--DECLARE @TradePartnerID uniqueidentifier
--DECLARE @TradePartnerVendorID uniqueidentifier
--
--DECLARE @ComissionPerc decimal(19,3) --StyleCostingCustomField9
--DECLARE @GarmentWgt decimal(19,3) --StyleCostingCustomField2
--DECLARE @AvgFirstCost decimal(19,3) --StyleQuoteItemCustomField1
--DECLARE @RetailCost decimal(19,3) --StyleQuoteItemCustomField1
--DECLARE @MiscCost  decimal(19,3) --StyleCostingCustomField4  
--DECLARE @RoyaltyPerc decimal(19,3) --StyleCostingCustomField8 
--DECLARE @RoyaltyCode int
--DECLARE @VariancePerc decimal(19,3) --StyleCostingCustomField10
--DECLARE @DutyPerc decimal(19,3) --StyleCostingCustomField11
--DECLARE @Surcharge decimal(19,3) --StyleCostingCustomField12
--DECLARE @BrokerHarborFee decimal(19,3) --StyleCostingCustomField13
--DECLARE @CountryCode varchar(50) --StyleQuoteItemCustomField4,
--DECLARE @StateCode varchar(50) --StyleQuoteItemCustomField5,
--DECLARE @StyleCostingType int
--DECLARE @TradePartnerState varchar(2)
--DECLARE @NumberOfUnit decimal(19,3)
--DECLARE @FreightMethod decimal(19,3)
--
--DECLARE @CartonHeight decimal(19,3) --StyleQuoteItemCustomField14
--DECLARE @CartonLeght decimal(19,3) --StyleQuoteItemCustomField15 
--DECLARE @CartonWidth decimal(19,3) --StyleQuoteItemCustomField16
--DECLARE @UnitPerCarton decimal(19,3) --StyleQuoteItemCustomField17
--DECLARE @VolCubicFeet decimal(19,3) --StyleQuoteItemCustomField18
--DECLARE @ContainerSize varchar(10) --StyleQuoteItemCustomField12
--
--DECLARE @HomeCost varchar(10)
--
----Preference Table
--DECLARE @PrefImportVariance decimal(19,3)
--DECLARE @PrefDomesticVariance decimal(19,3)
--DECLARE @PrefIndirectVariance decimal(19,3)
--
--SELECT @PrefImportVariance = ImportVariance, @PrefDomesticVariance = DomesticVariance, @PrefIndirectVariance = IndirectVariance FROM pStyleCostingPreference
--
--DECLARE @StyleQuoteItemShare  INT 
--
--SELECT 
--	@StyleId = ISNULL(StyleId,'{00000000-0000-0000-0000-000000000000}'), 
--	@StyleQuoteDutyId = ISNULL(StyleQuotaDutyId,'{00000000-0000-0000-0000-000000000000}'),
--	@TradePartnerID = ISNULL(TradePartnerID,'{00000000-0000-0000-0000-000000000000}'), 
--	@TradePartnerVendorID = ISNULL(TradePartnerVendorID,'{00000000-0000-0000-0000-000000000000}'),  
--	@StyleCostingType = ISNULL(StyleCostingType,0),
--	@AvgFirstCost = ISNULL(StyleQuoteItemCustomField1,0),
--	@RetailCost = ISNULL(StyleCostingCustomField1,0),
--	@RoyaltyCode = ISNULL(StyleQuoteItemCustomField3,0),
--	@CountryCode = ISNULL(StyleQuoteItemCustomField4,''),
--	@StateCode = StyleQuoteItemCustomField5,
--	@MiscCost = ISNULL(StyleCostingCustomField4,0),
--	@RoyaltyPerc = ISNULL(StyleCostingCustomField8,0),
--	@ComissionPerc = ISNULL(StyleCostingCustomField9,0),
--	@VariancePerc = ISNULL(StyleCostingCustomField10,0),
--	@DutyPerc = ISNULL(StyleCostingCustomField11,0),
--	@Surcharge = ISNULL(StyleCostingCustomField12,0),
--	@GarmentWgt = ISNULL(StyleCostingCustomField2,0),
--	@BrokerHarborFee = ISNULL(StyleCostingCustomField13,0),
--	@NumberOfUnit = ISNULL(StyleCostingCustomField18,0),
--	@FreightMethod = StyleCostingCustomField16 ,
--	@StyleQuoteItemShare	= StyleQuoteItemShare
--FROM  pStyleQuoteItem
--WHERE  (StyleQuoteItemID = @StyleQuoteItemID)
--
--
--/*********************************************************************************************************************************************************************************
--IF StyleQuoteItemShare = 1  check if the style is shared with the TradePartner 
--*/ 
--
--
--IF @StyleQuoteItemShare = 1  AND @TradePartnerID  IS NOT NULL
--BEGIN 
--	DECLARE  @StyleDevelopmentID  UNIQUEIDENTIFIER
-- 	SELECT  @StyleDevelopmentID   = DevelopmentID   FROM pStyleHeader WHERE StyleID = @StyleId
--
--	IF ( SELECT COUNT(*)  FROM pStyleTeam WHERE StyleID = @StyleId AND TeamID = @TradePartnerID  )  =  0
--	BEGIN 
--		INSERT INTO pStyleTeam ( StyleTeamID ,  TeamID , StyleDevelopmentId, StyleID ,  TradePartner  ) 
--		VALUES ( NEWID(),   @TradePartnerID ,  @StyleDevelopmentID ,   @StyleId , 1 ) 
--	END 
--
--END 
--
--
--/********************************************************************************************************************************************************************************/
--
--
--
--SELECT * FROM  pStyleQuoteItem WHERE (StyleQuoteItemID = @StyleQuoteItemID)
--
--DECLARE @TradePartnerClass varchar(50)
--DECLARE @TradePartnerCommission decimal(19,3) --StyleCostingCustomField9
--DECLARE @TradePartnerVendorCountry varchar(50)
--
--SELECT @TradePartnerClass = TradePartnerClass, @TradePartnerCommission = TradePartnerCommision, @TradePartnerState = State FROM uTradePartner WHERE TradePartnerID = @TradePartnerID
--
--SELECT @TradePartnerVendorCountry = Country 
--FROM uTradePartnerVendor WHERE TradePartnerVendorID = @TradePartnerVendorID
--
--DECLARE @RoyaltyCost int
--DECLARE @Commision decimal(19,3)
--DECLARE @Variance decimal(19,3)
--DECLARE @Duty decimal(19,3) 
--DECLARE @DutySurcharge decimal(19,3)
--DECLARE @BrokerHarbor decimal(19,3)
--DECLARE @ImportCost decimal(19,3)
--DECLARE @DomesticCost decimal(19,3)
--DECLARE @IndirectCost decimal(19,3)
--
----IF @RoyaltyCode = 1 SET @RoyaltyCost = @AvgFirstCost * @RoyaltyPerc
----IF @RoyaltyCode = 2 SET @RoyaltyCost = @RetailCost * @RoyaltyPerc
--
--SET @Commision = @AvgFirstCost *  @ComissionPerc --@TradePartnerCommission
--SET @Variance = @AvgFirstCost * @VariancePerc
--SET @Duty = @AvgFirstCost * @DutyPerc --NOT apllicable for DOMEST AND INDIRECT
--SET @DutySurcharge = @Surcharge * @GarmentWgt --NOT apllicable for DOMEST AND INDIRECT
--SET @BrokerHarbor = @AvgFirstCost * @BrokerHarborFee --NOT apllicable for DOMEST AND INDIRECT
--SET @ImportCost = @AvgFirstCost + @RoyaltyCost + @MiscCost + @Commision + @Variance + @Duty + @DutySurcharge + @BrokerHarbor 
--
--IF @RoyaltyCode = 1
--	BEGIN
--	SET @ImportCost = ((@AvgFirstCost * @RoyaltyPerc)+ @AvgFirstCost) + @MiscCost + @Commision + @Variance + @Duty + @DutySurcharge + @BrokerHarbor 
--	END
--ELSE IF @RoyaltyCode = 2
--	BEGIN
--	SET @ImportCost = ((@RetailCost * @RoyaltyPerc) + @AvgFirstCost) + @MiscCost + @Commision + @Variance + @Duty + @DutySurcharge + @BrokerHarbor 
--	END
--ELSE
--	BEGIN
--	SET @ImportCost = 0
--	END
--
--
--SELECT (@AvgFirstCost + (@RetailCost * @RoyaltyPerc)) AS R
--SELECT @MiscCost + @Commision + @Variance + @Duty + @DutySurcharge + @BrokerHarbor AS F
--SELECT ((@RetailCost * @RoyaltyPerc) + @AvgFirstCost) + @MiscCost + @Commision + @Variance + @Duty + @DutySurcharge + @BrokerHarbor  AS Royal
----Transportation Cost
--DECLARE @AirRate decimal(19,3)
--DECLARE @BoatRate decimal(19,3)
--DECLARE @AirCostperUnit decimal(19,3)
--DECLARE @BoatCostperUnit decimal(19,3)
--DECLARE @Container40 decimal(19,3)
--DECLARE @Container20 decimal(19,3)
--DECLARE @ContainerLCL decimal(19,3)
--DECLARE @ContainerVolumeAir decimal(19,3) 
--
--DECLARE @CostCode varchar(2)
--DECLARE @DomesticRate decimal(19,6)
--DECLARE @DomesticCostperUnit decimal(19,3)
--DECLARE @DomesticTLC decimal(19,3)
--DECLARE @DomesticMargin decimal(19,3)
--
--
--SELECT @AirRate = AirRate, @BoatRate = SeaRate, @Container40 = Container40, @Container20 = Container20, @ContainerLCL = @ContainerLCL, @ContainerVolumeAir = @ContainerVolumeAir   
--FROM uCountry WHERE CountryCode = @CountryCode
--
----IF @FreightMethod IS NULL OR  @FreightMethod = 0
--BEGIN
--	DECLARE @StyleCategoryId uniqueidentifier
--	SELECT @StyleCategoryId = StyleCategory FROM pStyleHeader WHERE StyleID = @StyleID
--	SELECT @FreightMethod = StyleCategoryFreightType FROM pStyleCategory WHERE StyleCategoryId = @StyleCategoryId
--END
--
--DECLARE @StyleFreightAirID uniqueidentifier
--DECLARE @StyleFreightBoatID uniqueidentifier
--DECLARE @StyleFreightDomesticID uniqueidentifier
--DECLARE @StyleFreightIndirectID uniqueidentifier
--
--SELECT @StyleFreightAirID = ISNULL(StyleQuoteFreightID, NEWID()) FROM pStyleQuoteItemFreightCost WHERE StyleQuoteItemID = @StyleQuoteItemID AND FreightMethod = 'Air'
--SELECT @StyleFreightBoatID = ISNULL(StyleQuoteFreightID, NEWID()) FROM pStyleQuoteItemFreightCost WHERE StyleQuoteItemID = @StyleQuoteItemID AND FreightMethod = 'Boat'
--SELECT @StyleFreightDomesticID = ISNULL(StyleQuoteFreightID, NEWID()) FROM pStyleQuoteItemFreightCost WHERE StyleQuoteItemID = @StyleQuoteItemID AND FreightMethod = 'Domestic'
--SELECT @StyleFreightIndirectID = ISNULL(StyleQuoteFreightID, NEWID()) FROM pStyleQuoteItemFreightCost WHERE StyleQuoteItemID = @StyleQuoteItemID AND FreightMethod = 'Indirect'
--
--IF(@StyleFreightAirID IS NULL)
--	BEGIN
--		SET @StyleFreightAirID = NEWID()
--	END
--
--IF(@StyleFreightBoatID IS NULL)
--	BEGIN
--		SET @StyleFreightBoatID = NEWID()
--	END
--
--IF(@StyleFreightDomesticID IS NULL)
--	BEGIN
--		SET @StyleFreightDomesticID = NEWID()
--	END
--
--IF(@StyleFreightIndirectID IS NULL)
--	BEGIN
--		SET @StyleFreightIndirectID = NEWID()
--	END
--
--
--DELETE FROM pStyleQuoteItemFreightCost WHERE StyleQuoteItemID = @StyleQuoteItemID
--
--
--IF @StyleCostingType = '1' OR @StyleCostingType = '2'
--BEGIN
--
----DELETE FROM pStyleQuoteItemFreightCost WHERE StyleQuoteItemID = @StyleQuoteItemID
--
--	--AIR
--	SET @AirCostperUnit = @GarmentWgt * @AirRate
--
--	DECLARE @AirTLC decimal(19,3)
--	SET @AirTLC = @ImportCost + @AirCostperUnit
--
--	SELECT @AirRate AS AirRate, @AirCostperUnit AS AirCost, @AirTLC AS AirTLC, @FreightMethod AS FM
--
--	DECLARE @AirMargin decimal(19,3)
--	IF @RetailCost = 0
--		BEGIN
--		SET @AirMargin = 0
--		END
--	ELSE
--		BEGIN
--		SET @AirMargin = (@RetailCost - @AirTLC) / @RetailCost
--		END
--
--	--Update Air Freight Cost	
--	IF @FreightMethod = 1
--		BEGIN
--
--			BEGIN 
--				INSERT INTO pStyleQuoteItemFreightCost
--					(StyleQuoteFreightID, StyleQuoteItemId, FreightMethod, Margin, TotalLandCost, FreightCost, FreightRate, Sort, FreightCostSelected)
--				VALUES (@StyleFreightAirID, @StyleQuoteItemId, 'Air', @AirMargin, @AirTLC, @AirCostperUnit , @AirRate, 1, 1)
--			END
--
--			UPDATE pStyleQuoteItem SET 
--				StyleQuoteItemCustomField6 = 1,
--				StyleQuoteItemCustomField7 = @AirMargin,	
--				StyleQuoteItemCustomField8 = @AirTLC,		
--				StyleQuoteItemCustomField9 = @AirCostperUnit,		
--				StyleQuoteItemCustomField10 = @AirRate,
--				StyleCostingCustomField16 = @FreightMethod					
--			WHERE StyleQuoteItemID = @StyleQuoteItemID
--		END
--	ELSE
--		BEGIN
--			INSERT INTO pStyleQuoteItemFreightCost
--				(StyleQuoteFreightID, StyleQuoteItemId, FreightMethod, Margin, TotalLandCost, FreightCost, FreightRate, Sort, FreightCostSelected)
--			VALUES (@StyleFreightAirID, @StyleQuoteItemId, 'Air', @AirMargin, @AirTLC, @AirCostperUnit , @AirRate, 2, 0)
--		END
--
--
--
--	--BOAT 
--	SET @BoatCostperUnit = (@GarmentWgt/16) * @BoatRate
--
--	DECLARE @BoatTLC decimal(19,3)
--	SET @BoatTLC = @ImportCost + @BoatCostperUnit
--
--	DECLARE @BoatMargin decimal(19,3)
--	IF @RetailCost = 0
--		BEGIN
--		SET @BoatMargin = 0
--		END
--	ELSE
--		BEGIN
--		SET @BoatMargin = (@RetailCost - @BoatTLC) / @RetailCost
--		END
--
--	SELECT @BoatRate AS BoatRate, @BoatCostperUnit AS BoatCost, @BoatTLC AS BoatTLC, @FreightMethod	AS FM
--
--	
--			
--	--Update Sea Freight Cost	
--	IF @FreightMethod = 2
--		BEGIN
--			INSERT INTO pStyleQuoteItemFreightCost
--				(StyleQuoteFreightID, StyleQuoteItemId, FreightMethod, Margin, TotalLandCost, FreightCost, FreightRate, Sort, FreightCostSelected)
--			VALUES (@StyleFreightBoatID, @StyleQuoteItemId, 'Boat', @BoatMargin, @BoatTLC, @BoatCostperUnit , @BoatRate, 1, 1)
--		
--			UPDATE pStyleQuoteItem SET 
--				StyleQuoteItemCustomField6 = 2,
--				StyleQuoteItemCustomField7 = @BoatMargin,	
--				StyleQuoteItemCustomField8 = @BoatTLC,		
--				StyleQuoteItemCustomField9 = @BoatCostperUnit,		
--				StyleQuoteItemCustomField10 = @BoatRate,
--				StyleCostingCustomField16 = @FreightMethod						
--			WHERE StyleQuoteItemID = @StyleQuoteItemID
--		END
--	ELSE
--		BEGIN
--		
--			INSERT INTO pStyleQuoteItemFreightCost
--				(StyleQuoteFreightID, StyleQuoteItemId, FreightMethod, Margin, TotalLandCost, FreightCost, FreightRate, Sort, FreightCostSelected)
--			VALUES (@StyleFreightBoatID, @StyleQuoteItemId, 'Boat', @BoatMargin, @BoatTLC, @BoatCostperUnit , @BoatRate, 2, 0)
--		
--		END
--
--END
--
----DOMESTIC 
--ELSE IF @StyleCostingType = '3'  --OR @TradePartnerClass = '3'
--BEGIN
--
----DELETE FROM pStyleQuoteItemFreightCost WHERE StyleQuoteItemID = @StyleQuoteItemID
--
--	IF @StateCode = '' SET @StateCode = @TradePartnerState
--
--	SELECT @CostCode = CostCode FROM uState WHERE StateCode = @StateCode	
--	SELECT @DomesticRate = CostRate FROM pStyleCostingDomesticRate WHERE CostCode = @CostCode
--
--	SET @DomesticCost = @AvgFirstCost + @MiscCost + @Variance 
--	SET @DomesticCostperUnit = @GarmentWgt * @DomesticRate 
--
--	
--	SET @DomesticTLC = @DomesticCost + @DomesticCostperUnit
--	
--	
--	IF @RetailCost = 0
--		BEGIN
--		SET @DomesticMargin = 0
--		END
--	ELSE
--		BEGIN
--		SET @DomesticMargin = (@RetailCost - @DomesticTLC) / @RetailCost
--		END	
--
--	INSERT INTO pStyleQuoteItemFreightCost
--		(StyleQuoteFreightID, StyleQuoteItemId, FreightMethod, Margin, TotalLandCost, FreightCost, FreightRate, Sort, FreightCostSelected)
--	VALUES (@StyleFreightDomesticID, @StyleQuoteItemId, 'Domestic', @DomesticMargin, @DomesticTLC, @DomesticCostperUnit , @DomesticRate, 1, 1)
--
--	--Update Domestic Freight Cost	
--	IF @FreightMethod = 3
--	BEGIN
--		UPDATE pStyleQuoteItem SET 
--			StyleQuoteItemCustomField6 = 3,
--			StyleQuoteItemCustomField7 = @DomesticMargin,	
--			StyleQuoteItemCustomField8 = @DomesticTLC,		
--			StyleQuoteItemCustomField9 = @DomesticCostperUnit,		
--			StyleQuoteItemCustomField10 = @DomesticRate					
--		WHERE StyleQuoteItemID = @StyleQuoteItemID
--	END
--
--
--END
--
--
----Indirect
--ELSE IF @StyleCostingType = '4'
--BEGIN
--
----DELETE FROM pStyleQuoteItemFreightCost WHERE StyleQuoteItemID = @StyleQuoteItemID
--
--	SET @DomesticCost = @AvgFirstCost + @MiscCost + @Variance 
--
--	SET @DomesticCostperUnit = @GarmentWgt 
--
--	SET @DomesticTLC = @DomesticCost 
--	
--	IF @RetailCost = 0
--		BEGIN
--		SET @DomesticMargin = 0
--		END
--	ELSE
--		BEGIN
--		SET @DomesticMargin = (@RetailCost - @DomesticTLC) / @RetailCost
--		END	
--
--	INSERT INTO pStyleQuoteItemFreightCost
--		(StyleQuoteFreightID, StyleQuoteItemId, FreightMethod, Margin, TotalLandCost, FreightCost, FreightRate, Sort, FreightCostSelected)
--	VALUES (@StyleFreightIndirectID, @StyleQuoteItemId, 'Indirect', @DomesticMargin, @DomesticTLC, @DomesticCostperUnit , @DomesticRate, 2, 1)
--
--			
--	--Update Indirect Freight Cost	
--	IF @FreightMethod = 4
--	BEGIN
--		UPDATE pStyleQuoteItem SET 
--			StyleQuoteItemCustomField6 = 4,
--			StyleQuoteItemCustomField7 = @DomesticMargin,	
--			StyleQuoteItemCustomField8 = @DomesticTLC,		
--			StyleQuoteItemCustomField9 = @DomesticCostperUnit,		
--			StyleQuoteItemCustomField10 = @DomesticRate					
--		WHERE StyleQuoteItemID = @StyleQuoteItemID
--	END
--
--END










GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_UserLogic_UPDATE]'
GO

ALTER PROCEDURE [dbo].[spx_UserLogic_UPDATE] (
@TeamID uniqueidentifier
)
AS
BEGIN 

	DECLARE @ReadOnly INT

	SELECT @ReadOnly = ReadOnly FROM Users WITH (NOLOCK) WHERE TeamID = @TeamID 
	IF @ReadOnly IS NULL
	BEGIN
		SET @ReadOnly = 0
		UPDATE Users SET ReadOnly = @ReadOnly WHERE TeamID = @TeamID 
	END
		
	IF @ReadOnly =  1
	BEGIN 
		-- IF READONLY = 1  REMOVE USER FROM NO-READONLY GROUPS 
		DELETE FROM uUserGroup 
		WHERE GroupID IN ( 
			SELECT GroupID FROM uGroup WITH (NOLOCK) WHERE (ReadOnly = 0 OR ReadOnly IS NULL)
		) AND TeamID = @TeamID
	END 
	ELSE
	BEGIN
		-- IF READONLY = 0  REMOVE USER FROM READONLY GROUPS 
		DELETE FROM uUserGroup 
		WHERE GroupID IN ( 
			SELECT GroupID FROM uGroup WITH (NOLOCK) WHERE ReadOnly = 1 )
		 AND TeamID = @TeamID
	END 
	

END 



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteActivityCalendarAgentShared_INSERT]'
GO



ALTER PROCEDURE [dbo].[spx_StyleQuoteActivityCalendarAgentShared_INSERT]
(@TradePartnerId varchar(50),
@CalendarId varchar(50),
@StartDate datetime,
@EndDate datetime)
AS 

BEGIN


	INSERT INTO dbo.pStyleCalendarTemp
		(CalendarId, PKeyId, CalendarLinkId, CalendarLinkSubId, CalendarDate, CalendarType, CalendarStatus, CalendarDescription, CalendarView)
	SELECT   @CalendarId AS CalendarId,  pStyleQuoteItem.StyleQuoteItemId, pStyleQuoteItem.StyleId, 
		pStyleQuoteItem.styleQuoteId AS CalendarLinkSubId, 
		pStyleQuoteItemActivity.CDate, 'QuoteActivity' AS CalendarType, pStyleQuoteItemActivity.ActivityType, 
		'<b>A: </b>' + dbo.uTradePartner.TradePartnerCode + ' / <b>V: </b>' + dbo.uTradePartnerVendor.VendorCode + '<BR>' + dbo.pStyleHeader.StyleNo + ' (' +
		dbo.pStyleHeader.SizeClass + ') ' + dbo.pStyleHeader.Description AS CalendarDescription, pStyleQuoteItem.AgentView
	FROM         pStyleQuoteItem WITH (NOLOCK) INNER JOIN
		dbo.pStyleHeader WITH (NOLOCK) ON pStyleQuoteItem.StyleID = dbo.pStyleHeader.StyleID INNER JOIN
		pStyleQuoteItemActivity WITH (NOLOCK) ON 
		pStyleQuoteItem.StyleQuoteItemId = pStyleQuoteItemActivity.StyleQuoteItemId INNER JOIN
		dbo.uTradePartner WITH (NOLOCK) ON pStyleQuoteItem.TradePartnerId = dbo.uTradePartner.TradePartnerID INNER JOIN
		dbo.uTradePartnerVendor WITH (NOLOCK) ON pStyleQuoteItem.TradePartnerVendorId = dbo.uTradePartnerVendor.TradePartnerVendorID
	WHERE     (uTradePartner.TradePartnerId = @TradePartnerId) 
	AND (pStyleQuoteItemActivity.TradePartner = 0)
	AND     (pStyleQuoteItemActivity.CDate BETWEEN @StartDate AND @EndDate) 
	AND pStyleQuoteItemActivity.ActivityType NOT IN ('V','A') AND (pStyleQuoteItem.StyleQuoteItemShare = 1)
	ORDER BY  dbo.pStyleHeader.StyleNo, pStyleQuoteItemActivity.ActivityType, pStyleQuoteItemActivity.Cdate ASC	


END 






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Session_LoginData]'
GO


ALTER PROCEDURE [dbo].[spx_Session_LoginData] ( 
	@UserName  nvarchar  (25) ,  @Password nvarchar (25) 

)
as 

	DECLARE @TeamID as uniqueidentifier 

	 SELECT   @TeamID = TeamID 
	 FROM  Users  a WITH (NOLOCK) , eMailAccounts b WITH (NOLOCK)  WHERE a.UserName = @UserName AND a.Password = @Password  AND a.Email  = b.FromAddress


	IF  (  @TeamID is not null ) 
	BEGIN
		update Users set SessionDate = getdate()
		where TeamID = @TeamID 

		SELECT  a.*, b.MailAccountID , c.StartHour, c.EndHour 
		FROM  Users  a WITH (NOLOCK) , eMailAccounts b WITH (NOLOCK) , cCalendarTemplate  c WITH (NOLOCK)
	             WHERE a.TeamID = @TeamID  and a.Email  = b.FromAddress
		and c.TemplateID = a.CalendarTemplateID 


	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_QuoteFolderItemTeam_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_QuoteFolderItemTeam_SELECT]
(
@QuoteFolderID uniqueidentifier = '00000000-0000-0000-0000-000000000000',
@QuoteFolderItemID uniqueidentifier = '00000000-0000-0000-0000-000000000000',
@QuoteFolderTeamID uniqueidentifier = '00000000-0000-0000-0000-000000000000',
@TeamID uniqueidentifier = '00000000-0000-0000-0000-000000000000'
)
AS 

IF (@QuoteFolderItemID <> '00000000-0000-0000-0000-000000000000')

	BEGIN

		SELECT     dbo.Users.UserId, dbo.Users.FirstName, dbo.Users.MiddleName, dbo.Users.LastName, dbo.Users.Company, dbo.Users.City, dbo.Users.State, 
                     	 dbo.Users.Country, dbo.pQuoteFolderItemTeam.QuoteFolderTeamID, dbo.pQuoteFolderItemTeam.QuoteFolderID, 
                     	 dbo.pQuoteFolderItemTeam.QuoteFolderItemID, dbo.pQuoteFolderItemTeam.StyleID, dbo.pQuoteFolderItemTeam.TeamID, 
                     	 dbo.pQuoteFolderItemTeam.TradePartner, dbo.pQuoteFolderItemTeam.EstimatedCostType, dbo.pQuoteFolderItemTeam.EstimatedCost, 
                      	dbo.pQuoteFolderItemTeam.EstimatedCostCur, dbo.pQuoteFolderItemTeam.VendorCostType, dbo.pQuoteFolderItemTeam.VendorCost, 
                      	dbo.pQuoteFolderItemTeam.VendorCostCur, dbo.pQuoteFolderItemTeam.FinalCostType, dbo.pQuoteFolderItemTeam.FinalCost, 
                      	dbo.pQuoteFolderItemTeam.FinalCostCur, dbo.pQuoteFolderItemTeam.QuoteFolderItemStatus
		FROM         dbo.Users WITH (NOLOCK) INNER JOIN
                      	dbo.pQuoteFolderItemTeam WITH (NOLOCK) ON dbo.Users.TeamID = dbo.pQuoteFolderItemTeam.TeamID
		WHERE     (dbo.pQuoteFolderItemTeam.QuoteFolderItemID = @QuoteFolderItemID)

	END	


IF (@QuoteFolderTeamID <> '00000000-0000-0000-0000-000000000000')

	BEGIN

		SELECT     dbo.Users.UserId, dbo.Users.FirstName, dbo.Users.MiddleName, dbo.Users.LastName, dbo.Users.Company, dbo.Users.City, dbo.Users.State, 
                     	 dbo.Users.Country, dbo.pQuoteFolderItemTeam.QuoteFolderTeamID, dbo.pQuoteFolderItemTeam.QuoteFolderID, 
                     	 dbo.pQuoteFolderItemTeam.QuoteFolderItemID, dbo.pQuoteFolderItemTeam.StyleID, dbo.pQuoteFolderItemTeam.TeamID, 
                     	 dbo.pQuoteFolderItemTeam.TradePartner, dbo.pQuoteFolderItemTeam.EstimatedCostType, dbo.pQuoteFolderItemTeam.EstimatedCost, 
                      	dbo.pQuoteFolderItemTeam.EstimatedCostCur, dbo.pQuoteFolderItemTeam.VendorCostType, dbo.pQuoteFolderItemTeam.VendorCost, 
                      	dbo.pQuoteFolderItemTeam.VendorCostCur, dbo.pQuoteFolderItemTeam.FinalCostType, dbo.pQuoteFolderItemTeam.FinalCost, 
                      	dbo.pQuoteFolderItemTeam.FinalCostCur, dbo.pQuoteFolderItemTeam.QuoteFolderItemStatus
		FROM         dbo.Users WITH (NOLOCK) INNER JOIN
                      	dbo.pQuoteFolderItemTeam WITH (NOLOCK) ON dbo.Users.TeamID = dbo.pQuoteFolderItemTeam.TeamID
		WHERE     (dbo.pQuoteFolderItemTeam.QuoteFolderTeamID = @QuoteFolderTeamID)

	END	


IF (@QuoteFolderID <> '00000000-0000-0000-0000-000000000000') AND (@TeamID <> '00000000-0000-0000-0000-000000000000')

	BEGIN

		SELECT     dbo.Users.UserId, dbo.Users.FirstName, dbo.Users.MiddleName, dbo.Users.LastName, dbo.Users.Company, dbo.Users.City, dbo.Users.State, 
                     	 dbo.Users.Country, dbo.pQuoteFolderItemTeam.QuoteFolderTeamID, dbo.pQuoteFolderItemTeam.QuoteFolderID, 
                     	 dbo.pQuoteFolderItemTeam.QuoteFolderItemID, dbo.pQuoteFolderItemTeam.StyleID, dbo.pQuoteFolderItemTeam.TeamID, 
                     	 dbo.pQuoteFolderItemTeam.TradePartner, dbo.pQuoteFolderItemTeam.EstimatedCostType, dbo.pQuoteFolderItemTeam.EstimatedCost, 
                      	dbo.pQuoteFolderItemTeam.EstimatedCostCur, dbo.pQuoteFolderItemTeam.VendorCostType, dbo.pQuoteFolderItemTeam.VendorCost, 
                      	dbo.pQuoteFolderItemTeam.VendorCostCur, dbo.pQuoteFolderItemTeam.FinalCostType, dbo.pQuoteFolderItemTeam.FinalCost, 
                      	dbo.pQuoteFolderItemTeam.FinalCostCur, dbo.pQuoteFolderItemTeam.QuoteFolderItemStatus
		FROM         dbo.Users WITH (NOLOCK) INNER JOIN
                      	dbo.pQuoteFolderItemTeam WITH (NOLOCK) ON dbo.Users.TeamID = dbo.pQuoteFolderItemTeam.TeamID
		WHERE     (dbo.pQuoteFolderItemTeam.QuoteFolderID = @QuoteFolderID) AND  (dbo.pQuoteFolderItemTeam.TeamID = @TeamID)  

	END	


IF (@QuoteFolderID <> '00000000-0000-0000-0000-000000000000')

	BEGIN

		SELECT     dbo.Users.UserId, dbo.Users.FirstName, dbo.Users.MiddleName, dbo.Users.LastName, dbo.Users.Company, dbo.Users.City, dbo.Users.State, 
                     	 dbo.Users.Country, dbo.pQuoteFolderItemTeam.QuoteFolderTeamID, dbo.pQuoteFolderItemTeam.QuoteFolderID, 
                     	 dbo.pQuoteFolderItemTeam.QuoteFolderItemID, dbo.pQuoteFolderItemTeam.StyleID, dbo.pQuoteFolderItemTeam.TeamID, 
                     	 dbo.pQuoteFolderItemTeam.TradePartner, dbo.pQuoteFolderItemTeam.EstimatedCostType, dbo.pQuoteFolderItemTeam.EstimatedCost, 
                      	dbo.pQuoteFolderItemTeam.EstimatedCostCur, dbo.pQuoteFolderItemTeam.VendorCostType, dbo.pQuoteFolderItemTeam.VendorCost, 
                      	dbo.pQuoteFolderItemTeam.VendorCostCur, dbo.pQuoteFolderItemTeam.FinalCostType, dbo.pQuoteFolderItemTeam.FinalCost, 
                      	dbo.pQuoteFolderItemTeam.FinalCostCur, dbo.pQuoteFolderItemTeam.QuoteFolderItemStatus
		FROM         dbo.Users WITH (NOLOCK) INNER JOIN
                      	dbo.pQuoteFolderItemTeam WITH (NOLOCK) ON dbo.Users.TeamID = dbo.pQuoteFolderItemTeam.TeamID
		WHERE     (dbo.pQuoteFolderItemTeam.QuoteFolderID = @QuoteFolderID) 

	END	





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcingQuoteItemNew_Logic_UPDATE]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 3, 2009
	The 'Currency' field, which is 'pStyleQuoteItem.StyleQuoteItemCustomField6' has
logic behind it in the procedure 'spx_StyleQuoteItemLogic_UPDATE', but that logic
needs to be added here, as well, so that the 'Currency' field is set properly when the
quote is first generated.
	If the Agent is of Partner Type "Vendor", pull the Currency type from
'uTradePartner.CurrencyType'.  If the Agent is of Partner Type "Agent", pull the
Currency type from 'uTradePartnerVendor.CurrencyType'.
	Going to comment out the other areas that are currently trying to get the 'Currency'
data incorrectly.

#02 - Ryan Cabanas - September 3, 2009
	The 'Freight Rate %' and 'Duty%' need to pull from either 'uTradePartner' or 'uTradePartnerVendor',
based on if the Agent is of Partner Type "Agent", or "Vendor".  Same logic as Comment #01 above.
	Going to comment out the other areas that are currently trying to get the 'Currency'
data incorrectly.
*/


ALTER PROCEDURE [dbo].[spx_StyleSourcingQuoteItemNew_Logic_UPDATE]
(
@StyleQuoteItemID UNIQUEIDENTIFIER,
@MUser NVARCHAR(200) ,
@MDate DATETIME
)
AS


--/************/
--/*Testing.	*/
--/************/
--BEGIN
--	DECLARE @StyleQuoteItemID UNIQUEIDENTIFIER
--	DECLARE @MUser NVARCHAR(200)
--	DECLARE @MDate DATETIME	
--
--	SET @StyleQuoteItemID = 'B5C1F84F-1BA8-4776-BDFC-9A0E69F84F6C'
--	SET @MUser = ''
--	SET @MDate = ''
--END



DECLARE @Custom2 NVARCHAR(50)
DECLARE @TradePartnerVendorID  UNIQUEIDENTIFIER 

DECLARE @CurrencyType NVARCHAR(5)
DECLARE @Freight DECIMAL(18,6)
DECLARE @Duty DECIMAL(18,6)
DECLARE @StyleSourcingID UNIQUEIDENTIFIER 


--Comment #01
DECLARE @TradePartnerID uniqueidentifier
DECLARE @TradePartnerType int


SELECT @Custom2 = Custom2 , @TradePartnerVendorID = a.TradePartnerVendorID,
/*@CurrencyType = CurrencyType, @Freight = Freight, @Duty = Duty,*/ @StyleSourcingID = a.StyleSourcingID	--Comment #01, #02
FROM pStyleQuoteItem a
INNER JOIN uTradePartner c ON a.TradePartnerID = c.TradePartnerID
LEFT OUTER JOIN pStyleSourcing b ON a.StyleSourcingID = b.StyleSourcingID 
WHERE a.StyleQuoteItemID = @StyleQuoteItemID 


IF @Freight is null 
	SET @Freight  = 0 
IF @Duty IS NULL 
	SET @Duty = 0 




DECLARE @StyleSeason NVARCHAR(50)
DECLARE @StyleYear NVARCHAR(50)
DECLARE @StyleID  UNIQUEIDENTIFIER 
DECLARE @StyleCategory UNIQUEIDENTIFIER 
DECLARE @Margin DECIMAL(18,6)
DECLARE @Commission DECIMAL(18,6)

SELECT  @StyleSeason = b.StyleSeason, @StyleYear  = b.StyleYear , 
@StyleID = b.StyleID,  @StyleCategory = StyleCategory
FROM pStyleSourcing a 
INNER JOIN pStyleSeasonYear b ON a.StyleSeasonYearID =  b.StyleSeasonYearID 
INNER JOIN pStyleHeader c ON c.StyleID  = b.StyleID
where a.StyleSourcingID = @StyleSourcingID


IF  @StyleSeason IS NOT NULL AND  @StyleYear IS NOT NULL  AND @StyleCategory IS NOT NULL
BEGIN

	SELECT  @Margin = b.Margin ,  @Commission = Commission
	FROM dbo.pTradePartnerVendorRate a
	INNER JOIN pTradePartnerVendorRateItem b ON a.TradepartnerVendorRateID =  b.TradePartnerVendorRateID 
	WHERE a.TradePartnerVendorID = @TradePartnerVendorID
	AND a.Season = @StyleSeason AND a.Year = @StyleYear 
	AND b.StyleCategoryID = @StyleCategory 

END 



IF @Margin IS NULL 
	SET @Margin  = 0 
IF @Commission IS NULL 
	SET @Commission  = 0 

	

--Comment #01, #02
BEGIN
	--Get the Agent and Vendor IDs.
	SELECT @TradePartnerID = TradePartnerID
		,@TradePartnerVendorID = TradePartnerVendorID
	FROM pStyleQuoteItem
	WHERE StyleQuoteItemID = @StyleQuoteItemID

	--Get 'Partner Type' for Agent.
	SELECT @TradePartnerType = TradePartnerType
	FROM uTradePartner
	WHERE TradePartnerID = @TradePartnerID

	IF(@TradePartnerType = 2)	--"Vendor" Partner Type
		BEGIN
			SELECT @CurrencyType = CurrencyType
				,@Freight = Freight		--Comment #02
				,@Duty = Duty		--Comment #02
			FROM uTradePartner
			WHERE TradePartnerID = @TradePartnerID
		END
	ELSE IF(@TradePartnerType = 1)	--"Agent" Partner Type
		BEGIN
			SELECT @CurrencyType = CurrencyType
				,@Freight = Freight		--Comment #02
				,@Duty = Duty		--Comment #02
			FROM uTradePartnerVendor
			WHERE TradePartnerVendorID = @TradePartnerVendorID
		END
END



UPDATE pStyleQuoteItem 
SET StyleQuoteItemCustomField7 = @Custom2,
StyleQuoteItemCustomField6  = @CurrencyType,
StyleQuoteItemCustomField12 = @Freight,
StyleQuoteItemCustomField13 = @Duty,
StyleQuoteItemCustomField22 = @Margin,
StyleQuoteItemCustomField11 = @Commission
WHERE StyleQuoteItemID = @StyleQuoteItemID 



--/************/
--/*Testing.	*/
--/************/
--BEGIN
--	SELECT @TradePartnerType, @Freight, @Duty
--END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_ControlTradePartnerRate_StyleCategory_SELECT]'
GO



ALTER  PROCEDURE [dbo].[spx_ControlTradePartnerRate_StyleCategory_SELECT] (
@TradePartnerVendorRateID uniqueidentifier  
)
as 

	SELECT a.TradePartnerVendorRateItemID,  a.StyleCategoryID , a.Rate, b.StyleCategory,
	a.Margin, a.Commission
	FROM pTradePartnerVendorRateItem a INNER JOIN pStyleCategory  b ON a.StyleCategoryID  =  b.StyleCategoryID 
	WHERE TradePartnerVendorRateID = @TradePartnerVendorRateID
	ORDER BY b.StyleCategory





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteActivityCalendarVendorShared_INSERT]'
GO



ALTER PROCEDURE [dbo].[spx_StyleQuoteActivityCalendarVendorShared_INSERT]
(@TradePartnerId varchar(50),
@TradePartnerVendorId varchar(50),
@CalendarId varchar(50),
@StartDate datetime,
@EndDate datetime)
AS 

BEGIN

	INSERT INTO dbo.pStyleCalendarTemp
		(CalendarId, PKeyId, CalendarLinkId, CalendarLinkSubId, CalendarDate, CalendarType, CalendarStatus, CalendarDescription, CalendarView)
	SELECT   @CalendarId AS CalendarId,  pStyleQuoteItem.StyleQuoteItemId, pStyleQuoteItem.StyleId, 
		pStyleQuoteItem.styleQuoteId AS CalendarLinkSubId, 
		pStyleQuoteItemActivity.CDate, 'QuoteActivity' AS CalendarType, pStyleQuoteItemActivity.ActivityType, 
		'<b>A: </b>' + dbo.uTradePartner.TradePartnerCode + ' / <b>V: </b>' + dbo.uTradePartnerVendor.VendorCode + '<BR>' + dbo.pStyleHeader.StyleNo + ' (' +
		dbo.pStyleHeader.SizeClass + ') ' + dbo.pStyleHeader.Description AS CalendarDescription, pStyleQuoteItem.AgentView
	FROM         pStyleQuoteItem WITH (NOLOCK) INNER JOIN
		dbo.pStyleHeader WITH (NOLOCK) ON pStyleQuoteItem.StyleID = dbo.pStyleHeader.StyleID INNER JOIN
		pStyleQuoteItemActivity WITH (NOLOCK) ON 
		pStyleQuoteItem.StyleQuoteItemId = pStyleQuoteItemActivity.StyleQuoteItemId INNER JOIN
		dbo.uTradePartner WITH (NOLOCK) ON pStyleQuoteItem.TradePartnerId = dbo.uTradePartner.TradePartnerID INNER JOIN
		dbo.uTradePartnerVendor WITH (NOLOCK) ON pStyleQuoteItem.TradePartnerVendorId = dbo.uTradePartnerVendor.TradePartnerVendorID
	WHERE  (uTradePartnerVendor.TradePartnerVendorID = @TradePartnerVendorId)  
	AND (pStyleQuoteItemActivity.TradePartner = 0)
	AND     (pStyleQuoteItemActivity.CDate BETWEEN @StartDate AND @EndDate) 
	AND pStyleQuoteItemActivity.ActivityType NOT IN ('V','A') AND (pStyleQuoteItem.StyleQuoteItemShare = 1)
	ORDER BY  pStyleQuoteItemActivity.Cdate, dbo.pStyleHeader.StyleNo, pStyleQuoteItemActivity.ActivityType ASC	


END 



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialColorIsUsedBy_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_MaterialColorIsUsedBy_SELECT]
(
@MaterialColorID uniqueidentifier
)
AS 

DECLARE @intCount1 INT
DECLARE @intCount2 INT
DECLARE @intCount3 INT
DECLARE @intTotalCount INT

BEGIN
	SELECT @intCount1 = COUNT(*) FROM pStyleColorwayItem WHERE MaterialColorID = @MaterialColorID
	SELECT @intCount2 = COUNT(*) FROM pMaterialLinkColorwayItem WHERE MaterialColorID = @MaterialColorID
	SELECT @intCount3 = COUNT(*) FROM pMaterialTradePartnerColor WHERE MaterialColorID = @MaterialColorID
	SET @intTotalCount = (@intCount1 + @intCount2 + @intCount3)
END

BEGIN
	If @intTotalCount > 0 
		BEGIN
			SELECT 1
		END	
	Else
		BEGIN
			SELECT 0
		END
END






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_ControlMaterialRequestWorkflowGroup_COPYFROM]'
GO

CREATE PROCEDURE [dbo].[spx_ControlMaterialRequestWorkflowGroup_COPYFROM](
	@MaterialRequestWorkflowGroupID varchar(40),
	@CUser nvarchar(200), 
	@CDate datetime
) 
AS 

BEGIN

	BEGIN TRY 
		BEGIN TRANSACTION 

			DECLARE @MaterialRequestWorkflowID varchar(10)
			DECLARE @MaterialRequestWorkflowGroup nvarchar(200)

			SELECT @MaterialRequestWorkflowID = MaterialRequestWorkflowID, @MaterialRequestWorkflowGroup = MaterialRequestWorkflowGroup
			FROM pMaterialRequestWorkflowGroup
			WHERE MaterialRequestWorkflowGroupID = @MaterialRequestWorkflowGroupID
			
			DECLARE @NewMaterialRequestWorkflowGroupID uniqueidentifier
			SET @NewMaterialRequestWorkflowGroupID = newid()
			INSERT INTO pMaterialRequestWorkflowGroup (MaterialRequestWorkflowGroupID, MaterialRequestWorkflowID, MaterialRequestWorkflowGroup, 
				CUser, CDate, MUser, MDate)
			VALUES (@NewMaterialRequestWorkflowGroupID, @MaterialRequestWorkflowID, @MaterialRequestWorkflowGroup + ' (Copy)', @CUser, @CDate, @CUser, @CDate)

			INSERT INTO pMaterialRequestWorkflowItem (MaterialRequestWorkflowItemID, MaterialRequestWorkflowGroupID, MaterialRequestWorkflowID, MaterialRequestWorkflowItemCustom1, 
			  MaterialRequestWorkflowItemCustom2, MaterialRequestWorkflowItemCustom3, MaterialRequestWorkflowItemCustom4, MaterialRequestWorkflowItemCustom5, 
			  MaterialRequestWorkflowItemCustom6, MaterialRequestWorkflowItemCustom7, MaterialRequestWorkflowItemCustom8, MaterialRequestWorkflowItemCustom9, 
			  MaterialRequestWorkflowItemCustom10, MaterialRequestWorkflowItemSort, CUser, CDate, MUser, MDate)
			SELECT newid(), @NewMaterialRequestWorkflowGroupID, MaterialRequestWorkflowID, MaterialRequestWorkflowItemCustom1, 
			  MaterialRequestWorkflowItemCustom2, MaterialRequestWorkflowItemCustom3, MaterialRequestWorkflowItemCustom4, MaterialRequestWorkflowItemCustom5, 
			  MaterialRequestWorkflowItemCustom6, MaterialRequestWorkflowItemCustom7, MaterialRequestWorkflowItemCustom8, MaterialRequestWorkflowItemCustom9, 
			  MaterialRequestWorkflowItemCustom10, MaterialRequestWorkflowItemSort, @CUser, @CDate, @CUser, @CDate
			FROM pMaterialRequestWorkflowItem
			WHERE MaterialRequestWorkflowGroupID = @MaterialRequestWorkflowGroupID

		COMMIT TRAN 
	END TRY

	BEGIN CATCH
		IF @@TRANCOUNT > 0
			ROLLBACK TRAN 

			DECLARE @ErrorMessage NVARCHAR(4000);
			DECLARE @ErrorSeverity INT;
			DECLARE @ErrorState INT;

			SELECT 
				@ErrorMessage = ERROR_MESSAGE(),
				@ErrorSeverity = ERROR_SEVERITY(),
				@ErrorState = ERROR_STATE();

				RAISERROR (@ErrorMessage, -- Message text.
						   @ErrorSeverity, -- Severity.
						   @ErrorState -- State.
						   );
	END CATCH

END






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_QuoteFolderItemTeamStatus_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_QuoteFolderItemTeamStatus_SELECT](@QuoteFolderID uniqueidentifier,
@QuoteFolderTeamID uniqueidentifier,
@QuoteStatus nvarchar(50))
AS SELECT     dbo.pQuoteFolderItem.QuoteFolderItemID, dbo.pQuoteFolderItemTeam.QuoteFolderID, dbo.pQuoteFolderItem.StyleID, 
                      dbo.pQuoteFolderItem.CustomField1, dbo.pQuoteFolderItem.CustomField2, dbo.pQuoteFolderItem.CustomField3, dbo.pQuoteFolderItem.CustomField4, 
                      dbo.pQuoteFolderItem.CustomField5, dbo.pQuoteFolderItem.CustomField6, dbo.pQuoteFolderItem.CustomField7, dbo.pQuoteFolderItem.CustomField8, 
                      dbo.pQuoteFolderItem.CustomField9, dbo.pQuoteFolderItem.CustomField10, dbo.pQuoteFolderItem.CustomField11, 
                      dbo.pQuoteFolderItem.CustomField12, dbo.pQuoteFolderItem.CustomField13, dbo.pQuoteFolderItem.CustomField14, 
                      dbo.pQuoteFolderItem.CustomField15, dbo.pQuoteFolderItem.CUser, dbo.pQuoteFolderItem.CDate, dbo.pQuoteFolderItem.MUser, 
                      dbo.pQuoteFolderItem.MDate, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.Description, dbo.pStyleHeader.DesignSketchID, 
                      dbo.pStyleHeader.DesignSketchVersion, dbo.pStyleHeader.StyleStatus, dbo.pQuoteFolderItem.PDFFile, dbo.pQuoteFolderItemTeam.TeamID, 
                      dbo.pQuoteFolderItemTeam.EstimatedCostType, dbo.pQuoteFolderItemTeam.EstimatedCost, dbo.pQuoteFolderItemTeam.EstimatedCostCur, 
                      dbo.pQuoteFolderItemTeam.VendorCostType, dbo.pQuoteFolderItemTeam.VendorCost, dbo.pQuoteFolderItemTeam.VendorCostCur, 
                      dbo.pQuoteFolderItemTeam.FinalCostType, dbo.pQuoteFolderItemTeam.FinalCost, dbo.pQuoteFolderItemTeam.FinalCostCur, 
                      dbo.pQuoteFolderItem.PDFDate, dbo.pQuoteFolderItem.PDFUser, dbo.pQuoteFolderItem.QuoteComments, 
                      dbo.pQuoteFolderItemTeam.QuoteFolderTeamID, dbo.pQuoteFolderItemTeam.QuoteFolderItemStatus, dbo.pQuoteFolderItem.QuoteFolderSort
FROM         dbo.pQuoteFolderItem WITH (NOLOCK) INNER JOIN
                      dbo.pStyleHeader WITH (NOLOCK) ON dbo.pQuoteFolderItem.StyleID = dbo.pStyleHeader.StyleID INNER JOIN
                      dbo.pQuoteFolderItemTeam WITH (NOLOCK) ON dbo.pQuoteFolderItem.QuoteFolderItemID = dbo.pQuoteFolderItemTeam.QuoteFolderItemID
WHERE     (dbo.pQuoteFolderItemTeam.TeamID = @QuoteFolderTeamID) AND (dbo.pQuoteFolderItemTeam.QuoteFolderID = @QuoteFolderID) AND 
                      (dbo.pQuoteFolderItemTeam.QuoteFolderItemStatus = @QuoteStatus)
ORDER BY dbo.pQuoteFolderItem.QuoteFolderSort, dbo.pQuoteFolderItem.PDFFile DESC, dbo.pStyleHeader.StyleNo



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Rebuilding [dbo].[pStyleQuoteItemVersion]'
GO

CREATE TABLE [dbo].[tmp_rg_xx_pStyleQuoteItemVersion]
(
[StyleQuoteItemVersionID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_pStyleQuoteItemVersion_StyleQuoteItemVersionID] DEFAULT (newid()),
[Version] [int] NOT NULL CONSTRAINT [DF_pStyleQuoteItemVersion_Version] DEFAULT ((1)),
[StyleQuoteItemID] [uniqueidentifier] NOT NULL,
[StyleQuoteItemNo] [int] NOT NULL,
[StyleQuoteItemShare] [int] NULL,
[StyleQuoteItemStatusId] [int] NULL,
[StyleQuoteVariationId] [uniqueidentifier] NULL,
[StyleQuoteID] [uniqueidentifier] NULL,
[StyleQuotaDutyID] [uniqueidentifier] NULL,
[StyleDevelopmentID] [uniqueidentifier] NULL,
[StyleID] [uniqueidentifier] NULL,
[StyleQuoteTradePartnerID] [uniqueidentifier] NULL,
[StyleCostingID] [uniqueidentifier] NULL,
[StyleCostingType] [int] NULL,
[StyleCostingFreightTypeID] [int] NULL,
[TradePartnerID] [uniqueidentifier] NULL,
[TradePartnerVendorID] [uniqueidentifier] NULL,
[StyleQuoteItemDueDate] [datetime] NULL,
[StyleQuoteItemApprovedBy] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemApprovedDate] [datetime] NULL,
[StyleQuoteItemCustomField1] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField2] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField3] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField4] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField5] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField6] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField7] [uniqueidentifier] NULL,
[StyleQuoteItemCustomField8] [money] NULL,
[StyleQuoteItemCustomField9] [money] NULL,
[StyleQuoteItemCustomField10] [money] NULL,
[StyleQuoteItemCustomField11] [decimal] (18, 4) NULL,
[StyleQuoteItemCustomField12] [decimal] (18, 4) NULL,
[StyleQuoteItemCustomField13] [decimal] (18, 4) NULL,
[StyleQuoteItemCustomField14] [money] NULL,
[StyleQuoteItemCustomField15] [money] NULL,
[StyleQuoteItemCustomField16] [decimal] (18, 4) NULL,
[StyleQuoteItemCustomField17] [money] NULL,
[StyleQuoteItemCustomField18] [money] NULL,
[StyleQuoteItemCustomField19] [money] NULL,
[StyleQuoteItemCustomField20] [money] NULL,
[StyleQuoteItemCustomField21] [decimal] (18, 3) NULL,
[StyleQuoteItemCustomField22] [decimal] (18, 3) NULL,
[StyleQuoteItemCustomField23] [decimal] (18, 3) NULL,
[StyleQuoteItemCustomField24] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField25] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField26] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField27] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField28] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField29] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemCustomField30] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleQuoteItemNotes] [ntext] COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField1] [money] NULL,
[StyleCostingCustomField2] [money] NULL,
[StyleCostingCustomField3] [decimal] (18, 4) NULL,
[StyleCostingCustomField4] [int] NULL,
[StyleCostingCustomField5] [int] NULL,
[StyleCostingCustomField6] [decimal] (18, 3) NULL,
[StyleCostingCustomField7] [decimal] (18, 3) NULL,
[StyleCostingCustomField8] [decimal] (18, 3) NULL,
[StyleCostingCustomField9] [decimal] (18, 3) NULL,
[StyleCostingCustomField10] [decimal] (18, 3) NULL,
[StyleCostingCustomField11] [decimal] (18, 3) NULL,
[StyleCostingCustomField12] [decimal] (18, 3) NULL,
[StyleCostingCustomField13] [decimal] (18, 3) NULL,
[StyleCostingCustomField14] [decimal] (18, 3) NULL,
[StyleCostingCustomField15] [decimal] (18, 3) NULL,
[StyleCostingCustomField16] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField17] [datetime] NULL,
[StyleCostingCustomField18] [decimal] (18, 3) NULL,
[StyleCostingCustomField19] [decimal] (18, 3) NULL,
[StyleCostingCustomField20] [decimal] (18, 3) NULL,
[StyleCostingCustomField21] [decimal] (18, 3) NULL,
[StyleCostingCustomField22] [decimal] (18, 3) NULL,
[StyleCostingCustomField23] [decimal] (18, 3) NULL,
[StyleCostingCustomField24] [decimal] (18, 3) NULL,
[StyleCostingCustomField25] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField26] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField27] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField28] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField29] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField30] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField31] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField32] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField33] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField34] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleCostingCustomField35] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CUser] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[QuoteFolderSort] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[AgentView] [int] NULL,
[StyleColorID] [uniqueidentifier] NULL,
[StyleSourcingID] [uniqueidentifier] NULL
)
GO

IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO


UPDATE pStyleQuoteItemVersion
 SET StyleQuoteItemCustomField7 = NULL
WHERE IsNumeric(StyleQuoteItemCustomField7) = 1
GO

IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO

UPDATE pStyleQuoteItemVersion
 SET StyleQuoteItemCustomField13 = NULL
WHERE IsNumeric(StyleQuoteItemCustomField13) = 0
GO

IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO

UPDATE pStyleQuoteItemVersion
 SET StyleQuoteItemCustomField16 = NULL
WHERE IsNumeric(StyleQuoteItemCustomField16) = 0
GO

IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO


UPDATE pStyleQuoteItemVersion
 SET StyleQuoteItemCustomField22 = NULL
WHERE IsNumeric(StyleQuoteItemCustomField22) = 0
GO


IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO

UPDATE pStyleQuoteItemVersion
 SET StyleCostingCustomField20 = NULL
WHERE IsNumeric(StyleCostingCustomField20) = 0
GO

--
-- kj debug
--

IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
INSERT INTO [dbo].[tmp_rg_xx_pStyleQuoteItemVersion]([StyleQuoteItemVersionID], [Version], [StyleQuoteItemID], [StyleQuoteItemNo], [StyleQuoteItemShare], [StyleQuoteItemStatusId], [StyleQuoteVariationId], [StyleQuoteID], [StyleQuotaDutyID], [StyleDevelopmentID], [StyleID], [StyleQuoteTradePartnerID], [StyleCostingID], [StyleCostingType], [StyleCostingFreightTypeID], [TradePartnerID], [TradePartnerVendorID], [StyleQuoteItemDueDate], [StyleQuoteItemApprovedBy], [StyleQuoteItemApprovedDate], [StyleQuoteItemCustomField1], [StyleQuoteItemCustomField2], [StyleQuoteItemCustomField3], [StyleQuoteItemCustomField4], [StyleQuoteItemCustomField5], [StyleQuoteItemCustomField6], [StyleQuoteItemCustomField7], [StyleQuoteItemCustomField8], [StyleQuoteItemCustomField9], [StyleQuoteItemCustomField10], [StyleQuoteItemCustomField11], [StyleQuoteItemCustomField12], [StyleQuoteItemCustomField13], [StyleQuoteItemCustomField14], [StyleQuoteItemCustomField15], [StyleQuoteItemCustomField16], [StyleQuoteItemCustomField17], [StyleQuoteItemCustomField18], [StyleQuoteItemCustomField19], [StyleQuoteItemCustomField20], [StyleQuoteItemCustomField21], [StyleQuoteItemCustomField22], [StyleQuoteItemCustomField23], [StyleQuoteItemCustomField24], [StyleQuoteItemCustomField25], [StyleQuoteItemCustomField26], [StyleQuoteItemCustomField27], [StyleQuoteItemCustomField28], [StyleQuoteItemCustomField29], [StyleQuoteItemCustomField30], [StyleQuoteItemNotes], [StyleCostingCustomField1], [StyleCostingCustomField2], [StyleCostingCustomField3], [StyleCostingCustomField4], [StyleCostingCustomField5], [StyleCostingCustomField6], [StyleCostingCustomField7], [StyleCostingCustomField8], [StyleCostingCustomField9], [StyleCostingCustomField10], [StyleCostingCustomField11], [StyleCostingCustomField12], [StyleCostingCustomField13], [StyleCostingCustomField14], [StyleCostingCustomField15], [StyleCostingCustomField16], [StyleCostingCustomField17], [StyleCostingCustomField18], [StyleCostingCustomField19], [StyleCostingCustomField20], [StyleCostingCustomField21], [StyleCostingCustomField22], [StyleCostingCustomField23], [StyleCostingCustomField24], [StyleCostingCustomField25], [StyleCostingCustomField26], [StyleCostingCustomField27], [StyleCostingCustomField28], [StyleCostingCustomField29], [StyleCostingCustomField30], [StyleCostingCustomField31], [StyleCostingCustomField32], [StyleCostingCustomField33], [StyleCostingCustomField34], [StyleCostingCustomField35], [CUser], [CDate], [MUser], [MDate], [QuoteFolderSort], [AgentView], [StyleColorID], [StyleSourcingID]) SELECT [StyleQuoteItemVersionID], [Version], [StyleQuoteItemID], [StyleQuoteItemNo], [StyleQuoteItemShare], [StyleQuoteItemStatusId], [StyleQuoteVariationId], [StyleQuoteID], [StyleQuotaDutyID], [StyleDevelopmentID], [StyleID], [StyleQuoteTradePartnerID], [StyleCostingID], [StyleCostingType], [StyleCostingFreightTypeID], [TradePartnerID], [TradePartnerVendorID], [StyleQuoteItemDueDate], [StyleQuoteItemApprovedBy], [StyleQuoteItemApprovedDate], CAST([StyleQuoteItemCustomField1] AS [nvarchar] (200)) COLLATE SQL_Latin1_General_CP1_CI_AS, CAST([StyleQuoteItemCustomField2] AS [nvarchar] (200)) COLLATE SQL_Latin1_General_CP1_CI_AS, [StyleQuoteItemCustomField3], [StyleQuoteItemCustomField4], [StyleQuoteItemCustomField5], [StyleQuoteItemCustomField6], [StyleQuoteItemCustomField7], CAST([StyleQuoteItemCustomField8] AS [money]), CAST([StyleQuoteItemCustomField9] AS [money]), CAST([StyleQuoteItemCustomField10] AS [money]), CAST([StyleQuoteItemCustomField11] AS [decimal] (18, 4)), [StyleQuoteItemCustomField12], [StyleQuoteItemCustomField13], CAST([StyleQuoteItemCustomField14] AS [money]), [StyleQuoteItemCustomField15], [StyleQuoteItemCustomField16], CAST([StyleQuoteItemCustomField17] AS [money]), CAST([StyleQuoteItemCustomField18] AS [money]), CAST([StyleQuoteItemCustomField19] AS [money]), CAST([StyleQuoteItemCustomField20] AS [money]), CAST([StyleQuoteItemCustomField21] AS [decimal] (18, 3)), [StyleQuoteItemCustomField22], [StyleQuoteItemCustomField23], [StyleQuoteItemCustomField24], [StyleQuoteItemCustomField25], [StyleQuoteItemCustomField26], [StyleQuoteItemCustomField27], [StyleQuoteItemCustomField28], [StyleQuoteItemCustomField29], [StyleQuoteItemCustomField30], [StyleQuoteItemNotes], [StyleCostingCustomField1], [StyleCostingCustomField2], CAST([StyleCostingCustomField3] AS [decimal] (18, 4)), [StyleCostingCustomField4], [StyleCostingCustomField5], [StyleCostingCustomField6], [StyleCostingCustomField7], CAST([StyleCostingCustomField8] AS [decimal] (18, 3)), [StyleCostingCustomField9], [StyleCostingCustomField10], [StyleCostingCustomField11], [StyleCostingCustomField12], [StyleCostingCustomField13], [StyleCostingCustomField14], [StyleCostingCustomField15], [StyleCostingCustomField16], [StyleCostingCustomField17], CAST([StyleCostingCustomField18] AS [decimal] (18, 3)), [StyleCostingCustomField19], [StyleCostingCustomField20], [StyleCostingCustomField21], [StyleCostingCustomField22], [StyleCostingCustomField23], [StyleCostingCustomField24], [StyleCostingCustomField25], [StyleCostingCustomField26], [StyleCostingCustomField27], [StyleCostingCustomField28], [StyleCostingCustomField29], [StyleCostingCustomField30], [StyleCostingCustomField31], [StyleCostingCustomField32], [StyleCostingCustomField33], [StyleCostingCustomField34], [StyleCostingCustomField35], [CUser], [CDate], [MUser], [MDate], [QuoteFolderSort], [AgentView], [StyleColorID], [StyleSourcingID] FROM [dbo].[pStyleQuoteItemVersion]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
DROP TABLE [dbo].[pStyleQuoteItemVersion]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_rename N'[dbo].[tmp_rg_xx_pStyleQuoteItemVersion]', N'pStyleQuoteItemVersion'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pStyleQuoteItemVersion] on [dbo].[pStyleQuoteItemVersion]'
GO
ALTER TABLE [dbo].[pStyleQuoteItemVersion] ADD CONSTRAINT [PK_pStyleQuoteItemVersion] PRIMARY KEY CLUSTERED  ([StyleQuoteItemVersionID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialRequestWorkflowVendorStatus_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_MaterialRequestWorkflowVendorStatus_SELECT](
@MaterialTradePartnerId UNIQUEIDENTIFIER
) AS 

SELECT pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID, pMaterialTradePartnerColor.MaterialTradePartnerColorID,  
   pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID, pMaterialTradePartner.MaterialTradePartnerId,
  pMaterialRequestSubmitStatus.StatusID, pMaterialRequestSubmitStatus.Status, pMaterialRequestSubmitWorkflow.Submit, 
  pMaterialRequestSubmitWorkflow.DueDate, pMaterialRequestSubmitWorkflow.EndDate, pMaterialRequestSubmitStatus.ApprovedType,
--	'<TABLE cellSpacing=''0'' cellPadding=''0'' width=''100%'' border=''0''><TR><TD width=''18''> 
--	<IMG src=''' + 
--	CASE 
--		WHEN pMaterialRequestSubmitStatus.ApprovedType = 1  THEN '../System/Icons/icon_ball_green.gif'
--		WHEN pMaterialRequestSubmitStatus.StatusID = 4  THEN '../System/Icons/icon_ball_red.gif'
--		WHEN pMaterialRequestSubmitWorkflow.Submit = 1 THEN '../System/Icons/icon_ball_blue.gif'
--		ELSE '../System/Icons/icon_ball_yellow.gif'
--	END
--	+ '''  border=0 ALT=''Open''><TD class=''font'' align=center valign=center nowrap>&nbsp; 
--	<a href="javascript:window.location(''../Material/Material_RequestSubmit.aspx?TB=' + CAST(pMaterialRequestSubmitWorkflow.Submit AS VARCHAR(2)) + 
--	'&MRWID=' + CAST(pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID AS VARCHAR(10)) + 
--	'&MTPCID=' + CAST(pMaterialTradePartnerColor.MaterialTradePartnerColorID AS VARCHAR(40)) + 
--	'&MTPID=' + CAST(pMaterialTradePartner.MaterialTradePartnerId AS VARCHAR(40)) + 
--	'&MTID=' + CAST(pMaterialTradePartner.MaterialId AS VARCHAR(40)) + ''');">' +
--	CASE 
--		WHEN pMaterialRequestSubmitStatus.ApprovedType = 1 Or pMaterialRequestSubmitStatus.StatusID = 4 THEN CONVERT(VARCHAR(12), pMaterialRequestSubmitWorkflow.EndDate , 107)
--		ELSE ISNULL(CONVERT(VARCHAR(12), pMaterialRequestSubmitWorkflow.DueDate , 107),'NODATE') --CONVERT(VARCHAR(20), pMaterialRequestSubmitWorkflow.DueDate , 101)
--	END 
--	+ '&nbsp;<b>(' 
--	+  CAST(pMaterialRequestSubmitWorkflow.Submit AS VARCHAR(5)) + ')</b></a></TD></TR></TABLE>' AS Link
	'<TABLE cellSpacing=''0'' cellPadding=''0'' width=''100%'' border=''0''><TR><TD width=''18''> 
	<IMG src=''' + '../System/Icons/' + pMaterialRequestSubmitStatus.StatusIcon 
	+ '''  border=0 ALT=''Open''><TD class=''font'' align=center valign=center nowrap>&nbsp; 
	<a href=''#'' onclick="javascript:window.open(''../Material/Material_RequestSubmitRedirect.aspx?MTPID=' + 
	CAST (pMaterialTradePartner.MaterialTradePartnerId AS VARCHAR(40)) + '&MRSWID=' + CAST(pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID AS VARCHAR(40)) + 
	'&MTPCID=' + CAST(pMaterialTradePartnerColor.MaterialTradePartnerColorID AS VARCHAR(40)) + '&MRWID=' + CAST(pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID AS VARCHAR(40)) +
	''',''' +  
	Replace(CAST (pMaterialTradePartnerColor.MaterialTradePartnerColorID AS VARCHAR(40)) , '-', '') +
	''',''width=1024, height=700, location=yes, menubar=yes, status=yes, toolbar=yes, scrollbars=yes, resizable=yes'');">' 
	+
	CASE 
		WHEN pMaterialRequestSubmitStatus.ApprovedType = 1 Or pMaterialRequestSubmitStatus.StatusID = 4 THEN ISNULL(CONVERT(VARCHAR(12), pMaterialRequestSubmitWorkflow.EndDate , 107),'NODATE')
		ELSE ISNULL(CONVERT(VARCHAR(12), pMaterialRequestSubmitWorkflow.DueDate , 107),'NODATE') --CONVERT(VARCHAR(20), pMaterialRequestSubmitWorkflow.DueDate , 101)
	END 
	+ '&nbsp;<b>(' 
	+  CAST(pMaterialRequestSubmitWorkflow.Submit AS VARCHAR(5)) + ')</b></a></TD></TR></TABLE>' AS Link
FROM  pMaterialTradePartnerColor INNER JOIN
  pMaterialTradePartner ON pMaterialTradePartnerColor.MaterialTradePartnerID = pMaterialTradePartner.MaterialTradePartnerId INNER JOIN
  pMaterialRequestSubmitWorkflow ON 
  pMaterialTradePartnerColor.MaterialTradePartnerColorID = pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID INNER JOIN
  pMaterialRequestSubmitStatus ON pMaterialRequestSubmitWorkflow.Status = pMaterialRequestSubmitStatus.StatusID
WHERE pMaterialRequestSubmitWorkflow.MaterialTradePartnerId = @MaterialTradePartnerId
UNION ALL
SELECT NULL AS MaterialTradePartnerColorId, NULL AS MaterialTradePartnerId, NULL AS MaterialRequestSubmitWorkflowId, NULL AS MaterialRequestWorkflowID, 
NULL AS StatusID, NULL AS [Status], NULL  AS Submit, NULL AS DueDate, NULL AS EndDate , NULL AS ApprovedType, '<div align=''center''>-------</div>'AS Link 






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteCalendarAgent_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_StyleQuoteCalendarAgent_INSERT]
(
@TeamId uniqueidentifier,
@TradePartnerId uniqueidentifier,
@CalendarId uniqueidentifier,
@StartDate datetime,
@EndDate datetime)
AS 


BEGIN
	INSERT INTO dbo.pStyleCalendarTemp
		(CalendarId, PKeyId, CalendarLinkId, CalendarLinkSubId, CalendarDate, CalendarType, CalendarStatus, CalendarDescription, CalendarView)
	SELECT     @CalendarId AS CalendarId, dbo.pStyleQuoteItem.StyleQuoteItemID, dbo.pStyleHeader.StyleID, dbo.pStyleHeader.DevelopmentID, 
		pStyleQuoteItem.StyleQuoteItemApprovedDate, 'Quote' AS CalendarType, pStyleQuoteItem.StyleQuoteItemStatusId,
		'<b>A: </b>' + uTradePartner.TradePartnerCode + ' / <b>V: </b>' + uTradePartnerVendor.VendorCode + '<BR>' + dbo.pStyleHeader.StyleNo + ' (' + dbo.pStyleHeader.SizeClass + ') ' + dbo.pStyleHeader.Description AS CalendarDescription, 0
	FROM   dbo.pStyleQuote WITH (NOLOCK) INNER JOIN
		dbo.pStyleQuoteItem WITH (NOLOCK) ON dbo.pStyleQuote.StyleQuoteID = dbo.pStyleQuoteItem.StyleQuoteID INNER JOIN
		dbo.uTradePartnerVendor WITH (NOLOCK) ON dbo.pStyleQuoteItem.TradePartnerVendorID = dbo.uTradePartnerVendor.TradePartnerVendorID INNER JOIN
		dbo.uTradePartner WITH (NOLOCK) ON dbo.pStyleQuote.TradePartnerID = dbo.uTradePartner.TradePartnerID INNER JOIN
		dbo.pStyleQuoteItemStatus WITH (NOLOCK) ON dbo.pStyleQuoteItem.StyleQuoteItemStatusId = dbo.pStyleQuoteItemStatus.CustomKey INNER JOIN
		dbo.pStyleHeader WITH (NOLOCK) ON dbo.pStyleQuoteItem.StyleID = dbo.pStyleHeader.StyleID
	WHERE (dbo.pStyleHeader.Active = 1) AND (pStyleQuoteItem.StyleQuoteItemApprovedDate BETWEEN @StartDate AND @EndDate) AND 
		(pStyleQuoteItem.StyleQuoteItemStatusId <> 0) AND (pStyleQuoteItem.TradePartnerID = @TradePartnerId) 
AND pStyleHeader.StyleType  in  (  SELECT  StyleTypeId from sAccessQuotationFolder WITH (NOLOCK)  where TeamID = @TeamId  AND ( AccessRoleId =  3 OR AccessView = 1) ) 
	
END 


BEGIN
	INSERT INTO dbo.pStyleCalendarTemp
		(CalendarId, PKeyId, CalendarLinkId, CalendarLinkSubId, CalendarDate, CalendarType, CalendarStatus, CalendarDescription, CalendarView)
	SELECT     @CalendarId AS CalendarId, dbo.pStyleQuoteItem.StyleQuoteItemID, dbo.pStyleHeader.StyleID, dbo.pStyleHeader.DevelopmentID, 
		pStyleQuoteItem.StyleQuoteItemDueDate, 'Quote' AS CalendarType, pStyleQuoteItem.StyleQuoteItemStatusId,
		'<b>A: </b>' + uTradePartner.TradePartnerCode + ' / <b>V: </b>' + uTradePartnerVendor.VendorCode + '<BR>' + dbo.pStyleHeader.StyleNo + ' (' + dbo.pStyleHeader.SizeClass + ') ' + dbo.pStyleHeader.Description AS CalendarDescription, 0
	FROM   dbo.pStyleQuote WITH (NOLOCK) INNER JOIN
		dbo.pStyleQuoteItem WITH (NOLOCK) ON dbo.pStyleQuote.StyleQuoteID = dbo.pStyleQuoteItem.StyleQuoteID INNER JOIN
		dbo.uTradePartnerVendor WITH (NOLOCK) ON dbo.pStyleQuoteItem.TradePartnerVendorID = dbo.uTradePartnerVendor.TradePartnerVendorID INNER JOIN
		dbo.uTradePartner WITH (NOLOCK) ON dbo.pStyleQuote.TradePartnerID = dbo.uTradePartner.TradePartnerID INNER JOIN
		dbo.pStyleQuoteItemStatus WITH (NOLOCK) ON dbo.pStyleQuoteItem.StyleQuoteItemStatusId = dbo.pStyleQuoteItemStatus.CustomKey INNER JOIN
		dbo.pStyleHeader WITH (NOLOCK) ON dbo.pStyleQuoteItem.StyleID = dbo.pStyleHeader.StyleID
	WHERE (dbo.pStyleHeader.Active = 1) AND (pStyleQuoteItem.StyleQuoteItemDueDate BETWEEN @StartDate AND @EndDate) AND  
		(pStyleQuoteItem.StyleQuoteItemStatusId = 0) AND (pStyleQuoteItem.TradePartnerID = @TradePartnerId) 
AND pStyleHeader.StyleType  in  (  SELECT  StyleTypeId from sAccessQuotationFolder WITH (NOLOCK)  where TeamID = @TeamId  AND ( AccessRoleId =  3 OR AccessView = 1) ) 
	
END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_ControlMaterialRequestWorkflowGroup_DELETE]'
GO

CREATE PROCEDURE [dbo].[spx_ControlMaterialRequestWorkflowGroup_DELETE](
	@MaterialRequestWorkflowGroupID varchar(40),
	@CUser nvarchar(200), 
	@CDate datetime
) 
AS 

BEGIN

	BEGIN TRY 
		BEGIN TRANSACTION 
			DELETE FROM pMaterialRequestWorkflowItem WHERE MaterialRequestWorkflowGroupID = @MaterialRequestWorkflowGroupID
			DELETE FROM pMaterialRequestWorkflowGroup WHERE MaterialRequestWorkflowGroupID = @MaterialRequestWorkflowGroupID
		COMMIT TRAN 
	END TRY

	BEGIN CATCH
		IF @@TRANCOUNT > 0
			ROLLBACK TRAN 

			DECLARE @ErrorMessage NVARCHAR(4000);
			DECLARE @ErrorSeverity INT;
			DECLARE @ErrorState INT;

			SELECT 
				@ErrorMessage = ERROR_MESSAGE(),
				@ErrorSeverity = ERROR_SEVERITY(),
				@ErrorState = ERROR_STATE();

				RAISERROR (@ErrorMessage, -- Message text.
						   @ErrorSeverity, -- Severity.
						   @ErrorState -- State.
						   );
	END CATCH

END






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_QuoteFolderStyle_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_QuoteFolderStyle_SELECT]
(
@QuoteFolderID uniqueidentifier = '00000000-0000-0000-0000-000000000000',
@TeamID uniqueidentifier = '00000000-0000-0000-0000-000000000000'
)
AS 

	
IF (@TeamID <> '00000000-0000-0000-0000-000000000000') 

	BEGIN

		SELECT  dbo.pStyleHeader.StyleID, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.Description, dbo.pStyleHeader.DesignSketchID, dbo.pStyleHeader.DesignSketchVersion, 
                     	dbo.pStyleHeader.StyleStatus, dbo.Users.Company, dbo.pQuoteFolderItemTeam.TeamID, dbo.pQuoteFolderItemTeam.QuoteFolderID, dbo.pQuoteFolderItemTeam.QuoteFolderItemID
		FROM  dbo.pStyleHeader WITH (NOLOCK) INNER JOIN
                     	dbo.pQuoteFolderItemTeam WITH (NOLOCK) ON dbo.pStyleHeader.StyleID = dbo.pQuoteFolderItemTeam.StyleID INNER JOIN
                      	dbo.Users WITH (NOLOCK) ON dbo.pQuoteFolderItemTeam.TeamID = dbo.Users.TeamID
		WHERE   (dbo.pQuoteFolderItemTeam.TeamID = @TeamID) AND  (dbo.pQuoteFolderItemTeam.QuoteFolderID = @QuoteFolderID)
		ORDER BY dbo.pStyleHeader.StyleNo

	END	

IF (@QuoteFolderID <> '00000000-0000-0000-0000-000000000000')

	BEGIN

		SELECT     dbo.pQuoteFolderItem.QuoteFolderItemID, dbo.pQuoteFolderItem.QuoteFolderID, dbo.pQuoteFolderItem.StyleID, dbo.pQuoteFolderItem.CustomField1, 
                     	 dbo.pQuoteFolderItem.CustomField2, dbo.pQuoteFolderItem.CustomField3, dbo.pQuoteFolderItem.CustomField4, dbo.pQuoteFolderItem.CustomField5, 
                     	 dbo.pQuoteFolderItem.CustomField6, dbo.pQuoteFolderItem.CustomField7, dbo.pQuoteFolderItem.CustomField8, dbo.pQuoteFolderItem.CustomField9, 
                      	dbo.pQuoteFolderItem.CustomField10, dbo.pQuoteFolderItem.CustomField11, dbo.pQuoteFolderItem.CustomField12, 
                      	dbo.pQuoteFolderItem.CustomField13, dbo.pQuoteFolderItem.CustomField14, dbo.pQuoteFolderItem.CustomField15, dbo.pQuoteFolderItem.CUser, 
                     	 dbo.pQuoteFolderItem.CDate, dbo.pQuoteFolderItem.MUser, dbo.pQuoteFolderItem.MDate, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.Description, 
                      	dbo.pStyleHeader.DesignSketchID, dbo.pStyleHeader.DesignSketchVersion, dbo.pStyleHeader.StyleStatus, dbo.pQuoteFolderItem.PDFFile
		FROM         dbo.pQuoteFolderItem WITH (NOLOCK) INNER JOIN
                     	 dbo.pStyleHeader WITH (NOLOCK) ON dbo.pQuoteFolderItem.StyleID = dbo.pStyleHeader.StyleID
		WHERE     (dbo.pQuoteFolderItem.QuoteFolderID = @QuoteFolderID)
		ORDER BY  dbo.pQuoteFolderItem.QuoteFolderSort, dbo.pStyleHeader.StyleNo

	END	




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialTradePartner_SeasonYear_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_MaterialTradePartner_SeasonYear_SELECT] (
@MaterialID UNIQUEIDENTIFIER , 
@MaterialTradePartnerID UNIQUEIDENTIFIER 
)
AS 

DECLARE @TradePartnerVendorID UNIQUEIDENTIFIER 
DECLARE @SeasonYearID UNIQUEIDENTIFIER 

SELECT @TradePartnerVendorID = TradePartnerVendorID , @SeasonYearID = SeasonYearID
FROM pMaterialTradePartner  
WHERE MaterialTradePartnerID = @MaterialTradePartnerID 


SELECT DISTINCT a.SeasonYearID,  b.Season + ' ' + b.Year AS SeasonYear , a.TradePartnerVendorID
FROM pMaterialTradePartner  a  
INNER JOIN pSeasonYear b ON a.SeasonYearID = b.SeasonYearID  
WHERE  MaterialID = @MaterialID
AND TradePartnerVendorID = @TradePartnerVendorID


SELECT @SeasonYearID AS SeasonYearID 











GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_MaterialSourcing_Default_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_MaterialSourcing_Default_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_ServiceQueueRunning_INSERT]'
GO



CREATE PROCEDURE [dbo].[spx_ServiceQueueRunning_INSERT]

AS 

BEGIN

	
	INSERT INTO sServiceQueueRunning (ServiceQueueID, ServiceQueueSql, ServiceQueuePriority, ServiceQueueRunningDate, Attempt)
	SELECT TOP 5 ServiceQueueID, ServiceQueueSql, ServiceQueuePriority, ServiceQueueDate, 0 AS Attempt
	FROM sServiceQueue 
	WHERE ServiceQueueID NOT IN (
		SELECT ServiceQueueID FROM sServiceQueueRunning
	)	
	ORDER BY ServiceQueueID

	DELETE FROM sServiceQueue WHERE ServiceQueueID IN (SELECT ServiceQueueID FROM sServiceQueueRunning)

END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteCalendarAgentShared_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_StyleQuoteCalendarAgentShared_INSERT]
(@TradePartnerId varchar(50),
@CalendarId varchar(50),
@StartDate datetime,
@EndDate datetime)
AS 


BEGIN
	INSERT INTO pStyleCalendarTemp
		(CalendarId, PKeyId, CalendarLinkId, CalendarLinkSubId, CalendarDate, CalendarType, CalendarStatus, CalendarDescription, CalendarView)
	SELECT     @CalendarId AS CalendarId, pStyleQuoteItem.StyleQuoteItemID, pStyleHeader.StyleID, pStyleHeader.DevelopmentID, 
		pStyleQuoteItem.StyleQuoteItemApprovedDate, 'Quote' AS CalendarType, pStyleQuoteItem.StyleQuoteItemStatusId,
		'<b>A: </b>' + uTradePartner.TradePartnerCode + ' / <b>V: </b>' + uTradePartnerVendor.VendorCode + '<BR>' + pStyleHeader.StyleNo + ' (' + pStyleHeader.SizeClass + ') ' + pStyleHeader.Description AS CalendarDescription, 0
	FROM   pStyleQuote WITH (NOLOCK) INNER JOIN
		pStyleQuoteItem WITH (NOLOCK) ON pStyleQuote.StyleQuoteID = pStyleQuoteItem.StyleQuoteID INNER JOIN
		uTradePartnerVendor WITH (NOLOCK) ON pStyleQuoteItem.TradePartnerVendorID = uTradePartnerVendor.TradePartnerVendorID INNER JOIN
		uTradePartner WITH (NOLOCK) ON pStyleQuote.TradePartnerID = uTradePartner.TradePartnerID INNER JOIN
		pStyleQuoteItemStatus WITH (NOLOCK) ON pStyleQuoteItem.StyleQuoteItemStatusId = pStyleQuoteItemStatus.CustomKey INNER JOIN
		pStyleHeader WITH (NOLOCK) ON pStyleQuoteItem.StyleID = pStyleHeader.StyleID
	WHERE (pStyleHeader.Active = 1) AND (pStyleQuoteItem.StyleQuoteItemApprovedDate BETWEEN @StartDate AND @EndDate) AND 
		(pStyleQuoteItem.StyleQuoteItemStatusId <> 0) AND (pStyleQuoteItem.TradePartnerID = @TradePartnerId) AND
		(pStyleQuoteItem.StyleQuoteItemShare = 1)
	

END 


BEGIN
	INSERT INTO pStyleCalendarTemp
		(CalendarId, PKeyId, CalendarLinkId, CalendarLinkSubId, CalendarDate, CalendarType, CalendarStatus, CalendarDescription, CalendarView)
	SELECT     @CalendarId AS CalendarId, pStyleQuoteItem.StyleQuoteItemID, pStyleHeader.StyleID, pStyleHeader.DevelopmentID, 
		pStyleQuoteItem.StyleQuoteItemDueDate, 'Quote' AS CalendarType, pStyleQuoteItem.StyleQuoteItemStatusId,
		'<b>A: </b>' + uTradePartner.TradePartnerCode + ' / <b>V: </b>' + uTradePartnerVendor.VendorCode + '<BR>' + pStyleHeader.StyleNo + ' (' + pStyleHeader.SizeClass + ') ' + pStyleHeader.Description AS CalendarDescription, 0
	FROM   pStyleQuote WITH (NOLOCK) INNER JOIN
		pStyleQuoteItem WITH (NOLOCK) ON pStyleQuote.StyleQuoteID = pStyleQuoteItem.StyleQuoteID INNER JOIN
		uTradePartnerVendor WITH (NOLOCK) ON pStyleQuoteItem.TradePartnerVendorID = uTradePartnerVendor.TradePartnerVendorID INNER JOIN
		uTradePartner WITH (NOLOCK) ON pStyleQuote.TradePartnerID = uTradePartner.TradePartnerID INNER JOIN
		pStyleQuoteItemStatus WITH (NOLOCK) ON pStyleQuoteItem.StyleQuoteItemStatusId = pStyleQuoteItemStatus.CustomKey INNER JOIN
		pStyleHeader WITH (NOLOCK) ON pStyleQuoteItem.StyleID = pStyleHeader.StyleID
	WHERE (pStyleHeader.Active = 1) AND (pStyleQuoteItem.StyleQuoteItemDueDate BETWEEN @StartDate AND @EndDate) AND  
		(pStyleQuoteItem.StyleQuoteItemStatusId = 0) AND (pStyleQuoteItem.TradePartnerID = @TradePartnerId) AND
		(pStyleQuoteItem.StyleQuoteItemShare = 1)
	
END 



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_ControlMaterialRequestWorkflowGroup_INSERT]'
GO
CREATE PROCEDURE [dbo].[spx_ControlMaterialRequestWorkflowGroup_INSERT](
	@MaterialRequestWorkflowID varchar(5),
	@CUser nvarchar(200), 
	@CDate datetime,
	@RequestMultiplier INT = 0
) 
AS 

DECLARE @counter int
SET @counter = 0
WHILE @counter < @RequestMultiplier
	BEGIN
		SET @counter = @counter + 1

		INSERT INTO pMaterialRequestWorkflowGroup (
			MaterialRequestWorkflowID, 
			CUser, 
			CDate, 
			MUser, 
			MDate) 
		VALUES
			(@MaterialRequestWorkflowID, 
			@CUser, 
			@CDate, 
			@CUser, 
			@CDate)
	END


SELECT * FROM pMaterialRequestWorkflowGroup


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcingQuoteItemTradePartner_INSERT]'
GO



/*
Comments:

#01 - Ryan Cabanas - August 19, 2009
	Burberry wants to set the value of 'pStyleQuoteItem.StyleQuoteItemCustomField26'
to 'pStyleCostingHeader.StyleCostingCustomField6'.  At the quote area, that field
currently is 'UK Wholesale'.  At the costing header, this field is currently
'Target Wholesale Price'.

#02 - Clayton Parker - August 25, 2009
	Burberry would like the Wholesale Target Margin(pStyleQuoteItem.StyleQuoteItemCustomField25)
in the quote to pull from the style costings Wholesale Margin at the costing header
(pStyleCostingHeader.StyleCostingCustomField5).
*/


ALTER PROCEDURE [dbo].[spx_StyleSourcingQuoteItemTradePartner_INSERT] (
@StyleQuoteItemID uniqueidentifier,
@StyleQuoteVariationID uniqueidentifier,
@TradePartnerVendorID uniqueidentifier,
@StyleColorID uniqueidentifier,
@StyleSourcingID  uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate datetime)
AS 

DECLARE @StyleQuoteId UNIQUEIDENTIFIER
SELECT @StyleQuoteId = StyleQuoteId FROM pStyleQuoteVariation WHERE StyleQuoteVariationId = @StyleQuoteVariationID  

DECLARE @StyleQuoteDueDate AS datetime
SELECT @StyleQuoteDueDate = StyleQuoteDueDate FROM pStyleQuote WHERE StyleQuoteID = @StyleQuoteId

INSERT INTO dbo.pStyleQuoteItem (
		StyleQuoteItemID, StyleQuoteID, StyleQuotaDutyID, StyleQuoteItemStatusId, 
		TradePartnerID, TradePartnerVendorID, StyleCostingID, StyleCostingType, StyleID, 
        StyleDevelopmentID, StyleQuoteVariationId, 
		StyleCostingCustomField1, StyleCostingCustomField2, StyleCostingCustomField3, 
        StyleCostingCustomField4, StyleCostingCustomField5, StyleCostingCustomField6, StyleCostingCustomField7, StyleCostingCustomField8, 
        StyleCostingCustomField9, StyleCostingCustomField10, StyleCostingCustomField11, StyleCostingCustomField12, StyleCostingCustomField13, 
        StyleCostingCustomField14, StyleCostingCustomField15, StyleCostingCustomField16, StyleCostingCustomField17, StyleCostingCustomField18, 
        StyleCostingCustomField19, StyleCostingCustomField20, StyleCostingCustomField21, StyleCostingCustomField22, StyleCostingCustomField23, 
        StyleCostingCustomField24, StyleCostingCustomField25, StyleCostingCustomField26, StyleCostingCustomField27, StyleCostingCustomField28, 
        StyleCostingCustomField29, StyleCostingCustomField30, StyleCostingCustomField31, StyleCostingCustomField32, StyleCostingCustomField33, 
        StyleCostingCustomField34, StyleCostingCustomField35, 
		CUser, CDate, MUser, MDate, StyleCostingFreightTypeID, 
		StyleQuoteItemCustomField1, 
        StyleQuoteItemCustomField2, StyleQuoteItemCustomField3, StyleQuoteItemCustomField4, StyleQuoteItemCustomField5, StyleQuoteItemCustomField6, 
        StyleQuoteItemCustomField7, StyleQuoteItemCustomField8, StyleQuoteItemCustomField9, StyleQuoteItemCustomField10, 
        StyleQuoteItemCustomField11, StyleQuoteItemCustomField12, StyleQuoteItemCustomField13, StyleQuoteItemCustomField14, 
        StyleQuoteItemCustomField15, StyleQuoteItemCustomField16, StyleQuoteItemCustomField17, StyleQuoteItemCustomField18, 
        StyleQuoteItemCustomField19, StyleQuoteItemCustomField20, StyleQuoteItemCustomField21, StyleQuoteItemCustomField22, 
        StyleQuoteItemCustomField23, StyleQuoteItemCustomField24, StyleQuoteItemCustomField25, StyleQuoteItemDueDate,
		StyleColorID , StyleSourcingID 
) 
SELECT  @StyleQuoteItemID, StyleQuoteID, StyleQuotaDutyID, 0, 
		TradePartnerID, @TradePartnerVendorID, StyleCostingID, StyleCostingType, StyleID, 
		StyleDevelopmentID, @StyleQuoteVariationId,
		StyleCostingCustomField1, StyleCostingCustomField2, StyleCostingCustomField3, StyleCostingCustomField4, 
        StyleCostingCustomField5, StyleCostingCustomField6, StyleCostingCustomField7, StyleCostingCustomField8, StyleCostingCustomField9, 
        StyleCostingCustomField10, StyleCostingCustomField11, StyleCostingCustomField12, StyleCostingCustomField13, StyleCostingCustomField14, 
        StyleCostingCustomField15, StyleCostingCustomField16, StyleCostingCustomField17, StyleCostingCustomField18, StyleCostingCustomField19, 
        StyleCostingCustomField20, StyleCostingCustomField21, StyleCostingCustomField22, StyleCostingCustomField23, StyleCostingCustomField24, 
        StyleCostingCustomField25, StyleCostingCustomField26, StyleCostingCustomField27, StyleCostingCustomField28, StyleCostingCustomField29, 
        StyleCostingCustomField30, StyleCostingCustomField31, StyleCostingCustomField32, StyleCostingCustomField33, StyleCostingCustomField34, 
        StyleCostingCustomField35, 
		@CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate, StyleCostingFreightTypeID, 
		StyleQuoteItemCustomField1, 
        StyleQuoteItemCustomField2, StyleQuoteItemCustomField3, StyleQuoteItemCustomField4, StyleQuoteItemCustomField5, StyleQuoteItemCustomField6, 
        StyleQuoteItemCustomField7, StyleQuoteItemCustomField8, StyleQuoteItemCustomField9, StyleQuoteItemCustomField10, 
        StyleQuoteItemCustomField11, StyleQuoteItemCustomField12, StyleQuoteItemCustomField13, StyleQuoteItemCustomField14, 
        StyleQuoteItemCustomField15, StyleQuoteItemCustomField16, StyleQuoteItemCustomField17, StyleQuoteItemCustomField18, 
        StyleQuoteItemCustomField19, StyleQuoteItemCustomField20, StyleQuoteItemCustomField21, StyleQuoteItemCustomField22, 
        StyleQuoteItemCustomField23, StyleQuoteItemCustomField24, StyleQuoteItemCustomField25, @StyleQuoteDueDate,
		@StyleColorID AS StyleColorID, @StyleSourcingID AS StyleSourcingID
FROM    pStyleQuoteVariation
WHERE  (StyleQuoteVariationID = @StyleQuoteVariationID)

INSERT INTO pStyleQuoteItemVersion (
	StyleQuoteItemVersionID, Version, StyleQuoteItemID, StyleQuoteItemNo, StyleQuoteItemShare, StyleQuoteItemStatusId, StyleQuoteVariationId, StyleQuoteID, 
	StyleQuotaDutyID, StyleDevelopmentID, StyleID, StyleQuoteTradePartnerID, StyleCostingID, StyleCostingType, StyleCostingFreightTypeID, TradePartnerID, 
	TradePartnerVendorID, StyleQuoteItemDueDate, StyleQuoteItemApprovedBy, StyleQuoteItemApprovedDate, StyleQuoteItemCustomField1, 
	StyleQuoteItemCustomField2, StyleQuoteItemCustomField3, StyleQuoteItemCustomField4, StyleQuoteItemCustomField5, StyleQuoteItemCustomField6, 
	StyleQuoteItemCustomField7, StyleQuoteItemCustomField8, StyleQuoteItemCustomField9, StyleQuoteItemCustomField10, StyleQuoteItemCustomField11, 
	StyleQuoteItemCustomField12, StyleQuoteItemCustomField13, StyleQuoteItemCustomField14, StyleQuoteItemCustomField15, StyleQuoteItemCustomField16, 
	StyleQuoteItemCustomField17, StyleQuoteItemCustomField18, StyleQuoteItemCustomField19, StyleQuoteItemCustomField20, StyleQuoteItemCustomField21, 
	StyleQuoteItemCustomField22, StyleQuoteItemCustomField23, StyleQuoteItemCustomField24, StyleQuoteItemCustomField25, StyleQuoteItemCustomField26, 
	StyleQuoteItemCustomField27, StyleQuoteItemCustomField28, StyleQuoteItemCustomField29, StyleQuoteItemCustomField30, StyleQuoteItemNotes, 
	StyleCostingCustomField1, StyleCostingCustomField2, StyleCostingCustomField3, StyleCostingCustomField4, StyleCostingCustomField5, StyleCostingCustomField6, 
	StyleCostingCustomField7, StyleCostingCustomField8, StyleCostingCustomField9, StyleCostingCustomField10, StyleCostingCustomField11, 
	StyleCostingCustomField12, StyleCostingCustomField13, StyleCostingCustomField14, StyleCostingCustomField15, StyleCostingCustomField16, 
	StyleCostingCustomField17, StyleCostingCustomField18, StyleCostingCustomField19, StyleCostingCustomField20, StyleCostingCustomField21, 
	StyleCostingCustomField22, StyleCostingCustomField23, StyleCostingCustomField24, StyleCostingCustomField25, StyleCostingCustomField26, 
	StyleCostingCustomField27, StyleCostingCustomField28, StyleCostingCustomField29, StyleCostingCustomField30, StyleCostingCustomField31, 
	StyleCostingCustomField32, StyleCostingCustomField33, StyleCostingCustomField34, StyleCostingCustomField35, CUser, CDate, MUser, MDate, QuoteFolderSort, 
	AgentView, StyleColorID, StyleSourcingID)
SELECT NEWID(),1 ,StyleQuoteItemID, StyleQuoteItemNo, StyleQuoteItemShare, StyleQuoteItemStatusId, StyleQuoteVariationId, StyleQuoteID, 
      StyleQuotaDutyID, StyleDevelopmentID, StyleID, StyleQuoteTradePartnerID, StyleCostingID, StyleCostingType, StyleCostingFreightTypeID, TradePartnerID, 
      TradePartnerVendorID, StyleQuoteItemDueDate, StyleQuoteItemApprovedBy, StyleQuoteItemApprovedDate, StyleQuoteItemCustomField1, 
      StyleQuoteItemCustomField2, StyleQuoteItemCustomField3, StyleQuoteItemCustomField4, StyleQuoteItemCustomField5, StyleQuoteItemCustomField6, 
      StyleQuoteItemCustomField7, StyleQuoteItemCustomField8, StyleQuoteItemCustomField9, StyleQuoteItemCustomField10, StyleQuoteItemCustomField11, 
      StyleQuoteItemCustomField12, StyleQuoteItemCustomField13, StyleQuoteItemCustomField14, StyleQuoteItemCustomField15, StyleQuoteItemCustomField16, 
      StyleQuoteItemCustomField17, StyleQuoteItemCustomField18, StyleQuoteItemCustomField19, StyleQuoteItemCustomField20, StyleQuoteItemCustomField21, 
      StyleQuoteItemCustomField22, StyleQuoteItemCustomField23, StyleQuoteItemCustomField24, StyleQuoteItemCustomField25, StyleQuoteItemCustomField26, 
      StyleQuoteItemCustomField27, StyleQuoteItemCustomField28, StyleQuoteItemCustomField29, StyleQuoteItemCustomField30, StyleQuoteItemNotes, 
      StyleCostingCustomField1, StyleCostingCustomField2, StyleCostingCustomField3, StyleCostingCustomField4, StyleCostingCustomField5, StyleCostingCustomField6, 
      StyleCostingCustomField7, StyleCostingCustomField8, StyleCostingCustomField9, StyleCostingCustomField10, StyleCostingCustomField11, 
      StyleCostingCustomField12, StyleCostingCustomField13, StyleCostingCustomField14, StyleCostingCustomField15, StyleCostingCustomField16, 
      StyleCostingCustomField17, StyleCostingCustomField18, StyleCostingCustomField19, StyleCostingCustomField20, StyleCostingCustomField21, 
      StyleCostingCustomField22, StyleCostingCustomField23, StyleCostingCustomField24, StyleCostingCustomField25, StyleCostingCustomField26, 
      StyleCostingCustomField27, StyleCostingCustomField28, StyleCostingCustomField29, StyleCostingCustomField30, StyleCostingCustomField31, 
      StyleCostingCustomField32, StyleCostingCustomField33, StyleCostingCustomField34, StyleCostingCustomField35, CUser, CDate, MUser, MDate, QuoteFolderSort, 
      AgentView, StyleColorID, StyleSourcingID FROM pStyleQuoteItem a
WHERE a.StyleQuoteItemID = @StyleQuoteItemID


BEGIN

	UPDATE a
	SET a.StyleQuoteItemCustomField5 = b.Country
	FROM pStyleQuoteItem a LEFT OUTER JOIN uTradePartnerVendor b ON
	a.TradePartnerVendorID = b.TradePartnerVendorID
	WHERE a.StyleQuoteItemID = @StyleQuoteItemID

END


--Comment #01
/*Set the 'UK Wholesale' at the quote to the 'Target Wholesale Price' at costing header.*/
UPDATE pStyleQuoteItem
SET pStyleQuoteItem.StyleQuoteItemCustomField26 = pStyleCostingHeader.StyleCostingCustomField6		--Comment #01
	,pStyleQuoteItem.StyleQuoteItemCustomField25 = pStyleCostingHeader.StyleCostingCustomField5		--Comment #02
FROM pStyleQuoteItem
	LEFT OUTER JOIN pStyleCostingHeader ON	pStyleQuoteItem.StyleID = pStyleCostingHeader.StyleID
WHERE pStyleQuoteItem.StyleQuoteItemID = @StyleQuoteItemID




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialTradePartnerByMaterial_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_MaterialTradePartnerByMaterial_SELECT] (
@MaterialID UNIQUEIDENTIFIER
)
AS

SELECT  DISTINCT pMaterialTradePartner.TradePartnerID ,uTradePartner.TradePartnerName  
  FROM pMaterialTradePartner INNER JOIN  uTradePartner  ON pMaterialTradePartner.TradePartnerID = uTradePartner.TradePartnerID 
  INNER JOIN uTradePartnerVendor  ON  uTradePartner.TradePartnerID = uTradePartnerVendor.TradePartnerID 
  WHERE MaterialId = @MaterialId  AND uTradePartnerVendor.Active <> 0  ORDER BY uTradePartner.TradePartnerName


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LineFolder_INSERT]'
GO





CREATE  PROCEDURE [dbo].[spx_LineFolder_INSERT]
(
@LineFolderID uniqueidentifier,
@CreatedDate datetime,
@CreatedBy nvarchar(200)
)
AS 

INSERT INTO pLineFolder  (LineFolderID, CUser, CDate, MUser, MDate, MChange)  
                VALUES  (@LineFolderID, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate, 1)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteCalendarVendorShared_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_StyleQuoteCalendarVendorShared_INSERT]
(@TradePartnerId varchar(50),
@TradePartnerVendorId varchar(50),
@CalendarId varchar(50),
@StartDate datetime,
@EndDate datetime)
AS 

BEGIN
	INSERT INTO pStyleCalendarTemp
		(CalendarId, PKeyId, CalendarLinkId, CalendarLinkSubId, CalendarDate, CalendarType, CalendarStatus, CalendarDescription, CalendarView)
	SELECT     @CalendarId AS CalendarId, pStyleQuoteItem.StyleQuoteItemID, pStyleHeader.StyleID, pStyleHeader.DevelopmentID, 
		pStyleQuoteItem.StyleQuoteItemApprovedDate, 'Quote' AS CalendarType, pStyleQuoteItem.StyleQuoteItemStatusId,
		'<b>A: </b>' + uTradePartner.TradePartnerCode + ' / <b>V: </b>' + uTradePartnerVendor.VendorCode + '<BR>' + pStyleHeader.StyleNo + ' (' + pStyleHeader.SizeClass + ') ' + pStyleHeader.Description AS CalendarDescription, 0
	FROM   pStyleQuote WITH (NOLOCK) INNER JOIN
		pStyleQuoteItem WITH (NOLOCK) ON pStyleQuote.StyleQuoteID = pStyleQuoteItem.StyleQuoteID INNER JOIN
		uTradePartnerVendor WITH (NOLOCK) ON pStyleQuoteItem.TradePartnerVendorID = uTradePartnerVendor.TradePartnerVendorID INNER JOIN
		uTradePartner WITH (NOLOCK) ON pStyleQuote.TradePartnerID = uTradePartner.TradePartnerID INNER JOIN
		pStyleQuoteItemStatus WITH (NOLOCK) ON pStyleQuoteItem.StyleQuoteItemStatusId = pStyleQuoteItemStatus.CustomKey INNER JOIN
		pStyleHeader WITH (NOLOCK) ON pStyleQuoteItem.StyleID = pStyleHeader.StyleID
	WHERE (pStyleHeader.Active = 1) AND (pStyleQuoteItem.StyleQuoteItemApprovedDate BETWEEN @StartDate AND @EndDate) AND 
		(pStyleQuoteItem.StyleQuoteItemStatusId <> 0) AND (pStyleQuoteItem.TradePartnerID = @TradePartnerId) AND
		(pStyleQuoteItem.TradePartnerVendorID = @TradePartnerVendorID) AND (pStyleQuoteItem.StyleQuoteItemShare = 1)
	

END 

BEGIN
	INSERT INTO pStyleCalendarTemp
		(CalendarId, PKeyId, CalendarLinkId, CalendarLinkSubId, CalendarDate, CalendarType, CalendarStatus, CalendarDescription, CalendarView)
	SELECT     @CalendarId AS CalendarId, pStyleQuoteItem.StyleQuoteItemID, pStyleHeader.StyleID, pStyleHeader.DevelopmentID, 
		pStyleQuoteItem.StyleQuoteItemDueDate, 'Quote' AS CalendarType, pStyleQuoteItem.StyleQuoteItemStatusId,
		'<b>A: </b>' + uTradePartner.TradePartnerCode + ' / <b>V: </b>' + uTradePartnerVendor.VendorCode + '<BR>' + pStyleHeader.StyleNo + ' (' + pStyleHeader.SizeClass + ') ' + pStyleHeader.Description AS CalendarDescription, 0
	FROM   pStyleQuote WITH (NOLOCK) INNER JOIN
		pStyleQuoteItem WITH (NOLOCK) ON pStyleQuote.StyleQuoteID = pStyleQuoteItem.StyleQuoteID INNER JOIN
		uTradePartnerVendor WITH (NOLOCK) ON pStyleQuoteItem.TradePartnerVendorID = uTradePartnerVendor.TradePartnerVendorID INNER JOIN
		uTradePartner WITH (NOLOCK) ON pStyleQuote.TradePartnerID = uTradePartner.TradePartnerID INNER JOIN
		pStyleQuoteItemStatus WITH (NOLOCK) ON pStyleQuoteItem.StyleQuoteItemStatusId = pStyleQuoteItemStatus.CustomKey INNER JOIN
		pStyleHeader WITH (NOLOCK) ON pStyleQuoteItem.StyleID = pStyleHeader.StyleID
	WHERE (pStyleHeader.Active = 1) AND (pStyleQuoteItem.StyleQuoteItemDueDate BETWEEN @StartDate AND @EndDate) AND  
		(pStyleQuoteItem.StyleQuoteItemStatusId = 0) AND (pStyleQuoteItem.TradePartnerID = @TradePartnerId) AND
		(pStyleQuoteItem.TradePartnerVendorID = @TradePartnerVendorID) AND (pStyleQuoteItem.StyleQuoteItemShare = 1)
	
END 



























GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialComment_DELETE]'
GO

create PROCEDURE [dbo].[spx_MaterialComment_DELETE](
	@MaterialCommentID uniqueidentifier,
	@CreatedBy nvarchar(200),
	@CreatedDate datetime
)
AS 

DELETE FROM pMaterialComment WHERE MaterialCommentID = @MaterialCommentID

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_ControlMaterialRequestWorkflowGroupID_SELECT]'
GO
CREATE PROCEDURE [dbo].[spx_ControlMaterialRequestWorkflowGroupID_SELECT](
	@MaterialRequestWorkflowID varchar(5)
) 
AS 

IF (SELECT COUNT(*) FROM pMaterialRequestWorkflowGroup 
WHERE MaterialRequestWorkflowID = @MaterialRequestWorkflowID) = 0
	BEGIN

		DECLARE @MaterialRequestWorkflowGroupID uniqueidentifier
		SET @MaterialRequestWorkflowGroupID = newid()
		INSERT INTO pMaterialRequestWorkflowGroup(MaterialRequestWorkflowGroupID, MaterialRequestWorkflowID, MaterialRequestWorkflowGroup)
			VALUES(@MaterialRequestWorkflowGroupID, @MaterialRequestWorkflowID, 'Default')

		UPDATE pMaterialRequestWorkflowItem SET MaterialRequestWorkflowGroupID = @MaterialRequestWorkflowGroupID 
		WHERE MaterialRequestWorkflowID = @MaterialRequestWorkflowID 
	
		SELECT TOP 1 MaterialRequestWorkflowGroupID FROM pMaterialRequestWorkflowGroup 
		WHERE MaterialRequestWorkflowID = @MaterialRequestWorkflowID
		ORDER BY MaterialRequestWorkflowGroup 

	END
ELSE
	BEGIN

		SELECT TOP 1 MaterialRequestWorkflowGroupID FROM pMaterialRequestWorkflowGroup 
		WHERE MaterialRequestWorkflowID = @MaterialRequestWorkflowID
		ORDER BY MaterialRequestWorkflowGroup 

	END




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_QuoteFolderUser_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_QuoteFolderUser_SELECT]
(@QuoteFolderID uniqueidentifier,
@TradePartner int)
AS SELECT     dbo.Users.*
FROM         dbo.Users WITH (NOLOCK)
WHERE     (TeamID IN
                          (SELECT   TeamID
                            FROM    pQuoteTeam WITH (NOLOCK)
                            WHERE      QuoteID = @QuoteFolderID AND TradePartner =@Tradepartner))



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteCalendarWeek_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_StyleQuoteCalendarWeek_INSERT]
(@CalendarId varchar(50),
@StartDate datetime,
@EndDate datetime)
AS 


BEGIN
	INSERT INTO dbo.pStyleCalendarTemp
		(CalendarId, PKeyId, CalendarLinkId, CalendarLinkSubId, CalendarDate, CalendarType, CalendarStatus, CalendarDescription)
	SELECT     @CalendarId AS CalendarId, dbo.pStyleQuoteItem.StyleQuoteItemID, dbo.pStyleHeader.StyleID, dbo.pStyleHeader.DevelopmentID, 
		pStyleQuoteItem.StyleQuoteItemApprovedDate, 'Quote' AS CalendarType, pStyleQuoteItem.StyleQuoteItemStatusId,
		'<b>A: </b>' + uTradePartner.TradePartnerCode + ' / <b>V: </b>' + uTradePartnerVendor.VendorCode + '<BR>' + dbo.pStyleHeader.StyleNo + ' (' + dbo.pStyleHeader.SizeClass + ') ' + dbo.pStyleHeader.Description AS CalendarDescription
	FROM   dbo.pStyleQuote WITH (NOLOCK) INNER JOIN
		dbo.pStyleQuoteItem WITH (NOLOCK) ON dbo.pStyleQuote.StyleQuoteID = dbo.pStyleQuoteItem.StyleQuoteID INNER JOIN
		dbo.uTradePartnerVendor WITH (NOLOCK) ON dbo.pStyleQuoteItem.TradePartnerVendorID = dbo.uTradePartnerVendor.TradePartnerVendorID INNER JOIN
		dbo.uTradePartner WITH (NOLOCK) ON dbo.pStyleQuote.TradePartnerID = dbo.uTradePartner.TradePartnerID INNER JOIN
		dbo.pStyleQuoteItemStatus WITH (NOLOCK) ON dbo.pStyleQuoteItem.StyleQuoteItemStatusId = dbo.pStyleQuoteItemStatus.CustomKey INNER JOIN
		dbo.pStyleHeader WITH (NOLOCK) ON dbo.pStyleQuoteItem.StyleID = dbo.pStyleHeader.StyleID
	WHERE (dbo.pStyleHeader.Active = 1) AND (pStyleQuoteItem.StyleQuoteItemApprovedDate BETWEEN @StartDate AND @EndDate) AND  (pStyleQuoteItem.StyleQuoteItemStatusId <> 0)
	
END 


BEGIN
	INSERT INTO dbo.pStyleCalendarTemp
		(CalendarId, PKeyId, CalendarLinkId, CalendarLinkSubId, CalendarDate, CalendarType, CalendarStatus, CalendarDescription)
	SELECT     @CalendarId AS CalendarId, dbo.pStyleQuoteItem.StyleQuoteItemID, dbo.pStyleHeader.StyleID, dbo.pStyleHeader.DevelopmentID, 
		pStyleQuote.StyleQuoteDueDate, 'Quote' AS CalendarType, pStyleQuoteItem.StyleQuoteItemStatusId,
		'<b>A: </b>' + uTradePartner.TradePartnerCode + ' / <b>V: </b>' + uTradePartnerVendor.VendorCode + '<BR>' + dbo.pStyleHeader.StyleNo + ' (' + dbo.pStyleHeader.SizeClass + ') ' + dbo.pStyleHeader.Description AS CalendarDescription
	FROM   dbo.pStyleQuote WITH (NOLOCK) INNER JOIN
		dbo.pStyleQuoteItem WITH (NOLOCK) ON dbo.pStyleQuote.StyleQuoteID = dbo.pStyleQuoteItem.StyleQuoteID INNER JOIN
		dbo.uTradePartnerVendor WITH (NOLOCK) ON dbo.pStyleQuoteItem.TradePartnerVendorID = dbo.uTradePartnerVendor.TradePartnerVendorID INNER JOIN
		dbo.uTradePartner WITH (NOLOCK) ON dbo.pStyleQuote.TradePartnerID = dbo.uTradePartner.TradePartnerID INNER JOIN
		dbo.pStyleQuoteItemStatus WITH (NOLOCK) ON dbo.pStyleQuoteItem.StyleQuoteItemStatusId = dbo.pStyleQuoteItemStatus.CustomKey INNER JOIN
		dbo.pStyleHeader WITH (NOLOCK) ON dbo.pStyleQuoteItem.StyleID = dbo.pStyleHeader.StyleID
	WHERE (dbo.pStyleHeader.Active = 1) AND (dbo.pStyleQuote.StyleQuoteDueDate BETWEEN @StartDate AND @EndDate) AND  (pStyleQuoteItem.StyleQuoteItemStatusId = 0)
	
END 






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialComment_INSERT]'
GO

create PROCEDURE [dbo].[spx_MaterialComment_INSERT](
	@MaterialID uniqueidentifier,
	@MaterialComment nvarchar(4000),
	@CreatedBy nvarchar(200),
	@CreatedDate datetime,
	@CTeamId varchar(40)
)
AS 

INSERT INTO pMaterialComment (MaterialID, CUser, CDate, MUser, MDate, MaterialComment, CTeamID) 
        VALUES (@MaterialID, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate, @MaterialComment, @CTeamID)

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_ControlMaterialRequestWorkflowItem_INSERT]'
GO
CREATE PROCEDURE [dbo].[spx_ControlMaterialRequestWorkflowItem_INSERT](
	@MaterialRequestWorkflowItemID uniqueidentifier,
	@MaterialRequestWorkflowID varchar(5),
	@MaterialRequestWorkflowGroupID uniqueidentifier,
	@CUser nvarchar(200), 
	@CDate datetime,
	@RequestMultiplier INT = 0
) 
AS 

DECLARE @counter int
SET @counter = 0
WHILE @counter < @RequestMultiplier
	BEGIN
		SET @counter = @counter + 1

		INSERT INTO pMaterialRequestWorkflowItem (
			MaterialRequestWorkflowItemID,
			MaterialRequestWorkflowID, 
			MaterialRequestWorkflowGroupID, 
			CUser, 
			CDate, 
			MUser, 
			MDate) 
		VALUES
			(
			@MaterialRequestWorkflowItemID,
			@MaterialRequestWorkflowID, 
			@MaterialRequestWorkflowGroupID, 
			@CUser, 
			@CDate, 
			@CUser, 
			@CDate)
	END


SELECT * FROM pMaterialRequestWorkflowItem


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_QuoteTeam_UPDATE]'
GO

ALTER PROCEDURE [dbo].[spx_QuoteTeam_UPDATE]
(@TeamID nvarchar(50),
@QuoteFolderItemID nvarchar(50),
@Subject nvarchar(50),
@Message ntext,
@QuoteFolderID nvarchar(50))
AS 


IF (SELECT COUNT(*)  FROM pQuoteTeam WITH (NOLOCK) WHERE TeamID = @TeamID AND QuoteFolderID = @QuoteFolderID )  = 0


INSERT INTO dbo.pQuoteTeam
                      (ManagerID, TeamID, QuoteID, TradePartner, QuoteFolderID,Subject,Message)
VALUES     ('00000000-0000-0000-0000-000000000000', @TeamID, @QuoteFolderItemID, 1, @QuoteFolderID, @Subject, @Message)
                        

ELSE

  UPDATE    dbo.pQuoteTeam
                           SET              TeamID = @TeamID, QuoteID = @QuoteFolderItemID, TradePartner = 1, Subject = @Subject, Message = @Message, 
                                                  QuoteFolderID = @QuoteFolderID



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Style_PreCosting_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.
*/


ALTER  procedure [dbo].[rpx_Style_PreCosting_SELECT]
    @StyleType int = null,
    @Season varchar(200) = null,
    @Year varchar(10) = null,
    @ProductCategory varchar(50) = null
as


SELECT     sh.StyleNo, sh.Description, sh.SizeClass, sh.SizeRange, sc.StyleCostingCustomField2 AS Weight, sc.StyleCostingCustomField1 AS TargetRetail, 
                      sc.StyleCostingCustomField3 AS TargetMargin, sc.StyleCostingCustomField8 AS Royalty, sc.StyleCostingCustomField4 AS MiscCost, 
                      sc.StyleCostingCustomField18 AS Units, sct.StyleCostingType AS CostingType, sc.StyleCostingCustomField14 AS TargetFirstCost, 
                      sc.StyleCostingCustomField15 AS FirstCost, sc.StyleCostingCustomField11 AS DutyPct, scd.DutyCategory AS QuotaCategory, 
                      sc.StyleCostingCustomField9 AS Commission, sh.StyleType, sc.StyleCostingTypeID, sh.CustomField5 AS StyleCategory,
					  dbo.fnx_GetStreamingImagePath(i.ImageID, i.[Version]) AS FilePath	--Comment #01
FROM         pStyleCostingDuty AS scd RIGHT OUTER JOIN
                      pStyleCostingType AS sct INNER JOIN
                      pStyleCosting AS sc ON sct.StyleCostingTypeID = sc.StyleCostingTypeID INNER JOIN
                      pStyleHeader AS sh ON sc.StyleID = sh.StyleID ON scd.DutyId = sc.StyleQuotaDutyID LEFT OUTER JOIN
                      hImage AS i ON sh.DesignSketchID = i.ImageID AND sh.DesignSketchVersion = i.Version
where (@StyleType is null or sh.StyleType = @StyleType)
and (@Season is null or sh.CustomField2 = @Season)
and (@Year is null or sh.CustomField4 = @Year)
and (@ProductCategory is null or sh.CustomField5 = @ProductCategory)
ORDER BY sh.CustomField5





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteCalendarWeek_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_StyleQuoteCalendarWeek_SELECT]
(@CalendarId varchar(50),
@StartDate datetime,
@EndDate datetime)
AS 


BEGIN
	INSERT INTO dbo.pStyleCalendarTemp
		(CalendarId, PKeyId, CalendarLinkId, CalendarLinkSubId, CalendarDate, CalendarType, CalendarStatus, CalendarDescription)
	SELECT     @CalendarId AS CalendarId, dbo.pStyleQuoteItem.StyleQuoteItemID, dbo.pStyleHeader.StyleID, dbo.pStyleHeader.DevelopmentID, 
		pStyleQuoteItem.StyleQuoteItemApprovedDate, 'Quote' AS CalendarType, pStyleQuoteItem.StyleQuoteItemStatusId,
		dbo.pStyleHeader.StyleNo + ' (' + dbo.pStyleHeader.SizeClass + ') ' + dbo.pStyleHeader.Description AS CalendarDescription
	FROM   dbo.pStyleQuote WITH (NOLOCK) INNER JOIN
		dbo.pStyleQuoteItem WITH (NOLOCK) ON dbo.pStyleQuote.StyleQuoteID = dbo.pStyleQuoteItem.StyleQuoteID INNER JOIN
		dbo.uTradePartnerVendor WITH (NOLOCK) ON dbo.pStyleQuoteItem.TradePartnerVendorID = dbo.uTradePartnerVendor.TradePartnerVendorID INNER JOIN
		dbo.uTradePartner WITH (NOLOCK) ON dbo.pStyleQuote.TradePartnerID = dbo.uTradePartner.TradePartnerID INNER JOIN
		dbo.pStyleQuoteItemStatus WITH (NOLOCK) ON dbo.pStyleQuoteItem.StyleQuoteItemStatusId = dbo.pStyleQuoteItemStatus.CustomKey INNER JOIN
		dbo.pStyleHeader WITH (NOLOCK) ON dbo.pStyleQuoteItem.StyleID = dbo.pStyleHeader.StyleID
	WHERE (dbo.pStyleHeader.Active = 1) AND (pStyleQuoteItem.StyleQuoteItemApprovedDate BETWEEN @StartDate AND @EndDate) AND  (pStyleQuoteItem.StyleQuoteItemStatusId <> 0)
	
END 


BEGIN
	INSERT INTO dbo.pStyleCalendarTemp
		(CalendarId, PKeyId, CalendarLinkId, CalendarLinkSubId, CalendarDate, CalendarType, CalendarStatus, CalendarDescription)
	SELECT     @CalendarId AS CalendarId, dbo.pStyleQuoteItem.StyleQuoteItemID, dbo.pStyleHeader.StyleID, dbo.pStyleHeader.DevelopmentID, 
		pStyleQuote.StyleQuoteDueDate, 'Quote' AS CalendarType, pStyleQuoteItem.StyleQuoteItemStatusId,
		dbo.pStyleHeader.StyleNo + ' (' + dbo.pStyleHeader.SizeClass + ') ' + dbo.pStyleHeader.Description AS CalendarDescription
	FROM   dbo.pStyleQuote WITH (NOLOCK) INNER JOIN
		dbo.pStyleQuoteItem WITH (NOLOCK) ON dbo.pStyleQuote.StyleQuoteID = dbo.pStyleQuoteItem.StyleQuoteID INNER JOIN
		dbo.uTradePartnerVendor WITH (NOLOCK) ON dbo.pStyleQuoteItem.TradePartnerVendorID = dbo.uTradePartnerVendor.TradePartnerVendorID INNER JOIN
		dbo.uTradePartner WITH (NOLOCK) ON dbo.pStyleQuote.TradePartnerID = dbo.uTradePartner.TradePartnerID INNER JOIN
		dbo.pStyleQuoteItemStatus WITH (NOLOCK) ON dbo.pStyleQuoteItem.StyleQuoteItemStatusId = dbo.pStyleQuoteItemStatus.CustomKey INNER JOIN
		dbo.pStyleHeader WITH (NOLOCK) ON dbo.pStyleQuoteItem.StyleID = dbo.pStyleHeader.StyleID
	WHERE (dbo.pStyleHeader.Active = 1) AND (dbo.pStyleQuote.StyleQuoteDueDate BETWEEN @StartDate AND @EndDate) AND  (pStyleQuoteItem.StyleQuoteItemStatusId = 0)
	
END 


BEGIN

	SELECT * FROM pstylecalendarTemp WITH (NOLOCK) WHERE CalendarId = @CalendarId

END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialComment_SELECT]'
GO
create PROCEDURE [dbo].[spx_MaterialComment_SELECT](@MaterialID uniqueidentifier)
AS 

SELECT * FROM pMaterialComment WHERE MaterialID = @MaterialID ORDER BY MDate DESC

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_DeskFolder_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_DeskFolder_SELECT]
AS 

BEGIN
	SELECT DeskFolderId, DeskFolderName FROM cDesktopFolder
END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcingQuoteVariation_CHECK_INSERT]'
GO
/*
'***********************************************************************
' Object name	   : spx_StyleSourcingQuoteVariation_CHECK_INSERT
' Author           : 
' Created          : 
'
' Last Modified By : Artemio Gomez
' Last Modified On : 12-11-2009
' Description      : Insert the StyleSourcing quote variation,
' Comments		   :
		#01  -	Artemio Gomez - December 11, 2009
				Add Parameter @OUTPUT INT with default = 1
				Add Parameter @StyleQuoteVariationID UNIQUEIDENTIFIER as an Output parameter
' Copyright        : (c) Yunique Solutions, Inc. All rights reserved.
'***********************************************************************
*/

ALTER PROCEDURE [dbo].[spx_StyleSourcingQuoteVariation_CHECK_INSERT] (
@StyleCostingID UNIQUEIDENTIFIER,
@StyleID UNIQUEIDENTIFIER,
@StyleQuoteID UNIQUEIDENTIFIER,
@StyleDevelopmentID UNIQUEIDENTIFIER,
@TradePartnerID UNIQUEIDENTIFIER,
@CreatedBy nvarchar(200),
@CreatedDate DATETIME,
@OUTPUT INT = 1,
@StyleQuoteVariationID UNIQUEIDENTIFIER = NULL OUTPUT
)
AS

DECLARE @TradePartnerClass varchar(50)
DECLARE @TradePartnerCommission decimal(19,3) 
DECLARE @TradePartnerVendorCountry varchar(50)
DECLARE @TradePartnerState varchar(50)
DECLARE @TradePartnerCountry varchar(50)

--DECLARE @StyleQuoteVariationID AS UNIQUEIDENTIFIER 

SELECT @StyleQuoteVariationID = StyleQuoteVariationID 
FROM  dbo.pStyleQuoteVariation  
WHERE StyleCostingID = @StyleCostingID 
AND StyleID =  @StyleID 
AND StyleQuoteID = @StyleQuoteID  



IF  @StyleQuoteVariationID IS NULL 
BEGIN 

	SET @StyleQuoteVariationID  = NEWID() 

	SELECT @TradePartnerClass = TradePartnerClass, 
			@TradePartnerCommission = TradePartnerCommision, 
			@TradePartnerState = State,
			@TradePartnerCountry = Country 
	FROM uTradePartner 
	WHERE TradePartnerID = @TradePartnerID
	
	INSERT INTO dbo.pStyleQuoteVariation
	    (StyleQuoteVariationID, StyleCostingID, StyleID, StyleCostingType, StyleCostingFreightTypeID, StyleQuotaDutyID, StyleCostingCustomField1, StyleCostingCustomField2, 
	    StyleCostingCustomField3, StyleCostingCustomField4, StyleCostingCustomField5, StyleCostingCustomField6, StyleCostingCustomField7, 
	    StyleCostingCustomField8, StyleCostingCustomField9, StyleCostingCustomField10, StyleCostingCustomField11, StyleCostingCustomField12, 
	    StyleCostingCustomField13, StyleCostingCustomField14, StyleCostingCustomField15, StyleCostingCustomField16, StyleCostingCustomField17, 
	    StyleCostingCustomField18, StyleCostingCustomField19, StyleCostingCustomField20, StyleCostingCustomField21, StyleCostingCustomField22, 
	    StyleCostingCustomField23, StyleCostingCustomField24, StyleCostingCustomField25, StyleCostingCustomField26, StyleCostingCustomField27, 
	    StyleCostingCustomField28, StyleCostingCustomField29, StyleCostingCustomField30, StyleCostingCustomField31, StyleCostingCustomField32, 
	    StyleCostingCustomField33, StyleCostingCustomField34, StyleCostingCustomField35, StyleQuoteID, StyleDevelopmentID, TradePartnerID, CUser, 
	    CDate, MUser, MDate)
	SELECT     @StyleQuoteVariationID AS StyleQuoteVariationID, StyleCostingID, StyleID, StyleCostingTypeID, StyleCostingFreightTypeID, StyleQuotaDutyID, StyleCostingCustomField1, StyleCostingCustomField2, 
	    StyleCostingCustomField3, StyleCostingCustomField4, StyleCostingCustomField5, StyleCostingCustomField6, StyleCostingCustomField7, 
	    StyleCostingCustomField8, StyleCostingCustomField9, StyleCostingCustomField10, StyleCostingCustomField11, StyleCostingCustomField12, 
	    StyleCostingCustomField13, StyleCostingCustomField14, StyleCostingCustomField15, StyleCostingCustomField16, StyleCostingCustomField17, 
	    StyleCostingCustomField18, StyleCostingCustomField19, StyleCostingCustomField20, StyleCostingCustomField21, StyleCostingCustomField22, 
	    StyleCostingCustomField23, StyleCostingCustomField24, StyleCostingCustomField25, StyleCostingCustomField26, StyleCostingCustomField27, 
	    StyleCostingCustomField28, StyleCostingCustomField29, StyleCostingCustomField30, StyleCostingCustomField31, StyleCostingCustomField32, 
	    StyleCostingCustomField33, StyleCostingCustomField34, StyleCostingCustomField35, @StyleQuoteID, @StyleDevelopmentID, @TradePartnerID, 
	    @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate
	FROM         dbo.pStyleCosting
	WHERE	  StyleID = @StyleID AND StyleCostingID = @StyleCostingID
	
	
	IF @TradePartnerClass = 1
		BEGIN
			UPDATE pStyleQuoteVariation SET
				StyleCostingCustomField9 = @TradePartnerCommission,
				StyleQuoteItemCustomField3 = 2,
				StyleQuoteItemCustomField4 = @TradePartnerCountry,
				StyleQuoteItemCustomField5 = @TradePartnerCountry
			WHERE StyleID = @StyleID AND StyleCostingID = @StyleCostingID AND TradePartnerID=@TradePartnerID
		END
	ELSE
		BEGIN
			UPDATE pStyleQuoteVariation SET
				StyleCostingCustomField9 = @TradePartnerCommission,
				StyleQuoteItemCustomField3 = 2,
				StyleQuoteItemCustomField4 = @TradePartnerCountry,
				StyleQuoteItemCustomField5 = @TradePartnerState
			WHERE StyleID = @StyleID AND StyleCostingID = @StyleCostingID AND TradePartnerID=@TradePartnerID
		END

END

IF @OUTPUT = 1
	SELECT StyleQuoteVariationID  = @StyleQuoteVariationID


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialTradePartnerColors_ApplyToAllLogic_UPDATE]'
GO
SET QUOTED_IDENTIFIER OFF
GO

--  
-- Comment #01 - Clay Parker Dec 21 2009
--	         Added MaterialPrice field to the apply to all functionality.
--
-- Comment #02 - Clay Parker Dec 21 2009
--	         Removed MaterialTradeColor4 and MaterialTradeColor5 for Burberry. These fields need to 
--	         be different for each color.
-- Comment #03 - Artemio Gomez 3/18/2010
--	         Remove MaterialColorID = @MaterialColorID condition to be able to apply changes to "All Colors"	
--

CREATE PROCEDURE [dbo].[spx_MaterialTradePartnerColors_ApplyToAllLogic_UPDATE](
@MaterialTradePartnerID UNIQUEIDENTIFIER,
@MaterialTradePartnerColorID UNIQUEIDENTIFIER,
@MUser NVARCHAR(200),
@MDate DATETIME 
)
AS 

DECLARE @MaterialColorID UNIQUEIDENTIFIER 

DECLARE @MaterialPrice MONEY                 -- #01
DECLARE @MaterialTradeColor1 NVARCHAR(200)
DECLARE @MaterialTradeColor2 NVARCHAR(200)
DECLARE @MaterialTradeColor3 NVARCHAR(200)
--DECLARE @MaterialTradeColor4 NVARCHAR(200)   -- #02
--DECLARE @MaterialTradeColor5 NVARCHAR(200)   -- #02	
DECLARE @MaterialTradeColor6 NVARCHAR(200)
DECLARE @MaterialTradeColor7 NVARCHAR(200)
DECLARE @MaterialTradeColor8 NVARCHAR(200)
DECLARE @MaterialTradeColor9 NVARCHAR(200)
DECLARE @MaterialTradeColor10 NVARCHAR(200)
DECLARE @MaterialTradeColor11 NVARCHAR(200)
DECLARE @MaterialTradeColor12 NVARCHAR(200)
DECLARE @MaterialTradeColor13 NVARCHAR(200)
DECLARE @MaterialTradeColor14 NVARCHAR(200)
DECLARE @MaterialTradeColor15 NVARCHAR(200)
DECLARE @MaterialTradeColor16 NVARCHAR(200)
DECLARE @MaterialTradeColor17 NVARCHAR(200)
DECLARE @MaterialTradeColor18 NVARCHAR(200)
DECLARE @MaterialTradeColor19 NVARCHAR(200)
DECLARE @MaterialTradeColor20 NVARCHAR(200)
DECLARE @MaterialTradeColor21 NVARCHAR(200)
DECLARE @MaterialTradeColor22 NVARCHAR(200)
DECLARE @MaterialTradeColor23 NVARCHAR(200)
DECLARE @MaterialTradeColor24 NVARCHAR(200)
DECLARE @MaterialTradeColor25 NVARCHAR(200)


SELECT @MaterialColorID = MaterialColorID,
@MaterialPrice = MaterialPrice,			-- #01
@MaterialTradeColor1 = MaterialTradeColor1,
@MaterialTradeColor2 = MaterialTradeColor2,
@MaterialTradeColor3 = MaterialTradeColor3,
--@MaterialTradeColor4 = MaterialTradeColor4,	-- #02
--@MaterialTradeColor5 = MaterialTradeColor5,	-- #02
@MaterialTradeColor6 = MaterialTradeColor6,
@MaterialTradeColor7 = MaterialTradeColor7,
@MaterialTradeColor8 = MaterialTradeColor8,
@MaterialTradeColor9 = MaterialTradeColor9,
@MaterialTradeColor10 = MaterialTradeColor10,
@MaterialTradeColor11 = MaterialTradeColor11,
@MaterialTradeColor12 = MaterialTradeColor12,
@MaterialTradeColor13 = MaterialTradeColor13,
@MaterialTradeColor14 = MaterialTradeColor14,
@MaterialTradeColor15 = MaterialTradeColor15,
@MaterialTradeColor16 = MaterialTradeColor16,
@MaterialTradeColor17 = MaterialTradeColor17,
@MaterialTradeColor18 = MaterialTradeColor18,
@MaterialTradeColor19 = MaterialTradeColor19,
@MaterialTradeColor20 = MaterialTradeColor20,
@MaterialTradeColor21 = MaterialTradeColor21,
@MaterialTradeColor22 = MaterialTradeColor22,
@MaterialTradeColor23 = MaterialTradeColor23,
@MaterialTradeColor24 = MaterialTradeColor24,
@MaterialTradeColor25 = MaterialTradeColor25
FROM pMaterialTradePartnerColor 
WHERE MaterialTradePartnerColorID= @MaterialTradePartnerColorID


DECLARE @TradepartnerVendorID UNIQUEIDENTIFIER 
DECLARE @MaterialID UNIQUEIDENTIFIER 

SELECT @TradepartnerVendorID = TradepartnerVendorID, @MaterialID = MaterialID 
FROM pMaterialTradePartner
WHERE MaterialTradePartnerID = @MaterialTradePartnerID


UPDATE pMaterialTradePartnerColor SET 
MaterialPrice		= @MaterialPrice,			-- #01
MaterialTradeColor1 = @MaterialTradeColor1,
MaterialTradeColor2 = @MaterialTradeColor2,
MaterialTradeColor3 = @MaterialTradeColor3,
--MaterialTradeColor4 = @MaterialTradeColor4,	-- #02
--MaterialTradeColor5 = @MaterialTradeColor5,	-- #02
MaterialTradeColor6 = @MaterialTradeColor6,
MaterialTradeColor7 = @MaterialTradeColor7,
MaterialTradeColor8 = @MaterialTradeColor8,
MaterialTradeColor9 = @MaterialTradeColor9,
MaterialTradeColor10 = @MaterialTradeColor10,
MaterialTradeColor11 = @MaterialTradeColor11,
MaterialTradeColor12 = @MaterialTradeColor12,
MaterialTradeColor13 = @MaterialTradeColor13,
MaterialTradeColor14 = @MaterialTradeColor14,
MaterialTradeColor15 = @MaterialTradeColor15,
MaterialTradeColor16 = @MaterialTradeColor16,
MaterialTradeColor17 = @MaterialTradeColor17,
MaterialTradeColor18 = @MaterialTradeColor18,
MaterialTradeColor19 = @MaterialTradeColor19,
MaterialTradeColor20 = @MaterialTradeColor20,
MaterialTradeColor21 = @MaterialTradeColor21,
MaterialTradeColor22 = @MaterialTradeColor22,
MaterialTradeColor23 = @MaterialTradeColor23,
MaterialTradeColor24 = @MaterialTradeColor24,
MaterialTradeColor25 = @MaterialTradeColor25
WHERE --MaterialColorID = @MaterialColorID AND  -- #03
MaterialTradePartnerID IN (
	SELECT MaterialTradePartnerID FROM pMaterialTradePartner 
	WHERE TradepartnerVendorId = @TradepartnerVendorId 
	AND MaterialId = @MaterialID
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_SystemServerStorageImageNew_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE  PROCEDURE [dbo].[spx_SystemServerStorageImageNew_SELECT] (
@NewImageID  UNIQUEIDENTIFIER 
)
AS 

SELECT TOP 1 
sSystemServerStorageSetting.ImageVersionPath +  + '\{' + CAST(@NewImageID AS VARCHAR(40)) + '}\1' 
FROM sSystemServerStorageSetting 
WHERE CurrentServerStorage = 1



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_ServiceQueueRunning_SELECT]'
GO


CREATE PROCEDURE [dbo].[spx_ServiceQueueRunning_SELECT]

AS 

BEGIN

	SELECT TOP 5 ServiceQueueID, ServiceQueueSql, ServiceQueuePriority, ServiceQueueRunningDate 
	FROM sServiceQueueRunning 
	WHERE Attempt < 3
	ORDER BY ServiceQueueID, ServiceQueuePriority ASC, ServiceQueueRunningDate ASC

END








GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialComment_UPDATE]'
GO

create PROCEDURE [dbo].[spx_MaterialComment_UPDATE](
	@MaterialCommentID uniqueidentifier,
	@MaterialComment nvarchar(4000),
	@CreatedBy nvarchar(200),
	@CreatedDate datetime
)
AS 

UPDATE pMaterialComment SET 
	MaterialComment=@MaterialComment, 
	MUser=@CreatedBy, 
	MDate=@CreatedDate 
WHERE MaterialCommentID = @MaterialCommentID

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_QuoteTradeStyleMenu_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_QuoteTradeStyleMenu_SELECT](@TeamID uniqueidentifier,
@QuoteFolderID uniqueidentifier)
AS SELECT     dbo.pStyleHeader.StyleID, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.Description, dbo.pQuoteFolderItemTeam.TeamID, 
                      dbo.pQuoteFolderItemTeam.QuoteFolderItemID, dbo.pQuoteFolderItemTeam.QuoteFolderID, dbo.pQuoteFolderItemMessage.QuoteMessageStatus, 
                      dbo.pQuoteFolderItemTeam.QuoteFolderTeamID, dbo.pQuoteFolderItem.PDFFile
FROM         dbo.pQuoteFolderItem WITH (NOLOCK) INNER JOIN
                      dbo.pStyleHeader WITH (NOLOCK) ON dbo.pQuoteFolderItem.StyleID = dbo.pStyleHeader.StyleID LEFT OUTER JOIN
                      dbo.pQuoteFolderItemTeam WITH (NOLOCK) ON dbo.pQuoteFolderItem.QuoteFolderItemID = dbo.pQuoteFolderItemTeam.QuoteFolderItemID LEFT OUTER JOIN
                      dbo.pQuoteFolderItemMessage WITH (NOLOCK) ON dbo.pQuoteFolderItemTeam.QuoteFolderTeamID = dbo.pQuoteFolderItemMessage.QuoteFolderTeamID
WHERE     (dbo.pQuoteFolderItemTeam.TeamID = @TeamID) AND (dbo.pQuoteFolderItemTeam.QuoteFolderID = @QuoteFolderID)
ORDER BY dbo.pQuoteFolderItem.PDFFile DESC, dbo.pStyleHeader.StyleNo



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialTradePartnerColors_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_MaterialTradePartnerColors_SELECT](@MaterialTradePartnerID uniqueidentifier)
AS 

SELECT a.MaterialTradePartnerColorID , a.MaterialPRICE,
d.ColorCode, d.ColorName , a.MaterialTradeColor1, a.MaterialTradeColor2, a.MaterialTradeColor3, 
a.MaterialTradeColor4, a.MaterialTradeColor5, a.MaterialTradeColor6, a.MaterialTradeColor7, 
 a.MaterialTradeColor8,a.MaterialTradeColor9, a.MaterialTradeColor10,
a.MaterialTradeColor11, a.MaterialTradeColor12, a.MaterialTradeColor13,
a.MaterialTradeColor14, a.MaterialTradeColor15, a.MaterialTradeColor16,
a.MaterialTradeColor17, a.MaterialTradeColor18, a.MaterialTradeColor19,
a.ColorName + '/ ' +  ISNULL(b.MaterialSize, '*NA') AS MaterialColor , c.SeasonYearID,

CASE 
	WHEN b.MaterialSizeID IS NULL THEN  '*NA' 
	ELSE b.MaterialSize
END AS MaterialSize, 
Case  
	WHEN a.MaterialColorImageID IS NULL  THEN 
		'<TABLE cellSpacing=''0'' cellPadding=''0'' width=''100%'' border=''0''><TR><TD width=''18''> 
		<IMG src=''' + '../System/Control/ColorStream.ashx?S=16&CFID=' + CAST(a.ColorFolderID AS VARCHAR(40)) + 
		'&CPID=' + CAST(a.ColorPaletteID AS VARCHAR(40)) + ''' border=0 ALT=''Open''></TD></TR></TABLE>'
	 ELSE  
		'<TABLE cellSpacing=''0'' cellPadding=''0'' width=''100%'' border=''0''><TR><TD width=''18''> 
		<IMG src=''' + '../System/Control/ImageStream.ashx?S=16&V=' + CAST(a.MaterialColorImageVersion AS VARCHAR(40)) + 
		'&IID=' + CAST(a.MaterialColorImageID AS VARCHAR(40)) + ''' border=0 ALT=''Open''></TD></TR></TABLE>'
END AS ColorImagePath

FROM pMaterialTradePartnerColor a  
INNER JOIN pMaterialTradePartner c on a.MaterialTradePartnerID = c.MaterialTradePartnerID
INNER JOIN pColorPalette d ON d.ColorPaletteID = a.ColorPaletteID 
LEFT OUTER JOIN pMaterialSize b ON a.MaterialSizeID =  b.MaterialSizeID
WHERE a.MaterialTradePartnerID = @MaterialTradePartnerID
ORDER BY a.ColorName, b.MaterialSize









GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_SystemServerStorageImagePOMThumb_SELECT]'
GO
CREATE PROCEDURE [dbo].[spx_SystemServerStorageImagePOMThumb_SELECT](
@PoMID UNIQUEIDENTIFIER
)
AS 


SELECT 
sSystemServerStorageSetting.ImagePoMPath + '\{' + 
CAST(@PoMID AS VARCHAR(50)) + '}\' + CAST(@PoMID AS VARCHAR(50))+ '.jpg'
AS ImageThumbPath 
FROM pPOMLibrary  a WITH (NOLOCK)  INNER JOIN sSystemServerStorageSetting WITH (NOLOCK) 
ON a.SystemServerStorageID = sSystemServerStorageSetting.SystemServerStorageID
WHERE a.POMLibraryID  = @PoMID



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_ServiceQueueRunning_EXECUTE]'
GO



CREATE PROCEDURE [dbo].[spx_ServiceQueueRunning_EXECUTE](
@ServiceQueueId int,
@ThrdId NVARCHAR(300)
)

AS 

--DECLARE @ServiceQueueId int
--SET @ServiceQueueId=2
DECLARE @nError INT 
SET @nError = 0 


BEGIN TRANSACTION

	DECLARE @SqlString nvarchar(4000)
	SET @SqlString = (SELECT TOP 1 ServiceQueueSql  FROM sServiceQueueRunning WHERE ServiceQueueID = @ServiceQueueId)
	EXEC sp_executesql @SqlString
	IF @@ERROR <> 0
	 BEGIN
		SET @nError = 1
		-- Rollback the transaction
		ROLLBACK
	   --Return
	 END
		
	IF @nError = 0 
	BEGIN 
		DELETE FROM sServiceQueueRunning WHERE ServiceQueueID = @ServiceQueueId
		IF @@ERROR <> 0
		 BEGIN
			-- Rollback the transaction
			SET @nError = 1
			ROLLBACK
		   --Return
		 END
	END

IF @nError = 0 
	COMMIT
ELSE
	UPDATE sServiceQueueRunning SET Attempt = Attempt + 1 WHERE ServiceQueueID = @ServiceQueueId
	










GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteGroupVariation_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_StyleQuoteGroupVariation_SELECT]
(@StyleDevelopmentID uniqueidentifier)
AS 

/*
Modified By Daniel @ 04/19/07 2:23 PM
StyleId Added 
*/

SELECT  StyleDevelopmentName, StyleDevelopmentID, Variation, StyleId
FROM         pStyleDevelopmentItem WITH (NOLOCK)
GROUP BY StyleDevelopmentName, Variation, StyleDevelopmentID, StyleId
HAVING      (StyleDevelopmentID = @StyleDevelopmentID)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialContent_DELETE]'
GO

CREATE PROCEDURE [dbo].[spx_MaterialContent_DELETE]
(
@MaterialId uniqueidentifier
)
AS 


DELETE FROM pMaterialContent WHERE MaterialId = @MaterialId 


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pColorGroup]'
GO
CREATE TABLE [dbo].[pColorGroup]
(
[ColorGroupID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_pColorGroup_ColorGroupID] DEFAULT (newsequentialid()),
[ColorGroupName] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[Sort] [varchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField1] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CustomField2] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Active] [int] NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pColorGroupID] on [dbo].[pColorGroup]'
GO
ALTER TABLE [dbo].[pColorGroup] ADD CONSTRAINT [PK_pColorGroupID] PRIMARY KEY CLUSTERED  ([ColorGroupID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_LineFolder_Global_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.  Needed to add the 'Version' field to the temp table for
the image stream and get the 'Version' from 'hImage' to put in the temp table.
*/


ALTER     procedure [dbo].[rpx_LineFolder_Global_SELECT]
	@Season varchar(50) = null,
	@Year varchar(50) = null,
	@Category varchar(50) = null
as

/*Test values*/
-- DECLARE	@Season varchar(50)
-- DECLARE	@Year varchar(50)
-- DECLARE	@Category varchar(50)
-- SET @Season = NULL
-- SET @Year = NULL
-- SET @Category = NULL


/*Variables*/
DECLARE @StrCategory varchar(255)


/*Get the string version of the StyleCategory for the report header*/
SELECT @StrCategory = StyleCategory
FROM pStyleCategory
WHERE CAST(StyleCategoryID AS varchar(50)) = @Category

/*Create temp tables*/
CREATE TABLE #tempLineFolderStyles
(
	TableRow int identity(0,1),
	StyleID varchar(50),
	StyleNo varchar(50),
	[Description] nvarchar(255),
	ImageID varchar(50),
	ImageHistoryID varchar(50),
	SizeClass nvarchar(50),
	SizeRange nvarchar(50),
	MaterialName nvarchar(100),
	MaterialNo nvarchar(50),
	Colorways varchar(2000),
	[Version] int	--Comment #01
)

/*Insert info into temp table.*/
INSERT INTO #tempLineFolderStyles(
	StyleID, 
	StyleNo, 
	[Description], 
	ImageID, 
	ImageHistoryID,
	SizeClass, 
	SizeRange, 
	MaterialName,
	MaterialNo,
	[Version])	--Comment #01
SELECT 	b.StyleID, 
	b.StyleNo, 
	b.[Description], 
	c.ImageID, 
	c.ImageHistoryID,
	b.SizeClass, 
	b.SizeRange, 
	d.MaterialName,
	d.MaterialNo,
	c.[Version]	--Comment #01
FROM pStyleHeader b 
INNER JOIN hImage c ON b.DesignSketchID = c.ImageID AND b.DesignSketchVersion = c.Version 
LEFT OUTER JOIN pMaterial d ON b.MaterialID = d.MaterialID
LEFT OUTER JOIN pStyleCategory e ON	b.StyleCategory = e.StyleCategoryID
WHERE (@Season is null or b.CustomField2 = @Season)
and (@Year is null or b.CustomField4 = @Year)
and (@Category is null or CAST(b.StyleCategory AS varchar(50)) = @Category)
ORDER BY e.StyleCategory, b.StyleNo, b.[Description]

create table #StyleColorways
(
	RowNum int identity(1,1),
	StyleID varchar(50),
	MainColor nvarchar(100)
)

insert #StyleColorways (StyleID, MainColor)
select StyleID, MainColor
from pStyleColorway
where StyleID in (select StyleID from #tempLineFolderStyles)

declare @counter int, @maxcount int
set @counter = 1

select @maxcount = max(RowNum)
from #StyleColorways

while (@counter <= @maxcount)
begin
	update s
	set s.Colorways = isnull(s.Colorways, '') + rtrim(c.MainColor) + ', '
	from #tempLineFolderStyles s
	inner join #StyleColorways c on s.StyleID = c.StyleID
	where c.RowNum = @counter

	set @counter = @counter + 1
end

/*Select the information how you want for the report.*/
SELECT
	TableRow % 4 AS [Column],
	@StrCategory AS Category,
	StyleID,
	StyleNo,
	[Description],
	dbo.fnx_GetStreamingImagePath(ImageID, [Version]) AS FilePath,	--Comment #01
	SizeClass,
	SizeRange,
	MaterialName,
	MaterialNo,
	substring(Colorways, 1, len(Colorways)-1) as Colorways
FROM #tempLineFolderStyles

/*Drop the temp tables*/
drop table #StyleColorways
DROP TABLE #tempLineFolderStyles


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_UserListGroups_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_UserListGroups_SELECT] (
@TeamID uniqueidentifier
)
AS
BEGIN 

	DECLARE @ReadOnly INT
	SELECT  @ReadOnly = ReadOnly FROM Users WITH (NOLOCK) WHERE TeamID = @TeamID
	IF @ReadOnly IS NULL
	BEGIN 
		SET @ReadOnly = 0		
		UPDATE  Users SET ReadOnly = @ReadOnly WHERE TeamID = @TeamID
	END 

	IF @ReadOnly = 0
	BEGIN 
		SELECT a.GroupName, a.GroupID 
		FROM uGroup a WITH (NOLOCK) 
		WHERE a.Active = 1 
		AND a.GroupID NOT IN ( SELECT GroupID FROM uUserGroup WITH (NOLOCK)  WHERE TeamID = @TeamID )
		AND ( a.ReadOnly = 0 OR a.ReadOnly IS NULL  )
		ORDER BY GroupName
	END 
	ELSE 
	BEGIN
		SELECT a.GroupName, a.GroupID 
		FROM uGroup a WITH (NOLOCK) 
		WHERE a.Active = 1 
		AND a.GroupID NOT IN ( SELECT GroupID FROM uUserGroup WITH (NOLOCK)  WHERE TeamID = @TeamID )
		AND a.ReadOnly = 1 
		ORDER BY GroupName
	END


END 



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_SystemServerStorageImageSampleThumb_SELECT]'
GO


CREATE PROCEDURE [dbo].[spx_SystemServerStorageImageSampleThumb_SELECT](
@ImageId UNIQUEIDENTIFIER,
@TradePartnerVendorID UNIQUEIDENTIFIER,
@SampleRequestTradeID UNIQUEIDENTIFIER,
@SampleRequestSubmitImageID UNIQUEIDENTIFIER
)
AS 


SELECT 
sSystemServerStorageSetting.SamplePath + '\' + 
CAST(@TradePartnerVendorID AS VARCHAR(50)) + '\' + CAST(@SampleRequestTradeID AS VARCHAR(50))+  '\' +
CAST(@SampleRequestSubmitImageID AS VARCHAR(50)) + '\Version\000\' + CAST(@Imageid AS VARCHAR(50)) + '.jpg'
AS ImageThumbPath 
FROM pSampleRequestSubmitImage a WITH (NOLOCK)  INNER JOIN sSystemServerStorageSetting WITH (NOLOCK) 
ON a.SystemServerStorageID = sSystemServerStorageSetting.SystemServerStorageID
WHERE a.SampleRequestSubmitImageID   = @SampleRequestSubmitImageID 








GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleHeaderNew_INSERT]'
GO


ALTER  PROCEDURE [dbo].[spx_StyleHeaderNew_INSERT]
(@StyleID uniqueidentifier,
@CreatedBy nvarchar(50),
@CreatedDate datetime)
AS 

DECLARE @NoOfStyleHeader int 
SELECT  @NoOfStyleHeader = COUNT(*)  FROM  pStyleHeader WITH (NOLOCK) WHERE StyleID = @StyleID


	IF @NoOfStyleHeader = 0


		BEGIN

		INSERT INTO pStyleHeader
                     	 (StyleID, StyleMasterID, CUser, CDate, MUser, MDate, Change, MaterialID, MaterialImageID, DesignSketchID, TechSketchID, ConceptSketchID, ColorSketchID, 
                     	 DetailSketchID1, DetailSketchID2, DetailSketchID3, DetailSketchID4, SpecSketchID1, SpecSketchID2, SpecSketchID3, SpecSketchID4, 
                     	 DesignSketchVersion, TechSketchVersion, ConceptSketchVersion, ColorSketchVersion, DetailSketchVersion1, DetailSketchVersion2, 
                      	 DetailSketchVersion3, DetailSketchVersion4, SpecSketchVersion1, SpecSketchVersion2, SpecSketchVersion3, SpecSketchVersion4)
		 VALUES     (@StyleID , @StyleID, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate, '1', '{00000000-0000-0000-0000-000000000000}', 
                     	 '{00000000-0000-0000-0000-000000000000}', '{00000000-0000-0000-0000-000000000000}', '{00000000-0000-0000-0000-000000000000}', 
                     	 '{00000000-0000-0000-0000-000000000000}', '{00000000-0000-0000-0000-000000000000}', '{00000000-0000-0000-0000-000000000000}', 
                    	 '{00000000-0000-0000-0000-000000000000}', '{00000000-0000-0000-0000-000000000000}', '{00000000-0000-0000-0000-000000000000}', 
                     	 '{00000000-0000-0000-0000-000000000000}', '{00000000-0000-0000-0000-000000000000}', '{00000000-0000-0000-0000-000000000000}', 
                     	 '{00000000-0000-0000-0000-000000000000}', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)

		SELECT 1

		END

	ELSE

		BEGIN

		SELECT 0

		END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteHistory_INSERT]'
GO




ALTER PROCEDURE [dbo].[spx_StyleQuoteHistory_INSERT]
(@StyleQuoteItemId uniqueidentifier,
@StyleId uniqueidentifier,
@TeamId uniqueidentifier,
@CreatedDate datetime)
AS 


IF (SELECT COUNT(*) FROM hStyleQuoteHistory WITH (NOLOCK) WHERE TeamID = @TeamID AND StyleId = @StyleId AND StyleQuoteItemId = @StyleQuoteItemId) = 0
	BEGIN
		INSERT INTO hStyleQuoteHistory  (StyleQuoteItemId, StyleID, TeamID, CDate) VALUES (@StyleQuoteItemId, @StyleID, @TeamID, @CreatedDate)
	END
Else
	BEGIN
		UPDATE hStyleQuoteHistory SET  CDate = @CreatedDate WHERE StyleID = @StyleID AND TeamID = @TeamID AND StyleQuoteItemId = @StyleQuoteItemId
	END

BEGIN
	DELETE FROM hStyleQuoteHistory WHERE TeamID = @TeamID AND  StyleQuoteItemId NOT IN (SELECT TOP 20 StyleQuoteItemId From hStyleQuoteHistory WITH (NOLOCK) WHERE TeamID = @TeamID ORDER BY CDate DESC)
END
	
	




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialContent_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_MaterialContent_SELECT]
(
@MaterialId uniqueidentifier
)
AS 


SELECT MaterialContentId, MaterialId, MaterialContentCode, MaterialContentPerc, MaterialContentName, CDate, CUser, MDate, MUser 
 FROM pMaterialContent WHERE MaterialId = @MaterialId ORDER BY MaterialContentPerc DESC


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_Group_AccessBodyFolder_SELECT]'
GO


CREATE PROCEDURE [dbo].[spx_Group_AccessBodyFolder_SELECT] ( 
@GroupID uniqueidentifier
)
AS 


SELECT a.BodyTypeID, a.BodyTypeDescription, 
	b.AccessBodyId,  b.AccessRoleId, b.AccessView, b.AccessCreate, 
	b.AccessModify, b.AccessDelete, b.AccessPrint, b.AccessRemove, 
	b.GroupID, b.CUser, b.CDate,  b.MUser, 
	b.MDate, a.BodyTypeOrder
FROM  pBodyType a WITH (NOLOCK) INNER JOIN   sAccessGroupBodyFolder  b WITH (NOLOCK) ON a.BodyTypeID = b.BodyTypeID
WHERE b.GroupID = @GroupID
ORDER BY a.BodyTypeOrder



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcingSampleRequestSubmit_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_StyleSourcingSampleRequestSubmit_SELECT] (
@StyleSourcingID UNIQUEIDENTIFIER 
)
AS 


SELECT a.SampleWorkflowID as tb_pivot , c.SampleWorkflowSort
INTO #tmpSampleStyleWorkflow 
FROM dbo.pSampleRequestSubmit a
INNER JOIN pSampleRequestTrade b ON a.SampleRequestTradeID  = b.SampleRequestTradeID  
INNER JOIN pSampleWorkflow c ON a.SampleWorkflowId = c.SampleWorkflowID 
WHERE b.StyleSourcingID = @StyleSourcingID 
ORDER BY SampleWorkflowSort 

DECLARE @sql varchar(8000)
DECLARE @PIVOT varchar(8000)
DECLARE @flag int 
SET @flag = 0 

SET @PIVOT = ''
set @sql= ''

SELECT @PIVOT=@PIVOT + '''_srsi_' + tb_pivot + ''' =  MAX( CASE a.SampleWorkflowID WHEN ''' + tb_pivot 
+ ''' THEN  CASE WHEN a.SampleRequestSubmitID  IS NULL THEN '''' ELSE CAST(a.SampleRequestSubmitID AS NVARCHAR(50)) END END ) ,'
FROM #tmpSampleStyleWorkflow

if LEN(@PIVOT) > 1
BEGIN
	SET @PIVOT=LEFT(@PIVOT, LEN(@PIVOT)-1)
	SET @flag = 1 
END

SET @sql = 'SELECT a.SampleRequestTradeID , d.VendorName , e.TradePartnerName as AgentName, 
g.StyleColorName, f.StyleNo,  f.SizeClass, f.Description, f.StyleSet, 

CASE 
	WHEN  b.TechPackID IS NULL  OR b.TechPackID  = ''00000000-0000-0000-0000-000000000000'' THEN ''<div align=center>-------</div>''
	ELSE  
	''<TABLE>
			<TR>
			<TD width=''''18''''><IMG src=''''../System/Icons/icon_packageok.gif'''' border=''''0''''></TD>
			<TD class=''''font'''' align=''''center'''' valign=''''center'''' nowrap>&nbsp;

			<a href=''''#'''' onclick="javascript:window.open(''''../Sample/SampleRequest_Workflow_Redirect.aspx?SRTID=''

			+ CAST (a.SampleRequestTradeID AS NVARCHAR(50))
			+ ''&SN='' + CAST(f.StyleSet AS NVARCHAR(10)) 
			+ ''&TP=1'''','' 

			+ '' '''''' + REPLACE ( CAST ( a.SampleRequestTradeID  AS NVARCHAR(50) ) , ''-'', '''' ) 

			+ '''''',   ''''width=1024, height=700, location=yes, menubar=yes, status=yes, toolbar=yes, scrollbars=yes, resizable=yes''''    '' 
			+ '' );" >  '' 
			
			+ CONVERT ( NVARCHAR(50), f.DueDate , 101)   +  ''</a>

			</TD></TR></TABLE>''
	END AS TechPack

' 

IF  LEN (@PIVOT) >  0 
	SET @sql = @sql +  ' , ' + @PIVOT

SET @sql = @sql + '		

FROM dbo.pSampleRequestSubmit a
INNER JOIN pSampleRequestTrade b ON a.SampleRequestTradeID  = b.SampleRequestTradeID  
INNER JOIN pSampleRequestSubmitStatus c ON a.Status  = c.StatusID 
INNER JOIN uTradepartnerVendor d ON a.TradePartnerVendorID = d.TradePartnerVendorID 
INNER JOIN uTradePartner e ON  a.TradePartnerID  = e.TradePartnerID 
INNER JOIN pStyleHeader f ON a.StyleID = f.StyleID 

LEFT OUTER JOIN pStyleColorway g ON a.StyleColorID  = g.StyleColorID
WHERE b.StyleSourcingID = ''' +  CAST (@StyleSourcingID  AS NVARCHAR(50)) + '''  
GROUP BY  a.SampleRequestTradeID , d.VendorName , e.TradePartnerName, g.StyleColorName,
f.StyleNo,  f.SizeClass, f.Description, f.StyleSet, b.TechPackID, f.DueDate 
'

EXEC (@sql )

--PRINT @sql 

drop table #tmpSampleStyleWorkflow


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SystemServerStorageImageThumb_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_SystemServerStorageImageThumb_SELECT](@ImageId uniqueidentifier, @ImageVersion int)
AS 

SELECT 
sSystemServerStorageSetting.ImageThumbPath + '\{' + CAST(hImage.ImageID AS VARCHAR(40)) + '}\Version\000\{' + CAST(hImage.ImageHistoryID AS VARCHAR(40)) + '}.jpg' AS ImageThumbPath 
FROM hImage WITH (NOLOCK) INNER JOIN
      sSystemServerStorageSetting WITH (NOLOCK) ON hImage.SystemServerStorageID = sSystemServerStorageSetting.SystemServerStorageID
WHERE (hImage.ImageID = @ImageId) AND (hImage.Version = @ImageVersion)





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteHistory_SELECT]'
GO


ALTER PROCEDURE [dbo].[spx_StyleQuoteHistory_SELECT]
(@TeamId uniqueidentifier)
AS 

SELECT  pStyleQuoteItem.StyleQuoteItemID, pStyleHeader.StyleID, pStyleHeader.StyleNo, pStyleHeader.Description, pStyleQuoteItem.StyleQuoteItemStatusId, 
      pStyleQuoteItem.StyleQuoteItemNo, hStyleQuoteHistory.CDate
FROM  pStyleQuoteItem WITH (NOLOCK) INNER JOIN
      pStyleHeader WITH (NOLOCK) ON pStyleQuoteItem.StyleID = pStyleHeader.StyleID INNER JOIN
      hStyleQuoteHistory WITH (NOLOCK) ON pStyleQuoteItem.StyleQuoteItemID = hStyleQuoteHistory.StyleQuoteItemId
WHERE hStyleQuoteHistory.StyleId IN (SELECT StyleId FROM hStyleQuoteHistory WITH (NOLOCK) WHERE TeamID = @TeamID) 
ORDER BY hStyleQuoteHistory.CDate DESC





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialCore_COPY]'
GO
CREATE PROCEDURE [dbo].[spx_MaterialCore_COPY]
(
	 @MaterialCoreID UNIQUEIDENTIFIER
	,@MaterialCoreNewID UNIQUEIDENTIFIER
	,@CreatedBy NVARCHAR(100)
	,@CreatedDate DATETIME
)

AS


--/************/
--/*Testing.	*/
--/************/
--DECLARE @MaterialCoreID UNIQUEIDENTIFIER
--DECLARE @CreatedBy NVARCHAR(100)
--DECLARE @CreatedDate DATETIME
--SET @MaterialCoreID = '3cdef533-5044-41bc-8646-07076a48a2f8'
--SET @CreatedBy  = 'Homie ''G'''
--SET @CreatedDate = '2010-02-28 12:00:00.000'


/********************/
/*Create variables.	*/
/********************/
DECLARE @MaterialCoreID_Copy UNIQUEIDENTIFIER

DECLARE @MaterialCoreItemID_Original UNIQUEIDENTIFIER
DECLARE @MaterialCoreItemID_Copy UNIQUEIDENTIFIER

DECLARE @MaterialCoreColorID_Original UNIQUEIDENTIFIER
DECLARE @MaterialCoreColorID_Copy UNIQUEIDENTIFIER

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************/
/*Create temp tables.	*/
/************************/
--Holds original Material Group Header record.
CREATE TABLE dbo.#temp_pMaterialCore_Original
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,MaterialCoreID uniqueidentifier
	,MaterialCoreName nvarchar(100)
	,MaterialCoreDescription nvarchar(4000)
	,CUser nvarchar(200)
	,CDate datetime
	,MUser nvarchar(200)
	,MDate datetime
	,Active nvarchar(5)
	,Sort nvarchar(5)
	)  ON [PRIMARY]

ALTER TABLE dbo.#temp_pMaterialCore_Original ADD CONSTRAINT
	PK_#temp_pMaterialCore_Original PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

--Holds copied Material Group Header record.
CREATE TABLE dbo.#temp_pMaterialCore_Copy
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,MaterialCoreID uniqueidentifier
	,MaterialCoreName nvarchar(100)
	,MaterialCoreDescription nvarchar(4000)
	,CUser nvarchar(200)
	,CDate datetime
	,MUser nvarchar(200)
	,MDate datetime
	,Active nvarchar(5)
	,Sort nvarchar(5)
	)  ON [PRIMARY]

ALTER TABLE dbo.#temp_pMaterialCore_Copy ADD CONSTRAINT
	PK_#temp_pMaterialCore_Copy PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

--Holds original Material Group Materials.
CREATE TABLE dbo.#temp_pMaterialCoreItem_Original
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,MaterialCoreItemID uniqueidentifier
	,MaterialCoreID uniqueidentifier
	,MaterialID uniqueidentifier
	,UOM nvarchar(50)
	,Qty nvarchar(18)
	,MaterialPrice money
	,Ext money
	,MaterialSize nvarchar(100)
	,Placement nvarchar(4000)
	,Artwork int
	,License int
	,Colorway int
	,CUser nvarchar(200)
	,CDate datetime
	,MUser nvarchar(200)
	,MDate datetime
	)  ON [PRIMARY]

ALTER TABLE dbo.#temp_pMaterialCoreItem_Original ADD CONSTRAINT
	PK_#temp_pMaterialCoreItem_Original PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

--Holds copied Material Group Materials.
CREATE TABLE dbo.#temp_pMaterialCoreItem_Copy
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,MaterialCoreItemID uniqueidentifier
	,MaterialCoreID uniqueidentifier
	,MaterialID uniqueidentifier
	,UOM nvarchar(50)
	,Qty nvarchar(18)
	,MaterialPrice money
	,Ext money
	,MaterialSize nvarchar(100)
	,Placement nvarchar(4000)
	,Artwork int
	,License int
	,Colorway int
	,CUser nvarchar(200)
	,CDate datetime
	,MUser nvarchar(200)
	,MDate datetime
	,MaterialCoreItemCopyID uniqueidentifier
	)  ON [PRIMARY]

ALTER TABLE dbo.#temp_pMaterialCoreItem_Copy ADD CONSTRAINT
	PK_#temp_pMaterialCoreItem_Copy PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

--Holds original Material Group Colors.
CREATE TABLE dbo.#temp_pMaterialCoreColor_Original
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,MaterialCoreColorID uniqueidentifier
	,MaterialCoreID uniqueidentifier
	,ColorPaletteID uniqueidentifier
	,ColorCode nvarchar(200)
	,ColorName nvarchar(200)
	,Active int
	,Sort varchar(5)
	,CDate datetime
	,CUser nvarchar(200)
	,MDate datetime
	,MUser nvarchar(200)
	)  ON [PRIMARY]

ALTER TABLE dbo.#temp_pMaterialCoreColor_Original ADD CONSTRAINT
	PK_#temp_pMaterialCoreColor_Original PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

--Holds copied Material Group Colors.
CREATE TABLE dbo.#temp_pMaterialCoreColor_Copy
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,MaterialCoreColorID uniqueidentifier
	,MaterialCoreID uniqueidentifier
	,ColorPaletteID uniqueidentifier
	,ColorCode nvarchar(200)
	,ColorName nvarchar(200)
	,Active int
	,Sort varchar(5)
	,CDate datetime
	,CUser nvarchar(200)
	,MDate datetime
	,MUser nvarchar(200)
	)  ON [PRIMARY]

ALTER TABLE dbo.#temp_pMaterialCoreColor_Copy ADD CONSTRAINT
	PK_#temp_pMaterialCoreColor_Copy PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

--Holds original Material Group Chip Colors.
CREATE TABLE dbo.#temp_pMaterialCoreColorItem_Original
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,MaterialCoreColorItemID uniqueidentifier
	,MaterialCoreColorItemMasterID uniqueidentifier
	,MaterialCoreColorID uniqueidentifier
	,MaterialCoreItemID uniqueidentifier
	,MaterialCoreID uniqueidentifier
	,MaterialID uniqueidentifier
	,MaterialColorID uniqueidentifier
	,CDate datetime
	,CUser nvarchar(100)
	,MDate datetime
	,MUser nvarchar(100)
	)  ON [PRIMARY]

ALTER TABLE dbo.#temp_pMaterialCoreColorItem_Original ADD CONSTRAINT
	PK_#temp_pMaterialCoreColorItem_Original PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

--Holds copied Material Group Chip Colors.
CREATE TABLE dbo.#temp_pMaterialCoreColorItem_Copy
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,MaterialCoreColorItemID uniqueidentifier
	,MaterialCoreColorItemMasterID uniqueidentifier
	,MaterialCoreColorID uniqueidentifier
	,MaterialCoreItemID uniqueidentifier
	,MaterialCoreID uniqueidentifier
	,MaterialID uniqueidentifier
	,MaterialColorID uniqueidentifier
	,CDate datetime
	,CUser nvarchar(100)
	,MDate datetime
	,MUser nvarchar(100)
	,MaterialCoreColorItemCopyID uniqueidentifier
	)  ON [PRIMARY]

ALTER TABLE dbo.#temp_pMaterialCoreColorItem_Copy ADD CONSTRAINT
	PK_#temp_pMaterialCoreColorItem_Copy PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/************************************************************************/
/*Get the original records and put them in the 'original' temp tables.	*/
/************************************************************************/
--Material Group Header Original.
INSERT INTO #temp_pMaterialCore_Original
	(MaterialCoreID, MaterialCoreName, MaterialCoreDescription, CUser, CDate, 
	MUser, MDate, Active, Sort)
SELECT
	MaterialCoreID, MaterialCoreName,MaterialCoreDescription, CUser, CDate,
	MUser, MDate, Active, Sort
FROM pMaterialCore
WHERE MaterialCoreID = @MaterialCoreID

--Material Group Materials Original.
INSERT INTO #temp_pMaterialCoreItem_Original
	(MaterialCoreItemID, MaterialCoreID, MaterialID, UOM, Qty, MaterialPrice,
	Ext, MaterialSize, Placement, Artwork, License, Colorway, CUser, CDate,
	MUser, MDate)
SELECT
	MaterialCoreItemID, MaterialCoreID, MaterialID, UOM, Qty, MaterialPrice,
	Ext, MaterialSize, Placement, Artwork, License, Colorway, CUser, CDate,
	MUser, MDate
FROM pMaterialCoreItem
WHERE MaterialCoreID = @MaterialCoreID

--Material Group Colors Original.
INSERT INTO #temp_pMaterialCoreColor_Original
	(MaterialCoreColorID, MaterialCoreID, ColorPaletteID, ColorCode, ColorName,
	Active, Sort, CDate, CUser, MDate, MUser)
SELECT
	MaterialCoreColorID, MaterialCoreID, ColorPaletteID, ColorCode, ColorName,
	Active, Sort, CDate, CUser, MDate, MUser
FROM pMaterialCoreColor
WHERE MaterialCoreID = @MaterialCoreID

--Material Group Color Chips Original.
INSERT INTO #temp_pMaterialCoreColorItem_Original
	(MaterialCoreColorItemID, MaterialCoreColorItemMasterID, MaterialCoreColorID,
	MaterialCoreItemID, MaterialCoreID, MaterialID, MaterialColorID, CDate, CUser,
	MDate, MUser)
SELECT
	MaterialCoreColorItemID, MaterialCoreColorItemMasterID, MaterialCoreColorID,
	MaterialCoreItemID, MaterialCoreID, MaterialID, MaterialColorID, CDate, CUser,
	MDate, MUser
FROM pMaterialCoreColorItem
WHERE MaterialCoreID = @MaterialCoreID


/********************************************************************/
/*Get the original records and put them in the 'copy' temp tables.	*/
/********************************************************************/
--Material Group Header Copy.
INSERT INTO #temp_pMaterialCore_Copy
	(MaterialCoreID, MaterialCoreName,MaterialCoreDescription, CUser, CDate,
	MUser, MDate, Active, Sort)
SELECT
	MaterialCoreID, MaterialCoreName,MaterialCoreDescription, CUser, CDate,
	MUser, MDate, Active, Sort
FROM #temp_pMaterialCore_Original

--Material Group Materials Copy.
INSERT INTO #temp_pMaterialCoreItem_Copy
	(MaterialCoreItemID, MaterialCoreID, MaterialID, UOM, Qty, MaterialPrice,
	Ext, MaterialSize, Placement, Artwork, License, Colorway, CUser, CDate,
	MUser, MDate, MaterialCoreItemCopyID )
SELECT
	MaterialCoreItemID, MaterialCoreID, MaterialID, UOM, Qty, MaterialPrice,
	Ext, MaterialSize, Placement, Artwork, License, Colorway, CUser, CDate,
	MUser, MDate, MaterialCoreItemID 
FROM #temp_pMaterialCoreItem_Original

--Material Group Colors Copy.
INSERT INTO #temp_pMaterialCoreColor_Copy
	(MaterialCoreColorID, MaterialCoreID, ColorPaletteID, ColorCode, ColorName,
	Active, Sort, CDate, CUser, MDate, MUser)
SELECT
	MaterialCoreColorID, MaterialCoreID, ColorPaletteID, ColorCode, ColorName,
	Active, Sort, CDate, CUser, MDate, MUser
FROM #temp_pMaterialCoreColor_Original

--Material Group Color Chips Copy.
INSERT INTO #temp_pMaterialCoreColorItem_Copy
	(MaterialCoreColorItemID, MaterialCoreColorItemMasterID, MaterialCoreColorID,
	MaterialCoreItemID, MaterialCoreID, MaterialID, MaterialColorID, CDate, CUser,
	MDate, MUser, MaterialCoreColorItemCopyID )
SELECT
	MaterialCoreColorItemID, MaterialCoreColorItemMasterID, MaterialCoreColorID,
	MaterialCoreItemID, MaterialCoreID, MaterialID, MaterialColorID, CDate, CUser,
	MDate, MUser, MaterialCoreColorItemID 
FROM #temp_pMaterialCoreColorItem_Original


/*************************************************************************************************/
/*HEADER:  Generate new ID and update 'copy' temp tables with it.  Do 'users' and 'dates' too.	*/
/*************************************************************************************************/
--Make new id.
SET @MaterialCoreID_Copy = @MaterialCoreNewID --NEWID()

--Update header 'copy' temp table.
UPDATE #temp_pMaterialCore_Copy
SET MaterialCoreID = @MaterialCoreNewID
	,CUser = @CreatedBy
	,CDate = @CreatedDate
	,MUser = @CreatedBy
	,MDate = @CreatedDate
WHERE MaterialCoreID = @MaterialCoreID

--Update material 'copy' temp table.
UPDATE #temp_pMaterialCoreItem_Copy
SET MaterialCoreID = @MaterialCoreID_Copy
	,CUser = @CreatedBy
	,CDate = @CreatedDate
	,MUser = @CreatedBy
	,MDate = @CreatedDate
WHERE MaterialCoreID = @MaterialCoreID

--Update color 'copy' temp table.
UPDATE #temp_pMaterialCoreColor_Copy
SET MaterialCoreID = @MaterialCoreID_Copy
	,CUser = @CreatedBy
	,CDate = @CreatedDate
	,MUser = @CreatedBy
	,MDate = @CreatedDate
WHERE MaterialCoreID = @MaterialCoreID

--Update color chip 'copy' temp table.
UPDATE #temp_pMaterialCoreColorItem_Copy
SET MaterialCoreID = @MaterialCoreID_Copy
	,CUser = @CreatedBy
	,CDate = @CreatedDate
	,MUser = @CreatedBy
	,MDate = @CreatedDate
WHERE MaterialCoreID = @MaterialCoreID


/************************************************************************/
/*MATERIALS:  Generate new ID and update 'copy' temp tables with it.	*/
/************************************************************************/
--Get and set counters.
SELECT @TotalCount = COUNT(*) FROM #temp_pMaterialCoreItem_Original
SET @RowCounter = 1

--Loop to update 'copy' temp tables.
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		--Clear variable.
		SET @MaterialCoreItemID_Original = NULL

		--Make new id.
		SET @MaterialCoreItemID_Copy = NEWID()

		--Get an 'original' id.
		SELECT @MaterialCoreItemID_Original = MaterialCoreItemID
		FROM #temp_pMaterialCoreItem_Original
		WHERE TableRow = @RowCounter

		--Update material 'copy' temp table.
		UPDATE #temp_pMaterialCoreItem_Copy
		SET MaterialCoreItemID = @MaterialCoreItemID_Copy
		WHERE MaterialCoreItemID = @MaterialCoreItemID_Original

		--Update color chip 'copy' temp table.
		UPDATE #temp_pMaterialCoreColorItem_Copy
		SET MaterialCoreItemID = @MaterialCoreItemID_Copy
		WHERE MaterialCoreItemID = @MaterialCoreItemID_Original

		--Up counter.
		SET @RowCounter = @RowCounter + 1
	END


/********************************************************************/
/*COLORS:  Generate new ID and update 'copy' temp tables with it.	*/
/********************************************************************/
--Get and set counters.
SELECT @TotalCount = COUNT(*) FROM #temp_pMaterialCoreColor_Original
SET @RowCounter = 1

--Loop to update 'copy' temp tables.
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		--Clear variable.
		SET @MaterialCoreColorID_Original = NULL

		--Make new id.
		SET @MaterialCoreColorID_Copy = NEWID()

		--Get an 'original' id.
		SELECT @MaterialCoreColorID_Original = MaterialCoreColorID
		FROM #temp_pMaterialCoreColor_Original
		WHERE TableRow = @RowCounter

		--Update color 'copy' temp table.
		UPDATE #temp_pMaterialCoreColor_Copy
		SET MaterialCoreColorID = @MaterialCoreColorID_Copy
		WHERE MaterialCoreColorID = @MaterialCoreColorID_Original

		--Update color chip 'copy' temp table.
		UPDATE #temp_pMaterialCoreColorItem_Copy
		SET MaterialCoreColorID = @MaterialCoreColorID_Copy
		WHERE MaterialCoreColorID = @MaterialCoreColorID_Original

		--Up counter.
		SET @RowCounter = @RowCounter + 1
	END


/********************************************************/
/*COLOR CHIPS:  Generate new IDs for 'copy' temp table.	*/
/********************************************************/
--Update color chip 'copy' temp table.
UPDATE #temp_pMaterialCoreColorItem_Copy
SET MaterialCoreColorItemID = NEWID()


/************************************************/
/*Insert 'copy' records into the real tables.	*/
/************************************************/
--Material Group Header.
--INSERT INTO pMaterialCore
--	(MaterialCoreID, MaterialCoreName,MaterialCoreDescription, CUser, CDate,
--	MUser, MDate, Active, Sort)
--SELECT
--	MaterialCoreID, MaterialCoreName,MaterialCoreDescription, CUser, CDate,
--	MUser, MDate, Active, Sort
--FROM #temp_pMaterialCore_Copy

--Material Group Materials.
INSERT INTO pMaterialCoreItem
	(MaterialCoreItemID, MaterialCoreID, MaterialID, UOM, Qty, MaterialPrice,
	Ext, MaterialSize, Placement, Artwork, License, Colorway, CUser, CDate,
	MUser, MDate, MaterialCoreItemCopyID)
SELECT
	MaterialCoreItemID, MaterialCoreID, MaterialID, UOM, Qty, MaterialPrice,
	Ext, MaterialSize, Placement, Artwork, License, Colorway, CUser, CDate,
	MUser, MDate, MaterialCoreItemCopyID 
FROM #temp_pMaterialCoreItem_Copy

--Material Group Colors.
INSERT INTO pMaterialCoreColor
	(MaterialCoreColorID, MaterialCoreID, ColorPaletteID, ColorCode, ColorName,
	Active, Sort, CDate, CUser, MDate, MUser)
SELECT
	MaterialCoreColorID, MaterialCoreID, ColorPaletteID, ColorCode, ColorName,
	Active, Sort, CDate, CUser, MDate, MUser
FROM #temp_pMaterialCoreColor_Copy

--Material Group Color Chips.
INSERT INTO pMaterialCoreColorItem
	(MaterialCoreColorItemID, MaterialCoreColorItemMasterID, MaterialCoreColorID,
	MaterialCoreItemID, MaterialCoreID, MaterialID, MaterialColorID, CDate, CUser,
	MDate, MUser, MaterialCoreColorItemCopyID)
SELECT
	MaterialCoreColorItemID, MaterialCoreColorItemMasterID, MaterialCoreColorID,
	MaterialCoreItemID, MaterialCoreID, MaterialID, MaterialColorID, CDate, CUser,
	MDate, MUser, MaterialCoreColorItemCopyID 
FROM #temp_pMaterialCoreColorItem_Copy


--/************/
--/*Testing.	*/
--/************/
--SELECT * FROM #temp_pMaterialCore_Original
--SELECT * FROM #temp_pMaterialCore_Copy
--SELECT * FROM #temp_pMaterialCoreItem_Original
--SELECT * FROM #temp_pMaterialCoreItem_Copy
--SELECT * FROM #temp_pMaterialCoreColor_Original
--SELECT * FROM #temp_pMaterialCoreColor_Copy
--SELECT * FROM #temp_pMaterialCoreColorItem_Original
--SELECT * FROM #temp_pMaterialCoreColorItem_Copy


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_pMaterialCore_Original
DROP TABLE #temp_pMaterialCore_Copy
DROP TABLE #temp_pMaterialCoreItem_Original
DROP TABLE #temp_pMaterialCoreItem_Copy
DROP TABLE #temp_pMaterialCoreColor_Original
DROP TABLE #temp_pMaterialCoreColor_Copy
DROP TABLE #temp_pMaterialCoreColorItem_Original
DROP TABLE #temp_pMaterialCoreColorItem_Copy

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_SampleRequest_Global_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.
*/



ALTER   proc [dbo].[rpx_SampleRequest_Global_SELECT]
	@Agent nvarchar(200) = null,
	@Season nvarchar(200) = null,
	@Year nvarchar(200) = null,
	@Category nvarchar(200) = null
as


select	tp.TradePartnerName, 
		tpv.VendorName,
		cast(sh.StyleID as varchar(50)) as StyleID,
		sh.StyleNo, 
		sh.Description,
		sh.StyleSet, 
		sh.SizeClass,
		sh.SizeRange,
		ISNULL(sc.MainColor,'NA') AS Color, 
		sh.DueDate AS [Tech Pack],
		sw.SampleWorkflowID,
		sw.SampleWorkflow,
		srw.DueDate,
		srw.EndDate,
		dbo.fnx_GetStreamingImagePath(i.ImageID, i.[Version]) AS FilePath	--Comment #01
from	pSampleRequestWorkflow srw
inner join	pSampleWorkflow sw on srw.SampleWorkflowID = sw.SampleWorkflowID
inner join	pStyleHeader sh on srw.StyleID = sh.StyleID
inner join	uTradePartner tp on srw.TradePartnerID = tp.TradePartnerID
inner join	uTradePartnerVendor tpv on srw.TradePartnerVendorID = tpv.TradePartnerVendorID
left outer join	pStyleColorway sc on srw.StyleColorID = sc.StyleColorID
left outer join	hImage i on sh.DesignSketchID = i.ImageID and sh.DesignSketchVersion = i.Version
where	(@Agent is null or srw.TradePartnerID = @Agent)
and 	(@Season is null or sh.CustomField2 = @Season)
and 	(@Year is null or sh.CustomField4 = @Year)
and 	(@Category is null or sh.CustomField5 = @Category)





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_Group_AccessBodyFolder_UPDATE]'
GO


CREATE PROCEDURE [dbo].[spx_Group_AccessBodyFolder_UPDATE]  (
@AccessRoleId int  , 
@AccessView int , 
@AccessCreate int , 
@AccessModify int, 
@AccessRemove int , 
@AccessDelete int , 
@AccessPrint int , 
@GroupID uniqueidentifier , 
@MUser nvarchar (200), 
@MDate  datetime , 
@AccessBodyId uniqueidentifier 
)
AS 

	UPDATE sAccessGroupBodyFolder  
	SET AccessRoleId = @AccessRoleId, 
	AccessView = @AccessView,  
	AccessCreate = @AccessCreate,  
	AccessModify = @AccessModify, 
	AccessRemove = @AccessRemove, 
	AccessDelete = @AccessDelete,  
	AccessPrint = @AccessPrint, 
	GroupID = @GroupID, 
	MUser = @MUser,  
	MDate = @MDate  
	WHERE AccessBodyId = @AccessBodyId
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_ReleaseCalendarLateSummary_SELECT]'
GO
ALTER  PROCEDURE [dbo].[spx_ReleaseCalendarLateSummary_SELECT](@StartDate datetime,
@TradePartnerId uniqueidentifier)
AS SELECT     COUNT(*) AS CriticalCount, dbo.pSampleRequestWorkflow.TradePartnerID, dbo.pSampleWorkflow.GroupName AS Workflow
FROM         dbo.pSampleRequestWorkflow WITH (NOLOCK) INNER JOIN
                      dbo.pSampleWorkflow WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.SampleWorkflowID = dbo.pSampleWorkflow.SampleWorkflowID
WHERE     (NOT (dbo.pSampleRequestWorkflow.Status IN (2, 3, 4))) AND (dbo.pSampleRequestWorkflow.DueDate < @StartDate)
GROUP BY dbo.pSampleWorkflow.SampleWorkflowID, dbo.pSampleRequestWorkflow.TradePartnerID, dbo.pSampleWorkflow.GroupName
HAVING      (dbo.pSampleRequestWorkflow.TradePartnerID = @TradePartnerId)
ORDER BY dbo.pSampleWorkflow.SampleWorkflowID



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialTradePartnerColorSeasonYearLogic_INSERT]'
GO
/*
	Commenet #01 - Clayton Parker - March 3rd 2010 
	There was an issue where if you had a color in multiple sizes each size was not being updated accordingly. 
	The system was updating the same color for all sizes with the same information. I updated the procedure to also filter by materialsizeid.
*/

CREATE PROCEDURE [dbo].[spx_MaterialTradePartnerColorSeasonYearLogic_INSERT] (
@MaterialColorSeasonYearID UNIQUEIDENTIFIER,
@MaterialTradePartnerID UNIQUEIDENTIFIER,
@MaterialSizeID UNIQUEIDENTIFIER,
@CUser NVARCHAR(200),
@CDate DATETIME 
)
AS


IF @MaterialSizeID IS NULL 
	SET @MaterialSizeID  = '00000000-0000-0000-0000-000000000000'


DECLARE @SeasonYearID UNIQUEIDENTIFIER 
DECLARE @ColorSeasonYearID UNIQUEIDENTIFIER 
DECLARE @TradePartnerID UNIQUEIDENTIFIER 
DECLARE @TradePartnerVendorID UNIQUEIDENTIFIER 
DECLARE @MaterialID UNIQUEIDENTIFIER 
DECLARE @MaterialColorID  UNIQUEIDENTIFIER 
DECLARE @MaterialTradePartnerIDNew UNIQUEIDENTIFIER
DECLARE @MaterialTradePartnerColorIDNew UNIQUEIDENTIFIER 
DECLARE @ColorPaletteID UNIQUEIDENTIFIER 
DECLARE @ColorName NVARCHAR(200)
DECLARE @ColorCode NVARCHAR(200)


SELECT @ColorSeasonYearID = a.SeasonYearID, @MaterialColorID = a.MaterialColorID,
@ColorPaletteID = b.ColorPaletteID, @ColorName = ColorName, @ColorCode = ColorCode
FROM pMaterialColorSeasonYear a
INNER JOIN pMaterialColor b On a.MaterialColorID = b.MaterialColorID
WHERE a.MaterialColorSeasonYearID = @MaterialColorSeasonYearID

SELECT @TradePartnerID = TradePartnerID, @TradePartnerVendorID = TradePartnerVendorID,
@MaterialID = MaterialID
FROM pMaterialTradePartner WHERE MaterialTradePartnerID = @MaterialTradePartnerID


/***
** Check if the relation material / tradepartner / seasonyear  Exists
**/
SELECT @MaterialTradePartnerIDNew = MaterialTradePartnerID  FROM pMaterialTradePartner  
WHERE MaterialID = @MaterialID 
AND TradePartnerVendorID = @TradePartnerVendorID  
AND SeasonYearID = @ColorSeasonYearID 

IF @MaterialTradePartnerIDNew IS NULL 
BEGIN 
	SET @MaterialTradePartnerIDNew =  NEWID()

	INSERT INTO  pMaterialTradePartner (MaterialTradepartnerID , MaterialID , TradePartnerID , TradePartnerVendorID,
	CUser, CDate, MUser, MDate, SeasonYearID ) 
	VALUES ( @MaterialTradePartnerIDNew , @MaterialID , @TradePartnerID , @TradePartnerVendorID,
	@CUser, @CDate, @CUser, @CDate, @ColorSeasonYearID) 

END 



IF @MaterialSizeID  = '00000000-0000-0000-0000-000000000000'
	SELECT @MaterialTradePartnerColorIDNew = MaterialTradePartnerColorID FROM pMaterialTradePartnerColor
	WHERE MaterialColorID = @MaterialColorID 
	AND MaterialTradepartnerID = @MaterialTradePartnerIDNew
	AND ( MaterialSizeID =  @MaterialSizeID OR MaterialSizeID  IS NULL ) 
ELSE 
	SELECT @MaterialTradePartnerColorIDNew = MaterialTradePartnerColorID  FROM pMaterialTradePartnerColor
	WHERE MaterialColorID = @MaterialColorID 
	AND MaterialTradepartnerID = @MaterialTradePartnerIDNew
	AND MaterialSizeID = @MaterialSizeID 



IF @MaterialTradePartnerColorIDNew IS NULL 
BEGIN

	SET @MaterialTradePartnerColorIDNew = NEWID() 

	INSERT INTO  pMaterialTradePartnerColor ( MaterialTradePartnerColorID, MaterialTradePartnerID , MaterialColorID, MaterialID, 
	ColorFolderID , ColorPaletteID, ColorCode, ColorName, ColorSource, Hex, R, G, B, C, M , Y, K , H, S, L, LAB_L, LAB_A, LAB_B, 
	CDate, CUser, MDate, MUser, MaterialColorVersion, ColorVersion, MaterialSizeID )
	SELECT @MaterialTradePartnerColorIDNew, @MaterialTradePartnerIDNew, @MaterialColorID, @MaterialID, 
	ColorFolderID, ColorPaletteID , ColorCode, ColorName, ColorSource, Hex, R, G, B, C, M , Y, K, H, S, L, LAB_L, LAB_A, LAB_B,
	@CDate, @CUser, @CDate, @CUser, 1, 1, @MaterialSizeID
	FROM pColorPalette
	WHERE ColorPaletteID  = @ColorPaletteID 

END 


DECLARE @MaterialTradePartnerColorID UNIQUEIDENTIFIER 
DECLARE @LastSeasonMaterialtradePartnerID UNIQUEIDENTIFIER 

SELECT TOP 1 @MaterialTradePartnerColorID = MaterialTradePartnerColorID,
@LastSeasonMaterialtradePartnerID = MaterialtradePartnerID
FROM pMaterialTradePartnerColor a
INNER JOIN pColorPalette b ON a.ColorPaletteID =  b.ColorPaletteID 
WHERE MaterialTradepartnerID = @MaterialTradepartnerID
AND b.ColorCode = @ColorCode AND b.ColorName = @ColorName and a.MaterialSizeID = @MaterialSizeID  --Comment #01

IF @MaterialTradePartnerColorID  IS NOT NULL AND @LastSeasonMaterialtradePartnerID IS NOT NULL
BEGIN 

	DECLARE @MaterialTradePartnerCustom1 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom2 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom3 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom4 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom5 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom6 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom7 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom8 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom9 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom10 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom11 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom12 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom13 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom14 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom15 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom16 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom17 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom18 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom19 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom20 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom21 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom22 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom23 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom24 NVARCHAR(50)
	DECLARE @MaterialTradePartnerCustom25 NVARCHAR(50)

	SELECT 	@MaterialTradePartnerCustom1 = MaterialTradePartnerCustom1, @MaterialTradePartnerCustom2 = MaterialTradePartnerCustom2, 
	@MaterialTradePartnerCustom3 = MaterialTradePartnerCustom3, @MaterialTradePartnerCustom4 = MaterialTradePartnerCustom4, 
	@MaterialTradePartnerCustom5 = MaterialTradePartnerCustom5, @MaterialTradePartnerCustom6 = MaterialTradePartnerCustom6, 
	@MaterialTradePartnerCustom7 = MaterialTradePartnerCustom7, @MaterialTradePartnerCustom8 = MaterialTradePartnerCustom8, 
	@MaterialTradePartnerCustom9 = MaterialTradePartnerCustom9, @MaterialTradePartnerCustom10 = MaterialTradePartnerCustom10, 
	@MaterialTradePartnerCustom11 = MaterialTradePartnerCustom11, @MaterialTradePartnerCustom12 = MaterialTradePartnerCustom12, 
	@MaterialTradePartnerCustom13 = MaterialTradePartnerCustom13, @MaterialTradePartnerCustom14 = MaterialTradePartnerCustom14, 
	@MaterialTradePartnerCustom15 = MaterialTradePartnerCustom15, @MaterialTradePartnerCustom16 = MaterialTradePartnerCustom16, 
	@MaterialTradePartnerCustom17 = MaterialTradePartnerCustom17, @MaterialTradePartnerCustom18 = MaterialTradePartnerCustom18, 
	@MaterialTradePartnerCustom19 = MaterialTradePartnerCustom19, @MaterialTradePartnerCustom20 = MaterialTradePartnerCustom20, 	
	@MaterialTradePartnerCustom21 = MaterialTradePartnerCustom21, @MaterialTradePartnerCustom22 = MaterialTradePartnerCustom22, 
	@MaterialTradePartnerCustom23 = MaterialTradePartnerCustom23, @MaterialTradePartnerCustom24 = MaterialTradePartnerCustom24, 
	@MaterialTradePartnerCustom25 = MaterialTradePartnerCustom25	
	FROM pMaterialtradePartner WHERE MaterialtradePartnerID = @LastSeasonMaterialtradePartnerID

	DECLARE @MaterialPrice MONEY
	DECLARE @MaterialTradeColor1 NVARCHAR(200)
	DECLARE @MaterialTradeColor2 NVARCHAR(200)
	DECLARE @MaterialTradeColor3 NVARCHAR(200)
	DECLARE @MaterialTradeColor4 NVARCHAR(200)
	DECLARE @MaterialTradeColor5 NVARCHAR(200)
	DECLARE @MaterialTradeColor6 NVARCHAR(200)
	DECLARE @MaterialTradeColor7 NVARCHAR(200)
	DECLARE @MaterialTradeColor8 NVARCHAR(200)
	DECLARE @MaterialTradeColor9 DECIMAL(18,2)
	DECLARE @MaterialTradeColor10 DECIMAL(18,2)
	DECLARE @MaterialTradeColor11 DECIMAL(18,2)
	DECLARE @MaterialTradeColor12 DECIMAL(18,2)
	DECLARE @MaterialTradeColor13 DECIMAL(18,2)
	DECLARE @MaterialTradeColor14 NVARCHAR(200)
	DECLARE @MaterialTradeColor15 NVARCHAR(200)
	DECLARE @MaterialTradeColor16 NVARCHAR(200)
	DECLARE @MaterialTradeColor17 NVARCHAR(200)
	DECLARE @MaterialTradeColor18 NVARCHAR(200)
	DECLARE @MaterialTradeColor19 NVARCHAR(200)
	DECLARE @MaterialTradeColor20 NVARCHAR(200)
	DECLARE @MaterialTradeColor21 NVARCHAR(200)
	DECLARE @MaterialTradeColor22 NVARCHAR(200)
	DECLARE @MaterialTradeColor23 NVARCHAR(200)
	DECLARE @MaterialTradeColor24 NVARCHAR(200)
	DECLARE @MaterialTradeColor25 NVARCHAR(200)

	SELECT @MaterialPrice = MaterialPrice, 
	@MaterialTradeColor1 = MaterialTradeColor1, @MaterialTradeColor2 = MaterialTradeColor2,
	@MaterialTradeColor3 = MaterialTradeColor3, @MaterialTradeColor4 = MaterialTradeColor4,
	@MaterialTradeColor5 = MaterialTradeColor5, @MaterialTradeColor6 = MaterialTradeColor6,
	@MaterialTradeColor7 = MaterialTradeColor7, @MaterialTradeColor8 = MaterialTradeColor8,
	@MaterialTradeColor9 = MaterialTradeColor9, @MaterialTradeColor10 = MaterialTradeColor10,
	@MaterialTradeColor11 = MaterialTradeColor11, @MaterialTradeColor12 = MaterialTradeColor12,
	@MaterialTradeColor13 = MaterialTradeColor13, @MaterialTradeColor14 = MaterialTradeColor14,
	@MaterialTradeColor15 = MaterialTradeColor15, @MaterialTradeColor16 = MaterialTradeColor16,
	@MaterialTradeColor17 = MaterialTradeColor17, @MaterialTradeColor18 = MaterialTradeColor18,
	@MaterialTradeColor19 = MaterialTradeColor19, @MaterialTradeColor20 = MaterialTradeColor20,	
	@MaterialTradeColor21 = MaterialTradeColor21, @MaterialTradeColor22 = MaterialTradeColor22,
	@MaterialTradeColor23 = MaterialTradeColor23, @MaterialTradeColor24 = MaterialTradeColor24,
	@MaterialTradeColor25 = MaterialTradeColor25
	FROM pMaterialtradePartnerColor WHERE MaterialtradePartnerColorID = @MaterialTradePartnerColorID


	UPDATE pMaterialtradePartner SET 
	MaterialTradePartnerCustom1 = @MaterialTradePartnerCustom1, MaterialTradePartnerCustom2 = @MaterialTradePartnerCustom2, 
	MaterialTradePartnerCustom3 = @MaterialTradePartnerCustom3, MaterialTradePartnerCustom4 = @MaterialTradePartnerCustom4, 
	MaterialTradePartnerCustom5 = @MaterialTradePartnerCustom5, MaterialTradePartnerCustom6 = @MaterialTradePartnerCustom6, 
	MaterialTradePartnerCustom7 = @MaterialTradePartnerCustom7, MaterialTradePartnerCustom8 = @MaterialTradePartnerCustom8, 
	MaterialTradePartnerCustom9 = @MaterialTradePartnerCustom9, MaterialTradePartnerCustom10 = @MaterialTradePartnerCustom10, 
	MaterialTradePartnerCustom11 = @MaterialTradePartnerCustom11, MaterialTradePartnerCustom12 = @MaterialTradePartnerCustom12, 
	MaterialTradePartnerCustom13 = @MaterialTradePartnerCustom13, MaterialTradePartnerCustom14 = @MaterialTradePartnerCustom14, 
	MaterialTradePartnerCustom15 = @MaterialTradePartnerCustom15, MaterialTradePartnerCustom16 = @MaterialTradePartnerCustom16, 
	MaterialTradePartnerCustom17 = @MaterialTradePartnerCustom17, MaterialTradePartnerCustom18 = @MaterialTradePartnerCustom18, 
	MaterialTradePartnerCustom19 = @MaterialTradePartnerCustom19, MaterialTradePartnerCustom20 = @MaterialTradePartnerCustom20, 	
	MaterialTradePartnerCustom21 = @MaterialTradePartnerCustom21, MaterialTradePartnerCustom22 = @MaterialTradePartnerCustom22, 
	MaterialTradePartnerCustom23 = @MaterialTradePartnerCustom23, MaterialTradePartnerCustom24 = @MaterialTradePartnerCustom24, 
	MaterialTradePartnerCustom25 = @MaterialTradePartnerCustom25	
	WHERE MaterialtradePartnerID = @MaterialTradePartnerIDNew

	UPDATE pMaterialtradePartnerColor SET 
	MaterialPrice = @MaterialPrice,
	MaterialTradeColor1 = @MaterialTradeColor1, MaterialTradeColor2 = @MaterialTradeColor2,
	MaterialTradeColor3 = @MaterialTradeColor3, MaterialTradeColor4 = @MaterialTradeColor4,
	MaterialTradeColor5 = @MaterialTradeColor5, MaterialTradeColor6 = @MaterialTradeColor6,
	MaterialTradeColor7 = @MaterialTradeColor7, MaterialTradeColor8 = @MaterialTradeColor8,
	MaterialTradeColor9 = @MaterialTradeColor9, MaterialTradeColor10 = @MaterialTradeColor10,
	MaterialTradeColor11 = @MaterialTradeColor11, MaterialTradeColor12 = @MaterialTradeColor12,
	MaterialTradeColor13 = @MaterialTradeColor13, MaterialTradeColor14 = @MaterialTradeColor14,
	MaterialTradeColor15 = @MaterialTradeColor15, MaterialTradeColor16 = @MaterialTradeColor16,
	MaterialTradeColor17 = @MaterialTradeColor17, MaterialTradeColor18 = @MaterialTradeColor18,
	MaterialTradeColor19 = @MaterialTradeColor19, MaterialTradeColor20 = @MaterialTradeColor20,	
	MaterialTradeColor21 = @MaterialTradeColor21, MaterialTradeColor22 = @MaterialTradeColor22,
	MaterialTradeColor23 = @MaterialTradeColor23, MaterialTradeColor24 = @MaterialTradeColor24,
	MaterialTradeColor25 = @MaterialTradeColor25
	WHERE MaterialTradePartnerColorID = @MaterialTradePartnerColorIDNew


END 

SELECT @MaterialTradePartnerIDNew AS MaterialTradePartnerColorID


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SystemServerStorageImageVersion_SELECT]'
GO



ALTER PROCEDURE [dbo].[spx_SystemServerStorageImageVersion_SELECT](@ImageId uniqueidentifier, @ImageVersion int)
AS 

SELECT 
sSystemServerStorageSetting.ImageVersionPath + '\{' + CAST(hImage.ImageID AS VARCHAR(40)) + '}\Version\000\{' + CAST(hImage.ImageHistoryID AS VARCHAR(40)) + '}.jpg' AS ImageVersionPath 
FROM hImage WITH (NOLOCK) INNER JOIN
      sSystemServerStorageSetting WITH (NOLOCK) ON hImage.SystemServerStorageID = sSystemServerStorageSetting.SystemServerStorageID
WHERE (hImage.ImageID = @ImageId) AND (hImage.Version = @ImageVersion)




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Style_MaterialImageGrid_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.
*/


ALTER   PROCEDURE [dbo].[rpx_Style_MaterialImageGrid_SELECT]
	(@StyleID AS varchar(50), 	
	@StyleSet AS int)
AS 


SELECT RTRIM(ct.ComponentDescription) AS ComponentDescription, sm.MainMaterial, sm.MaterialNo, 
	 sm.MaterialName, sm.G AS Content, sm.H AS Construction, sm.I AS YarnSizeCount, sm.K AS Weight, 
	 sm.L AS WashFabr, sm.Placement, sm.Qty, sm.MaterialSize, 
	 (dbo.fnx_GetStreamingImagePath(hi.ImageID, hi.[Version])) AS FilePath	--Comment #01
FROM pStyleMaterials sm INNER JOIN pComponentType ct ON
	sm.MaterialType = ct.ComponentTypeID LEFT OUTER JOIN hImage hi ON
	sm.MaterialImageID = hi.ImageID AND sm.MaterialImageVersion = hi.Version 
WHERE ((sm.StyleSet = @StyleSet) AND
	(sm.StyleID = @StyleID))

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[fix_StyleMaterialSummary_MaterialSize]'
GO
CREATE PROCEDURE dbo.fix_StyleMaterialSummary_MaterialSize 
AS

DECLARE @TOTAL INT 
DECLARE @ROW_ID INT 

DECLARE @StyleMaterialID UNIQUEIDENTIFIER 
DECLARE @MaterialSizeID UNIQUEIDENTIFIER 
DECLARE @MaterialSize NVARCHAR(200)
DECLARE @MaterialID UNIQUEIDENTIFIER 

CREATE TABLE #tmpMat (
ROW_ID INT IDENTITY (1,1),
StyleMaterialID UNIQUEIDENTIFIER, 
MaterialID UNIQUEIDENTIFIER, 
MaterialSizeID  UNIQUEIDENTIFIER, 
MaterialSize NVARCHAR(200)
)

INSERT INTO #tmpMat (StyleMaterialID, MaterialID, MaterialSizeID , MaterialSize)
SELECT StyleMaterialID , MaterialID, MaterialSizeID , MaterialSize
FROM pStyleMaterials


SET @ROW_ID = 1 
SELECT @TOTAL  = COUNT (*)  FROM #tmpMat 

WHILE @ROW_ID <= @TOTAL
BEGIN 

      SET @MaterialSizeID = NULL 

      SELECT @StyleMaterialID = StyleMaterialID, @MaterialSize = MaterialSize, @MaterialID = MaterialID 
      FROM #tmpMat
      WHERE ROW_ID = @ROW_ID

      IF UPPER(@MaterialSize) = '*NA'
      BEGIN
            SET @MaterialSize = '*NA'
            SET @MaterialSizeID = '00000000-0000-0000-0000-000000000000'
      END
      ELSE 
            SELECT @MaterialSizeID = MaterialSizeID FROM pMaterialSize WHERE MaterialID = @MaterialID AND MaterialSize = @MaterialSize 

      
      IF @MaterialSizeID IS NOT  NULL 
      BEGIN
            UPDATE pStyleMaterials SET MaterialSize = @MaterialSize , MaterialSizeID = @MaterialSizeID
            WHERE StyleMaterialID = @StyleMaterialID
      END 
      ELSE 
            PRINT 'StyleMaterialID = ' + CAST (@StyleMaterialID AS NVARCHAR(50))


      SET @ROW_ID = @ROW_ID + 1 

      print CAST (@ROW_ID  AS NVARCHAR(20))

END 


DROP TABLE #tmpMat

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_ReleaseTradePartnerVendorSummary_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_ReleaseTradePartnerVendorSummary_SELECT](@TradePartnerId uniqueidentifier)
AS SELECT     VendorCode, VendorName, Country
FROM         dbo.uTradePartnerVendor WITH (NOLOCK)
WHERE     (TradePartnerID = @TradePartnerId)
UNION
SELECT     VendorCode, VendorName, Country
FROM         dbo.uTradePartnerVendor WITH (NOLOCK)
WHERE     (TradePartnerID = @TradePartnerId)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcingSeasonYearColor_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_StyleSourcingSeasonYearColor_SELECT] (
@StyleID UNIQUEIDENTIFIER,   
@StyleSet INT ,
@SeasonYearID UNIQUEIDENTIFIER
)
AS



IF @SeasonYearID IS NULL 
BEGIN
	SELECT TOP 1 @SeasonYearID = SeasonYearID FROM pStyleSeasonYear WHERE StyleID = @StyleID
END 


IF @SeasonYearID IS NOT NULL
BEGIN 


	DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER 
	SELECT @StyleSeasonYearID  = StyleSeasonYearID 
	FROM pStyleSeasonYear
	WHERE SeasonYearID = @SeasonYearID AND StyleID = @StyleID 


	SELECT StyleColorID,  ColorCode as StyleColorNo,  ColorName as StyleColorName,  ColorName as MainColor 
	FROM pStyleColorwaySeasonYear a 
	INNER JOIN pStyleColorway b ON a.StyleColorwayID = b.StyleColorID
	LEFT OUTER JOIN pColorPalette c ON c.ColorPaletteID = b.ColorPaletteID
	WHERE a.StyleID = @StyleID 
	AND b.StyleSet = @StyleSet
	AND a.StyleSeasonYearID = @StyleSeasonYearID


END 
ELSE
BEGIN 

	SELECT StyleColorID,  ColorCode as StyleColorNo,  ColorName as StyleColorName,  ColorName as MainColor 
	FROM pStyleColorway a 
	LEFT OUTER JOIN pColorPalette b ON b.ColorPaletteID = a.ColorPaletteID
	WHERE a.StyleID = @StyleID 
	AND a.StyleSet = @StyleSet

END 

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_SystemServerStorageImageVersionPath_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_SystemServerStorageImageVersionPath_SELECT](
@ImageId uniqueidentifier,
@ImageVersion int)
AS 

SELECT 
sSystemServerStorageSetting.ImageVersionPath + '\{' + CAST(@ImageId AS VARCHAR(40)) + '}' 
ImageVersionPath 
FROM hImage WITH (NOLOCK) 
INNER JOIN sSystemServerStorageSetting WITH (NOLOCK) ON hImage.SystemServerStorageID = sSystemServerStorageSetting.SystemServerStorageID
WHERE hImage.ImageID = @ImageId
AND hImage.Version = @ImageVersion





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleHeaderMainMaterial_UPDATE]'
GO

ALTER PROCEDURE [dbo].[spx_StyleHeaderMainMaterial_UPDATE]
(
@StyleId uniqueidentifier,
@StyleMaterialId uniqueidentifier)
AS 

DECLARE
@MainMaterial int,
@MaterialId uniqueidentifier,
@MaterialImageId uniqueidentifier,
@MaterialImageVersion int,
@MaterialNo nvarchar(50),
@MaterialName nvarchar(200),
@MaterialNull nvarchar(50)


SELECT @MainMaterial = MainMaterial, 
	@MaterialId = MaterialId,
	@MaterialImageId = MaterialImageId,
	@MaterialImageVersion = MaterialImageVersion,
	@MaterialNo = MaterialNo,
	@MaterialName = MaterialName 
FROM pStyleMaterials WITH (NOLOCK) WHERE (StyleMaterialId = @StyleMaterialid)


IF @MainMaterial = 1

	UPDATE dbo.pStyleHeader
		SET  MaterialID = @MaterialId, MaterialImageID = @MaterialImageId, MaterialImageVersion = @MaterialImageVersion, MaterialNo = @MaterialNo, 
		MaterialName = @MaterialName, StyleMaterialID = @StyleMaterialId
	WHERE  (StyleID = @StyleId)

ELSE

SET @MaterialNull = '{00000000-0000-0000-0000-000000000000}'

	UPDATE dbo.pStyleHeader
		SET  MaterialID = @MaterialNull, MaterialImageID = @MaterialNull, MaterialImageVersion = 0, MaterialNo = NULL, 
		MaterialName = NULL, StyleMaterialID = @MaterialNull
	WHERE  (StyleID = @StyleId)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_MaterialWizardRequest_ColorSeasonYear_Available_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_MaterialWizardRequest_ColorSeasonYear_Available_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialCoreColor_DELETE]'
GO

CREATE PROCEDURE [dbo].[spx_MaterialCoreColor_DELETE] (
@MaterialCoreColorID UNIQUEIDENTIFIER 
)
AS 

	DELETE pMaterialCoreColor WHERE MaterialCoreColorID  = @MaterialCoreColorID
	DELETE pMaterialCoreColorItem WHERE  MaterialCoreColorID  = @MaterialCoreColorID
	
	
	
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_AccessColorFolder_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_User_AccessColorFolder_SELECT]
(@teamId uniqueidentifier)
AS 


SELECT 1 AS ColorTypeID, 'Color Folder' AS ColorFolder, sAccessColorFolder.AccessColorId, 
    sAccessColorFolder.AccessRoleId, sAccessColorFolder.AccessView, sAccessColorFolder.AccessCreate, 
    sAccessColorFolder.AccessModify, sAccessColorFolder.AccessDelete, sAccessColorFolder.AccessPrint, 
    sAccessColorFolder.TeamId, sAccessColorFolder.CUser, sAccessColorFolder.CDate, sAccessColorFolder.MUser, 
    sAccessColorFolder.MDate  
FROM  sAccessColorFolder WITH (NOLOCK) 
WHERE(sAccessColorFolder.TeamId = @teamId)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Style_Quote_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.
*/


ALTER      procedure [dbo].[rpx_Style_Quote_SELECT]
    @StyleType int = null,
    @Season varchar(200) = null,
    @Year varchar(10) = null,
    @ProductCategory varchar(50) = null
as


select 
sh.StyleNo,
sh.[Description],
sh.SizeClass,
sh.SizeRange,
sc.StyleCostingCustomField2 as Weight,
sc.StyleCostingCustomField1 as TargetRetail,
sc.StyleCostingCustomField3 as TargetMargin,
sc.StyleCostingCustomField8 as Royalty,
sc.StyleCostingCustomField4 as MiscCost,
sc.StyleCostingCustomField18 as Units,
sct.StyleCostingType as CostingType,
sc.StyleCostingCustomField14 as TargetFirstCost,
sc.StyleCostingCustomField15 as FirstCost,
sc.StyleCostingCustomField11 as DutyPct,
scd.DutyCategory as QuotaCategory,
sc.StyleCostingCustomField9 as Commission,
dbo.fnx_GetStreamingImagePath(i.ImageID, i.[Version]) AS FilePath	--Comment #01
from pStyleHeader sh WITH (NOLOCK)
join pStyleCosting sc on sh.StyleID = sc.StyleID
join pStyleCostingType sct on sc.StyleCostingTypeID = sct.StyleCostingTypeID
join pStyleCostingDuty scd on sc.StyleQuotaDutyId = scd.DutyId
left outer join hImage i on sh.DesignSketchID = i.ImageID and sh.DesignSketchVersion = i.Version
where (@StyleType is null or sh.StyleType = @StyleType)
and (@Season is null or sh.CustomField2 = @Season)
and (@Year is null or sh.CustomField4 = @Year)
and (@ProductCategory is null or sh.CustomField5 = @ProductCategory)







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleHeaderNoLogic_UPDATE]'
GO

ALTER  PROCEDURE [dbo].[spx_StyleHeaderNoLogic_UPDATE]
(@StyleNo nvarchar(20),
@TempId nvarchar(20),
@TempNo nvarchar(20),
@StyleId uniqueidentifier)
AS 


DECLARE @StyleDevelopmentId uniqueidentifier
DECLARE @StyleVariation int

SELECT TOP 1 @StyleVariation = Variation, @StyleDevelopmentId = StyleDevelopmentId FROM pStyleDevelopmentItem WITH (NOLOCK) WHERE StyleId = @StyleId

IF (SELECT COUNT(*) FROM pStyleDevelopmentItem WITH (NOLOCK) WHERE Variation = @StyleVariation AND StyleDevelopmentId = @StyleDevelopmentId) = 1 
	BEGIN
		UPDATE  pStyleHeader
		SET StyleNo = @StyleNo, TempID = @TempId, TempNo = @TempNo
		WHERE   (StyleID = @StyleId)
	END	
	
	
ELSE
	BEGIN
	
		DECLARE @tmpStyleId uniqueidentifier
		DECLARE @tmpStyleNo nvarchar(20)
		DECLARE @tmpTempId nvarchar(20)
		DECLARE @tmpTempNo nvarchar(20)
		
		SELECT TOP 1 @tmpStyleId = StyleId FROM pStyleDevelopmentItem WITH (NOLOCK) 
		WHERE Variation = @StyleVariation AND StyleDevelopmentId = @StyleDevelopmentId 
		ORDER BY CDate ASC
	
		SELECT TOP 1 @tmpStyleNo = StyleNo, @tmpTempID = TempId, @tmpTempNo = TempNo FROM pStyleHeader WITH (NOLOCK)
		WHERE StyleID = @tmpStyleId
		
		DECLARE @NewStyleNo nvarchar(20)
		SET @NewStyleNo = REPLACE(@TempId, 'AUTOID', @tmpTempNo)
	
		UPDATE  pStyleHeader
		SET StyleNo = @NewStyleNo, TempID = @TempId, TempNo = @tmpTempNo
		WHERE   (StyleID = @StyleId)
	
	END	
	
	
	
--- *************************************************
-- Season/ Year 
--
--DECLARE @Season NVARCHAR(200)
--DECLARE @Year NVARCHAR(200)
--DECLARE @SeasonYearID UNIQUEIDENTIFIER 
--DECLARE @StyleSeasonYearID  UNIQUEIDENTIFIER 
--
--SELECT @Season = CustomField5, @Year = CustomField6
--FROM pStyleHeader 
--WHERE StyleID = @StyleId
--
--IF @Season IS NULL 
--	SET @Season = '*NA'
--IF @Year IS NULL
--	SET @Year  = '*NA'
--
--SELECT @SeasonYearID = SeasonYearID FROM pSeasonYear WHERE Season = @Season AND Year = @Year
--IF @SeasonYearID IS NULL
--BEGIN
--	SET @SeasonYearID = NEWID()
--	INSERT INTO  pSeasonYear (SeasonYearID , Season, Year, Active )
--	VALUES (@SeasonYearID , @Season, @Year, 1 )
--END 
--
--
--SELECT @StyleSeasonYearID = StyleSeasonYearID 
--FROM pStyleSeasonYear 
--WHERE SeasonYearID = @SeasonYearID AND StyleID = @StyleID
--
--
--
--IF @StyleSeasonYearID IS NULL 
--BEGIN 
--	SET @StyleSeasonYearID  = NEWID()
--	INSERT INTO  pStyleSeasonYear ( StyleSeasonYearID , StyleID , StyleSeason, StyleYear,SeasonYearID, StyleNo, MUser )
--	VALUES ( NEWID(), @StyleID , @Season, @Year, @SeasonYearID , @StyleNo, 'SYSTEM' )
--END 
--









GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteItemAgent_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_StyleQuoteItemAgent_SELECT]
(@StyleId uniqueidentifier,
@TradePartnerID uniqueidentifier)
AS SELECT     dbo.pStyleQuoteItem.StyleQuoteItemID, dbo.pStyleQuoteItem.StyleQuoteItemNo, dbo.pStyleQuoteItem.StyleQuoteItemStatusId, 
                      dbo.pStyleQuoteItem.StyleQuoteID, dbo.pStyleQuoteItem.StyleDevelopmentID, dbo.pStyleQuoteItem.StyleID, 
                      dbo.pStyleQuoteItem.StyleQuoteTradePartnerID, dbo.pStyleQuoteItem.StyleCostingID, dbo.pStyleQuoteItem.TradePartnerID, 
                      dbo.pStyleQuoteItem.TradePartnerVendorID, dbo.uTradePartnerVendor.VendorCode, dbo.uTradePartnerVendor.VendorName, 
                      dbo.pStyleQuoteItem.StyleCostingType AS Expr1, dbo.pStyleQuoteItem.StyleCostingFreightTypeID, dbo.pStyleQuoteItem.StyleQuoteVariationId, 
                      dbo.pStyleQuoteItemStatus.Custom, dbo.pStyleQuote.StyleQuoteDueDate
FROM         dbo.pStyleQuoteItem WITH (NOLOCK) INNER JOIN
                      dbo.uTradePartnerVendor WITH (NOLOCK) ON dbo.pStyleQuoteItem.TradePartnerVendorID = dbo.uTradePartnerVendor.TradePartnerVendorID INNER JOIN
                      dbo.pStyleQuoteItemStatus WITH (NOLOCK) ON dbo.pStyleQuoteItem.StyleQuoteItemStatusId = dbo.pStyleQuoteItemStatus.CustomKey INNER JOIN
                      dbo.pStyleQuote WITH (NOLOCK) ON dbo.pStyleQuoteItem.StyleQuoteID = dbo.pStyleQuote.StyleQuoteID
WHERE     (dbo.pStyleQuoteItem.StyleID = @StyleId) AND (dbo.pStyleQuoteItem.TradePartnerID = @TradePartnerID) AND
			(pStyleQuoteItem.StyleQuoteItemShare = 1)
ORDER BY dbo.uTradePartnerVendor.VendorName



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialCoreColor_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_MaterialCoreColor_SELECT](@MaterialCoreID uniqueidentifier)
AS 

SELECT     MaterialCoreColorID, MaterialCoreID, ColorPaletteID, ColorCode, ColorName, Active, Sort, CDate, CUser, MDate, MUser
FROM         pMaterialCoreColor
WHERE     (MaterialCoreID = @MaterialCoreID)
ORDER BY Sort, ColorName




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleWorkflowGrid_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_SampleWorkflowGrid_SELECT] 
(@TeamID nvarchar(50))
AS

DECLARE @UserID varchar(10), @sql varchar(8000), @delim varchar(1), @select varchar(8000), @enddate varchar(100), @duedate varchar(100), @pivot varchar(100), @table varchar(100)

SET NOCOUNT ON
SET ANSI_WARNINGS OFF

SET @UserID = (SELECT UserID FROM Users WITH (NOLOCK) WHERE (TeamID = @TeamID))

SELECT @select = 'SELECT dbo.pSampleRequestWorkflow.SessionID, dbo.pSampleRequestWorkflow.StyleColorID, dbo.pSampleRequestWorkflow.StyleID, dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.StyleNo AS [Style No], 
dbo.pStyleHeader.Description,
CASE 
WHEN pSampleRequestWorkflow.StyleSet = 1 THEN 
	CASE WHEN dbo.pStyleHeader.PC1 Is Not Null THEN dbo.pStyleHeader.PC1 ELSE ''1st Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 2 THEN 
	CASE WHEN dbo.pStyleHeader.PC2 Is Not Null THEN dbo.pStyleHeader.PC2 ELSE ''2nd Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 3 THEN 
	CASE WHEN dbo.pStyleHeader.PC3 Is Not Null THEN dbo.pStyleHeader.PC3 ELSE ''3rd Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 4 THEN 
	CASE WHEN dbo.pStyleHeader.PC4 Is Not Null THEN dbo.pStyleHeader.PC4 ELSE ''4th Set'' END 
END AS [Style Set], dbo.pStyleColorway.MainColor AS Color FROM dbo.pSampleRequestWorkflow WITH (NOLOCK) INNER JOIN 
dbo.pStyleHeader WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.StyleID = dbo.pStyleHeader.StyleID INNER JOIN 
dbo.pStyleColorway WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.StyleColorID = dbo.pStyleColorway.StyleColorID
GROUP BY dbo.pSampleRequestWorkflow.SessionID, dbo.pSampleRequestWorkflow.StyleID, dbo.pSampleRequestWorkflow.StyleColorID, 
dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.Description, 
dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.Pc1, dbo.pStyleHeader.Pc2, 
dbo.pStyleHeader.Pc3, dbo.pStyleHeader.Pc4, dbo.pSampleRequestWorkflow.TeamID, dbo.pStyleColorway.MainColor
HAVING dbo.pSampleRequestWorkflow.TeamID IN (SELECT TeamID FROM Users WITH (NOLOCK) WHERE UserID = ' + @UserID + ') ORDER BY dbo.pStyleHeader.StyleNo, dbo.pSampleRequestWorkflow.StyleSet'


SELECT @enddate = 'MAX(dbo.pSampleRequestWorkflow.EndDate)'
SELECT @duedate = 'MAX(dbo.pSampleRequestWorkflow.DueDate)'
SELECT @pivot = 'pSampleRequestWorkflow.SampleWorkflowID'
SELECt @table = 'pSampleRequestWorkflow WITH (NOLOCK)'

--DROP TABLE ##SampleWorkflow

--EXEC ('SELECT pSampleRequestWorkflow.SampleWorkflowID AS pivot INTO ##SampleWorkflow FROM pSampleRequestWorkflow WITH (NOLOCK) WHERE 1=2')

EXEC ('SELECT ' + @pivot + ' AS tb_pivot INTO ##SampleWorkflow FROM ' + @table + ' WHERE 1=2')

EXEC ('INSERT INTO ##SampleWorkflow SELECT DISTINCT ' + @pivot + ' FROM ' + @table + ' WHERE TeamID = ''{' + @TeamID + '}''' + ' AND ' + @pivot + ' Is Not Null')

SELECT @sql='',  @duedate=stuff(@duedate, len(@duedate), 1, ' END)' )
SELECT @sql=@sql + '',  @enddate=stuff(@enddate, len(@enddate), 1, ' END)' )

SELECT @delim=CASE Sign( CharIndex('char', data_type) + CharIndex('date', data_type) ) 
WHEN 0 THEN '''' ELSE '''' END 
FROM tempdb.information_schema.columns 
WHERE table_name='##SampleWorkflow' AND column_name='tb_pivot'

SELECT @sql=@sql + '''D_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@duedate,charindex( '(', @duedate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
+ '''E_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@enddate,charindex( '(', @enddate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
FROM ##SampleWorkflow

print @sql

SELECT @sql=left(@sql, len(@sql)-1)

print '###################################################'

print @sql

SELECT @select=stuff(@select, charindex(' FROM ', @select)+1, 0, ', ' + @sql + ' ')

print '###################################################'

print @select

DROP TABLE ##SampleWorkflow

EXEC (@select)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_AccessLinePlanFolder_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_Group_AccessLinePlanFolder_SELECT] (
@LinePlanTemplateId uniqueidentifier,
@GroupID uniqueidentifier
)
AS 

DECLARE @sqlScript varchar(200)
DECLARE @tableName varchar(100)

CREATE TABLE [#tmpCustomTable](
	[CustomID] [uniqueidentifier] NOT NULL,
	[Custom] [nvarchar](200) NOT NULL)


SELECT @sqlScript = 'INSERT #tmpCustomTable (CustomID, Custom) SELECT ' + a.LinePlanAttributeValue +
', ' + a.LinePlanAttributeText + ' FROM ' + a.LinePlanAttributeTable 
FROM  pLinePlanTemplateItem  a
WHERE CAST(LinePlanTemplateItemSort AS INT) = '1' 
AND a.LinePlanTemplateID = @LinePlanTemplateID

EXEC('EXEC sp_executesql N''' + @sqlScript +'''')

SELECT CAST(#tmpCustomTable.CustomID AS VARCHAR(40)) AS CustomId, 
		#tmpCustomTable.Custom, 
		sAccessGroupLinePlanFolder.AccessLinePlanId, 
		sAccessGroupLinePlanFolder.AccessRoleId, 
		sAccessGroupLinePlanFolder.AccessPlanView, 
		sAccessGroupLinePlanFolder.AccessPlanNew, 
		sAccessGroupLinePlanFolder.AccessPlanDelete, 
		sAccessGroupLinePlanFolder.AccessHierView, 
		sAccessGroupLinePlanFolder.AccessHierNew, 
		sAccessGroupLinePlanFolder.AccessHierDelete, 
		sAccessGroupLinePlanFolder.GroupID, 
		sAccessGroupLinePlanFolder.CUser, 
		sAccessGroupLinePlanFolder.CDate, 
		sAccessGroupLinePlanFolder.MUser, 
		sAccessGroupLinePlanFolder.MDate
FROM  #tmpCustomTable INNER JOIN
      sAccessGroupLinePlanFolder ON CAST(#tmpCustomTable.CustomID AS VARCHAR(40)) = CAST(sAccessGroupLinePlanFolder.CustomId AS VARCHAR(40))
WHERE sAccessGroupLinePlanFolder.GroupID = @GroupID AND sAccessGroupLinePlanFolder.LinePlanTemplateId = @LinePlanTemplateId
ORDER BY #tmpCustomTable.Custom

DROP TABLE #tmpCustomTable







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_AccessComplianceFolder_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_User_AccessComplianceFolder_SELECT]
(@teamId uniqueidentifier)
AS 

SELECT     dbo.pComplianceType.ComplianceType, dbo.pComplianceType.ComplianceDescription, dbo.sAccessComplianceFolder.AccessComplianceFolderID, 
                      dbo.sAccessComplianceFolder.AccessRoleId, dbo.sAccessComplianceFolder.AccessView, dbo.sAccessComplianceFolder.AccessCreate, 
                      dbo.sAccessComplianceFolder.AccessModify, dbo.sAccessComplianceFolder.AccessDelete, dbo.sAccessComplianceFolder.AccessPrint, 
                      dbo.sAccessComplianceFolder.TeamId, dbo.sAccessComplianceFolder.CUser, dbo.sAccessComplianceFolder.CDate, 
                      dbo.sAccessComplianceFolder.MUser, dbo.sAccessComplianceFolder.MDate, dbo.pComplianceType.ComplianceOrder
FROM         dbo.sAccessComplianceFolder WITH (NOLOCK) INNER JOIN
                      dbo.pComplianceType WITH (NOLOCK) ON dbo.sAccessComplianceFolder.ComplianceTypeId = dbo.pComplianceType.ComplianceTypeID
WHERE     (sAccessComplianceFolder.TeamId = @teamId)
ORDER BY pComplianceType.ComplianceOrder , pComplianceType.ComplianceType



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleHeaderVariation_UPDATE]'
GO

ALTER PROCEDURE [dbo].[spx_StyleHeaderVariation_UPDATE]
(@StyleID uniqueidentifier)
AS 

CREATE TABLE #tmpStyleHeader ( 
    [StyleID]             	uniqueidentifier NULL,
    [StyleMasterID]       	uniqueidentifier NULL,
    [StyleType]           	int NOT NULL DEFAULT (1),
    [WorkflowType]        	uniqueidentifier NULL,
    [RefNo]               	int IDENTITY(100,1) NOT NULL,
    [StyleNo]             	nvarchar(20) NULL,
    [TempID]              	nvarchar(20) NULL,
    [TempNo]              	nvarchar(20) NULL,
    [CustomerNo]          	nvarchar(50) NULL,
    [DevelopmentID]       	uniqueidentifier NULL,
    [DevelopmentNo]       	nvarchar(20) NULL,
    [ConceptID]           	uniqueidentifier NULL,
    [ConceptNo]           	nvarchar(50) NULL,
    [SpecNo]              	nvarchar(50) NULL,
    [Description]         	nvarchar(100) NULL,
    [StyleCategory]       	uniqueidentifier NULL,
    [SizeClass]           	nvarchar(50) NULL,
    [SizeRange]           	nvarchar(50) NULL,
    [StyleSet]            	int NULL,
    [DueDate]             	datetime NULL,
    [RecDate]             	datetime NULL,
    [Customer]            	nvarchar(200) NULL,
    [Buyer]               	nvarchar(200) NULL,
    [Designer]            	nvarchar(100) NULL,
    [SampleMaker]         	nvarchar(100) NULL,
    [PatternMaker]        	nvarchar(100) NULL,
    [ProductionManager]   	nvarchar(100) NULL,
    [TechnicalDesigner]   	nvarchar(100) NULL,
    [StyleStatus]         	nvarchar(50) NULL,
    [StyleLocation]       	nvarchar(50) NULL,
    [WashType]            	nvarchar(50) NULL,
    [Pitch]               	int NULL,
    [MaterialID]          	uniqueidentifier NULL,
    [MaterialImageID]     	uniqueidentifier NULL,
    [MaterialImageVersion]	int NULL DEFAULT (0),
    [MaterialNo]          	nvarchar(50) NULL,
    [MaterialName]        	nvarchar(200) NULL,
    [POMTempID1]          	uniqueidentifier NULL,
    [POMTempVersion1]     	int NULL,
    [POMTempSizeClass1]   	nvarchar(50) NULL,
    [POMTempID2]          	uniqueidentifier NULL,
    [POMTempVersion2]     	int NULL,
    [POMTempSizeClass2]   	nvarchar(50) NULL,
    [POMTempID3]          	uniqueidentifier NULL,
    [POMTempVersion3]     	int NULL,
    [POMTempSizeClass3]   	nvarchar(50) NULL,
    [POMTempID4]          	uniqueidentifier NULL,
    [POMTempVersion4]     	int NULL,
    [POMTempSizeClass4]   	nvarchar(50) NULL,
    [StyleMaterialID]     	uniqueidentifier NULL,
    [DesignSketchID]      	uniqueidentifier NULL,
    [TechSketchID]        	uniqueidentifier NULL,
    [ConceptSketchID]     	uniqueidentifier NULL,
    [ColorSketchID]       	uniqueidentifier NULL,
    [DesignSketchVersion] 	int NULL,
    [TechSketchVersion]   	int NULL,
    [ConceptSketchVersion]	int NULL,
    [ColorSketchVersion]  	int NULL,
    [DetailSketchID1]     	uniqueidentifier NULL,
    [DetailSketchID2]     	uniqueidentifier NULL,
    [DetailSketchID3]     	uniqueidentifier NULL,
    [DetailSketchID4]     	uniqueidentifier NULL,
    [DetailSketchVersion1]	int NULL,
    [DetailSketchVersion2]	int NULL,
    [DetailSketchVersion3]	int NULL,
    [DetailSketchVersion4]	int NULL,
    [SpecSketchID1]       	uniqueidentifier NULL,
    [SpecSketchID2]       	uniqueidentifier NULL,
    [SpecSketchID3]       	uniqueidentifier NULL,
    [SpecSketchID4]       	uniqueidentifier NULL,
    [SpecSketchVersion1]  	int NULL,
    [SpecSketchVersion2]  	int NULL,
    [SpecSketchVersion3]  	int NULL,
    [SpecSketchVersion4]  	int NULL,
    [Markup]              	numeric(18,0) NULL,
    [TargetPrice]         	money NULL,
    [SellingPrice]        	money NULL,
    [CustomField1]        	nvarchar(200) NULL,
    [CustomField2]        	nvarchar(200) NULL,
    [CustomField3]        	nvarchar(200) NULL,
    [CustomField4]        	nvarchar(200) NULL,
    [CustomField5]        	nvarchar(200) NULL,
    [CustomField6]        	nvarchar(200) NULL,
    [CustomField7]    		nvarchar(200) NULL,
	[CustomField8]        	nvarchar(200) NULL,
    [CustomField9]        	nvarchar(200) NULL,
    [CustomField10]       	nvarchar(200) NULL,
    [CustomField11]       	nvarchar(200) NULL,
    [CustomField12]       	nvarchar(200) NULL,
    [CustomField13]       	nvarchar(200) NULL,
    [CustomField14]       	nvarchar(200) NULL,
    [CustomField15]       	nvarchar(200) NULL,
    [Size0]               	nvarchar(7) NULL,
    [Size1]               	nvarchar(7) NULL,
    [Size2]               	nvarchar(7) NULL,
    [Size3]               	nvarchar(7) NULL,
    [Size4]               	nvarchar(7) NULL,
    [Size5]               	nvarchar(7) NULL,
    [Size6]               	nvarchar(7) NULL,
    [Size7]               	nvarchar(7) NULL,
    [Size8]               	nvarchar(7) NULL,
    [Size9]               	nvarchar(7) NULL,
    [Size10]              	nvarchar(7) NULL,
    [Size11]              	nvarchar(7) NULL,
    [Sel0]                	bit NULL,
    [Sel1]                	bit NULL,
    [Sel2]                	bit NULL,
    [Sel3]                	bit NULL,
    [Sel4]                	bit NULL,
    [Sel5]                	bit NULL,
    [Sel6]                	bit NULL,
    [Sel7]                	bit NULL,
    [Sel8]                	bit NULL,
    [Sel9]                	bit NULL,
    [Sel10]               	bit NULL,
    [Sel11]               	bit NULL,
    [Pc1]                 	nvarchar(50) NULL,
    [Pc2]                 	nvarchar(50) NULL,
    [Pc3]                 	nvarchar(50) NULL,
    [Pc4]                 	nvarchar(50) NULL,
    [CUser]               	nvarchar(50) NULL,
    [CDate]               	datetime NULL,
    [MUser]               	nvarchar(200) NULL,
    [MDate]               	datetime NULL,
    [Active]              	int NULL,
    [Change]              	int NULL,
    [Action]              	nvarchar(200) NULL,
    [NoColorCombo]        	int NOT NULL DEFAULT (0),
    [StyleDetail]         	ntext NULL,

    [CustomField16]       	nvarchar(200) NULL,
    [CustomField17]       	nvarchar(200) NULL,
    [CustomField18]       	nvarchar(200) NULL,
    [CustomField19]       	nvarchar(200) NULL,
    [CustomField20]       	nvarchar(200) NULL,
    [CustomField21]       	nvarchar(200) NULL,
    [CustomField22]       	nvarchar(200) NULL,
    [CustomField23]       	nvarchar(200) NULL,
    [CustomField24]       	nvarchar(200) NULL,
    [CustomField25]       	nvarchar(200) NULL,
    [CustomField26]       	nvarchar(200) NULL,
    [CustomField27]       	nvarchar(200) NULL,
    [CustomField28]       	nvarchar(200) NULL,
    [CustomField29]       	nvarchar(200) NULL,
    [CustomField30]       	nvarchar(200) NULL
)

INSERT INTO #tmpStyleHeader
    (StyleID, StyleMasterID, StyleType, WorkflowType, StyleNo, TempID, TempNo, CustomerNo, DevelopmentID, DevelopmentNo, ConceptID, 
    ConceptNo, SpecNo, Description, StyleCategory, SizeClass, SizeRange, StyleSet, DueDate, RecDate, Customer, Buyer, Designer, SampleMaker, 
    PatternMaker, ProductionManager, TechnicalDesigner, StyleStatus, StyleLocation, WashType, Pitch, MaterialID, MaterialImageID, 
    MaterialImageVersion, MaterialNo, MaterialName, POMTempID1, POMTempVersion1, POMTempSizeClass1, POMTempID2, POMTempVersion2, 
    POMTempSizeClass2, POMTempID3, POMTempVersion3, POMTempSizeClass3, POMTempID4, POMTempVersion4, POMTempSizeClass4, 
    StyleMaterialID, DesignSketchID, TechSketchID, ConceptSketchID, ColorSketchID, DesignSketchVersion, TechSketchVersion, ConceptSketchVersion, 
    ColorSketchVersion, DetailSketchID1, DetailSketchID2, DetailSketchID3, DetailSketchID4, DetailSketchVersion1, DetailSketchVersion2, 
    DetailSketchVersion3, DetailSketchVersion4, SpecSketchID1, SpecSketchID2, SpecSketchID3, SpecSketchID4, SpecSketchVersion1, 
    SpecSketchVersion2, SpecSketchVersion3, SpecSketchVersion4, Markup, TargetPrice, SellingPrice, CustomField1, CustomField2, CustomField3, 
    CustomField4, CustomField5, CustomField6, CustomField7, CustomField8, CustomField9, CustomField10, CustomField11, CustomField12, 
    CustomField13, CustomField14, CustomField15, 
	--Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Sel0, Sel1, Sel2,  Sel3, Sel4, Sel5, Sel6, Sel7, Sel8, Sel9, Sel10, Sel11, 
	Pc1, Pc2, Pc3, Pc4, CUser, CDate, MUser, MDate, Active, Change, Action, NoColorCombo, 
    StyleDetail,
	CustomField16, CustomField17, CustomField18, CustomField19, CustomField20, CustomField21, CustomField22,  CustomField23, CustomField24,  CustomField25, 
	CustomField26, CustomField27, CustomField28,  CustomField29,  CustomField30 
	)
SELECT     StyleID, StyleMasterID, StyleType, WorkflowType, StyleNo, TempID, TempNo, CustomerNo, DevelopmentID, DevelopmentNo, ConceptID, 
    ConceptNo, SpecNo, Description, StyleCategory, SizeClass, SizeRange, StyleSet, DueDate, RecDate, Customer, Buyer, Designer, SampleMaker, 
    PatternMaker, ProductionManager, TechnicalDesigner, StyleStatus, StyleLocation, WashType, Pitch, MaterialID, MaterialImageID, 
    MaterialImageVersion, MaterialNo, MaterialName, POMTempID1, POMTempVersion1, POMTempSizeClass1, POMTempID2, POMTempVersion2, 
    POMTempSizeClass2, POMTempID3, POMTempVersion3, POMTempSizeClass3, POMTempID4, POMTempVersion4, POMTempSizeClass4, 
    StyleMaterialID, DesignSketchID, TechSketchID, ConceptSketchID, ColorSketchID, DesignSketchVersion, TechSketchVersion, ConceptSketchVersion, 
    ColorSketchVersion, DetailSketchID1, DetailSketchID2, DetailSketchID3, DetailSketchID4, DetailSketchVersion1, DetailSketchVersion2, 
    DetailSketchVersion3, DetailSketchVersion4, SpecSketchID1, SpecSketchID2, SpecSketchID3, SpecSketchID4, SpecSketchVersion1, 
    SpecSketchVersion2, SpecSketchVersion3, SpecSketchVersion4, Markup, TargetPrice, SellingPrice, CustomField1, CustomField2, CustomField3, 
    CustomField4, CustomField5, CustomField6, CustomField7, CustomField8, CustomField9, CustomField10, CustomField11, CustomField12, 
    CustomField13, CustomField14, CustomField15, 
--	Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Sel0, Sel1, Sel2, Sel3, Sel4, Sel5, Sel6, Sel7, Sel8, Sel9, Sel10, Sel11, 
Pc1, Pc2, Pc3, Pc4, CUser, CDate, MUser, MDate, Active, Change, Action, NoColorCombo, 
    StyleDetail,
	CustomField16, CustomField17, CustomField18, CustomField19, CustomField20, CustomField21, CustomField22,  CustomField23, CustomField24,  CustomField25, 
	CustomField26, CustomField27, CustomField28,  CustomField29,  CustomField30 
FROM dbo.pStyleHeader WITH (NOLOCK)
WHERE (StyleID = @StyleID)

DECLARE
    @StyleMasterID       	uniqueidentifier,
    @StyleType           	int,
    @WorkflowType        	uniqueidentifier,
    @CustomerNo          	nvarchar(50),
    @DevelopmentID       	uniqueidentifier,
    @DevelopmentNo       	nvarchar(50),
    @SpecNo              	nvarchar(50),
    @Description         	nvarchar(200),
    @StyleCategory       	uniqueidentifier,
    @StyleSet            	int,
    @DueDate             	datetime,
    @RecDate             	datetime,
    @Customer            	nvarchar,
    @Buyer               	nvarchar(200),
    @Designer            	nvarchar(200),
    @SampleMaker         	nvarchar(200),
    @PatternMaker        	nvarchar(200),
    @ProductionManager   	nvarchar(200),
    @TechnicalDesigner   	nvarchar(200),
    @StyleStatus         	nvarchar(200),
    @StyleLocation       	nvarchar(200),
    @WashType            	nvarchar(200),
    @Pitch               	int,
    @MaterialID          	uniqueidentifier,
    @MaterialImageID     	uniqueidentifier,
    @MaterialImageVersion	int,
    @MaterialNo          	nvarchar(200),
    @MaterialName        	nvarchar(200),
    @StyleMaterialID     	uniqueidentifier,
    @DesignSketchID      	uniqueidentifier,
    @TechSketchID        	uniqueidentifier,
    @ConceptSketchID     	uniqueidentifier,
    @ColorSketchID       	uniqueidentifier,
    @DesignSketchVersion 	int,
    @TechSketchVersion   	int,
    @ConceptSketchVersion	int,
    @ColorSketchVersion  	int,
    @DetailSketchID1     	uniqueidentifier,
    @DetailSketchID2     	uniqueidentifier,
    @DetailSketchID3     	uniqueidentifier,
    @DetailSketchID4     	uniqueidentifier,
    @DetailSketchVersion1	int,
    @DetailSketchVersion2	int,
    @DetailSketchVersion3	int,
    @DetailSketchVersion4	int,
    @SpecSketchID1       	uniqueidentifier,
    @SpecSketchID2       	uniqueidentifier,
    @SpecSketchID3       	uniqueidentifier,
    @SpecSketchID4       	uniqueidentifier,
    @SpecSketchVersion1  	int,
    @SpecSketchVersion2  	int,
    @SpecSketchVersion3  	int,
    @SpecSketchVersion4  	int,
   @Markup              	numeric,
    @TargetPrice         	money,
    @SellingPrice        	money,
    @CustomField1        	nvarchar(200),
    @CustomField2        	nvarchar(200),
    @CustomField3        	nvarchar(200),
    @CustomField4        	nvarchar(200),
    @CustomField5        	nvarchar(200),
    @CustomField6        	nvarchar(200),
    @CustomField7    		nvarchar(200),
    @CustomField8        	nvarchar(200),
    @CustomField9        	nvarchar(200),
    @CustomField10       	nvarchar(200),
    @CustomField11       	nvarchar(200),
    @CustomField12       	nvarchar(200),
    @CustomField13       	nvarchar(200),
    @CustomField14       	nvarchar(200),
    @CustomField15       	nvarchar(200),
    @Pc1                 	nvarchar(200),
    @Pc2                 	nvarchar(200),
    @Pc3                 	nvarchar(200),
    @Pc4                 	nvarchar(200),
    @MUser               	nvarchar(200),
    @MDate               	datetime,
    @Change              	int
    --@StyleDetail         	ntext

DECLARE	@CustomField16	nvarchar(200),
		@CustomField17	nvarchar(200),
		@CustomField18	nvarchar(200),
		@CustomField19       	nvarchar(200),
		@CustomField20	nvarchar(200),
		@CustomField21	nvarchar(200),
		@CustomField22       	nvarchar(200),
		@CustomField23	nvarchar(200),
		@CustomField24	nvarchar(200),
		@CustomField25       	nvarchar(200),
		@CustomField26	nvarchar(200),
		@CustomField27	nvarchar(200),
		@CustomField28       	nvarchar(200),
		@CustomField29	nvarchar(200),
		@CustomField30	nvarchar(200)


SELECT     
    @StyleMasterID			= StyleMasterID,
    @StyleType				= StyleType,
    @WorkflowType			= WorkflowType,
    @CustomerNo				= CustomerNo,
    @DevelopmentID			= DevelopmentID,
    @DevelopmentNo			= DevelopmentNo,
    @SpecNo					= SpecNo,
    @Description         	= Description,
    @StyleCategory       	= StyleCategory,
    @StyleSet            	= StyleSet,
    @DueDate             	= DueDate,
    @RecDate             	= RecDate,
    @Customer            	= Customer,
    @Buyer               	= Buyer,
    @Designer            	= Designer,
    @SampleMaker         	= SampleMaker,
    @PatternMaker        	= PatternMaker,
    @ProductionManager   	= ProductionManager,
    @TechnicalDesigner   	= TechnicalDesigner,
    @StyleStatus         	= StyleStatus,
    @StyleLocation       	= StyleLocation,
    @WashType            	= WashType,
    @Pitch               	= Pitch,
    @MaterialID          	= MaterialID,
    @MaterialImageID     	= MaterialImageID,
    @MaterialImageVersion	= MaterialImageVersion,
    @MaterialNo          	= MaterialNo,
    @MaterialName        	= MaterialName,
    @StyleMaterialID     	= StyleMaterialID,
    @DesignSketchID      	= DesignSketchID,
    @TechSketchID        	= TechSketchID,
    @ConceptSketchID     	= ConceptSketchID,
    @ColorSketchID       	= ColorSketchID,
    @DesignSketchVersion 	= DesignSketchVersion,
    @TechSketchVersion   	= TechSketchVersion,
    @ConceptSketchVersion	= ConceptSketchVersion,
    @ColorSketchVersion  	= ColorSketchVersion,
    @DetailSketchID1     	= DetailSketchID1,
    @DetailSketchID2     	= DetailSketchID2,
    @DetailSketchID3     	= DetailSketchID3,
    @DetailSketchID4     	= DetailSketchID4,
    @DetailSketchVersion1	= DetailSketchVersion1,
    @DetailSketchVersion2	= DetailSketchVersion2,
    @DetailSketchVersion3	= DetailSketchVersion3,
    @DetailSketchVersion4	= DetailSketchVersion4,
    @SpecSketchID1       	= SpecSketchID1,
    @SpecSketchID2       	= SpecSketchID2,
    @SpecSketchID3       	= SpecSketchID3,
    @SpecSketchID4       	= SpecSketchID4,
    @SpecSketchVersion1  	= SpecSketchVersion1,
    @SpecSketchVersion2  	= SpecSketchVersion2,
    @SpecSketchVersion3  	= SpecSketchVersion3,
    @SpecSketchVersion4  	= SpecSketchVersion4,
    @Markup              	= Markup,
    @TargetPrice         	= TargetPrice,
    @SellingPrice        	= SellingPrice,
    @CustomField1        	= CustomField1,
    @CustomField2        	= CustomField2,
    @CustomField3        	= CustomField3,
    @CustomField4        	= CustomField4,
    @CustomField5        	= CustomField5,
    @CustomField6        	= CustomField6,
    @CustomField7    		= CustomField7,
	@CustomField8        	= CustomField8,
    @CustomField9        	= CustomField9,
    @CustomField10       	= CustomField10,
    @CustomField11       	= CustomField11,
    @CustomField12       	= CustomField12,
    @CustomField13       	= CustomField13,
    @CustomField14       	= CustomField14,
    @CustomField15       	= CustomField15,
    @Pc1      				= Pc1,
    @Pc2               		= Pc2,
    @Pc3                 	= Pc3,
    @Pc4                 	= Pc4,
    @MUser               	= MUser,
    @MDate               	= MDate,
    @Change              	= Change,

    @CustomField16       	= CustomField16,
    @CustomField17       	= CustomField17,
    @CustomField18       	= CustomField18,
    @CustomField19       	= CustomField19,
    @CustomField20       	= CustomField20,
    @CustomField21       	= CustomField21,
    @CustomField22       	= CustomField22,
    @CustomField23       	= CustomField23,
    @CustomField24       	= CustomField24,
    @CustomField25       	= CustomField25,
    @CustomField26       	= CustomField26,
    @CustomField27       	= CustomField27,
    @CustomField28       	= CustomField28,
    @CustomField29       	= CustomField29,
    @CustomField30       	= CustomField30
FROM  #tmpStyleHeader


CREATE TABLE #tempStyleDevelopmentItem ( 
	[RecID]						int IDENTITY(1,1)  NOT NULL,
	[StyleDevelopmentID]    	uniqueidentifier NULL,
	[StyleID]               	uniqueidentifier NULL,
	[SizeRange]             	nvarchar(50) NULL,
	[Variation]             	int NULL,
	[CUser]                 	nvarchar(200) NULL,
	[CDate]                 	datetime NULL,
	[MUser]                 	nvarchar(200) NULL,
	[MDate]                 	datetime NULL,
)

DECLARE @RowStyleLoop 			int
DECLARE @RowStyleCount 			int
DECLARE @tmpStyleID				uniqueidentifier
DECLARE @tmpStyleVariation		int

DECLARE @StyleDevelopmentId uniqueidentifier
SELECT @tmpStyleVariation = Variation, @StyleDevelopmentId = StyleDevelopmentId FROM pStyleDevelopmentItem WITH (NOLOCK) WHERE StyleId = @StyleId

BEGIN
	INSERT INTO #tempStyleDevelopmentItem (StyleDevelopmentID, StyleID, SizeRange, Variation)
	SELECT StyleDevelopmentID, StyleID, SizeRange, Variation FROM pStyleDevelopmentItem WITH (NOLOCK) 
	WHERE StyleDevelopmentID = @StyleDevelopmentId AND Variation = @tmpStyleVariation
END

SELECT * FROM #tempStyleDevelopmentItem

SET @RowStyleLoop = 1
SET @RowStyleCount = (SELECT COUNT(*) FROM #tempStyleDevelopmentItem)

WHILE @RowStyleLoop <= @RowStyleCount 

	BEGIN

		SELECT @tmpStyleID = StyleID FROM #tempStyleDevelopmentItem WHERE RecID = @RowStyleLoop

			BEGIN	
			
				UPDATE pStyleHeader
				SET StyleMasterID = @StyleMasterID, StyleType = @StyleType, WorkflowType = @WorkflowType, DevelopmentID = @DevelopmentID, 
					DevelopmentNo = @DevelopmentNo, SpecNo = @SpecNo, Description = @Description, StyleCategory = @StyleCategory, StyleSet = @StyleSet, 
					DueDate = @DueDate, RecDate = @RecDate, Customer = @Customer, Buyer = @Buyer, Designer = @Designer, SampleMaker = @SampleMaker, 
					PatternMaker = @PatternMaker, ProductionManager = @ProductionManager, TechnicalDesigner = @TechnicalDesigner, StyleStatus = @StyleStatus, 
					StyleLocation = @StyleLocation, WashType = @WashType, Pitch = @Pitch, MaterialID = @MaterialID, MaterialImageID = @MaterialImageID, 
					MaterialImageVersion = @MaterialImageVersion, MaterialNo = @MaterialNo, MaterialName = @MaterialName, StyleMaterialID = @StyleMaterialID, 
					DesignSketchID = @DesignSketchID, TechSketchID = @TechSketchID, ConceptSketchID = @ConceptSketchID, ColorSketchID = @ColorSketchID, 
					DesignSketchVersion = DesignSketchVersion, TechSketchVersion = @TechSketchVersion, ConceptSketchVersion = @ConceptSketchVersion, 
					ColorSketchVersion = @ColorSketchVersion, DetailSketchID1 = @DetailSketchID1, DetailSketchID2 = @DetailSketchID2, 
					DetailSketchID3 = @DetailSketchID3, DetailSketchID4 = @DetailSketchID4, DetailSketchVersion1 = @DetailSketchVersion1, 
					DetailSketchVersion2 = @DetailSketchVersion2, DetailSketchVersion3 = @DetailSketchVersion3, DetailSketchVersion4 = @DetailSketchVersion4, 
					SpecSketchID1 = @SpecSketchID1, SpecSketchID2 = @SpecSketchID2, SpecSketchID3 = @SpecSketchID3, SpecSketchID4 = @SpecSketchID4, 
					SpecSketchVersion1 = @SpecSketchVersion1, SpecSketchVersion2 = @SpecSketchVersion2, SpecSketchVersion3 = @SpecSketchVersion3, 
					SpecSketchVersion4 = @SpecSketchVersion4, Markup = @Markup, TargetPrice = @TargetPrice, SellingPrice = @SellingPrice, 
					CustomField1 = @CustomField1, CustomField2 = @CustomField2, CustomField3 = @CustomField3, CustomField4 = @CustomField4, 
					CustomField5 = @CustomField5, CustomField6 = @CustomField6, CustomField7 = @CustomField7, CustomField8 = @CustomField8, 
					CustomField9 = @CustomField9, CustomField10 = @CustomField10, CustomField11 = @CustomField11, CustomField12 = @CustomField12, 
					CustomField13 = @CustomField13, CustomField14 = @CustomField14, CustomField15 = @CustomField15, Change = @Change, MUser = @Muser, 
					MDate = @MDate,
					CustomField16 = @CustomField16,  CustomField17 = @CustomField17,  CustomField18 = @CustomField18,  CustomField19 = @CustomField19, 
					CustomField20 = @CustomField20, CustomField21 = @CustomField21,  CustomField22 = @CustomField22,  CustomField23 = @CustomField23, 
					CustomField24 = @CustomField24,  CustomField25 = @CustomField25,  CustomField26 = @CustomField26,  CustomField27 = @CustomField27, 
					CustomField28 = @CustomField28,  CustomField29 = @CustomField29,  CustomField30 = @CustomField30 
				WHERE StyleID = @tmpStyleID

			END	

		SET @RowStyleLoop = @RowStyleLoop + 1
		
	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteItemAgentLate_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_StyleQuoteItemAgentLate_SELECT]
(@TradePartnerId uniqueidentifier)
AS 


SELECT     dbo.pStyleQuoteItem.StyleQuoteItemID, dbo.pStyleQuoteItem.CDate, dbo.pStyleHeader.StyleID, dbo.pStyleHeader.StyleNo, 
    dbo.pStyleHeader.Description, dbo.pStyleHeader.SizeClass, dbo.uTradePartnerVendor.VendorName, dbo.pStyleQuoteItem.TradePartnerID, 
    dbo.uTradePartnerVendor.VendorCode
FROM         dbo.pStyleQuoteItem WITH (NOLOCK) INNER JOIN
    dbo.pStyleHeader WITH (NOLOCK) ON dbo.pStyleQuoteItem.StyleID = dbo.pStyleHeader.StyleID INNER JOIN
    dbo.uTradePartnerVendor WITH (NOLOCK) ON dbo.pStyleQuoteItem.TradePartnerVendorID = dbo.uTradePartnerVendor.TradePartnerVendorID
WHERE     (dbo.pStyleQuoteItem.TradePartnerID = @TradePartnerId) AND (dbo.pStyleQuoteItem.AgentView = 0)
ORDER BY dbo.uTradePartnerVendor.VendorCode, dbo.pStyleQuoteItem.CDate



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialCoreColorItem_UPDATE]'
GO
CREATE PROCEDURE [dbo].[spx_MaterialCoreColorItem_UPDATE] (
	@MaterialCoreItemID UNIQUEIDENTIFIER,
	@MaterialCoreColorID UNIQUEIDENTIFIER,
	@ColorPaletteId uniqueidentifier,
	@ModifiedBy varchar(200),
	@ModifiedDate datetime
)
AS 

DECLARE @TmpColorPaletteID UNIQUEIDENTIFIER
DECLARE @TmpMaterialID UNIQUEIDENTIFIER
DECLARE @TmpMaterialColorID UNIQUEIDENTIFIER
DECLARE @TmpMaterialCoreID UNIQUEIDENTIFIER

BEGIN
	SELECT 
		@TmpMaterialID = MaterialID
		,@TmpMaterialColorID = MaterialColorID
		,@TmpMaterialCoreID = MaterialCoreID
	FROM pMaterialCoreColorItem 
	WHERE MaterialCoreColorID = @MaterialCoreColorID 
		AND MaterialCoreItemID = @MaterialCoreItemID 
END

DECLARE @TmpStyleMaterialID UNIQUEIDENTIFIER
DECLARE @TmpStyleID UNIQUEIDENTIFIER

BEGIN
	SELECT @TmpStyleMaterialID = StyleMaterialID, @TmpStyleID = StyleID 
		FROM pStyleMaterials WHERE StyleMaterialLinkID = @MaterialCoreItemID 
END

--Update Material group colors
BEGIN
	UPDATE pMaterialCoreColorItem
	   SET MaterialColorID = @ColorPaletteId
		  ,MUser = @ModifiedBy
		  ,MDate = @ModifiedDate
	 WHERE MaterialCoreItemID = @MaterialCoreItemID
		AND MaterialCoreColorID = @MaterialCoreColorID
END

--Update Style Material Color Item
BEGIN

	UPDATE pStyleColorwayItem 
		SET MaterialColorID = @ColorPaletteId   
		  ,MUser = @ModifiedBy
		  ,MDate = @ModifiedDate
	WHERE MaterialID = @TmpMaterialID 
		AND MaterialColorID = @TmpMaterialColorID 
		AND StyleMaterialID = @TmpStyleMaterialID 	  		

END

--BEGIN

--	UPDATE pStyleSourcingItem 
--		SET MaterialColorID = @ColorPaletteId   
--		  ,MUser = @ModifiedBy
--		  ,MDate = @ModifiedDate
--	WHERE MaterialID = @TmpMaterialID 
--		AND MaterialColorID = @TmpMaterialColorID 
--		AND StyleMaterialID = @TmpStyleMaterialID 	

--END


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_Team]'
GO

ALTER PROCEDURE [dbo].[spx_User_Team](@TeamID uniqueidentifier)
AS SELECT     UserId, UserCode, TeamID, FirstName, MiddleName, LastName, Title, Birthday, Company, Street1, Street2, City, State, Zip, Country, Phone, Fax, 
                      Mobile, UserName, PassWord, Email, ContactName1, ContactTitle1, ContactEmail1, ContactName2, ContactTitle2, ContactEmail2, ContactName3, 
                      ContactTitle3, ContactEmail3, ContactName4, ContactTitle4, ContactEmail4, Admin, Active, PublicAccess, TradePartner, LastUpdate, SESSION, 
                      SESSIONDATE, FULLNAME, USERDIR, MAILADDR, MAXSIZE, MAXMSGS, FLAGS, TYPE, IP, Picture, CDate, MDate, A_StyleFolder, A_StyleHeader, 
                      A_StyleMaterial, A_StyleArtwork, A_StyleLicensee, A_StyleColorway, A_StyleDesignDetail, A_StyleDevelopmentSpec, A_StyleGradeMeasurment
FROM         dbo.Users WITH (NOLOCK)
WHERE     (TeamID = @TeamID)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_AccessControlPanel_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_User_AccessControlPanel_SELECT](@teamId uniqueidentifier)
AS SELECT     dbo.pControlPanel.ControlPanelID, dbo.pControlPanel.ControlPanelName, dbo.sAccessControlPanel.AccessControlPanelId, 
                      dbo.sAccessControlPanel.AccessRoleId, dbo.sAccessControlPanel.AccessView, dbo.sAccessControlPanel.AccessCreate, 
                      dbo.sAccessControlPanel.AccessModify, dbo.sAccessControlPanel.AccessDelete, dbo.sAccessControlPanel.AccessPrint, 
                      dbo.sAccessControlPanel.TeamId, dbo.sAccessControlPanel.CUser, dbo.sAccessControlPanel.CDate, dbo.sAccessControlPanel.MUser, 
                      dbo.sAccessControlPanel.MDate, dbo.pControlPanel.ControlPanelOrder
FROM         dbo.pControlPanel WITH (NOLOCK) INNER JOIN
                      dbo.sAccessControlPanel WITH (NOLOCK) ON dbo.pControlPanel.ControlPanelID = dbo.sAccessControlPanel.ControlPanelId
WHERE     (dbo.sAccessControlPanel.TeamId = @teamId)
ORDER BY dbo.pControlPanel.ControlPanelOrder



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LineFolder_SELECT]'
GO
CREATE PROCEDURE [dbo].[spx_LineFolder_SELECT]
(@LineFolderId uniqueidentifier)
AS 


SELECT *  FROM pLineFolder WHERE (LineFolderID = @LineFolderId)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialCoreColorItemAvail_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_MaterialCoreColorItemAvail_SELECT]
(
@MaterialID uniqueidentifier
)
AS 

BEGIN
	SELECT '00000000-0000-0000-0000-000000000000' AS MaterialColorID, '' AS ColorCode, '' AS ColorName, '' AS ColorCodeName
	UNION 
	SELECT CAST(a.MaterialColorID AS VARCHAR(40)) AS MaterialColorID, b.ColorCode, 
	'('  + ISNULL(b.ColorCode, '')  + ') ' + ISNULL(b.ColorName,'') AS  ColorName, 
	b.ColorName AS ColorCodeName 
	FROM pMaterialColor a
	INNER JOIN pColorPalette b ON a.ColorPaletteID = b.ColorPaletteID 
	WHERE a.MaterialID = @MaterialID
	--GROUP BY  a.MaterialColorID, a.ColorCode, a.ColorName, a.ColorName
	ORDER BY ColorName
END


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[vwx_StyleSample_Search_SEL]'
GO
CREATE VIEW [dbo].[vwx_StyleSample_Search_SEL]
AS
SELECT     dbo.pStyleHeader.StyleID, dbo.pStyleHeader.StyleMasterID, dbo.pStyleHeader.StyleWorkflowID, dbo.pStyleHeader.StyleType, 
                      dbo.pStyleHeader.WorkflowType, dbo.pStyleHeader.RefNo, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.TempID, dbo.pStyleHeader.TempNo, 
                      dbo.pStyleHeader.CustomerNo, dbo.pStyleHeader.DevelopmentID, dbo.pStyleHeader.DevelopmentNo, dbo.pStyleHeader.ConceptID, 
                      dbo.pStyleHeader.ConceptNo, dbo.pStyleHeader.SpecNo, dbo.pStyleHeader.Description, dbo.pStyleHeader.StyleCategory, 
                      dbo.pStyleHeader.SizeClass, dbo.pStyleHeader.SizeRange, dbo.pStyleHeader.StyleSet, dbo.pStyleHeader.TechPackId, 
                      dbo.pStyleHeader.TechPackDate, dbo.pStyleHeader.DueDate, dbo.pStyleHeader.RecDate, dbo.pStyleHeader.Customer, dbo.pStyleHeader.Buyer, 
                      dbo.pStyleHeader.Designer, dbo.pStyleHeader.SampleMaker, dbo.pStyleHeader.PatternMaker, dbo.pStyleHeader.ProductionManager, 
                      dbo.pStyleHeader.TechnicalDesigner, dbo.pStyleHeader.StyleStatus, dbo.pStyleHeader.StyleLocation, dbo.pStyleHeader.WashType, 
                      dbo.pStyleHeader.Pitch, dbo.pStyleHeader.MaterialID, dbo.pStyleHeader.MaterialImageID, dbo.pStyleHeader.MaterialImageVersion, 
                      dbo.pStyleHeader.MaterialNo, dbo.pStyleHeader.MaterialName, dbo.pStyleHeader.POMTempGroupID1, dbo.pStyleHeader.POMTempGroupID2, 
                      dbo.pStyleHeader.POMTempGroupID3, dbo.pStyleHeader.POMTempGroupID4, dbo.pStyleHeader.POMTempID1, dbo.pStyleHeader.POMTempVersion1, 
                      dbo.pStyleHeader.POMTempSizeClass1, dbo.pStyleHeader.POMTempID2, dbo.pStyleHeader.POMTempVersion2, 
                      dbo.pStyleHeader.POMTempSizeClass2, dbo.pStyleHeader.POMTempID3, dbo.pStyleHeader.POMTempVersion3, 
                      dbo.pStyleHeader.POMTempSizeClass3, dbo.pStyleHeader.POMTempID4, dbo.pStyleHeader.POMTempVersion4, 
                      dbo.pStyleHeader.POMTempSizeClass4, dbo.pStyleHeader.StyleMaterialID, dbo.pStyleHeader.DesignSketchID, dbo.pStyleHeader.TechSketchID, 
                      dbo.pStyleHeader.ConceptSketchID, dbo.pStyleHeader.ColorSketchID, dbo.pStyleHeader.DesignSketchVersion, dbo.pStyleHeader.TechSketchVersion, 
                      dbo.pStyleHeader.ConceptSketchVersion, dbo.pStyleHeader.ColorSketchVersion, dbo.pStyleHeader.DetailSketchID1, 
                      dbo.pStyleHeader.DetailSketchID2, dbo.pStyleHeader.DetailSketchID3, dbo.pStyleHeader.DetailSketchID4, dbo.pStyleHeader.DetailSketchVersion1, 
                      dbo.pStyleHeader.DetailSketchVersion2, dbo.pStyleHeader.DetailSketchVersion3, dbo.pStyleHeader.DetailSketchVersion4, 
                      dbo.pStyleHeader.SpecSketchID1, dbo.pStyleHeader.SpecSketchID2, dbo.pStyleHeader.SpecSketchID3, dbo.pStyleHeader.SpecSketchID4, 
                      dbo.pStyleHeader.SpecSketchVersion1, dbo.pStyleHeader.SpecSketchVersion2, dbo.pStyleHeader.SpecSketchVersion3, 
                      dbo.pStyleHeader.SpecSketchVersion4, dbo.pStyleHeader.Markup, dbo.pStyleHeader.TargetPrice, dbo.pStyleHeader.SellingPrice, 
                      dbo.pStyleHeader.CustomField1, dbo.pStyleHeader.CustomField2, dbo.pStyleHeader.CustomField3, dbo.pStyleHeader.CustomField4, 
                      dbo.pStyleHeader.CustomField5, dbo.pStyleHeader.CustomField6, dbo.pStyleHeader.CustomField7, dbo.pStyleHeader.CustomField8, 
                      dbo.pStyleHeader.CustomField9, dbo.pStyleHeader.CustomField10, dbo.pStyleHeader.CustomField11, dbo.pStyleHeader.CustomField12, 
                      dbo.pStyleHeader.CustomField13, dbo.pStyleHeader.CustomField14, dbo.pStyleHeader.CustomField15, dbo.pStyleHeader.Pc1, dbo.pStyleHeader.Pc2, 
                      dbo.pStyleHeader.Pc3, dbo.pStyleHeader.Pc4, dbo.pStyleHeader.CUser, dbo.pStyleHeader.CDate, dbo.pStyleHeader.MUser, dbo.pStyleHeader.MDate, 
                      dbo.pStyleHeader.Active, dbo.pStyleHeader.Change, dbo.pStyleHeader.Action, dbo.pStyleHeader.NoColorCombo, dbo.pStyleHeader.StyleVersion, 
                      dbo.pStyleHeader.StyleDetail, dbo.pStyleHeader.StyleDetail1, dbo.pStyleHeader.StyleDetail2, dbo.pStyleHeader.StyleAttribute, 
                      dbo.pStyleHeader.LinePlanID, dbo.pStyleHeader.LinePlanNo, dbo.pStyleHeader.LinePlanSketchID, dbo.pStyleHeader.LinePlanSketchVersion, 
                      dbo.pStyleHeader.CustomField16, dbo.pStyleHeader.CustomField17, dbo.pStyleHeader.CustomField18, dbo.pStyleHeader.CustomField19, 
                      dbo.pStyleHeader.CustomField20, dbo.pStyleHeader.CustomField21, dbo.pStyleHeader.CustomField22, dbo.pStyleHeader.CustomField23, 
                      dbo.pStyleHeader.CustomField24, dbo.pStyleHeader.CustomField25, dbo.pStyleHeader.CustomField26, dbo.pStyleHeader.CustomField27, 
                      dbo.pStyleHeader.CustomField28, dbo.pStyleHeader.CustomField29, dbo.pStyleHeader.CustomField30, dbo.pStyleHeader.PackagingNo, 
                      dbo.pStyleHeader.StyleCopyID, dbo.pStyleHeader.LinePlanItemID, dbo.pStyleHeader.StyleStatusID, dbo.pStyleHeader.BodyID, 
                      dbo.pStyleHeader.TradePartnerID, dbo.pStyleHeader.TradePartnerVendorID, dbo.pSeasonYear.Year, dbo.pSeasonYear.Season, 
                      dbo.pStyleHeader.HeaderLocked, dbo.pStyleSeasonYear.StyleSeasonYearID, dbo.pStyleSeasonYear.SeasonYearID
FROM  dbo.pStyleHeader 
LEFT OUTER JOIN dbo.pStyleSeasonYear ON dbo.pStyleHeader.StyleID = dbo.pStyleSeasonYear.StyleID
LEFT OUTER JOIN dbo.pSeasonYear ON dbo.pSeasonYear.SeasonYearID = dbo.pStyleSeasonYear.SeasonYearID


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_SampleRequest_Style_SELECT]'
GO

ALTER VIEW [dbo].[vwx_SampleRequest_Style_SELECT]
AS
SELECT     CASE WHEN StyleDevelopmentName IS NULL THEN 'Variation ' + CAST(Variation AS NVARCHAR(5)) ELSE StyleDevelopmentName END AS Variation, 
                      a.StyleID, a.StyleMasterID, a.StyleWorkflowID, a.StyleType, a.WorkflowType, a.RefNo, a.StyleNo, a.TempID, a.TempNo, a.CustomerNo, 
                      a.DevelopmentID, a.DevelopmentNo, a.ConceptID, a.ConceptNo, a.SpecNo, a.Description, a.StyleCategory, a.SizeClass, a.SizeRange, a.StyleSet, 
                      a.TechPackId, a.TechPackDate, a.DueDate, a.RecDate, a.Customer, a.Buyer, a.Designer, a.SampleMaker, a.PatternMaker, a.ProductionManager, 
                      a.TechnicalDesigner, a.StyleStatus, a.StyleLocation, a.WashType, a.Pitch, a.MaterialID, a.MaterialImageID, a.MaterialImageVersion, a.MaterialNo, 
                      a.MaterialName, a.POMTempGroupID1, a.POMTempGroupID2, a.POMTempGroupID3, a.POMTempGroupID4, a.POMTempID1, a.POMTempVersion1, 
                      a.POMTempSizeClass1, a.POMTempID2, a.POMTempVersion2, a.POMTempSizeClass2, a.POMTempID3, a.POMTempVersion3, 
                      a.POMTempSizeClass3, a.POMTempID4, a.POMTempVersion4, a.POMTempSizeClass4, a.StyleMaterialID, a.DesignSketchID, a.TechSketchID, 
                      a.ConceptSketchID, a.ColorSketchID, a.DesignSketchVersion, a.TechSketchVersion, a.ConceptSketchVersion, a.ColorSketchVersion, a.DetailSketchID1, 
                      a.DetailSketchID2, a.DetailSketchID3, a.DetailSketchID4, a.DetailSketchVersion1, a.DetailSketchVersion2, a.DetailSketchVersion3, 
                      a.DetailSketchVersion4, a.SpecSketchID1, a.SpecSketchID2, a.SpecSketchID3, a.SpecSketchID4, a.SpecSketchVersion1, a.SpecSketchVersion2, 
                      a.SpecSketchVersion3, a.SpecSketchVersion4, a.Markup, a.TargetPrice, a.SellingPrice, a.CustomField1, a.CustomField2, a.CustomField3, 
                      a.CustomField4, a.CustomField5, a.CustomField6, a.CustomField7, a.CustomField8, a.CustomField9, a.CustomField10, a.CustomField11, 
                      a.CustomField12, a.CustomField13, a.CustomField14, a.CustomField15, a.CustomField16, a.CustomField17, a.CustomField18, a.CustomField19, 
                      a.CustomField20, a.CustomField21, a.CustomField22, a.CustomField23, a.CustomField24, a.CustomField25, a.CustomField26, a.CustomField27, 
                      a.CustomField28, a.CustomField29, a.CustomField30, a.Pc1, a.Pc2, a.Pc3, a.Pc4, a.CUser, a.CDate, a.MUser, a.MDate, a.Active, a.Change, a.Action, 
                      a.NoColorCombo, a.StyleVersion, a.StyleDetail, a.StyleDetail1, a.StyleAttribute, a.StyleDetail2, a.LinePlanSketchID, a.LinePlanSketchVersion, 
                      a.LinePlanID, a.LinePlanNo, a.PackagingNo, a.StyleCopyID, a.LinePlanItemID, a.StyleStatusID, 
   					  d.Season, d.Year, c.StyleSeasonYearID
FROM dbo.pStyleHeader a 
INNER JOIN pStyleSeasonYear c ON c.StyleID  = a.StyleID 
INNER JOIN pSeasonYear d ON c.SeasonYearID  = d.SeasonYearID
INNER JOIN dbo.pStyleDevelopmentItem b ON a.DevelopmentID = b.StyleDevelopmentID 

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LineFolderItemStyle_SELECT]'
GO


CREATE PROCEDURE [dbo].[spx_LineFolderItemStyle_SELECT]
(
@LineFolderID uniqueidentifier,
@SeasonYearID uniqueidentifier = NULL,
@LineFolderItemDrop varchar(10) = NULL,
@LineFolderItemSort varchar(10) = NULL,
@SqlViewName varchar(8000) = NULL,
@SqlWhere varchar(8000) = NULL
)
AS 

/*Create temp tables.*/
--Holds Style record.
CREATE TABLE #temp
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,LineFolderID UNIQUEIDENTIFIER
	,LineFolderItemID UNIQUEIDENTIFIER
	,LineItemFolder1 nvarchar(100)
	,LineItemFolder2 nvarchar(100)
	,LineItemFolder3 nvarchar(100)
	,LineItemFolder4 nvarchar(100)
	,LineItemFolder5 nvarchar(100)
	,LineItemFolder6 nvarchar(100)
	,LineItemFolder7 nvarchar(100)
	,LineItemFolder8 nvarchar(100)
	,LineItemFolder9 nvarchar(100)
	,LineFolderItemDrop nvarchar(5)
	,LineFolderItemDropUser nvarchar(200)
	,LineFolderItemDropDate datetime
	,LineFolderImageID uniqueidentifier
	,LineFolderImageVersion int
	,LineFolderItemSort varchar(5)
	,CUser nvarchar(200)
	,CDate datetime
	,MUser nvarchar(200)
	,MDate datetime
	,MChange int
	,SeasonYearID UNIQUEIDENTIFIER
	,StyleID UNIQUEIDENTIFIER				--pStyleHeader.StyleID
	,DesignSketchID UNIQUEIDENTIFIER		--pStyleHeader.DesignSketchID
	,DesignSketchVersion int				--pStyleHeader.DesignSketchVersion
	,ConceptNo NVARCHAR(200)				--pStyleHeader.DevelopmentNo + pStyleDevelopmentItem.Variation
	,StyleNo NVARCHAR(20)					--pStyleHeader.StyleNo
	,PatternRef NVARCHAR(200)				--pStyleHeader.CustomField5
	,[Description] NVARCHAR(200)			--pStyleHeader.[Description]
	,DMCStyleType NVARCHAR(200)				--pStyleHeader.CustomField8
	,FabricYarnType NVARCHAR(200)			--pStyleMaterials.F
	,MainMaterial NVARCHAR(200)				--pStyleMaterials.MaterialName
	,[Content] NVARCHAR(200)				--pStyleMaterials.H
	,FabricWeight NVARCHAR(200)				--pStyleMaterials.I
	,SizeRange NVARCHAR(50)					--pStyleHeader.SizeRange
	,TPAgent1 NVARCHAR(200)					--uTradePartner.TradePartnerName
	,TPAgent2 NVARCHAR(200)					--uTradePartner.TradePartnerName
	,TPAgent3 NVARCHAR(200)					--uTradePartner.TradePartnerName
	,TPAgent4 NVARCHAR(200)					--uTradePartner.TradePartnerName
	,TPAgent5 NVARCHAR(200)					--uTradePartner.TradePartnerName
	,TPAgent6 NVARCHAR(200)					--uTradePartner.TradePartnerName
	,ColorName NVARCHAR(4000)				--pLineFolderItemColor.StyleColorName (Items strung together)
	)  ON [PRIMARY]

ALTER TABLE dbo.#temp ADD CONSTRAINT
	PK_#temp PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


--Holds Tech Pack Agent records.
CREATE TABLE dbo.#tempTPAgents
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,TradePartnerID UNIQUEIDENTIFIER
	,TPAgent NVARCHAR(200)
	)  ON [PRIMARY]

ALTER TABLE dbo.#tempTPAgents ADD CONSTRAINT
	PK_#tempTPAgents PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


--Holds Colorway records.
CREATE TABLE dbo.#tempColorways
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,ColorNameIndividual NVARCHAR(200)
	)  ON [PRIMARY]

ALTER TABLE dbo.#tempColorways ADD CONSTRAINT
	PK_#tempColorways PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/*Declare variables.*/
DECLARE @TotalCount2 INT
DECLARE @RowCounter2 INT

DECLARE @LineFolderItemID UNIQUEIDENTIFIER
DECLARE @StyleID UNIQUEIDENTIFIER

DECLARE @TotalCount INT
DECLARE @RowCounter INT

DECLARE @TPAgent NVARCHAR(200)

DECLARE @SQLString VARCHAR(4000)

DECLARE @ColorNameIndividual NVARCHAR(200)
DECLARE @ColorName NVARCHAR(4000)


/*
Get the initial data for the Style records 
FROM VIEW IN THE PARAMS
*/

EXEC('INSERT INTO #temp(
	LineFolderID
	,LineFolderItemID
	,LineItemFolder1 
	,LineItemFolder2 
	,LineItemFolder3 
	,LineItemFolder4 
	,LineItemFolder5 
	,LineItemFolder6 
	,LineItemFolder7 
	,LineItemFolder8 
	,LineItemFolder9 
	,LineFolderItemDrop 
	,LineFolderItemDropUser 
	,LineFolderItemDropDate 
	,LineFolderImageID 
	,LineFolderImageVersion 
	,LineFolderItemSort
	,DesignSketchID
	,DesignSketchVersion
	,CUser 
	,CDate 
	,MUser 
	,MDate 
	,MChange 
	,StyleID
	,ConceptNo
	,StyleNo
	,PatternRef
	,[Description]
	,DMCStyleType
	,FabricYarnType
	,MainMaterial
	,[Content]
	,FabricWeight
	,SizeRange
)
SELECT
	LineFolderID
	,LineFolderItemID
	,LineItemFolder1 
	,LineItemFolder2 
	,LineItemFolder3 
	,LineItemFolder4 
	,LineItemFolder5 
	,LineItemFolder6 
	,LineItemFolder7 
	,LineItemFolder8 
	,LineItemFolder9 
	,LineFolderItemDrop 
	,LineFolderItemDropUser 
	,LineFolderItemDropDate 
	,LineFolderImageID 
	,LineFolderImageVersion 
	,LineFolderItemSort
	,DesignSketchID
	,DesignSketchVersion
	,CUser 
	,CDate 
	,MUser 
	,MDate 
	,MChange 
	,StyleID
	,ConceptNo
	,StyleNo
	,PatternRef
	,[Description]
	,DMCStyleType
	,FabricYarnType
	,MainMaterial
	,[Content]
	,FabricWeight
	,SizeRange
FROM ' + @SqlViewName + ' 
' + @SqlWhere + ' 
ORDER BY LineFolderItemSort, StyleNo')


/*Get and set counts for records in the Line Folder.*/
SELECT @TotalCount2 = COUNT(*) FROM #temp
SET @RowCounter2 = 1


/*Loop through the Line Folder records.*/
WHILE(@RowCounter2 <= @TotalCount2)
	BEGIN
		/*Clear variables.*/
		SET @LineFolderItemID = NULL
		SET @StyleID =NULL

		/*Get the LineFolderItemID and StyleID.*/
		SELECT @LineFolderItemID = LineFolderItemID
			,@StyleID = StyleID
		FROM #temp
		WHERE TableRow = @RowCounter2


		/*Get information for TP Agents for the Style.*/
		INSERT INTO #tempTPAgents(
			StyleID
			,TradePartnerID
			,TPAgent
		)
		SELECT DISTINCT TOP 6
			pTechPackTeam.StyleID
			,pTechPackTeam.TeamID AS TradePartnerID
			,uTradePartner.TradePartnerName AS TPAgent
		FROM pTechPackTeam
			INNER JOIN uTradePartner ON	pTechPackTeam.TeamID = uTradePartner.TradePartnerID
		WHERE pTechPackTeam.StyleID = @StyleID
		ORDER BY uTradePartner.TradePartnerName ASC


		/*Get & set counters of TPAgents.*/
		SELECT @TotalCount = COUNT(*) FROM #tempTPAgents
		SET @RowCounter = 1


		/*Loop to update Style record with Tech Pack Agents.*/
		WHILE(@RowCounter <= @TotalCount)
			BEGIN
				/*Clear variables.*/
				SET @TPAgent = ''

				/*Get Tech Pack Agent name.*/
				SELECT @TPAgent = TPAgent
				FROM #tempTPAgents
				WHERE TableRow = @RowCounter

				/*Build dynamic SQL String.*/
				SET @SQLString = ' UPDATE #temp '
				SET @SQLString = @SQLString + ' SET TPAgent' + CAST(@RowCounter AS VARCHAR(5)) + ' = ''' + @TPAgent + ''''
				SET @SQLString = @SQLString + ' WHERE TableRow = ' + CAST(@RowCounter2 AS VARCHAR(5))

				/************/
				/*Testing.	*/
				/************/
--				SELECT @SQLString

				/*Run dynamic SQL String to update Style record.*/
				EXEC(@SQLString)

				/*Up counter.*/
				SET @RowCounter = @RowCounter + 1
			END


		/*Get Colorway records.*/
		INSERT INTO #tempColorways(
			ColorNameIndividual
		)
		SELECT
			StyleColorName AS ColorNameIndividual
		FROM pLineFolderItemColor
		WHERE LineFolderItemID = @LineFolderItemID
			AND LineFolderItemColorDrop <> 1
		ORDER BY StyleColorName


		/*Get & set counters.*/
		SELECT @TotalCount = COUNT(*) FROM #tempColorways
		SET @RowCounter = 1


		/*Clear variables.*/
		SET @ColorName = ''


		/*Loop to string the ColorNames together.*/
		WHILE(@RowCounter <= @TotalCount)
			BEGIN
				/*Clear variables.*/
				SET @ColorNameIndividual = ''

				/*Get ColorName.*/
				SELECT @ColorNameIndividual = ColorNameIndividual
				FROM #tempColorways
				WHERE TableRow = @RowCounter

				/*Add individual color to the color string.*/
				IF(@RowCounter = 1)
					BEGIN
						SET @ColorName = @ColorNameIndividual
					END
				ELSE
					BEGIN
						SET @ColorName = @ColorName + ', ' + @ColorNameIndividual
					END

				/*Up counter.*/
				SET @RowCounter = @RowCounter + 1
			END


		/*Update temp table with strung together colorway names.*/
		UPDATE #temp
		SET ColorName = @ColorName
		WHERE TableRow = @RowCounter2


		/*Truncate temp tables to be re-used for next pass of a Line Folder record.*/
		TRUNCATE TABLE #tempTPAgents
		TRUNCATE TABLE #tempColorways


		/*Up counter.*/
		SET @RowCounter2 = @RowCounter2 + 1
	END


/*Final SELECT.*/
SELECT * FROM #temp ORDER BY LineFolderItemSort, StyleNo

/*Final COUNT(*)
It's required for paging on ASPX page
*/
SELECT COUNT(*) FROM #temp

/*Drop temp table.*/
DROP TABLE #temp
DROP TABLE #tempTPAgents
DROP TABLE #tempColorways
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleHistory_SELECT]'
GO
SET QUOTED_IDENTIFIER OFF
GO
--
-- Daniel Pak 04-23-2010
--    Fix Style History not displaying in srmOn
--

ALTER  PROCEDURE [dbo].[spx_StyleHistory_SELECT]
(@TeamId uniqueidentifier)
AS 

SELECT StyleId, StyleNo, [Description]
  FROM pStyleHeader WITH (NOLOCK) WHERE StyleId IN (SELECT StyleId FROM pStyleHistory WITH (NOLOCK) WHERE TeamID = @TeamID) 
ORDER BY [CDate] DESC
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteItemAvailableAgent_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO







ALTER      PROCEDURE [dbo].[spx_StyleQuoteItemAvailableAgent_SELECT](@StyleId uniqueidentifier, @TradePartnerId uniqueidentifier)
AS 


SELECT  pStyleQuoteItem.StyleQuoteItemID, '(' + CAST(pStyleQuoteItem.StyleQuoteItemNo AS VARCHAR(10)) + ') ' + pStyleQuoteItemStatus.Custom + ': ' + uTradePartnerVendor.VendorName AS StyleQuote, pStyleQuoteItem.StyleID
FROM pStyleQuoteItem WITH (NOLOCK) INNER JOIN
	uTradePartnerVendor WITH (NOLOCK) ON pStyleQuoteItem.TradePartnerVendorID = uTradePartnerVendor.TradePartnerVendorID INNER JOIN
	pStyleQuoteItemStatus WITH (NOLOCK) ON pStyleQuoteItem.StyleQuoteItemStatusId = pStyleQuoteItemStatus.CustomKey
--WHERE   AND 
WHERE	(pStyleQuoteItem.TradePartnerID = @TradePartnerId) AND (pStyleQuoteItem.StyleID = @StyleId) AND (pStyleQuoteItem.StyleQuoteItemShare = 0)
ORDER BY StyleQuoteItemNo







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialCoreColorName_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_MaterialCoreColorName_SELECT](@MaterialCoreColorID uniqueidentifier)
AS 

	SELECT '('  + ISNULL(a.ColorCode, '')  + ') ' + ISNULL(a.ColorName,'') AS ColorName 
	--, ISNULL(a.ColorCode, '') as ColorCode
	FROM pColorPalette a
	INNER JOIN pMaterialCoreColor b
	ON a.ColorPaletteID  = b.ColorPaletteID 
	WHERE MaterialCoreColorID = @MaterialCoreColorID











GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[vwx_StyleSeasonTemp]'
GO
CREATE VIEW [dbo].[vwx_StyleSeasonTemp] 
AS 

select a.StyleID, StyleSeasonYearID =  ( select top 1 b.StyleSeasonYearID from pStyleSeasonYear b WHERE b.StyleID =  a.StyleID)
from pStyleSeasonYear a
GROUP BY a.StyleID
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_DesktopAccessFolderCheck_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_Group_DesktopAccessFolderCheck_INSERT]
(
@GroupID uniqueidentifier ,
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

DECLARE @I as int
DECLARE @Row_Count int
DECLARE @DeskFolderId int 
DECLARE @DeskAccessId int

SET @DeskAccessId = 0
SET @I = 1

	BEGIN
	CREATE TABLE #TempGroupAccess (
		Id int IDENTITY (1, 1) NOT NULL , 
		DeskFolderId int NOT NULL 
	) 
	END


	BEGIN
	
	INSERT INTO #TempGroupAccess
		(DeskFolderId)
	SELECT DeskFolderId FROM cDesktopFolder WITH (NOLOCK) 
	
	
	--EXEC('SELECT IDENTITY(int, 1,1) AS ID, DeskFolderId INTO #TempUserAccess FROM cDesktopFolder')

	
	
	SET @Row_Count = (SELECT COUNT(*) FROM #TempGroupAccess)

	WHILE @I <= @Row_Count 
		BEGIN

			SELECT @DeskFolderId = DeskFolderId FROM #TempGroupAccess WHERE ID = @I

			IF (SELECT COUNT(*) FROM cDeskGroupFolderAccess WITH (NOLOCK) WHERE DeskFolderId = @DeskFolderId AND GroupID = @GroupID) = 0
			BEGIN
				INSERT INTO cDeskGroupFolderAccess
					(DeskFolderId, DeskAccessId, GroupID, CUser, CDate, MUser, MDate)
				SELECT DeskFolderId, @DeskAccessId, @GroupID,  @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate 
				FROM  cDesktopFolder WITH (NOLOCK) WHERE DeskFolderId = @DeskFolderId
			END
				
			SET @I = @I + 1
		END

		--SELECT * FROM #tempGroupAccess

	END


set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_LineFolder_Image_3x0_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.
*/


ALTER  PROCEDURE [dbo].[rpx_LineFolder_Image_3x0_SELECT]	 
	@LineFolderID AS varchar(255)
AS


SELECT
	identity(int,0,1) AS RowNumber,
	fi.LineFolderItemID AS LineFolderItemID, 
	sh.StyleNo,
	sh.StyleType,
	sh.DevelopmentNo,
	sh.SizeClass,
	sc.StyleCategory,
	sh.[Description], 
	sh.MaterialName, 
	(dbo.fnx_GetStreamingImagePath(hi.ImageID, hi.[Version])) AS FilePath,	--Comment #01
	ch.StyleCostingCustomField23 AS TargetFOB,
	ch.StyleCostingCustomField22 AS TargetLDP, 
	ch.StyleCostingCustomField21 AS TargetWHSL,
	ch.StyleCostingCustomField20 AS TargetMSRP, 
	ch.StyleCostingCustomField24 AS PricingComment,
	st.StyleTypeDescription AS StyleTypeDescription
INTO	#TblTemp 
FROM         pLineFolderItem fi LEFT OUTER JOIN
                      hImage hi ON fi.LineFolderImageID = hi.ImageID AND fi.LineFolderImageVersion = hi.Version LEFT OUTER JOIN
                      pStyleHeader sh ON fi.StyleID = sh.StyleID LEFT OUTER JOIN
                      pStyleCostingHeader ch ON sh.StyleID = ch.StyleID LEFT OUTER JOIN
                      pStyleCategory sc ON sh.StyleCategory = sc.StyleCategoryId LEFT OUTER JOIN
                      pStyleType st ON sh.StyleType = st.StyleTypeID
WHERE fi.LineFolderID = @LineFolderID 

SELECT
	RowNumber % 3 AS Row,
	LineFolderItemID,
	StyleType,
	DevelopmentNo,
	SizeClass,
	StyleCategory,
	[Description], 
	MaterialName,
	FilePath,
	TargetFOB,
	TargetLDP,
	TargetWHSL,
	TargetMSRP,
	PricingComment,
	 StyleTypeDescription
FROM #TblTemp

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_AccessImageFolder_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_User_AccessImageFolder_SELECT]
(@teamId uniqueidentifier)
AS 


SELECT pImageType.ImageTypeID, pImageType.ImageType, sAccessImageFolder.AccessImageId, 
    sAccessImageFolder.AccessRoleId, sAccessImageFolder.AccessView, sAccessImageFolder.AccessCreate, 
    sAccessImageFolder.AccessModify, sAccessImageFolder.AccessDelete, sAccessImageFolder.AccessPrint, 
    sAccessImageFolder.TeamId, sAccessImageFolder.CUser, sAccessImageFolder.CDate, sAccessImageFolder.MUser, 
    sAccessImageFolder.MDate, pImageType.ImageOrder
FROM  pImageType WITH (NOLOCK) INNER JOIN
    sAccessImageFolder WITH (NOLOCK) ON pImageType.ImageTypeID = sAccessImageFolder.ImageTypeID
WHERE(sAccessImageFolder.TeamId = @teamId)
ORDER BY pImageType.ImageOrder



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialCoreColors_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_MaterialCoreColors_SELECT] (
@MaterialCoreID UNIQUEIDENTIFIER 
)
AS 

SELECT a.MaterialCoreColorID , b.ColorCode, b.ColorName, b.ColorPaletteID ,  
'<img src=''../System/Control/ColorStream.ashx?S=25&CFID=' + CAST(ISNULL(b.ColorFolderID, '00000000-0000-0000-0000-000000000000') AS NVARCHAR(50)) +
'&CPID=' + CAST(ISNULL(b.ColorPaletteID, '00000000-0000-0000-0000-000000000000') AS NVARCHAR(50)) + '''  />' AS ColorImagePath
FROM pMaterialCoreColor a
INNER JOIN pColorPalette b ON a.ColorPaletteID = b.ColorPaletteID 
WHERE a.MaterialCoreID = @MaterialCoreID


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_DesktopAccessLinePlanFolderCheck_INSERT]'
GO
ALTER PROCEDURE [dbo].[spx_Group_DesktopAccessLinePlanFolderCheck_INSERT] (
@LinePlanTemplateID uniqueidentifier,
@GroupID uniqueidentifier, 
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS


DECLARE @iCount as int
DECLARE @iCountRow int
DECLARE @CustomID UNIQUEIDENTIFIER
DECLARE @DeskAccessId int

DECLARE @sqlScript varchar(200)

CREATE TABLE #TempGroupAccess (
	Id int IDENTITY (1, 1) NOT NULL , 
	CustomID UNIQUEIDENTIFIER,
	GroupID uniqueidentifier 
) 


SELECT @sqlScript = 'INSERT #TempGroupAccess (CustomID) SELECT ' + a.LinePlanAttributeValue +  ' FROM ' + a.LinePlanAttributeTable 
FROM  pLinePlanTemplateItem  a

WHERE CAST(a.LinePlanTemplateItemSort AS INT) = '1' 
AND a.LinePlanTemplateID = @LinePlanTemplateID


EXEC('EXEC sp_executesql N''' + @sqlScript +'''')






SET @iCountRow = (SELECT COUNT(*) FROM #TempGroupAccess)

SET @iCount = 1

WHILE @iCount <= @iCountRow 
BEGIN

	SELECT @CustomID = CustomID FROM #TempGroupAccess WHERE ID = @iCount
	IF (SELECT COUNT(*) FROM sAccessGroupLinePlanFolder WHERE CustomID = @CustomID AND LinePlanTemplateID = @LinePlanTemplateID AND GroupID = @GroupID) = 0
	BEGIN
		INSERT INTO sAccessGroupLinePlanFolder
			(LinePlanTemplateID, GroupID, CUser, CDate, MUser, MDate, CustomID)
		SELECT @LinePlanTemplateID, @GroupID, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate, CustomID 
		FROM  #TempGroupAccess WHERE Id = @iCount
	END

	SET @iCount = @iCount + 1
END

SELECT * FROM #tempGroupAccess

DROP TABLE #tempGroupAccess





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_MaterialTradePartnerSearch_SELECT]'
GO
EXEC sp_refreshview N'[dbo].[vwx_MaterialTradePartnerSearch_SELECT]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteItemCost_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_StyleQuoteItemCost_SELECT]
(@StyleQuoteId uniqueidentifier,
@StyleId uniqueidentifier)
AS 

SELECT   dbo.pStyleQuoteItem.StyleQuoteItemID, dbo.pStyleQuoteItem.StyleQuoteItemNo, dbo.pStyleQuoteItem.StyleQuoteItemStatusId, 
dbo.pStyleQuoteItem.StyleQuoteID, dbo.pStyleQuoteItem.StyleDevelopmentID, dbo.pStyleQuoteItem.StyleID, 
dbo.pStyleQuoteItem.StyleQuoteTradePartnerID, dbo.pStyleQuoteItem.StyleCostingID, dbo.pStyleQuoteItem.TradePartnerID, 
dbo.pStyleQuoteItem.TradePartnerVendorID, dbo.uTradePartnerVendor.VendorCode, dbo.uTradePartnerVendor.VendorName, 
dbo.pStyleQuoteItemStatus.Custom AS QuoteStatus, dbo.pStyleCostingType.StyleCostingType, 
dbo.pStyleQuoteItemStatus.CustomIcon AS QuoteStatusIcon
FROM    dbo.pStyleQuoteItem WITH (NOLOCK) INNER JOIN
dbo.uTradePartnerVendor WITH (NOLOCK) ON dbo.pStyleQuoteItem.TradePartnerVendorID = dbo.uTradePartnerVendor.TradePartnerVendorID INNER JOIN
dbo.pStyleQuoteItemStatus WITH (NOLOCK) ON dbo.pStyleQuoteItem.StyleQuoteItemStatusId = dbo.pStyleQuoteItemStatus.CustomKey INNER JOIN
dbo.pStyleCostingType WITH (NOLOCK) ON dbo.pStyleQuoteItem.StyleCostingType = dbo.pStyleCostingType.StyleCostingTypeID
WHERE     (dbo.pStyleQuoteItem.StyleQuoteID = @StyleQuoteId) AND (dbo.pStyleQuoteItem.StyleID = @StyleId)
ORDER BY dbo.uTradePartnerVendor.VendorCode, dbo.uTradePartnerVendor.VendorName



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialCoreColorway_INSERT]'
GO


CREATE PROCEDURE [dbo].[spx_MaterialCoreColorway_INSERT] (
	@MaterialCoreID UNIQUEIDENTIFIER,
	@ColorPaletteId uniqueidentifier,
	@CreatedBy varchar(200),
	@CreatedDate datetime
)
AS 


IF (SELECT COUNT(*) FROM pMaterialCoreColor 
	WHERE MaterialCoreID  = @MaterialCoreID AND ColorPaletteId = @ColorPaletteID) = 0
BEGIN
	
	INSERT pMaterialCoreColor (MaterialCoreID, ColorPaletteID, ColorCode, ColorName, Active, CUser, CDate, MUser, MDate)
	SELECT @MaterialCoreID, ColorPaletteID, ColorCode, ColorName, 1, @CreatedBy, @CreatedDate, @CreatedBy , @CreatedDate
		FROM pColorPalette WHERE ColorPaletteId = @ColorPaletteID

END


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_AccessLinePlanFolderHierarchy_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_User_AccessLinePlanFolderHierarchy_SELECT]
(
      @LinePlanID uniqueidentifier,
      @TeamId uniqueidentifier
)
AS 


DECLARE @LinePlanTemplateID UNIQUEIDENTIFIER 

SELECT @LinePlanTemplateID = LinePlanTemplateID FROM pLinePlan WHERE LinePlanID = @LinePlanID

SELECT MAX(AccessRoleID) AS AccessRoleID, MAX(AccessPlanView) AS AccessPlanView, 
MAX(AccessPlanNew) AS AccessPlanNew, MAX(AccessPlanDelete) AS AccessPlanDelete, 
MAX(AccessHierView) AS AccessHierView,  MAX(AccessHierNew) AS AccessHierNew, 
MAX(AccessHierDelete) AS AccessHierDelete
FROM sAccessGroupLinePlanFolder
WHERE LinePlanTemplateID = @LinePlanTemplateID
AND GroupID  IN (
	SELECT GroupID FROM uUserGroup WHERE TeamID = @TeamID
)


/*
IF (SELECT COUNT(*) FROM pLinePlanAttributeItem WHERE LinePlanID = @LinePlanID) = 0
      BEGIN       
	
            SELECT  MAX(AccessRoleId) AS AccessRoleID, MAX(AccessPlanView) AS AccessPlanView, MAX(AccessPlanNew) AS AccessPlanNew, MAX(AccessPlanDelete) 
                    AS AccessPlanDelete, MAX(AccessHierView) AS AccessHierView, MAX(AccessHierNew) AS AccessHierNew, MAX(AccessHierDelete) AS AccessHierDelete, TeamId
            FROM sAccessLinePlanFolder
            WHERE (sAccessLinePlanFolder.TeamId = @TeamID)  
            GROUP BY TeamId
      END
ELSE
      BEGIN
            SELECT MAX(sAccessLinePlanFolder.AccessRoleId) AS AccessRoleID, MAX(sAccessLinePlanFolder.AccessPlanView) AS AccessPlanView, 
                    MAX(sAccessLinePlanFolder.AccessPlanNew) AS AccessPlanNew, MAX(sAccessLinePlanFolder.AccessPlanDelete) AS AccessPlanDelete, 
                    MAX(sAccessLinePlanFolder.AccessHierView) AS AccessHierView, MAX(sAccessLinePlanFolder.AccessHierNew) AS AccessHierNew, 
                    MAX(sAccessLinePlanFolder.AccessHierDelete) AS AccessHierDelete, sAccessLinePlanFolder.TeamId, pLinePlanAttributeItem.LinePlanId
            FROM sAccessLinePlanFolder INNER JOIN
                    pLinePlanAttributeItem ON sAccessLinePlanFolder.LinePlanTemplateID = pLinePlanAttributeItem.LinePlanTemplateID AND 
                    CAST(sAccessLinePlanFolder.CustomID AS VARCHAR(40)) = pLinePlanAttributeItem.LinePlanAttributeValue
            WHERE (pLinePlanAttributeItem.LinePlanAttributeItemParentID = '00000000-0000-0000-0000-000000000000') AND
                        (pLinePlanAttributeItem.LinePlanID = @LinePlanID) AND (sAccessLinePlanFolder.TeamId = @TeamID)  
            GROUP BY sAccessLinePlanFolder.TeamId, pLinePlanAttributeItem.LinePlanId
      END
*/





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteItemCount_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_StyleQuoteItemCount_SELECT](@StyleId uniqueidentifier)
AS SELECT     COUNT(*) AS CountQuote
FROM         dbo.pStyleQuoteItem WITH (NOLOCK)
WHERE     (StyleID = @StyleId)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialCoreColorway_SELECT]'
GO


CREATE PROCEDURE [dbo].[spx_MaterialCoreColorway_SELECT] (
	@MaterialCoreID UNIQUEIDENTIFIER
)
AS 

--Daniel Pak
--2/7/2010

--DECLARE @MaterialCoreID uniqueidentifier
--SET @MaterialCoreID = '5a3acd8c-b66a-4bf9-80fa-0294628f270e'

BEGIN

--Create temp table for available colors
CREATE TABLE #tmpMaterialCoreColor( 
	RecID						int IDENTITY(1,1)  NOT NULL,
	MaterialCoreColorID 	 	uniqueidentifier,
	MaterialCoreID 				uniqueidentifier
) ON [PRIMARY]

--Create temp table for available materials
CREATE TABLE #tmpMaterialCoreItem( 
	RecID						int IDENTITY(1,1)  NOT NULL,
	MaterialCoreItemID 	 	    uniqueidentifier,
	MaterialID 	 				uniqueidentifier,
	MaterialCoreID 				uniqueidentifier
) ON [PRIMARY]


DECLARE @RowMaterialCoreLoop 			int
DECLARE @RowMaterialCoreCount 			int
DECLARE @tmpMaterialCoreColorID			uniqueidentifier

DECLARE @RowMaterialCoreItemLoop 		int
DECLARE @RowMaterialCoreItemCount 		int
DECLARE @tmpMaterialCoreItemID			uniqueidentifier
DECLARE @tmpMaterialID					uniqueidentifier

BEGIN
--Populate colors 
	INSERT INTO #tmpMaterialCoreColor (MaterialCoreColorID, MaterialCoreID)
	SELECT MaterialCoreColorID, MaterialCoreID FROM pMaterialCoreColor WITH (NOLOCK)
	WHERE MaterialCoreId = @MaterialCoreId 
END

BEGIN
--Populate materials
	INSERT INTO #tmpMaterialCoreItem (MaterialCoreItemID, MaterialCoreID, MaterialID)
	SELECT MaterialCoreItemID, MaterialCoreID, MaterialID FROM pMaterialCoreItem WITH (NOLOCK)
	WHERE MaterialCoreId = @MaterialCoreId 
END

SET @RowMaterialCoreLoop = 1
SET @RowMaterialCoreCount = (SELECT COUNT(*) FROM #tmpMaterialCoreColor)
--Loop available colors
WHILE @RowMaterialCoreLoop <= @RowMaterialCoreCount 

	BEGIN
		SELECT @tmpMaterialCoreColorID = MaterialCoreColorID FROM #tmpMaterialCoreColor WHERE RecID = @RowMaterialCoreLoop

			BEGIN	

					SET @RowMaterialCoreItemLoop = 1
					SET @RowMaterialCoreItemCount = (SELECT COUNT(*) FROM #tmpMaterialCoreItem)
					--Loop available materials
					WHILE @RowMaterialCoreItemLoop <= @RowMaterialCoreItemCount 
						BEGIN

							SELECT @tmpMaterialCoreItemID = MaterialCoreItemID, @tmpMaterialID = MaterialID FROM #tmpMaterialCoreItem WHERE RecID = @RowMaterialCoreItemLoop
								BEGIN	

									--Check if color is available on pMaterialCoreColorItem for PIVOT function
									IF (SELECT COUNT(*) FROM pMaterialCoreColorItem WHERE MaterialCoreItemID = @tmpMaterialCoreItemID AND MaterialID = @tmpMaterialID AND MaterialCoreColorID = @tmpMaterialCoreColorID) = 0
									BEGIN
										--If not found create a blank insert.
										--INSERT INTO pMaterialCoreColorItem (MaterialCoreColorID, MaterialCoreItemID, MaterialCoreID, MaterialColorId, MaterialId)
										--SELECT @tmpMaterialCoreColorID, @tmpMaterialCoreItemID, @MaterialCoreID, '00000000-0000-0000-0000-000000000000', @tmpMaterialId 
										
										INSERT INTO pMaterialCoreColorItem (MaterialCoreColorID, MaterialCoreItemID, MaterialCoreID, MaterialColorId, MaterialId)
										SELECT @tmpMaterialCoreColorID, @tmpMaterialCoreItemID, @MaterialCoreID, NULL, @tmpMaterialId 										
										
										
									END
								END	

							SET @RowMaterialCoreItemLoop = @RowMaterialCoreItemLoop + 1
							
						END

			END	

		SET @RowMaterialCoreLoop = @RowMaterialCoreLoop + 1
		
	END

	DROP TABLE #tmpMaterialCoreItem
	DROP TABLE #tmpMaterialCoreColor

END

--BEGIN
----Update MaterialColorId NULL with '00000000-0000-0000-0000-000000000000'
----This will avoid error on color dropdownlist with null values
--	UPDATE pMaterialCoreColorItem SET MaterialColorID = '00000000-0000-0000-0000-000000000000' WHERE (MaterialColorID IS NULL) AND (MaterialCoreID = @MaterialCoreID)
--END


IF  @RowMaterialCoreCount = 0
	BEGIN
		SELECT 0 AS MainMaterial, pMaterial.MaterialID, pMaterial.TempID, pMaterial.TempNo, pMaterial.MaterialImageID, pMaterial.MaterialImageVersion, 
			  pMaterial.MaterialImageDetailID, pMaterial.MaterialImageDetailVersion, pMaterial.NoColorMatch, pMaterial.SupplierID, pMaterial.MaterialType, 
			  pMaterial.MaterialNo, pMaterial.MaterialName, pMaterial.A, pMaterial.B, pMaterial.C, pMaterial.D, pMaterial.E, pMaterial.F, 
			  pMaterial.G, pMaterial.H, pMaterial.I, pMaterial.J, pMaterial.K, pMaterial.L, pMaterial.M, pMaterial.N, pMaterial.O, 
			  pMaterial.P, pMaterial.Q, pMaterial.R, pMaterial.S, pMaterial.T, pMaterial.U, pMaterial.V, pMaterial.W, pMaterial.X, 
			  pMaterial.Y, pMaterial.Z, pMaterial.Source, pMaterial.Notes, pMaterial.VendorPrice, pMaterial.VolumePrice, 
			  pMaterial.VolumePriceMinimum, pMaterial.VendorProductionMin, pMaterial.VendorProductionLeadTime, pMaterial.MaterialPlacement, 
			  pMaterial.DetailYesNo, pMaterial.ImageType1, pMaterial.height, pMaterial.width, pMaterial.MChange, pMaterial.DChange, 
			  pMaterial.Action, pMaterial.Status, pMaterial.Active, pMaterial.MultiDimension, pMaterial.MaterialCode, pMaterial.MaterialCodeNo, 
			  pMaterial.SAPCode, pMaterial.SAPControl, pMaterial.MaterialColorRequired, pMaterial.FactorySourced, pMaterial.TradePartnerID, 
			  pMaterial.TradePartnerVendorID, pMaterialCoreItem.MaterialCoreID, pMaterialCoreItem.MaterialCoreItemID, pComponentType.ComponentTypeID, 
			  pComponentType.ComponentDescription, pComponentType.ComponentType, pComponentType.ComponentOrder, pMaterial.UOM, 
			  pMaterialCoreItem.Qty, pMaterialCoreItem.MaterialPrice, pMaterialCoreItem.Ext, pMaterialCoreItem.MaterialSize, pMaterialCoreItem.Placement, 
			  pMaterialCoreItem.Artwork, pMaterialCoreItem.License, pMaterialCoreItem.Colorway, pMaterialCoreItem.CUser, pMaterialCoreItem.CDate, 
			  pMaterialCoreItem.MUser, pMaterialCoreItem.MDate, 
			  '<img src="../System/Control/ImageStream.ashx?S=50&V=' + CAST(pMaterial.MaterialImageVersion AS NVARCHAR(5)) 
			  + '&IID=' + CAST(pMaterial.MaterialImageID AS NVARCHAR(40)) + '" />' AS ImagePath
		FROM  pMaterial INNER JOIN
			  pMaterialCoreItem ON pMaterial.MaterialID = pMaterialCoreItem.MaterialID INNER JOIN
			  pComponentType ON pMaterial.MaterialType = pComponentType.ComponentTypeID
		WHERE pMaterialCoreItem.MaterialCoreID = @MaterialCoreID

	END
ELSE
	BEGIN 
	--Create a temp table with all available color to pivot the table
		SELECT 0 AS MainMaterial,  pMaterial.MaterialID, pMaterial.TempID, pMaterial.TempNo, pMaterial.MaterialImageID, pMaterial.MaterialImageVersion, 
		  pMaterial.MaterialImageDetailID, pMaterial.MaterialImageDetailVersion, pMaterial.NoColorMatch, pMaterial.SupplierID, pMaterial.MaterialType, 
		  pMaterial.MaterialNo, pMaterial.MaterialName, pMaterial.A, pMaterial.B, pMaterial.C, pMaterial.D, pMaterial.E, pMaterial.F, 
		  pMaterial.G, pMaterial.H, pMaterial.I, pMaterial.J, pMaterial.K, pMaterial.L, pMaterial.M, pMaterial.N, pMaterial.O, 
		  pMaterial.P, pMaterial.Q, pMaterial.R, pMaterial.S, pMaterial.T, pMaterial.U, pMaterial.V, pMaterial.W, pMaterial.X, 
		  pMaterial.Y, pMaterial.Z, pMaterial.Source, pMaterial.Notes, pMaterial.VendorPrice, pMaterial.VolumePrice, 
		  pMaterial.VolumePriceMinimum, pMaterial.VendorProductionMin, pMaterial.VendorProductionLeadTime, pMaterial.MaterialPlacement, 
		  pMaterial.DetailYesNo, pMaterial.ImageType1, pMaterial.height, pMaterial.width, pMaterial.MChange, pMaterial.DChange, 
		  pMaterial.Action, pMaterial.Status, pMaterial.Active, pMaterial.MultiDimension, pMaterial.MaterialCode, pMaterial.MaterialCodeNo, 
		  pMaterial.SAPCode, pMaterial.SAPControl, pMaterial.MaterialColorRequired, pMaterial.FactorySourced, pMaterial.TradePartnerID, 
		  pMaterial.TradePartnerVendorID, pMaterialCoreItem.MaterialCoreID, pMaterialCoreItem.MaterialCoreItemID, pMaterialCoreColor.MaterialCoreColorID, pMaterialCoreColor.ColorPaletteID, 
		  pMaterialCoreColor.ColorCode, pMaterialCoreColor.ColorName, pMaterialCoreColor.Sort, pMaterialCoreColorItem.MaterialColorID, 
		  pComponentType.ComponentTypeID, pComponentType.ComponentDescription, pComponentType.ComponentType, 
		  pComponentType.ComponentOrder, pMaterial.UOM, pMaterialCoreItem.Qty, pMaterialCoreItem.MaterialPrice, pMaterialCoreItem.Ext, 
		  pMaterialCoreItem.MaterialSize, pMaterialCoreItem.Placement, pMaterialCoreItem.Artwork, pMaterialCoreItem.License, 
		  pMaterialCoreItem.Colorway, pMaterialCoreItem.CUser, pMaterialCoreItem.CDate, pMaterialCoreItem.MUser, pMaterialCoreItem.MDate, pMaterialCoreColorItem.MaterialCoreColorItemID,

		'<img src="../System/Control/ImageStream.ashx?S=50&V='  +  CAST(pMaterial.MaterialImageVersion  AS NVARCHAR(5))+  
		'&IID=' + CAST ( pMaterial.MaterialImageID AS NVARCHAR(40)) + '" />'
		as ImagePath 
		INTO #MaterialCore
		FROM pMaterial INNER JOIN
		  pMaterialCoreItem ON pMaterial.MaterialID = pMaterialCoreItem.MaterialID INNER JOIN
		  pMaterialCoreColor ON pMaterialCoreItem.MaterialCoreID = pMaterialCoreColor.MaterialCoreID INNER JOIN
		  pComponentType ON pMaterial.MaterialType = pComponentType.ComponentTypeID LEFT OUTER JOIN
		  pMaterialCoreColorItem ON pMaterialCoreColor.MaterialCoreColorID = pMaterialCoreColorItem.MaterialCoreColorID AND 
		  pMaterialCoreItem.MaterialCoreItemID = pMaterialCoreColorItem.MaterialCoreItemID
		WHERE pMaterialCoreItem.MaterialCoreID = @MaterialCoreID

		--Finally we got it pivoting the table.
		EXECUTE spx_Crosstab 'SELECT MainMaterial,  
		ComponentOrder, MaterialCoreItemID, MaterialCoreID, Placement, 
		MaterialNo, MaterialCode, MaterialName, MaterialType, 
		MaterialID, UOM, Qty, MaterialPrice, ImagePath,
		Ext, MaterialSize, MaterialPlacement, 
		MaterialImageID, 
		MaterialImageVersion, ComponentTypeID, 
		A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S, T, U, 
		V, W, X, Y, Z, 
		CDate, CUser, MDate, MUser, 
		Artwork, License, Colorway, '''' AS GroupName,
		ComponentDescription, LTRIM(RTRIM(MaterialColorID)) AS MaterialColorID , MaterialCoreColorID
		FROM #MaterialCore',
		NULL,
		NULL,
		'MaterialCoreColorID',
		'MaterialColorID',
		'MAX'

		DROP TABLE #MaterialCore

	END 








GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[vws_SampleRequest_Relationship]'
GO
CREATE VIEW dbo.vws_SampleRequest_Relationship
AS
SELECT     dbo.pSampleRequestWorkflow.SampleRequestWorkflowID
FROM         dbo.pSampleRequestComment INNER JOIN
                      dbo.pSampleRequestLog INNER JOIN
                      dbo.pSampleRequestSpecItem INNER JOIN
                      dbo.pSampleRequestSpecSize ON 
                      dbo.pSampleRequestSpecItem.SampleRequestSpecSizeID = dbo.pSampleRequestSpecSize.SampleRequestSpecSizeID INNER JOIN
                      dbo.pSampleRequestWorkflow INNER JOIN
                      dbo.pSampleRequestTrade INNER JOIN
                      dbo.pSampleRequestStyle ON dbo.pSampleRequestTrade.StyleColorID = dbo.pSampleRequestStyle.StyleColorID ON 
                      dbo.pSampleRequestWorkflow.SampleRequestTradeID = dbo.pSampleRequestTrade.SampleRequestTradeID INNER JOIN
                      dbo.pSampleRequestSubmitImage ON 
                      dbo.pSampleRequestWorkflow.SampleRequestWorkflowID = dbo.pSampleRequestSubmitImage.SampleRequestWorkflowID INNER JOIN
                      dbo.pSampleRequestActivity INNER JOIN
                      dbo.pSampleRequestSubmit ON dbo.pSampleRequestActivity.SampleRequestSubmitID = dbo.pSampleRequestSubmit.SampleRequestSubmitID ON 
                      dbo.pSampleRequestWorkflow.SampleRequestWorkflowID = dbo.pSampleRequestSubmit.SampleRequestWorkflowID INNER JOIN
                      dbo.pSampleRequestSubmitStatus ON dbo.pSampleRequestSubmit.Status = dbo.pSampleRequestSubmitStatus.StatusID ON 
                      dbo.pSampleRequestSpecItem.SampleRequestWorkflowID = dbo.pSampleRequestSubmitImage.SampleRequestWorkflowID INNER JOIN
                      dbo.pSampleRequestMaterial ON dbo.pSampleRequestSubmitImage.SampleRequestWorkflowID = dbo.pSampleRequestMaterial.SampleRequestWorkflowID ON 
                      dbo.pSampleRequestLog.SampleRequestSubmitID = dbo.pSampleRequestSubmit.SampleRequestSubmitID ON 
                      dbo.pSampleRequestComment.SampleRequestWorkflowID = dbo.pSampleRequestWorkflow.SampleRequestWorkflowID
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_AccessLinePlanFolderTab_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_User_AccessLinePlanFolderTab_SELECT]
(
@LinePlanAttributeItemId uniqueidentifier,
@LinePlanAttributeId uniqueidentifier,
@LinePlanId uniqueidentifier,
@TeamId uniqueidentifier
)
AS 

/*
@LinePlanAttributeId will display current level of plan 
@LinePlanAttributeItemId will display first level of plan 
*/


DECLARE  @LinePlanTemplateID UNIQUEIDENTIFIER 
SELECT @LinePlanTemplateID = LinePlanTemplateID FROM pLinePlan WHERE LinePlanID = @LinePlanID 

SELECT a.LinePlanFolderTabID, c.TeamID, a.AccessLinePlanId, 
      a.AccessRoleId, a.AccessView, a.AccessCreate, 
      a.AccessModify, a.AccessDelete, a.AccessPrint, 
      a.AccessRemove, a.CUser, a.CDate, a.MUser, 
      a.MDate, a.AccessLinePlanTabId, f.LinePlanTabID, f.LinePlanTabName, 
      f.LinePlanTabUrl, f.LinePlanTabToolTip, f.LinePlanTabSort, f.LinePlanTabRollupName, 
      f.LinePlanTabRollupUrl, f.LinePlanTabRollupToolTip
FROM  sAccessGroupLinePlanTab a 
INNER JOIN sAccessGroupLinePlanFolder b ON a.AccessLinePlanId = b.AccessLinePlanId 
INNER JOIN uUserGroup c ON b.GroupID = c.GroupID 
INNER JOIN pLinePlanAttributeItem d ON CAST(b.CustomID AS VARCHAR(40)) = d.LinePlanAttributeValue 
INNER JOIN pLinePlanFolderTab e ON a.LinePlanFolderTabID = e.LinePlanFolderTabID 
INNER JOIN pLinePlanTab f ON e.LinePlanTabID = f.LinePlanTabID
WHERE c.TeamID = @TeamID
AND f.Active = 1
AND d.LinePlanAttributeItemID = @LinePlanAttributeItemId 
AND d.LinePlanID = @LinePlanId
AND a.LinePlanTemplateID = @LinePlanTemplateID 
ORDER BY  f.LinePlanTabSort




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pLineFolderType]'
GO
CREATE TABLE [dbo].[pLineFolderType]
(
[LineFolderTypeID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_pLineFolderType_LineFolderTypeID] DEFAULT (newsequentialid()),
[LineFolderTypeName] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[LineFolderTypeDescription] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[LineFolderNewSchema] [varchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[LineFolderSchema] [varchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[LineFolderSchemaItem] [varchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[LineFolderSchemaSearch] [varchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[LineFolderItemSchemaSearch] [varchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[LineFolderItemSchema] [varchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CDate] [datetime] NULL,
[MUser] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pLineFolderType] on [dbo].[pLineFolderType]'
GO
ALTER TABLE [dbo].[pLineFolderType] ADD CONSTRAINT [PK_pLineFolderType] PRIMARY KEY CLUSTERED  ([LineFolderTypeID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[vwx_MaterialRequestWorkflowTemplateItem_SEL]'
GO

CREATE VIEW [dbo].[vwx_MaterialRequestWorkflowTemplateItem_SEL]
AS
SELECT     dbo.pMaterialRequestWorkflowTemplateItem.MaterialRequestWorkflowTempItemID, dbo.pMaterialRequestWorkflowTemplateItem.MaterialRequestWorkflowTempID, 
                      dbo.pMaterialRequestWorkflowTemplateItem.MaterialRequestWorkflowID, dbo.pMaterialRequestWorkflowTemplateItem.MaterialRequestWorkflowAssignedTo, 
                      dbo.pMaterialRequestWorkflowTemplateItem.MaterialRequestWorkflowDays, dbo.pMaterialRequestWorkflowTemplateItem.MaterialRequestWorkflowRDays, 
                      dbo.pMaterialRequestWorkflowTemplateItem.MaterialRequestWorkflowFinalDate, dbo.pMaterialRequestWorkflowTemplateItem.MaterialRequestWorkflowAlerts, 
                      dbo.pMaterialRequestWorkflowTemplateItem.Active, dbo.pMaterialRequestWorkflowTemplateItem.CUser, dbo.pMaterialRequestWorkflowTemplateItem.CDate, 
                      dbo.pMaterialRequestWorkflowTemplateItem.MUser, dbo.pMaterialRequestWorkflowTemplateItem.MDate, 
                      dbo.pMaterialRequestWorkflowTemplateItem.MaterialRequestWorkflowSort, dbo.pMaterialRequestWorkflow.MaterialRequestWorkflow AS MaterialRequestWorkflowName, 
                      dbo.pMaterialRequestWorkflowTemplateItem.MaterialRequestWorkflowGroupID
FROM         dbo.pMaterialRequestWorkflow INNER JOIN
                      dbo.pMaterialRequestWorkflowTemplateItem ON 
                      dbo.pMaterialRequestWorkflow.MaterialRequestWorkflowID = dbo.pMaterialRequestWorkflowTemplateItem.MaterialRequestWorkflowID
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_User_SELECT]'
GO


CREATE PROCEDURE [dbo].[spx_User_SELECT]
(
@TeamID uniqueidentifier
)
AS 

BEGIN
	SELECT UserId, UserCode, TeamID, FirstName, MiddleName, LastName, Title, Birthday, Company, Street1, Street2, City, State, Zip, Country, Phone, Fax, Mobile, UserName, 
	  PassWord, Email, ContactName1, ContactTitle1, ContactEmail1, ContactName2, ContactTitle2, ContactEmail2, ContactName3, ContactTitle3, ContactEmail3, 
	  ContactName4, ContactTitle4, ContactEmail4, Admin, Active, PublicAccess, TradePartner, LastUpdate, SESSION, SESSIONDATE, SESSIONOS, SCREENWIDTH, 
	  SCREENHEIGHT, FirstName + ' ' + LastName AS FULLNAME, USERDIR, MAILADDR, MAXSIZE, MAXMSGS, FLAGS, TYPE, IP, Picture, CUser, CDate, MUser, MDate, CalendarTemplateID, ActivationID, 
	  ReadOnly, SystemClientID, ServerLocationID
	FROM Users
	WHERE TeamId = @TeamId
END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_User_AccessLinePlanFolderTabItem_SELECT]'
GO


CREATE PROCEDURE [dbo].[spx_User_AccessLinePlanFolderTabItem_SELECT](
@LinePlanAttributeItemId uniqueidentifier,
@LinePlanId uniqueidentifier,
@LinePlanTabID int,
@TeamId uniqueidentifier
)
AS 


DECLARE  @LinePlanTemplateID UNIQUEIDENTIFIER 
SELECT @LinePlanTemplateID = LinePlanTemplateID FROM pLinePlan WHERE LinePlanID = @LinePlanID 

SELECT a.LinePlanFolderTabID, c.TeamID, a.AccessLinePlanId, 
      a.AccessRoleId, a.AccessView, a.AccessCreate, 
      a.AccessModify, a.AccessDelete, a.AccessPrint, 
      a.AccessRemove, a.CUser, a.CDate, a.MUser, 
      a.MDate, a.AccessLinePlanTabId, f.LinePlanTabID, f.LinePlanTabName, 
      f.LinePlanTabUrl, f.LinePlanTabToolTip, f.LinePlanTabSort, f.LinePlanTabRollupName, 
      f.LinePlanTabRollupUrl, f.LinePlanTabRollupToolTip
FROM  sAccessGroupLinePlanTab a 
INNER JOIN sAccessGroupLinePlanFolder b ON a.AccessLinePlanId = b.AccessLinePlanId 
INNER JOIN uUserGroup c ON b.GroupID = c.GroupID 
INNER JOIN pLinePlanAttributeItem d ON CAST(b.CustomID AS VARCHAR(40)) = d.LinePlanAttributeValue 
INNER JOIN pLinePlanFolderTab e ON a.LinePlanFolderTabID = e.LinePlanFolderTabID  AND e.LinePlanTemplateID = @LinePlanTemplateID
INNER JOIN pLinePlanTab f ON e.LinePlanTabID = f.LinePlanTabID
WHERE c.TeamID = @TeamID
AND f.Active = 1
AND d.LinePlanAttributeItemID = @LinePlanAttributeItemId 
AND d.LinePlanID = @LinePlanId
AND a.LinePlanTemplateID = @LinePlanTemplateID 
AND e.LinePlanTabID  = @LinePlanTabID 
ORDER BY  f.LinePlanTabSort



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[vwx_LineFolderItem_SELECT]'
GO
CREATE VIEW dbo.vwx_LineFolderItem_SELECT
AS
SELECT     dbo.pLineFolderItem.LineFolderID, dbo.pLineFolderItem.LineFolderItemID, dbo.pLineFolderItem.LineItemFolder1, dbo.pLineFolderItem.LineItemFolder2, 
                      dbo.pLineFolderItem.LineItemFolder3, dbo.pLineFolderItem.LineItemFolder4, dbo.pLineFolderItem.LineItemFolder5, dbo.pLineFolderItem.LineItemFolder6, 
                      dbo.pLineFolderItem.LineItemFolder7, dbo.pLineFolderItem.LineItemFolder8, dbo.pLineFolderItem.LineItemFolder9, dbo.pLineFolderItem.LineFolderItemDrop, 
                      dbo.pLineFolderItem.LineFolderItemDropUser, dbo.pLineFolderItem.LineFolderItemDropDate, dbo.pLineFolderItem.LineFolderImageID, 
                      dbo.pLineFolderItem.LineFolderImageVersion, dbo.pLineFolderItem.CUser, dbo.pLineFolderItem.CDate, dbo.pLineFolderItem.MUser, dbo.pLineFolderItem.MDate, 
                      dbo.pLineFolderItem.MChange, dbo.pStyleHeader.StyleID, dbo.pStyleHeader.DevelopmentNo + '*' + CAST(dbo.pStyleDevelopmentItem.Variation AS NVARCHAR(5)) 
                      AS ConceptNo, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.CustomField5 AS PatternRef, dbo.pStyleHeader.Description, 
                      dbo.pStyleHeader.CustomField8 AS DMCStyleType, dbo.pStyleMaterials.F AS FabricYarnType, dbo.pStyleMaterials.MaterialName AS MainMaterial, 
                      dbo.pStyleMaterials.H AS [Content], dbo.pStyleMaterials.I AS FabricWeight, dbo.pStyleHeader.SizeRange, dbo.pLineFolder.SeasonYearID, 
                      dbo.pLineFolder.LineFolderTypeID, dbo.pStyleHeader.SizeClass, dbo.pStyleHeader.DesignSketchID, dbo.pStyleHeader.DesignSketchVersion, 
                      dbo.pLineFolderItem.LineFolderItemSort
FROM         dbo.pLineFolderItem INNER JOIN
                      dbo.pStyleHeader ON dbo.pLineFolderItem.StyleID = dbo.pStyleHeader.StyleID INNER JOIN
                      dbo.pStyleDevelopmentItem ON dbo.pStyleHeader.StyleID = dbo.pStyleDevelopmentItem.StyleID INNER JOIN
                      dbo.pLineFolder ON dbo.pLineFolderItem.LineFolderID = dbo.pLineFolder.LineFolderID LEFT OUTER JOIN
                      dbo.pStyleMaterials ON dbo.pStyleHeader.StyleID = dbo.pStyleMaterials.StyleID AND dbo.pStyleHeader.StyleSet = dbo.pStyleMaterials.StyleSet AND 
                      dbo.pStyleMaterials.MainMaterial = 1
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialCoreItem_INSERT]'
GO


ALTER PROCEDURE [dbo].[spx_MaterialCoreItem_INSERT](
@MaterialID nvarchar(50),
@CreatedBy nvarchar(200),
@CreatedDate datetime,
@MaterialCoreID uniqueidentifier
)
AS 

DECLARE @MaterialCoreItemID UNIQUEIDENTIFIER 
SET @MaterialCoreItemID  = NEWID()


INSERT INTO dbo.pMaterialCoreItem (MaterialCoreItemID, MaterialID, CDate, CUser, MDate, MUser, MaterialCoreID)
VALUES  (@MaterialCoreItemID, @MaterialID, @CreatedDate, @CreatedBy, @CreatedDate, @CreatedBy, @MaterialCoreID)


--***
--** MultiCloth Logic ! 
--***
CREATE TABLE #style (
ROWID INT IDENTITY (1,1),
StyleID  UNIQUEIDENTIFIER 
)

INSERT INTO #style  (StyleID) 
SELECT StyleID 
FROM pStyleHeader 
WHERE MaterialCoreID = @MaterialCoreID 

DECLARE @TOTAL INT
DECLARE @ROWID INT 
DECLARE @StyleID UNIQUEIDENTIFIER 
DECLARE @StyleMaterialID UNIQUEIDENTIFIER 

SELECT @TOTAL = COUNT(*) FROM  #style 
SET @ROWID = 1 

WHILE @ROWID <= @TOTAL 
BEGIN

	SELECT @StyleID = StyleID FROM #style WHERE ROWID = @ROWID 
	SET @StyleMaterialID = NEWID()
	
	INSERT INTO pStyleMaterials ( StyleMaterialID , StyleMaterialMasterID, MainMaterial,StyleSet, StyleID, 
		MaterialID , MaterialImageID , MaterialImageVersion, MaterialType, MaterialNo, MaterialName, 
		A,B, C, D ,E, F, G,H, I, J , K, L, M , N, O, P, Q, R, S, T, 
		U, V,W, X, Y, Z, Notes, CUser, CDate,MUser,MDate, MChange, Colorway,
		UOM, Qty, MaterialPrice, Ext, MaterialSize, Placement, Artwork, License, StyleMaterialLinkID, MultiCloth)
	SELECT  @StyleMaterialID, NEWID() AS StyleMaterialMasterID, 0, 1 AS StyleSet, @StyleID, a.MaterialID, ISNULL(a.MaterialImageID,'00000000-0000-0000-0000-000000000000') AS MaterialImageID, 
	  ISNULL(a.MaterialImageVersion,1) AS MaterialImageVersion, a.MaterialType, a.MaterialNo, a.MaterialName, a.A, a.B, a.C, a.D, a.E, a.F, a.G, a.H, a.I, a.J, a.K, a.L, a.M, a.N, a.O, a.P, a.Q, a.R, a.S, a.T, a.U, 
	  a.V, a.W, a.X, a.Y, a.Z, a.Notes, @CreatedBy AS CreatedBy, @CreatedDate AS CreatedDate, @CreatedBy AS ModifiedBy, @CreatedDate AS ModifiedDate, a.MChange, 1 AS Colorway, 
	  a.UOM, 0 AS Qty, 0 AS MaterialPrice, NULL, NULL, NULL, 
	  0  AS Artwork, 0 AS License, @MaterialCoreItemID, 1 AS MultiCloth
	FROM pMaterial AS a 
	WHERE MaterialID = @MaterialID

  			
	SET @ROWID = @ROWID + 1 
END 










GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LineFolderItem_INSERT]'
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER  PROCEDURE [dbo].[spx_LineFolderItem_INSERT]
(@StyleSeasonYearID uniqueidentifier,
@LineFolderItemID uniqueidentifier,
@LineFolderID uniqueidentifier,
@CreatedDate datetime,
@CreatedBy nvarchar(200))
AS 

DECLARE @StyleID UNIQUEIDENTIFIER
SELECT @StyleID = StyleID FROM pStyleSeasonYear WHERE StyleSeasonYearID = @StyleSeasonYearID


INSERT INTO dbo.pLineFolderItem (LineFolderItemID , LineFolderID, StyleID, StyleSeasonYearID, CUser, CDate, MUser, MDate) 
VALUES (@LineFolderItemID, @LineFolderID, @StyleID, @StyleSeasonYearID, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate)

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_POMLibraryToStyleSpec_Linked_INSERT]'
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[spx_POMLibraryToStyleSpec_Linked_INSERT]
(
	@POMLibraryID uniqueidentifier,
	@StyleID nvarchar(50),
	@StyleSet nvarchar(50)
)
AS 


/************************/
/*Declare variables.	*/
/************************/
DECLARE @POMLibraryID_Param UNIQUEIDENTIFIER	--Keep a copy of the original parameter value.
DECLARE @StyleID_Param UNIQUEIDENTIFIER			--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT						--Keep a copy of the original parameter value.

DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @POMLibraryID_Param = @POMLibraryID
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	,POMLibraryID UNIQUEIDENTIFIER
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_POMLibraryToStyleSpec_INSERT
			@POMLibraryID_Param
			,@StyleID_Param
			,@StyleSet_Param
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet
			,POMLibraryID)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet_Param AS StyleSet
			,@POMLibraryID_Param AS POMLibraryID
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID
	END

/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles to add the POM to.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @POMLibraryID = NULL
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Get the 'StyleID' for the insert.*/
		SELECT @POMLibraryID = POMLibraryID
			,@StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_POMLibraryToStyleSpec_INSERT
			@POMLibraryID
			,@StyleID
			,@StyleSet


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_AccessLinePlanFolderTree_SELECT]'
GO



ALTER PROCEDURE [dbo].[spx_User_AccessLinePlanFolderTree_SELECT]
(
@LinePlanAttributeId uniqueidentifier,
@LinePlanId uniqueidentifier,
@TeamId uniqueidentifier
)
AS 

DECLARE @LinePlanTemplateID  uniqueidentifier
SELECT @LinePlanTemplateID   = LinePlanTemplateID   FROM pLinePlan where LinePlanID = @LinePlanID 

SELECT  b.AccessRoleId
FROM  pLinePlanAttributeItem a WITH (NOLOCK) 
INNER JOIN sAccessLinePlanFolder b WITH (NOLOCK) 
	ON a.LinePlanAttributeValue = CAST(b.CustomID AS VARCHAR(40))
WHERE b.TeamId = @TeamID
AND a.LinePlanID = @LinePlanID
AND a.LinePlanAttributeID = @LinePlanAttributeId
AND  a.LinePlanAttributeItemParentID = '00000000-0000-0000-0000-000000000000'
AND b.LinePlanTemplateID   = @LinePlanTemplateID  





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialCoreItem_SELECT]'
GO



ALTER PROCEDURE [dbo].[spx_MaterialCoreItem_SELECT](@MaterialCoreID uniqueidentifier)
AS SELECT     
dbo.pMaterial.MaterialID, dbo.pMaterial.MaterialImageID, dbo.pMaterial.MaterialImageVersion, dbo.pMaterial.MaterialNo, dbo.pMaterial.MaterialName, 
dbo.pMaterial.MaterialCode,
dbo.pMaterial.MaterialType, dbo.pMaterialCoreItem.MaterialCoreItemID, dbo.pMaterialCoreItem.MaterialCoreID, dbo.pMaterial.UOM, 
dbo.pMaterialCoreItem.Qty, dbo.pMaterialCoreItem.MaterialPrice, dbo.pMaterialCoreItem.Ext, dbo.pMaterialCoreItem.MaterialSize, 
dbo.pMaterialCoreItem.Placement, dbo.pMaterialCoreItem.CUser, dbo.pMaterialCoreItem.CDate, dbo.pMaterialCoreItem.MUser, 
dbo.pMaterialCoreItem.MDate, dbo.pMaterialCoreItem.Artwork, dbo.pMaterialCoreItem.License, dbo.pMaterialCoreItem.Colorway,

'<img src="../System/Control/ImageStream.ashx?S=50&V='  +  CAST(dbo.pMaterial.MaterialImageVersion  AS NVARCHAR(5))+  
'&IID=' + CAST ( dbo.pMaterial.MaterialImageID AS NVARCHAR(40)) + '" />'
as ImagePath 
FROM         dbo.pMaterial WITH (NOLOCK) INNER JOIN
                      dbo.pMaterialCoreItem WITH (NOLOCK) ON dbo.pMaterial.MaterialID = dbo.pMaterialCoreItem.MaterialID
WHERE     (dbo.pMaterialCoreItem.MaterialCoreID = @MaterialCoreID)
ORDER BY dbo.pMaterial.MaterialName, dbo.pMaterial.MaterialType






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_AccessLineFolder_SELECT]'
GO




ALTER PROCEDURE [dbo].[spx_User_AccessLineFolder_SELECT]
(@teamId uniqueidentifier)
AS 


SELECT 1 AS LineTypeID, 'Line Folder' AS LineFolder,  AccessLineId,  AccessRoleId,  AccessView, AccessCreate, 
    AccessModify, AccessDelete, AccessPrint,  TeamId,  CUser,  CDate, MUser,  MDate  
FROM  sAccessLineFolder WITH (NOLOCK) 
WHERE TeamId = @teamId



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LineFolderItemColorChip_SELECT]'
GO



/**************************************************
-- @nOption 	= 0	Select all
		= 1	Select with LineFolderItemColorDrop = 1  (DROPPED)
		= 2	Select with LineFolderItemColorDrop = 0   (ACTIVE)

**************************************************/
ALTER  PROCEDURE [dbo].[spx_LineFolderItemColorChip_SELECT]
(@LineFolderItemID uniqueidentifier,
@nOption int = 0 
)
AS

SET NOCOUNT ON

/*****************************************************
@nColorName 	= 0 COLOR COMBO (Color Combo name.)
				= 1	COLOR NAME (For some reason, this is also the color combo name.)
				= 2 MATERIAL COLOR (The name of the Main Material chip.)
*****************************************************/
DECLARE @nColorName as int 
SET @nColorName = 0


IF @nOption = 1
	BEGIN 
	
			-- DROPPED
			IF @nColorName = 0
			BEGIN
				SELECT  pMaterialColor.ColorFolderID, pMaterialColor.ColorPaletteID, pMaterialColor.ColorCode, pMaterialColor.ColorName, pStyleColorway.StyleColorNo, 
					pStyleColorway.StyleColorName, pMaterialColor.MaterialColorImageID, pMaterialColor.MaterialColorImageVersion
				FROM  pLineFolderItemColor WITH (NOLOCK) INNER JOIN
					pMaterialColor WITH (NOLOCK) INNER JOIN
					pStyleColorwayItem WITH (NOLOCK) ON pMaterialColor.MaterialColorID = pStyleColorwayItem.MaterialColorID INNER JOIN
					pStyleColorway WITH (NOLOCK) ON pStyleColorwayItem.StyleColorID = pStyleColorway.StyleColorID ON 
					pLineFolderItemColor.StyleColorID = pStyleColorway.StyleColorID
				WHERE (pLineFolderItemColor.LineFolderItemID = @LineFolderItemID) AND (pLineFolderItemColor.LineFolderItemColorDrop = 1)
				ORDER BY pStyleColorway.Sort, pStyleColorway.StyleColorNo, pStyleColorway.StyleColorName
			END	
			ELSE
			BEGIN
				SELECT  pMaterialColor.ColorFolderID, pMaterialColor.ColorPaletteID, pMaterialColor.ColorCode, pMaterialColor.ColorName, pStyleColorway.StyleColorNo, 
					pStyleColorway.StyleColorName, pMaterialColor.MaterialColorImageID ,  pMaterialColor.MaterialColorImageVersion
				FROM pStyleColorwayItem WITH (NOLOCK) INNER JOIN
					pMaterialColor WITH (NOLOCK) ON pStyleColorwayItem.MaterialColorID = pMaterialColor.MaterialColorID INNER JOIN
					pStyleColorway WITH (NOLOCK) ON pStyleColorwayItem.StyleColorID = pStyleColorway.StyleColorID INNER JOIN
					pLineFolderItemColor WITH (NOLOCK) ON pStyleColorway.StyleColorID = pLineFolderItemColor.StyleColorID INNER JOIN
					pStyleMaterials WITH (NOLOCK) ON pStyleColorwayItem.StyleMaterialID = pStyleMaterials.StyleMaterialID
				WHERE (pStyleMaterials.MainMaterial = 1) AND (pLineFolderItemColor.LineFolderItemID = @LineFolderItemID)
				AND  pLineFolderItemColor.LineFolderItemColorDrop =  1
				ORDER BY pStyleColorway.Sort, pStyleColorway.StyleColorNo, pStyleColorway.StyleColorName
			END
	END 
ELSE  IF @nOption = 2 
	BEGIN 
		-- ACTIVE 
		DECLARE @MaterialID  as uniqueidentifier 
		DECLARE @StyleMaterialID  as uniqueidentifier 
		
		SELECT TOP 1 @MaterialID =  pStyleColorwayItem.MaterialID , @StyleMaterialID =  pStyleMaterials.StyleMaterialID
		FROM pLineFolderItemColor WITH (NOLOCK) INNER JOIN
			pStyleColorway WITH (NOLOCK) ON pLineFolderItemColor.StyleColorID = pStyleColorway.StyleColorID INNER JOIN
			pStyleColorwayItem WITH (NOLOCK) ON pStyleColorway.StyleColorID = pStyleColorwayItem.StyleColorID INNER JOIN
			pStyleMaterials WITH (NOLOCK) ON pStyleColorwayItem.StyleMaterialID = pStyleMaterials.StyleMaterialID
		WHERE (pLineFolderItemColor.LineFolderItemID = @LineFolderItemID) AND (pLineFolderItemColor.LineFolderItemColorDrop <> 1)
		ORDER BY pStyleMaterials.MainMaterial DESC			
				
		--SELECT @MaterialID as MATERIAL 
			
		IF   @MaterialID is not null 
			BEGIN 
				select  c.MainMaterial , a.StyleColorID, a.StyleID,
				b.StyleColorNo, b.StyleColorName,  b.MainColor ,   d.MaterialID , d.MaterialColorID,
		
				Case c.MainMaterial 
					WHEN 0 THEN NULL
					WHEN 1 THEN 
						CASE @nColorName 
							WHEN 0 THEN 	NULL
							ELSE e.ColorCode
						END 
				END as ColorCode ,
		
				CASE @nColorName
					WHEN 0 THEN b.MainColor
					WHEN 1 THEN b.StyleColorName 
					WHEN 2 THEN e.ColorName 
				END as ColorName, 
		
				Case c.MainMaterial 
					WHEN 0 THEN NULL 
					WHEN 1 THEN e.ColorFolderID 
				END as ColorFolderID ,
				Case c.MainMaterial 
					WHEN 0 THEN NULL
					WHEN 1 THEN e.ColorPaletteID
				END as ColorPaletteID , 
				Case c.MainMaterial 
					WHEN 0 THEN NULL
					WHEN 1 THEN e.MaterialColorImageID 
				END as MaterialColorImageID  , 			
				Case c.MainMaterial 
					WHEN 0 THEN NULL
					WHEN 1 THEN e.MaterialColorImageVersion
				END as MaterialColorImageVersion
		  
				FROM pMaterialColor e WITH (NOLOCK) RIGHT OUTER JOIN
		
			                pStyleColorwayItem d WITH (NOLOCK) INNER JOIN
			                pLineFolderItemColor a WITH (NOLOCK) INNER JOIN
			                pStyleColorway b WITH (NOLOCK) ON a.StyleColorID = b.StyleColorID AND a.StyleID = b.StyleID INNER JOIN
			                pStyleMaterials c WITH (NOLOCK) ON b.StyleID = c.StyleID ON d.StyleMaterialID = c.StyleMaterialID AND d.StyleColorID = a.StyleColorID ON 
			                e.MaterialColorID = d.MaterialColorID
		
				WHERE     (a.LineFolderItemID = @LineFolderItemId) AND 
				a.LineFolderItemColorDrop <> 1 AND 
				(d.MaterialID = @MaterialID) AND 
				(c.StyleMaterialID = @StyleMaterialID)
				ORDER BY b.Sort, b.StyleColorName, b.StyleColorID               
				
			END
		ELSE
			BEGIN		
				IF  ( select  count(*) 
				from pStyleColorWay a WITH (NOLOCK), pLinefolderItemColor   b WITH (NOLOCK) 
				where b.LineFolderItemId   = @LineFolderItemId 
				AND a.StyleId = b.StyleID 
				AND (b.LineFolderItemColorDrop = 0 OR b.LineFolderItemColorDrop IS NULL)
				and a.StyleColorId = b.StyleColorID  ) > 0 
					select  NULL AS  MainMaterial, NULL AS  StyleColorID, NULL AS StyleID ,
					NULL AS  StyleColorNo,  NULL AS StyleColorName,  NULL AS MainColor ,  NULL AS MaterialID , 
					NULL AS MaterialColorID, a.MainColor AS ColorCode , NULL AS ColorName , NULL AS ColorFolderID ,
					NULL AS  ColorPaletteID ,   
					NULL AS MaterialColorImageID ,  NULL AS MaterialColorImageVersion
					FROM pStyleColorWay a WITH (NOLOCK), pLinefolderItemColor   b WITH (NOLOCK) 
					where b.LineFolderItemId   = @LineFolderItemId
					AND A.StyleId = b.StyleID 
					and a.StyleColorId = b.StyleColorID 
					AND (b.LineFolderItemColorDrop = 0 OR b.LineFolderItemColorDrop IS NULL)	
		
			END 
	
	END
ELSE --@nOption = NULL
	BEGIN 
		-- ALL
		IF @nColorName = 0
			BEGIN
				SELECT  pMaterialColor.ColorFolderID, pMaterialColor.ColorPaletteID, pMaterialColor.ColorCode, pMaterialColor.ColorName, pStyleColorway.StyleColorNo, 
					pStyleColorway.StyleColorName, pMaterialColor.MaterialColorImageID, pMaterialColor.MaterialColorImageVersion
				FROM  pLineFolderItemColor WITH (NOLOCK) INNER JOIN
					pMaterialColor WITH (NOLOCK) INNER JOIN
					pStyleColorwayItem WITH (NOLOCK) ON pMaterialColor.MaterialColorID = pStyleColorwayItem.MaterialColorID INNER JOIN
					pStyleColorway WITH (NOLOCK) ON pStyleColorwayItem.StyleColorID = pStyleColorway.StyleColorID ON 
					pLineFolderItemColor.StyleColorID = pStyleColorway.StyleColorID
				WHERE (pLineFolderItemColor.LineFolderItemID = @LineFolderItemID) 
				ORDER BY pStyleColorway.Sort, pStyleColorway.StyleColorNo, pStyleColorway.StyleColorName
			END	
		ELSE
			BEGIN
				SELECT  pMaterialColor.ColorFolderID, pMaterialColor.ColorPaletteID, pMaterialColor.ColorCode, pMaterialColor.ColorName, pStyleColorway.StyleColorNo, 
					pStyleColorway.StyleColorName, pMaterialColor.MaterialColorImageID ,  pMaterialColor.MaterialColorImageVersion
				FROM pStyleColorwayItem WITH (NOLOCK) INNER JOIN
					pMaterialColor WITH (NOLOCK) ON pStyleColorwayItem.MaterialColorID = pMaterialColor.MaterialColorID INNER JOIN
					pStyleColorway WITH (NOLOCK) ON pStyleColorwayItem.StyleColorID = pStyleColorway.StyleColorID INNER JOIN
					pLineFolderItemColor WITH (NOLOCK) ON pStyleColorway.StyleColorID = pLineFolderItemColor.StyleColorID INNER JOIN
					pStyleMaterials WITH (NOLOCK) ON pStyleColorwayItem.StyleMaterialID = pStyleMaterials.StyleMaterialID
				WHERE (pStyleMaterials.MainMaterial = 1) AND (pLineFolderItemColor.LineFolderItemID = @LineFolderItemID)
				ORDER BY pStyleColorway.Sort, pStyleColorway.StyleColorNo, pStyleColorway.StyleColorName
			END
	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleMaterialPending_Linked_INSERT]'
GO
SET QUOTED_IDENTIFIER OFF
GO



CREATE PROCEDURE [dbo].[spx_StyleMaterialPending_Linked_INSERT]
(
	@StyleMaterialID uniqueidentifier,
	@StyleID uniqueidentifier,
	@StyleSet int,
	@CreatedDate datetime,
	@CreatedBy nvarchar(200)
)

AS 

SET NOCOUNT ON

/************************/
/*Declare variables.	*/
/************************/
DECLARE @StyleMaterialID_Param UNIQUEIDENTIFIER		--Keep a copy of the original parameter value.
DECLARE @StyleID_Param UNIQUEIDENTIFIER				--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT							--Keep a copy of the original parameter value.


DECLARE @StyleLinkID UNIQUEIDENTIFIER
DECLARE @StyleMaterialLinkID UNIQUEIDENTIFIER
DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet
SET @StyleMaterialID_Param = @StyleMaterialID
SET @StyleMaterialLinkID = NEWID()


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	,StyleMaterialID UNIQUEIDENTIFIER
	,StyleMaterialLinkID UNIQUEIDENTIFIER
	)  ON [PRIMARY]


/*
ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
*/


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleMaterialPending_INSERT
			@StyleMaterialID_Param
			,@StyleID_Param
			,@StyleSet_Param
			,@CreatedDate
			,@CreatedBy
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Put a copy of the original Style in the temp table first.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet
			,StyleMaterialID
			,StyleMaterialLinkID)
		SELECT
			@StyleID_Param AS StyleID
			,@StyleLinkID
			,@StyleSet_Param AS StyleSet
			,@StyleMaterialID_Param AS StyleMaterialID
			,@StyleMaterialLinkID 


		/*Get the other Styles that are Multi-Cloth linked to this one.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet
			,StyleMaterialID
			,StyleMaterialLinkID)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet_Param AS StyleSet
			,NEWID() AS StyleMaterialID
			,@StyleMaterialLinkID 
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID
			AND StyleID <> @StyleID_Param
	END


/********************************************************************************************/
/*Loop through the records to add a copy of the system temp Material for the other Styles.	*/
/********************************************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @StyleMaterialID = NULL
		SET @StyleID = NULL
		SET @StyleSet = NULL
		SET @StyleMaterialLinkID = NULL


		/*Get the 'StyleMaterialID' and 'StyleID' for the temp Material copy.*/
		SELECT @StyleMaterialID = StyleMaterialID
			,@StyleID = StyleID
			,@StyleSet = StyleSet
			,@StyleMaterialLinkID = StyleMaterialLinkID 
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Check to make sure that the Style you're looking at is not the original.*/
		IF(@StyleMaterialID <> @StyleMaterialID_Param AND @StyleID <> @StyleID_Param)
			BEGIN
				/*Add a copy of the temp Material to the system temp table, but with the new 'StyleMaterialID' and 'StyleID' values.*/
				INSERT INTO pStyleMaterialTemp(
					[StyleMaterialID]
					,[MainMaterial]
					,[Development]
					,[MiscColor]
					,[StyleSet]
					,[StyleID]
					,[UOM]
					,[Qty]
					,[MaterialPrice]
					,[Ext]
					,[MaterialSize]
					,[MaterialID]
					,[MaterialPlacement]
					,[MaterialPlacementCode]
					,[MaterialPlacementDetail]
					,[MaterialImageID]
					,[MaterialImageVersion]
					,[NoColorMatch]
					,[SupplierID]
					,[ComponentTypeID]
					,[MaterialType]
					,[MaterialNo]
					,[MaterialName]
					,[A]
					,[B]
					,[C]
					,[D]
					,[E]
					,[F]
					,[G]
					,[H]
					,[I]
					,[J]
					,[K]
					,[L]
					,[M]
					,[N]
					,[O]
					,[P]
					,[Q]
					,[R]
					,[S]
					,[T]
					,[U]
					,[V]
					,[W]
					,[X]
					,[Y]
					,[Z]
					,[Source]
					,[Notes]
					,[Placement]
					,[VendorPrice]
					,[VolumePrice]
					,[VolumePriceMinimum]
					,[VendorProductionMin]
					,[VendorProductionLeadTime]
					,[DetailYesNo]
					,[ImageType]
					,[height]
					,[width]
					,[CDate]
					,[CUser]
					,[MDate]
					,[MUser]
					,[MChange]
					,[SChange]
					,[DChange]
					,[CChange]
					,[Action]
					,[ColorPlacement]
					,[Artwork]
					,[License]
					,[Colorway]
					,[MaterialPackLabelGroupID]
					,[TradePartnerID]
					,[TradePartnerVendorID]
					,[MaterialBOM]
					,[MaterialLining]
					,[MaterialLinked]
					,[MaterialTrack]
					,[MaterialDimension]
					,[MaterialSort]
					,[MaterialSizeID]
					,[StyleMaterialLinkID]
				)
				SELECT
					@StyleMaterialID AS [StyleMaterialID]
					,[MainMaterial]
					,[Development]
					,[MiscColor]
					,[StyleSet]
					,@StyleID AS [StyleID]
					,[UOM]
					,[Qty]
					,[MaterialPrice]
					,[Ext]
					,[MaterialSize]
					,[MaterialID]
					,[MaterialPlacement]
					,[MaterialPlacementCode]
					,[MaterialPlacementDetail]
					,[MaterialImageID]
					,[MaterialImageVersion]
					,[NoColorMatch]
					,[SupplierID]
					,[ComponentTypeID]
					,[MaterialType]
					,[MaterialNo]
					,[MaterialName]
					,[A]
					,[B]
					,[C]
					,[D]
					,[E]
					,[F]
					,[G]
					,[H]
					,[I]
					,[J]
					,[K]
					,[L]
					,[M]
					,[N]
					,[O]
					,[P]
					,[Q]
					,[R]
					,[S]
					,[T]
					,[U]
					,[V]
					,[W]
					,[X]
					,[Y]
					,[Z]
					,[Source]
					,[Notes]
					,[Placement]
					,[VendorPrice]
					,[VolumePrice]
					,[VolumePriceMinimum]
					,[VendorProductionMin]
					,[VendorProductionLeadTime]
					,[DetailYesNo]
					,[ImageType]
					,[height]
					,[width]
					,[CDate]
					,[CUser]
					,[MDate]
					,[MUser]
					,[MChange]
					,[SChange]
					,[DChange]
					,[CChange]
					,[Action]
					,[ColorPlacement]
					,[Artwork]
					,[License]
					,[Colorway]
					,[MaterialPackLabelGroupID]
					,[TradePartnerID]
					,[TradePartnerVendorID]
					,[MaterialBOM]
					,[MaterialLining]
					,[MaterialLinked]
					,[MaterialTrack]
					,[MaterialDimension]
					,[MaterialSort]
					,[MaterialSizeID]
					,@StyleMaterialLinkID 
				FROM pStyleMaterialTemp
				WHERE StyleMaterialID = @StyleMaterialID_Param
					AND StyleID = @StyleID_Param
					AND StyleSet = @StyleSet_Param
			END
		ELSE
		BEGIN
			--***
			--** Link original StyleMaterial 
			--***
			UPDATE pStyleMaterialTemp SET StyleMaterialLinkID = @StyleMaterialLinkID 
			WHERE StyleMaterialID = @StyleMaterialID_Param
			AND StyleID = @StyleID_Param
			AND StyleSet = @StyleSet_Param
		
		END 


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @StyleMaterialID = NULL
		SET @StyleID = NULL
		SET @StyleSet = NULL
		SET @StyleMaterialLinkID = NULL


		/*Get the 'StyleID' for the insert.*/
		SELECT @StyleMaterialID = StyleMaterialID
			,@StyleID = StyleID
			,@StyleSet = StyleSet
			,@StyleMaterialLinkID = StyleMaterialLinkID 
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleMaterialPending_INSERT
			@StyleMaterialID
			,@StyleID
			,@StyleSet
			,@CreatedDate
			,@CreatedBy


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

SET NOCOUNT OFF



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_POMTemplateItemTemp_INSERT]'
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[spx_POMTemplateItemTemp_INSERT]
(@POMTempItemID uniqueidentifier)
AS 

BEGIN
	INSERT INTO pPOMTemplateItemTemp
	(POMTempID, POMTempGroupID, POMLibraryID, FitComID, Critical, POM, PointMeasur, HowToMeasurText, HowToMeasurImage, 
	TOL, TOLN, Spec, Grade0, Grade1, Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14, 
	Grade15, Grade16, Grade17, Grade18, Grade19, CDate, CUser, MDate, MUser, Change, Sort) 
	SELECT POMTempID, POMTempGroupID, POMLibraryID, FitComID, Critical, POM, PointMeasur, HowToMeasurText, HowToMeasurImage, 
	TOL, TOLN, Spec, Grade0, Grade1, Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14, 
	Grade15, Grade16, Grade17, Grade18, Grade19, CDate, CUser, MDate, MUser, Change, Sort
	FROM pPOMTemplateItem 
	WHERE POMTempItemId = @POMTempItemID
END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_AccessMaterialFolder_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_User_AccessMaterialFolder_SELECT]
(@teamId uniqueidentifier)
AS 


SELECT pComponentType.ComponentTypeID, pComponentType.ComponentDescription, sAccessMaterialFolder.AccessMaterialId, 
    sAccessMaterialFolder.AccessRoleId, sAccessMaterialFolder.AccessView, sAccessMaterialFolder.AccessCreate, 
    sAccessMaterialFolder.AccessModify, sAccessMaterialFolder.AccessDelete, sAccessMaterialFolder.AccessPrint, 
    sAccessMaterialFolder.TeamId, sAccessMaterialFolder.CUser, sAccessMaterialFolder.CDate, sAccessMaterialFolder.MUser, 
    sAccessMaterialFolder.MDate, pComponentType.ComponentOrder
FROM  pComponentType WITH (NOLOCK) INNER JOIN
    sAccessMaterialFolder WITH (NOLOCK) ON pComponentType.ComponentTypeID = sAccessMaterialFolder.ComponentTypeID
WHERE(sAccessMaterialFolder.TeamId = @teamId)
ORDER BY pComponentType.ComponentOrder



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteItemSharedAgent_SELECT]'
GO


ALTER PROCEDURE [dbo].[spx_StyleQuoteItemSharedAgent_SELECT]
(@StyleId uniqueidentifier, @TradePartnerId uniqueidentifier)
AS 


SELECT  pStyleQuoteItem.StyleQuoteItemID, '(' + CAST(pStyleQuoteItem.StyleQuoteItemNo AS VARCHAR(10)) + ') ' + pStyleQuoteItemStatus.Custom + ': ' + uTradePartnerVendor.VendorName AS StyleQuote, pStyleQuoteItem.StyleID
FROM pStyleQuoteItem WITH (NOLOCK) INNER JOIN
	uTradePartnerVendor WITH (NOLOCK) ON pStyleQuoteItem.TradePartnerVendorID = uTradePartnerVendor.TradePartnerVendorID INNER JOIN
	pStyleQuoteItemStatus WITH (NOLOCK) ON pStyleQuoteItem.StyleQuoteItemStatusId = pStyleQuoteItemStatus.CustomKey
WHERE	(pStyleQuoteItem.TradePartnerID = @TradePartnerId) AND (pStyleQuoteItem.StyleID = @StyleId) AND (pStyleQuoteItem.StyleQuoteItemShare = 1)
ORDER BY StyleQuoteItemNo




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialCoreItemCopy_DELETE]'
GO


CREATE PROCEDURE [dbo].[spx_MaterialCoreItemCopy_DELETE]
(
@MaterialCoreItemID uniqueidentifier,
@MaterialCoreId uniqueidentifier
)
AS 

BEGIN

	BEGIN TRY --Start the Try Block..
		BEGIN TRANSACTION -- Start the transaction..
			DELETE FROM pMaterialCoreColorItem WHERE MaterialCoreColorItemCopyID = @MaterialCoreItemID AND MaterialCoreID = @MaterialCoreId 
			DELETE FROM pMaterialCoreItem WHERE MaterialCoreItemCopyID = @MaterialCoreItemID AND MaterialCoreID = @MaterialCoreId 
		COMMIT TRAN -- Transaction Success!
	END TRY

	BEGIN CATCH
		IF @@TRANCOUNT > 0
		ROLLBACK TRAN --RollBack in case of Error
        DECLARE @ErrorMessage NVARCHAR(4000);
        DECLARE @ErrorSeverity INT;
        DECLARE @ErrorState INT;

        SELECT @ErrorMessage = ERROR_MESSAGE();
        SELECT @ErrorSeverity = ERROR_SEVERITY();
        SELECT @ErrorState = ERROR_STATE();

        RAISERROR (
				   @ErrorMessage, -- Message text.
                   @ErrorSeverity, -- Severity.
                   @ErrorState -- State.
                   );

	END CATCH

END


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanItemColorNew_SELECT]'
GO

/*
Dec 1 2009 - Clayton Parker
Modified the procedure so that the color chips would pull through at create style screen. 
*/


ALTER PROCEDURE [dbo].[spx_LinePlanItemColorNew_SELECT](
@LinePlanID UNIQUEIDENTIFIER,
@LinePlanRangeID UNIQUEIDENTIFIER
)
AS

SELECT pColorPalette.ColorPaletteID, pColorPalette.ColorFolderID, pColorPalette.ColorCode, pColorPalette.ColorName, pColorPalette.ColorSource, pColorPalette.ColorNotes, 
      pColorPalette.Hex, pColorPalette.R, pColorPalette.G, pColorPalette.B, pColorPalette.C, pColorPalette.M, pColorPalette.Y, pColorPalette.K, pColorPalette.H, 
      pColorPalette.S, pColorPalette.L, pColorPalette.LAB_L, pColorPalette.LAB_A, pColorPalette.LAB_B, pColorPalette.CUser, pColorPalette.CDate, pColorPalette.MUser, 
      pColorPalette.MDate, pColorPalette.ColorID, pColorPalette.Change, pColorPalette.Action, pColorPalette.Active, pColorPalette.Sort, pColorPalette.ColorImage, 
      pColorPalette.ColorImageType, pColorPalette.CopyColorPaletteID, pLinePlanColorItem.LinePlanID, pLinePlanColorItem.LinePlanColorItemID, 
      pLinePlanColorItem.LinePlanColorID, pLinePlanColorItem.LinePlanRangeID,
		'<img src="../System/Control/ColorStream.ashx?S=20&CFID=' + CAST(pColorPalette.ColorFolderID AS NVARCHAR(50)) -- #01
		+ '&CPID=' + CAST(pColorPalette.ColorPaletteID AS NVARCHAR(50)) +  '" border="0" />'     -- #01
		AS ColorUrl,	-- #01
	  0 AS StyleColorDelivery1,
	  0 AS StyleColorDelivery2,
	  0 AS StyleColorDelivery3,
	  1 AS StyleColorDelivery4,
	  0 as Units

FROM  pColorPalette INNER JOIN
      pLinePlanColorItem ON pColorPalette.ColorPaletteID = pLinePlanColorItem.ColorPaletteID
WHERE pLinePlanColorItem.LinePlanID = @LinePlanID AND pLinePlanColorItem.LinePlanRangeID IN (SELECT LinePlanRangeID FROM pLinePlanRange WHERE 
        LinePlanFinancialID = '10000000-0000-0000-0000-000000000002' AND
        (ISNULL(CAST(LinePlanAttributeItemID1 AS VARCHAR(40)),'') + ISNULL(CAST(LinePlanAttributeItemID2 AS VARCHAR(40)),'') + ISNULL(CAST(LinePlanAttributeItemID3 AS VARCHAR(40)),'') + ISNULL(CAST(LinePlanAttributeItemID4 AS VARCHAR(40)),'')) IN 
        (SELECT ISNULL(CAST(LinePlanAttributeItemID1 AS VARCHAR(40)),'') + ISNULL(CAST(LinePlanAttributeItemID2 AS VARCHAR(40)),'') + ISNULL(CAST(LinePlanAttributeItemID3 AS VARCHAR(40)),'') + ISNULL(CAST(LinePlanAttributeItemID4 AS VARCHAR(40)),'') 
        FROM pLinePlanRange WHERE LinePlanRangeID = @LinePlanRangeID))
ORDER BY pColorPalette.ColorName





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_LineFolder_Image_4x0_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.  Needed to add the 'Version' field to the temp table for
the image stream and get the 'Version' from 'hImage' to put in the temp table.
*/



ALTER        PROCEDURE [dbo].[rpx_LineFolder_Image_4x0_SELECT]
( 
	@LineFolderID AS varchar(255)
)
AS


CREATE TABLE #tempLineFolderStyles
(
	TableRow int identity(0,1),
	StyleID varchar(50),
	StyleNo varchar(50),
	[Description] nvarchar(255),
	ImageID varchar(50),
	ImageHistoryID varchar(50),
	LineFolderItemDrop varchar(5),
	LineFolderItemDropUser nvarchar(255),
	LineFolderItemDropDate datetime,
	SizeClass nvarchar(50),
	SizeRange nvarchar(50),
	MaterialName nvarchar(100),
	MaterialNo nvarchar(50),
	[Version] int	--Comment #01
)

/*Insert info into temp table.*/
INSERT INTO #tempLineFolderStyles(StyleID, StyleNo, [Description], ImageID, ImageHistoryID,
	LineFolderItemDrop, LineFolderItemDropUser,	LineFolderItemDropDate, SizeClass, SizeRange, MaterialName,
	MaterialNo, [Version])	--Comment #01
SELECT b.StyleID, b.StyleNo, b.[Description], c.ImageID, c.ImageHistoryID,
	a.LineFolderItemDrop, a.LineFolderItemDropUser, a.LineFolderItemDropDate, b.SizeClass, b.SizeRange, d.MaterialName,
	d.MaterialNo, c.[Version]	--Comment #01
FROM pLineFolderItem a INNER JOIN pStyleHeader b ON
a.StyleID = b.StyleID INNER JOIN hImage c ON
b.DesignSketchID = c.ImageID AND b.DesignSketchVersion = c.Version LEFT OUTER JOIN pMaterial d ON
b.MaterialID = d.MaterialID
WHERE LineFolderID = @LineFolderID
ORDER BY a.LineFolderItemSort, b.StyleNo, b.Description


/*Select the information how you want for the report.*/
SELECT
	TableRow % 4 AS [Column],
	StyleID,
	StyleNo,
	[Description],
	dbo.fnx_GetStreamingImagePath(ImageID, [Version]) AS FilePath,	--Comment #01
	@LineFolderID AS LineFolderID,
	LineFolderItemDrop,
	'Dropped By ' + LineFolderItemDropUser + ' - ' + CAST(LineFolderItemDropDate AS varchar(50)) AS DroppedInfo,
	SizeClass,
	SizeRange,
	MaterialName,
	MaterialNo
FROM #tempLineFolderStyles

DROP TABLE #tempLineFolderStyles





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_GetAllColorGroups_Add_SELECT]'
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE PROCEDURE [dbo].[spx_GetAllColorGroups_Add_SELECT]  (
 @StyleID UNIQUEIDENTIFIER,
 @StyleSet int,
 @SeasonYearID NVARCHAR(50)= NULL 
)
AS
BEGIN 

 IF @SeasonYearID IS NOT NULL AND LEN(@SeasonYearID) > 0
  Select * from pColorGroup AS CG where CG.ColorGroupID NOT IN (Select ColorGroupID FROM pStyleColorGroup Where StyleID= @StyleID and StyleSet=@StyleSet and SeasonYearID=@SeasonYearID) AND CG.Active = 1 order by Sort, ColorGroupName  
 ELSE  
  Select * from pColorGroup AS CG where CG.ColorGroupID NOT IN (Select ColorGroupID FROM pStyleColorGroup Where StyleID= @StyleID and StyleSet=@StyleSet) AND CG.Active = 1 order by Sort, ColorGroupName  
  
END 

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[vwx_TradePartner_VendorPrice_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[vwx_TradePartner_VendorPrice_SELECT]
AS 

	SELECT a.*, b.VendorName
	FROM pTradePartnerVendorRate a
	INNER JOIN uTradePartnerVendor b ON a.TradePartnerVendorID = b.TradePartnerVendorID


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_AccessPermissions_UPDATE]'
GO

ALTER PROCEDURE [dbo].[spx_User_AccessPermissions_UPDATE] (
@TeamID uniqueidentifier ,
@FullName as nvarchar (200) ,
@CDate  as DateTime
)
AS


DECLARE @DeskFolderID INT

SET NOCOUNT ON



	/********************************************************************************************************************************************************************/
	-- STYLE FOLDER
	DELETE FROM sAccessStyleFolder where TeamID = @TeamID

	INSERT INTO sAccessStyleFolder (StyleTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,  AccessRemove , AccessDelete , AccessPrint ,TeamId, CUser, CDate, MUser, MDate   )
	SELECT  StyleTypeId , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessRemove ) AS AccessRemove , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId ,
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupStyleFolder 
	WHERE GroupID IN ( 
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 2 
	) 
	GROUP BY StyleTypeId  


	SET @DeskFolderID  =  2
	IF ( SELECT count(*) FROM sAccessStyleFolder WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )
	END
	ELSE

		DELETE FROM  cDeskUserFolderAccess WHERE TeamID =@TeamID and DeskFolderId = @DeskFolderId 




	/********************************************************************************************************************************************************************/
	-- LINEPLAN FOLDER
/*
	DELETE FROM sAccessLinePlanFolder where TeamID = @TeamID   

	INSERT INTO sAccessLinePlanFolder (StyleTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,  AccessRemove , AccessDelete , AccessPrint ,TeamId, CUser, CDate, MUser, MDate   )
	SELECT  StyleTypeId , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessRemove ) AS AccessRemove , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId ,
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupLinePlanFolder   
	WHERE GroupID IN ( 
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 2 
	) 
	GROUP BY StyleTypeId  


	SET @DeskFolderID  =  2
	IF ( SELECT count(*) FROM sAccessLinePlanFolder WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )
	END
	ELSE

		DELETE FROM  cDeskUserFolderAccess WHERE TeamID =@TeamID and DeskFolderId = @DeskFolderId 
*/


	/********************************************************************************************************************************************************************/
	-- LINE FOLDER
	DELETE FROM sAccessLineFolder where TeamID = @TeamID

	INSERT INTO sAccessLineFolder (LineTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
	SELECT  1 as LineTypeId , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupLineFolder 
	WHERE GroupID IN (
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 3
	) 
	GROUP BY LineTypeId

	IF ( SELECT count(*) FROM sAccessLineFolder WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		SET @DeskFolderID  =  3
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

	END 


	/********************************************************************************************************************************************************************/
	-- QUOTATION FOLDER
	DELETE FROM sAccessQuotationFolder  where TeamID = @TeamID

	INSERT INTO sAccessQuotationFolder (StyleTypeID,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
	SELECT  StyleTypeID , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupQuotationFolder 
	WHERE GroupID IN ( 
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 4 
	) 
	GROUP BY StyleTypeID

	IF ( SELECT count(*) FROM sAccessQuotationFolder  WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		SET @DeskFolderID  =  4
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

	END 


	/********************************************************************************************************************************************************************/
	-- SAMPLE FOLDER
	DELETE FROM sAccessSampleFolder  where TeamID = @TeamID

	INSERT INTO sAccessSampleFolder (SampleTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify , AccessRemove,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
	SELECT  SampleTypeId  , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessRemove ) AS AccessRemove , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupSampleFolder 
	WHERE GroupID IN ( 
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 5 
	) 
	GROUP BY SampleTypeId

	IF ( SELECT count(*) FROM sAccessSampleFolder WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		SET @DeskFolderID  =  5
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

	END 


	/********************************************************************************************************************************************************************/
	-- IMAGE FOLDER
	DELETE FROM sAccessImageFolder  where TeamID = @TeamID

	INSERT INTO sAccessImageFolder (ImageTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
	SELECT  ImageTypeId , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupImageFolder 
	WHERE GroupID IN ( 
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 6 
	) 
	GROUP BY ImageTypeId


	IF ( SELECT count(*) FROM sAccessImageFolder  WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		SET @DeskFolderID  =  6
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

	END 


	/********************************************************************************************************************************************************************/
	-- COLOR FOLDER
	DELETE FROM sAccessColorFolder WHERE TeamID = @TeamID

	INSERT INTO sAccessColorFolder (ColorTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
	SELECT  ColorTypeId  , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupColorFolder 
	WHERE GroupID IN ( 
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 7 	
	) 
	GROUP BY ColorTypeId


	IF ( SELECT count(*) FROM sAccessColorFolder  WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		SET @DeskFolderID  =  7
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

	END 

	/********************************************************************************************************************************************************************/
	-- MATERIAL FOLDER
	DELETE FROM sAccessMaterialFolder WHERE TeamID = @TeamID

	INSERT INTO sAccessMaterialFolder (ComponentTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
	SELECT  ComponentTypeId  , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupMaterialFolder 
	WHERE GroupID IN ( 
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 8 
	) 
	GROUP BY ComponentTypeId

	IF ( SELECT count(*) FROM sAccessMaterialFolder  WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		SET @DeskFolderID  =  8
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

	END 


	/********************************************************************************************************************************************************************/
	-- COMPLIANCE FOLDER
	DELETE FROM sAccessComplianceFolder WHERE TeamID = @TeamID

	INSERT INTO sAccessComplianceFolder (ComplianceTypeId ,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
	SELECT  ComplianceTypeId  , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupComplianceFolder 
	WHERE GroupID IN ( 
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 9 
	) 
	GROUP BY ComplianceTypeId


	IF ( SELECT count(*) FROM sAccessComplianceFolder  WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		SET @DeskFolderID  =  9
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

	END 

	/********************************************************************************************************************************************************************/
	-- CONTROL PANEL  FOLDER
	DELETE FROM sAccessControlPanel WHERE TeamID = @TeamID

	INSERT INTO sAccessControlPanel (ControlPanelId ,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
	SELECT  ControlPanelId  , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupControlPanel
	WHERE GroupID IN ( 
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 10 
	) 
	GROUP BY ControlPanelId

	IF ( SELECT count(*) FROM sAccessControlPanel  WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		SET @DeskFolderID  =  10
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

	END 






	/********************************************************************************************************************************************************************/
	-- SHARE FOLDER
	DELETE FROM sAccessShareFolder WHERE TeamID = @TeamID

	INSERT INTO sAccessShareFolder ( ShareTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
	SELECT  1 as ShareTypeId  , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupShareFolder 
	WHERE GroupID IN ( 
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 11 
	) 
	GROUP BY ShareTypeId

	IF ( SELECT count(*) FROM sAccessShareFolder  WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		SET @DeskFolderID  =  11
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

	END 




	/********************************************************************************************************************************************************************/
	-- COSTING 
	DELETE FROM sAccessCosting where TeamID = @TeamID

	INSERT INTO sAccessCosting (StyleTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId, CUser, CDate, MUser, MDate   )
	SELECT  StyleTypeId , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId ,
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupCosting 
	WHERE GroupID IN ( 
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 2 
	) 
	GROUP BY StyleTypeId  


	SET @DeskFolderID  =  12
	IF ( SELECT count(*) FROM sAccessCosting  WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )
	END
	ELSE

		DELETE FROM  cDeskUserFolderAccess WHERE TeamID =@TeamID and DeskFolderId = @DeskFolderId 



	/********************************************************************************************************************************************************************/
	-- LINEPLAN FOLDER / Templates

/*
	DELETE FROM sAccessLinePlanFolder where TeamID = @TeamID

	INSERT INTO sAccessLinePlanFolder (LinePlanTemplateId, CustomID, AccessRoleId , AccessPlanView, AccessPlanNew, AccessPlanDelete ,  AccessHierView, AccessHierNew , AccessHierDelete ,TeamId, CUser, CDate, MUser, MDate   )
	SELECT  LinePlanTemplateId, CustomID, MAX(AccessRoleID ) AS  AccessRoleId  , MAX(AccessPlanView) AS  AccessPlanView,  MAX(AccessPlanNew) AS AccessPlanNew , 
	MAX(AccessPlanDelete) AS AccessPlanDelete, MAX(AccessHierView) AS AccessHierView , MAX(AccessHierNew) AS AccessHierNew, MAX (AccessHierDelete) AS AccessHierDelete, @TeamID AS TeamId ,
	@FullName AS CUser, @CDate AS CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupLinePlanFolder WITH (NOLOCK)
	WHERE GroupID IN ( 
		SELECT  a.GroupID 
		FROM uUserGroup a WITH (NOLOCK), uGroup b WITH (NOLOCK), cDeskGroupFolderAccess c WITH (NOLOCK)
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 2 
	) 
	GROUP BY LinePlanTemplateId, CustomID 

 
	SET @DeskFolderID  =  2
	IF ( SELECT count(*) FROM sAccessLinePlanFolder WITH (NOLOCK) WHERE TeamId = @TeamID ) > 0  
		BEGIN 
			IF ( SELECT Count(*) FROM cDeskUserFolderAccess WITH (NOLOCK) WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
				UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
			ELSE 
				INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
				VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )
		END
	ELSE
		DELETE FROM  cDeskUserFolderAccess WHERE TeamID =@TeamID and DeskFolderId = @DeskFolderId 

*/


/****************************************************************************************************************************************************************************************************************************************/

/*
-- CHECK FOR USER WITHOUT A GROUP 
DECLARE cursor_users2 CURSOR FOR	
SELECT  TeamID from Users  WHERE TeamID not in (  select  DISTINCT TeamID  from uUserGroup ) 


OPEN cursor_users2
FETCH NEXT FROM cursor_users2 INTO @TeamID

WHILE @@FETCH_STATUS = 0 
BEGIN

	DELETE FROM sAccessStyleFolder where TeamID = @TeamID
	DELETE FROM sAccessLineFolder where TeamID = @TeamID
	DELETE FROM sAccessQuotationFolder  where TeamID = @TeamID
	DELETE FROM sAccessSampleFolder  where TeamID = @TeamID
	DELETE FROM sAccessImageFolder  where TeamID = @TeamID
	DELETE FROM sAccessColorFolder WHERE TeamID = @TeamID
	DELETE FROM sAccessMaterialFolder WHERE TeamID = @TeamID
	DELETE FROM sAccessComplianceFolder WHERE TeamID = @TeamID
	DELETE FROM sAccessControlPanel WHERE TeamID = @TeamID
	DELETE FROM sAccessShareFolder WHERE TeamID = @TeamID
	DELETE FROM sAccessCosting WHERE TeamID = @TeamID 


	FETCH NEXT FROM cursor_users2 INTO @TeamID

END 

CLOSE cursor_users2
DEALLOCATE cursor_users2

*/

SET NOCOUNT OFF









GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Country_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_Country_SELECT]
AS SELECT     CountryCode, CountryName
FROM         dbo.uCountry WITH (NOLOCK)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialCoreToStyleMaterialTemp_INSERT]'
GO



ALTER PROCEDURE [dbo].[spx_MaterialCoreToStyleMaterialTemp_INSERT](@MaterialCoreItemID uniqueidentifier,
@Placement nvarchar(4000),
@Artwork int,
@License int,
@Colorway int,
@UOM nvarchar(100),
@Qty nvarchar(50),
@MaterialSize nvarchar(200) ,
@MaterialPrice money,
@StyleID nvarchar(50),
@StyleSet nvarchar(5))
AS 


DECLARE @MaterialSizeID UNIQUEIDENTIFIER 

SELECT @MaterialSizeID = b.MaterialSizeID
FROM pMaterialCoreItem a
INNER JOIN pMaterialSize b ON a.MaterialID = b.MaterialID
WHERE MaterialCoreItemID = @MaterialCoreItemID
AND b.MaterialSize = @MaterialSize


INSERT INTO dbo.pStyleMaterialTemp
                      (MaterialID, MaterialImageID, MaterialImageVersion, NoColorMatch, SupplierID, MaterialType, MaterialNo, MaterialName, A, B, C, D, E, F, G, H, I, J, K, 
                      L, M, N, O, P, Q, R, S, T, U, V, W, X, Y, Z,  Source, Notes, VendorPrice, VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, 
                      MaterialPlacement, DetailYesNo, height, width, MChange, DChange, UOM, Qty, MaterialPrice, Ext, MaterialSize, Placement, Artwork, License, 
                      Colorway, CUser, CDate, MUser, MDate, StyleID, StyleSet, MaterialSizeID )
SELECT     dbo.pMaterial.MaterialID, dbo.pMaterial.MaterialImageID, dbo.pMaterial.MaterialImageVersion, dbo.pMaterial.NoColorMatch, dbo.pMaterial.SupplierID, 
                      dbo.pMaterial.MaterialType, dbo.pMaterial.MaterialNo, dbo.pMaterial.MaterialName, dbo.pMaterial.A, dbo.pMaterial.B, dbo.pMaterial.C, 
                      dbo.pMaterial.D, dbo.pMaterial.E, dbo.pMaterial.F, dbo.pMaterial.G, dbo.pMaterial.H, dbo.pMaterial.I, dbo.pMaterial.J, dbo.pMaterial.K, dbo.pMaterial.L, 
                      dbo.pMaterial.M, dbo.pMaterial.N, dbo.pMaterial.O, dbo.pMaterial.P, dbo.pMaterial.Q, dbo.pMaterial.R, dbo.pMaterial.S, 
	         dbo.pMaterial.T, dbo.pMaterial.U, dbo.pMaterial.V, dbo.pMaterial.W, dbo.pMaterial.X, dbo.pMaterial.Y, dbo.pMaterial.Z, dbo.pMaterial.Source, 
                      dbo.pMaterial.Notes, dbo.pMaterial.VendorPrice, dbo.pMaterial.VolumePrice, dbo.pMaterial.VolumePriceMinimum, dbo.pMaterial.VendorProductionMin, 
                      dbo.pMaterial.VendorProductionLeadTime, dbo.pMaterial.MaterialPlacement, dbo.pMaterial.DetailYesNo, dbo.pMaterial.height, dbo.pMaterial.width, 
                      dbo.pMaterial.MChange, dbo.pMaterial.DChange, @UOM, @Qty, @MaterialPrice, dbo.pMaterialCoreItem.Ext, @MaterialSize, @Placement, @Artwork, 
                      @License, @Colorway, dbo.pMaterialCoreItem.CUser, dbo.pMaterialCoreItem.CDate, dbo.pMaterialCoreItem.MUser, dbo.pMaterialCoreItem.MDate, 
                      @StyleID, @StyleSet, @MaterialSizeID
FROM         dbo.pMaterial WITH (NOLOCK) INNER JOIN
                      dbo.pMaterialCoreItem WITH (NOLOCK) ON dbo.pMaterial.MaterialID = dbo.pMaterialCoreItem.MaterialID
WHERE     (dbo.pMaterialCoreItem.MaterialCoreItemID = @MaterialCoreItemID)









GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_SampleRequestSubmit_HowToMeasure_SELECT]'
GO



/*
Comments:

#01 - Ryan Cabanas - September 25, 2009
	Replace the old pom image string with the new image string using function.
Deleted old code.
*/




ALTER	PROCEDURE [dbo].[rpx_SampleRequestSubmit_HowToMeasure_SELECT]
(
	@SampleRequestSubmitID varchar(50)
)
AS


DECLARE @SampleRequestTradeID varchar(50)
DECLARE @SampleWorkflowID nvarchar(5)
DECLARE @StyleSet int 
DECLARE @Submit int
DECLARE @StyleID varchar(50)

/*Get the remaining variables needed.*/
SELECT
	@SampleRequestTradeID = SampleRequestTradeID,
	@SampleWorkflowID = SampleWorkflowID,
	@StyleSet = StyleSet,
	@Submit = Submit,
	@StyleID = StyleID
FROM pSampleRequestSubmit
WHERE SampleRequestSubmitID = @SampleRequestSubmitID

/*Creat temporary table*/
CREATE       TABLE #TempHowTo
(
	RowNumber int identity(0,1),
	POM nvarchar(5),
	PointMeasur nvarchar(200),
	HowToMeasurText nvarchar(4000),
	FilePath nvarchar(255),
	Sort nvarchar(5)
)


/*Insert values into the temporary table*/
INSERT INTO #TempHowTo(POM, PointMeasur, HowToMeasurText, FilePath, Sort)
SELECT	pSampleRequestSpecItem.POM,
	pSampleRequestSpecItem.PointMeasur,
	pPOMLibrary.HowToMeasurText,
	dbo.fnx_GetStreamingPOMImageSmallPath(pPOMLibrary.POMLibraryID) AS FilePath,	--Comment #01
	pSampleRequestSpecItem.Sort
FROM	pSampleRequestSpecItem INNER JOIN pPOMLibrary ON
	pSampleRequestSpecItem.POM = pPOMLibrary.POM
WHERE	(pSampleRequestSpecItem.StyleID = @StyleID) AND
	(pSampleRequestSpecItem.SampleRequestTradeID = @SampleRequestTradeID) AND
	(pSampleRequestSpecItem.SampleWorkflowID = @SampleWorkflowID) AND
	(pSampleRequestSpecItem.Submit = @Submit) AND
	(pSampleRequestSpecItem.Ask <>0) AND
	(pSampleRequestSpecItem.StyleSet = @StyleSet)
ORDER BY	pSampleRequestSpecItem.Sort

/*Select the temporary table*/
SELECT	Sort, RowNumber % 3 AS Columns, POM, PointMeasur, HowToMeasurText, FilePath
FROM	#TempHowTo
ORDER BY Sort, Columns DESC

DROP TABLE #TempHowTo






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlan_Hierarchies_Logic_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_LinePlan_Hierarchies_Logic_SELECT] (
@StyleID UNIQUEIDENTIFIER 
)
AS 

DECLARE @LinePlanItemID  UNIQUEIDENTIFIER 

IF ( SELECT COUNT(*) FROM pStyleSeasonYear WHERE StyleID = @StyleID AND LinePlanItemID IS NOT NULL)= 1
BEGIN

	SELECT @LinePlanItemID = LinePlanItemID  FROM pStyleSeasonyear a
	WHERE a.StyleID = @StyleID 
	
		
	IF @LinePlanItemID  IS NOT NULL
	BEGIN
	
		/***
		*** Style is in a lineplan 
		***/
		DECLARE @LinePlanID UNIQUEIDENTIFIER 
		DECLARE @LinePlanRangeID UNIQUEIDENTIFIER 

	

		SELECT @LinePlanRangeID = a.LinePlanRangeID, @LinePlanID = a.LinePlanID
		FROM pLinePlanItem a
		WHERE a.LinePlanItemID = @LinePlanItemID 
		
		SELECT DISTINCT b.LinePlanAttributeText1 + ' / ' + b.LinePlanAttributeText2 + ' / '  + b.LinePlanAttributeText3 AS Hierarchy,
		b.LinePlanRangeID 
		FROM pLinePlanItem a
		INNER JOIN pLinePlanRange b ON a.LinePlanRangeID =  b.LinePlanRangeID 
		WHERE a.LinePlanID = @LinePlanID 
		AND a.LinePlanRangeID <>  @LinePlanRangeID 
		AND a.StyleID = '00000000-0000-0000-0000-000000000000'
		AND a.LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003'
		ORDER BY b.LinePlanAttributeText1 + ' / ' + b.LinePlanAttributeText2 + ' / '  + b.LinePlanAttributeText3 
		
			
				

	END 
	ELSE 
		SELECT NULL AS  Hierarchy, NULL AS LinePlanRangeID
END 
ELSE 
	SELECT NULL AS  Hierarchy, NULL AS LinePlanRangeID







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[_pStyleHeader]'
GO
EXEC sp_refreshview N'[dbo].[_pStyleHeader]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[vwx_StyleMaterialWhere_SELECT]'
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE VIEW [dbo].[vwx_StyleMaterialWhere_SELECT]
AS 

SELECT a.StyleSeasonYearID, b.StyleNo, b.Description, b.SizeClass, b.SizeRange   
FROM pStyleSeasonYear a 
INNER JOIN  pStyleHeader b ON a.StyleID  = b.StyleID 

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[vwx_LinePlanShowroomStyle_SEL]'
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW dbo.vwx_LinePlanShowroomStyle_SEL
AS
SELECT DISTINCT 
                      a.StyleID, a.LinePlanRangeID, d.StyleNo, d.Description, 
                      '<img src=''../System/Control/ImageStream.ashx?S=50&V=' + CAST(ISNULL(d.DesignSketchVersion, 0) AS NVARCHAR(50)) 
                      + '&IID=' + CAST(ISNULL(d.DesignSketchID, '00000000-0000-0000-0000-000000000000') AS NVARCHAR(50)) + '''  />' AS StyleImagePath, d.MaterialNo, 
                      d.MaterialName, d.MaterialID, e.MaterialCode, d.CustomField14
FROM         dbo.pLinePlanItem AS a INNER JOIN
                      dbo.pStyleSeasonYear AS b ON a.StyleID = b.StyleID AND a.LinePlanItemID = b.LinePlanItemID INNER JOIN
                      dbo.pStyleColorwaySeasonYear AS c ON b.StyleSeasonYearID = c.StyleSeasonYearID INNER JOIN
                      dbo.pStyleHeader AS d ON d.StyleID = a.StyleID LEFT OUTER JOIN
                      dbo.pStyleMaterials AS e ON e.StyleID = d.StyleID AND e.MainMaterial = 1
WHERE     (a.StyleID <> '00000000-0000-0000-0000-000000000000') AND (c.SampleStatus = 200) OR
                      (c.SampleStatus = 300)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_AccessQuotationFolder_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_User_AccessQuotationFolder_SELECT]
(@teamId uniqueidentifier)
AS 


SELECT pStyleType.StyleTypeID, pStyleType.StyleTypeDescription, 
	sAccessQuotationFolder.AccessQuotationID, 
	sAccessQuotationFolder.AccessRoleID, sAccessQuotationFolder.AccessView, sAccessQuotationFolder.AccessCreate, 
	sAccessQuotationFolder.AccessModify, sAccessQuotationFolder.AccessDelete, sAccessQuotationFolder.AccessPrint, 
	sAccessQuotationFolder.TeamID, sAccessQuotationFolder.CUser, sAccessQuotationFolder.CDate, sAccessQuotationFolder.MUser, 
	sAccessQuotationFolder.MDate, pStyleType.StyleTypeOrder
FROM  pStyleType WITH (NOLOCK) INNER JOIN
    sAccessQuotationFolder WITH (NOLOCK) ON pStyleType.StyleTypeID = sAccessQuotationFolder.StyleTypeID
WHERE sAccessQuotationFolder.TeamId = @teamId
ORDER BY pStyleType.StyleTypeOrder



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteItemVendor_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_StyleQuoteItemVendor_SELECT]
(@StyleQuoteId uniqueidentifier,
@TradePartnerID uniqueidentifier,
@StyleQuoteVariationId uniqueidentifier)
AS 
SELECT     dbo.pStyleQuoteItem.StyleQuoteItemID, dbo.pStyleQuoteItem.StyleQuoteItemNo, dbo.pStyleQuoteItem.StyleQuoteItemStatusId, 
        dbo.pStyleQuoteItem.StyleQuoteID, dbo.pStyleQuoteItem.StyleDevelopmentID, dbo.pStyleQuoteItem.StyleID, 
        dbo.pStyleQuoteItem.StyleQuoteTradePartnerID, dbo.pStyleQuoteItem.StyleCostingID, dbo.pStyleQuoteItem.TradePartnerID, 
        dbo.pStyleQuoteItem.TradePartnerVendorID, dbo.uTradePartnerVendor.VendorCode, dbo.uTradePartnerVendor.VendorName, 
        dbo.pStyleCostingType.StyleCostingType, dbo.pStyleCostingType.StyleCostingSchema, dbo.pStyleCostingType.StyleQuoteSchema, 
        dbo.pStyleCostingType.StyleQuoteVendorSchema, dbo.pStyleQuoteItem.StyleCostingType AS Expr1, dbo.pStyleQuoteItem.StyleCostingFreightTypeID, 
        dbo.pStyleCostingType.StyleQuoteVendorSummarySchema, dbo.pStyleCostingType.StyleQuoteSummarySchema, 
        dbo.pStyleQuoteItem.StyleQuoteVariationId
FROM         dbo.pStyleQuoteItem WITH (NOLOCK) INNER JOIN
        dbo.uTradePartnerVendor WITH (NOLOCK) ON dbo.pStyleQuoteItem.TradePartnerVendorID = dbo.uTradePartnerVendor.TradePartnerVendorID INNER JOIN
        dbo.pStyleCostingType WITH (NOLOCK) ON dbo.pStyleQuoteItem.StyleCostingType = dbo.pStyleCostingType.StyleCostingTypeID
WHERE     (dbo.pStyleQuoteItem.StyleQuoteID = @StyleQuoteId) AND (dbo.pStyleQuoteItem.TradePartnerID = @TradePartnerID) 
		AND (dbo.pStyleQuoteItem.StyleQuoteVariationId = @StyleQuoteVariationId)
ORDER BY dbo.uTradePartnerVendor.VendorName



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialCoreToStyleMaterialTempLogic_INSERT]'
GO


CREATE PROCEDURE dbo.spx_MaterialCoreToStyleMaterialTempLogic_INSERT(
@StyleID NVARCHAR(50),
@StyleSet INT,
@MaterialCoreItemID UNIQUEIDENTIFIER ,
@Params NVARCHAR(4000),
@CUser NVARCHAR(200) ,
@CDate DATETIME
)
AS 


DECLARE @StyleMaterialID UNIQUEIDENTIFIER 
SET @StyleMaterialID  = NEWID()


INSERT INTO dbo.pStyleMaterialTemp(
StyleMaterialID, MaterialID, MaterialImageID, MaterialImageVersion, NoColorMatch, SupplierID, MaterialType, MaterialNo, MaterialName, A, B, C, D, E, F, G, H, I, J, K, 
L, M, N, O, P, Q, R, S, T, U, V, W, X, Y, Z,  Source, Notes, VendorPrice, VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, 
MaterialPlacement, DetailYesNo, height, width, MChange, DChange, Ext, StyleID, StyleSet,
CUser, CDate, MUser, MDate
--, UOM, Qty, MaterialPrice, MaterialSize, Placement, Artwork, License, Colorway,  MaterialSizeID 
)

SELECT     
@StyleMaterialID AS StyleMaterialID, dbo.pMaterial.MaterialID, dbo.pMaterial.MaterialImageID, dbo.pMaterial.MaterialImageVersion, dbo.pMaterial.NoColorMatch, dbo.pMaterial.SupplierID, 
dbo.pMaterial.MaterialType, dbo.pMaterial.MaterialNo, dbo.pMaterial.MaterialName, dbo.pMaterial.A, dbo.pMaterial.B, dbo.pMaterial.C, 
dbo.pMaterial.D, dbo.pMaterial.E, dbo.pMaterial.F, dbo.pMaterial.G, dbo.pMaterial.H, dbo.pMaterial.I, dbo.pMaterial.J, dbo.pMaterial.K, dbo.pMaterial.L, 
dbo.pMaterial.M, dbo.pMaterial.N, dbo.pMaterial.O, dbo.pMaterial.P, dbo.pMaterial.Q, dbo.pMaterial.R, dbo.pMaterial.S, 
dbo.pMaterial.T, dbo.pMaterial.U, dbo.pMaterial.V, dbo.pMaterial.W, dbo.pMaterial.X, dbo.pMaterial.Y, dbo.pMaterial.Z, dbo.pMaterial.Source, 
dbo.pMaterial.Notes, dbo.pMaterial.VendorPrice, dbo.pMaterial.VolumePrice, dbo.pMaterial.VolumePriceMinimum, dbo.pMaterial.VendorProductionMin, 
dbo.pMaterial.VendorProductionLeadTime, dbo.pMaterial.MaterialPlacement, dbo.pMaterial.DetailYesNo, dbo.pMaterial.height, dbo.pMaterial.width, 
dbo.pMaterial.MChange, dbo.pMaterial.DChange, dbo.pMaterialCoreItem.Ext, @StyleID, @StyleSet,
dbo.pMaterialCoreItem.CUser, dbo.pMaterialCoreItem.CDate, dbo.pMaterialCoreItem.MUser, dbo.pMaterialCoreItem.MDate

--,@UOM, @Qty, @MaterialPrice, @MaterialSize, @Placement, @Artwork, @License, @Colorway, @MaterialSizeID

FROM         dbo.pMaterial WITH (NOLOCK) INNER JOIN
                      dbo.pMaterialCoreItem WITH (NOLOCK) ON dbo.pMaterial.MaterialID = dbo.pMaterialCoreItem.MaterialID
WHERE     (dbo.pMaterialCoreItem.MaterialCoreItemID = @MaterialCoreItemID)

DECLARE @SQL NVARCHAR(4000)
SET @SQL  = 'UPDATE pStyleMaterialTemp SET ' + @Params + ' WHERE StyleMaterialID = ''' +  CAST(@StyleMaterialID AS NVARCHAR(50)) + ''''
EXEC (@SQL)


/**
** UPDATE MaterialSizeID
**/
DECLARE @MaterialSizeID UNIQUEIDENTIFIER 
DECLARE @MaterialSize NVARCHAR(200)

SELECT @MaterialSize = MaterialSize FROM pStyleMaterialTemp WHERE  StyleMaterialID = @StyleMaterialID

SELECT @MaterialSizeID = b.MaterialSizeID
FROM pMaterialCoreItem a
INNER JOIN pMaterialSize b ON a.MaterialID = b.MaterialID
WHERE MaterialCoreItemID = @MaterialCoreItemID
AND b.MaterialSize = @MaterialSize

UPDATE pStyleMaterialTemp SET MaterialSizeID = @MaterialSizeID 
WHERE StyleMaterialID = @StyleMaterialID









GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlan_ItemsCount_SELECT]'
GO
CREATE PROCEDURE dbo.spx_LinePlan_ItemsCount_SELECT (
@LinePlanID UNIQUEIDENTIFIER  
)
AS 

	SELECT COUNT(*) FROM pLinePlanItem 
	WHERE LinePlanID = @LinePlanID 
	AND StyleID <>  '00000000-0000-0000-0000-000000000000'




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_Style_Status_SELECT]'
GO
CREATE PROCEDURE dbo.spx_Style_Status_SELECT (
@StyleID UNIQUEIDENTIFIER 
)
AS

	SELECT StatusID ,Status FROM pStyleColorwayStatus




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_AccessSampleFolder_SELECT]'
GO



ALTER PROCEDURE [dbo].[spx_User_AccessSampleFolder_SELECT]
(@teamId uniqueidentifier)
AS 



/*
SELECT 1 AS SampleTypeID, 'Sample Folder' AS SampleFolder,  AccessSampleId,  AccessRoleId,  AccessView, AccessCreate, 
    AccessModify, AccessDelete, AccessPrint,  TeamId,  CUser,  CDate, MUser,  MDate  
FROM  sAccessSampleFolder WITH (NOLOCK) 
WHERE TeamId = @teamId
*/

	Select pSampleWorkflow.SampleWorkflowID as SampleTypeID ,  pSampleWorkflow.SampleWorkflow as SampleTypeDescription ,
	sAccessSampleFolder.AccessSampleId, 
		sAccessSampleFolder.AccessRoleId, sAccessSampleFolder.AccessView, sAccessSampleFolder.AccessCreate, 
		sAccessSampleFolder.AccessModify, sAccessSampleFolder.AccessDelete, sAccessSampleFolder.AccessPrint, 
		sAccessSampleFolder.TeamId, sAccessSampleFolder.CUser, sAccessSampleFolder.CDate, sAccessSampleFolder.MUser, 
		sAccessSampleFolder.MDate , pSampleWorkflow.SampleWorkflowSort
	FROM  pSampleWorkflow WITH (NOLOCK) INNER JOIN
	    sAccessSampleFolder WITH (NOLOCK) ON pSampleWorkflow.SampleWorkflowID = sAccessSampleFolder.SampleTypeID
	WHERE sAccessSampleFolder.TeamId = @teamId
	ORDER BY pSampleWorkflow.SampleWorkflowSort



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_DeskSide_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_DeskSide_SELECT]
(@TeamId uniqueidentifier)
AS 

if not exists (select * from dbo.sysobjects where id = object_id(N'#DeskSide') and OBJECTPROPERTY(id, N'IsUserTable') = 1)
BEGIN
CREATE TABLE #DeskSide (
	[DeskSideID] [int] NOT NULL ,
	[DeskFolderId] [int] NULL ,
	[DeskSideName] [varchar] (200) NULL ,
	[DeskSideDescription] [varchar] (2000) NULL ,
	[DeskSideWindow] [varchar] (200) NULL ,
	[DeskSideURL] [varchar] (50) NULL ,
	[DeskSideIcon] [varchar] (50) NULL ,
	[DeskSideSort] [varchar] (4) NULL ,
	[DeskSideActive] [int] NOT NULL 
) ON [PRIMARY]
END

BEGIN
	INSERT INTO #DeskSide
	(DeskSideID, DeskFolderId, DeskSideName, DeskSideDescription, DeskSideWindow, DeskSideURL, DeskSideIcon, DeskSideSort, DeskSideActive)
	SELECT DeskSideID, DeskFolderId, DeskSideName, DeskSideDescription, DeskSideWindow, DeskSideURL, DeskSideIcon, DeskSideSort, DeskSideActive
	FROM  cDeskSide WITH (NOLOCK)
	WHERE (DeskSideActive = 1) AND (DeskFolderId IN (SELECT DeskFolderId FROM cDeskUserFolderAccess WITH (NOLOCK) WHERE TeamId = @TeamId AND DeskAccessId = 1))
END

IF (SELECT COUNT(*) FROM Users WITH (NOLOCK) WHERE TeamId = @TeamId AND Admin = 1) = 1
BEGIN
	INSERT INTO #DeskSide
	(DeskSideID, DeskFolderId, DeskSideName, DeskSideDescription, DeskSideWindow, DeskSideURL, DeskSideIcon, DeskSideSort, DeskSideActive)
	SELECT TOP 1 DeskSideID, DeskFolderId, DeskSideName, DeskSideDescription, DeskSideWindow, DeskSideURL, DeskSideIcon, DeskSideSort, DeskSideActive
	FROM  cDeskSide WITH (NOLOCK)
	WHERE (DeskSideActive = 1) AND (DeskFolderId = 100)
END

SELECT DeskSideID, DeskFolderId, DeskSideName, DeskSideDescription, DeskSideWindow, DeskSideURL, DeskSideIcon, DeskSideSort, DeskSideActive
FROM #DeskSide



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteLogic_UPDATE]'
GO

ALTER PROCEDURE [dbo].[spx_StyleQuoteLogic_UPDATE]
(
@StyleQuoteID uniqueidentifier,
@ModifiedBy nvarchar(200),
@ModifiedDate datetime
)
AS 

DECLARE @StyleQuoteDueDate datetime

SELECT @StyleQuoteDueDate = StyleQuoteDueDate FROM pStyleQuote WITH (NOLOCK) WHERE StyleQuoteID = @StyleQuoteID  

UPDATE pStyleQuoteItem SET StyleQuoteItemDueDate = @StyleQuoteDueDate
WHERE  (StyleQuoteID = @StyleQuoteID) AND (StyleQuoteItemDueDate IS NULL)







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialDocument_SELECT]'
GO

create PROCEDURE [dbo].[spx_MaterialDocument_SELECT]
(	
	@MaterialID uniqueidentifier,
	@MaterialRequest int
)
AS 

IF @MaterialRequest = 1
	BEGIN
		SELECT MaterialDocumentID, MaterialID, MaterialDocumentName, 
			MaterialDocumentDescription, MaterialDocumentExt, MaterialDocumentSize, 
			MaterialDocumentShared, CUser, CDate, MUser, MDate, MChange, 
			SystemServerStorageID
		FROM pMaterialDocument 
		WHERE MaterialID = @MaterialID AND MaterialDocumentShared = @MaterialRequest
	END
ELSE
	BEGIN
		SELECT MaterialDocumentID, MaterialID, MaterialDocumentName, 
			MaterialDocumentDescription, MaterialDocumentExt, MaterialDocumentSize, 
			MaterialDocumentShared, CUser, CDate, MUser, MDate, MChange, 
			SystemServerStorageID
		FROM pMaterialDocument 
		WHERE MaterialID = @MaterialID 
	END

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlan_ListGrid_SELECT]'
GO

CREATE PROCEDURE dbo.spx_LinePlan_ListGrid_SELECT (
@TeamID UNIQUEIDENTIFIER,
@Filter NVARCHAR(4000),
@Sort NVARCHAR(4000)
)
AS 


SELECT * INTO #tmp FROM  pLinePlan
WHERE LinePlanTemplateID  in ( 
	SELECT DISTINCT LinePlanTemplateID  FROM  dbo.sAccessGroupLinePlanFolder
	WHERE (AccessRoleID = 3 OR AccessPlanView = 1 OR AccessHierView = 1  )
	AND GroupID IN (
		SELECT GroupID FROM dbo.uUserGroup WHERE TeamID = @TeamID
	)
)


DECLARE @SQL NVARCHAR(4000) 
SET @SQL  = 'SELECT  * FROM  #tmp '

IF LEN (@Filter)  >  0 
	SET @SQL  = @SQL   + ' WHERE ' + @Filter

IF LEN (@Sort)  >  0 
	SET @SQL  = @SQL   + ' ORDER BY ' + @Sort


EXEC ( @SQL) 

DROP TABLE #tmp 







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[vwx_LineList_Style_Search_SEL]'
GO
SET QUOTED_IDENTIFIER OFF
GO


/*
Comments:

General - Ryan Cabanas - April 6, 2010
	View for Style searching at the line list.  Loosely based off of the 'vwx_Style_Search_SEL' view.
*/

CREATE VIEW [dbo].[vwx_LineList_Style_Search_SEL]
AS
SELECT     dbo.pStyleHeader.StyleID, dbo.pStyleHeader.StyleMasterID, dbo.pStyleHeader.StyleWorkflowID, dbo.pStyleHeader.StyleType, 
                      dbo.pStyleHeader.WorkflowType, dbo.pStyleHeader.RefNo, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.TempID, dbo.pStyleHeader.TempNo, 
                      dbo.pStyleHeader.CustomerNo, dbo.pStyleHeader.DevelopmentID, dbo.pStyleHeader.DevelopmentNo, dbo.pStyleHeader.ConceptID, 
                      dbo.pStyleHeader.ConceptNo, dbo.pStyleHeader.SpecNo, dbo.pStyleHeader.Description, dbo.pStyleHeader.StyleCategory, 
                      dbo.pStyleHeader.SizeClass, dbo.pStyleHeader.SizeRange, dbo.pStyleHeader.StyleSet, dbo.pStyleHeader.TechPackId, 
                      dbo.pStyleHeader.TechPackDate, dbo.pStyleHeader.DueDate, dbo.pStyleHeader.RecDate, dbo.pStyleHeader.Customer, dbo.pStyleHeader.Buyer, 
                      dbo.pStyleHeader.Designer, dbo.pStyleHeader.SampleMaker, dbo.pStyleHeader.PatternMaker, dbo.pStyleHeader.ProductionManager, 
                      dbo.pStyleHeader.TechnicalDesigner, dbo.pStyleHeader.StyleStatus, dbo.pStyleHeader.StyleLocation, dbo.pStyleHeader.WashType, 
                      dbo.pStyleHeader.Pitch, dbo.pStyleHeader.MaterialID, dbo.pStyleHeader.MaterialImageID, dbo.pStyleHeader.MaterialImageVersion, 
                      dbo.pStyleHeader.MaterialNo, dbo.pStyleHeader.MaterialName, dbo.pStyleHeader.POMTempGroupID1, dbo.pStyleHeader.POMTempGroupID2, 
                      dbo.pStyleHeader.POMTempGroupID3, dbo.pStyleHeader.POMTempGroupID4, dbo.pStyleHeader.POMTempID1, dbo.pStyleHeader.POMTempVersion1, 
                      dbo.pStyleHeader.POMTempSizeClass1, dbo.pStyleHeader.POMTempID2, dbo.pStyleHeader.POMTempVersion2, 
                      dbo.pStyleHeader.POMTempSizeClass2, dbo.pStyleHeader.POMTempID3, dbo.pStyleHeader.POMTempVersion3, 
                      dbo.pStyleHeader.POMTempSizeClass3, dbo.pStyleHeader.POMTempID4, dbo.pStyleHeader.POMTempVersion4, 
                      dbo.pStyleHeader.POMTempSizeClass4, dbo.pStyleHeader.StyleMaterialID, dbo.pStyleHeader.DesignSketchID, dbo.pStyleHeader.TechSketchID, 
                      dbo.pStyleHeader.ConceptSketchID, dbo.pStyleHeader.ColorSketchID, dbo.pStyleHeader.DesignSketchVersion, dbo.pStyleHeader.TechSketchVersion, 
                      dbo.pStyleHeader.ConceptSketchVersion, dbo.pStyleHeader.ColorSketchVersion, dbo.pStyleHeader.DetailSketchID1, 
                      dbo.pStyleHeader.DetailSketchID2, dbo.pStyleHeader.DetailSketchID3, dbo.pStyleHeader.DetailSketchID4, dbo.pStyleHeader.DetailSketchVersion1, 
                      dbo.pStyleHeader.DetailSketchVersion2, dbo.pStyleHeader.DetailSketchVersion3, dbo.pStyleHeader.DetailSketchVersion4, 
                      dbo.pStyleHeader.SpecSketchID1, dbo.pStyleHeader.SpecSketchID2, dbo.pStyleHeader.SpecSketchID3, dbo.pStyleHeader.SpecSketchID4, 
                      dbo.pStyleHeader.SpecSketchVersion1, dbo.pStyleHeader.SpecSketchVersion2, dbo.pStyleHeader.SpecSketchVersion3, 
                      dbo.pStyleHeader.SpecSketchVersion4, dbo.pStyleHeader.Markup, dbo.pStyleHeader.TargetPrice, dbo.pStyleHeader.SellingPrice, 
                      dbo.pStyleHeader.CustomField1, dbo.pStyleHeader.CustomField2, dbo.pStyleHeader.CustomField3, dbo.pStyleHeader.CustomField4, 
                      dbo.pStyleHeader.CustomField5, dbo.pStyleHeader.CustomField6, dbo.pStyleHeader.CustomField7, dbo.pStyleHeader.CustomField8, 
                      dbo.pStyleHeader.CustomField9, dbo.pStyleHeader.CustomField10, dbo.pStyleHeader.CustomField11, dbo.pStyleHeader.CustomField12, 
                      dbo.pStyleHeader.CustomField13, dbo.pStyleHeader.CustomField14, dbo.pStyleHeader.CustomField15, dbo.pStyleHeader.Pc1, dbo.pStyleHeader.Pc2, 
                      dbo.pStyleHeader.Pc3, dbo.pStyleHeader.Pc4, dbo.pStyleHeader.CUser, dbo.pStyleHeader.CDate, dbo.pStyleHeader.MUser, dbo.pStyleHeader.MDate, 
                      dbo.pStyleHeader.Active, dbo.pStyleHeader.Change, dbo.pStyleHeader.Action, dbo.pStyleHeader.NoColorCombo, dbo.pStyleHeader.StyleVersion, 
                      dbo.pStyleHeader.StyleDetail, dbo.pStyleHeader.StyleDetail1, dbo.pStyleHeader.StyleAttribute, dbo.pStyleHeader.StyleDetail2, 
                      dbo.pStyleHeader.LinePlanSketchID, dbo.pStyleHeader.LinePlanSketchVersion, dbo.pStyleHeader.LinePlanID, dbo.pStyleHeader.LinePlanNo, 
                      dbo.pStyleHeader.CustomField16, dbo.pStyleHeader.CustomField17, dbo.pStyleHeader.CustomField18, dbo.pStyleHeader.CustomField19, 
                      dbo.pStyleHeader.CustomField20, dbo.pStyleHeader.CustomField21, dbo.pStyleHeader.CustomField22, dbo.pStyleHeader.CustomField23, 
                      dbo.pStyleHeader.CustomField24, dbo.pStyleHeader.CustomField25, dbo.pStyleHeader.CustomField26, dbo.pStyleHeader.CustomField27, 
                      dbo.pStyleHeader.CustomField28, dbo.pStyleHeader.CustomField29, dbo.pStyleHeader.CustomField30, dbo.pStyleHeader.PackagingNo, 
                      dbo.pStyleHeader.StyleCopyID, dbo.pStyleHeader.LinePlanItemID, dbo.pStyleHeader.StyleStatusID, dbo.pStyleMaterials.F AS FabricType, 
                      dbo.pStyleMaterials.H AS FabricContent, dbo.pStyleSeasonYear.StyleSeason, dbo.pStyleSeasonYear.StyleYear, 
                      dbo.pStyleSeasonYear.SeasonYearID, dbo.pStyleSeasonYear.StyleSeasonYearID
FROM         dbo.pStyleHeader INNER JOIN
                      dbo.pStyleSeasonYear ON dbo.pStyleHeader.StyleID = dbo.pStyleSeasonYear.StyleID LEFT OUTER JOIN
                      dbo.pStyleMaterials ON dbo.pStyleHeader.StyleMaterialID = dbo.pStyleMaterials.StyleMaterialID
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vmx_Control_ExchangeRateItem]'
GO
EXEC sp_refreshview N'[dbo].[vmx_Control_ExchangeRateItem]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleDevelopmentPOMItemSortAllClasses_Linked_UPDATE]'
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[spx_StyleDevelopmentPOMItemSortAllClasses_Linked_UPDATE]
(
	@StyleId uniqueidentifier,
	@StyleSet int
)

AS 


/************************/
/*Declare variables.	*/
/************************/
DECLARE @StyleID_Param UNIQUEIDENTIFIER			--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT						--Keep a copy of the original parameter value.

DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleDevelopmentPOMItemSortAllClasses_UPDATE
			@StyleID_Param
			,@StyleSet_Param
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet_Param AS StyleSet
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID
	END

/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Get the 'StyleID' for the update.*/
		SELECT @StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleDevelopmentPOMItemSortAllClasses_UPDATE
			@StyleID
			,@StyleSet


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_DesktopAccessColorFolderCheck_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_User_DesktopAccessColorFolderCheck_INSERT]
(
@TeamId uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

IF (SELECT COUNT(*) FROM sAccessColorFolder WITH (NOLOCK) WHERE ColorTypeId = 1 AND TeamId = @TeamId) = 0
	BEGIN
		INSERT INTO sAccessColorFolder
			(ColorTypeId, TeamId, CUser, CDate, MUser, MDate)
		VALUES (1, @TeamId, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate) 
	END





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlan_MoveItem_Header_SELECT]'
GO
CREATE  PROCEDURE [dbo].[spx_LinePlan_MoveItem_Header_SELECT] (
@StyleID UNIQUEIDENTIFIER, 
@ActionID INT 
)
as 

DECLARE @LinePlanItemID UNIQUEIDENTIFIER 

SELECT TOP 1 @LinePlanItemID = LinePlanItemID  FROM pStyleSeasonyear a
WHERE a.StyleID = @StyleID 

IF  @ActionID  = 1 
	SELECT 'Lineplan: '  + c.Description + ' (' + b.LinePlanAttributeText1 + ' / ' + LinePlanAttributeText2 + ' / ' + LinePlanAttributeText3 + ')' 
	as Description 
	FROM pLinePlanItem a
	INNER JOIN pLinePlanRange b ON a.LinePlanRangeID =  b.LinePlanRangeID
	INNER JOIN pLinePlan c ON c.LinePlanID = a.LinePlanID 
	WHERE a.LinePlanItemID = @LinePlanItemID 
ELSE 
	SELECT b.LinePlanAttributeText1 + ' / ' + LinePlanAttributeText2 + ' / ' + LinePlanAttributeText3 
	FROM pLinePlanItem a
	INNER JOIN pLinePlanRange b ON a.LinePlanRangeID =  b.LinePlanRangeID
	INNER JOIN pLinePlan c ON c.LinePlanID = a.LinePlanID 
	WHERE a.LinePlanItemID = @LinePlanItemID 


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleDevelopmentItemTemp_INSERT]'
GO

CREATE PROCEDURE [dbo].[spx_StyleDevelopmentItemTemp_INSERT](
	@StyleDevelopmentID UNIQUEIDENTIFIER, 
	@NewStyleDevelopmentID UNIQUEIDENTIFIER, 
	@StyleID UNIQUEIDENTIFIER, 
	@NewStyleID UNIQUEIDENTIFIER,
	@DevNo varchar(50),
	@DevTempID varchar(50),
	@DevTempNo varchar(50),
	@StyleCopyType VARCHAR(50)
)
AS
BEGIN

-- Usage:
-- Insert selected styles to create new styles and carry over styles
-- There are two stylecopytype 'CARRYOVER' AND 'NEW'

INSERT INTO pStyleDevelopmentItemTemp
           (StyleDevelopmentItemID
			,StyleDevelopmentID
			,NewStyleDevelopmentID
			,StyleID
			,NewStyleID
			,Variation
			,DevNo 
			,DevTempID 
			,DevTempNo 
			,StyleCopyType
			,StyleDevelopmentName)
		SELECT
			StyleDevelopmentItemID
			,StyleDevelopmentID
			,@NewStyleDevelopmentID
			,StyleID
			,@NewStyleID
			,Variation
			,@DevNo 
			,@DevTempID 
			,@DevTempNo 
			,@StyleCopyType
			,StyleDevelopmentName
		FROM pStyleDevelopmentItem 
		WHERE StyleID = @StyleID

END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_Material_AgentVendor_SELECT]'
GO
EXEC sp_refreshview N'[dbo].[vwx_Material_AgentVendor_SELECT]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[vwx_LineList_Style_Item_SEL]'
GO
SET QUOTED_IDENTIFIER OFF
GO



/*
Comments:

General - Ryan Cabanas - April 6, 2010
	View to select (schema) fields to show below a style when searching to add styles to a line list.
*/

CREATE VIEW [dbo].[vwx_LineList_Style_Item_SEL]
AS
SELECT
	pStyleHeader.*
	,pStyleSeasonYear.StyleSeason
	,pStyleSeasonYear.StyleYear
	,ISNULL(pStyleDevelopmentItem.StyleDevelopmentName, pStyleDevelopmentItem.Variation) AS Variation
FROM pStyleHeader
	INNER JOIN dbo.pStyleSeasonYear ON pStyleHeader.StyleID = pStyleSeasonYear.StyleID
	INNER JOIN pStyleDevelopmentItem ON pStyleHeader.DevelopmentID = pStyleDevelopmentItem.StyleDevelopmentID
										AND pStyleHeader.StyleID = pStyleDevelopmentItem.StyleID

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_BB_Material_StatusReport_SELECT]'
GO
EXEC sp_refreshview N'[dbo].[vwx_BB_Material_StatusReport_SELECT]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleDevelopmentSpecSort_UPDATE]'
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spx_StyleDevelopmentSpecSort_UPDATE]
(
@SpecID uniqueidentifier,
@StyleID uniqueidentifier,
@StyleSet int,
@SpecSort varchar(5),
@MUser nvarchar(200),
@MDate datetime
)
AS


BEGIN
	UPDATE pStyleSpec SET Sort = @SpecSort WHERE (SpecID = @SpecID)
END

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleDevelopmentSpecSort_Linked_UPDATE]'
GO
CREATE PROCEDURE [dbo].[spx_StyleDevelopmentSpecSort_Linked_UPDATE]
(
	@SpecID uniqueidentifier,
	@StyleID uniqueidentifier,
	@StyleSet int,
	@SpecSort varchar(5),
	@MUser nvarchar(200),
	@MDate datetime
)

AS


/************************/
/*Declare variables.	*/
/************************/
DECLARE @StyleID_Param UNIQUEIDENTIFIER		--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT					--Keep a copy of the original parameter value.
DECLARE @SpecID_Param UNIQUEIDENTIFIER		--Keep a copy of the original parameter value.

DECLARE @StyleLinkID UNIQUEIDENTIFIER
DECLARE @POM NVARCHAR(10)
DECLARE @PointMeasure NVARCHAR(225)

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @SpecID_Param = @SpecID
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,SpecID UNIQUEIDENTIFIER
	,StyleSet INT
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleDevelopmentSpecSort_UPDATE
			@SpecID_Param
			,@StyleID_Param
			,@StyleSet_Param
			,@SpecSort
			,@MUser
			,@MDate
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Clear variables.*/
		SET @POM = NULL
		SET @PointMeasure = NULL


		/*Get the 'POM' and 'PointMeasure' values of the calling Style.*/
		SELECT @POM = POM
			,@PointMeasure = PointMeasur
		FROM pStyleSpec
		WHERE SpecID = @SpecID_Param


		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet_Param AS StyleSet
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID


		/*Get and set the counts for the Multi-Cloth linked Styles.*/
		SELECT @TotalCount = COUNT(*) FROM #temp_Linked
		SET @RowCounter = 1


		/*Get the 'SpecID' of the POM for each of the Multi-Cloth linked Styles.*/
		WHILE(@RowCounter <= @TotalCount)
			BEGIN
				/*Clear variables.*/
				SET @StyleID = NULL
				SET @SpecID = NULL
				SET @StyleSet = NULL


				/*Get 'StyleID'.*/
				SELECT @StyleID = StyleID
					,@StyleSet = StyleSet
				FROM #temp_Linked
				WHERE TableRow = @RowCounter


				/*Get the 'SpecID'.*/
				SELECT @SpecID = SpecID
				FROM pStyleSpec
				WHERE StyleID = @StyleID
					AND StyleSet = @StyleSet
					AND POM = @POM
					AND PointMeasur = @PointMeasure


				/*Update the temp table with the 'SpecID'.*/
				UPDATE #temp_Linked
				SET SpecID = @SpecID
				WHERE TableRow = @RowCounter


				/*Up row counter.*/
				SET @RowCounter = @RowCounter + 1
			END
	END

/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'SpecID' of the POM for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @SpecID = NULL
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Get the 'SpecID' for the update.*/
		SELECT @SpecID = SpecID
			,@StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleDevelopmentSpecSort_UPDATE
			@SpecID
			,@StyleID
			,@StyleSet
			,@SpecSort
			,@MUser
			,@MDate


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_DesktopAccessComplianceFolderCheck_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_User_DesktopAccessComplianceFolderCheck_INSERT]
(
@TeamId uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

DECLARE @I as int
DECLARE @Row_Count int
DECLARE @ComplianceTypeID int
DECLARE @DeskAccessId int
DECLARE @DeskTableName varchar(100)
DECLARE @DeskTableKey varchar(50)


	BEGIN
	CREATE TABLE #TempUserAccess (
		Id int IDENTITY (1, 1) NOT NULL , 
		ComplianceTypeID int NOT NULL,
		TeamId uniqueidentifier
	) 
	END

	BEGIN
	
	INSERT INTO #TempUserAccess(ComplianceTypeID) SELECT ComplianceTypeID FROM pComplianceType WITH (NOLOCK)
	
	
	SET @Row_Count = (SELECT COUNT(*) FROM #TempUserAccess)
	
	SET @I = 1

	WHILE @I <= @Row_Count 
		BEGIN

			SELECT @ComplianceTypeID = ComplianceTypeID FROM #TempUserAccess WHERE ID = @I
			IF (SELECT COUNT(*) FROM sAccessComplianceFolder WITH (NOLOCK) WHERE ComplianceTypeID = @ComplianceTypeID AND TeamId = @TeamId) = 0
			BEGIN
				INSERT INTO sAccessComplianceFolder
					(ComplianceTypeID, TeamId, CUser, CDate, MUser, MDate)
				SELECT ComplianceTypeID, @TeamId, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate 
				FROM  #TempUserAccess WHERE Id = @I
			END
				
			SET @I = @I + 1
		END

		SELECT * FROM #tempUserAccess

	END
	




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialLinkByGroup_SELECT]'
GO



CREATE PROCEDURE  [dbo].[spx_MaterialLinkByGroup_SELECT] (
@MaterialGroupID UNIQUEIDENTIFIER   
)
AS 

	SELECT a.MaterialLinkID , a.MaterialID , b.MaterialName, b.MaterialNo  FROM pMaterialLink a INNER JOIN pMaterial b ON a.MaterialID = b.MaterialID 
	INNER JOIN pComponentType c ON b.MaterialType =  c.ComponentTypeID 
	WHERE a.MaterialGroupID = @MaterialGroupID  
	ORDER BY c.ComponentOrder , c.ComponentDescription , b.MaterialNo, b.MaterialName, a.MaterialLinkID




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_UserGroup_SELECT]'
GO




CREATE PROCEDURE [dbo].[spx_UserGroup_SELECT]
(@teamId uniqueidentifier)
AS 


SELECT  uUserGroup.GroupID, uGroup.GroupName, uGroup.Active, uUserGroup.TeamID
FROM  uUserGroup INNER JOIN
  uGroup ON uUserGroup.GroupID = uGroup.GroupID
WHERE uUserGroup.TeamId = @teamId
ORDER BY uGroup.GroupName
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlan_MoveTo_Logic_SELECT]'
GO


CREATE PROCEDURE [dbo].[spx_LinePlan_MoveTo_Logic_SELECT](
	@StyleID UNIQUEIDENTIFIER 
)
AS 

	DECLARE @LinePlanID UNIQUEIDENTIFIER
	DECLARE @LinePlanAttributeText1 NVARCHAR(200)
	DECLARE @LinePlanAttributeText2 NVARCHAR(200)
	DECLARE @LinePlanAttributeText3 NVARCHAR(200)

	
	SELECT @LinePlanID = a.LinePlanID, @LinePlanAttributeText1 = c.LinePlanAttributeText1, 
	@LinePlanAttributeText2 = c.LinePlanAttributeText2, @LinePlanAttributeText3 = c.LinePlanAttributeText3
	FROM pStyleSeasonYear a
	INNER JOIN pLinePlanItem b ON a.LinePlanItemID =  b.LinePlanItemID
	INNER JOIN pLinePlanRange c ON c.LinePlanRangeID =  b.LinePlanRangeID 
	WHERE a.StyleID = @StyleID
	AND a.LinePlanItemID  IS NOT NULL 
	
	IF @LinePlanID IS NOT NULL 
	AND @LinePlanAttributeText1 IS NOT NULL 
	AND @LinePlanAttributeText2 IS NOT NULL 
	AND @LinePlanAttributeText3 IS NOT NULL 
	BEGIN
		
		SELECT DISTINCT a.LinePlanID, c.Description + '&nbsp;&nbsp;&nbsp;(' + c.Season + '/' + c.Year  + ')' AS Description 
		FROM  pLinePlanItem a
		INNER JOIN pLinePlanRange b  ON a.LinePlanRangeID =  b.LinePlanRangeID 
		INNER JOIN pLinePlan c ON c.LinePlanID =  a.LinePlanID 
		WHERE a.StyleID = '00000000-0000-0000-0000-000000000000'
		AND a.LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003'
		AND b.LinePlanAttributeText1 =  @LinePlanAttributeText1
		AND b.LinePlanAttributeText2 =  @LinePlanAttributeText2
		AND b.LinePlanAttributeText3 =  @LinePlanAttributeText3
		AND a.LinePlanID NOT IN (
			SELECT b.LinePlanID  
			FROM pStyleSeasonYear a
			INNER JOIN pLinePlanItem b ON b.LinePlanItemID =  a.LinePlanItemID 
			WHERE a.StyleID = @StyleID --'7ca997ee-5944-4c48-a918-83f85d324c32'
		)
		ORDER BY c.Description 
	
	END 
	ELSE
		SELECT NULL AS LinePlanID,  NULL AS Description 
	
	






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_Material_AgentVendorColor_SELECT]'
GO
EXEC sp_refreshview N'[dbo].[vwx_Material_AgentVendorColor_SELECT]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_DesktopAccessControlPanelCheck_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_User_DesktopAccessControlPanelCheck_INSERT]
(
@TeamId uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

DECLARE @I as int
DECLARE @Row_Count int
DECLARE @ControlPanelId int
DECLARE @DeskAccessId int
DECLARE @DeskTableName varchar(100)
DECLARE @DeskTableKey varchar(50)


	BEGIN
	CREATE TABLE #TempUserAccess (
		Id int IDENTITY (1, 1) NOT NULL , 
		ControlPanelId int NOT NULL,
		TeamId uniqueidentifier
	) 
	END

	BEGIN
	
	INSERT INTO #TempUserAccess(ControlPanelId) SELECT ControlPanelId FROM pControlPanel WITH (NOLOCK)
	
	
	SET @Row_Count = (SELECT COUNT(*) FROM #TempUserAccess)
	
	SET @I = 1

	WHILE @I <= @Row_Count 
		BEGIN

			SELECT @ControlPanelId = ControlPanelId FROM #TempUserAccess WHERE ID = @I
			IF (SELECT COUNT(*) FROM sAccessControlPanel WITH (NOLOCK) WHERE ControlPanelId = @ControlPanelId AND TeamId = @TeamId) = 0
			BEGIN
				INSERT INTO sAccessControlPanel
					(ControlPanelId, TeamId, CUser, CDate, MUser, MDate)
				SELECT ControlPanelId, @TeamId, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate 
				FROM  #TempUserAccess WHERE Id = @I
			END
				
			SET @I = @I + 1
		END

		SELECT * FROM #tempUserAccess

	END
	




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleHeaderVariation_INSERT]'
GO



/********************************************************************************************************************/
/*NOTES:																											*/
/* 12/12/2007 - Ryan Cabanas -	For the next to last INSERT statement, into the pStyleWorkflow table, modified		*/
/*								the "WorkStatus" and "WorkStatusDate" fields so that they insert a '6' and 'NULL',	*/
/*								respectively.  Before, they just entered the values from the previous Variation.	*/
/*								The '6' sets the status to "In Progress".											*/
/********************************************************************************************************************/




ALTER  PROCEDURE [dbo].[spx_StyleHeaderVariation_INSERT]
(
@StyleID uniqueidentifier,
@NewStyleID uniqueidentifier,
@DesignSketchID uniqueidentifier,
@DesignSketchVersion varchar(5),
@StyleVariation varchar(5),
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

SET NOCOUNT ON

DECLARE @StyleMasterID uniqueidentifier
DECLARE @NewStyleMasterID uniqueidentifier


SET @NewStyleMasterID = newid()

/*
BEGIN
		
	SELECT @StyleMasterID = StyleMasterID FROM pStyleHeader WITH (NOLOCK) WHERE StyleID = @StyleID
		
		IF @StyleMasterID IS NULL
		BEGIN			
			UPDATE pStyleHeader SET StyleMasterID = @NewStyleMasterID WHERE StyleID = @StyleID
		END	
			
END
*/

SET @StyleMasterID = @NewStyleMasterID

BEGIN
	INSERT INTO pStyleHeader
		(StyleID, StyleMasterID, StyleCategory, SizeClass, StyleType, WorkflowType, StyleNo, TempID, TempNo, CustomerNo, DevelopmentID, 
		DevelopmentNo, SpecNo, Description, SizeRange, StyleSet, DueDate, RecDate, Designer, StyleStatus, StyleLocation, WashType, Pitch, MaterialID, 
		MaterialImageID, MaterialImageVersion, MaterialNo, MaterialName, POMTempID1, POMTempVersion1, POMTempID2, POMTempVersion2, 
		POMTempID3, POMTempVersion3, POMTempID4, POMTempVersion4, POMTempSizeClass1, POMTempSizeClass2, POMTempSizeClass3, 
		POMTempSizeClass4, StyleMaterialID, DesignSketchID, TechSketchID, ConceptSketchID, ColorSketchID, DesignSketchVersion, TechSketchVersion, 
		ConceptSketchVersion, ColorSketchVersion, DetailSketchID1, DetailSketchID2, DetailSketchID3, DetailSketchID4, DetailSketchVersion1, 
		DetailSketchVersion2, DetailSketchVersion3, DetailSketchVersion4, SpecSketchID1, SpecSketchID2, SpecSketchID3, SpecSketchID4, 
		SpecSketchVersion1, SpecSketchVersion2, SpecSketchVersion3, SpecSketchVersion4, CustomField1, CustomField2, CustomField3, CustomField4, 
		CustomField5, CustomField6, CustomField7, CustomField8, CustomField9, CustomField10, CustomField11, CustomField12, CustomField13, 
		CustomField14, CustomField15, Pc1, Pc2, Pc3, Pc4, CUser, CDate, MUser, MDate, Active, Change, Action, StyleDetail, StyleAttribute, Customer, Buyer, 
		SampleMaker, PatternMaker, ProductionManager, TechnicalDesigner, StyleDetail1, StyleDetail2,
		CustomField16, CustomField17, CustomField18, CustomField19, CustomField20, CustomField21, CustomField22,  CustomField23, CustomField24,  CustomField25, 
		CustomField26, CustomField27, CustomField28,  CustomField29,  CustomField30 
		)
	SELECT @NewStyleID AS NewStyleId, @StyleMasterID AS StyleMasterId, StyleCategory, SizeClass, StyleType, WorkflowType, StyleNo, TempID, TempNo, 
		CustomerNo, DevelopmentID, DevelopmentNo, SpecNo, Description, SizeRange, StyleSet, DueDate, RecDate, Designer, StyleStatus, StyleLocation, 
		WashType, Pitch, MaterialID, MaterialImageID, MaterialImageVersion, MaterialNo, MaterialName, POMTempID1, POMTempVersion1, POMTempID2, 
		POMTempVersion2, POMTempID3, POMTempVersion3, POMTempID4, POMTempVersion4, POMTempSizeClass1, POMTempSizeClass2, 
		POMTempSizeClass3, POMTempSizeClass4, StyleMaterialID, @DesignSketchID AS Expr3, TechSketchID, ConceptSketchID, ColorSketchID, 
		@DesignSketchVersion AS Expr4, TechSketchVersion, ConceptSketchVersion, ColorSketchVersion, DetailSketchID1, DetailSketchID2, DetailSketchID3, 
		DetailSketchID4, DetailSketchVersion1, DetailSketchVersion2, DetailSketchVersion3, DetailSketchVersion4, SpecSketchID1, SpecSketchID2, 
		SpecSketchID3, SpecSketchID4, SpecSketchVersion1, SpecSketchVersion2, SpecSketchVersion3, SpecSketchVersion4, CustomField1, CustomField2, 
		CustomField3, CustomField4, CustomField5, CustomField6, CustomField7, CustomField8, CustomField9, CustomField10, CustomField11, 
		CustomField12, CustomField13, CustomField14, CustomField15, Pc1, Pc2, Pc3, Pc4, @CreatedBy AS CUser, @CreatedDate AS CDate, 
		@CreatedBy AS MUser, @CreatedDate AS MDate, 1, Change, Action, StyleDetail, StyleAttribute, Customer, Buyer, SampleMaker, PatternMaker, 
		ProductionManager, TechnicalDesigner, StyleDetail1, StyleDetail2,
		CustomField16, CustomField17, CustomField18, CustomField19, CustomField20, CustomField21, CustomField22,  CustomField23, CustomField24,  CustomField25, 
		CustomField26, CustomField27, CustomField28,  CustomField29,  CustomField30 
	FROM  pStyleHeader WITH (NOLOCK)
	WHERE StyleID = @StyleID
END

BEGIN
	
	INSERT INTO pStyleAttribute
         (StyleAttributeTableId, StyleId, StyleAttributeText, StyleAttributeValue, CUser, CDate, MUser, MDate)
	SELECT StyleAttributeTableId, @NewStyleId, StyleAttributeText, StyleAttributeValue, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate
	FROM pStyleAttribute WITH (NOLOCK)
	WHERE StyleID = @StyleID
	
END

BEGIN
		
	SELECT @StyleMasterID = StyleMasterID FROM pStyleImage WITH (NOLOCK) WHERE StyleID = @StyleID
		
		IF @StyleMasterID IS NULL
		BEGIN
			UPDATE pStyleImage SET StyleMasterID = @NewStyleMasterID WHERE StyleID = @StyleID
		END	
			
END

BEGIN

	INSERT INTO dbo.pStyleImage
	(StyleID, StyleMasterID, StyleType, MaterialID, MaterialImageID, DesignSketchID, TechSketchID, SalesSketchID, ColorSketchID, MaterialImageVersion, 
	DesignSketchVersion, TechSketchVersion, SalesSketchVersion, ColorSketchVersion, SpecSketchID1, SpecSketchID2, SpecSketchID3, SpecSketchID4, 
	SpecSketchVersion1, SpecSketchVersion2, SpecSketchVersion3, SpecSketchVersion4, DetailSketchNo, DetailSketchData, DetailSketchID1, 
	DetailSketchID2, DetailSketchID3, DetailSketchID4, DetailSketchID11, DetailSketchID12, DetailSketchID21, DetailSketchID22, DetailSketchID31, 
	DetailSketchID32, DetailSketchID41, DetailSketchID42, DetailSketchVersion1, DetailSketchVersion2, DetailSketchVersion3, DetailSketchVersion4, 
	DetailSketchVersion11, DetailSketchVersion12, DetailSketchVersion21, DetailSketchVersion22, DetailSketchVersion31, DetailSketchVersion32, 
	DetailSketchVersion41, DetailSketchVersion42)
	SELECT @NewStyleID, @StyleMasterID, StyleType, MaterialID, MaterialImageID, DesignSketchID, TechSketchID, SalesSketchID, ColorSketchID, MaterialImageVersion, 
	DesignSketchVersion, TechSketchVersion, SalesSketchVersion, ColorSketchVersion, SpecSketchID1, SpecSketchID2, SpecSketchID3, SpecSketchID4, 
	SpecSketchVersion1, SpecSketchVersion2, SpecSketchVersion3, SpecSketchVersion4, DetailSketchNo, DetailSketchData, DetailSketchID1, 
	DetailSketchID2, DetailSketchID3, DetailSketchID4, DetailSketchID11, DetailSketchID12, DetailSketchID21, DetailSketchID22, DetailSketchID31, 
	DetailSketchID32, DetailSketchID41, DetailSketchID42, DetailSketchVersion1, DetailSketchVersion2, DetailSketchVersion3, DetailSketchVersion4, 
	DetailSketchVersion11, DetailSketchVersion12, DetailSketchVersion21, DetailSketchVersion22, DetailSketchVersion31, DetailSketchVersion32, 
	DetailSketchVersion41, DetailSketchVersion42
	FROM dbo.pStyleImage WITH (NOLOCK)
	WHERE StyleID = @StyleID
	
END

BEGIN
CREATE TABLE [dbo].[#tempStyleWorkflow] (
	[RecID] int IDENTITY(1,1)  NOT NULL,
	[StyleWorkflowID]  uniqueidentifier ROWGUIDCOL  NOT NULL ,
	[StyleWorkflowMasterID] [uniqueidentifier],
	[StyleID] [uniqueidentifier],
	[StyleSet] [int],
	[WorkflowID] [uniqueidentifier],
	[WorkflowType] [int],
	[WorkflowOrder] [int],
	[WorkDate] [datetime],
	[WorkStart] [datetime],
	[WorkDue] [datetime],
	[WorkAssignedTo] [int],
	[WorkComplete] [nvarchar] (50),
	[WorkStatus] [int],
	[WorkStatusDate] [datetime],
	[WorkStatusBy] [nvarchar] (50),
	[WorkVersion] [int],
	[WorkComments] [nvarchar] (4000),
	[WorkSort] [nvarchar] (2),
	[CUser] [nvarchar] (100),
	[CDate] [datetime],
	[MUser] [nvarchar] (100),
	[MDate] [datetime]
)
END

BEGIN
	INSERT INTO dbo.#tempStyleWorkflow
	(StyleWorkflowID, StyleID, StyleSet, WorkflowID, WorkflowType, WorkflowOrder, WorkDate, WorkStart, WorkDue, WorkAssignedTo, WorkComplete, 
	WorkStatus, WorkStatusDate, WorkStatusBy, WorkVersion, WorkComments, WorkSort, CUser, CDate, MUser, MDate)
	SELECT StyleWorkflowID, @NewStyleID AS StyleID, StyleSet, WorkflowID, WorkflowType, WorkflowOrder, WorkDate, WorkStart, WorkDue, WorkAssignedTo, WorkComplete, 
	WorkStatus, WorkStatusDate, WorkStatusBy, WorkVersion, WorkComments, WorkSort, @CreatedBy AS CUser, @CreatedDate AS CDate, @CreatedBy AS MUser, @CreatedDate AS MDate
	FROM  dbo.pStyleWorkflow WITH (NOLOCK)
	WHERE StyleID = @StyleID
END

BEGIN

DECLARE @Row_Count int
DECLARE @Row_Loop int
DECLARE @NewStyleWorkflowMasterID uniqueidentifier
DECLARE @StyleWorkflowMasterID uniqueidentifier
DECLARE @StyleWorkflowID uniqueidentifier


	SET @Row_Loop = 1
	SET @Row_Count = (SELECT COUNT(*) FROM dbo.#tempStyleWorkflow)
	
	WHILE @Row_Loop <= @Row_Count 
	
		BEGIN
		
		SELECT @StyleWorkflowMasterID = StyleWorkflowMasterID, @StyleWorkflowID = StyleWorkflowID FROM #tempStyleWorkflow WHERE RecID = @Row_Loop
			
			IF @StyleWorkflowMasterID IS NULL
			BEGIN
				SET @NewStyleWorkflowMasterID = newid()
				UPDATE pStyleWorkflow SET StyleWorkflowMasterID = @NewStyleWorkflowMasterID WHERE StyleWorkflowID = @StyleWorkflowID
			END	
		
		SET @Row_Loop = @Row_Loop + 1
			
		END
END

BEGIN

	INSERT INTO dbo.pStyleWorkflow
	(StyleWorkflowID, StyleID, StyleSet, WorkflowID, WorkflowType, WorkflowOrder, WorkDate, WorkStart, WorkDue, WorkAssignedTo, WorkComplete, 
	WorkStatus, WorkStatusDate, WorkStatusBy, WorkVersion, WorkComments, WorkSort, CUser, CDate, MUser, MDate)
	SELECT  newid() AS StyleWorkflowID, @NewStyleID AS StyleID, StyleSet, WorkflowID, WorkflowType, WorkflowOrder, WorkDate, WorkStart, WorkDue, WorkAssignedTo, WorkComplete, 
	6 AS WorkStatus, NULL AS WorkStatusDate, WorkStatusBy, WorkVersion, WorkComments, WorkSort, @CreatedBy AS CUser, @CreatedDate AS CDate, @CreatedBy AS MUser, @CreatedDate AS MDate
	FROM  dbo.pStyleWorkflow WITH (NOLOCK)
	WHERE StyleID = @StyleID
END

BEGIN

	DECLARE @Variation int
	DECLARE @StyleDevelopmentID varchar(50)

	SELECT @StyleDevelopmentID = StyleDevelopmentID FROM dbo.pStyleDevelopmentItem WITH (NOLOCK) WHERE StyleID = @StyleID
	SET @Variation = (SELECT MAX(Variation) FROM pStyleDevelopmentItem WITH (NOLOCK) WHERE StyleDevelopmentID = @StyleDevelopmentID) + 1

	INSERT INTO dbo.pStyleDevelopmentItem
	(StyleDevelopmentItemID, StyleDevelopmentID, StyleID, SizeRange, Variation, CUser, CDate, MUser, MDate)
	SELECT newid() AS StyleDevelopmentItemID, StyleDevelopmentID, @NewStyleID, SizeRange, @Variation, @CreatedBy AS CUser, @CreatedDate AS CDate, @CreatedBy AS MUser, @CreatedDate AS MDate
	FROM dbo.pStyleDevelopmentItem WITH (NOLOCK)
	WHERE StyleID = @StyleID

END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteTradePartner_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_StyleQuoteTradePartner_SELECT](@StyleDevelopmentID uniqueidentifier,
@TradePartnerID uniqueidentifier)
AS SELECT     dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.Description, dbo.pStyleHeader.SizeClass, dbo.pStyleHeader.SizeRange, 
                      dbo.pStyleHeader.DesignSketchID, dbo.pStyleHeader.DesignSketchVersion, dbo.pStyleQuoteItem.StyleQuoteItemID, 
                      dbo.pStyleQuoteItem.StyleQuoteID, dbo.pStyleQuoteItem.StyleID, dbo.pStyleQuoteItem.StyleQuoteTradePartnerID, dbo.pStyleQuoteItem.StyleCostingID,
                       dbo.pStyleQuoteItem.StyleCostingType, dbo.pStyleQuoteItem.TradePartnerID, dbo.pStyleQuoteItem.StyleDevelopmentID
FROM         dbo.pStyleQuoteItem WITH (NOLOCK) INNER JOIN
                      dbo.pStyleHeader WITH (NOLOCK) ON dbo.pStyleQuoteItem.StyleID = dbo.pStyleHeader.StyleID
WHERE     (dbo.pStyleQuoteItem.StyleDevelopmentID = @StyleDevelopmentID) AND (dbo.pStyleQuoteItem.TradePartnerID = @TradePartnerID)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleNumberCopyLogic_UPDATE]'
GO


CREATE PROCEDURE [dbo].[spx_StyleNumberCopyLogic_UPDATE]
(
@NewStyleId uniqueidentifier,
@StyleNo nvarchar(20),
@TempId nvarchar(20),
@TempNo nvarchar(20),
@StyleCopyType varchar(100)
)
AS 

-- Using: It will update style numbers from style number XML logic 
-- Param: StyleCopyTpe = 'CARRYOVER' and 'NEW'

DECLARE @StyleId uniqueidentifier
DECLARE @StyleDevelopmentId uniqueidentifier
DECLARE @StyleVariation int
DECLARE @DevNo nvarchar(50)
DECLARE @DevTempId nvarchar(50)
DECLARE @DevTempNo nvarchar(50)

SELECT TOP 1 @StyleVariation = Variation, 
	@StyleDevelopmentId = StyleDevelopmentId, 
	@StyleId = StyleId,
	@DevNo = DevNo,
	@DevTempID = DevTempID,
	@DevTempNo = DevTempNo 
FROM pStyleDevelopmentItemTemp WHERE NewStyleId = @NewStyleId

IF @StyleCopyType = 'CARRYOVER'
	BEGIN
		SELECT @StyleNo = StyleNo, @TempID = TempId, @TempNo = TempNo FROM pStyleHeader
		WHERE StyleID = @StyleId

		UPDATE  pStyleHeader SET DevelopmentNo = @DevNo, StyleNo = @StyleNo, TempID = @TempId, TempNo = @TempNo
		WHERE StyleID = @NewStyleId
	END	
ELSE
	--NEW
	BEGIN
		UPDATE  pStyleHeader SET 
			DevelopmentNo = @DevNo, StyleNo = @StyleNo, TempID = @TempId, TempNo = @TempNo
		WHERE   (StyleID = @NewStyleId)
	
	END	
	
	
	
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_Material_AgentVendorColorLabDip_SELECT]'
GO
-- kj EXEC sp_refreshview N'[dbo].[vwx_Material_AgentVendorColorLabDip_SELECT]'
--GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleNo_Logic_UPDATE]'
GO

CREATE  PROCEDURE dbo.spx_StyleNo_Logic_UPDATE(
@StyleNo nvarchar(20),
@TempId nvarchar(20),
@TempNo nvarchar(20),
@StyleId uniqueidentifier,
@MUser NVARCHAR(200), 
@MDate DATETIME
)
AS 


DECLARE @StyleDevelopmentId uniqueidentifier
DECLARE @StyleVariation int

SELECT TOP 1 @StyleVariation = Variation, @StyleDevelopmentId = StyleDevelopmentId 
FROM pStyleDevelopmentItem WITH (NOLOCK) WHERE StyleId = @StyleId

IF (SELECT COUNT(*) FROM pStyleDevelopmentItem WITH (NOLOCK) WHERE Variation = @StyleVariation AND StyleDevelopmentId = @StyleDevelopmentId) = 1 
BEGIN
	UPDATE  pStyleHeader
	SET StyleNo = @StyleNo, TempID = @TempId, TempNo = @TempNo,	MUser =@MUser, MDate = @MDate
	WHERE StyleID = @StyleId
END	
ELSE
BEGIN

	DECLARE @tmpStyleId uniqueidentifier
	DECLARE @tmpStyleNo nvarchar(20)
	DECLARE @tmpTempId nvarchar(20)
	DECLARE @tmpTempNo nvarchar(20)
	
	SELECT TOP 1 @tmpStyleId = StyleId FROM pStyleDevelopmentItem WITH (NOLOCK) 
	WHERE Variation = @StyleVariation AND StyleDevelopmentId = @StyleDevelopmentId 
	ORDER BY CDate ASC

	SELECT TOP 1 @tmpStyleNo = StyleNo, @tmpTempID = TempId, @tmpTempNo = TempNo FROM pStyleHeader WITH (NOLOCK)
	WHERE StyleID = @tmpStyleId
	
	DECLARE @NewStyleNo nvarchar(20)
	SET @NewStyleNo = REPLACE(@TempId, 'AUTOID', @tmpTempNo)

	UPDATE  pStyleHeader
	SET StyleNo = @NewStyleNo, TempID = @TempId, TempNo = @tmpTempNo, MUser =@MUser, MDate = @MDate
	WHERE StyleID = @StyleId

END	


--***
--** UPDATE PLMCode 
--***
--EXEC dbo.spx_StyleColorway_PLMCode_UPDATE @StyleID = @StyleId , @FromColorPalette = 1 
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_DesktopAccessFolder_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_User_DesktopAccessFolder_SELECT]
(@TeamId uniqueidentifier)
AS 


SELECT cDeskUserFolderAccess.DeskUserAccessId, cDesktopFolder.DeskFolderId, cDesktopFolder.DeskFolderName, 
    cDeskUserFolderAccess.TeamId, cDeskUserFolderAccess.DeskAccessId, cDesktopFolder.DeskFolderUrl , cDesktopFolder.DeskSubFolder
FROM  cDeskUserFolderAccess WITH (NOLOCK) INNER JOIN
    cDesktopFolder WITH (NOLOCK) ON cDeskUserFolderAccess.DeskFolderId = cDesktopFolder.DeskFolderId
WHERE (cDeskUserFolderAccess.TeamId = @TeamId)
ORDER BY cDesktopFolder.DeskFolderId



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_SampleRequestSubmit_Image_SELECT]'
GO



/*
Comments:

#01 - Ryan Cabanas - September 25, 2009
	Replace the old sample image string with the new image string using function.
Deleted old code.
*/



ALTER    PROCEDURE [dbo].[rpx_SampleRequestSubmit_Image_SELECT]
(
	@SampleRequestSubmitID varchar(50)
)
AS


DECLARE @SampleRequestTradeID varchar(50)
DECLARE @SampleWorkflowID nvarchar(5)
DECLARE	@Submit int
DECLARE	@StyleID varchar(50)
DECLARE @StyleSet int
 

/*Get some other variables needed.*/
SELECT
	@SampleRequestTradeID = SampleRequestTradeID,
	@SampleWorkflowID = SampleWorkflowID,
	@Submit = Submit,
	@StyleID = StyleID,
	@StyleSet = StyleSet
FROM pSampleRequestSubmit
WHERE SampleRequestSubmitID = @SampleRequestSubmitID

CREATE TABLE #TemppSampleRequestSubmitImage
(
	TableRow int identity(0,1),
	FilePath varchar(255),
	[Description] nvarchar(200),
	MUser nvarchar(200),
	MDate datetime
)

INSERT INTO #TemppSampleRequestSubmitImage
	(FilePath
	,Description
	,MUser
	,MDate)
SELECT
	dbo.fnx_GetStreamingSampleImagePath(SampleRequestTradeID, TradePartnerVendorID, SampleRequestSubmitImageID, ImageID) AS FilePath	--Comment #01
	,ImageDescription
	,MUser
	,MDate
FROM pSampleRequestSubmitImage
WHERE StyleID = @StyleID AND
StyleSet = @StyleSet AND
SampleRequestTradeID = @SampleRequestTradeID AND
SampleWorkflowID = @SampleWorkflowID AND
Submit = @Submit
ORDER BY CDate ASC

SELECT TableRow, TableRow % 2 AS [Column], FilePath, [Description], MUser, MDate
FROM #TemppSampleRequestSubmitImage
ORDER BY TableRow

DROP TABLE #TemppSampleRequestSubmitImage





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_Control_TradePartnerQuote_SELECT]'
GO
EXEC sp_refreshview N'[dbo].[vwx_Control_TradePartnerQuote_SELECT]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleSampleSize_Linked_UPDATE]'
GO
CREATE   PROCEDURE [dbo].[spx_StyleSampleSize_Linked_UPDATE]
(
	@StyleID uniqueidentifier,
	@Sel0 nvarchar(50),
	@Sel1 nvarchar(50),
	@Sel2 nvarchar(50),
	@Sel3 nvarchar(50),
	@Sel4 nvarchar(50),
	@Sel5 nvarchar(50),
	@Sel6 nvarchar(50),
	@Sel7 nvarchar(50),
	@Sel8 nvarchar(50),
	@Sel9 nvarchar(50),
	@Sel10 nvarchar(50),
	@Sel11 nvarchar(50),
	@Sel12 nvarchar(50),
	@Sel13 nvarchar(50),
	@Sel14 nvarchar(50),
	@Sel15 nvarchar(50),
	@Sel16 nvarchar(50),
	@Sel17 nvarchar(50),
	@Sel18 nvarchar(50),
	@Sel19 nvarchar(50)
)

AS 


/************************/
/*Declare variables.	*/
/************************/
DECLARE @StyleID_Param UNIQUEIDENTIFIER			--Keep a copy of the original parameter value.

DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleID_Param = @StyleID


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleSampleSize_UPDATE
			@StyleID_Param
			,@Sel0
			,@Sel1
			,@Sel2
			,@Sel3
			,@Sel4
			,@Sel5
			,@Sel6
			,@Sel7
			,@Sel8
			,@Sel9
			,@Sel10
			,@Sel11
			,@Sel12
			,@Sel13
			,@Sel14
			,@Sel15
			,@Sel16
			,@Sel17
			,@Sel18
			,@Sel19

	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID)
		SELECT
			StyleID
			,StyleLinkID
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID
	END

/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @StyleID = NULL


		/*Get the 'StyleID' for the update.*/
		SELECT @StyleID = StyleID
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleSampleSize_UPDATE
			@StyleID
			,@Sel0
			,@Sel1
			,@Sel2
			,@Sel3
			,@Sel4
			,@Sel5
			,@Sel6
			,@Sel7
			,@Sel8
			,@Sel9
			,@Sel10
			,@Sel11
			,@Sel12
			,@Sel13
			,@Sel14
			,@Sel15
			,@Sel16
			,@Sel17
			,@Sel18
			,@Sel19


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_DesktopAccessFolder_UPDATE]'
GO

ALTER PROCEDURE [dbo].[spx_User_DesktopAccessFolder_UPDATE]
(@DeskUserAccessId uniqueidentifier,
@DeskAccessId int,
@mUser nvarchar(200),
@mDate datetime)
AS 

DECLARE @DeskFolderId int
DECLARE @TeamId uniqueidentifier

SELECT @DeskFolderId = DeskFolderId, @TeamId = TeamId FROM cDeskUserFolderAccess WITH (NOLOCK) 
WHERE  (DeskUserAccessId = @DeskUserAccessId)

UPDATE   cDeskUserFolderAccess
SET  DeskAccessId = @DeskAccessId, MUser = @mUser, MDate = @mDate
WHERE  (DeskUserAccessId = @DeskUserAccessId)


If @DeskFolderId = 10
BEGIN
	IF @DeskAccessId = 1
	BEGIN
		UPDATE sAccessControlPanel SET 
			AccessRoleId = 0, 
			AccessView = 0, 
			AccessCreate = 0, 
			AccessModify = 0, 
			AccessDelete = 0, 
			AccessPrint = 0,
			MUser = @mUser, 
			MDate = @mDate
		WHERE TeamId = @TeamId
	END
END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlan_SeasonYears_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_LinePlan_SeasonYears_SELECT](
	@StyleID UNIQUEIDENTIFIER 
)
AS 

SELECT c.SeasonYearID , d.Description + '&nbsp;&nbsp; (' +  c.Season + ' / ' + c.Year + ')' AS Description  
FROM pStyleSeasonYear a
INNER JOIN pLinePlanItem b ON a.LinePlanItemID =  b.LinePlanItemID
INNER JOIN pSeasonYear c ON c.SeasonYearID =  a.SeasonYearID
INNER JOIN pLinePlan d ON d.LinePlanID =  b.LinePlanID
WHERE a.StyleID = @StyleID 
AND a.LinePlanItemID  IS NOT NULL 






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_LineFolder_Image_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.
*/


ALTER  PROCEDURE [dbo].[rpx_LineFolder_Image_SELECT]	 
	@LineFolderID AS varchar(255)
AS


SELECT
	identity(int,0,1) AS RowNumber,
	fi.LineFolderItemID AS LineFolderItemID, 
	sh.StyleNo,
	sh.StyleType,
	sh.DevelopmentNo,
	sh.SizeClass,
	sc.StyleCategory,
	sh.[Description], 
	sh.MaterialName, 
	(dbo.fnx_GetStreamingImagePath(hi.ImageID, hi.[Version])) AS FilePath,	--Comment #01
	ch.StyleCostingCustomField23 AS TargetFOB,
	ch.StyleCostingCustomField22 AS TargetLDP, 
	ch.StyleCostingCustomField21 AS TargetWHSL,
	ch.StyleCostingCustomField20 AS TargetMSRP, 
	ch.StyleCostingCustomField24 AS PricingComment,
	st.StyleTypeDescription AS StyleTypeDescription
INTO	#TblTemp 
FROM         pLineFolderItem fi LEFT OUTER JOIN
                      hImage hi ON fi.LineFolderImageID = hi.ImageID AND fi.LineFolderImageVersion = hi.Version LEFT OUTER JOIN
                      pStyleHeader sh ON fi.StyleID = sh.StyleID LEFT OUTER JOIN
                      pStyleCostingHeader ch ON sh.StyleID = ch.StyleID LEFT OUTER JOIN
                      pStyleCategory sc ON sh.StyleCategory = sc.StyleCategoryId LEFT OUTER JOIN
                      pStyleType st ON sh.StyleType = st.StyleTypeID
WHERE fi.LineFolderID = @LineFolderID 

SELECT
	RowNumber % 6 AS Row,
	LineFolderItemID,
	StyleType,
	DevelopmentNo,
	SizeClass,
	StyleCategory,
	[Description], 
	MaterialName,
	FilePath,
	TargetFOB,
	TargetLDP,
	TargetWHSL,
	TargetMSRP,
	PricingComment,
	 StyleTypeDescription
FROM #TblTemp

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_Material_AgentVendorNew_SELECT]'
GO
EXEC sp_refreshview N'[dbo].[vwx_Material_AgentVendorNew_SELECT]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_Control_TradePartnerQuotePopup_Default_SELECT]'
GO
EXEC sp_refreshview N'[dbo].[vwx_Control_TradePartnerQuotePopup_Default_SELECT]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_DesktopAccessImageFolderCheck_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_User_DesktopAccessImageFolderCheck_INSERT]
(
@TeamId uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

DECLARE @I as int
DECLARE @Row_Count int
DECLARE @ImageTypeID uniqueidentifier
DECLARE @DeskAccessId int
DECLARE @DeskTableName varchar(100)
DECLARE @DeskTableKey varchar(50)


	BEGIN
	CREATE TABLE #TempUserAccess (
		Id int IDENTITY (1, 1) NOT NULL , 
		ImageTypeID uniqueidentifier NOT NULL,
		TeamId uniqueidentifier
	) 
	END

	BEGIN
	
	INSERT INTO #TempUserAccess(ImageTypeID) SELECT ImageTypeID FROM pImageType WITH (NOLOCK)
	
	
	SET @Row_Count = (SELECT COUNT(*) FROM #TempUserAccess)
	
	SET @I = 1

	WHILE @I <= @Row_Count 
		BEGIN

			SELECT @ImageTypeID = ImageTypeID FROM #TempUserAccess WHERE ID = @I
			IF (SELECT COUNT(*) FROM sAccessImageFolder WITH (NOLOCK) WHERE ImageTypeId = @ImageTypeId AND TeamId = @TeamId) = 0
			BEGIN
				INSERT INTO sAccessImageFolder
					(ImageTypeId, TeamId, CUser, CDate, MUser, MDate)
				SELECT ImageTypeId, @TeamId, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate 
				FROM  #TempUserAccess WHERE Id = @I
			END
				
			SET @I = @I + 1
		END

		SELECT * FROM #tempUserAccess

	END
	




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteVariation_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_StyleQuoteVariation_SELECT]
(
@StyleID uniqueidentifier,
@StyleDevelopmentID uniqueidentifier,
@StyleQuoteID uniqueidentifier,
@StyleVariation varchar(3),
@TeamID uniqueidentifier = NULL 
)
AS 

SELECT pStyleHeader.StyleID, pStyleHeader.StyleMasterID, pStyleHeader.StyleNo, pStyleHeader.SizeClass, pStyleHeader.SizeRange, 
    pStyleHeader.Description, pStyleDevelopmentItem.Variation, pStyleHeader.DesignSketchID, pStyleHeader.DesignSketchVersion, 
    pStyleDevelopmentItem.StyleDevelopmentID, pStyleQuoteVariation.StyleQuoteID, pStyleQuoteVariation.StyleQuoteVariationID, 
    pStyleDevelopmentItem.StyleDevelopmentItemID, pStyleQuoteVariation.TradePartnerID, uTradePartner.CostingTypeID, 
    pStyleQuoteVariation.TeamComment, pStyleQuoteVariation.PartnerComment, pStyleQuoteVariation.PdfFileId, 
    pStyleQuoteVariation.PdfUser, pStyleQuoteVariation.PdfDate
FROM   pStyleHeader WITH (NOLOCK) INNER JOIN
    pStyleDevelopmentItem WITH (NOLOCK) ON pStyleHeader.StyleID = pStyleDevelopmentItem.StyleID INNER JOIN
    pStyleQuoteVariation WITH (NOLOCK) ON pStyleHeader.StyleID = pStyleQuoteVariation.StyleID INNER JOIN
    uTradePartner WITH (NOLOCK) ON pStyleQuoteVariation.TradePartnerID = uTradePartner.TradePartnerID
WHERE     
	(pStyleDevelopmentItem.StyleDevelopmentID = @StyleDevelopmentID) AND 
	(pStyleQuoteVariation.StyleQuoteID = @StyleQuoteID) AND 
    (pStyleHeader.StyleID = @StyleID)
	AND pStyleHeader.StyleType  IN  ( SELECT StyleTypeId FROM sAccessQuotationFolder WITH (NOLOCK)    WHERE  TeamID = @TeamID  AND   ( AccessRoleId =  3 OR AccessView = 1)  )



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlan_StyleAttribute_RangeRollup3_Temp_SELECT]'
GO






create PROCEDURE [dbo].[spx_LinePlan_StyleAttribute_RangeRollup3_Temp_SELECT] (
@LinePlanRangeID UNIQUEIDENTIFIER,
@LinePlanStyleAttributeItemID UNIQUEIDENTIFIER
)
AS 


DECLARE
@LinePlanAttributeItemId1 UNIQUEIDENTIFIER,
@LinePlanAttributeItemId2 UNIQUEIDENTIFIER,
@LinePlanAttributeItemId3 UNIQUEIDENTIFIER,
@LinePlanAttributeItemID4 UNIQUEIDENTIFIER,
@LinePlanFinancialSort NVARCHAR(5) ,
@LinePlanRangeAttributeID UNIQUEIDENTIFIER


SELECT @LinePlanAttributeItemID1 = LinePlanAttributeItemID1, @LinePlanAttributeItemID2 = LinePlanAttributeItemID2,
@LinePlanAttributeItemID3 = LinePlanAttributeItemID3, @LinePlanAttributeItemID4 = LinePlanAttributeItemID4	
FROM pLinePlanRange
WHERE LinePlanRangeID = @LinePlanRangeID 


DECLARE
@SLinePlanRangeDelCO1 int, 	@SLinePlanRangeDelNV1 int, 	@SLinePlanRangeDelN1 int, 	@SLinePlanRangeDelTL1 int,
@SLinePlanRangeDelCO2 int,	@SLinePlanRangeDelNV2 int,	@SLinePlanRangeDelN2 int,	@SLinePlanRangeDelTL2 int,
@SLinePlanRangeDelCO3 int,	@SLinePlanRangeDelNV3 int,	@SLinePlanRangeDelN3 int,	@SLinePlanRangeDelTL3 int,
@SLinePlanRangeDelCO4 int,	@SLinePlanRangeDelNV4 int,	@SLinePlanRangeDelN4 int,	@SLinePlanRangeDelTL4 int,
@SLinePlanRangeDelAVCO int,	@SLinePlanRangeDelAVNV int,	@SLinePlanRangeDelAVN int,	@SLinePlanRange VARCHAR(100),
@SLinePlanRangeID UNIQUEIDENTIFIER 


DECLARE
@FLinePlanRangeDelCO1 int, 	@FLinePlanRangeDelNV1 int,	@FLinePlanRangeDelN1 int,	@FLinePlanRangeDelTL1 int,
@FLinePlanRangeDelCO2 int,	@FLinePlanRangeDelNV2 int,	@FLinePlanRangeDelN2 int,	@FLinePlanRangeDelTL2 int,
@FLinePlanRangeDelCO3 int,	@FLinePlanRangeDelNV3 int,	@FLinePlanRangeDelN3 int,	@FLinePlanRangeDelTL3 int,
@FLinePlanRangeDelCO4 int,	@FLinePlanRangeDelNV4 int,	@FLinePlanRangeDelN4 int,	@FLinePlanRangeDelTL4 int,
@FLinePlanRangeDelAVCO int,	@FLinePlanRangeDelAVNV int,	@FLinePlanRangeDelAVN int,	@FLinePlanRange VARCHAR(100),
@FLinePlanRangeID UNIQUEIDENTIFIER  


DECLARE
@BLinePlanRangeDelCO1 int,	@BLinePlanRangeDelNV1 int,	@BLinePlanRangeDelN1 int,	@BLinePlanRangeDelTL1 int,
@BLinePlanRangeDelCO2 int,	@BLinePlanRangeDelNV2 int,	@BLinePlanRangeDelN2 int,	@BLinePlanRangeDelTL2 int,
@BLinePlanRangeDelCO3 int,	@BLinePlanRangeDelNV3 int,	@BLinePlanRangeDelN3 int,	@BLinePlanRangeDelTL3 int,
@BLinePlanRangeDelCO4 int,	@BLinePlanRangeDelNV4 int,	@BLinePlanRangeDelN4 int,	@BLinePlanRangeDelTL4 int,
@BLinePlanRangeDelAVCO int,	@BLinePlanRangeDelAVNV int,	@BLinePlanRangeDelAVN int,	@BLinePlanRange VARCHAR(100),
@BLinePlanRangeID UNIQUEIDENTIFIER  
	 

DECLARE
@CLinePlanRangeDelCO1 int,	@CLinePlanRangeDelNV1 int,	@CLinePlanRangeDelN1 int,	@CLinePlanRangeDelTL1 int,
@CLinePlanRangeDelCO2 int,	@CLinePlanRangeDelNV2 int,	@CLinePlanRangeDelN2 int,	@CLinePlanRangeDelTL2 int,
@CLinePlanRangeDelCO3 int,	@CLinePlanRangeDelNV3 int,	@CLinePlanRangeDelN3 int,	@CLinePlanRangeDelTL3 int,
@CLinePlanRangeDelCO4 int,	@CLinePlanRangeDelNV4 int,	@CLinePlanRangeDelN4 int,	@CLinePlanRangeDelTL4 int,
@CLinePlanRangeDelAVCO int,	@CLinePlanRangeDelAVNV int,	@CLinePlanRangeDelAVN int,	@CLinePlanRange VARCHAR(100),
@CLinePlanRangeID UNIQUEIDENTIFIER  


DECLARE
@OLinePlanRangeDelCO1 int,	@OLinePlanRangeDelNV1 int,	@OLinePlanRangeDelN1 int,	@OLinePlanRangeDelTL1 int,
@OLinePlanRangeDelCO2 int,	@OLinePlanRangeDelNV2 int,	@OLinePlanRangeDelN2 int,	@OLinePlanRangeDelTL2 int,
@OLinePlanRangeDelCO3 int,	@OLinePlanRangeDelNV3 int,	@OLinePlanRangeDelN3 int,	@OLinePlanRangeDelTL3 int,
@OLinePlanRangeDelCO4 int,	@OLinePlanRangeDelNV4 int,	@OLinePlanRangeDelN4 int,	@OLinePlanRangeDelTL4 int,
@OLinePlanRangeDelAVCO int,	@OLinePlanRangeDelAVNV int,	@OLinePlanRangeDelAVN int,	@OLinePlanRange VARCHAR(100),
@OLinePlanRangeID UNIQUEIDENTIFIER  
 
CREATE TABLE #tmpLinePlanRange(
	LinePlanRangeAttributeID UNIQUEIDENTIFIER , 
	LinePlanRangeID uniqueidentifier NULL,
	LinePlanFinancialID uniqueidentifier NULL,
	LinePlanRange nvarchar(100) NULL,
	LinePlanAttributeItemID1 uniqueidentifier NULL,
	LinePlanAttributeItemID2 uniqueidentifier NULL,
	LinePlanAttributeItemID3 uniqueidentifier NULL,
	LinePlanAttributeItemID4 uniqueidentifier NULL,
	LinePlanAttributeText1 nvarchar(100) NULL,
	LinePlanAttributeText2 nvarchar(100) NULL,
	LinePlanAttributeText3 nvarchar(100) NULL,
	LinePlanAttributeText4 nvarchar(100) NULL,
	LinePlanAttributeItemSort1 varchar(5) NULL,
	LinePlanAttributeItemSort2 varchar(5) NULL,
	LinePlanAttributeItemSort3 varchar(5) NULL,
	LinePlanAttributeItemSort4 varchar(5) NULL,
	LinePlanRangeDelCO1 int NULL,
	LinePlanRangeDelNV1 int NULL,
	LinePlanRangeDelN1 int NULL,
	LinePlanRangeDelTL1 int NULL,
	LinePlanRangeDelCO2 int NULL,
	LinePlanRangeDelNV2 int NULL,
	LinePlanRangeDelN2 int NULL,
	LinePlanRangeDelTL2 int NULL,
	LinePlanRangeDelCO3 int NULL,
	LinePlanRangeDelNV3 int NULL,
	LinePlanRangeDelN3 int NULL,
	LinePlanRangeDelTL3 int NULL,
	LinePlanRangeDelCO4 int NULL,
	LinePlanRangeDelNV4 int NULL,
	LinePlanRangeDelN4 int NULL,
	LinePlanRangeDelTL4 int NULL,
	LinePlanRangeDelAVCO int NULL,
	LinePlanRangeDelAVNV int NULL,
	LinePlanRangeDelAVN int NULL,
	LinePlanFinancialSort varchar(5) NULL)


/***************************************************************************************/
-- STYLES 
SET @LinePlanRangeID =  NULL
SELECT @LinePlanRangeID = LinePlanRangeID FROM pLinePlanRange 
WHERE  LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 

----------------------------
-- Reset temp table 
DELETE FROM pLinePlanRangeAttributeTemp 
WHERE LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID 
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 

INSERT INTO pLinePlanRangeAttributeTemp  
SELECT * FROM pLinePlanRangeAttribute
WHERE LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID 
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 
----------------------------


SELECT  @LinePlanRangeAttributeID = LinePlanRangeAttributeID,
@SLinePlanRangeDelCO1 = SUM(LinePlanRangeDelCO1), 	@SLinePlanRangeDelNV1 = SUM(LinePlanRangeDelNV1), 
@SLinePlanRangeDelN1 = SUM(LinePlanRangeDelN1), 	@SLinePlanRangeDelCO2 = SUM(LinePlanRangeDelCO2), 
@SLinePlanRangeDelNV2 = SUM(LinePlanRangeDelNV2), 	@SLinePlanRangeDelN2 = SUM(LinePlanRangeDelN2), 
@SLinePlanRangeDelCO3 = SUM(LinePlanRangeDelCO3), 	@SLinePlanRangeDelNV3 = SUM(LinePlanRangeDelNV3), 
@SLinePlanRangeDelN3 = SUM(LinePlanRangeDelN3), 	@SLinePlanRangeDelCO4 = SUM(LinePlanRangeDelCO4), 
@SLinePlanRangeDelNV4 = SUM(LinePlanRangeDelNV4), 	@SLinePlanRangeDelN4 = SUM(LinePlanRangeDelN4), 
@SLinePlanRangeDelTL1 = SUM(LinePlanRangeDelTL1), 	@SLinePlanRangeDelTL2 = SUM(LinePlanRangeDelTL2), 
@SLinePlanRangeDelTL3 = SUM(LinePlanRangeDelTL3), 	@SLinePlanRangeDelTL4 = SUM(LinePlanRangeDelTL4), 
@SLinePlanRange = LinePlanRange, @LinePlanFinancialSort = LinePlanFinancialSort
FROM pLinePlanRangeAttribute
WHERE LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID 
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'
GROUP BY LinePlanRangeAttributeID, LinePlanRange, LinePlanFinancialSort




INSERT INTO #tmpLinePlanRange (
LinePlanRangeAttributeID ,
LinePlanRangeID,		LinePlanFinancialID, LinePlanRange,
LinePlanRangeDelCO1,	LinePlanRangeDelNV1,	LinePlanRangeDelN1,		LinePlanRangeDelTL1,
LinePlanRangeDelCO2,	LinePlanRangeDelNV2,	LinePlanRangeDelN2,		LinePlanRangeDelTL2,
LinePlanRangeDelCO3,	LinePlanRangeDelNV3,	LinePlanRangeDelN3,		LinePlanRangeDelTL3,
LinePlanRangeDelCO4,	LinePlanRangeDelNV4,	LinePlanRangeDelN4,		LinePlanRangeDelTL4,
LinePlanRangeDelAVCO,	LinePlanRangeDelAVNV,	LinePlanRangeDelAVN,	LinePlanFinancialSort )
VALUES(
@LinePlanRangeAttributeID, 
@LinePlanRangeID ,		'10000000-0000-0000-0000-000000000004', @SLinePlanRange,
@SLinePlanRangeDelCO1,	@SLinePlanRangeDelNV1,	@SLinePlanRangeDelN1,	@SLinePlanRangeDelTL1,
@SLinePlanRangeDelCO2,	@SLinePlanRangeDelNV2,	@SLinePlanRangeDelN2,	@SLinePlanRangeDelTL2,
@SLinePlanRangeDelCO3,	@SLinePlanRangeDelNV3,	@SLinePlanRangeDelN3,	@SLinePlanRangeDelTL3,	
@SLinePlanRangeDelCO4,	@SLinePlanRangeDelNV4,	@SLinePlanRangeDelN4,	@SLinePlanRangeDelTL4,
@SLinePlanRangeDelAVCO,	@SLinePlanRangeDelAVNV,	@SLinePlanRangeDelAVN , @LinePlanFinancialSort)



SELECT #tmpLinePlanRange.*, 
	pLinePlanFinancial.LinePlanFinancialDataType, 
	pLinePlanFinancial.LinePlanFinancialDataFormat, 
	pLinePlanFinancial.LinePlanFinancialCssClass
	FROM #tmpLinePlanRange INNER JOIN
    pLinePlanFinancial ON #tmpLinePlanRange.LinePlanFinancialID = pLinePlanFinancial.LinePlanFinancialID
ORDER BY  #tmpLinePlanRange.LinePlanFinancialSort


DROP TABLE #tmpLinePlanRange




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_DesktopAccessLineFolderCheck_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_User_DesktopAccessLineFolderCheck_INSERT] (
@TeamId uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

IF (SELECT COUNT(*) FROM sAccessLineFolder WITH (NOLOCK) WHERE LineTypeId = 1 AND TeamId = @TeamId) = 0
	BEGIN
		INSERT INTO sAccessLineFolder
			(LineTypeId, TeamId, CUser, CDate, MUser, MDate)
		VALUES (1, @TeamId, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate) 
	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_AccessComplianceFolder_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_Group_AccessComplianceFolder_SELECT] (
@GroupID uniqueidentifier
)
AS 

SELECT     b.ComplianceType, b.ComplianceDescription, a.AccessComplianceFolderID, 
                      a.AccessRoleId, a.AccessView, a.AccessCreate, 
                      a.AccessModify, a.AccessDelete, a.AccessPrint, 
                      a.GroupID , a.CUser, a.CDate, 
                      a.MUser, a.MDate, b.ComplianceOrder
FROM	dbo.sAccessGroupComplianceFolder a WITH (NOLOCK) INNER JOIN  dbo.pComplianceType b WITH (NOLOCK) ON a.ComplianceTypeId = b.ComplianceTypeID
WHERE	a.GroupID = @GroupID 
ORDER BY b.ComplianceOrder , b.ComplianceType



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteVariationAvailable_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_StyleQuoteVariationAvailable_SELECT]
(@TradePartnerID uniqueidentifier,
@StyleDevelopmentId uniqueidentifier,
@StyleQuoteID uniqueidentifier)
AS 

SELECT     dbo.pStyleHeader.StyleID, dbo.pStyleHeader.StyleMasterID, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.SizeClass, dbo.pStyleHeader.SizeRange, 
                      dbo.pStyleHeader.Description, dbo.pStyleHeader.DesignSketchID, dbo.pStyleHeader.DesignSketchVersion, dbo.pStyleDevelopmentItem.Variation, 
                      dbo.pStyleDevelopmentItem.StyleDevelopmentID
FROM         dbo.pStyleHeader WITH (NOLOCK) INNER JOIN
                      dbo.pStyleDevelopmentItem WITH (NOLOCK) ON dbo.pStyleHeader.StyleID = dbo.pStyleDevelopmentItem.StyleID
WHERE 
(dbo.pStyleDevelopmentItem.StyleDevelopmentID = @StyleDevelopmentId) AND 
(dbo.pStyleHeader.StyleID NOT IN (SELECT StyleID FROM pStyleQuoteVariation WITH (NOLOCK) WHERE StyleQuoteID = @StyleQuoteID))
ORDER BY dbo.pStyleDevelopmentItem.Variation, dbo.pStyleHeader.SizeClass ASC



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlan_StyleMaterialVariation_INSERT]'
GO


CREATE PROCEDURE [dbo].[spx_LinePlan_StyleMaterialVariation_INSERT]
(
@LinePlanItemID  UNIQUEIDENTIFIER,
@StyleID uniqueidentifier,
@NewStyleID uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate nvarchar(50)
)
AS


CREATE TABLE #tempStyleMaterials (
RecID int IDENTITY(1,1)  NOT NULL,
StyleMaterialID  uniqueidentifier ROWGUIDCOL  NOT NULL ,
StyleMaterialMasterID uniqueidentifier,
Colorway nvarchar (3),
)


CREATE TABLE #tempCopyStyleMaterials (
	RecID int IDENTITY(1,1)  NOT NULL,
	StyleMaterialID  uniqueidentifier ROWGUIDCOL  NOT NULL ,
	StyleMaterialMasterID uniqueidentifier,
	CopyStyleMaterialID uniqueidentifier,
	MainMaterial int,
	Development bit,
	StyleSet int,
	StyleID uniqueidentifier,
	UOM nvarchar (50),
	Qty nvarchar (18),
	MaterialPrice money,
	Ext money,
	MaterialSize nvarchar (200),
	MaterialID uniqueidentifier,
	MaterialPlacement bit,
	MaterialPlacementCode nvarchar (4),
	MaterialPlacementDetail nvarchar (200),
	MaterialImageID uniqueidentifier,
	MaterialImageVersion int,
	NoColorMatch int,
	SupplierID nvarchar (50),
	ComponentTypeID int,
	MaterialType int,
	MaterialNo nvarchar (50),
	MaterialName nvarchar (200),
	A nvarchar (100),
	B nvarchar (100),
	C nvarchar (100),
	D nvarchar (100),
	E nvarchar (100),
	F nvarchar (100),
	G nvarchar (100),
	H nvarchar (100),
	I nvarchar (100),
	J nvarchar (100),
	K nvarchar (100),
	L nvarchar (100),
	M nvarchar (100),
	N nvarchar (100),
	O nvarchar (100),
	P nvarchar (100),
	Q nvarchar (100),
	R nvarchar (100),
	S nvarchar (100),
	T nvarchar (100),
	U nvarchar (100),
	V nvarchar (100),
	W nvarchar (100),
	X nvarchar (100),
	Y nvarchar (100),
	Z nvarchar (100),
	Source nvarchar (200),
	Notes nvarchar (4000),
	Placement nvarchar (4000),
	VendorPrice decimal(19, 3),
	VolumePrice decimal(19, 3),
	VolumePriceMinimum nvarchar (50),
	VendorProductionMin nvarchar (50),
	VendorProductionLeadTime nvarchar (50),
	DetailYesNo int,
	ImageType nvarchar (50),
	height nvarchar (18),
	width nvarchar (18),
	CDate datetime,
	CUser nvarchar (200),
	MDate datetime,
	MUser nvarchar (200),
	MChange int,
	SChange int,
	DChange int,
	CChange int,
	Action nvarchar (50),
	ColorPlacement nvarchar (4000),
	Artwork nvarchar (3),
	License nvarchar (3),
	Colorway nvarchar (3),
	MaterialSort varchar (5),
	MaterialTrack int,
	MaterialLinked int,
	MaterialLining int,
	MaterialSizeID UNIQUEIDENTIFIER,
	TradePartnerID UNIQUEIDENTIFIER,
	TradePartnerVendorID UNIQUEIDENTIFIER,
	CopyMaterialID UNIQUEIDENTIFIER
)





CREATE TABLE #tempStyleSeasonYear(
RecID INT IDENTITY (1,1),
StyleSeasonYearID UNIQUEIDENTIFIER, 
StyleSeason NVARCHAR(50),  
StyleYear NVARCHAR(50), 
SeasonYearID UNIQUEIDENTIFIER, 
NewStyleSeasonYearID UNIQUEIDENTIFIER
)



DECLARE @Row_Count int
DECLARE @Row_Loop int
DECLARE @Row_Color_Count int
DECLARE @Row_Color_Loop int

DECLARE @Season VARCHAR(100)
DECLARE @Year VARCHAR(100)
DECLARE @SeasonYearID UNIQUEIDENTIFIER
DECLARE @StyleCopyType VARCHAR(50)


	

		
BEGIN

	INSERT INTO #tempStyleMaterials	(StyleMaterialMasterID, StyleMaterialID, Colorway)
	SELECT StyleMaterialMasterId, StyleMaterialID, Colorway
	FROM pStyleMaterials WITH (NOLOCK)
	WHERE (StyleID = @StyleID)


	DECLARE @StyleMaterialMasterID uniqueidentifier
	DECLARE @StyleMaterialID uniqueidentifier
	DECLARE @NewStyleMaterialID uniqueidentifier
	DECLARE @Colorway nvarchar(3)

	SET @Row_Loop = 1
	SET @Row_Count = (SELECT COUNT(*) FROM #tempStyleMaterials)
	
	WHILE @Row_Loop <= @Row_Count 
	BEGIN
		SELECT @StyleMaterialMasterID = StyleMaterialMasterID, @StyleMaterialID = StyleMaterialID, @Colorway = Colorway 
		FROM #tempStyleMaterials WHERE RecID = @Row_Loop
		
		BEGIN
			-- New StyleMaterial in temp table 
			SET @NewStyleMaterialID = newid()
			INSERT INTO #tempCopyStyleMaterials
				(StyleMaterialID, MainMaterial, StyleSet, StyleID, UOM, Qty, MaterialPrice, Ext, MaterialSize, MaterialID, MaterialImageID, 
				MaterialImageVersion, NoColorMatch, SupplierID, ComponentTypeID, MaterialType, MaterialNo, MaterialName, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O,
				P, Q, R, S, T, U, V, W, X, Y, Z, Source, Notes, Placement, VendorPrice, VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, 
				DetailYesNo, ImageType, ColorPlacement, Artwork, License, Colorway, CDate, CUser, MDate, MUser, MChange,  SChange, DChange, 
				CChange, Action, StyleMaterialMasterID, Development, MaterialTrack, MaterialLinked, MaterialSort, MaterialLining , CopyStyleMaterialID, MaterialSizeID, 
				TradePartnerID, TradePartnerVendorID, CopyMaterialID)
			SELECT @NewStyleMaterialID, MainMaterial, StyleSet, @NewStyleID AS StyleID, UOM, 
				Qty, MaterialPrice, Ext, MaterialSize, MaterialID, MaterialImageID, MaterialImageVersion, NoColorMatch, SupplierID, 
				ComponentTypeID, MaterialType, MaterialNo, MaterialName, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S,  T, U, V, W, X, Y, Z,Source, Notes, 
				Placement AS Placement, VendorPrice, VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, DetailYesNo, 
				ImageType, ColorPlacement, Artwork, License, Colorway, @CreatedDate AS CDate, @CreatedBy AS CUser, 
				@CreatedDate AS MDate, @CreatedBy AS MUser, MChange, SChange, DChange, CChange, Action, newid() AS StyleMaterialMasterId , 
				Development, MaterialTrack, MaterialLinked, MaterialSort, MaterialLining, StyleMaterialID  AS CopyStyleMaterialID, MaterialSizeID, 
				TradePartnerID, TradePartnerVendorID, MaterialID
			FROM pStyleMaterials WITH (NOLOCK)
			WHERE (StyleMaterialID = @StyleMaterialID)
				
														
		END			
		SET @Row_Loop = @Row_Loop + 1
	END
END


	INSERT INTO pStyleMaterials (
		StyleMaterialID, MainMaterial, StyleSet, StyleID, UOM, Qty, MaterialPrice, Ext, MaterialSize, MaterialID, MaterialImageID, 
		MaterialImageVersion, NoColorMatch, SupplierID, ComponentTypeID, MaterialType, MaterialNo, MaterialName, 
		A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S,  T, U, V, W, X, Y, Z,
		Source, Notes, Placement, VendorPrice, VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, 
		DetailYesNo, ImageType, ColorPlacement, Artwork, License, Colorway, CDate, CUser, MDate, MUser, MChange,  SChange, DChange, 
		CChange, Action, StyleMaterialMasterID, Development, MaterialTrack, MaterialLinked, MaterialSort, MaterialLining, CopyStyleMaterialID, 
		MaterialSizeID, TradePartnerID, TradePartnerVendorID )
	SELECT 
		StyleMaterialID, MainMaterial, StyleSet, StyleID, UOM, Qty, MaterialPrice, Ext, MaterialSize, MaterialID, MaterialImageID, 
		MaterialImageVersion, NoColorMatch, SupplierID, ComponentTypeID, MaterialType, MaterialNo, MaterialName, 
		A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S,  T, U, V, W, X, Y, Z,
		Source, Notes, Placement, VendorPrice, VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, 
		DetailYesNo, ImageType, ColorPlacement, Artwork, License, Colorway, @CreatedDate, @CreatedBy, @CreatedDate, @CreatedBy, MChange, SChange, DChange, 
		CChange, Action, StyleMaterialMasterID, Development, MaterialTrack, MaterialLinked, MaterialSort, MaterialLining , CopyStyleMaterialID, 
		MaterialSizeID, TradePartnerID, TradePartnerVendorID
	FROM #tempCopyStyleMaterials
	
	
	
	DECLARE @StyleMaterialIDTmp  AS uniqueidentifier   

	SELECT TOP 1 @StyleMaterialIDTmp = StyleMaterialID FROM pStyleMaterials WITH (NOLOCK) 
	WHERE StyleID = @NewStyleID AND MainMaterial = 1 

	UPDATE pStyleHeader SET StyleMaterialID = @StyleMaterialIDTmp
	WHERE StyleID = @NewStyleID





	



BEGIN

	DROP TABLE #tempStyleMaterials
	DROP TABLE #tempCopyStyleMaterials
	DROP TABLE #tempStyleSeasonYear
END














GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleDevelopmentTempNoGen_SELECT]'
GO


CREATE  PROCEDURE [dbo].[spx_StyleDevelopmentTempNoGen_SELECT]
(
@TempId varchar(50)
)
AS 

--************ DISABLE MASTER TEMPID
--BEGIN
--	if exists (select * from dbo.sysobjects where id = object_id(N'#TempId'))
--	drop table #TempId
--END
--
--BEGIN
--	CREATE TABLE #TempId (
--                [ID] [int] IDENTITY(1,1)  NOT NULL,
--		[TempId] [varchar] (50)  NULL ,
--		[TempNo] [varchar] (50)  NULL 
--	) 
--END
--
--BEGIN
--	EXEC ('INSERT INTO #TempId  (TempId, TempNo) SELECT  TempID, TempNo FROM  ' + @TableName  + ' WHERE TempId = ''' + @TempId + '''' )
--	EXEC ('INSERT INTO #TempId  (TempId, TempNo) SELECT  TempID, TempNo FROM  sTempId WHERE TempId = ''' + @TempId + '''' )
--END
--
--
--SELECT MAX(CAST(TempNo as int)) AS TempNo, TempId  FROM #TempId GROUP BY TempId-- WHERE TempId = @TempId
--*********************************************

DECLARE @TempNoCount INT 
SET @TempNoCount = (SELECT MAX(CAST(TempNo as int)) FROM pStyleDevelopment WHERE TempId = @TempID) 

SELECT ISNULL(@TempNoCount,0) + 1 AS TempNo











GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_Material_Link_Yarn_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_Material_Link_Yarn_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[vwx_StyleHeader_StyleDevelopmentItem_SEL]'
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE VIEW [dbo].[vwx_StyleHeader_StyleDevelopmentItem_SEL]

AS

SELECT     pStyleHeader.*

FROM         dbo.pStyleHeader INNER JOIN

                      dbo.pStyleDevelopmentItem ON dbo.pStyleHeader.StyleID = dbo.pStyleDevelopmentItem.StyleID

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_DesktopAccessMaterialFolderCheck_INSERT]'
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[spx_User_DesktopAccessMaterialFolderCheck_INSERT]
(
@TeamId uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

DECLARE @I as int
DECLARE @Row_Count int
DECLARE @ComponentTypeID int
DECLARE @DeskAccessId int
DECLARE @DeskTableName varchar(100)
DECLARE @DeskTableKey varchar(50)


	BEGIN
	CREATE TABLE #TempUserAccess (
		Id int IDENTITY (1, 1) NOT NULL , 
		ComponentTypeID int NOT NULL,
		TeamId uniqueidentifier
	) 
	END

	BEGIN
	
	INSERT INTO #TempUserAccess(ComponentTypeID) SELECT ComponentTypeID FROM pComponentType WITH (NOLOCK)
	
	
	SET @Row_Count = (SELECT COUNT(*) FROM #TempUserAccess)
	
	SET @I = 1

	WHILE @I <= @Row_Count 
		BEGIN

			SELECT @ComponentTypeID = ComponentTypeID FROM #TempUserAccess WHERE ID = @I
			IF (SELECT COUNT(*) FROM sAccessMaterialFolder WITH (NOLOCK) WHERE ComponentTypeId = @ComponentTypeId AND TeamId = @TeamId) = 0
			BEGIN
				INSERT INTO sAccessMaterialFolder
					(ComponentTypeId, TeamId, CUser, CDate, MUser, MDate)
				SELECT ComponentTypeId, @TeamId, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate 
				FROM  #TempUserAccess WHERE Id = @I
			END
				
			SET @I = @I + 1
		END

		SELECT * FROM #tempUserAccess

	END
	




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_AccessControlPanel_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_Group_AccessControlPanel_SELECT](
@GroupID uniqueidentifier
)

AS SELECT     a.ControlPanelID, a.ControlPanelName, b.AccessGroupControlPanelId, 
                      b.AccessRoleId, b.AccessView, b.AccessCreate, 
                      b.AccessModify, b.AccessDelete, b.AccessPrint, 
                      b.GroupID , b.CUser, b.CDate, b.MUser, 
                      b.MDate, a.ControlPanelOrder
FROM         dbo.pControlPanel a WITH (NOLOCK) INNER JOIN
                      dbo.sAccessGroupControlPanel  b WITH (NOLOCK) ON a.ControlPanelID = b.ControlPanelId
WHERE     b.GroupID  = @GroupID 
ORDER BY a.ControlPanelOrder



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_LinePlanColorItem_SEL]'
GO

ALTER VIEW [dbo].[vwx_LinePlanColorItem_SEL]
AS
SELECT     dbo.pLinePlanColorItem.LinePlanRangeID, dbo.pLinePlanColorItem.LinePlanColorItemID, dbo.pLinePlanColorItem.LinePlanColorID, 
dbo.pLinePlanColorItem.LinePlanID, dbo.pLinePlanColorItem.CUser, dbo.pLinePlanColorItem.CDate, dbo.pLinePlanColorItem.MUser, dbo.pLinePlanColorItem.MDate, 
dbo.pColorPalette.ColorPaletteID, dbo.pColorPalette.ColorFolderID, dbo.pColorPalette.ColorCode, dbo.pColorPalette.ColorName, dbo.pColorPalette.ColorSource, 
dbo.pColorPalette.ColorNotes, dbo.pColorPalette.Hex, dbo.pColorPalette.ColorImage, dbo.pColorPalette.ColorImageType, dbo.pColorPalette.CopyColorPaletteID, 
dbo.pColorPalette.Sort,
'<img src="../System/Control/ColorStream.ashx?S=20&CFID=' + CAST(pColorPalette.ColorFolderID AS NVARCHAR(50))
+ '&CPID=' + CAST(pColorPalette.ColorPaletteID AS NVARCHAR(50)) +  '" border="0" />' AS ColorImagePath

FROM         dbo.pColorPalette INNER JOIN
                      dbo.pLinePlanColorItem ON dbo.pColorPalette.ColorPaletteID = dbo.pLinePlanColorItem.ColorPaletteID



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[dpx_StyleTypeBySeasonYear_SELECT]'
GO

CREATE PROCEDURE [dbo].[dpx_StyleTypeBySeasonYear_SELECT]
AS 

SELECT ROW_NUMBER() OVER(ORDER BY pStyleHeader.StyleType DESC) AS 'Row Number', pStyleHeader.StyleType, pStyleType.StyleTypeDescription, COUNT(*) AS COUNT
FROM  pStyleHeader INNER JOIN
  pStyleType ON pStyleHeader.StyleType = pStyleType.StyleTypeID
GROUP BY pStyleHeader.StyleType, pStyleType.StyleTypeDescription
ORDER BY pStyleType.StyleTypeDescription

--HAVING (@Season is null or pStyleHeader.CustomField2 = @Season)
--and (@Year is null or pStyleHeader.CustomField4 = @Year)


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcing_INSERT]'
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[spx_StyleSourcing_INSERT] (
@StyleSourcingID UNIQUEIDENTIFIER,
@StyleID UNIQUEIDENTIFIER,
@CUser NVARCHAR(200),
@CDate DATETIME ,
@SeasonYearID UNIQUEIDENTIFIER,
@TradePartnerVendorID UNIQUEIDENTIFIER
)
AS


IF ( SELECT COUNT(*) FROM pStyleSourcing a
	INNER JOIN pStyleSeasonYear b ON a.StyleSeasonYearID =  b.StyleSeasonYearID
	WHERE b.StyleID = @StyleID 
	AND b.SeasonYearID = @SeasonYearID 
	AND a.TradePartnerVendorID = @TradePartnerVendorID ) = 0 
BEGIN

	DECLARE @StyleSeasonYearID  UNIQUEIDENTIFIER 

	SELECT  @StyleSeasonYearID = StyleSeasonYearID FROM pStyleSeasonYear 
	WHERE StyleID = @StyleID 
	AND SeasonYearID = @SeasonYearID

	INSERT INTO pStyleSourcing  (StyleSourcingID , StyleID , CDate, CUser, MDate, MUser, StyleSeasonYearID ) 
	VALUES (@StyleSourcingID , @StyleID , @CDate, @CUser, @CDate, @CUser, @StyleSeasonYearID ) 
	
	SELECT 0 as iRes
END 
ELSE
	SELECT 1 as iRes




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_DesktopAccessQuotationFolderCheck_INSERT]'
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[spx_User_DesktopAccessQuotationFolderCheck_INSERT]
(
@TeamId uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

DECLARE @I as int
DECLARE @Row_Count int
DECLARE @StyleTypeID int 
DECLARE @DeskAccessId int
DECLARE @DeskTableName varchar(100)
DECLARE @DeskTableKey varchar(50)


	BEGIN
	CREATE TABLE #TempUserAccess (
		Id int IDENTITY (1, 1) NOT NULL , 
		StyleTypeID int NOT NULL,
		TeamId uniqueidentifier
	) 
	END

	BEGIN
	
	INSERT INTO #TempUserAccess( StyleTypeID) SELECT StyleTypeID FROM pStyleType WITH (NOLOCK)
	
	
	SET @Row_Count = (SELECT COUNT(*) FROM #TempUserAccess)
	
	SET @I = 1

	WHILE @I <= @Row_Count 
		BEGIN

			SELECT @StyleTypeID = StyleTypeID FROM #TempUserAccess WHERE ID = @I

			IF (SELECT COUNT(*) FROM sAccessQuotationFolder WITH (NOLOCK) WHERE StyleTypeID = @StyleTypeID  AND TeamID = @TeamId) = 0
			BEGIN
				INSERT INTO sAccessQuotationFolder
					( StyleTypeID, TeamID, CUser, CDate, MUser, MDate)
				SELECT StyleTypeId, @TeamId, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate 
				FROM  #TempUserAccess WHERE Id = @I
			END
				
			SET @I = @I + 1
		END

		SELECT * FROM #tempUserAccess

	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_AccessCosting_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_Group_AccessCosting_SELECT] ( 
@GroupID uniqueidentifier
)
AS 


SELECT a.StyleTypeID, a.StyleTypeDescription, 
	b.AccessCostingId,  b.AccessRoleId, b.AccessView, b.AccessCreate, 
	b.AccessModify, b.AccessDelete, b.AccessPrint, 
	b.GroupID, b.CUser, b.CDate,  b.MUser, 
	b.MDate, a.StyleTypeOrder
FROM  pStyleType a WITH (NOLOCK) INNER JOIN   sAccessGroupCosting b WITH (NOLOCK) ON a.StyleTypeID = b.StyleTypeID
WHERE b.GroupID = @GroupID
ORDER BY a.StyleTypeOrder



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteVariationGroup_SELECT]'
GO


ALTER  PROCEDURE [dbo].[spx_StyleQuoteVariationGroup_SELECT](@StyleDevelopmentID uniqueidentifier,
@StyleQuoteId uniqueidentifier)
AS SELECT DISTINCT 
                      dbo.pStyleDevelopmentItem.Variation, dbo.pStyleDevelopmentItem.StyleDevelopmentID, dbo.pStyleQuoteVariation.StyleQuotaDutyID, 
                      dbo.pStyleQuoteVariation.StyleCostingID, dbo.pStyleQuoteVariation.StyleCostingType, dbo.pStyleQuoteVariation.StyleCostingFreightTypeID, 
                      dbo.pStyleQuoteVariation.StyleID, dbo.pStyleQuoteVariation.StyleQuoteVariationID
FROM         dbo.pStyleDevelopmentItem WITH (NOLOCK) INNER JOIN
                      dbo.pStyleQuoteVariation WITH (NOLOCK) ON dbo.pStyleDevelopmentItem.StyleID = dbo.pStyleQuoteVariation.StyleID
WHERE     (dbo.pStyleQuoteVariation.StyleQuoteID = @StyleQuoteId) AND (dbo.pStyleDevelopmentItem.StyleDevelopmentID = @StyleDevelopmentID)
ORDER BY pStyleDevelopmentItem.Variation




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_LineFolderItem_List_SELECT]'
GO
EXEC sp_refreshview N'[dbo].[vwx_LineFolderItem_List_SELECT]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_DesktopAccessSampleFolderCheck_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_User_DesktopAccessSampleFolderCheck_INSERT]
(
@TeamId uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

DECLARE @I as int
DECLARE @Row_Count int
DECLARE @SampleTypeID nvarchar (5)
DECLARE @DeskAccessId int
DECLARE @DeskTableName varchar(100)
DECLARE @DeskTableKey varchar(50)


	BEGIN
	CREATE TABLE #TempUserAccess (
		Id int IDENTITY (1, 1) NOT NULL , 
		SampleTypeID nvarchar (5)  NOT NULL,
		TeamId uniqueidentifier
	) 
	END

	BEGIN
	
	INSERT INTO #TempUserAccess( SampleTypeID) SELECT SampleWorkflowID FROM pSampleWorkflow WITH (NOLOCK)
	
	
	SET @Row_Count = (SELECT COUNT(*) FROM #TempUserAccess)
	
	SET @I = 1

	WHILE @I <= @Row_Count 
		BEGIN

			SELECT @SampleTypeID =  SampleTypeID FROM #TempUserAccess WHERE ID = @I
			IF (SELECT COUNT(*) FROM sAccessSampleFolder WITH (NOLOCK) WHERE SampleTypeId = @SampleTypeID  AND TeamId = @TeamId) = 0
			BEGIN
				INSERT INTO sAccessSampleFolder
					( SampleTypeId, TeamId, CUser, CDate, MUser, MDate)
				SELECT SampleTypeId, @TeamId, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate 
				FROM  #TempUserAccess WHERE Id = @I
			END
				
			SET @I = @I + 1
		END

		SELECT * FROM #tempUserAccess

	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleColorway_LockingLogic_UPDATE]'
GO
CREATE  PROCEDURE [dbo].[spx_StyleColorway_LockingLogic_UPDATE] (
@StyleID UNIQUEIDENTIFIER, 
@SeasonYearID UNIQUEIDENTIFIER,
@MUser NVARCHAR(200), 
@MDate DATETIME
)
AS

IF ( SELECT COUNT(*) FROM pStyleColorwaySeasonYear 
	WHERE StyleID = @StyleID 
	AND (  SampleStatus = 300  OR StyleColorStatus = 300  )
	) > 0

--IF ( SELECT COUNT(*) FROM pStyleColorwaySeasonYear 
--	WHERE StyleID = @StyleID 
--	AND ( SampleStatus = 200  OR SampleStatus = 300  OR StyleColorStatus = 200 OR StyleColorStatus = 300  )
--	) > 0
BEGIN 


	DECLARE @LockValue INT 
	SET @LockValue  = 1 

	UPDATE pStyleHeader SET HeaderLocked = @LockValue WHERE StyleID = @StyleID 

	UPDATE pMaterial SET HeaderLocked = @LockValue
	WHERE MaterialID  = (
		SELECT   MaterialID 
		FROM pStyleMaterials WHERE StyleID = @StyleID 
		AND MainMaterial = 1 
	)

END 
ELSE 
BEGIN

	-- unlock StyleHeader 
	UPDATE pStyleHeader SET HeaderLocked = 0 WHERE StyleID = @StyleID 

	-- unlock material 
	DECLARE @MaterialID  UNIQUEIDENTIFIER 
	SELECT @MaterialID = MaterialID FROM pStyleMaterials where StyleID = @StyleID   --'3de2e9db-6fa8-4691-abae-6c3b48485457' 
	AND MainMaterial = 1 

	IF ( SELECT COUNT(*) FROM pStyleColorwaySeasonYear 
	WHERE StyleID IN ( SELECT StyleID FROM pStyleMaterials WHERE MaterialID = @MaterialID AND MainMaterial = 1	)
	AND ( SampleStatus = 200  OR SampleStatus = 300  OR StyleColorStatus = 200 OR StyleColorStatus = 300  ) )  = 0 
		UPDATE pMaterial SET HeaderLocked = 0 WHERE MaterialID  = @MaterialID 

END 



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleColorway_LinePlan_LockingLogic_UPDATE]'
GO

CREATE PROCEDURE [dbo].[spx_StyleColorway_LinePlan_LockingLogic_UPDATE] (
@StyleColorwaySeasonYearID UNIQUEIDENTIFIER, 
@MUser NVARCHAR(200), 
@MDate DATETIME
)
AS

DECLARE @StyleID UNIQUEIDENTIFIER 
DECLARE @SeasonYearID UNIQUEIDENTIFIER 

SELECT @StyleID = a.StyleID, @SeasonYearID  = b.SeasonYearID 
FROM pStyleColorwaySeasonYear a
INNER JOIN pStyleSeasonYear b ON a.StyleSeasonYearID = b.StyleSeasonYearID 
WHERE a.StyleColorwaySeasonYearID  = @StyleColorwaySeasonYearID  


EXEC spx_StyleColorway_LockingLogic_UPDATE @StyleID = @StyleID, @SeasonYearID = @SeasonYearID, @MUser = @MUser, @MDate = @MDate 



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanAttributeTable_SELECT]'
GO
CREATE PROCEDURE dbo.spx_LinePlanAttributeTable_SELECT  (
@LinePlanID UNIQUEIDENTIFIER 
) 
AS 

DECLARE @LinePlanTemplateID  UNIQUEIDENTIFIER 
SELECT @LinePlanTemplateID  = LinePlanTemplateID  FROM pLinePlan  WHERE LinePlanID =@LinePlanID

SELECT 	LinePlanTemplateItemId, LinePlanAttributeTableName, LinePlanAttributeXML, LinePlanAttributeTable, 
LinePlanAttributeText, LinePlanAttributeValue, Active, LinePlanTemplateItemSort 
FROM pLinePlanTemplateItem  
WHERE LinePlanTemplateID = @LinePlanTemplateID
AND Active = 1
ORDER BY LinePlanTemplateItemSort




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_MaterialTradePartnerVendor_SELECT]'
GO
ALTER VIEW dbo.vwx_MaterialTradePartnerVendor_SELECT
AS
SELECT     '00000000-0000-0000-0000-000000000000' AS TradePartnerVendorID, 'Factory Sourced' AS VendorName, NULL AS SeasonYearID, NULL 
                      AS MaterialId, NULL AS StyleID, NULL AS StyleMaterialID, 1 AS Active
UNION
SELECT     b.TradePartnerVendorID, b.VendorName, a.SeasonYearID, a.MaterialId, c.StyleID, c.StyleMaterialID, b.Active
FROM         dbo.pMaterialTradePartner AS a INNER JOIN
                      dbo.pStyleMaterials AS c ON c.MaterialID = a.MaterialId INNER JOIN
                      dbo.uTradePartnerVendor AS b ON a.TradepartnerVendorId = b.TradePartnerVendorID
WHERE     ((CAST(a.SeasonYearID AS NVARCHAR(50)) + CAST(c.StyleID AS NVARCHAR(50))) IN
                          (SELECT     CAST(SeasonYearID AS NVARCHAR(50)) + CAST(StyleID AS NVARCHAR(50)) AS Expr1
                            FROM          dbo.pStyleSeasonYear))


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_DesktopAccessStyleFolderCheck_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_User_DesktopAccessStyleFolderCheck_INSERT]
(
@TeamId uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

DECLARE @I as int
DECLARE @Row_Count int
DECLARE @StyleTypeID int 
DECLARE @DeskAccessId int
DECLARE @DeskTableName varchar(100)
DECLARE @DeskTableKey varchar(50)


	BEGIN
	CREATE TABLE #TempUserAccess (
		Id int IDENTITY (1, 1) NOT NULL , 
		StyleTypeID int NOT NULL,
		TeamId uniqueidentifier
	) 
	END

	BEGIN
	
	INSERT INTO #TempUserAccess( StyleTypeID) SELECT StyleTypeID FROM pStyleType WITH (NOLOCK)
	
	
	SET @Row_Count = (SELECT COUNT(*) FROM #TempUserAccess)
	
	SET @I = 1

	WHILE @I <= @Row_Count 
		BEGIN

			SELECT @StyleTypeID = StyleTypeID FROM #TempUserAccess WHERE ID = @I
			IF (SELECT COUNT(*) FROM sAccessStyleFolder WITH (NOLOCK) WHERE StyleTypeId = @StyleTypeID  AND TeamId = @TeamId) = 0
			BEGIN
				INSERT INTO sAccessStyleFolder
					( StyleTypeId, TeamId, CUser, CDate, MUser, MDate)
				SELECT StyleTypeId, @TeamId, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate 
				FROM  #TempUserAccess WHERE Id = @I
			END
				
			SET @I = @I + 1
		END

		SELECT * FROM #tempUserAccess

	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_AccessImageFolder_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_Group_AccessImageFolder_SELECT] (
@GroupID  uniqueidentifier
)
AS 


SELECT a.ImageTypeID,  a.ImageType, b.AccessImageId, 
    b.AccessRoleId,  b.AccessView,  b.AccessCreate,  b.AccessModify, b.AccessDelete, b.AccessPrint, 
    b.GroupID,  b.CUser, b.CDate,  b.MUser, 
    b.MDate,  a.ImageOrder
FROM  pImageType a WITH (NOLOCK) INNER JOIN  sAccessGroupImageFolder  b WITH (NOLOCK)  ON a.ImageTypeID =  b.ImageTypeID
WHERE b.GroupID = @GroupID 
AND a.Active = 1 
ORDER BY a.ImageOrder



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleColorway_LinePlanAvaliable_SELECT]'
GO

/*
Comments:

#01 - Ryan Cabanas - October 29, 2009
	Modified the select to show not only the color name, but also the
color code.
*/


ALTER PROCEDURE [dbo].[spx_StyleColorway_LinePlanAvaliable_SELECT](
@StyleID UNIQUEIDENTIFIER,
@SeasonYearID UNIQUEIDENTIFIER
)
AS


DECLARE @LinePlanItemID UNIQUEIDENTIFIER 
DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER 
DECLARE @LinePlanStyleRangeID UNIQUEIDENTIFIER 
DECLARE @LinePlanColorRangeID UNIQUEIDENTIFIER 
DECLARE @LinePlanAttributeItemID1 UNIQUEIDENTIFIER 
DECLARE @LinePlanAttributeItemID2 UNIQUEIDENTIFIER 
DECLARE @LinePlanAttributeItemID3 UNIQUEIDENTIFIER 

SELECT  @LinePlanItemID = LinePlanItemID, @StyleSeasonYearID = StyleSeasonYearID 
FROM pStyleSeasonYear
WHERE StyleID = @StyleID
AND SeasonYearID = @SeasonYearID


IF @LinePlanItemID IS NOT NULL  
BEGIN 
	SELECT @LinePlanStyleRangeID = LinePlanRangeID 
	FROM pLinePlanItem where LinePlanItemId = @LinePlanItemID

	SELECT @LinePlanAttributeItemID1 = LinePlanAttributeItemID1, 
	@LinePlanAttributeItemID2 = LinePlanAttributeItemID2, 
	@LinePlanAttributeItemID3 = LinePlanAttributeItemID3
	FROM pLinePlanRange 
	WHERE LinePlanRangeID = @LinePlanStyleRangeID

	SELECT @LinePlanColorRangeID  = LinePlanRangeID 
	FROM pLinePlanRange 
	WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000002'
	AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
	AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
	AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3

	SELECT a.ColorPaletteID
		,b.ColorCode
		,b.ColorName + ' (' + b.ColorCode + ')' AS ColorName		--Comment #01
	FROM pLinePlanColorItem  a
	INNER JOIN pColorPalette b ON a.ColorPaletteID  = b.ColorPaletteID 
	WHERE a.LinePlanRangeID = @LinePlanColorRangeID
	AND ISNULL(b.ColorCode,'') + ISNULL( b.ColorName,'') NOT IN ( 
		SELECT ISNULL(c.ColorCode,'') + ISNULL( c.ColorName,'') 
		FROM pStyleColorwaySeasonYear a
		INNER JOIN pStyleColorway b ON a.StyleColorwayID =  b.StyleColorID 
		INNER JOIN pColorPalette c ON c.ColorPaletteID = b.ColorPaletteID
		WHERE a.StyleSeasonYearID = @StyleSeasonYearID
	)
	Order BY b.ColorName

END 
ELSE
	SELECT ColorPaletteID, ColorCode, ColorName
	FROM pColorPalette WHERE 1 =2 









GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_StyleWorkflowItems]'
GO
EXEC sp_refreshview N'[dbo].[vwx_StyleWorkflowItems]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanAttributeTableList_SELECT]'
GO



ALTER PROCEDURE [dbo].[spx_LinePlanAttributeTableList_SELECT]
(
@LinePlanId varchar(50),
@LinePlanTemplateItemId varchar(50) ,
@TeamID UNIQUEIDENTIFIER 
)
AS 

DECLARE @LinePlanAttributeTable varchar(200)
DECLARE @LinePlanAttributeText varchar(200)
DECLARE @LinePlanAttributeValue VARCHAR(200) 
DECLARE @LinePlanAttributeSql varchar(4000)
DECLARE @LinePlanTemplateItemSort INT 
DECLARE @LinePlanTemplateID UNIQUEIDENTIFIER 
DECLARE @Count INT

SET  @Count = 0

SELECT @LinePlanAttributeValue = LinePlanAttributeValue, @LinePlanAttributeTable = LinePlanAttributeTable,
@LinePlanAttributeText = LinePlanAttributeText,
@LinePlanTemplateItemSort = CAST ( LinePlanTemplateItemSort AS INT ),
@LinePlanTemplateID  = LinePlanTemplateID
FROM pLinePlanTemplateItem WHERE (LinePlanTemplateItemId = @LinePlanTemplateItemId)



DECLARE @TOTAL  INT 
SELECT @TOTAL   = COUNT(*) 
FROM pLinePlanAttribute 
WHERE  LinePlanTemplateItemId = @LinePlanTemplateItemId 
AND LinePlanID =  @LinePlanID 


IF @LinePlanTemplateItemSort = 1 
BEGIN
	-- Check for permissions
	SELECT DISTINCT CustomID INTO #tmp 
	FROM sAccessGroupLinePlanFolder a
	WHERE a.LinePlanTemplateID = @LinePlanTemplateID
	AND ( AccessRoleID =  3 OR AccessHierNew = 1)
	AND a.GroupID  IN (
		SELECT GroupID FROM uUserGroup WHERE TeamID = @TeamID
	) 
	SELECT @Count = COUNT(*) FROM #tmp

END 

IF @TOTAL> 0 
BEGIN 
	SET @LinePlanAttributeSql = 'SELECT * FROM ' + @LinePlanAttributeTable + ' WHERE Active = 1 AND  '
	+ @LinePlanAttributeValue + ' NOT IN (SELECT LinePlanAttributeValue FROM pLinePlanAttribute WHERE  LinePlanTemplateItemId = ''' + @LinePlanTemplateItemId +
	 ''' AND LinePlanID =  ''' + @LinePlanID + ''') ' 

	IF @LinePlanTemplateItemSort = 1 AND @Count > 0 
		SET @LinePlanAttributeSql = @LinePlanAttributeSql + '  AND '   + @LinePlanAttributeValue + ' IN ( SELECT CustomID FROM #tmp  ) '
 	
	 SET @LinePlanAttributeSql = @LinePlanAttributeSql + ' ORDER BY ' + @LinePlanAttributeText
END 
ELSE
BEGIN 
	SET @LinePlanAttributeSql = 'SELECT * FROM ' + @LinePlanAttributeTable + ' WHERE Active = 1 ' 
	IF @LinePlanTemplateItemSort = 1 AND @Count > 0 	
		SET @LinePlanAttributeSql = @LinePlanAttributeSql + '  AND '   + @LinePlanAttributeValue + ' IN ( SELECT CustomID FROM #tmp  ) '

	SET @LinePlanAttributeSql = @LinePlanAttributeSql + ' ORDER BY ' + @LinePlanAttributeText
END 

print @LinePlanAttributeSql
EXEC (@LinePlanAttributeSql)

IF @LinePlanTemplateItemSort = 1 
	DROP TABLE #tmp






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_DesktopFolderAccess_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_User_DesktopFolderAccess_SELECT]
(@DeskUserAccessId uniqueidentifier)
AS SELECT     dbo.cDesktopFolder.DeskFolderName, dbo.cDeskUserFolderAccess.DeskAccessId, dbo.cDeskUserFolderAccess.TeamId, 
                      dbo.cDesktopFolder.DeskFolderId, dbo.cDeskUserFolderAccess.DeskUserAccessId
FROM         dbo.cDesktopFolder WITH (NOLOCK) INNER JOIN
                      dbo.cDeskUserFolderAccess WITH (NOLOCK) ON dbo.cDesktopFolder.DeskFolderId = dbo.cDeskUserFolderAccess.DeskFolderId
WHERE     (dbo.cDeskUserFolderAccess.DeskUserAccessId = @DeskUserAccessId)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_AccessLineFolder_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_Group_AccessLineFolder_SELECT] (
@GroupID uniqueidentifier
)
AS 


SELECT 1 AS LineTypeID, 'Line Folder' AS LineFolder,  AccessLineId,  AccessRoleId,  AccessView, AccessCreate, 
    AccessModify, AccessDelete, AccessPrint,  GroupID, CUser,  CDate, MUser,  MDate  
FROM  sAccessGroupLineFolder WITH (NOLOCK) 
WHERE GroupID = @GroupID



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_User_DesktopAccessFolderCheck_INSERT]'
GO




ALTER PROCEDURE [dbo].[spx_User_DesktopAccessFolderCheck_INSERT]
(
@TeamId uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

DECLARE @I as int
DECLARE @Row_Count int
DECLARE @DeskFolderId int 
DECLARE @DeskAccessId int

SET @DeskAccessId = 0
SET @I = 1

	BEGIN
	CREATE TABLE #TempUserAccess (
		Id int IDENTITY (1, 1) NOT NULL , 
		DeskFolderId int NOT NULL 
	) 
	END


	BEGIN
	
	INSERT INTO #TempUserAccess
		(DeskFolderId)
	SELECT DeskFolderId FROM cDesktopFolder WITH (NOLOCK) 

	--EXEC('SELECT DeskFolderId INTO #TempUserAccess FROM cDesktopFolder WITH (NOLOCK)')
	
	SET @Row_Count = (SELECT COUNT(*) FROM #TempUserAccess)

	WHILE @I <= @Row_Count 
		BEGIN

			SELECT @DeskFolderId = DeskFolderId FROM #TempUserAccess WHERE ID = @I
			IF (SELECT COUNT(*) FROM cDeskUserFolderAccess WITH (NOLOCK) WHERE DeskFolderId = @DeskFolderId AND TeamId = @TeamID) = 0
			BEGIN
				INSERT INTO cDeskUserFolderAccess
					(DeskFolderId, DeskAccessId, TeamId, CUser, CDate, MUser, MDate)
				SELECT @DeskFolderId, @DeskAccessId, @TeamId, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate 
				FROM  cDesktopFolder WITH (NOLOCK) WHERE DeskFolderId = @DeskFolderId
			END
				
			SET @I = @I + 1
		END

		SELECT * FROM #tempUserAccess

	END
	





set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanAttributeTableList_SELECTED]'
GO

ALTER PROCEDURE [dbo].[spx_LinePlanAttributeTableList_SELECTED](
@LinePlanId varchar(40),
@LinePlanTemplateItemId varchar(40),
@TeamID UNIQUEIDENTIFIER 
)
AS 

/*
DECLARE @LinePlanId varchar(40)
DECLARE @LinePlanTemplateItemId varchar(40)
DECLARE @TeamID UNIQUEIDENTIFIER 

SET @linePlanId=N'b7c141b0-aee5-448b-b1a0-6fd11106e186'
SET @LinePlanTemplateItemId=N'70000000-0000-0000-0001-000000000002'
SET @TeamID=N'1e37969e-e790-49c9-8341-999999999999'
*/

DECLARE @LinePlanAttributeTable varchar(200)
DECLARE @LinePlanAttributeText varchar(200)
DECLARE @LinePlanAttributeValue VARCHAR(200) 
DECLARE @LinePlanAttributeSql varchar(4000)
DECLARE @LinePlanTemplateItemSort INT 
DECLARE @LinePlanTemplateID UNIQUEIDENTIFIER 
DECLARE @Count INT
SET  @Count = 0




SELECT @LinePlanAttributeValue = LinePlanAttributeValue, @LinePlanAttributeTable = LinePlanAttributeTable,
@LinePlanAttributeText = LinePlanAttributeText,
@LinePlanTemplateItemSort = CAST ( LinePlanTemplateItemSort AS INT ),
@LinePlanTemplateID  = LinePlanTemplateID
FROM pLinePlanTemplateItem WHERE (LinePlanTemplateItemId = @LinePlanTemplateItemId)




IF @LinePlanTemplateItemSort = 1 
BEGIN
	-- Check for permissions
	SELECT DISTINCT CustomID INTO #tmp 
	FROM sAccessGroupLinePlanFolder a
	WHERE a.LinePlanTemplateID = @LinePlanTemplateID
	AND ( AccessRoleID =  3 OR AccessHierNew = 1 OR AccessHierDelete = 1 )
	AND a.GroupID  IN (
		SELECT GroupID FROM uUserGroup WHERE TeamID = @TeamID
	) 
	SELECT @Count = COUNT(*) FROM #tmp
	
END 



IF @LinePlanTemplateItemSort = 1 AND @Count = 0 
BEGIN
	SET @LinePlanAttributeSql = 'SELECT NULL AS ' + @LinePlanAttributeValue + ' ,  NULL AS ' + @LinePlanAttributeText  + ' WHERE 1 = 2 ' 
END 
ELSE 
BEGIN 

	SET @LinePlanAttributeSql = 'SELECT ' + @LinePlanAttributeValue + ', ' + @LinePlanAttributeText 
	+ ' FROM ' + @LinePlanAttributeTable + ' WHERE Active = 1 AND 	 ' 
	+ @LinePlanAttributeValue + ' IN (SELECT LinePlanAttributeValue FROM pLinePlanAttribute WHERE  LinePlanTemplateItemId = ''' 
	+ @LinePlanTemplateItemId + ''' AND LinePlanID =  ''' + @LinePlanID + ''')  '

	IF @LinePlanTemplateItemSort = 1 AND @Count > 0 
		SET @LinePlanAttributeSql = @LinePlanAttributeSql + '  AND '   + @LinePlanAttributeValue + ' IN ( SELECT CustomID FROM #tmp  ) '

	SET @LinePlanAttributeSql  = @LinePlanAttributeSql   + 'ORDER BY ' + @LinePlanAttributeText + ''
END 

EXEC (@LinePlanAttributeSql)


IF @LinePlanTemplateItemSort = 1 
	DROP TABLE #tmp







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialRequestWorkflow_INSERT]'
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE PROCEDURE [dbo].[spx_MaterialRequestWorkflow_INSERT] (
@MaterialRequestWorkflowID VARCHAR(5),
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS 

INSERT INTO pMaterialRequestWorkflow(MaterialRequestWorkflowID, 
MaterialRequestSubmitSchema, MaterialRequestWorkflowSchema, MaterialRequestWorkflowItemSchema, MaterialRequestWorkflowControlSchema,
CUser, CDate, MUser, MDate) 
VALUES (@MaterialRequestWorkflowID, 
'Material_RequestSubmit.xml', 'Material_RequestSubmitItem.xml', 'Material_RequestWorkflowItem.xml', 'Control_MaterialRequestWorkflowItem_Default.xml',
@CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate)

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_UserSession_UPDATE]'
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [dbo].[spx_UserSession_UPDATE]
(
@TeamID uniqueidentifier,
@SESSION varchar(50), 
@SESSIONDATE datetime, 
@SESSIONOS varchar(50), 
@SESSIONWIDTH int, 
@SESSIONHEIGHT int,
@IP varchar(50)
)
AS 

BEGIN
	UPDATE Users SET 
		SESSION = @SESSION, 
		SESSIONDATE = @SESSIONDATE, 
		SESSIONOS = @SESSIONOS, 
		SCREENWIDTH = @SESSIONWIDTH, 
		SCREENHEIGHT = @SESSIONHEIGHT,
		IP = @IP 
	WHERE TeamId = @TeamId
END

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleColorway_Logic_INSERT]'
GO
/*
'***********************************************************************
' Object name	   : spx_StyleColorway_Logic_INSERT
' Author           : Artemio Gomez
' Created          : 12-11-2009
'
' Last Modified By : Artemio Gomez
' Last Modified On : 12-11-2009
' Description      : Every time a colorway is added to a style, the Sourcing items are created automatically
'
' Copyright        : (c) Yunique Solutions, Inc. All rights reserved.
'***********************************************************************
*/

CREATE PROCEDURE [dbo].[spx_StyleColorway_Logic_INSERT](
@StyleSeasonYearID UNIQUEIDENTIFIER, 
@StyleColorID UNIQUEIDENTIFIER, 
@CUser NVARCHAR(200),
@CDate DATETIME
)
AS 



DECLARE @ROW_ID INT
DECLARE @TOTAL INT
DECLARE @StyleSourcingID UNIQUEIDENTIFIER 
DECLARE @TradePartnerID UNIQUEIDENTIFIER
DECLARE @TradePartnerVendorID UNIQUEIDENTIFIER

DECLARE @StyleID UNIQUEIDENTIFIER 
DECLARE @DevelopmentID UNIQUEIDENTIFIER 

SELECT @StyleID = a.StyleID, @DevelopmentID = a.DevelopmentID 
FROM pStyleHeader a
INNER JOIN pStyleColorway b ON a.StyleID = b.StyleID 
WHERE b.StyleColorID = @StyleColorID


/**
** Get Style Sourcings
**/
CREATE TABLE #ss(
ROW_ID INT IDENTITY(1,1),
StyleSourcingID UNIQUEIDENTIFIER,
TradePartnerID UNIQUEIDENTIFIER,
TradePartnerVendorID UNIQUEIDENTIFIER
)

INSERT INTO #ss (StyleSourcingID, TradePartnerID, TradePartnerVendorID)
SELECT StyleSourcingID, TradePartnerID, TradePartnerVendorID FROM pStyleSourcing WHERE StyleSeasonYearID = @StyleSeasonYearID 

SELECT @TOTAL = COUNT(*) FROM #ss
SET @ROW_ID = 1 


WHILE @ROW_ID <= @TOTAL
BEGIN 
	SELECT @StyleSourcingID = StyleSourcingID, @TradePartnerID = TradePartnerID, @TradePartnerVendorID = TradePartnerVendorID
	FROM #ss WHERE ROW_ID = @ROW_ID 

	/**
	** Call SP to insert StyleSourcingItems
	**/
	EXEC spx_StyleSourcingLogic_INSERT @StyleSourcingID = @StyleSourcingID,
	@StyleColorID = @StyleColorID, @MDate = @CDate, @MUser = @CUser
	
	/**
	** Check for existing costing (Default costing type: FOB)
	**/
	CREATE TABLE #ct (
		StyleCostingID UNIQUEIDENTIFIER, 
		StyleID UNIQUEIDENTIFIER, 
		StyleCostingType NVARCHAR(10),
		Custon NVARCHAR(200), 
		CustomIcon NVARCHAR(200), 
		StyleCostingTypeID INT
	)
		
	INSERT INTO #ct 
	EXEC spx_StyleSourcingCostingDropDownLogic_SELECT @TradePartnerID=@TradePartnerID,
	@StyleID=@StyleID,@StyleSourcingID=@StyleSourcingID
	
	DECLARE @StyleCostingTypeID INT 
	DECLARE @StyleCostingID UNIQUEIDENTIFIER
	
	SELECT @StyleCostingTypeID = StyleCostingTypeID, @StyleCostingID = StyleCostingID FROM #ct WHERE StylecostingType = 'FOB'
	IF @StyleCostingTypeID IS NULL
	BEGIN
		SELECT TOP 1 @StyleCostingTypeID  = StyleCostingTypeID, @StyleCostingID = StyleCostingID FROM #ct 
	END 
	
	DROP TABLE #ct
	
	
	IF @StyleCostingTypeID IS NULL
		RETURN
	
	/**
	** Create the Stylequote item 
	**/
	
		-- Create RFQ Item
		DECLARE @StyleQuoteID UNIQUEIDENTIFIER 
		EXEC spx_StyleSourcingQuote_CHECK_INSERT @TradePartnerID = @TradePartnerID, @StyleDevelopmentID = @DevelopmentID, 
		@CreatedDate = @CDate,  @CreatedBy = @CUser, @OUTPUT = 0, @StyleQuoteID = @StyleQuoteID output
				

		-- Execute StyleQuote Logic Update				
		EXEC spx_StyleQuoteLogic_UPDATE @StyleQuoteID = @StyleQuoteID, @ModifiedBy = @CUser, @ModifiedDate = @CDate

		
											
		-- Insert StyleQuote Variation
		DECLARE @StyleQuoteVariationID UNIQUEIDENTIFIER 
		EXEC spx_StyleSourcingQuoteVariation_CHECK_INSERT
		@StyleCostingID = @StyleCostingID ,
		@StyleID = @StyleID,
		@StyleQuoteID = @StyleQuoteID,
		@StyleDevelopmentID = @DevelopmentID,
		@TradePartnerID = @TradePartnerID,
		@CreatedBy = @CUser,
		@CreatedDate = @CDate,
		@OUTPUT = 0,
		@StyleQuoteVariationID = @StyleQuoteVariationID OUTPUT
				
SELECT @StyleQuoteVariationID		 AS StyleQuoteVariationID

		-- Insert StyleQuoteItem / Color 
		DECLARE @StyleQuoteItemID UNIQUEIDENTIFIER 
		SET @StyleQuoteItemID = NEWID()
		
		EXEC spx_StyleSourcingQuoteItemTradePartner_INSERT
		@StyleQuoteItemID = @StyleQuoteItemID,
		@StyleQuoteVariationID = @StyleQuoteVariationID,
		@TradePartnerVendorID = @TradePartnerVendorID,
		@StyleColorID = @StyleColorID,
		@StyleSourcingID = @StyleSourcingID,
		@CreatedBy = @CUser,
		@CreatedDate = @CDate
						
		-- Execute Logic
		EXEC spx_StyleSourcingQuoteItemNew_Logic_UPDATE @StyleQuoteItemID = @StyleQuoteItemID,
		@MUser = @CUser,
		@MDate = @CDate
	
	SET @ROW_ID = @ROW_ID + 1 
END 



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanBusinessGroup_SELECT]'
GO


ALTER PROCEDURE [dbo].[spx_LinePlanBusinessGroup_SELECT]
(
@LinePlanId varchar(40),
@LinePlanIndex varchar(1),
@LinePlanAttributeItemId varchar(40)
)
AS 


DECLARE @LineRollup INT
DECLARE @LineHIndex INT 

SELECT @LineHIndex  = COUNT(*) FROM pLinePlanTemplateItem a 
INNER JOIN pLinePlan b ON a.LinePlanTemplateID = b.LinePlanTemplateID 
WHERE b.LinePlanID = @LinePlanId  AND a.Active =  1


IF @LinePlanIndex = @LineHIndex
BEGIN
	SET @LineRollup = 0
END
ELSE
BEGIN
	SET @LineRollup = 1
END

IF @LinePlanIndex = '1'
	BEGIN
		SELECT LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3, LinePlanAttributeItemID4, LinePlanAttributeText1, 
		  LinePlanAttributeText2, LinePlanAttributeText3, LinePlanAttributeText4, @LineRollup AS LinePlanRollup
		FROM  pLinePlanBusiness WITH(NOLOCK)
		WHERE (LinePlanID = @LinePlanId) AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID
		GROUP BY LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3, LinePlanAttributeItemID4, LinePlanAttributeText1, 
		  LinePlanAttributeText2, LinePlanAttributeText3, LinePlanAttributeText4, LinePlanAttributeItemSort1, LinePlanAttributeItemSort2, 
		  LinePlanAttributeItemSort3
		ORDER BY LinePlanAttributeItemSort1, LinePlanAttributeItemSort2, LinePlanAttributeItemSort3

	END
ELSE IF @LinePlanIndex = '2'
	BEGIN 
		SELECT LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3, LinePlanAttributeItemID4, LinePlanAttributeText1, 
		  LinePlanAttributeText2, LinePlanAttributeText3, LinePlanAttributeText4, @LineRollup AS LinePlanRollup
		FROM  pLinePlanBusiness WITH(NOLOCK)
		WHERE (LinePlanID = @LinePlanId) AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID
		GROUP BY LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3, LinePlanAttributeItemID4, LinePlanAttributeText1, 
		  LinePlanAttributeText2, LinePlanAttributeText3, LinePlanAttributeText4, LinePlanAttributeItemSort1, LinePlanAttributeItemSort2, 
		  LinePlanAttributeItemSort3
		ORDER BY LinePlanAttributeItemSort1, LinePlanAttributeItemSort2, LinePlanAttributeItemSort3
	END
ELSE IF @LinePlanIndex = '3'
	BEGIN 
		SELECT LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3, LinePlanAttributeItemID4, LinePlanAttributeText1, 
		  LinePlanAttributeText2, LinePlanAttributeText3, LinePlanAttributeText4, @LineRollup AS LinePlanRollup
		FROM  pLinePlanBusiness WITH(NOLOCK)
		WHERE (LinePlanID = @LinePlanId) AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID
		GROUP BY LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3, LinePlanAttributeItemID4, LinePlanAttributeText1, 
		  LinePlanAttributeText2, LinePlanAttributeText3, LinePlanAttributeText4, LinePlanAttributeItemSort1, LinePlanAttributeItemSort2, 
		  LinePlanAttributeItemSort3
		ORDER BY LinePlanAttributeItemSort1, LinePlanAttributeItemSort2, LinePlanAttributeItemSort3
	END
ELSE IF @LinePlanIndex = '4'
	BEGIN 
		SELECT LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3, LinePlanAttributeItemID4, LinePlanAttributeText1, 
		  LinePlanAttributeText2, LinePlanAttributeText3, LinePlanAttributeText4, @LineRollup AS LinePlanRollup
		FROM  pLinePlanBusiness WITH(NOLOCK)
		WHERE (LinePlanID = @LinePlanId) AND LinePlanAttributeItemID4 = @LinePlanAttributeItemID
		GROUP BY LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3, LinePlanAttributeItemID4, LinePlanAttributeText1, 
		  LinePlanAttributeText2, LinePlanAttributeText3, LinePlanAttributeText4, LinePlanAttributeItemSort1, LinePlanAttributeItemSort2, 
		  LinePlanAttributeItemSort3
		ORDER BY LinePlanAttributeItemSort1, LinePlanAttributeItemSort2, LinePlanAttributeItemSort3
	END








GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_LineFolder_MainMaterial_Image_SELECT]'
GO


/******************
 * 4/25/2007 - 11:24pm EST - Ryan Cabanas - In the first INSERT SELECT statement, I added "OR b.LineFolderItemColorDrop IS NULL"
 * to the end of the JOIN.
 *****************/


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.  Needed to add the 'Version' field to the temp table for
the image stream and get the 'Version' from 'hImage' to put in the temp table.

#02 - Ryan Cabanas - September 23, 2009
	Replace the old color image string with the new color image string using function.
Deleted old code.
*/


ALTER           PROCEDURE [dbo].[rpx_LineFolder_MainMaterial_Image_SELECT]
( 
	@LineFolderID varchar(50),
	@StyleID varchar(50)
)
AS

DECLARE @TotalCount int
DECLARE @RowCounter int
DECLARE @StyleColorID nvarchar(50)
DECLARE @StyleColorName nvarchar(200)
DECLARE @StyleColorNo nvarchar(10)


CREATE TABLE #tempStyleColorways
(
	TableRow int identity(1,1),
	StyleColorID varchar(50),
	StyleID varchar(50),
	StyleColorName nvarchar(200),
	StyleColorNo nvarchar(10)
)

CREATE TABLE #tempMainMaterialImages
(
	TableRow int identity(0,1),
	FilePath varchar(255),
	StyleID varchar(50),
	ColorName nvarchar(150),
	ColorCode nvarchar(50),
	ColorFolderID varchar(50),
	ColorPaletteID varchar(50),
	MainColor nvarchar(50),
	MainColorNo nvarchar(10),
	NoImage int,
	ImageID varchar(50),
	ImageHistoryID varchar(50),
	[Version] int	--Comment #01
)

/*Get the colorways that are active for the style.*/
INSERT INTO #tempStyleColorways (StyleColorID, StyleID, StyleColorNo, StyleColorName)
SELECT a.StyleColorID, a.StyleID, a.StyleColorNo, a.StyleColorName
FROM pStyleColorway a INNER JOIN pLineFolderItemColor b ON
a.StyleID = b.StyleID AND a.StyleColorID = b.StyleColorID AND
(b.LineFolderItemColorDrop = 0 OR b.LineFolderItemColorDrop IS NULL)
WHERE b.LineFolderID = @LineFolderID AND b.StyleID = @StyleID
ORDER BY a.Sort, a.StyleColorName, a.StyleColorID

/*Get the count and set the counter.*/
SELECT @TotalCount = COUNT(*) FROM #tempStyleColorways
SET @RowCounter = 1

/*Begin loop to get final record data one at a time in order to capture blanks, as well.*/
WHILE (@RowCounter <= @TotalCount)
	BEGIN
		/*Get the active colorways one at a time.*/
		SELECT
			@StyleColorID = StyleColorID,
			@StyleColorName = StyleColorName,
			@StyleColorNo = StyleColorNo
		FROM #tempStyleColorways
		WHERE TableRow = @RowCounter

		/*Put a real, or bogus, record into the temp table.*/
		IF (SELECT COUNT(*)
			FROM pStyleColorwayItem INNER JOIN pMaterialColor ON
				pStyleColorwayItem.MaterialColorID = pMaterialColor.MaterialColorID INNER JOIN pStyleColorway ON
				pStyleColorwayItem.StyleColorID = pStyleColorway.StyleColorID INNER JOIN pLineFolderItemColor ON
				pStyleColorway.StyleColorID = pLineFolderItemColor.StyleColorID INNER JOIN pStyleMaterials ON
				pStyleColorwayItem.StyleMaterialID = pStyleMaterials.StyleMaterialID LEFT OUTER JOIN pLineFolderItem ON
				pLineFolderItemColor.LineFolderItemID = pLineFolderItem.LineFolderItemID
			WHERE	(pStyleMaterials.MainMaterial = 1) AND (pLineFolderItemColor.LineFolderID = @LineFolderID) AND
					(pLineFolderItemColor.StyleID = @StyleID) AND (pLineFolderItemColor.StyleColorID = @StyleColorID)
		   ) = 0
			BEGIN
				/*Put a blank in for Styles that have no images.*/
				INSERT INTO #tempMainMaterialImages (StyleID, ColorName, ColorCode,	ColorFolderID, ColorPaletteID, MainColor, MainColorNo, NoImage, ImageID, ImageHistoryID, [Version])	--Comment #01
				VALUES (@StyleID, NULL, NULL, NULL, NULL, @StyleColorName, @StyleColorNo, 1, NULL, NULL, NULL)	--Comment #01
		
			END
		ELSE
			BEGIN
				/*Put records in for Main Materials with chips.*/
				INSERT INTO #tempMainMaterialImages (StyleID, ColorName, ColorCode,	ColorFolderID, ColorPaletteID, MainColor, MainColorNo, NoImage, ImageID, ImageHistoryID, [Version])	--Comment #01
				SELECT
					pLineFolderItemColor.StyleID, 
					pMaterialColor.ColorName,
					pMaterialColor.ColorCode,
					pMaterialColor.ColorFolderID,
					pMaterialColor.ColorPaletteID,
					pStyleColorway.MainColor,
					pStyleColorway.StyleColorNo,
					0 AS NoImage,
					i.ImageID,
					i.ImageHistoryID,
					i.[Version]	--Comment #01
				FROM pStyleColorwayItem INNER JOIN
					pMaterialColor ON pStyleColorwayItem.MaterialColorID = pMaterialColor.MaterialColorID INNER JOIN
					pStyleColorway ON pStyleColorwayItem.StyleColorID = pStyleColorway.StyleColorID INNER JOIN
					pLineFolderItemColor ON pStyleColorway.StyleColorID = pLineFolderItemColor.StyleColorID INNER JOIN
					pStyleMaterials ON pStyleColorwayItem.StyleMaterialID = pStyleMaterials.StyleMaterialID LEFT OUTER JOIN
					pLineFolderItem ON pLineFolderItemColor.LineFolderItemID = pLineFolderItem.LineFolderItemID LEFT OUTER JOIN 
					hImage i on pMaterialColor.MaterialColorImageID = i.ImageID and pMaterialColor.MaterialColorImageVersion = i.Version
				WHERE	(pStyleMaterials.MainMaterial = 1) AND (pLineFolderItemColor.LineFolderID = @LineFolderID) AND
						(pLineFolderItemColor.StyleID = @StyleID) AND (pLineFolderItemColor.StyleColorID = @StyleColorID)

			END

		SET @RowCounter = @RowCounter + 1
	END

/*Create the URL for the Images.*/
UPDATE #tempMainMaterialImages
SET FilePath = dbo.fnx_GetStreamingColorImagePath(ColorFolderID, ColorPaletteID)	--Comment #02
FROM #tempMainMaterialImages
WHERE ColorFolderID is not null

UPDATE #tempMainMaterialImages
SET FilePath = dbo.fnx_GetStreamingImagePath(ImageID, [Version])	--Comment #01
FROM #tempMainMaterialImages
WHERE ImageID is not null 
and FilePath is null

SELECT 
	TableRow % 4 AS [Column],
	FilePath,
	StyleID,
	ColorName,
	ColorCode,
	MainColor,
	MainColorNo,
	NoImage
FROM #tempMainMaterialImages

DROP TABLE #tempStyleColorways
DROP TABLE #tempMainMaterialImages







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanShowroomStyle_INSERT]'
GO





/*
Comment #01 - Clayton Parker - Oct 14 2009.
	Added the status of 300 which is sent to SAP so they can add those styles to the showroom area
*/



CREATE  PROCEDURE [dbo].[spx_LinePlanShowroomStyle_INSERT](
@LinePlanID UNIQUEIDENTIFIER, 
@LinePlanRangeID UNIQUEIDENTIFIER, 
@StyleID UNIQUEIDENTIFIER, 
@CUser NVARCHAR (200),
@CDate DATETIME
)
AS 

DECLARE @Season NVARCHAR(50)
DECLARE @Year NVARCHAR(50)

DECLARE @TOTAL INT 
DECLARE @ROW_ID  INT 
DECLARE @StyleColorID UNIQUEIDENTIFIER 

DECLARE @TOTAL_SR INT 
DECLARE @ROW_ID_SR  INT 
DECLARE @ShowroomID UNIQUEIDENTIFIER 

DECLARE @Price MONEY 
DECLARE @TradePartnerVendorID UNIQUEIDENTIFIER 

CREATE TABLE  #color (
ROW_ID INT IDENTITY (1,1)  ,
StyleColorID UNIQUEIDENTIFIER 
)

CREATE TABLE #showroom (
ROW_ID INT IDENTITY (1,1),
ShowroomID UNIQUEIDENTIFIER 
)


INSERT INTO  #color ( StyleColorID ) 
SELECT DISTINCT c.StyleColorwayID 
FROM   pLinePlanItem AS a 
INNER JOIN pStyleSeasonYear AS b ON a.StyleID = b.StyleID AND a.LinePlanItemID = b.LinePlanItemID 
INNER JOIN pStyleColorwaySeasonYear AS c ON b.StyleSeasonYearID = c.StyleSeasonYearID 
WHERE a.StyleID = @StyleID
AND (c.SampleStatus = 200 or c.SampleStatus = 300) -- Comment #01
AND a.LinePlanRangeID = @LinePlanRangeID

SET @ROW_ID  = 1 
SELECT @TOTAL = COUNT(*) from #color 

INSERT INTO #showroom  ( ShowroomID ) 
SELECT ShowroomID FROM dbo.pLinePlanShowroomItem WHERE LinePlanRangeID = @LinePlanRangeID


SELECT  @TOTAL_SR = COUNT(*) FROM #showroom 

select @TOTAL , @TOTAL_SR 

select  @Season = b.Season , @Year  = b.Year 
from pLinePlan b WHERE LinePlanID = @LinePlanID



WHILE @ROW_ID <= @TOTAL 
BEGIN
	SELECT @StyleColorID  = StyleColorID FROM #color WHERE ROW_ID =  @ROW_ID 

	SET @ROW_ID_SR = 1 
	WHILE  @ROW_ID_SR <= @TOTAL_SR 
	BEGIN 

		SELECT @ShowroomID = ShowroomID FROM #showroom WHERE ROW_ID = @ROW_ID_SR

		IF  ( SELECT COUNT(*) FROM dbo.pLinePlanShowroomStyleColor  
			WHERE StyleID = @StyleID
			AND  LinePlanRangeID = @LinePlanRangeID
			AND StyleColorID = @StyleColorID
			AND ShowroomID = @ShowroomID ) = 0 
		BEGIN

			SET @TradePartnerVendorID = NULL 
			SET @Price = 0

--
--			IF ( SELECT COUNT(*) FROM dbo.pLinePlanShowroomStyleColor  
--				WHERE StyleID = @StyleID 
--				AND  LinePlanRangeID = @LinePlanRangeID AND StyleColorID = @StyleColorID ) = 0 
--			BEGIN
--				-- First showroom for that Stylecolor an LineplanRange 
--				-- Get a default TradePartnerVendor 
--
--				
--				SELECT @TradePartnerVendorID = b.TradePartnerVendorID
--				FROM   dbo.pLinePlanItem AS a 
--				INNER JOIN dbo.pStyleSourcing AS b ON a.StyleID = b.StyleID 
--				INNER JOIN dbo.pStyleQuoteItem AS c ON a.StyleID = c.StyleID AND c.StyleSourcingID = b.StyleSourcingID 
--				INNER JOIN dbo.pStyleColorway AS d ON d.StyleColorID = c.StyleColorID 
--				INNER JOIN dbo.pStyleColorwaySeasonYear AS f ON f.StyleColorwayID = d.StyleColorID 
--				INNER JOIN dbo.pStyleSeasonYear AS g ON g.StyleSeasonYearID = f.StyleSeasonYearID AND g.LinePlanItemID = a.LinePlanItemID 
--				INNER JOIN dbo.pStyleHeader AS h ON h.StyleID = a.StyleID
--				WHERE a.StyleID = @StyleID
--				AND c.StyleQuoteItemStatusId = 3 AND f.StyleColorStatus = 200
--				AND a.LinePlanRangeID = @LinePlanRangeID 
--			
--				DECLARE @StyleCategoryID UNIQUEIDENTIFIER 
--				SELECT @StyleCategoryID  = StyleCategory FROM pStyleHeader WHERE StyleID = @StyleID 
--
--				IF @StyleCategoryID IS NOT NULL AND @TradePartnerVendorID IS NOT NULL 
--				BEGIN 
--		
--					SELECT TOP 1 @Price = b.Rate 
--					FROM pTradePartnerVendorRate a
--					INNER JOIN  pTradePartnerVendorRateItem  b ON a.TradePartnerVendorRateID = b.TradePartnerVendorRateID
--					WHERE a.TradePartnerVendorID = @TradePartnerVendorID
--					AND StyleCategoryID = @StyleCategoryID
--					AND a.Season = @Season 
--					AND a.Year = @Year
--		
--					--print 'SELECT TOP 1 b.Rate 	FROM pTradePartnerVendorRate a 	INNER JOIN  pTradePartnerVendorRateItem  b ON a.TradePartnerVendorRateID = b.TradePartnerVendorRateID 		WHERE a.TradePartnerVendorID = ''' + Cast(@TradePartnerVendorID as nvarchar(50)) +  ''' AND StyleCategoryID = ''' + Cast(@StyleCategoryID as nvarchar(50)) + ''' AND a.Season = ''' +  @Season  + ''' AND a.Year = ''' + @Year + ''' '
--					IF @Price IS NULL SET @Price = 0 
--				END 
--
--			END 
--			ELSE 
--				SELECT TOP 1 @Price = Price, @TradePartnerVendorID  = TradePartnerVendorID 
--				FROM dbo.pLinePlanShowroomStyleColor  
--				WHERE StyleID = @StyleID
--				AND  LinePlanRangeID = @LinePlanRangeID
--				AND StyleColorID = @StyleColorID
--			

			INSERT INTO pLinePlanShowroomStyleColor ( LinePlanShowroomStyleColorID , LinePlanID , LinePlanRangeID , StyleID , StyleColorID , 
				ShowroomID , CUser, CDate, MUser, MDate, Price, Qty, TradePartnerVendorID ) 
			VALUES (NEWID() , @LinePlanID, @LinePlanRangeID , @StyleID , @StyleColorID , 
				@ShowroomID , @CUser, @CDate, @CUser, @CDate, @Price, 0, @TradePartnerVendorID)

		END 
		SET @ROW_ID_SR = @ROW_ID_SR + 1 
	END 
		
	SET @ROW_ID = @ROW_ID + 1
END 


DROP TABLE #color
DROP TABLE #showroom


--select * from dbo.pLinePlanShowroom where LinePlanID = 'a2e4d875-3e41-4b97-8fa6-6835ca1ce1ba'
--  select * from dbo.pLinePlanShowroomItem    -- RANGEID
--select * from dbo.pLinePlanShowroomStyleColor  













GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_UserSessionLogIn_SELECT]'
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE PROCEDURE [dbo].[spx_UserSessionLogIn_SELECT]
(
@UserName varchar(50), 
@Password varchar(50) 
)
AS 

BEGIN
	SELECT UserId, UserCode, TeamID, FirstName, MiddleName, LastName, Title, Birthday, Company, Street1, Street2, City, State, Zip, Country, Phone, Fax, Mobile, UserName, 
	  PassWord, Email, ContactName1, ContactTitle1, ContactEmail1, ContactName2, ContactTitle2, ContactEmail2, ContactName3, ContactTitle3, ContactEmail3, 
	  ContactName4, ContactTitle4, ContactEmail4, Admin, Active, PublicAccess, TradePartner, LastUpdate, SESSION, SESSIONDATE, SESSIONOS, SCREENWIDTH, 
	  SCREENHEIGHT, FULLNAME, USERDIR, MAILADDR, MAXSIZE, MAXMSGS, FLAGS, TYPE, IP, Picture, CUser, CDate, MUser, MDate, CalendarTemplateID, ActivationID, 
	  ReadOnly, SystemClientID, ServerLocationID, PreferredLang
	FROM Users
	WHERE UserName = @UserName AND Password = @Password
END

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_AccessMaterialFolder_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[spx_Group_AccessMaterialFolder_SELECT] (
@GroupID uniqueidentifier
)
AS 


SELECT a.ComponentTypeID, a.ComponentDescription, b.AccessMaterialId, 
    b.AccessRoleId, b.AccessView, b.AccessCreate, 
    b.AccessModify, b.AccessDelete, b.AccessPrint, 
    b.GroupID , b.CUser, b.CDate, b.MUser, 
    b.MDate, a.ComponentOrder
FROM  pComponentType a WITH (NOLOCK) INNER JOIN  sAccessGroupMaterialFolder b WITH (NOLOCK) ON a.ComponentTypeID = b.ComponentTypeID
WHERE b.GroupID  = @GroupID
ORDER BY a.ComponentOrder



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleColorway_LinePlanColor_Linked_DELETE]'
GO
SET QUOTED_IDENTIFIER OFF
GO
--
-- Comment #01 - Artemio Gomez - 3/18/2010
--               Remove index in Temp Table
--

CREATE PROCEDURE [dbo].[spx_StyleColorway_LinePlanColor_Linked_DELETE]
(
	@ColorPaletteID UNIQUEIDENTIFIER, 
	@StyleID UNIQUEIDENTIFIER,
	@StyleSet INT,
	@SeasonYearID UNIQUEIDENTIFIER
)

AS


/************************/
/*Declare variables.	*/
/************************/
DECLARE @StyleID_Param UNIQUEIDENTIFIER			--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT						--Keep a copy of the original parameter value.

DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE #temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	)  ON [PRIMARY]

-- Comment #01
/*
ALTER TABLE #temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
*/

/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleColorway_LinePlanColor_DELETE
			@ColorPaletteID
			,@StyleID_Param
			,@StyleSet_Param
			,@SeasonYearID
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet_Param AS StyleSet
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID
	END

/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles to add the Colorway to.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Get the 'StyleID' for the insert.*/
		SELECT @StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleColorway_LinePlanColor_DELETE
			@ColorPaletteID
			,@StyleID
			,@StyleSet
			,@SeasonYearID


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanBusinessItemLogic_UPDATE]'
GO
SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [dbo].[spx_LinePlanBusinessItemLogic_UPDATE](
	@StyleQuoteItemID uniqueidentifier,
	@StyleID uniqueidentifier, 
	@LinePlanID uniqueidentifier, 
	@LinePlanRangeID uniqueidentifier, 
	@LinePlanAttributeItemID1 uniqueidentifier, 
	@LinePlanAttributeItemID2 uniqueidentifier, 
	@LinePlanAttributeItemID3 uniqueidentifier, 
	@LinePlanAttributeItemID4 uniqueidentifier, 
	@StyleSeasonYearID UNIQUEIDENTIFIER
)
AS


DECLARE @LY1_NoOfStyle INTEGER
DECLARE @LY1_NoOfFabric INTEGER
DECLARE @LY1_NoOfBody INTEGER 
DECLARE @LY1_NoOfColor INTEGER
DECLARE @LY1_NoOfOptions INTEGER
DECLARE @LY1_MarkupFactor DECIMAL(18, 3)
DECLARE @LY1_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @LY1_AvgTargetFOB DECIMAL(18, 5)
DECLARE @LY1_SalesUnit DECIMAL(18, 3)
DECLARE @LY1_ProjectedWhs DECIMAL(18, 5)
DECLARE @LY1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY1_WeightGrossMarginRtl DECIMAL(18, 3)


DECLARE @LY2_NoOfStyle INTEGER
DECLARE @LY2_NoOfFabric INTEGER
DECLARE @LY2_NoOfBody INTEGER 
DECLARE @LY2_NoOfColor INTEGER
DECLARE @LY2_NoOfOptions INTEGER
DECLARE @LY2_MarkupFactor DECIMAL(18, 3)
DECLARE @LY2_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @LY2_AvgTargetFOB DECIMAL(18, 5)
DECLARE @LY2_SalesUnit DECIMAL(18, 3)
DECLARE @LY2_ProjectedWhs DECIMAL(18, 5)
DECLARE @LY2_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY2_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY2_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY2_WeightGrossMarginRtl DECIMAL(18, 3)


DECLARE @LY3_NoOfStyle INTEGER
DECLARE @LY3_NoOfFabric INTEGER
DECLARE @LY3_NoOfBody INTEGER 
DECLARE @LY3_NoOfColor INTEGER
DECLARE @LY3_NoOfOptions INTEGER
DECLARE @LY3_MarkupFactor DECIMAL(18, 3)
DECLARE @LY3_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @LY3_AvgTargetFOB DECIMAL(18, 5)
DECLARE @LY3_SalesUnit DECIMAL(18, 3)
DECLARE @LY3_ProjectedWhs DECIMAL(18, 5)
DECLARE @LY3_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY3_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY3_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY3_WeightGrossMarginRtl DECIMAL(18, 3)


DECLARE @LY4_NoOfStyle INTEGER
DECLARE @LY4_NoOfFabric INTEGER
DECLARE @LY4_NoOfBody INTEGER 
DECLARE @LY4_NoOfColor INTEGER
DECLARE @LY4_NoOfOptions INTEGER
DECLARE @LY4_MarkupFactor DECIMAL(18, 3)
DECLARE @LY4_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @LY4_AvgTargetFOB DECIMAL(18, 5)
DECLARE @LY4_SalesUnit DECIMAL(18, 3)
DECLARE @LY4_ProjectedWhs DECIMAL(18, 5)
DECLARE @LY4_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY4_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY4_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY4_WeightGrossMarginRtl DECIMAL(18, 3)


DECLARE @PL1_NoOfStyle INTEGER
DECLARE @PL1_NoOfFabric INTEGER
DECLARE @PL1_NoOfBody INTEGER 
DECLARE @PL1_NoOfColor INTEGER
DECLARE @PL1_NoOfOptions INTEGER
DECLARE @PL1_MarkupFactor DECIMAL(18, 3)
DECLARE @PL1_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @PL1_AvgTargetFOB DECIMAL(18, 5)
DECLARE @PL1_SalesUnit DECIMAL(18, 3)
DECLARE @PL1_ProjectedWhs DECIMAL(18, 5)
DECLARE @PL1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL1_WeightGrossMarginRtl DECIMAL(18, 3)


DECLARE @PL2_NoOfStyle INTEGER
DECLARE @PL2_NoOfFabric INTEGER
DECLARE @PL2_NoOfBody INTEGER 
DECLARE @PL2_NoOfColor INTEGER
DECLARE @PL2_NoOfOptions INTEGER
DECLARE @PL2_MarkupFactor DECIMAL(18, 3)
DECLARE @PL2_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @PL2_AvgTargetFOB DECIMAL(18, 5)
DECLARE @PL2_SalesUnit DECIMAL(18, 3)
DECLARE @PL2_ProjectedWhs DECIMAL(18, 5)
DECLARE @PL2_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL2_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL2_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL2_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @PL3_NoOfStyle INTEGER
DECLARE @PL3_NoOfFabric INTEGER
DECLARE @PL3_NoOfBody INTEGER 
DECLARE @PL3_NoOfColor INTEGER
DECLARE @PL3_NoOfOptions INTEGER
DECLARE @PL3_MarkupFactor DECIMAL(18, 3)
DECLARE @PL3_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @PL3_AvgTargetFOB DECIMAL(18, 5)
DECLARE @PL3_SalesUnit DECIMAL(18, 3)
DECLARE @PL3_ProjectedWhs DECIMAL(18, 5)
DECLARE @PL3_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL3_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL3_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL3_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @PL4_NoOfStyle INT
DECLARE @PL4_NoOfFabric INT
DECLARE @PL4_NoOfBody INT 
DECLARE @PL4_NoOfColor INT
DECLARE @PL4_NoOfOptions INT
DECLARE @PL4_MarkupFactor DECIMAL(18, 3)
DECLARE @PL4_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @PL4_AvgTargetFOB DECIMAL(18, 5)
DECLARE @PL4_SalesUnit DECIMAL(18, 3)
DECLARE @PL4_ProjectedWhs DECIMAL(18, 5)
DECLARE @PL4_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL4_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL4_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL4_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @Cu1_NoOfStyle INT
DECLARE @Cu1_NoOfFabric INT
DECLARE @Cu1_NoOfBody INT
DECLARE @Cu1_NoOfColor INT
DECLARE @Cu1_NoOfOptions INT
DECLARE @Cu1_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @Cu1_AvgTargetFOB DECIMAL(18, 5)
DECLARE @Cu1_SalesUnit DECIMAL(18, 3)
DECLARE @Cu1_ProjectedWhs DECIMAL(18, 5)
DECLARE @Cu1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu1_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @Cu2_NoOfStyle INT
DECLARE @Cu2_NoOfFabric INT
DECLARE @Cu2_NoOfBody INT 
DECLARE @Cu2_NoOfColor INT
DECLARE @Cu2_NoOfOptions INT
DECLARE @Cu2_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu2_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @Cu2_AvgTargetFOB DECIMAL(18, 5)
DECLARE @Cu2_SalesUnit DECIMAL(18, 3)
DECLARE @Cu2_ProjectedWhs DECIMAL(18, 5)
DECLARE @Cu2_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu2_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu2_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu2_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @Cu3_NoOfStyle INT
DECLARE @Cu3_NoOfFabric INT
DECLARE @Cu3_NoOfBody INT 
DECLARE @Cu3_NoOfColor INT
DECLARE @Cu3_NoOfOptions INT
DECLARE @Cu3_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu3_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @Cu3_AvgTargetFOB DECIMAL(18, 5)
DECLARE @Cu3_SalesUnit DECIMAL(18, 3)
DECLARE @Cu3_ProjectedWhs DECIMAL(18, 5)
DECLARE @Cu3_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu3_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu3_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu3_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @Cu4_NoOfStyle INT
DECLARE @Cu4_NoOfFabric INT
DECLARE @Cu4_NoOfBody INT 
DECLARE @Cu4_NoOfColor INT
DECLARE @Cu4_NoOfOptions INT
DECLARE @Cu4_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu4_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @Cu4_AvgTargetFOB DECIMAL(18, 5)
DECLARE @Cu4_SalesUnit DECIMAL(18, 3)
DECLARE @Cu4_ProjectedWhs DECIMAL(18, 5)
DECLARE @Cu4_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu4_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu4_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu4_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu4_WeightedAverageRetailPrice DECIMAL(18, 3)


DECLARE @Wp1_NoOfStyle INT
DECLARE @Wp1_NoOfFabric INT
DECLARE @Wp1_NoOfBody INT 
DECLARE @Wp1_NoOfColor INT
DECLARE @Wp1_NoOfOptions INT
DECLARE @Wp1_MarkupFactor DECIMAL(18, 3)
DECLARE @Wp1_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @Wp1_AvgTargetFOB DECIMAL(18, 5)
DECLARE @Wp1_SalesUnit DECIMAL(18, 3)
DECLARE @Wp1_ProjectedWhs DECIMAL(18, 5)
DECLARE @Wp1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Wp1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp1_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @Wp2_NoOfStyle INT
DECLARE @Wp2_NoOfFabric INT
DECLARE @Wp2_NoOfBody INT 
DECLARE @Wp2_NoOfColor INT
DECLARE @Wp2_NoOfOptions INT
DECLARE @Wp2_MarkupFactor DECIMAL(18, 3)
DECLARE @Wp2_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @Wp2_AvgTargetFOB DECIMAL(18, 5)
DECLARE @Wp2_SalesUnit DECIMAL(18, 3)
DECLARE @Wp2_ProjectedWhs DECIMAL(18, 5)
DECLARE @Wp2_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Wp2_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp2_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp2_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @Wp3_NoOfStyle INT
DECLARE @Wp3_NoOfFabric INT
DECLARE @Wp3_NoOfBody INT 
DECLARE @Wp3_NoOfColor INT
DECLARE @Wp3_NoOfOptions INT
DECLARE @Wp3_MarkupFactor DECIMAL(18, 3)
DECLARE @Wp3_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @Wp3_AvgTargetFOB DECIMAL(18, 5)
DECLARE @Wp3_SalesUnit DECIMAL(18, 3)
DECLARE @Wp3_ProjectedWhs DECIMAL(18, 5)
DECLARE @Wp3_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Wp3_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp3_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp3_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @Wp4_NoOfStyle INT
DECLARE @Wp4_NoOfFabric INT
DECLARE @Wp4_NoOfBody INT 
DECLARE @Wp4_NoOfColor INT
DECLARE @Wp4_NoOfOptions INT
DECLARE @Wp4_MarkupFactor DECIMAL(18, 3)
DECLARE @Wp4_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @Wp4_AvgTargetFOB DECIMAL(18, 5)
DECLARE @Wp4_SalesUnit DECIMAL(18, 3)
DECLARE @Wp4_ProjectedWhs DECIMAL(18, 5)
DECLARE @Wp4_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Wp4_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp4_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp4_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @AveragePrice DECIMAL(18,3)

SET @Cu2_AvgTargetFOB = 0
SET @Cu3_AvgTargetFOB = 0
SET @Cu4_AvgTargetFOB = 0

SET @Cu2_InitialGrossMarginRtl = 0
SET @Cu3_InitialGrossMarginRtl = 0
SET @Cu4_InitialGrossMarginRtl = 0

SET @Cu2_InitialGrossMarginWhs = 0
SET @Cu3_InitialGrossMarginWhs = 0
SET @Cu4_InitialGrossMarginWhs = 0



--=============================================================================================================================
-- <!-- 1 -->
-- NUMBER OF STYLES ( 0  OR 1 )

DECLARE @NoStyles INT  

SELECT  @NoStyles = COUNT( DISTINCT b.StyleID )
FROM  pStyleQuoteItem b
INNER JOIN pStyleSourcing c ON b.StyleID = c.StyleID AND b.StyleSourcingID = c.StyleSourcingID
INNER JOIN pStyleColorwaySeasonYear e ON e.StyleColorwayID = b.StyleColorID
INNER JOIN pStyleSeasonYear f ON f.StyleSeasonYearID = e.StyleSeasonYearID
--INNER JOIN pStyleColorway d ON d.StyleColorId = b.StyleColorID
where b.StyleID = @StyleID
AND e.StyleSeasonYearID = @StyleSeasonYearID
AND b.StyleQuoteItemStatusId = 3
AND (e.StyleColorStatus = 200 or e.StyleColorStatus = 300)
AND f.MostLikelyVendor = 1


SELECT TOP 1 
@LY1_NoOfStyle = LinePlanBusLYCh1, 	@LY2_NoOfStyle = LinePlanBusLYCh2,	@LY3_NoOfStyle = LinePlanBusLYCh3, 	@LY4_NoOfStyle = LinePlanBusLYCh4, 
@PL1_NoOfStyle = LinePlanBusPnCh1, 	@PL2_NoOfStyle = LinePlanBusPnCh2, 	@PL3_NoOfStyle = LinePlanBusPnCh3, 	@PL4_NoOfStyle = LinePlanBusPnCh4, 
@Cu1_NoOfStyle = @NoStyles, 	@Cu2_NoOfStyle = 0, 	@Cu3_NoOfStyle = 0, 	@Cu4_NoOfStyle = 0 
FROM pLinePlanBusiness
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 	AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID 
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'

IF @NoStyles = 0 
	SET @Wp1_NoOfStyle = 1
ELSE 
	SET @Wp1_NoOfStyle = 0

SELECT @Wp2_NoOfStyle = 0, @Wp3_NoOfStyle = 0, @Wp4_NoOfStyle = 0

UPDATE pLinePlanBusinessItem SET
LinePlanBusLYCh1 = @LY1_NoOfStyle, LinePlanBusLYCh2 = @LY2_NoOfStyle, LinePlanBusLYCh3 = @LY3_NoOfStyle, LinePlanBusLYCh4 = @LY4_NoOfStyle, 
LinePlanBusPnCh1 = @PL1_NoOfStyle, LinePlanBusPnCh2 = @PL2_NoOfStyle, LinePlanBusPnCh3 = @PL3_NoOfStyle, LinePlanBusPnCh4 = @PL4_NoOfStyle, 
LinePlanBusCuCh1 = @Cu1_NoOfStyle, LinePlanBusCuCh2 = @Cu2_NoOfStyle, LinePlanBusCuCh3 = @Cu3_NoOfStyle, LinePlanBusCuCh4 = @Cu4_NoOfStyle,
LinePlanBusWpCh1 = @Wp1_NoOfStyle, LinePlanBusWpCh2 = @Wp2_NoOfStyle, LinePlanBusWpCh3 = @Wp3_NoOfStyle, LinePlanBusWpCh4 = @Wp4_NoOfStyle
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID AND StyleID = @StyleID
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'



--=============================================================================================================================
-- <!-- 2 -->
-- NUMBER OF COLORWAYS ( 0  OR 1 )
DECLARE @NoColorways INT 

IF @NoStyles > 0 
BEGIN
	SELECT  @NoColorways = COUNT( DISTINCT b.StyleColorID )
	FROM  pStyleQuoteItem b
	INNER JOIN pStyleSourcing c ON b.StyleID = c.StyleID AND b.StyleSourcingID = c.StyleSourcingID
	INNER JOIN pStyleColorwaySeasonYear e ON e.StyleColorwayID = b.StyleColorID
	INNER JOIN pStyleSeasonYear f ON f.StyleSeasonYearID = e.StyleSeasonYearID
	--INNER JOIN pStyleColorway d ON d.StyleColorId = b.StyleColorID
	where b.StyleID = @StyleID
	AND e.StyleSeasonYearID = @StyleSeasonYearID
	AND b.StyleQuoteItemStatusId = 3
	AND (e.StyleColorStatus = 200 or e.StyleColorStatus = 300)
	AND f.MostLikelyVendor = 1 
END 
ELSE 
	SET @NoColorways = 0 


--================================================================================================================
-- COLORS IN PROGRESS 
DECLARE @TradepartnerVendorID UNIQUEIDENTIFIER 

select @TradepartnerVendorID = a.TradepartnerVendorID
from pStyleSeasonYear a
where a.StyleSeasonYearID = @StyleSeasonYearID

--select @TradepartnerVendorID as TradepartnerVendorID, @StyleSeasonYearID as StyleSeasonYearID

SELECT @Wp1_NoOfColor  = COUNT(*) 
FROM pStyleColorwaySeasonYear 
WHERE StyleSeasonYearID = @StyleSeasonYearID



IF @TradepartnerVendorID IS NOT NULL 
BEGIN 

	SELECT @Wp1_NoOfColor = COUNT(DISTINCT b.ColorPaletteID)
	FROM pStyleColorwaySeasonYear a 
	INNER JOIN pStyleColorway b ON b.StyleColorID   = a.StyleColorwayID
	WHERE a.StyleSeasonYearID = @StyleSeasonYearID
	AND b.ColorPaletteID NOT IN ( 
		select e.ColorPaletteID 
		from  pStyleSourcing a
		INNER JOIN pStyleColorwaySeasonYear b ON a.StyleSeasonYearID = b.StyleSeasonYearID
		INNER JOIN pStyleColorway c ON c.StyleColorID   = b.StyleColorwayID
		INNER JOIN pStyleQuoteItem d ON ( d.StyleSourcingID = a.StyleSourcingID 
		AND d.StyleColorID = c.StyleColorID  )
		INNER JOIN pColorPalette e ON e.ColorPaletteID = c.ColorPaletteID 
		where a.StyleSeasonYearID = @StyleSeasonYearID
		AND a.TradePartnerVendorID = @TradePartnerVendorID
		AND d.StyleQuoteItemStatusID = 3
		AND (b.StyleColorStatus  = 200 or b.StyleColorStatus  = 300)
	)

END 

SELECT @Wp2_NoOfColor = 0, @Wp3_NoOfColor = 0,@Wp4_NoOfColor = 0


SELECT TOP 1 
@LY1_NoOfColor = LinePlanBusLYCh1, 	@LY2_NoOfColor = LinePlanBusLYCh2,	@LY3_NoOfColor = LinePlanBusLYCh3, 	@LY4_NoOfColor = LinePlanBusLYCh4, 
@PL1_NoOfColor = LinePlanBusPnCh1, 	@PL2_NoOfColor = LinePlanBusPnCh2, 	@PL3_NoOfColor = LinePlanBusPnCh3, 	@PL4_NoOfColor = LinePlanBusPnCh4, 
@Cu1_NoOfColor = LinePlanBusCuCh1, @Cu2_NoOfColor = LinePlanBusCuCh2, 	@Cu3_NoOfColor = LinePlanBusCuCh3, 	@Cu4_NoOfColor = LinePlanBusCuCh4
FROM pLinePlanBusiness
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000002'

UPDATE pLinePlanBusinessItem SET
LinePlanBusLYCh1 = @LY1_NoOfColor, LinePlanBusLYCh2 = @LY2_NoOfColor,LinePlanBusLYCh3 = @LY3_NoOfColor, LinePlanBusLYCh4 = @LY4_NoOfColor, 
LinePlanBusPnCh1 = @PL1_NoOfColor, LinePlanBusPnCh2 = @PL2_NoOfColor, LinePlanBusPnCh3 = @PL3_NoOfColor, LinePlanBusPnCh4 = @PL4_NoOfColor, 
LinePlanBusCuCh1 = @NoColorways ,  LinePlanBusCuCh2 = @Cu2_NoOfColor, LinePlanBusCuCh3 = @Cu3_NoOfColor, LinePlanBusCuCh4 = @Cu4_NoOfColor,
LinePlanBusWpCh1 = @Wp1_NoOfColor, LinePlanBusWpCh2 = @Wp2_NoOfColor, LinePlanBusWpCh3 = @Wp3_NoOfColor, LinePlanBusWpCh4 = @Wp4_NoOfColor		
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID AND StyleID = @StyleID
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000002'



--=============================================================================================================================
-- <!-- 3 -->
-- NUMBER OF FABRICS ( 0  OR 1 )

DECLARE @NoFabrics INT 

IF @NoStyles = 0 
BEGIN
	SET @NoFabrics = 0 

	-- Total Main Materials /In progress
	SELECT @Wp1_NoOfFabric =  1

END 
ELSE
BEGIN

	SELECT  @NoFabrics = COUNT ( DISTINCT e.MaterialID )
	FROM  pStyleQuoteItem b
	INNER JOIN pStyleSourcing c ON b.StyleID = c.StyleID AND b.StyleSourcingID = c.StyleSourcingID
	INNER JOIN pStyleColorwaySeasonYear f ON f.StyleColorwayID = b.StyleColorID
	INNER JOIN pStyleSeasonYear g ON g.StyleSeasonYearID = f.StyleSeasonYearID
	--INNER JOIN pStyleColorway d ON d.StyleColorId = b.StyleColorID
	INNER JOIN pStyleMaterials e ON e.StyleID =  b.StyleID
	where b.StyleID = @StyleID
	AND f.StyleSeasonYearID = @StyleSeasonYearID
	AND b.StyleQuoteItemStatusId = 3
	AND (f.StyleColorStatus = 200 or f.StyleColorStatus = 300)
	AND g.MostLikelyVendor = 1 
	AND e.MainMaterial = 1 

	SET @Wp1_NoOfFabric = 0 
END 

SELECT @Wp2_NoOfFabric = 0, @Wp3_NoOfFabric = 0, @Wp4_NoOfFabric = 0

SELECT TOP 1 
@LY1_NoOfFabric = LinePlanBusLYCh1, @LY2_NoOfFabric = LinePlanBusLYCh2,	@LY3_NoOfFabric = LinePlanBusLYCh3, @LY4_NoOfFabric = LinePlanBusLYCh4, 
@PL1_NoOfFabric = LinePlanBusPnCh1, @PL2_NoOfFabric = LinePlanBusPnCh2, @PL3_NoOfFabric = LinePlanBusPnCh3, @PL4_NoOfFabric = LinePlanBusPnCh4, 
@Cu1_NoOfFabric = @NoFabrics, @Cu2_NoOfFabric = 0, @Cu3_NoOfFabric = 0, @Cu4_NoOfFabric = 0
FROM pLinePlanBusiness 
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000001'


UPDATE pLinePlanBusinessItem SET
LinePlanBusLYCh1 = @LY1_NoOfFabric, LinePlanBusLYCh2 = @LY2_NoOfFabric,	LinePlanBusLYCh3 = @LY3_NoOfFabric, LinePlanBusLYCh4 = @LY4_NoOfFabric, 
LinePlanBusPnCh1 = @PL1_NoOfFabric, LinePlanBusPnCh2 = @PL2_NoOfFabric, LinePlanBusPnCh3 = @PL3_NoOfFabric, LinePlanBusPnCh4 = @PL4_NoOfFabric, 
LinePlanBusCuCh1 = @Cu1_NoOfFabric, LinePlanBusCuCh2 = @Cu2_NoOfFabric, LinePlanBusCuCh3 = @Cu3_NoOfFabric, LinePlanBusCuCh4 = @Cu4_NoOfFabric,
LinePlanBusWpCh1 = @Wp1_NoOfFabric, LinePlanBusWpCh2 = @Wp2_NoOfFabric, LinePlanBusWpCh3 = @Wp3_NoOfFabric, LinePlanBusWpCh4 = @Wp4_NoOfFabric
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID AND StyleID = @StyleID
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000001'


--=============================================================================================================================
-- <!-- 4 -->
-- NUMBER OF BODYS ( 0  OR 1 )

DECLARE @BodyID UNIQUEIDENTIFIER

SELECT @BodyID = BodyID
FROM pStyleHeader 
WHERE StyleID = @StyleID

SELECT TOP 1 
@LY1_NoOfBody = LinePlanBusLYCh1, @LY2_NoOfBody = LinePlanBusLYCh2,	@LY3_NoOfBody = LinePlanBusLYCh3, @LY4_NoOfBody = LinePlanBusLYCh4, 
@PL1_NoOfBody = LinePlanBusPnCh1, @PL2_NoOfBody = LinePlanBusPnCh2, @PL3_NoOfBody = LinePlanBusPnCh3, @PL4_NoOfBody = LinePlanBusPnCh4, 
@Cu1_NoOfBody = CASE WHEN (@BodyID IS NULL) OR (@NoStyles = 0)   THEN 0 ELSE 1 END  , @Cu2_NoOfBody = 0, 	@Cu3_NoOfBody = 0, 	@Cu4_NoOfBody = 0 
FROM pLinePlanBusiness
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000003'


SET @Wp1_NoOfBody = CASE WHEN ( @NoStyles = 0 AND  @BodyID IS NOT NULL) THEN 1 ELSE 0 END
SELECT @Wp2_NoOfBody = 0, @Wp3_NoOfBody = 0, @Wp4_NoOfBodY = 0


UPDATE pLinePlanBusinessItem SET
LinePlanBusLYCh1 = @LY1_NoOfBody, LinePlanBusLYCh2 = @LY2_NoOfBody,	LinePlanBusLYCh3 = @LY3_NoOfBody, LinePlanBusLYCh4 = @LY4_NoOfBody, 
LinePlanBusPnCh1 = @PL1_NoOfBody, LinePlanBusPnCh2 = @PL2_NoOfBody, LinePlanBusPnCh3 = @PL3_NoOfBody, LinePlanBusPnCh4 = @PL4_NoOfBody, 
LinePlanBusCuCh1 = @Cu1_NoOfBody, LinePlanBusCuCh2 = @Cu2_NoOfBody, LinePlanBusCuCh3 = @Cu3_NoOfBody, LinePlanBusCuCh4 = @Cu4_NoOfBody,
LinePlanBusWpCh1 = @Wp1_NoOfBody, LinePlanBusWpCh2 = @Wp2_NoOfBody, LinePlanBusWpCh3 = @Wp3_NoOfBody, LinePlanBusWpCh4 = @Wp4_NoOfBody	
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID AND StyleID = @StyleID
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000003'




--=============================================================================================================================
-- <!-- 5 -->
-- NUMBER OF OPTIONS 


SELECT TOP 1 
@LY1_NoOfOptions = LinePlanBusLYCh1, @LY2_NoOfOptions = LinePlanBusLYCh2,@LY3_NoOfOptions = LinePlanBusLYCh3, @LY4_NoOfOptions = LinePlanBusLYCh4, 
@PL1_NoOfOptions = LinePlanBusPnCh1, @PL2_NoOfOptions = LinePlanBusPnCh2, @PL3_NoOfOptions = LinePlanBusPnCh3, @PL4_NoOfOptions = LinePlanBusPnCh4, 
@Cu1_NoOfOptions = 0, 	@Cu2_NoOfOptions = 0, @Cu3_NoOfOptions = 0, @Cu4_NoOfOptions = 0 
FROM pLinePlanBusiness
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000005'


IF @NoStyles = 0 
	SET @Cu1_NoOfOptions = 0
ELSE 
	SELECT @Cu1_NoOfOptions = COUNT(*) FROM pStyleColorwaySeasonYear WHERE StyleID = @StyleID 


UPDATE pLinePlanBusinessItem SET
LinePlanBusLYCh1 = @LY1_NoOfOptions, LinePlanBusLYCh2 = @LY2_NoOfOptions, LinePlanBusLYCh3 = @LY3_NoOfOptions, LinePlanBusLYCh4 = @LY4_NoOfOptions, 
LinePlanBusPnCh1 = @PL1_NoOfOptions, LinePlanBusPnCh2 = @PL2_NoOfOptions, LinePlanBusPnCh3 = @PL3_NoOfOptions, LinePlanBusPnCh4 = @PL4_NoOfOptions, 
LinePlanBusCuCh1 = @Cu1_NoOfOptions, LinePlanBusCuCh2 = @Cu2_NoOfOptions, LinePlanBusCuCh3 = @Cu3_NoOfOptions, LinePlanBusCuCh4 = @Cu4_NoOfOptions,
LinePlanBusWpCh1 = NULL, LinePlanBusWpCh2 = NULL, LinePlanBusWpCh3 = NULL, LinePlanBusWpCh4 = NULL
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID AND StyleID = @StyleID
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000005'


--=============================================================================================================================
-- <!-- 6 -->
-- RAW VALUES FROM pStyleCostingHeader 

DECLARE @UNITS INT 
DECLARE @TARGET_FIRST_COST DECIMAL(18,3)
DECLARE @TARGET_RETAIL_GBP DECIMAL(18,3)
DECLARE @TARGET_WHOLESALE_PRICE DECIMAL(18,3)
DECLARE @AVG_PRICE DECIMAL(18,3)
DECLARE @MARGIN_MARKUP DECIMAL(18,3)
DECLARE @WHOLESALE_MARGIN DECIMAL(18,3)


--******  NEW *****
-- The calculation for the Actual Target FOB should be the average of the Landed Dutty Price calculated in the Quote:
DECLARE @ACTUAL_TARGET_FOB DECIMAL(18,3)

SELECT  @ACTUAL_TARGET_FOB  = AVG ( b.StyleQuoteItemCustomField15) 
FROM  pStyleQuoteItem b
INNER JOIN pStyleSourcing c ON b.StyleID = c.StyleID AND b.StyleSourcingID = c.StyleSourcingID
--INNER JOIN pStyleColorway d ON d.StyleColorId = b.StyleColorID
INNER JOIN pStyleColorwaySeasonYear e ON e.StyleColorwayID = b.StyleColorID
INNER JOIN pStyleSeasonYear f ON f.StyleSeasonYearID = e.StyleSeasonYearID
where b.StyleID = @StyleID
AND e.StyleSeasonYearID = @StyleSeasonYearID 
AND b.StyleQuoteItemStatusId = 3
AND (e.StyleColorStatus = 200 or e.StyleColorStatus = 300)
AND f.MostLikelyVendor = 1


IF @ACTUAL_TARGET_FOB IS NULL 
	SET @ACTUAL_TARGET_FOB = 0 


IF @NoStyles > 0 
BEGIN 
	SELECT 	
	@TARGET_WHOLESALE_PRICE = ISNULL(StyleCostingCustomField6,0),
	@TARGET_FIRST_COST = ISNULL(StyleCostingCustomField2,0),
	@MARGIN_MARKUP  = ISNULL(StyleCostingCustomField3,0), 
	@WHOLESALE_MARGIN  = ISNULL(StyleCostingCustomField5,0), 
	@TARGET_RETAIL_GBP = ISNULL(StyleCostingCustomField1,0),
	@AVG_PRICE = ISNULL(StyleCostingCustomField1,0) 
	FROM pStyleCostingHeader
	WHERE StyleId = @StyleId
	

	SELECT @UNITS = SUM (Units) 
	FROM pStyleColorwaySeasonYear
	WHERE StyleSeasonYearID = @StyleSeasonYearID
	AND  StyleColorwayID IN  (
		select StyleColorID from pStyleQuoteItem 
		WHERE StyleID = @StyleID
		AND StyleQuoteItemStatusID = 3
	)
	AND (StyleColorStatus  = 200 or StyleColorStatus  = 300)


	IF @UNITS IS NULL 
		SET @UNITS = 0 



END 
ELSE 
BEGIN
	SELECT 	@UNITS = 0, @TARGET_FIRST_COST = 0, @TARGET_RETAIL_GBP = 0 , 
	@TARGET_WHOLESALE_PRICE = 0, @AVG_PRICE = 0, @MARGIN_MARKUP = 0 , @WHOLESALE_MARGIN = 0, @ACTUAL_TARGET_FOB = 0 
END  

--=============================================================================================================================
-- <!-- 7 -->
--***
--** Mark Up Factor
--** Retail price / wholesale price 
--** ( Target Retail GBP / Targer Wholesale Price)
--** StyleCostingCustomField1 / StyleCostingCustomField6
--***

SELECT @LY1_MarkupFactor = 0, @LY2_MarkupFactor = 0, @LY3_MarkupFactor = 0, @LY4_MarkupFactor = 0
SELECT @PL1_MarkupFactor = 0, @PL2_MarkupFactor = 0, @PL3_MarkupFactor = 0, @PL4_MarkupFactor = 0
SET @Cu1_MarkupFactor = CASE WHEN @TARGET_WHOLESALE_PRICE = 0 THEN 0 ELSE @TARGET_RETAIL_GBP / @TARGET_WHOLESALE_PRICE END 
SELECT @Cu2_MarkupFactor = 0, @Cu3_MarkupFactor = 0, @Cu4_MarkupFactor = 0

UPDATE pLinePlanBusinessItem SET 
LinePlanBusCuCh1 = @Cu1_MarkupFactor, LinePlanBusCuCh2 = 0, LinePlanBusCuCh3 = 0, 	LinePlanBusCuCh4 = 0,
LinePlanBusWpCh1 = NULL, LinePlanBusWpCh2 = NULL, LinePlanBusWpCh3 = NULL, LinePlanBusWpCh4 = NULL 	
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID AND StyleID = @StyleID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000005'



----=============================================================================================================================
-- <!-- 9 -->
-- SALES UNITS

SELECT TOP 1 
@LY1_SalesUnit = LinePlanBusLYCh1, @LY2_SalesUnit = LinePlanBusLYCh2, @LY3_SalesUnit = LinePlanBusLYCh3, @LY4_SalesUnit = LinePlanBusLYCh4, 
@PL1_SalesUnit = LinePlanBusPnCh1, @PL2_SalesUnit = LinePlanBusPnCh2, @PL3_SalesUnit = LinePlanBusPnCh3, @PL4_SalesUnit = LinePlanBusPnCh4, 
@Cu1_SalesUnit = @UNITS , @Cu2_SalesUnit = 0, @Cu3_SalesUnit = 0, @Cu4_SalesUnit = 0 
FROM pLinePlanBusiness
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000008'

UPDATE pLinePlanBusinessItem SET
LinePlanBusLYCh1 = @LY1_SalesUnit, LinePlanBusLYCh2 = @LY2_SalesUnit, LinePlanBusLYCh3 = @LY3_SalesUnit, LinePlanBusLYCh4 = @LY4_SalesUnit, 
LinePlanBusPnCh1 = @PL1_SalesUnit, LinePlanBusPnCh2 = @PL2_SalesUnit, LinePlanBusPnCh3 = @PL3_SalesUnit, LinePlanBusPnCh4 = @PL4_SalesUnit, 
LinePlanBusCuCh1 = @Cu1_SalesUnit, LinePlanBusCuCh2 = @Cu2_SalesUnit, LinePlanBusCuCh3 = @Cu3_SalesUnit, LinePlanBusCuCh4 = @Cu4_SalesUnit,
LinePlanBusWpCh1 = NULL, LinePlanBusWpCh2 = NULL, LinePlanBusWpCh3 = NULL, LinePlanBusWpCh4 = NULL		
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID AND StyleID = @StyleID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000008'



--=============================================================================================================================
-- <!-- 10 -->
-- TARGET AVG WHS PRICE (GBP)  =  FROM COSTING 

SELECT TOP 1 
@LY1_TargetAvgWhsPrice = LinePlanBusLYCh1, @LY2_TargetAvgWhsPrice = LinePlanBusLYCh2, @LY3_TargetAvgWhsPrice = LinePlanBusLYCh3, @LY4_TargetAvgWhsPrice = LinePlanBusLYCh4, 
@PL1_TargetAvgWhsPrice = LinePlanBusPnCh1, @PL2_TargetAvgWhsPrice = LinePlanBusPnCh2, @PL3_TargetAvgWhsPrice = LinePlanBusPnCh3, @PL4_TargetAvgWhsPrice = LinePlanBusPnCh4, 
@Cu1_TargetAvgWhsPrice = @TARGET_WHOLESALE_PRICE, @Cu2_TargetAvgWhsPrice = 0, @Cu3_TargetAvgWhsPrice = 0, @Cu4_TargetAvgWhsPrice = 0
FROM pLinePlanBusiness
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000009'

IF @NoStyles = 0 
	SET @Cu1_TargetAvgWhsPrice = 0 

UPDATE pLinePlanBusinessItem SET
LinePlanBusLYCh1 = @LY1_TargetAvgWhsPrice, LinePlanBusLYCh2 = @LY2_TargetAvgWhsPrice, LinePlanBusLYCh3 = @LY3_TargetAvgWhsPrice, LinePlanBusLYCh4 = @LY4_TargetAvgWhsPrice, 
LinePlanBusPnCh1 = @PL1_TargetAvgWhsPrice, LinePlanBusPnCh2 = @PL2_TargetAvgWhsPrice, LinePlanBusPnCh3 = @PL3_TargetAvgWhsPrice, LinePlanBusPnCh4 = @PL4_TargetAvgWhsPrice, 
LinePlanBusCuCh1 = @Cu1_TargetAvgWhsPrice, LinePlanBusCuCh2 = @Cu2_TargetAvgWhsPrice, LinePlanBusCuCh3 = @Cu3_TargetAvgWhsPrice, LinePlanBusCuCh4 = @Cu4_TargetAvgWhsPrice,
LinePlanBusWpCh1 = NULL, LinePlanBusWpCh2 = NULL, LinePlanBusWpCh3 = NULL, LinePlanBusWpCh4 = NULL 	
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID AND StyleID = @StyleID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000009'


--=============================================================================================================================
-- <!-- 12 -->
-- AVERAGE TARGET FOB (BGP)  

SELECT TOP 1 
@LY1_AvgTargetFOB = LinePlanBusLYCh1, @LY2_AvgTargetFOB = LinePlanBusLYCh2,	@LY3_AvgTargetFOB = LinePlanBusLYCh3, @LY4_AvgTargetFOB = LinePlanBusLYCh4, 
@PL1_AvgTargetFOB = LinePlanBusPnCh1, @PL2_AvgTargetFOB = LinePlanBusPnCh2, @PL3_AvgTargetFOB = LinePlanBusPnCh3, @PL4_AvgTargetFOB = LinePlanBusPnCh4, 
@Cu1_AvgTargetFOB = @ACTUAL_TARGET_FOB, @Cu2_AvgTargetFOB = 0, @Cu3_AvgTargetFOB = 0, @Cu4_AvgTargetFOB = 0
FROM pLinePlanBusiness
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID 
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000006'


UPDATE pLinePlanBusinessItem SET
LinePlanBusLYCh1 = @LY1_AvgTargetFOB, LinePlanBusLYCh2 = @LY2_AvgTargetFOB,	LinePlanBusLYCh3 = @LY3_AvgTargetFOB, LinePlanBusLYCh4 = @LY4_AvgTargetFOB, 
LinePlanBusPnCh1 = @PL1_AvgTargetFOB, LinePlanBusPnCh2 = @PL2_AvgTargetFOB, LinePlanBusPnCh3 = @PL3_AvgTargetFOB, LinePlanBusPnCh4 = @PL4_AvgTargetFOB, 
LinePlanBusCuCh1 = @Cu1_AvgTargetFOB, LinePlanBusCuCh2 = @Cu2_AvgTargetFOB, LinePlanBusCuCh3 = @Cu3_AvgTargetFOB, LinePlanBusCuCh4 = @Cu4_AvgTargetFOB,
LinePlanBusWpCh1 = 0, LinePlanBusWpCh2 = 0, LinePlanBusWpCh3 = 0, LinePlanBusWpCh4 = 0
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID AND StyleID = @StyleID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000006'

--=============================================================================================================================
-- <!-- 13 -->
-- PROJECTED WHOLESALE "POUNDS"  = ( SALES UNITS X TARGET AVG WHS PRICE ) 
-- 

SELECT TOP 1 
@LY1_ProjectedWhs = LinePlanBusLYCh1, @LY2_ProjectedWhs = LinePlanBusLYCh2,	@LY3_ProjectedWhs = LinePlanBusLYCh3, @LY4_ProjectedWhs = LinePlanBusLYCh4, 
@PL1_ProjectedWhs = LinePlanBusPnCh1, @PL2_ProjectedWhs = LinePlanBusPnCh2, @PL3_ProjectedWhs = LinePlanBusPnCh3, @PL4_ProjectedWhs = LinePlanBusPnCh4, 
@Cu1_ProjectedWhs = (@TARGET_WHOLESALE_PRICE * @UNITS ), @Cu2_ProjectedWhs = 0, @Cu3_ProjectedWhs = 0, @Cu4_ProjectedWhs = 0
FROM pLinePlanBusiness
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000007'


UPDATE pLinePlanBusinessItem SET
LinePlanBusLYCh1 = @LY1_ProjectedWhs, LinePlanBusLYCh2 = @LY2_ProjectedWhs,	LinePlanBusLYCh3 = @LY3_ProjectedWhs, LinePlanBusLYCh4 = @LY4_ProjectedWhs, 
LinePlanBusPnCh1 = @PL1_ProjectedWhs, LinePlanBusPnCh2 = @PL2_ProjectedWhs, LinePlanBusPnCh3 = @PL3_ProjectedWhs, LinePlanBusPnCh4 = @PL4_ProjectedWhs, 
LinePlanBusCuCh1 = @Cu1_ProjectedWhs, LinePlanBusCuCh2 = @Cu2_ProjectedWhs, LinePlanBusCuCh3 = @Cu3_ProjectedWhs, LinePlanBusCuCh4 = @Cu4_ProjectedWhs,
LinePlanBusWpCh1 = 0, LinePlanBusWpCh2 = 0, LinePlanBusWpCh3 = 0, LinePlanBusWpCh4 = 0
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID AND StyleID = @StyleID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000007'


--=============================================================================================================================
-- <!-- 14 -->
-- INITIAL GROSS MARGIN WHS % 

SELECT TOP 1 
@LY1_InitialGrossMarginWhs = LinePlanBusLYCh1, @LY2_InitialGrossMarginWhs = LinePlanBusLYCh2, @LY3_InitialGrossMarginWhs = LinePlanBusLYCh3, @LY4_InitialGrossMarginWhs = LinePlanBusLYCh4, 
@PL1_InitialGrossMarginWhs = LinePlanBusPnCh1, @PL2_InitialGrossMarginWhs = LinePlanBusPnCh2, @PL3_InitialGrossMarginWhs = LinePlanBusPnCh3, @PL4_InitialGrossMarginWhs = LinePlanBusPnCh4, 
@Cu1_InitialGrossMarginWhs = LinePlanBusPnCh1, @Cu2_InitialGrossMarginWhs = LinePlanBusPnCh2, @Cu3_InitialGrossMarginWhs = LinePlanBusPnCh3, @Cu4_InitialGrossMarginWhs = LinePlanBusPnCh4
FROM pLinePlanBusiness
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000013'

IF @NoStyles = 0 
	SET @Cu1_InitialGrossMarginWhs = 0 
ELSE
BEGIN

	-- Average of wholesale margins by style on Costing button in line plan.  Approved styles only
	SELECT @Cu1_InitialGrossMarginWhs = ISNULL(StyleCostingCustomField5 ,0)
	FROM pStyleCostingHeader WHERE StyleID = @StyleID 
	
END 

UPDATE pLinePlanBusinessItem SET
LinePlanBusLYCh1 = @LY1_InitialGrossMarginWhs, LinePlanBusLYCh2 = @LY2_InitialGrossMarginWhs, LinePlanBusLYCh3 = @LY3_InitialGrossMarginWhs, LinePlanBusLYCh4 = @LY4_InitialGrossMarginWhs, 
LinePlanBusPnCh1 = @PL1_InitialGrossMarginWhs, LinePlanBusPnCh2 = @PL2_InitialGrossMarginWhs, LinePlanBusPnCh3 = @PL3_InitialGrossMarginWhs, LinePlanBusPnCh4 = @PL4_InitialGrossMarginWhs, 
LinePlanBusCuCh1 = @Cu1_InitialGrossMarginWhs, LinePlanBusCuCh2 = @Cu2_InitialGrossMarginWhs, LinePlanBusCuCh3 = @Cu3_InitialGrossMarginWhs, LinePlanBusCuCh4 = @Cu4_InitialGrossMarginWhs,
LinePlanBusWpCh1 = 0, LinePlanBusWpCh2 = 0, LinePlanBusWpCh3 = 0, LinePlanBusWpCh4 = 0
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID AND StyleID = @StyleID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000013'


--=============================================================================================================================
-- <!-- 15 -->
-- WEIGHTED GROSS MARGIN RETAIL %  

SELECT TOP 1 
@LY1_WeightGrossMarginRtl = LinePlanBusLYCh1, @LY2_WeightGrossMarginRtl = LinePlanBusLYCh2, @LY3_WeightGrossMarginRtl = LinePlanBusLYCh3, @LY4_WeightGrossMarginRtl = LinePlanBusLYCh4, 
@PL1_WeightGrossMarginRtl = LinePlanBusPnCh1, @PL2_WeightGrossMarginRtl = LinePlanBusPnCh2, @PL3_WeightGrossMarginRtl = LinePlanBusPnCh3, @PL4_WeightGrossMarginRtl = LinePlanBusPnCh4, 
@Cu1_WeightGrossMarginRtl = LinePlanBusCuCh1, @Cu2_WeightGrossMarginRtl = LinePlanBusCuCh2, @Cu3_WeightGrossMarginRtl = LinePlanBusCuCh3, @Cu4_WeightGrossMarginRtl = LinePlanBusCuCh4 
FROM pLinePlanBusiness
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000012'

SET @Cu1_WeightGrossMarginRtl = CASE WHEN  @TARGET_RETAIL_GBP = 0 OR @NoStyles = 0  THEN  0 ELSE (@TARGET_RETAIL_GBP - @ACTUAL_TARGET_FOB)/ @TARGET_RETAIL_GBP END

UPDATE pLinePlanBusinessItem SET
LinePlanBusLYCh1 = @LY1_WeightGrossMarginRtl, LinePlanBusLYCh2 = @LY2_WeightGrossMarginRtl,	LinePlanBusLYCh3 = @LY3_WeightGrossMarginRtl, LinePlanBusLYCh4 = @LY4_WeightGrossMarginRtl, 
LinePlanBusPnCh1 = @PL1_WeightGrossMarginRtl, LinePlanBusPnCh2 = @PL2_WeightGrossMarginRtl, LinePlanBusPnCh3 = @PL3_WeightGrossMarginRtl, LinePlanBusPnCh4 = @PL4_WeightGrossMarginRtl, 
LinePlanBusCuCh1 = @Cu1_WeightGrossMarginRtl , LinePlanBusCuCh2 = @Cu2_WeightGrossMarginRtl, LinePlanBusCuCh3 = @Cu3_WeightGrossMarginRtl, LinePlanBusCuCh4 = @Cu4_WeightGrossMarginRtl,
LinePlanBusWpCh1 = 0, LinePlanBusWpCh2 = 0, LinePlanBusWpCh3 = 0, LinePlanBusWpCh4 = 0
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 	AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID AND StyleID = @StyleID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000012'

--=============================================================================================================================
-- <!-- 15 -->
-- WEIGHTED GROSS MARGIN WHOLESALE %  

IF @NoStyles = 0 
BEGIN
	SELECT @Cu1_WeightGrossMarginWhs = 0
	SELECT @LY1_WeightGrossMarginWhs = 0, @LY2_WeightGrossMarginWhs = 0, @LY3_WeightGrossMarginWhs = 0, @LY4_WeightGrossMarginWhs = 0
	SELECT @PL1_WeightGrossMarginWhs = 0, @PL2_WeightGrossMarginWhs = 0, @PL3_WeightGrossMarginWhs = 0, @PL4_WeightGrossMarginWhs = 0
	SELECT @Cu1_WeightGrossMarginWhs = 0, @Cu2_WeightGrossMarginWhs = 0, @Cu3_WeightGrossMarginWhs = 0, @Cu4_WeightGrossMarginWhs = 0
END
ELSE
BEGIN 
	SELECT TOP 1 
	@LY1_WeightGrossMarginWhs = LinePlanBusLYCh1, @LY2_WeightGrossMarginWhs = LinePlanBusLYCh2, @LY3_WeightGrossMarginWhs = LinePlanBusLYCh3, @LY4_WeightGrossMarginWhs = LinePlanBusLYCh4, 
	@PL1_WeightGrossMarginWhs = LinePlanBusPnCh1, @PL2_WeightGrossMarginWhs = LinePlanBusPnCh2, @PL3_WeightGrossMarginWhs = LinePlanBusPnCh3, @PL4_WeightGrossMarginWhs = LinePlanBusPnCh4, 
	@Cu1_WeightGrossMarginWhs = LinePlanBusCuCh1, @Cu2_WeightGrossMarginWhs = LinePlanBusCuCh2, @Cu3_WeightGrossMarginWhs = LinePlanBusCuCh3, @Cu4_WeightGrossMarginWhs = LinePlanBusCuCh4 
	FROM pLinePlanBusiness
	WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
	AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000011'
END 


SET @Cu1_WeightGrossMarginWhs = CASE 
	WHEN  @TARGET_WHOLESALE_PRICE = 0 OR @NoStyles = 0  THEN  0 
	ELSE (@TARGET_WHOLESALE_PRICE - @ACTUAL_TARGET_FOB)/ @TARGET_WHOLESALE_PRICE END

UPDATE pLinePlanBusinessItem SET
LinePlanBusLYCh1 = @LY1_WeightGrossMarginWhs, LinePlanBusLYCh2 = @LY2_WeightGrossMarginWhs,	LinePlanBusLYCh3 = @LY3_WeightGrossMarginWhs, LinePlanBusLYCh4 = @LY4_WeightGrossMarginWhs, 
LinePlanBusPnCh1 = @PL1_WeightGrossMarginWhs, LinePlanBusPnCh2 = @PL2_WeightGrossMarginWhs, LinePlanBusPnCh3 = @PL3_WeightGrossMarginWhs, LinePlanBusPnCh4 = @PL4_WeightGrossMarginWhs, 
LinePlanBusCuCh1 = @Cu1_WeightGrossMarginWhs, LinePlanBusCuCh2 = @Cu2_WeightGrossMarginWhs, LinePlanBusCuCh3 = @Cu3_WeightGrossMarginWhs, LinePlanBusCuCh4 = @Cu4_WeightGrossMarginWhs,
LinePlanBusWpCh1 = 0, LinePlanBusWpCh2 = 0, LinePlanBusWpCh3 = 0, LinePlanBusWpCh4 = 0
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID AND StyleID = @StyleID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000011'


--=============================================================================================================================
-- <!-- 11 -->
-- Retail Flow Through Margin



SELECT TOP 1 
@LY1_InitialGrossMarginRtl = LinePlanBusLYCh1, @LY2_InitialGrossMarginRtl = LinePlanBusLYCh2, @LY3_InitialGrossMarginRtl = LinePlanBusLYCh3, @LY4_InitialGrossMarginRtl = LinePlanBusLYCh4, 
@PL1_InitialGrossMarginRtl = LinePlanBusPnCh1, @PL2_InitialGrossMarginRtl = LinePlanBusPnCh2, @PL3_InitialGrossMarginRtl = LinePlanBusPnCh3, @PL4_InitialGrossMarginRtl = LinePlanBusPnCh4, 
@Cu1_InitialGrossMarginRtl = LinePlanBusPnCh1, @Cu2_InitialGrossMarginRtl = LinePlanBusPnCh2, @Cu3_InitialGrossMarginRtl = LinePlanBusPnCh3, @Cu4_InitialGrossMarginRtl = LinePlanBusPnCh4
FROM pLinePlanBusiness
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000010'

IF @NoStyles = 0  
	SET @Cu1_InitialGrossMarginRtl = 0 
ELSE
BEGIN
	-- Average of retail margins by style on Costing button in line plan.  Approved styles only
	SELECT @Cu1_InitialGrossMarginRtl = ISNULL(StyleCostingCustomField3 ,0)
	FROM pStyleCostingHeader WHERE StyleID = @StyleID 
END 


UPDATE pLinePlanBusinessItem SET
LinePlanBusLYCh1 = @LY1_InitialGrossMarginRtl, LinePlanBusLYCh2 = @LY2_InitialGrossMarginRtl, 
LinePlanBusLYCh3 = @LY3_InitialGrossMarginRtl, LinePlanBusLYCh4 = @LY4_InitialGrossMarginRtl, 
LinePlanBusPnCh1 = @PL1_InitialGrossMarginRtl, LinePlanBusPnCh2 = @PL2_InitialGrossMarginRtl, 
LinePlanBusPnCh3 = @PL3_InitialGrossMarginRtl, LinePlanBusPnCh4 = @PL4_InitialGrossMarginRtl,
LinePlanBusCuCh1 = @Cu1_InitialGrossMarginRtl, LinePlanBusCuCh2 = @Cu2_InitialGrossMarginRtl, 
LinePlanBusCuCh3 = @Cu3_InitialGrossMarginRtl, LinePlanBusCuCh4 = @Cu4_InitialGrossMarginRtl,
LinePlanBusWpCh1 = 0, LinePlanBusWpCh2 = 0, LinePlanBusWpCh3 = 0, LinePlanBusWpCh4 = 0
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID AND StyleID = @StyleID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000010'




























GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LineFolderItemStyleWorkflowAccess_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_LineFolderItemStyleWorkflowAccess_SELECT] ( 
@StyleID uniqueidentifier,
@TeamID uniqueidentifier  
)
AS 

DECLARE @DevelopmentId uniqueidentifier
SELECT @DevelopmentId = DevelopmentId FROM pStyleHeader WITH (NOLOCK) WHERE StyleId = @StyleId

CREATE TABLE #TempLineWorkflow (
	[LineId] [int] IDENTITY (1, 1) NOT NULL ,
	[Map] [uniqueidentifier] NULL ,
	[MapDetail] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL ,
	[StyleId] [uniqueidentifier] NULL ,
	[DevelopmentId] [uniqueidentifier] NULL ,
	[Sort] [smallint] NULL 
) 


INSERT INTO #TempLineWorkflow
    (Map, MapDetail, Sort, StyleId, DevelopmentId)
SELECT Mapping.Map, Mapping.MapDetail, pStyleWorkflow.WorkSort, @StyleID, @DevelopmentID
FROM pStyleWorkflow WITH (NOLOCK) INNER JOIN
    Mapping WITH (NOLOCK) ON pStyleWorkflow.WorkflowID = Mapping.Map INNER JOIN
    pStyleHeader WITH (NOLOCK) ON pStyleWorkflow.StyleID = pStyleHeader.StyleID
WHERE     (pStyleWorkflow.StyleID = @StyleID) AND (pStyleWorkflow.StyleSet = 1)
AND pStyleHeader.StyleType in  (  SELECT  StyleTypeId from sAccessStyleFolder WITH (NOLOCK) where TeamId = @TeamID  AND ( AccessRoleId =  3 OR AccessView = 1) ) 
ORDER BY pStyleWorkflow.WorkSort


DECLARE @Count AS INT 

SELECT @Count = COUNT(*)  FROM sAccessCosting WITH (NOLOCK)
WHERE TeamID  = @TeamID
AND StyleTypeId  =  ( SELECT StyleType FROM pStyleHeader WITH (NOLOCK) WHERE  StyleID = @StyleID   )
AND  ( AccessRoleId =  3 OR AccessView = 1)


IF  @Count > 0 
BEGIN
	INSERT INTO #TempLineWorkflow
	    (Map, MapDetail, StyleId, DevelopmentId)
	VALUES
		('{50000000-0000-0000-0000-000000000005}', 'Costing', @StyleId, @DevelopmentId)

END 



SELECT Map, MapDetail, StyleId, DevelopmentId FROM #TempLineWorkflow



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rpx_Request_For_Quote_SELECT]'
GO
CREATE PROCEDURE [dbo].[rpx_Request_For_Quote_SELECT]
(
	@SEASON nvarchar(200) = NULL,
	@YEAR nvarchar(200) = NULL,
	@CATEGORY NVARCHAR(200)= NULL,
	@VENDORNAME NVARCHAR(200)=NULL
)
AS
--
--DECLARE @SEASON nvarchar(200)
--DECLARE @YEAR nvarchar(200)
--DECLARE @CATEGORY NVARCHAR(200)
--DECLARE @VENDORNAME NVARCHAR(200)
--
--SET @SEASON='spring summer'
--SET @year='2010'
--SET @CATEGORY='w lifestyle'
--SET @VENDORNAME='frontline image ltd'


--/*Testing.*/
--DECLARE @StyleID varchar(50)
--SET @StyleID = '767dceda-c7a0-41c7-99c1-4dcdd97060b2'

/*Set default values for blank parameters.*/
IF(@Season IS NULL OR @Season = '')
	BEGIN
		SET @Season = '(ALL)'
	END

IF(@Year IS NULL OR @Year = '')
	BEGIN
		SET @Year = '(ALL)'
	END
IF(@Category IS NULL OR @Category = '')
	BEGIN
		SET @Category = '(ALL)'
	END
IF(@Vendorname IS NULL OR @Vendorname = '')
	BEGIN
		SET @Vendorname = '(ALL)'
	END


/*Declare necessary variables for looping.*/
DECLARE @TotalCount int		--To keep track of the total number of records in the temp table.
DECLARE @RowCounter int		--To keep track of what loop you are on.
DECLARE @RowValue int		--To keep track of the row value.
DECLARE	@ColumnValue int	--To keep track of the column value.
DECLARE @ImageFolder varchar(200)

/*Create temp table.*/
CREATE TABLE #tempTable(
	TableRow int identity(1,1),
	STYLENO  NVARCHAR (20),
[description] NVARCHAR (100),
customfield14 NVARCHAR (200),
materialno NVARCHAR (50),
styleseason NVARCHAR (200),
styleyear NVARCHAR (200),
vendorname NVARCHAR (200),
customfield3 nvarchar (200),
FilePath varchar(255),
Row int,
[Column] int)
/*Set the path for the image.*/
SET @ImageFolder = (SELECT TOP 1 SettingValue FROM rReportSetting WITH (NOLOCK) WHERE SettingType = 'ImagePath')

/*Insert records into temp table.*/
INSERT INTO #tempTable(
	STYLENO,
	[DESCRIPTION],
	CUSTOMFIELD14,
	MATERIALNO,
	styleseason,
	styleyear,
	VENDORNAME,
	customfield3,
	FILEPATH)
SELECT distinct
	psh.STYLENO ,
	psh.description  ,
	psh.customfield14 ,
	psh.materialno ,
	pssy.styleseason,
	pssy.styleyear,
	utpv.vendorname ,
	psh.customfield3,
	@IMAGEFOLDER+'/{'+CAST(hi.IMAGEID AS VARCHAR (255))+'}/VERSION/000/{'+
		CAST(hi.IMAGEHISTORYID AS VARCHAR(255))+'}.jpG' AS filepath
FROM PSTYLEHEADER psh
	left outer join pstylecolorway psc on psc.styleid=psh.styleid
	left outer join pstylecolorwayseasonyear pscsy on pscsy.styleid=psc.styleid and pscsy.stylecolorwayid=psc.stylecolorid
	left outer join pstyleseasonyear pssy on pssy.styleseasonyearid=pscsy.styleseasonyearid
	left outer join pstylesourcing pss on pss.styleid=psh.styleid
--	inner join pstylequoteitem psqi on psqi.styleid=psh.styleid
	inner join utradepartnervendor utpv on utpv.tradepartnervendorid=pss.tradepartnervendorid
	INNER JOIN hImage hi ON psh.DesignSketchID = hi.ImageID
						AND psh.DesignSketchVersion = hi.Version

where (pssy.styleseason=@season or @season='(all)')
and (pssy.styleyear=@year or @year='(all)') 
and (psh.customfield3=@category or @category='(all)')
and (vendorname=@vendorname or @vendorname='(all)')


/*Get the number of records in the temp table.*/
SELECT @TotalCount = COUNT(*) FROM #tempTable

/*Set the initial counter and variable values.*/
SET @RowCounter = 1
SET @RowValue = 1

/*Loop to populate Row and Column fields.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Set the initial column value to 1.*/
		SET @ColumnValue = 1

		/*Loop to keep track of the column we are on.*/
		WHILE(@ColumnValue <= 3)
			BEGIN
				/*Record the row and column positions.*/
				UPDATE #tempTable
				SET Row = @RowValue
					,[Column] = @ColumnValue
				WHERE TableRow = @RowCounter

				/*Up the column value counter.*/
				SET @ColumnValue = @ColumnValue + 1

				/*Up the row counter.*/
				SET @RowCounter = @RowCounter + 1
			END

		/*Up the row value counter.*/
		SET @RowValue = @RowValue + 1
	END

/*Show records in temp table.*/
SELECT
	FilePath,
	STYLENO AS 'Desingno',
[description] as 'StyleName',
customfield14 as 'Description',
materialno as 'Mainfabric',
styleseason as 'Season',
styleyear as 'Year',
vendorname as'Vendorname',
customfield3 as 'category',
Row,
[Column]
FROM #tempTable

/*Drop temp table.*/
DROP TABLE #tempTable


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanMaterialCoreColorItemAvail_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_LinePlanMaterialCoreColorItemAvail_SELECT](
@MaterialCoreID uniqueidentifier
)
AS 



SELECT '00000000-0000-0000-0000-000000000000' AS MaterialCoreColorID, '' AS ColorName , '' AS ColorCode
UNION 
SELECT a.MaterialCoreColorID, '(' + ISNULL(b.ColorCode,'')  + ') ' + ISNULL(b.ColorName,'')  AS ColorName, b.ColorCode
FROM pMaterialCoreColor a
INNER JOIN pColorPalette b ON a.ColorPaletteID = b.ColorPaletteID 
WHERE MaterialCoreID = @MaterialCoreID
ORDER BY ColorName

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_AccessQuotationFolder_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_Group_AccessQuotationFolder_SELECT] ( 
@GroupID uniqueidentifier
)
AS 


SELECT a.StyleTypeID,  a.StyleTypeDescription, 
	b.AccessQuotationID,  b.AccessRoleID, b.AccessView, b.AccessCreate, 
	b.AccessModify, b.AccessDelete, b.AccessPrint, 
	b.GroupID, b.CUser, b.CDate, b.MUser, 
	b.MDate, a.StyleTypeOrder
FROM  pStyleType  a WITH (NOLOCK) INNER JOIN  sAccessGroupQuotationFolder  b WITH (NOLOCK) ON a.StyleTypeID = b.StyleTypeID
WHERE b.GroupID = @GroupID
ORDER BY a.StyleTypeOrder



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Style_DevelopmentSpec_SELECT]'
GO





ALTER      PROCEDURE [dbo].[rpx_Style_DevelopmentSpec_SELECT] 
	@StyleID AS varchar(255), 
	@StyleSet As int
AS

SELECT
	ps.POM,
	ps.PointMeasur,
	CAST(ps.TOL AS decimal(8,3)) AS TOL, 
	CAST(ps.Spec AS decimal(8,3)) AS Spec,
	CASE
	     WHEN sz.Sel0 = 1 THEN sz.Size0
	     WHEN sz.Sel1 = 1 THEN sz.Size1
	     WHEN sz.Sel2 = 1 THEN sz.Size2
	     WHEN sz.Sel3 = 1 THEN sz.Size3
	     WHEN sz.Sel4 = 1 THEN sz.Size4
	     WHEN sz.Sel5 = 1 THEN sz.Size5
	     WHEN sz.Sel6 = 1 THEN sz.Size6
	     WHEN sz.Sel7 = 1 THEN sz.Size7
	     WHEN sz.Sel8 = 1 THEN sz.Size8
	     WHEN sz.Sel9 = 1 THEN sz.Size9
	     WHEN sz.Sel10 = 1 THEN sz.Size10
	     WHEN sz.Sel11 = 1 THEN sz.Size11
	END AS SizeNo
FROM	pStyleSpec ps, pStyleSpecSize sz 
WHERE ((sz.StyleID = ps.StyleID) AND
	(ps.StyleSet = @StyleSet) AND
	(sz.StyleID = @StyleID) AND
	(ps.Spec <> 0)) 
ORDER BY ps.Sort, ps.POM, ps.PointMeasur



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[vwx_ExchangeRate_By_Style]'
GO
CREATE VIEW dbo.vwx_ExchangeRate_By_Style
AS
SELECT     TOP (100) PERCENT dbo.sExchangeRate.Description, dbo.pStyleHeader.Description AS Expr1, dbo.pLinePlan.Description AS Expr2, 
                      dbo.pStyleHeader.StyleNo
FROM         dbo.sExchangeRate INNER JOIN
                      dbo.pStyleSourcing ON dbo.sExchangeRate.ExchangeRateID = dbo.pStyleSourcing.Custom2 INNER JOIN
                      dbo.pStyleHeader ON dbo.pStyleSourcing.StyleID = dbo.pStyleHeader.StyleID INNER JOIN
                      dbo.pLinePlan ON dbo.pStyleHeader.LinePlanID = dbo.pLinePlan.LinePlanID INNER JOIN
                      dbo.pLinePlanItem ON dbo.pStyleHeader.LinePlanItemID = dbo.pLinePlanItem.LinePlanItemID AND 
                      dbo.pLinePlan.LinePlanID = dbo.pLinePlanItem.LinePlanID
WHERE     (dbo.pLinePlan.Description LIKE N'Womenswear Au%') AND (dbo.sExchangeRate.Description <> N'AW10')
ORDER BY dbo.sExchangeRate.Description
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_AccessSampleFolder_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_Group_AccessSampleFolder_SELECT] (
@GroupID uniqueidentifier
)
AS 

	Select a.SampleWorkflowID as SampleTypeID ,  a.SampleWorkflow as SampleTypeDescription ,
		b.AccessSampleId, b.AccessRoleId, b.AccessView, b.AccessCreate, 
		b.AccessModify, b.AccessDelete, b.AccessPrint, b.AccessRemove, 
		b.GroupID, b.CUser, b.CDate, b.MUser, 
		b.MDate , a.SampleWorkflowSort
	FROM  pSampleWorkflow a WITH (NOLOCK) INNER JOIN sAccessGroupSampleFolder b WITH (NOLOCK) ON a.SampleWorkflowID = b.SampleTypeID
	WHERE b.GroupID = @GroupID
	ORDER BY a.SampleWorkflowSort



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleColorGroups_PIVOT]'
GO
SET QUOTED_IDENTIFIER OFF
GO
/****** Object:  StoredProcedure [dbo].[spx_StyleColorGroups_PIVOT]    Script Date: 03/09/2010 10:12:58 ******/


CREATE PROCEDURE [dbo].[spx_StyleColorGroups_PIVOT] (
@StyleID UNIQUEIDENTIFIER,
@StyleSet int,
@SeasonYearID NVARCHAR(50)= NULL
)

AS

BEGIN

--Create temp table for available colors
CREATE TABLE #tmpStyleAvailbleColor( 
	RecID						int IDENTITY(1,1)  NOT NULL,
	StyleColorID 	 	uniqueidentifier,
	StyleID 				uniqueidentifier
) ON [PRIMARY]

--Create temp table for available colorgroups
CREATE TABLE #tmpStyleAvailableColorGroup( 
	RecID						int IDENTITY(1,1)  NOT NULL,
	ColorGroupID 	 	    uniqueidentifier,
	StyleColorGroupID 	 				uniqueidentifier,
	StyleID 				uniqueidentifier
) ON [PRIMARY]


DECLARE @RowAvailbleColorLoop 			int
DECLARE @RowAvailbleColorCount 			int
DECLARE @tmpStyleColorID			uniqueidentifier

DECLARE @RowAvailableColorGroupLoop 		int
DECLARE @RowAvailableColorGroupCount 		int
DECLARE @tmpColorGroupID			uniqueidentifier
DECLARE @tmpStyleColorGroupID					uniqueidentifier

BEGIN
--Populate colors 
	INSERT INTO #tmpStyleAvailbleColor (StyleColorID, StyleID)
	SELECT StyleColorID, StyleID FROM pStyleColorway WITH (NOLOCK)
	WHERE StyleID = @StyleID 
END

BEGIN

--
--Populate colorgroups
--

  IF @SeasonYearID IS NOT NULL AND LEN(@SeasonYearID) > 0
	INSERT INTO #tmpStyleAvailableColorGroup (ColorGroupID, StyleID, StyleColorGroupID)
	SELECT ColorGroupID, StyleID, StyleColorGroupID FROM pStyleColorGroup WITH (NOLOCK)
	WHERE StyleID = @StyleID AND SeasonYearID = @SeasonYearID
  ELSE
    INSERT INTO #tmpStyleAvailableColorGroup (ColorGroupID, StyleID, StyleColorGroupID)
	SELECT ColorGroupID, StyleID, StyleColorGroupID FROM pStyleColorGroup WITH (NOLOCK)
	WHERE StyleID = @StyleID
END

SET @RowAvailbleColorLoop = 1
SET @RowAvailbleColorCount = (SELECT COUNT(*) FROM #tmpStyleAvailbleColor)

--
--Loop available colors
--

WHILE @RowAvailbleColorLoop <= @RowAvailbleColorCount 

	BEGIN
		SELECT @tmpStyleColorID = StyleColorID FROM #tmpStyleAvailbleColor WHERE RecID = @RowAvailbleColorLoop

			BEGIN	

					SET @RowAvailableColorGroupLoop = 1
					SET @RowAvailableColorGroupCount = (SELECT COUNT(*) FROM #tmpStyleAvailableColorGroup)
					--Loop available colorgroups
					WHILE @RowAvailableColorGroupLoop <= @RowAvailableColorGroupCount 
						BEGIN

							SELECT @tmpColorGroupID = ColorGroupID, @tmpStyleColorGroupID = StyleColorGroupID FROM #tmpStyleAvailableColorGroup WHERE RecID = @RowAvailableColorGroupLoop
								BEGIN	

									--Check if quantity is available on pStyleColorGroupItem for PIVOT function
									IF (SELECT COUNT(*) FROM pStyleColorGroupItem WHERE StyleColorGroupID = @tmpStyleColorGroupID AND StyleColorID = @tmpStyleColorID) = 0
									BEGIN
										--If not found create a blank insert.
										INSERT INTO pStyleColorGroupItem (StyleColorGroupID, StyleColorID, StyleID, Quantity, SeasonYearID)
										SELECT @tmpStyleColorGroupID, @tmpStyleColorID,  @StyleID, '0', @SeasonYearID
									END
								END	

							SET @RowAvailableColorGroupLoop = @RowAvailableColorGroupLoop + 1
							
						END

			END	

		SET @RowAvailbleColorLoop = @RowAvailbleColorLoop + 1
		
	END

	DROP TABLE #tmpStyleAvailbleColor
	DROP TABLE #tmpStyleAvailableColorGroup

END

BEGIN
--
--Update Quantity NULL with '0'
--

IF @SeasonYearID IS NOT NULL AND LEN(@SeasonYearID) > 0
	UPDATE pStyleColorGroupItem SET Quantity = '0' WHERE (Quantity IS NULL) AND (StyleID = @StyleID) AND SeasonYearID = @SeasonYearID
ELSE
    UPDATE pStyleColorGroupItem SET Quantity = '0' WHERE (Quantity IS NULL) AND (StyleID = @StyleID)
END


BEGIN 


CREATE TABLE #tmpStyleColorwayGroups (
Rec_ID INT IDENTITY (1,1) ,
StyleColorID UNIQUEIDENTIFIER , 
StyleID UNIQUEIDENTIFIER ,
StyleSet INT,
StyleColorNo NVARCHAR(50) , 
StyleColorName NVARCHAR(200) ,
MainColor NVARCHAR(100),
SAPCode NVARCHAR(50) , 
PLMCode NVARCHAR(200)
)

----COMMENTED TO CONVERT StyleColorID as NVARCHAR, FROM UNIQUEIDENTIFIER, AS IT DOESN'T WORK IN SQL ADD ETC. OPERATIONS
--CREATE TABLE #tmpStyleColorwayGroups (
--Rec_ID INT IDENTITY (1,1) ,
--StyleColorID NVARCHAR(50) , 
--StyleID UNIQUEIDENTIFIER ,
--StyleSet INT,
--StyleColorNo NVARCHAR(50) , 
--StyleColorName NVARCHAR(200) ,
--MainColor NVARCHAR(100),
--SAPCode NVARCHAR(50) , 
--PLMCode NVARCHAR(200)
--)

IF @SeasonYearID IS NOT NULL AND LEN(@SeasonYearID) > 0
BEGIN 

	DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER 

	SELECT @StyleSeasonYearID  = StyleSeasonYearID 
	FROM pStyleSeasonYear
	WHERE SeasonYearID = @SeasonYearID AND StyleID = @StyleID 

	INSERT INTO #tmpStyleColorwayGroups (StyleColorID , StyleID, StyleSet, StyleColorNo, StyleColorName, MainColor, SAPCode , PLMCode)
	SELECT b.StyleColorID , b.StyleID, b.StyleSet, b.StyleColorNo, c.ColorName, c.ColorName, b.SAPCode, b.PLMCode 
	FROM pStyleColorwaySeasonYear a INNER JOIN pStyleColorway b ON a.StyleColorwayID = b.StyleColorID
	INNER JOIN pColorPalette c ON c.ColorPaletteID = b.ColorPaletteID 
	WHERE  a.StyleID = @StyleID
	AND a.StyleSeasonYearID = @StyleSeasonYearID
	AND b.StyleSet = @StyleSet 
	ORDER BY b.Sort, b.MainColor
END
ELSE 
BEGIN

	INSERT INTO #tmpStyleColorwayGroups (StyleColorID , StyleID, StyleSet, StyleColorNo, StyleColorName, MainColor, SAPCode , PLMCode)
	SELECT StyleColorID , a.StyleID, a.StyleSet, StyleColorNo, b.ColorName AS StyleColorName, b.ColorName AS MainColor, SAPCode, PLMCode 
	FROM pStyleColorway a 
	INNER JOIN pColorPalette b ON a.ColorPaletteID = b.ColorPaletteID 
	WHERE StyleID = @StyleID 
	--AND StyleSet = @StyleSet
	ORDER BY a.Sort, a.MainColor

END

CREATE TABLE #StyleColorValues (
Rec_ID INT IDENTITY (1,1) ,
StyleColorGroupID UNIQUEIDENTIFIER , 
StyleID UNIQUEIDENTIFIER ,
StyleSet INT,
ColorGroupID UNIQUEIDENTIFIER ,
ColorGroupName NVARCHAR(200) ,
StyleColorID  UNIQUEIDENTIFIER ,
StyleColorName NVARCHAR(200) ,
Quantity DECIMAL 
)

IF @SeasonYearID IS NOT NULL AND LEN(@SeasonYearID) > 0
BEGIN
    INSERT INTO #StyleColorValues (StyleColorGroupID, StyleID, StyleSet, ColorGroupID, 
	ColorGroupName, StyleColorID, StyleColorName, Quantity)
	SELECT     b.StyleColorGroupID, b.StyleID, b.StyleSet, b.ColorGroupID, 
	b.ColorGroupName, a.StyleColorID, a.StyleColorName, c.Quantity	
	FROM         #tmpStyleColorwayGroups AS a LEFT OUTER JOIN
						  pStyleColorGroup AS b ON a.StyleID = b.StyleID LEFT OUTER JOIN
						  pStyleColorGroupItem AS c ON c.StyleColorGroupID = b.StyleColorGroupID AND a.StyleColorID = c.StyleColorID
	WHERE     (a.StyleID = @StyleID) AND (a.StyleSet = @StyleSet) AND b.StyleID=@StyleID AND b.StyleSet = @StyleSet AND b.SeasonYearID = @SeasonYearID AND c.SeasonYearID = @SeasonYearID
	ORDER BY b.Sort, b.ColorGroupName
END
ELSE
BEGIN
    INSERT INTO #StyleColorValues (StyleColorGroupID, StyleID, StyleSet, ColorGroupID, 
	ColorGroupName, StyleColorID, StyleColorName, Quantity)
	SELECT     b.StyleColorGroupID, b.StyleID, b.StyleSet, b.ColorGroupID, 
	b.ColorGroupName, a.StyleColorID, a.StyleColorName, c.Quantity	
	FROM         #tmpStyleColorwayGroups AS a LEFT OUTER JOIN
						  pStyleColorGroup AS b ON a.StyleID = b.StyleID LEFT OUTER JOIN
						  pStyleColorGroupItem AS c ON c.StyleColorGroupID = b.StyleColorGroupID AND a.StyleColorID = c.StyleColorID
	WHERE     (a.StyleID = @StyleID) AND (a.StyleSet = @StyleSet) AND b.StyleID=@StyleID AND b.StyleSet = @StyleSet 
	ORDER BY b.Sort, b.ColorGroupName
END

EXECUTE spx_Crosstab 'SELECT  StyleColorGroupID, StyleID, StyleSet, ColorGroupID, ColorGroupName,
StyleColorID, Quantity
FROM #StyleColorValues',
NULL,
NULL,
'StyleColorID',
'Quantity',
'MAX'


--Commented as currently compatibility level for db is set to 80 which doesn't support PIVOT
--DECLARE @cols NVARCHAR(2000)
--SELECT  @cols = STUFF(( SELECT DISTINCT TOP 100 PERCENT
--                                '],[' + t2.StyleColorID
--                        FROM    #tmpStyleColorwayGroups AS t2
--                        --ORDER BY '],[' + t2.StyleColorID
--                        FOR XML PATH('')
--                      ), 1, 2, '') + ']'
--
--
--DECLARE @query NVARCHAR(4000)
--SET @query = N'SELECT StyleColorGroupID, StyleID, StyleSet, ColorGroupID, ColorGroupName,
--'+ @cols +'
--FROM
--(SELECT t1.StyleColorGroupID, t1.StyleID, t1.StyleSet, t1.ColorGroupID, t1.ColorGroupName,
--t1.StyleColorID, t1.Quantity
--FROM    #StyleColorValues AS t1
--        JOIN #tmpStyleColorwayGroups AS t2 ON t1.StyleColorID = t2.StyleColorID) p
--PIVOT
--(
--MAX([Quantity])
--FOR [StyleColorID] IN
--( '+
--@cols +' )
--) AS pvt
--ORDER BY ColorGroupName;'
--EXECUTE(@query)

DROP TABLE #StyleColorValues
DROP TABLE #tmpStyleColorwayGroups

END 

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_LinePlanBusiness_SEL]'
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[vwx_LinePlanBusiness_SEL]
AS
SELECT     TOP (100) PERCENT dbo.pLinePlanBusiness.LinePlanBusinessID, dbo.pLinePlanBusiness.LinePlanID, dbo.pLinePlanBusiness.LinePlanFinancialID, 
                      dbo.pLinePlanFinancial.LinePlanFinancialText, dbo.pLinePlanBusiness.LinePlanFinancialSort, dbo.pLinePlanBusiness.LinePlanAttributeItemID1, 
                      dbo.pLinePlanBusiness.LinePlanAttributeItemID2, dbo.pLinePlanBusiness.LinePlanAttributeItemID3, dbo.pLinePlanBusiness.LinePlanAttributeItemID4, 
                      dbo.pLinePlanBusiness.LinePlanAttributeText1, dbo.pLinePlanBusiness.LinePlanAttributeText2, dbo.pLinePlanBusiness.LinePlanAttributeText3, 
                      dbo.pLinePlanBusiness.LinePlanAttributeText4, dbo.pLinePlanBusiness.LinePlanAttributeItemSort1, 
                      dbo.pLinePlanBusiness.LinePlanAttributeItemSort2, dbo.pLinePlanBusiness.LinePlanAttributeItemSort3, 
                      dbo.pLinePlanBusiness.LinePlanAttributeItemSort4, dbo.pLinePlanBusiness.LinePlanBusLYCh1, dbo.pLinePlanBusiness.LinePlanBusLYCh2, 
                      dbo.pLinePlanBusiness.LinePlanBusLYCh3, dbo.pLinePlanBusiness.LinePlanBusLYCh4, dbo.pLinePlanBusiness.LinePlanBusLYCh5, 
                      dbo.pLinePlanBusiness.LinePlanBusPnCh1, dbo.pLinePlanBusiness.LinePlanBusPnCh2, dbo.pLinePlanBusiness.LinePlanBusPnCh3, 
                      dbo.pLinePlanBusiness.LinePlanBusPnCh4, dbo.pLinePlanBusiness.LinePlanBusPnCh5, dbo.pLinePlanBusiness.LinePlanBusCuCh1, 
                      dbo.pLinePlanBusiness.LinePlanBusCuCh2, dbo.pLinePlanBusiness.LinePlanBusCuCh3, dbo.pLinePlanBusiness.LinePlanBusCuCh4, 
                      dbo.pLinePlanBusiness.LinePlanBusCuCh5, dbo.pLinePlanBusiness.LinePlanBus1, dbo.pLinePlanBusiness.LinePlanBus2, 
                      dbo.pLinePlanBusiness.LinePlanBus3, dbo.pLinePlanBusiness.LinePlanBus4, dbo.pLinePlanBusiness.LinePlanBus5, 
                      dbo.pLinePlanBusiness.LinePlanBus6, dbo.pLinePlanBusiness.LinePlanBus7, dbo.pLinePlanBusiness.LinePlanBus8, 
                      dbo.pLinePlanBusiness.LinePlanBus9, dbo.pLinePlanBusiness.LinePlanBus10, dbo.pLinePlanBusiness.LinePlanBus11, 
                      dbo.pLinePlanBusiness.LinePlanBus12, dbo.pLinePlanBusiness.LinePlanBus13, dbo.pLinePlanBusiness.LinePlanBus14, 
                      dbo.pLinePlanBusiness.LinePlanBus15, dbo.pLinePlanBusiness.LinePlanBus16, dbo.pLinePlanBusiness.LinePlanBus17, 
                      dbo.pLinePlanBusiness.LinePlanBus18, dbo.pLinePlanBusiness.LinePlanBus19, dbo.pLinePlanBusiness.LinePlanBus20, 
                      dbo.pLinePlanFinancial.LinePlanFinancialDataType, dbo.pLinePlanFinancial.LinePlanFinancialDataFormat, 
                      dbo.pLinePlanFinancial.LinePlanFinancialCssClass, dbo.pLinePlanBusiness.LinePlanBusWpCh1, dbo.pLinePlanBusiness.LinePlanBusWpCh2, 
                      dbo.pLinePlanBusiness.LinePlanBusWpCh3, dbo.pLinePlanBusiness.LinePlanBusWpCh4
FROM         dbo.pLinePlanBusiness 
INNER JOIN dbo.pLinePlanFinancial ON dbo.pLinePlanBusiness.LinePlanFinancialID = dbo.pLinePlanFinancial.LinePlanFinancialID
ORDER BY dbo.pLinePlanBusiness.LinePlanAttributeItemSort1, dbo.pLinePlanBusiness.LinePlanAttributeItemSort2, 
                      dbo.pLinePlanBusiness.LinePlanAttributeItemSort3, dbo.pLinePlanBusiness.LinePlanAttributeItemSort4, dbo.pLinePlanBusiness.LinePlanFinancialSort








GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_AccessShareFolder_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_Group_AccessShareFolder_SELECT] (
@GroupID uniqueidentifier
)
AS 


SELECT 1 AS ShareTypeID, 'Share Folder' AS ShareFolder, a.AccessShareId, 
    a.AccessRoleId, a.AccessView, a.AccessCreate, 
    a.AccessModify, a.AccessDelete, a.AccessPrint, 
    a.GroupID , a.CUser, a.CDate, a.MUser, 
    a.MDate  
FROM  sAccessGroupShareFolder a WITH (NOLOCK)
WHERE a.GroupID = @GroupID



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleColorGroupItem_UPDATE]'
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE PROCEDURE [dbo].[spx_StyleColorGroupItem_UPDATE](@StyleColorGroupID uniqueidentifier,
@StyleColorID uniqueidentifier,
@StyleID uniqueidentifier,
@Quantity decimal,
@ModifiedBy nvarchar(200),
@ModifiedDate datetime,
@SeasonYearID NVARCHAR(50)= NULL)
--ALTER PROCEDURE [dbo].[spx_StyleColorGroupItem_UPDATE](@StyleColorGroupID uniqueidentifier,
--@StyleColorID uniqueidentifier,
--@StyleID uniqueidentifier,
--@Quantity decimal,
--@ModifiedDate datetime)
AS 

IF @SeasonYearID IS NOT NULL AND LEN(@SeasonYearID) > 0
UPDATE    pStyleColorGroupItem
SET              Quantity = @Quantity, 
--                 MDate = @ModifiedDate
                  MUser = @ModifiedBy, MDate = @ModifiedDate 
WHERE     (StyleColorGroupID = @StyleColorGroupID AND StyleColorID = @StyleColorID AND StyleID = @StyleID AND SeasonYearID = @SeasonYearID)
ELSE
UPDATE    pStyleColorGroupItem
SET              Quantity = @Quantity, 
--                 MDate = @ModifiedDate
                  MUser = @ModifiedBy, MDate = @ModifiedDate 
WHERE     (StyleColorGroupID = @StyleColorGroupID AND StyleColorID = @StyleColorID AND StyleID = @StyleID)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_LinePlanBusinessItem_SEL]'
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[vwx_LinePlanBusinessItem_SEL]
AS
SELECT     TOP (100) PERCENT dbo.pLinePlanBusinessItem.LinePlanBusinessID, dbo.pLinePlanBusinessItem.LinePlanID, 
                      dbo.pLinePlanBusinessItem.LinePlanFinancialID, dbo.pLinePlanFinancial.LinePlanFinancialText, dbo.pLinePlanBusinessItem.LinePlanFinancialSort, 
                      dbo.pLinePlanBusinessItem.LinePlanAttributeItemID1, dbo.pLinePlanBusinessItem.LinePlanAttributeItemID2, 
                      dbo.pLinePlanBusinessItem.LinePlanAttributeItemID3, dbo.pLinePlanBusinessItem.LinePlanAttributeItemID4, 
                      dbo.pLinePlanBusinessItem.LinePlanAttributeText1, dbo.pLinePlanBusinessItem.LinePlanAttributeText2, 
                      dbo.pLinePlanBusinessItem.LinePlanAttributeText3, dbo.pLinePlanBusinessItem.LinePlanAttributeText4, 
                      dbo.pLinePlanBusinessItem.LinePlanAttributeItemSort1, dbo.pLinePlanBusinessItem.LinePlanAttributeItemSort2, 
                      dbo.pLinePlanBusinessItem.LinePlanAttributeItemSort3, dbo.pLinePlanBusinessItem.LinePlanAttributeItemSort4, 
                      dbo.pLinePlanBusinessItem.LinePlanBusLYCh1, dbo.pLinePlanBusinessItem.LinePlanBusLYCh2, dbo.pLinePlanBusinessItem.LinePlanBusLYCh3, 
                      dbo.pLinePlanBusinessItem.LinePlanBusLYCh4, dbo.pLinePlanBusinessItem.LinePlanBusLYCh5, dbo.pLinePlanBusinessItem.LinePlanBusPnCh1, 
                      dbo.pLinePlanBusinessItem.LinePlanBusPnCh2, dbo.pLinePlanBusinessItem.LinePlanBusPnCh3, dbo.pLinePlanBusinessItem.LinePlanBusPnCh4, 
                      dbo.pLinePlanBusinessItem.LinePlanBusPnCh5, dbo.pLinePlanBusinessItem.LinePlanBusCuCh1, dbo.pLinePlanBusinessItem.LinePlanBusCuCh2, 
                      dbo.pLinePlanBusinessItem.LinePlanBusCuCh3, dbo.pLinePlanBusinessItem.LinePlanBusCuCh4, dbo.pLinePlanBusinessItem.LinePlanBusCuCh5, 
                      dbo.pLinePlanBusinessItem.LinePlanBus1, dbo.pLinePlanBusinessItem.LinePlanBus2, dbo.pLinePlanBusinessItem.LinePlanBus3, 
                      dbo.pLinePlanBusinessItem.LinePlanBus4, dbo.pLinePlanBusinessItem.LinePlanBus5, dbo.pLinePlanBusinessItem.LinePlanBus6, 
                      dbo.pLinePlanBusinessItem.LinePlanBus7, dbo.pLinePlanBusinessItem.LinePlanBus8, dbo.pLinePlanBusinessItem.LinePlanBus9, 
                      dbo.pLinePlanBusinessItem.LinePlanBus10, dbo.pLinePlanBusinessItem.LinePlanBus11, dbo.pLinePlanBusinessItem.LinePlanBus12, 
                      dbo.pLinePlanBusinessItem.LinePlanBus13, dbo.pLinePlanBusinessItem.LinePlanBus14, dbo.pLinePlanBusinessItem.LinePlanBus15, 
                      dbo.pLinePlanBusinessItem.LinePlanBus16, dbo.pLinePlanBusinessItem.LinePlanBus17, dbo.pLinePlanBusinessItem.LinePlanBus18, 
                      dbo.pLinePlanBusinessItem.LinePlanBus19, dbo.pLinePlanBusinessItem.LinePlanBus20, dbo.pLinePlanFinancial.LinePlanFinancialDataType, 
                      dbo.pLinePlanFinancial.LinePlanFinancialDataFormat, dbo.pLinePlanFinancial.LinePlanFinancialCssClass, dbo.pLinePlanBusinessItem.StyleID, 
                      dbo.pLinePlanBusinessItem.LinePlanBusWpCh1, dbo.pLinePlanBusinessItem.LinePlanBusWpCh2, dbo.pLinePlanBusinessItem.LinePlanBusWpCh3, 
                      dbo.pLinePlanBusinessItem.LinePlanBusWpCh4, dbo.pLinePlanBusinessItem.LinePlanBusWpCh5
FROM         dbo.pLinePlanBusinessItem 
INNER JOIN dbo.pLinePlanFinancial ON dbo.pLinePlanBusinessItem.LinePlanFinancialID = dbo.pLinePlanFinancial.LinePlanFinancialID
ORDER BY dbo.pLinePlanBusinessItem.LinePlanAttributeItemSort1, dbo.pLinePlanBusinessItem.LinePlanAttributeItemSort2, 
                      dbo.pLinePlanBusinessItem.LinePlanAttributeItemSort3, dbo.pLinePlanBusinessItem.LinePlanAttributeItemSort4, 
                      dbo.pLinePlanBusinessItem.LinePlanFinancialSort








GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_AccessStyleFolder_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_Group_AccessStyleFolder_SELECT] ( 
@GroupID uniqueidentifier
)
AS 


SELECT a.StyleTypeID, a.StyleTypeDescription, 
	b.AccessStyleId,  b.AccessRoleId, b.AccessView, b.AccessCreate, 
	b.AccessModify, b.AccessDelete, b.AccessPrint, b.AccessRemove, 
	b.GroupID, b.CUser, b.CDate,  b.MUser, 
	b.MDate, a.StyleTypeOrder
FROM  pStyleType a WITH (NOLOCK) INNER JOIN   sAccessGroupStyleFolder  b WITH (NOLOCK) ON a.StyleTypeID = b.StyleTypeID
WHERE b.GroupID = @GroupID
ORDER BY a.StyleTypeOrder



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_SampleRequestSubmit_SELECT]'
GO


/*****************
 * 4/30/07 - 5:00pm EST - Ryan Cabanas - Added the "@SampleRequestWorkflowID" variable, grabbed the value for that 
 * variable in the initial SELECT statement from the pSampleRequestSubmit table, and then I changed the CASE
 * selection where the SampleSize was chosen.  Selected the SampleSize from the pSampleRequestSpecSize table now.
 ****************/
/*****************
 * June 18 2009 - Clay Parker- Modified the Get Status Information Fields from Fraction to Decimal
 ****************/

ALTER           PROCEDURE [dbo].[rpx_SampleRequestSubmit_SELECT]
(
	@SampleRequestSubmitID varchar(50)
)
AS

/*Variables*/
DECLARE @StatusID nvarchar(5)
DECLARE @StatusDescription nvarchar(50)
DECLARE @SampleSubmitType nvarchar(50)
DECLARE @TradePartnerID uniqueidentifier
DECLARE	@TradePartnerVendorID uniqueidentifier
DECLARE	@TradePartnerName nvarchar(255)
DECLARE	@VendorName nvarchar(255)
DECLARE	@DueDate nvarchar(50)
DECLARE	@ReceivedDate nvarchar(50)
DECLARE	@ApprovedDate nvarchar(50)
DECLARE	@VendorDate nvarchar(50)
DECLARE	@ReviewedDate nvarchar(50)
DECLARE @WashType nvarchar(50)
DECLARE	@SpecSketchID nvarchar(255)
DECLARE	@SpecSketchVersion int
DECLARE @ImageID nvarchar(255)
DECLARE	@ImageHistoryID nvarchar(255)
DECLARE	@Version int
DECLARE @HeadingStr nvarchar(255)
DECLARE	@SampleSize nvarchar(10)
DECLARE @SubmitNumberExtension nvarchar(5)
DECLARE @ApprovedStr1 nvarchar(255)
DECLARE @ApprovedStr2 nvarchar(255)
DECLARE @ApprovedBy nvarchar(255)
DECLARE @ReviewedBy nvarchar(255)
DECLARE	@SampleRequestTradeID varchar(255)
DECLARE	@SampleWorkflowID nvarchar(5)
DECLARE	@Submit int
DECLARE	@StyleID varchar(50)
DECLARE @StyleSet int 
DECLARE @Count int
DECLARE @SampleRequestWorkflowID uniqueidentifier

/*Get some other variables needed.*/
SELECT
	@SampleRequestTradeID = SampleRequestTradeID,
	@SampleWorkflowID = SampleWorkflowID,
	@Submit = Submit,
	@StyleID = StyleID,
	@StyleSet = StyleSet,
	@StatusID = Status,
	@TradePartnerID = TradePartnerID,
	@TradePartnerVendorID = TradePartnerVendorID,
	@DueDate = DueDate,
	@ReceivedDate = RecDate,
	@ApprovedDate  = EndDate,
	@VendorDate  = VendorDate,
	@ReviewedDate = RevDate,
	@ReviewedBy = RevBy,
	@ApprovedBy = EndBy,
	@SampleRequestWorkflowID = SampleRequestWorkflowID
FROM pSampleRequestSubmit
WHERE SampleRequestSubmitID = @SampleRequestSubmitID

/*Get the status description of the submit*/
SELECT	@StatusDescription = Status
FROM	pSampleRequestSubmitStatus
WHERE	(StatusID = @StatusID)

/*Get the name of the sample submit type*/
SELECT	@SampleSubmitType = GroupName
FROM	pSampleWorkflow
WHERE	(SampleWorkflowID = @SampleWorkflowID)

/*Get Agent's name*/
SELECT	@TradePartnerName = TradePartnerName
FROM	uTradePartner
WHERE	TradePartnerID = @TradePartnerID

/*Get Vendor's name*/
SELECT	@VendorName = VendorName
FROM	uTradePartnerVendor
WHERE	TradePartnerVendorID = @TradePartnerVendorID

/*Change all the dates to a shorter date format*/
SET	@DueDate = CAST(Month(@DueDate) AS nvarchar(10)) + '/' +
	CAST(Day(@DueDate) AS nvarchar(10)) + '/' +
	CAST(Year(@DueDate) AS nvarchar(10))
SET	@ReceivedDate = CAST(Month(@ReceivedDate) AS nvarchar(10)) + '/' +
	CAST(Day(@ReceivedDate) AS nvarchar(10)) + '/' +
	CAST(Year(@ReceivedDate) AS nvarchar(10))
SET	@ApprovedDate = CAST(Month(@ApprovedDate) AS nvarchar(10)) + '/' +
	CAST(Day(@ApprovedDate) AS nvarchar(10)) + '/' +
	CAST(Year(@ApprovedDate) AS nvarchar(10))
SET	@VendorDate = CAST(Month(@VendorDate) AS nvarchar(10)) + '/' +
	CAST(Day(@VendorDate) AS nvarchar(10)) + '/' +
	CAST(Year(@VendorDate) AS nvarchar(10))SET	@ReviewedDate = CAST(Month(@ReviewedDate) AS nvarchar(10)) + '/' +
	CAST(Day(@ReviewedDate) AS nvarchar(10)) + '/' +
	CAST(Year(@ReviewedDate) AS nvarchar(10))

/*Get wash type of the style*/
SELECT	@WashType = WashType
FROM	pStyleHeader
WHERE	(StyleID = @StyleID)

/*Make sure washtype is not null*/
SET	@WashType = 
		CASE 
			WHEN UPPER(@WashType) IS NULL THEN 'TOL'
			WHEN UPPER(@WashType) = '' THEN 'TOL'
			WHEN UPPER(@WashType) = 'WASH' THEN 'TOL'
			ELSE 'TOLN'
		END 

/*Get the sample size*/
SELECT  @SampleSize =
	(CASE 
        WHEN Sel0 = 1 THEN Size0
        WHEN Sel1 = 1 THEN Size1
        WHEN Sel2 = 1 THEN Size2
        WHEN Sel3 = 1 THEN Size3
        WHEN Sel4 = 1 THEN Size4
        WHEN Sel5 = 1 THEN Size5
        WHEN Sel6 = 1 THEN Size6
        WHEN Sel7 = 1 THEN Size7
        WHEN Sel8 = 1 THEN Size8
        WHEN Sel9 = 1 THEN Size9
        WHEN Sel10 = 1 THEN Size10
        WHEN Sel11 = 1 THEN Size11
        WHEN Sel12 = 1 THEN Size12
        WHEN Sel13 = 1 THEN Size13
        WHEN Sel14 = 1 THEN Size14
        WHEN Sel15 = 1 THEN Size15
        WHEN Sel16 = 1 THEN Size16
        WHEN Sel17 = 1 THEN Size17
        WHEN Sel18 = 1 THEN Size18
        WHEN Sel19 = 1 THEN Size19
	END) FROM pSampleRequestSpecSize
	WHERE (SampleRequestWorkflowID = @SampleRequestWorkflowID)
		AND (SampleRequestTradeID = @SampleRequestTradeID)
		AND (StyleID = @StyleID)

/*Make heading string*/
IF (@Submit = 0)
	BEGIN
		SET @SubmitNumberExtension = 'th'
	END
ELSE IF (@Submit = 1)
	BEGIN
		SET @SubmitNumberExtension = 'st'
	END
ELSE IF (@Submit = 2)
	BEGIN
		SET @SubmitNumberExtension = 'nd'
	END
ELSE IF (@Submit = 3)
	BEGIN
		SET @SubmitNumberExtension = 'rd'
	END
ELSE 
	BEGIN
		SET @SubmitNumberExtension = 'th'
	END

SET @HeadingStr = @SampleSubmitType + ' / ' + CAST(@Submit AS nvarchar(2)) +
	@SubmitNumberExtension + ' Submit'

/*Made the 'Approved By-Reviewed By' string*/
IF ((@StatusID = 2) OR (@StatusID = 3))
	BEGIN
		SET @ApprovedStr1 = 'Approved By: '
		SET @ApprovedStr2 = @ApprovedBy + ' on ' + @ApprovedDate
	END
ELSE IF ((@ReviewedBy IS NULL) OR (@ReviewedBy = ''))
	BEGIN
		SET @ApprovedStr1 = 'Reviewed By: '
		SET @ApprovedStr2 = 'No Reviewer'
	END
ELSE
	BEGIN
		SET @ApprovedStr1 = 'Reviewed By: '
		SET @ApprovedStr2 = @ReviewedBy + ' on ' + @ReviewedDate
	END

/*Do counts to find out if there are any records.*/
SELECT @Count = COUNT(*)
FROM	pSampleRequestSpecItem LEFT OUTER JOIN pSampleRequestWorkflow ON
	pSampleRequestSpecItem.SampleRequestWorkflowID = pSampleRequestWorkflow.SampleRequestWorkflowID LEFT OUTER JOIN
	pSampleRequestSubmit ON
	pSampleRequestWorkflow.SampleRequestWorkflowID = pSampleRequestSubmit.SampleRequestWorkflowID
WHERE	(pSampleRequestSpecItem.StyleID = @StyleID) AND
	(pSampleRequestSpecItem.SampleRequestTradeID = @SampleRequestTradeID) AND
	(pSampleRequestSpecItem.SampleWorkflowID = @SampleWorkflowID) AND
	(pSampleRequestSpecItem.Submit = @Submit) AND
	(pSampleRequestSpecItem.Ask <> 0) AND 
	(pSampleRequestSpecItem.StyleSet = @StyleSet) AND
	(pSampleRequestSubmit.SampleRequestSubmitID = @SampleRequestSubmitID)


/*Get status information fields*/  /*Modified the below info on June 18th 2009 - Clay Parker - from Fraction to Decimal*/
IF (@Count <> 0)
	BEGIN
		SELECT
			@ApprovedStr1 AS ApprovedStr1,
			@ApprovedStr2 AS ApprovedStr2,
			@HeadingStr AS HeadingStr,
			@SampleSize AS SampleSize,
			@StatusID AS StatusID,
			@StatusDescription AS StatusDescription,
			@SampleSubmitType AS SampleSubmitType,
			--@TradePartnerID AS TradePartnerID,
			--@TradePartnerVendorID AS TradepartnerVendorID,
			@TradePartnerName AS TradePartnerName,
			@VendorName AS VendorName,
			pSampleRequestSpecItem.Critical,
			pSampleRequestSpecItem.POM,
			pSampleRequestSpecItem.PointMeasur,
			CAST(pSampleRequestSpecItem.TOL AS DECIMAL(18,3)) TOL,
			CAST(pSampleRequestSpecItem.TOLN AS DECIMAL(18,3)) TOLN,
			CAST(pSampleRequestSpecItem.Ask AS DECIMAL(18,3)) AS ASK,
			CAST(pSampleRequestSpecItem.[Var] AS DECIMAL(18,3)) AS [Var],
			CAST(pSampleRequestSpecItem.Vendor AS DECIMAL(18,3)) AS Vendor,
			CAST(pSampleRequestSpecItem.Spec AS DECIMAL(18,3)) AS Spec,
			CAST(pSampleRequestSpecItem.Rev AS DECIMAL(18,3)) AS Rev,
			CAST(pSampleRequestSpecItem.Final AS DECIMAL(18,3)) Final,
			@DueDate AS DueDate,
			pSampleRequestSubmit.NoTolerance,
			pSampleRequestSubmit.RecBy AS ReceivedBy,
			@ReceivedDate AS ReceivedDate, 
			@ApprovedBy AS ApprovedBy,
			@ApprovedDate AS ApprovedDate,
			pSampleRequestSubmit.VendorName AS VendorBy,
			@VendorDate AS VendorDate,
			pSampleRequestSubmit.RecWeight AS ReceivedWeight,
			pSampleRequestSubmit.VendorWeight AS VendorWeight,
			pSampleRequestSubmit.RecCarrier AS ShipMethod,
			pSampleRequestSubmit.RecTrackNo AS TrackingNo,
			@ReviewedBy AS ReviewedBy,
			@ReviewedDate AS ReviewedDate,
			pSampleRequestSubmit.Comment AS FitComments,
			pSampleRequestSubmit.VendorComment AS VendorComments,
			@WashType AS WashType
		FROM	pSampleRequestSpecItem LEFT OUTER JOIN pSampleRequestWorkflow ON
			pSampleRequestSpecItem.SampleRequestWorkflowID = pSampleRequestWorkflow.SampleRequestWorkflowID LEFT OUTER JOIN
			pSampleRequestSubmit ON
			pSampleRequestWorkflow.SampleRequestWorkflowID = pSampleRequestSubmit.SampleRequestWorkflowID
		WHERE	(pSampleRequestSpecItem.StyleID = @StyleID) AND
			(pSampleRequestSpecItem.SampleRequestTradeID = @SampleRequestTradeID) AND
			(pSampleRequestSpecItem.SampleWorkflowID = @SampleWorkflowID) AND
			(pSampleRequestSpecItem.Submit = @Submit) AND
			(pSampleRequestSpecItem.Ask <> 0) AND 
			(pSampleRequestSpecItem.StyleSet = @StyleSet) AND
			(pSampleRequestSubmit.SampleRequestSubmitID = @SampleRequestSubmitID)		ORDER BY	pSampleRequestSpecItem. Sort, pSampleRequestSpecItem.POM, pSampleRequestSpecItem.PointMeasur
	END
ELSE IF (@Count = 0)
	BEGIN
		SELECT
			@ApprovedStr1 AS ApprovedStr1,
			@ApprovedStr2 AS ApprovedStr2,
			@HeadingStr AS HeadingStr,
			@SampleSize AS SampleSize,
			@StatusID AS StatusID,
			@StatusDescription AS StatusDescription,
			@SampleSubmitType AS SampleSubmitType,
			--@TradePartnerID AS TradePartnerID,
			--@TradePartnerVendorID AS TradepartnerVendorID,
			@TradePartnerName AS TradePartnerName,
			@VendorName AS VendorName,
			0 AS Critical,
			'' AS POM,
			'' AS PointMeasur,
			NULL AS TOL,
			NULL AS TOLN,
			NULL AS Ask,
			NULL AS [Var],
			NULL AS Vendor,
			NULL AS Spec,
			NULL AS Rev,
			NULL AS Final,
			@DueDate AS DueDate,
			pSampleRequestSubmit.NoTolerance,
			pSampleRequestSubmit.RecBy AS ReceivedBy,
			@ReceivedDate AS ReceivedDate, 
			@ApprovedBy AS ApprovedBy,
			@ApprovedDate AS ApprovedDate,
			pSampleRequestSubmit.VendorName AS VendorBy,
			@VendorDate AS VendorDate,
			pSampleRequestSubmit.RecWeight AS ReceivedWeight,
			pSampleRequestSubmit.VendorWeight AS VendorWeight,
			pSampleRequestSubmit.RecCarrier AS ShipMethod,
			pSampleRequestSubmit.RecTrackNo AS TrackingNo,
			@ReviewedBy AS ReviewedBy,
			@ReviewedDate AS ReviewedDate,
			pSampleRequestSubmit.Comment AS FitComments,
			pSampleRequestSubmit.VendorComment AS VendorComments,
			@WashType AS WashType
		FROM	pSampleRequestWorkflow INNER JOIN pSampleRequestSubmit ON
			pSampleRequestWorkflow.SampleRequestWorkflowID = pSampleRequestSubmit.SampleRequestWorkflowID
		WHERE pSampleRequestSubmit.SampleRequestSubmitID = @SampleRequestSubmitID
	END






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_SaveColorGroups_INSERT]'
GO
SET QUOTED_IDENTIFIER OFF
GO
/****** Object:  StoredProcedure [dbo].[spx_SaveColorGroups_INSERT]    Script Date: 03/09/2010 10:12:58 ******/


CREATE PROCEDURE [dbo].[spx_SaveColorGroups_INSERT] ( @StyleID UNIQUEIDENTIFIER, @StyleSet int,  @ColorGroupID UNIQUEIDENTIFIER, @ColorGroupName nvarchar(200), @CUser NVARCHAR(200),   
@CDate DATETIME, @SeasonYearID NVARCHAR(50)= NULL ) AS  INSERT INTO pStyleColorGroup (StyleID, StyleSet, ColorGroupID, ColorGroupName, CUser, CDate, SeasonYearID)  
 VALUES (@StyleID, @StyleSet, @ColorGroupID, @ColorGroupName, @CUser, @CDate, @SeasonYearID)  
 
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanShowroom_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO

/* Comment #01 - Clayton Parker - Oct 15 2009. 
	Burberry needed the showrooms to appear in a certain order. This can be setup based on the pShowroom.Sort table. 
*/

CREATE PROCEDURE [dbo].[spx_LinePlanShowroom_SELECT] (
@LinePlanID  UNIQUEIDENTIFIER ,
@LinePlanRangeID UNIQUEIDENTIFIER 
)
AS 


	SELECT a.ShowroomID, b.Custom as Showroom
	FROM dbo.pLinePlanShowroomItem a
	INNER JOIN pShowroom b ON a.ShowroomID =  b.CustomID 
	WHERE a.LinePlanRangeID = @LinePlanRangeID
	Order By b.Sort -- Comment #01




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanBusinessRangeRollup2_SELECT]'
GO


ALTER PROCEDURE [dbo].[spx_LinePlanBusinessRangeRollup2_SELECT]
(
@LinePlanIndex varchar(1),
@LinePlanId varchar(40),
@LinePlanAttributeItemId1 varchar(40),
@LinePlanAttributeItemId2 varchar(40)
)
AS 


DECLARE @NoOfStyleText VARCHAR(200)
DECLARE @NoOfColorText VARCHAR(200)
DECLARE @NoOfBodyText VARCHAR(200)
DECLARE @NoOfFabricText VARCHAR(200)
DECLARE @NoOfOptionsText VARCHAR(200)
DECLARE @TargetAvgRetailPriceLowText VARCHAR(200)
DECLARE @NoOfStyleLowText VARCHAR(200)
DECLARE @TargetAvgRetailPriceMedText VARCHAR(200)
DECLARE @NoOfStyleMedText VARCHAR(200)
DECLARE @TargetAvgRetailPriceHighText VARCHAR(200)
DECLARE @NoOfStyleHighText VARCHAR(200)
DECLARE @MarkupFactorText VARCHAR(200)
DECLARE @SalesUnitText VARCHAR(200)
DECLARE @ProjectedWhsText VARCHAR(200)
DECLARE @InitialGrossMarginRtlText VARCHAR(200)

DECLARE @LY1_NoOfStyle INTEGER
DECLARE @LY1_NoOfFabric INTEGER
DECLARE @LY1_NoOfBody INTEGER 
DECLARE @LY1_NoOfColor INTEGER
DECLARE @LY1_NoOfOptions INTEGER
DECLARE @LY1_MarkupFactor DECIMAL(18, 3)
DECLARE @LY1_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @LY1_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @LY1_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @LY1_NoOfStyleLow DECIMAL(18, 3)
DECLARE @LY1_NoOfStyleMed DECIMAL(18, 3)
DECLARE @LY1_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @LY1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @LY1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @LY1_SalesUnit DECIMAL(18, 3)
DECLARE @LY1_ProjectedWhs DECIMAL(18, 3)
DECLARE @LY1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY1_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @LY2_NoOfStyle INTEGER
DECLARE @LY2_NoOfFabric INTEGER
DECLARE @LY2_NoOfBody INTEGER 
DECLARE @LY2_NoOfColor INTEGER
DECLARE @LY2_NoOfOptions INTEGER
DECLARE @LY2_MarkupFactor DECIMAL(18, 3)
DECLARE @LY2_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @LY2_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @LY2_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @LY2_NoOfStyleLow DECIMAL(18, 3)
DECLARE @LY2_NoOfStyleMed DECIMAL(18, 3)
DECLARE @LY2_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @LY2_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @LY2_AvgTargetFOB DECIMAL(18, 3)
DECLARE @LY2_SalesUnit DECIMAL(18, 3)
DECLARE @LY2_ProjectedWhs DECIMAL(18, 3)
DECLARE @LY2_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY2_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY2_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY2_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @LY3_NoOfStyle INTEGER
DECLARE @LY3_NoOfFabric INTEGER
DECLARE @LY3_NoOfBody INTEGER 
DECLARE @LY3_NoOfColor INTEGER
DECLARE @LY3_NoOfOptions INTEGER
DECLARE @LY3_MarkupFactor DECIMAL(18, 3)
DECLARE @LY3_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @LY3_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @LY3_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @LY3_NoOfStyleLow DECIMAL(18, 3)
DECLARE @LY3_NoOfStyleMed DECIMAL(18, 3)
DECLARE @LY3_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @LY3_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @LY3_AvgTargetFOB DECIMAL(18, 3)
DECLARE @LY3_SalesUnit DECIMAL(18, 3)
DECLARE @LY3_ProjectedWhs DECIMAL(18, 3)
DECLARE @LY3_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY3_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY3_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY3_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @LY4_NoOfStyle INTEGER
DECLARE @LY4_NoOfFabric INTEGER
DECLARE @LY4_NoOfBody INTEGER 
DECLARE @LY4_NoOfColor INTEGER
DECLARE @LY4_NoOfOptions INTEGER
DECLARE @LY4_MarkupFactor DECIMAL(18, 3)
DECLARE @LY4_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @LY4_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @LY4_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @LY4_NoOfStyleLow DECIMAL(18, 3)
DECLARE @LY4_NoOfStyleMed DECIMAL(18, 3)
DECLARE @LY4_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @LY4_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @LY4_AvgTargetFOB DECIMAL(18, 3)
DECLARE @LY4_SalesUnit DECIMAL(18, 3)
DECLARE @LY4_ProjectedWhs DECIMAL(18, 3)
DECLARE @LY4_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY4_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY4_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY4_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @PL1_NoOfStyle INTEGER
DECLARE @PL1_NoOfFabric INTEGER
DECLARE @PL1_NoOfBody INTEGER 
DECLARE @PL1_NoOfColor INTEGER
DECLARE @PL1_NoOfOptions INTEGER
DECLARE @PL1_MarkupFactor DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleLow DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleMed DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @PL1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @PL1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @PL1_SalesUnit DECIMAL(18, 3)
DECLARE @PL1_ProjectedWhs DECIMAL(18, 3)
DECLARE @PL1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL1_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @PL2_NoOfStyle INTEGER
DECLARE @PL2_NoOfFabric INTEGER
DECLARE @PL2_NoOfBody INTEGER 
DECLARE @PL2_NoOfColor INTEGER
DECLARE @PL2_NoOfOptions INTEGER
DECLARE @PL2_MarkupFactor DECIMAL(18, 3)
DECLARE @PL2_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @PL2_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @PL2_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @PL2_NoOfStyleLow DECIMAL(18, 3)
DECLARE @PL2_NoOfStyleMed DECIMAL(18, 3)
DECLARE @PL2_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @PL2_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @PL2_AvgTargetFOB DECIMAL(18, 3)
DECLARE @PL2_SalesUnit DECIMAL(18, 3)
DECLARE @PL2_ProjectedWhs DECIMAL(18, 3)
DECLARE @PL2_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL2_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL2_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL2_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @PL3_NoOfStyle INTEGER
DECLARE @PL3_NoOfFabric INTEGER
DECLARE @PL3_NoOfBody INTEGER 
DECLARE @PL3_NoOfColor INTEGER
DECLARE @PL3_NoOfOptions INTEGER
DECLARE @PL3_MarkupFactor DECIMAL(18, 3)
DECLARE @PL3_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @PL3_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @PL3_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @PL3_NoOfStyleLow DECIMAL(18, 3)
DECLARE @PL3_NoOfStyleMed DECIMAL(18, 3)
DECLARE @PL3_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @PL3_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @PL3_AvgTargetFOB DECIMAL(18, 3)
DECLARE @PL3_SalesUnit DECIMAL(18, 3)
DECLARE @PL3_ProjectedWhs DECIMAL(18, 3)
DECLARE @PL3_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL3_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL3_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL3_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @PL4_NoOfStyle INTEGER
DECLARE @PL4_NoOfFabric INTEGER
DECLARE @PL4_NoOfBody INTEGER 
DECLARE @PL4_NoOfColor INTEGER
DECLARE @PL4_NoOfOptions INTEGER
DECLARE @PL4_MarkupFactor DECIMAL(18, 3)
DECLARE @PL4_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @PL4_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @PL4_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @PL4_NoOfStyleLow DECIMAL(18, 3)
DECLARE @PL4_NoOfStyleMed DECIMAL(18, 3)
DECLARE @PL4_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @PL4_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @PL4_AvgTargetFOB DECIMAL(18, 3)
DECLARE @PL4_SalesUnit DECIMAL(18, 3)
DECLARE @PL4_ProjectedWhs DECIMAL(18, 3)
DECLARE @PL4_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL4_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL4_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL4_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @Cu1_NoOfStyle INTEGER
DECLARE @Cu1_NoOfFabric INTEGER
DECLARE @Cu1_NoOfBody INTEGER 
DECLARE @Cu1_NoOfColor INTEGER
DECLARE @Cu1_NoOfOptions INTEGER
DECLARE @Cu1_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @Cu1_NoOfStyleLow DECIMAL(18, 3)
DECLARE @Cu1_NoOfStyleMed DECIMAL(18, 3)
DECLARE @Cu1_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Cu1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Cu1_SalesUnit DECIMAL(18, 3)
DECLARE @Cu1_ProjectedWhs DECIMAL(18, 3)
DECLARE @Cu1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu1_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @Cu2_NoOfStyle INTEGER
DECLARE @Cu2_NoOfFabric INTEGER
DECLARE @Cu2_NoOfBody INTEGER 
DECLARE @Cu2_NoOfColor INTEGER
DECLARE @Cu2_NoOfOptions INTEGER
DECLARE @Cu2_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu2_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @Cu2_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @Cu2_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @Cu2_NoOfStyleLow DECIMAL(18, 3)
DECLARE @Cu2_NoOfStyleMed DECIMAL(18, 3)
DECLARE @Cu2_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @Cu2_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Cu2_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Cu2_SalesUnit DECIMAL(18, 3)
DECLARE @Cu2_ProjectedWhs DECIMAL(18, 3)
DECLARE @Cu2_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu2_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu2_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu2_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @Cu3_NoOfStyle INTEGER
DECLARE @Cu3_NoOfFabric INTEGER
DECLARE @Cu3_NoOfBody INTEGER 
DECLARE @Cu3_NoOfColor INTEGER
DECLARE @Cu3_NoOfOptions INTEGER
DECLARE @Cu3_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu3_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @Cu3_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @Cu3_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @Cu3_NoOfStyleLow DECIMAL(18, 3)
DECLARE @Cu3_NoOfStyleMed DECIMAL(18, 3)
DECLARE @Cu3_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @Cu3_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Cu3_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Cu3_SalesUnit DECIMAL(18, 3)
DECLARE @Cu3_ProjectedWhs DECIMAL(18, 3)
DECLARE @Cu3_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu3_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu3_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu3_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @Cu4_NoOfStyle INTEGER
DECLARE @Cu4_NoOfFabric INTEGER
DECLARE @Cu4_NoOfBody INTEGER 
DECLARE @Cu4_NoOfColor INTEGER
DECLARE @Cu4_NoOfOptions INTEGER
DECLARE @Cu4_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu4_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @Cu4_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @Cu4_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @Cu4_NoOfStyleLow DECIMAL(18, 3)
DECLARE @Cu4_NoOfStyleMed DECIMAL(18, 3)
DECLARE @Cu4_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @Cu4_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Cu4_AvgTargetFOB DECIMAL(18, 3)	
DECLARE @Cu4_SalesUnit DECIMAL(18, 3)
DECLARE @Cu4_ProjectedWhs DECIMAL(18, 3)
DECLARE @Cu4_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu4_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu4_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu4_WeightGrossMarginRtl DECIMAL(18, 3)


DECLARE @Wp1_NoOfStyle INT
DECLARE @Wp1_NoOfFabric INT
DECLARE @Wp1_NoOfBody INT
DECLARE @Wp1_NoOfColor INT
DECLARE @Wp1_NoOfOptions INT
DECLARE @Wp1_MarkupFactor DECIMAL(18, 3)
DECLARE @Wp1_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @Wp1_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @Wp1_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @Wp1_NoOfStyleLow DECIMAL(18, 3)
DECLARE @Wp1_NoOfStyleMed DECIMAL(18, 3)
DECLARE @Wp1_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @Wp1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Wp1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Wp1_SalesUnit DECIMAL(18, 3)
DECLARE @Wp1_ProjectedWhs DECIMAL(18, 3)
DECLARE @Wp1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Wp1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp1_WeightGrossMarginRtl DECIMAL(18, 3)


DECLARE @Wp2_NoOfStyle INTEGER
DECLARE @Wp2_NoOfFabric INTEGER
DECLARE @Wp2_NoOfBody INTEGER 
DECLARE @Wp2_NoOfColor INTEGER
DECLARE @Wp2_NoOfOptions INTEGER
DECLARE @Wp2_MarkupFactor DECIMAL(18, 3)
DECLARE @Wp2_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @Wp2_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @Wp2_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @Wp2_NoOfStyleLow DECIMAL(18, 3)
DECLARE @Wp2_NoOfStyleMed DECIMAL(18, 3)
DECLARE @Wp2_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @Wp2_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Wp2_AvgTargetFOB DECIMAL(18, 3)	
DECLARE @Wp2_SalesUnit DECIMAL(18, 3)
DECLARE @Wp2_ProjectedWhs DECIMAL(18, 3)
DECLARE @Wp2_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Wp2_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp2_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp2_WeightGrossMarginRtl DECIMAL(18, 3)


DECLARE @Wp3_NoOfStyle INT
DECLARE @Wp3_NoOfFabric INT
DECLARE @Wp3_NoOfBody INT
DECLARE @Wp3_NoOfColor INT
DECLARE @Wp3_NoOfOptions INT
DECLARE @Wp3_MarkupFactor DECIMAL(18, 3)
DECLARE @Wp3_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @Wp3_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @Wp3_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @Wp3_NoOfStyleLow DECIMAL(18, 3)
DECLARE @Wp3_NoOfStyleMed DECIMAL(18, 3)
DECLARE @Wp3_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @Wp3_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Wp3_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Wp3_SalesUnit DECIMAL(18, 3)
DECLARE @Wp3_ProjectedWhs DECIMAL(18, 3)
DECLARE @Wp3_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Wp3_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp3_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp3_WeightGrossMarginRtl DECIMAL(18, 3)


DECLARE @Wp4_NoOfStyle INT
DECLARE @Wp4_NoOfFabric INT
DECLARE @Wp4_NoOfBody INT
DECLARE @Wp4_NoOfColor INT
DECLARE @Wp4_NoOfOptions INT
DECLARE @Wp4_MarkupFactor DECIMAL(18, 3)
DECLARE @Wp4_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @Wp4_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @Wp4_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @Wp4_NoOfStyleLow DECIMAL(18, 3)
DECLARE @Wp4_NoOfStyleMed DECIMAL(18, 3)
DECLARE @Wp4_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @Wp4_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Wp4_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Wp4_SalesUnit DECIMAL(18, 3)
DECLARE @Wp4_ProjectedWhs DECIMAL(18, 3)
DECLARE @Wp4_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Wp4_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp4_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp4_WeightGrossMarginRtl DECIMAL(18, 3)


---- Create Temp table
CREATE TABLE #tmpLinePlanBusiness(
	[LinePlanID] [uniqueidentifier] NULL,
	[LinePlanFinancialID] [uniqueidentifier] NULL,
	[LinePlanFinancialText] [nvarchar](100) NULL,
	[LinePlanAttributeItemID1] [uniqueidentifier] NULL,
	[LinePlanAttributeItemID2] [uniqueidentifier] NULL,
	[LinePlanAttributeItemID3] [uniqueidentifier] NULL,
	[LinePlanAttributeItemID4] [uniqueidentifier] NULL,
	[LinePlanBusLYCh1] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusLYCh2] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusLYCh3] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusLYCh4] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusLYCh5] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusPnCh1] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusPnCh2] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusPnCh3] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusPnCh4] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusPnCh5] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusCuCh1] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusCuCh2] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusCuCh3] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusCuCh4] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusCuCh5] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanFinancialSort] [varchar](5) NULL ,
	[LinePlanBusWpCh1] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusWpCh2] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusWpCh3] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusWpCh4] [decimal](18, 3) NULL DEFAULT ((0)), 
	[LinePlanBusWpCh5] [decimal](18, 3) NULL DEFAULT ((0)),
)


---========================================================================================================================
-- <!-- 1 -->
-- # of Style
SELECT  @NoOfStyleText = LinePlanFinancialText,
@LY1_NoOfStyle = SUM(LinePlanBusLYCh1), @LY2_NoOfStyle = SUM(LinePlanBusLYCh2), @LY3_NoOfStyle = SUM(LinePlanBusLYCh3), @LY4_NoOfStyle = SUM(LinePlanBusLYCh4), 
@PL1_NoOfStyle = SUM(LinePlanBusPnCh1), @PL2_NoOfStyle = SUM(LinePlanBusPnCh2), @PL3_NoOfStyle = SUM(LinePlanBusPnCh3), @PL4_NoOfStyle = SUM(LinePlanBusPnCh4), 
@Cu1_NoOfStyle = SUM(LinePlanBusCuCh1), @Cu2_NoOfStyle = SUM(LinePlanBusCuCh2), @Cu3_NoOfStyle = SUM(LinePlanBusCuCh3), @Cu4_NoOfStyle = SUM(LinePlanBusCuCh4), 
@Wp1_NoOfStyle = SUM(LinePlanBusWpCh1), @Wp2_NoOfStyle = SUM(LinePlanBusWpCh2), @Wp3_NoOfStyle = SUM(LinePlanBusWpCh3), @Wp4_NoOfStyle = SUM(LinePlanBusWpCh4)
FROM pLinePlanBusiness 
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000004' 
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND	LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2

INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1, LinePlanBusLYCh2,LinePlanBusLYCh3,LinePlanBusLYCh4,
LinePlanBusPnCh1,LinePlanBusPnCh2,LinePlanBusPnCh3,LinePlanBusPnCh4,
LinePlanBusCuCh1,LinePlanBusCuCh2,LinePlanBusCuCh3,LinePlanBusCuCh4,
LinePlanAttributeItemID1,LinePlanFinancialSort,
LinePlanBusWpCh1, LinePlanBusWpCh2, LinePlanBusWpCh3, LinePlanBusWpCh4 )
VALUES (  @LinePlanID, '10000000-0000-0000-0000-000000000004', @NoOfStyleText, 
@LY1_NoOfStyle, @LY2_NoOfStyle, @LY3_NoOfStyle, @LY4_NoOfStyle, 
@PL1_NoOfStyle, @PL2_NoOfStyle, @PL3_NoOfStyle, @PL4_NoOfStyle, 
@Cu1_NoOfStyle, @Cu2_NoOfStyle, @Cu3_NoOfStyle, @Cu4_NoOfStyle, 
@LinePlanAttributeItemID1,'0001',
@Wp1_NoOfStyle, @Wp2_NoOfStyle, @Wp3_NoOfStyle, @Wp4_NoOfStyle )


---========================================================================================================================
-- <!-- 2 -->
--- # of Fabric
SELECT @NoOfFabricText = LinePlanFinancialText,
@LY1_NoOfFabric = SUM(LinePlanBusLYCh1), @LY2_NoOfFabric = SUM(LinePlanBusLYCh2),@LY3_NoOfFabric = SUM(LinePlanBusLYCh3), @LY4_NoOfFabric = SUM(LinePlanBusLYCh4), 
@PL1_NoOfFabric = SUM(LinePlanBusPnCh1), @PL2_NoOfFabric = SUM(LinePlanBusPnCh2), @PL3_NoOfFabric = SUM(LinePlanBusPnCh3), @PL4_NoOfFabric = SUM(LinePlanBusPnCh4), 
@Cu1_NoOfFabric = SUM(LinePlanBusCuCh1), @Cu2_NoOfFabric = SUM(LinePlanBusCuCh2), @Cu3_NoOfFabric = SUM(LinePlanBusCuCh3), @Cu4_NoOfFabric = SUM(LinePlanBusCuCh4),
@Wp1_NoOfFabric = SUM(LinePlanBusWpCh1), @Wp2_NoOfFabric = SUM(LinePlanBusWpCh2), @Wp3_NoOfFabric = SUM(LinePlanBusWpCh3), @Wp4_NoOfFabric = SUM(LinePlanBusWpCh4)  
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000001'
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND LinePlanId = @LinePlanId 
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2

INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusLYCh2,LinePlanBusLYCh3,LinePlanBusLYCh4,
LinePlanBusPnCh1,LinePlanBusPnCh2,LinePlanBusPnCh3,LinePlanBusPnCh4,
LinePlanBusCuCh1,LinePlanBusCuCh2,LinePlanBusCuCh3,LinePlanBusCuCh4,
LinePlanAttributeItemID1,LinePlanFinancialSort,
LinePlanBusWpCh1,LinePlanBusWpCh2,LinePlanBusWpCh3,LinePlanBusWpCh4 )
VALUES ( @LinePlanID, '10000000-0000-0000-0000-000000000001', @NoOfFabricText, 
@LY1_NoOfFabric, @LY2_NoOfFabric, @LY3_NoOfFabric, @LY4_NoOfFabric, 
@PL1_NoOfFabric, @PL2_NoOfFabric, @PL3_NoOfFabric, @PL4_NoOfFabric, 
@Cu1_NoOfFabric, @Cu2_NoOfFabric, @Cu3_NoOfFabric, @Cu4_NoOfFabric, 
@LinePlanAttributeItemID1, '0002',
@Wp1_NoOfFabric, @Wp2_NoOfFabric, @Wp3_NoOfFabric, @Wp4_NoOfFabric 
)


---========================================================================================================================
-- <!-- 3 -->
--- # of Body
SELECT  @NoOfBodyText = LinePlanFinancialText, 
@LY1_NoOfBody = SUM(LinePlanBusLYCh1), @LY2_NoOfBody = SUM(LinePlanBusLYCh2),@LY3_NoOfBody = SUM(LinePlanBusLYCh3), @LY4_NoOfBody = SUM(LinePlanBusLYCh4), 
@PL1_NoOfBody = SUM(LinePlanBusPnCh1), @PL2_NoOfBody = SUM(LinePlanBusPnCh2), @PL3_NoOfBody = SUM(LinePlanBusPnCh3), @PL4_NoOfBody = SUM(LinePlanBusPnCh4), 
@Cu1_NoOfBody = SUM(LinePlanBusCuCh1), @Cu2_NoOfBody = SUM(LinePlanBusCuCh2), @Cu3_NoOfBody = SUM(LinePlanBusCuCh3), @Cu4_NoOfBody = SUM(LinePlanBusCuCh4) ,
@Wp1_NoOfBody = SUM(LinePlanBusWpCh1), @Wp2_NoOfBody = SUM(LinePlanBusWpCh2), @Wp3_NoOfBody = SUM(LinePlanBusWpCh3), @Wp4_NoOfBody = SUM(LinePlanBusWpCh4) 
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000003'
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND	LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2

INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1, LinePlanBusLYCh2,LinePlanBusLYCh3,LinePlanBusLYCh4,
LinePlanBusPnCh1,LinePlanBusPnCh2,LinePlanBusPnCh3,LinePlanBusPnCh4,
LinePlanBusCuCh1,LinePlanBusCuCh2,LinePlanBusCuCh3,LinePlanBusCuCh4,
LinePlanAttributeItemID1,LinePlanFinancialSort, 
LinePlanBusWpCh1,LinePlanBusWpCh2,LinePlanBusWpCh3,LinePlanBusWpCh4 )
VALUES ( @LinePlanID, '10000000-0000-0000-0000-000000000003', @NoOfBodyText, 
@LY1_NoOfBody,	@LY2_NoOfBody, @LY3_NoOfBody, @LY4_NoOfBody, 
@PL1_NoOfBody, @PL2_NoOfBody, @PL3_NoOfBody, @PL4_NoOfBody, 
@Cu1_NoOfBody, @Cu2_NoOfBody, @Cu3_NoOfBody, @Cu4_NoOfBody, 
@LinePlanAttributeItemID1,'0003',
@Wp1_NoOfBody, @Wp2_NoOfBody, @Wp3_NoOfBody, @Wp4_NoOfBody 
)

---========================================================================================================================
-- <!-- 4 -->
-- # of Color

SELECT  @NoOfColorText = LinePlanFinancialText,
@LY1_NoOfColor = SUM(LinePlanBusLYCh1), @LY2_NoOfColor = SUM(LinePlanBusLYCh2),@LY3_NoOfColor = SUM(LinePlanBusLYCh3), @LY4_NoOfColor = SUM(LinePlanBusLYCh4), 
@PL1_NoOfColor = SUM(LinePlanBusPnCh1), @PL2_NoOfColor = SUM(LinePlanBusPnCh2), @PL3_NoOfColor = SUM(LinePlanBusPnCh3), @PL4_NoOfColor = SUM(LinePlanBusPnCh4), 
@Cu1_NoOfColor = SUM(LinePlanBusCuCh1), @Cu2_NoOfColor = SUM(LinePlanBusCuCh2), @Cu3_NoOfColor = SUM(LinePlanBusCuCh3), @Cu4_NoOfColor = SUM(LinePlanBusCuCh4) ,
@Wp1_NoOfColor = SUM(LinePlanBusWpCh1), @Wp2_NoOfColor = SUM(LinePlanBusWpCh2), @Wp3_NoOfColor = SUM(LinePlanBusWpCh3), @Wp4_NoOfColor = SUM(LinePlanBusWpCh4) 
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000002' 
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND	LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2

INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusLYCh2,LinePlanBusLYCh3,LinePlanBusLYCh4,
LinePlanBusPnCh1,LinePlanBusPnCh2,LinePlanBusPnCh3,LinePlanBusPnCh4,
LinePlanBusCuCh1,LinePlanBusCuCh2,LinePlanBusCuCh3,LinePlanBusCuCh4,
LinePlanAttributeItemID1,LinePlanFinancialSort, 
LinePlanBusWpCh1,LinePlanBusWpCh2,LinePlanBusWpCh3,LinePlanBusWpCh4 )
VALUES ( @LinePlanID, '10000000-0000-0000-0000-000000000002', @NoOfColorText, 
@LY1_NoOfColor, @LY2_NoOfColor, @LY3_NoOfColor, @LY4_NoOfColor, 
@PL1_NoOfColor, @PL2_NoOfColor, @PL3_NoOfColor, @PL4_NoOfColor, 
@Cu1_NoOfColor, @Cu2_NoOfColor, @Cu3_NoOfColor, @Cu4_NoOfColor, 
@LinePlanAttributeItemID1,'0004' ,
@Wp1_NoOfColor, @Wp2_NoOfColor, @Wp3_NoOfColor, @Wp4_NoOfColor
)

---========================================================================================================================
-- <!-- 5 -->
---- # of Options

SELECT  @NoOfColorText = LinePlanFinancialText,
@LY1_NoOfOptions = SUM(LinePlanBusLYCh1), @LY2_NoOfOptions = SUM(LinePlanBusLYCh2), @LY3_NoOfOptions = SUM(LinePlanBusLYCh3), @LY4_NoOfOptions  = SUM(LinePlanBusLYCh4), 
@PL1_NoOfOptions = SUM(LinePlanBusPnCh1), @PL2_NoOfOptions = SUM(LinePlanBusPnCh2), @PL3_NoOfOptions = SUM(LinePlanBusPnCh3), @PL4_NoOfOptions = SUM(LinePlanBusPnCh4), 
@Cu1_NoOfOptions = SUM(LinePlanBusCuCh1), @Cu2_NoOfOptions = SUM(LinePlanBusCuCh2), @Cu3_NoOfOptions = SUM(LinePlanBusCuCh3), @Cu4_NoOfOptions = SUM(LinePlanBusCuCh4),
@Wp1_NoOfOptions = SUM(LinePlanBusWpCh1), @Wp2_NoOfOptions = SUM(LinePlanBusWpCh2), @Wp3_NoOfOptions = SUM(LinePlanBusWpCh3), @Wp4_NoOfOptions = SUM(LinePlanBusWpCh4)  
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000005' 
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND	LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2


INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusLYCh2,LinePlanBusLYCh3,LinePlanBusLYCh4,
LinePlanBusPnCh1,LinePlanBusPnCh2,LinePlanBusPnCh3,LinePlanBusPnCh4,
LinePlanBusCuCh1,LinePlanBusCuCh2,LinePlanBusCuCh3,LinePlanBusCuCh4,
LinePlanAttributeItemID1,LinePlanFinancialSort,
LinePlanBusWpCh1,LinePlanBusWpCh2,LinePlanBusWpCh3,LinePlanBusWpCh4 )
VALUES ( @LinePlanID, '10000000-0000-0000-0000-000000000005', 'No of Options', 
@LY1_NoOfOptions, @LY2_NoOfOptions, @LY3_NoOfOptions, @LY4_NoOfOptions, 
@PL1_NoOfOptions, @PL2_NoOfOptions, @PL3_NoOfOptions, @PL4_NoOfOptions,
@Cu1_NoOfOptions, @Cu2_NoOfOptions, @Cu3_NoOfOptions, @Cu4_NoOfOptions,
@LinePlanAttributeItemID1,	'0005', 
@Wp1_NoOfOptions, @Wp2_NoOfOptions, @Wp3_NoOfOptions, @Wp4_NoOfOptions )

/*
INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusLYCh2,LinePlanBusLYCh3,LinePlanBusLYCh4,
LinePlanBusPnCh1,LinePlanBusPnCh2,LinePlanBusPnCh3,LinePlanBusPnCh4,
LinePlanBusCuCh1,LinePlanBusCuCh2,LinePlanBusCuCh3,LinePlanBusCuCh4,
LinePlanAttributeItemID1,LinePlanFinancialSort)
VALUES ( @LinePlanID, '10000000-0000-0000-0000-000000000005', 'No of Options', 
(@LY1_NoOfStyle * @LY1_NoOfFabric * @LY1_NoOfColor), (@LY2_NoOfStyle * @LY2_NoOfFabric * @LY2_NoOfColor), (@LY3_NoOfStyle * @LY3_NoOfFabric * @LY3_NoOfColor), (@LY4_NoOfStyle * @LY4_NoOfFabric * @LY4_NoOfColor), 
(@PL1_NoOfStyle * @PL1_NoOfFabric * @PL1_NoOfColor), (@PL2_NoOfStyle * @PL2_NoOfFabric * @PL2_NoOfColor), (@PL3_NoOfStyle * @PL3_NoOfFabric * @PL3_NoOfColor), (@PL4_NoOfStyle * @PL4_NoOfFabric * @PL4_NoOfColor), 
(@Cu1_NoOfStyle * @Cu1_NoOfFabric * @Cu1_NoOfColor), (@Cu2_NoOfStyle * @Cu2_NoOfFabric * @Cu2_NoOfColor), (@Cu3_NoOfStyle * @Cu3_NoOfFabric * @Cu3_NoOfColor), (@Cu4_NoOfStyle * @Cu4_NoOfFabric * @Cu4_NoOfColor), 
@LinePlanAttributeItemID1,	'0005')
*/

---========================================================================================================================
-- <!-- 6 -->

SELECT 
	#tmpLinePlanBusiness.LinePlanID, 
	#tmpLinePlanBusiness.LinePlanFinancialID, 
	#tmpLinePlanBusiness.LinePlanFinancialText, 
	#tmpLinePlanBusiness.LinePlanFinancialSort, 
	#tmpLinePlanBusiness.LinePlanAttributeItemID1, 
	#tmpLinePlanBusiness.LinePlanAttributeItemID2, 
	#tmpLinePlanBusiness.LinePlanAttributeItemID3, 
	#tmpLinePlanBusiness.LinePlanAttributeItemID4, 
	pLinePlanFinancial.LinePlanFinancialDataType, 
	pLinePlanFinancial.LinePlanFinancialDataFormat, 
	pLinePlanFinancial.LinePlanFinancialCssClass,
	#tmpLinePlanBusiness.LinePlanBusLYCh1,
	#tmpLinePlanBusiness.LinePlanBusLYCh2,
	#tmpLinePlanBusiness.LinePlanBusLYCh3,
	#tmpLinePlanBusiness.LinePlanBusLYCh4,
	#tmpLinePlanBusiness.LinePlanBusPnCh1,
	#tmpLinePlanBusiness.LinePlanBusPnCh2,
	#tmpLinePlanBusiness.LinePlanBusPnCh3,
	#tmpLinePlanBusiness.LinePlanBusPnCh4,
	#tmpLinePlanBusiness.LinePlanBusCuCh1,
	#tmpLinePlanBusiness.LinePlanBusCuCh2,
	#tmpLinePlanBusiness.LinePlanBusCuCh3,
	#tmpLinePlanBusiness.LinePlanBusCuCh4,
	#tmpLinePlanBusiness.LinePlanBusWpCh1,
	#tmpLinePlanBusiness.LinePlanBusWpCh2,
	#tmpLinePlanBusiness.LinePlanBusWpCh3,
	#tmpLinePlanBusiness.LinePlanBusWpCh4
FROM  #tmpLinePlanBusiness INNER JOIN
    pLinePlanFinancial ON #tmpLinePlanBusiness.LinePlanFinancialID = pLinePlanFinancial.LinePlanFinancialID


DROP TABLE #tmpLinePlanBusiness













GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_RemoveColorGroups_DELETE]'
GO
SET QUOTED_IDENTIFIER OFF
GO
/****** Object:  StoredProcedure [spx_RemoveColorGroups_DELETE]    Script Date: 03/09/2010 10:12:58 ******/


CREATE PROCEDURE [dbo].[spx_RemoveColorGroups_DELETE] ( @StyleID UNIQUEIDENTIFIER, @StyleSet int,  @ColorGroupID UNIQUEIDENTIFIER, @ColorGroupName nvarchar(200), @SeasonYearID NVARCHAR(50)= NULL ) AS  BEGIN  
  
 BEGIN TRY --Start the Try Block..  
  BEGIN TRANSACTION -- Start the transaction.. 
IF @SeasonYearID IS NOT NULL AND LEN(@SeasonYearID) > 0 
BEGIN            
DELETE FROM pStyleColorGroupItem WHERE StyleColorGroupID=(Select StyleColorGroupID FROM pStyleColorGroup WHERE StyleID=@StyleID
 AND StyleSet=@StyleSet AND ColorGroupID=@ColorGroupID AND ColorGroupName=@ColorGroupName and SeasonYearID=@SeasonYearID)
           DELETE FROM pStyleColorGroup WHERE StyleID=@StyleID AND StyleSet=@StyleSet AND  ColorGroupID=@ColorGroupID AND ColorGroupName=@ColorGroupName and SeasonYearID=@SeasonYearID  
END    
ELSE  
BEGIN  
          DELETE FROM pStyleColorGroupItem WHERE StyleColorGroupID=(Select StyleColorGroupID FROM pStyleColorGroup WHERE StyleID=@StyleID AND StyleSet=@StyleSet AND ColorGroupID=@ColorGroupID AND ColorGroupName=@ColorGroupName)           DELETE FROM pStyleColorGroup WHERE StyleID=@StyleID AND StyleSet=@StyleSet AND  ColorGroupID=@ColorGroupID AND ColorGroupName=@ColorGroupName  
END        
COMMIT TRAN -- Transaction Success!  
 END TRY  
  
 BEGIN CATCH  
  IF @@TRANCOUNT > 0  
  ROLLBACK TRAN --RollBack in case of Error  
        DECLARE @ErrorMessage NVARCHAR(4000);  
        DECLARE @ErrorSeverity INT;  
        DECLARE @ErrorState INT;  
  
        SELECT @ErrorMessage = ERROR_MESSAGE();  
        SELECT @ErrorSeverity = ERROR_SEVERITY();  
        SELECT @ErrorState = ERROR_STATE();  
  
        RAISERROR (  
       @ErrorMessage, -- Message text.  
                   @ErrorSeverity, -- Severity.  
                   @ErrorState -- State.  
                   );  
  
 END CATCH  
  
END  


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanShowroomItem_Vendor_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[spx_LinePlanShowroomItem_Vendor_SELECT] (
@StyleID UNIQUEIDENTIFIER,
@StyleColorID UNIQUEIDENTIFIER,
@LinePlanID UNIQUEIDENTIFIER,
@LinePlanRangeID UNIQUEIDENTIFIER
)
AS 

DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER
SELECT @StyleSeasonYearID = StyleSeasonYearID  FROM pStyleSeasonYear  WHERE StyleID = @StyleID
AND LinePlanID = @LinePlanID 

SELECT TOP 1 a.TradePartnerVendorID
FROM pLinePlanShowroomStyleColor  a
WHERE a.LinePlanRangeID = @LinePlanRangeID   
AND StyleColorID = @StyleColorID   
 

/*

SELECT a.TradePartnerVendorID, d.VendorName
FROM pStyleSourcing a
INNER JOIN pStyleQuoteItem c ON c.StyleSourcingID =  a.StyleSourcingID
INNER JOIN uTradePartnerVendor d ON d.TradepartnerVendorID = a.TradepartnerVendorID 
WHERE a.StyleID = @StyleID   -- '7d7f5f7c-cf39-4996-9d60-b3eae15d60da'
AND a.StyleSeasonYearID = @StyleSeasonYearID   -- 'FB5FF218-C4E3-420C-95B3-CDCECADAE082'
AND c.StyleColorID = @StyleColorID  -- '7EF5CFC7-D645-45A4-BAE8-C5674282405A'
AND c.StyleQuoteItemStatusID =  '3'
*/



IF ( SELECT COUNT(*) FROM pStyleSourcingItem a
	INNER JOIN pStyleSourcing b ON a.StyleSourcingID = b.StyleSourcingID 
	INNER JOIN uTradePartnerVendor c ON c.TradepartnerVendorID = b.TradepartnerVendorID 
	WHERE b.StyleID = @StyleID
	AND a.StyleColorID = @StyleColorID
	AND b.StyleSeasonYearID = @StyleSeasonYearID
) > 0 

	SELECT DISTINCT c.TradePartnerVendorID, c.VendorName 
	FROM pStyleSourcingItem a
	INNER JOIN pStyleSourcing b ON a.StyleSourcingID = b.StyleSourcingID 
	INNER JOIN uTradePartnerVendor c ON c.TradepartnerVendorID = b.TradepartnerVendorID 
	WHERE b.StyleID = @StyleID
	AND a.StyleColorID = @StyleColorID
	AND b.StyleSeasonYearID = @StyleSeasonYearID
ELSE

	SELECT NULL  AS TradePartnerVendorID, NULL AS VendorName








GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleColorway_SeasonColorAvaliable_SELECT]'
GO
SET QUOTED_IDENTIFIER OFF
GO

/****** Object:  StoredProcedure [dbo].[spx_StyleColorway_SeasonColorAvaliable_SELECT]    Script Date: 03/17/2010 01:27:59 ******/


--
-- Comments:
--
--  #01 - Ryan Cabanas - October 29, 2009
--	  Modified the select to show not only the color name, but also the
--        color code.
--


ALTER PROCEDURE [dbo].[spx_StyleColorway_SeasonColorAvaliable_SELECT](
@StyleID UNIQUEIDENTIFIER,
@SeasonYearID UNIQUEIDENTIFIER
)
AS

/*
SELECT b.ColorPaletteID
	,b.ColorCode
	,b.ColorName + ' (' + b.ColorCode + ')' AS ColorName		--Comment #01
FROM pStyleColorway a
INNER JOIN pColorPalette b ON a.ColorPaletteID = b.ColorPaletteID 
WHERE a.StyleID = @StyleID
AND StyleColorID NOT IN (
	SELECT StyleColorwayID 
	FROM pStyleColorwaySeasonYear a
	INNER JOIN pStyleSeasonYear b ON  a.StyleSeasonYearID = b.StyleSeasonYearID
	WHERE b.StyleID = @StyleID AND b.SeasonYearID = @SeasonYearID
)
*/
/**
** Colorways avaliable for a NON LinePlan style always going to be EMPTY !!! 
**/

SELECT ColorPaletteID, ColorCode, ColorName		
FROM pColorPalette WHERE 1 = 2 
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Style_SampleSize]'
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[spx_Style_SampleSize]
(@StyleID uniqueidentifier)
AS 


SELECT     StyleID, SizeRange,
CASE 
WHEN Sel0 = 1 THEN 
	Size0
WHEN Sel1 = 1 THEN 
	Size1
WHEN Sel2 = 1 THEN 
	Size2
WHEN Sel3 = 1 THEN 
	Size3
WHEN Sel4 = 1 THEN 
	Size4
WHEN Sel5 = 1 THEN 
	Size5
WHEN Sel6 = 1 THEN 
	Size6
WHEN Sel7 = 1 THEN 
	Size7
WHEN Sel8 = 1 THEN 
	Size8
WHEN Sel9 = 1 THEN 
	Size9
WHEN Sel10 = 1 THEN 
	Size10
WHEN Sel11 = 1 THEN 
	Size11
WHEN Sel12 = 1 THEN 
	Size12
WHEN Sel13 = 1 THEN 
	Size13
WHEN Sel14 = 1 THEN 
	Size14
WHEN Sel15 = 1 THEN 
	Size15
WHEN Sel16 = 1 THEN 
	Size16
WHEN Sel17 = 1 THEN 
	Size17
WHEN Sel18 = 1 THEN 
	Size18
WHEN Sel19 = 1 THEN 
	Size19	
END AS [SampleSize]
FROM   dbo.pStyleSpecSize WITH (NOLOCK)
WHERE StyleID = @StyleID






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanMaterialTemp_StyleMaterial_INSERT]'
GO
ALTER PROCEDURE [dbo].[spx_LinePlanMaterialTemp_StyleMaterial_INSERT]  (
@StyleMaterialID uniqueidentifier ,
@StyleID uniqueidentifier 
)
AS 

BEGIN

	INSERT INTO dbo.pStyleMaterials
		(StyleMaterialMasterID, MainMaterial, Development, MiscColor, StyleSet, StyleID, UOM, Qty, MaterialPrice, Ext, MaterialSize, MaterialID, 
		MaterialPlacement, MaterialPlacementCode, MaterialPlacementDetail, MaterialImageID, MaterialImageVersion, NoColorMatch, SupplierID, 
		ComponentTypeID, MaterialType, MaterialNo, MaterialName, Source, Notes, Placement, VendorPrice, VolumePrice, VolumePriceMinimum, 
		VendorProductionMin, VendorProductionLeadTime, DetailYesNo, ImageType, height, width, CDate, CUser, MDate, MUser, MChange, SChange, 
		DChange, CChange, Action, ColorPlacement, Artwork, License, Colorway, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S, T, U, V, W, X, Y, Z,
		MaterialLinked, MaterialTrack)
	SELECT   newid()  AS StyleMaterialMasterID, 0, Development, MiscColor, StyleSet, @StyleID, UOM, Qty, MaterialPrice, Ext, MaterialSize, 
		MaterialID, MaterialPlacement, MaterialPlacementCode, MaterialPlacementDetail, MaterialImageID, MaterialImageVersion, NoColorMatch, SupplierID, 
		ComponentTypeID, MaterialType, MaterialNo, MaterialName, Source, Notes, Placement, VendorPrice, VolumePrice, VolumePriceMinimum, 
		VendorProductionMin, VendorProductionLeadTime, DetailYesNo, ImageType, height, width, GETDATE() AS CDate, CUser AS CUser, GETDATE() 
		AS MDate, MUser AS MUser, MChange, SChange, DChange, CChange, Action, ColorPlacement, Artwork, License, Colorway, A, B, C, D, E, F, G, H, I, J, K, 
		L, M, N, O, P, Q, R, S, T, U, V, W, X, Y, Z, 1, 0
	FROM  pStyleMaterialTemp WITH (NOLOCK)
	WHERE StyleMaterialID = @StyleMaterialID


	DELETE FROM pStyleMaterialTemp  WHERE StyleMaterialID = @StyleMaterialID


END




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanBusinessRollup1_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_LinePlanBusinessRollup1_SELECT]
(
@LinePlanIndex varchar(1),
@LinePlanId varchar(40),
@LinePlanAttributeItemId1 varchar(40)
)
AS 

DECLARE @tmpLinePlanAttributeItemId1 varchar(36)
DECLARE @tmpLinePlanAttributeItemId2 varchar(36)
DECLARE @tmpLinePlanAttributeItemId3 varchar(36)
DECLARE @tmpLinePlanAttributeItemId4 varchar(36)
DECLARE @Row_Count AS INT
DECLARE @I AS INT


DECLARE @NoOfStyleText VARCHAR(200)
DECLARE @NoOfColorText VARCHAR(200)
DECLARE @NoOfBodyText VARCHAR(200)
DECLARE @NoOfFabricText VARCHAR(200)
DECLARE @NoOfOptionsText VARCHAR(200)
DECLARE @TargetAvgRetailPriceLowText VARCHAR(200)
DECLARE @NoOfStyleLowText VARCHAR(200)
DECLARE @TargetAvgRetailPriceMedText VARCHAR(200)
DECLARE @NoOfStyleMedText VARCHAR(200)
DECLARE @TargetAvgRetailPriceHighText VARCHAR(200)
DECLARE @NoOfStyleHighText VARCHAR(200)
DECLARE @MarkupFactorText VARCHAR(200)
DECLARE @SalesUnitText VARCHAR(200)
DECLARE @ProjectedWhsText VARCHAR(200)
DECLARE @InitialGrossMarginRtlText VARCHAR(200)
DECLARE @WeightedAverageRetailPriceText VARCHAR(200)

DECLARE @LY1_NoOfStyle INTEGER
DECLARE @LY1_NoOfFabric INTEGER
DECLARE @LY1_NoOfBody INTEGER 
DECLARE @LY1_NoOfColor INTEGER
DECLARE @LY1_NoOfOptions INTEGER
DECLARE @LY1_MarkupFactor DECIMAL(18, 3)
DECLARE @LY1_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @LY1_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @LY1_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @LY1_NoOfStyleLow DECIMAL(18, 3)
DECLARE @LY1_NoOfStyleMed DECIMAL(18, 3)
DECLARE @LY1_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @LY1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @LY1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @LY1_SalesUnit DECIMAL(18, 3)
DECLARE @LY1_ProjectedWhs DECIMAL(18, 3)
DECLARE @LY1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY1_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY1_WeightedAverageRetailPrice DECIMAL(18, 3)


DECLARE @PL1_NoOfStyle INTEGER
DECLARE @PL1_NoOfFabric INTEGER
DECLARE @PL1_NoOfBody INTEGER 
DECLARE @PL1_NoOfColor INTEGER
DECLARE @PL1_NoOfOptions INTEGER
DECLARE @PL1_MarkupFactor DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleLow DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleMed DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @PL1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @PL1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @PL1_SalesUnit DECIMAL(18, 3)
DECLARE @PL1_ProjectedWhs DECIMAL(18, 3)
DECLARE @PL1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL1_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL1_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @Cu1_NoOfStyle INTEGER
DECLARE @Cu1_NoOfFabric INTEGER
DECLARE @Cu1_NoOfBody INTEGER 
DECLARE @Cu1_NoOfColor INTEGER
DECLARE @Cu1_NoOfOptions INTEGER
DECLARE @Cu1_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @Cu1_NoOfStyleLow DECIMAL(18, 3)
DECLARE @Cu1_NoOfStyleMed DECIMAL(18, 3)
DECLARE @Cu1_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Cu1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Cu1_SalesUnit DECIMAL(18, 3)
DECLARE @Cu1_ProjectedWhs DECIMAL(18, 3)
DECLARE @Cu1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu1_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu1_WeightedAverageRetailPrice DECIMAL(18, 3)


DECLARE @Wp1_NoOfStyle INT
DECLARE @Wp1_NoOfFabric INT
DECLARE @Wp1_NoOfBody INT
DECLARE @Wp1_NoOfColor INT
DECLARE @Wp1_NoOfOptions INT
DECLARE @Wp1_MarkupFactor DECIMAL(18, 3)
DECLARE @Wp1_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @Wp1_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @Wp1_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @Wp1_NoOfStyleLow DECIMAL(18, 3)
DECLARE @Wp1_NoOfStyleMed DECIMAL(18, 3)
DECLARE @Wp1_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @Wp1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Wp1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Wp1_SalesUnit DECIMAL(18, 3)
DECLARE @Wp1_ProjectedWhs DECIMAL(18, 3)
DECLARE @Wp1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Wp1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp1_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @Wp1_WeightedAverageRetailPrice DECIMAL(18, 3)


SET @Wp1_InitialGrossMarginWhs  = 0 
SET @Wp1_WeightedAverageRetailPrice = 0 
SET @Wp1_InitialGrossMarginRtl = 0 


---- Create Temp table

CREATE TABLE #tmpLinePlanBusiness(
	[LinePlanID] [uniqueidentifier] NULL,
	[LinePlanFinancialID] [uniqueidentifier] NULL,
	[LinePlanFinancialText] [nvarchar](100) NULL,
	[LinePlanAttributeItemID1] [uniqueidentifier] NULL,
	[LinePlanAttributeItemID2] [uniqueidentifier] NULL,
	[LinePlanAttributeItemID3] [uniqueidentifier] NULL,
	[LinePlanAttributeItemID4] [uniqueidentifier] NULL,
	[LinePlanBusLYCh1] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusPnCh1] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusCuCh1] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanFinancialSort] [varchar](5) NULL,
	[LinePlanBusWpCh1] [decimal](18, 3) NULL DEFAULT ((0)),
)


--=============================================================================================================================
-- <!-- 1 -->
--- # of Style
SELECT  @NoOfStyleText = LinePlanFinancialText,
@LY1_NoOfStyle = SUM(LinePlanBusLYCh1),@PL1_NoOfStyle = SUM(LinePlanBusPnCh1),@Cu1_NoOfStyle = SUM(LinePlanBusCuCh1),
@Wp1_NoOfStyle = SUM(LinePlanBusWpCh1)
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000004' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND LinePlanId = @LinePlanId 
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1

INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusPnCh1,LinePlanBusCuCh1,
LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1 )
VALUES ( @LinePlanID, '10000000-0000-0000-0000-000000000004', @NoOfStyleText, 
@LY1_NoOfStyle, @PL1_NoOfStyle, @Cu1_NoOfStyle, @LinePlanAttributeItemID1, '0001', @Wp1_NoOfStyle)



--=============================================================================================================================
-- <!-- 2 -->
--- # of Fabric
SELECT @NoOfFabricText = LinePlanFinancialText, @LY1_NoOfFabric = SUM(LinePlanBusLYCh1), 
@PL1_NoOfFabric = SUM(LinePlanBusPnCh1), @Cu1_NoOfFabric = SUM(LinePlanBusCuCh1)
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000001' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1


--- WORK IN PROGRESS 
SELECT @Wp1_NoOfFabric =  COUNT(  DISTINCT c.MaterialID)
FROM pLinePlanItem a
Inner join pLinePlanRange b ON a.LinePlanRangeID  = b.LinePlanRangeID 
INNER JOIN pStyleMaterials c ON a.StyleID = c.StyleID 
WHERE a.LinePlanID = @LinePlanID 
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND a.StyleID <> '00000000-0000-0000-0000-000000000000'
AND c.MainMaterial =1 
AND c.MaterialID NOT IN  ( 
	-- approved 
	SELECT DISTINCT  e.MaterialID 
	FROM pLinePlanItem a
	INNER JOIN pLineplanRange b ON a.LinePlanRangeID = b.LinePlanRangeID 
	INNER JOIN pStyleSeasonYear c ON  ( a.StyleID = c.StyleID AND c.LinePlanItemID = c.LinePlanItemID  ) 
	INNER JOIN pStyleColorwaySeasonYear d ON d.StyleSeasonYearID = c.StyleSeasonYearID
	INNER JOIN pStyleMaterials e ON e.StyleID = a.StyleID 
	INNER JOIN pStyleColorway f ON f.StyleColorID  = d.StyleColorwayID
	INNER JOIN pStyleSourcing g ON g.StyleSeasonYearID = c.StyleSeasonYearID 
	INNER JOIN pStyleQuoteItem h ON ( h.StyleSourcingID = g.StyleSourcingID AND h.StyleColorID = f.StyleColorID )
	WHERE b.LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
	AND a.StyleID <> '00000000-0000-0000-0000-000000000000'
	AND c.LinePlanID = @LinePlanID
	AND d.StyleColorStatus = 200
	AND e.MainMaterial = 1
	AND g.TradePartnerVendorID IS NOT NULL 
	AND h.StyleQuoteItemStatusID = 3
)




INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusPnCh1,LinePlanBusCuCh1,	LinePlanAttributeItemID1,LinePlanFinancialSort ,LinePlanBusWpCh1 )
VALUES ( @LinePlanID, '10000000-0000-0000-0000-000000000001',  @NoOfFabricText, @LY1_NoOfFabric, 
@PL1_NoOfFabric, @Cu1_NoOfFabric, @LinePlanAttributeItemID1,'0002' , @Wp1_NoOfFabric)



--=============================================================================================================================
-- <!-- 3 -->
--- # of Body
SELECT  @NoOfBodyText = LinePlanFinancialText, @LY1_NoOfBody = SUM(LinePlanBusLYCh1), 
@PL1_NoOfBody = SUM(LinePlanBusPnCh1), @Cu1_NoOfBody = SUM(LinePlanBusCuCh1)
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000003' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1


-- Work in progress
SELECT @Wp1_NoOfBody = COUNT ( DISTINCT d.BodyID )
FROM pLinePlanItem a
INNER JOIN pLineplanRange b ON a.LinePlanRangeID = b.LinePlanRangeID 
INNER JOIN pStyleSeasonYear c ON  ( a.StyleID = c.StyleID AND c.LinePlanItemID = c.LinePlanItemID  ) 
INNER JOIN pStyleHeader d ON d.StyleID =  a.StyleID 
WHERE b.LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND a.StyleID <> '00000000-0000-0000-0000-000000000000'
AND c.LinePlanID = @LinePlanID
AND d.BodyID IS NOT NULL
AND d.BodyID  NOT IN  ( 
	-- approved 
	SELECT DISTINCT  i.BodyID
	FROM pLinePlanItem a
	INNER JOIN pLineplanRange b ON a.LinePlanRangeID = b.LinePlanRangeID 
	INNER JOIN pStyleSeasonYear c ON  ( a.StyleID = c.StyleID AND c.LinePlanItemID = c.LinePlanItemID  ) 
	INNER JOIN pStyleColorwaySeasonYear d ON d.StyleSeasonYearID = c.StyleSeasonYearID
	INNER JOIN pStyleColorway f ON f.StyleColorID  = d.StyleColorwayID
	INNER JOIN pStyleSourcing g ON g.StyleSeasonYearID = c.StyleSeasonYearID 
	INNER JOIN pStyleQuoteItem h ON ( h.StyleSourcingID = g.StyleSourcingID AND h.StyleColorID = f.StyleColorID )
	INNER JOIN pStyleHeader i ON i.StyleID = a.StyleID
	WHERE b.LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
	AND a.StyleID <> '00000000-0000-0000-0000-000000000000'
	AND c.LinePlanID = @LinePlanID
	AND d.StyleColorStatus = 200
	AND g.TradePartnerVendorID IS NOT NULL 
	AND h.StyleQuoteItemStatusID = 3
	AND i.BodyID IS NOT NULL 
)



INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusPnCh1,LinePlanBusCuCh1,	LinePlanAttributeItemID1,LinePlanFinancialSort ,LinePlanBusWpCh1)
VALUES ( @LinePlanID, '10000000-0000-0000-0000-000000000003', @NoOfBodyText, @LY1_NoOfBody,
@PL1_NoOfBody, @Cu1_NoOfBody, @LinePlanAttributeItemID1,'0003' , @Wp1_NoOfBody )


--=============================================================================================================================
-- <!-- 4 -->
---- # of Color

SELECT @NoOfColorText = LinePlanFinancialText,	@LY1_NoOfColor = SUM(LinePlanBusLYCh1), 
@PL1_NoOfColor = SUM(LinePlanBusPnCh1), @Cu1_NoOfColor = SUM(LinePlanBusCuCh1)
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000002' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1


-- COLOURS IN PROGRESS
SELECT @Wp1_NoOfColor = COUNT (DISTINCT e.ColorPaletteID)
FROM pLinePlanItem a
INNER JOIN pLineplanRange b ON a.LinePlanRangeID = b.LinePlanRangeID 
INNER JOIN pStyleSeasonYear c ON  ( a.StyleID = c.StyleID AND c.LinePlanItemID = c.LinePlanItemID  ) 
INNER JOIN pStyleColorwaySeasonYear d ON d.StyleSeasonYearID = c.StyleSeasonYearID 
INNER JOIN pStyleColorway e ON e.StyleColorID  = d.StyleColorwayID 
WHERE b.LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND a.StyleID <> '00000000-0000-0000-0000-000000000000'
AND c.LinePlanID = @LinePlanID
AND e.ColorPaletteID NOT IN  ( 
	-- approved 
	SELECT DISTINCT  f.ColorPaletteID
	FROM pLinePlanItem a
	INNER JOIN pLineplanRange b ON a.LinePlanRangeID = b.LinePlanRangeID 
	INNER JOIN pStyleSeasonYear c ON  ( a.StyleID = c.StyleID AND c.LinePlanItemID = c.LinePlanItemID  ) 
	INNER JOIN pStyleColorwaySeasonYear d ON d.StyleSeasonYearID = c.StyleSeasonYearID
	INNER JOIN pStyleColorway f ON f.StyleColorID  = d.StyleColorwayID
	INNER JOIN pStyleSourcing g ON g.StyleSeasonYearID = c.StyleSeasonYearID 
	INNER JOIN pStyleQuoteItem h ON ( h.StyleSourcingID = g.StyleSourcingID AND h.StyleColorID = f.StyleColorID )
	WHERE b.LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
	AND a.StyleID <> '00000000-0000-0000-0000-000000000000'
	AND c.LinePlanID = @LinePlanID
	AND d.StyleColorStatus = 200
	AND g.TradePartnerVendorID IS NOT NULL 
	AND h.StyleQuoteItemStatusID = 3
)





INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusPnCh1,	LinePlanBusCuCh1,LinePlanAttributeItemID1,LinePlanFinancialSort, LinePlanBusWpCh1)
VALUES (  @LinePlanID, '10000000-0000-0000-0000-000000000002',@NoOfColorText, @LY1_NoOfColor, 
@PL1_NoOfColor, @Cu1_NoOfColor, @LinePlanAttributeItemID1,'0004', @Wp1_NoOfColor)



--=============================================================================================================================
-- <!-- 5 -->
---- # of Options
SELECT @NoOfColorText = LinePlanFinancialText,	
@LY1_NoOfOptions = SUM(LinePlanBusLYCh1), 
@PL1_NoOfOptions = SUM(LinePlanBusPnCh1), 
@Cu1_NoOfOptions = SUM(LinePlanBusCuCh1),
@Wp1_NoOfOptions = SUM(LinePlanBusWpCh1)
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000005' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1

INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusPnCh1,LinePlanBusCuCh1,	LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '10000000-0000-0000-0000-000000000005', 'No of Options', 
@LY1_NoOfOptions, @PL1_NoOfOptions, @Cu1_NoOfOptions,
@LinePlanAttributeItemID1,	'0005' , @Wp1_NoOfOptions)


--=============================================================================================================================
-- <!-- 6 -->
--- Markup Factor
SELECT @MarkupFactorText = LinePlanFinancialText,@LY1_MarkupFactor = AVG(LinePlanBusLYCh1), 
@PL1_MarkupFactor = AVG(LinePlanBusPnCh1), 	@Cu1_MarkupFactor = AVG(LinePlanBusCuCh1),
@Wp1_MarkupFactor = NULL
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000005' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1

INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusPnCh1,	LinePlanBusCuCh1,LinePlanAttributeItemID1,LinePlanFinancialSort, LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000005', @MarkupFactorText, @LY1_MarkupFactor, 
@PL1_MarkupFactor, @Cu1_MarkupFactor, @LinePlanAttributeItemID1,'0006' , @Wp1_MarkupFactor)




--=============================================================================================================================
-- <!-- 8 -->
--- Target Avg Retail Price (low)
SELECT 	@TargetAvgRetailPriceLowText = LinePlanFinancialText, @LY1_TargetAvgRetailPriceLow = AVG(LinePlanBusLYCh1), 
@PL1_TargetAvgRetailPriceLow = AVG(LinePlanBusPnCh1), @Cu1_TargetAvgRetailPriceLow = AVG(LinePlanBusCuCh1) ,
@Wp1_TargetAvgRetailPriceLow = NULL
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000020' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1

INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,	LinePlanBusCuCh1,LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000020', @TargetAvgRetailPriceLowText, @LY1_TargetAvgRetailPriceLow, 
@PL1_TargetAvgRetailPriceLow, @Cu1_TargetAvgRetailPriceLow, @LinePlanAttributeItemID1,'0007' , @Wp1_TargetAvgRetailPriceLow )



--=============================================================================================================================
-- <!-- 9 -->
--- # of Style low
SELECT @NoOfStyleLowText = LinePlanFinancialText,@LY1_NoOfStyleLow = SUM(LinePlanBusLYCh1), 
@PL1_NoOfStyleLow = SUM(LinePlanBusPnCh1), 	@Cu1_NoOfStyleLow = SUM(LinePlanBusCuCh1),
@Wp1_NoOfStyleLow  = NULL
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000021' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1

INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusPnCh1,LinePlanBusCuCh1,	LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000021', @NoOfStyleLowText, @LY1_NoOfStyleLow, 
@PL1_NoOfStyleLow, @Cu1_NoOfStyleLow, @LinePlanAttributeItemID1,'0008', @Wp1_NoOfStyleLow )


--=============================================================================================================================
-- <!-- 10 -->
--- Target Avg Retail Price (Med)
SELECT @TargetAvgRetailPriceMedText = LinePlanFinancialText,@LY1_TargetAvgRetailPriceMed = AVG(LinePlanBusLYCh1), 
@PL1_TargetAvgRetailPriceMed = AVG(LinePlanBusPnCh1), @Cu1_TargetAvgRetailPriceMed = AVG(LinePlanBusCuCh1),
@Wp1_TargetAvgRetailPriceMed = NULL
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000022' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1

INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1, LinePlanBusCuCh1,	LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES (@LinePlanID, '00000000-0000-0000-0000-000000000022', @TargetAvgRetailPriceMedText, @LY1_TargetAvgRetailPriceMed, 
@PL1_TargetAvgRetailPriceMed, @Cu1_TargetAvgRetailPriceMed, @LinePlanAttributeItemID1,'0009' , @Wp1_TargetAvgRetailPriceMed)




--=============================================================================================================================
-- <!-- 11 -->
--- # of Style Med
SELECT @NoOfStyleMedText = LinePlanFinancialText, @LY1_NoOfStyleMed = SUM(LinePlanBusLYCh1), 
@PL1_NoOfStyleMed = SUM(LinePlanBusPnCh1), @Cu1_NoOfStyleMed = SUM(LinePlanBusCuCh1),
@Wp1_NoOfStyleMed = NULL 
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000023' AND 	LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1

INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,	LinePlanBusPnCh1,LinePlanBusCuCh1,LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000023', @NoOfStyleMedText, @LY1_NoOfStyleMed, 
@PL1_NoOfStyleMed, @Cu1_NoOfStyleMed, @LinePlanAttributeItemID1,'0010' , @Wp1_NoOfStyleMed)


--=============================================================================================================================
-- <!-- 12 -->
--- Target Avg Retail Price (Hi)
SELECT @TargetAvgRetailPriceHighText = LinePlanFinancialText,
@LY1_TargetAvgRetailPriceHigh = AVG(LinePlanBusLYCh1), @PL1_TargetAvgRetailPriceHigh = AVG(LinePlanBusPnCh1), 
@Cu1_TargetAvgRetailPriceHigh = AVG(LinePlanBusCuCh1),
@Wp1_TargetAvgRetailPriceHigh = NULL
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000024' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1

INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,LinePlanBusCuCh1,LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000024',@TargetAvgRetailPriceHighText, @LY1_TargetAvgRetailPriceHigh, 
@PL1_TargetAvgRetailPriceHigh, @Cu1_TargetAvgRetailPriceHigh,@LinePlanAttributeItemID1,'0011' , @Wp1_TargetAvgRetailPriceHigh)



--=============================================================================================================================
-- <!-- 13 -->
--- # of Style Hi
SELECT @NoOfStyleHighText = LinePlanFinancialText,@LY1_NoOfStyleHigh = SUM(LinePlanBusLYCh1), 
@PL1_NoOfStyleHigh = SUM(LinePlanBusPnCh1), @Cu1_NoOfStyleHigh = SUM(LinePlanBusCuCh1),
@Wp1_NoOfStyleHigh = NULL
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000025' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1

INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,LinePlanBusCuCh1,	LinePlanAttributeItemID1,LinePlanFinancialSort ,LinePlanBusWpCh1 )
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000025', @NoOfStyleHighText, @LY1_NoOfStyleHigh, 
@PL1_NoOfStyleHigh, @Cu1_NoOfStyleHigh, @LinePlanAttributeItemID1,'0012' , @Wp1_NoOfStyleHigh)



--=============================================================================================================================
-- <!-- 16 -->
---Sales Unit

SELECT @SalesUnitText = LinePlanFinancialText, @LY1_SalesUnit = SUM(LinePlanBusLYCh1), 
@PL1_SalesUnit = SUM(LinePlanBusPnCh1), @Cu1_SalesUnit = SUM(LinePlanBusCuCh1),
@Wp1_SalesUnit  = NULL
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000008' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1

INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,LinePlanBusCuCh1,LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000008', @SalesUnitText, @LY1_SalesUnit, 
@PL1_SalesUnit, @Cu1_SalesUnit, @LinePlanAttributeItemID1,'0015' , @Wp1_SalesUnit)

--=============================================================================================================================
-- <!-- 18 -->
-- 'Weighted average retail price'
/*
(
(Target Average Retail Price (Low) x Number of styles - Low) + 
(Target Average Retail Price (Med) x Number of styles - Med) + 
(Target Average Retail Price (High) x Number of styles - High)
) / Number of Styles

*/
SET @LY1_WeightedAverageRetailPrice = CASE WHEN @LY1_NoOfStyle = 0 OR @LY1_NoOfStyle IS NULL THEN 0 ELSE  (((@LY1_TargetAvgRetailPriceLow * @LY1_NoOfStyleLow ) + (@LY1_TargetAvgRetailPriceMed * @LY1_NoOfStyleMed ) + (@LY1_TargetAvgRetailPriceHigh * @LY1_NoOfStyleHigh )) / @LY1_NoOfStyle ) END
SET @PL1_WeightedAverageRetailPrice = CASE WHEN @PL1_NoOfStyle = 0 OR @PL1_NoOfStyle IS NULL THEN 0 ELSE  (((@PL1_TargetAvgRetailPriceLow * @PL1_NoOfStyleLow ) + (@PL1_TargetAvgRetailPriceMed * @PL1_NoOfStyleMed ) + (@PL1_TargetAvgRetailPriceHigh * @PL1_NoOfStyleHigh )) / @PL1_NoOfStyle ) END
SET @Cu1_WeightedAverageRetailPrice = CASE WHEN @Cu1_NoOfStyle = 0 OR @Cu1_NoOfStyle IS NULL THEN 0 ELSE  (((@Cu1_TargetAvgRetailPriceLow * @Cu1_NoOfStyleLow ) + (@Cu1_TargetAvgRetailPriceMed * @Cu1_NoOfStyleMed ) + (@Cu1_TargetAvgRetailPriceHigh * @Cu1_NoOfStyleHigh )) / @Cu1_NoOfStyle ) END
SET @Wp1_WeightedAverageRetailPrice = 0 

SELECT @WeightedAverageRetailPriceText = LinePlanFinancialText
FROM pLinePlanBusiness
WHERE  LinePlanFinancialID = '00000000-0000-0000-0000-000000000026' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1

INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanFinancialID, 	LinePlanFinancialText,
LinePlanBusLYCh1,
LinePlanBusPnCh1,	
LinePlanBusCuCh1,
LinePlanBusWpCh1,
LinePlanAttributeItemID1,LinePlanFinancialSort )
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000026', @WeightedAverageRetailPriceText, 
@LY1_WeightedAverageRetailPrice, 
@PL1_WeightedAverageRetailPrice,
@Cu1_WeightedAverageRetailPrice,
@Wp1_WeightedAverageRetailPrice,
@LinePlanAttributeItemID1,'0020' )

--=============================================================================================================================
-- <!-- 19 -->
--- Target Avg Whs Price 
--- Weighted average retail price / Markup Factor

SET @LY1_TargetAvgWhsPrice = CASE WHEN @LY1_MarkupFactor = 0 OR @LY1_MarkupFactor IS NULL THEN 0 ELSE @LY1_WeightedAverageRetailPrice / @LY1_MarkupFactor END  
SET @PL1_TargetAvgWhsPrice = CASE WHEN @PL1_MarkupFactor = 0 OR @PL1_MarkupFactor IS NULL THEN 0 ELSE @PL1_WeightedAverageRetailPrice / @PL1_MarkupFactor END
SET @Cu1_TargetAvgWhsPrice = CASE WHEN @Cu1_MarkupFactor = 0 OR @Cu1_MarkupFactor IS NULL THEN 0 ELSE @Cu1_WeightedAverageRetailPrice / @Cu1_MarkupFactor END
SET @Wp1_TargetAvgWhsPrice = 0

INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,LinePlanBusCuCh1,LinePlanAttributeItemID1,	LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000009', 'Target Avg Whs Price ', @LY1_TargetAvgWhsPrice, 
@PL1_TargetAvgWhsPrice, @Cu1_TargetAvgWhsPrice, @LinePlanAttributeItemID1,'0013' , @Wp1_TargetAvgWhsPrice)



--=============================================================================================================================
-- <!-- 20 -->
--Calculate Initial Gross Margin Wholesale %

SELECT 
@LY1_InitialGrossMarginWhs = AVG(LinePlanBusLYCh1), 
@PL1_InitialGrossMarginWhs = AVG(LinePlanBusPnCh1), 	
@Cu1_InitialGrossMarginWhs = AVG(LinePlanBusCuCh1)
FROM pLinePlanBusiness
WHERE  LinePlanFinancialID = '00000000-0000-0000-0000-000000000013' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1


INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,LinePlanBusCuCh1,LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000013', 'Initial Gross Margin Wholesale %', @LY1_InitialGrossMarginWhs, 
@PL1_InitialGrossMarginWhs,	@Cu1_InitialGrossMarginWhs, @LinePlanAttributeItemID1,'0018' , @Wp1_InitialGrossMarginWhs)



--=============================================================================================================================
-- <!-- 21 -->
---Average Target FOB

SET @LY1_AvgTargetFOB = (@LY1_TargetAvgWhsPrice - (@LY1_TargetAvgWhsPrice * @LY1_InitialGrossMarginWhs))/100 
SET @PL1_AvgTargetFOB = (@PL1_TargetAvgWhsPrice - (@PL1_TargetAvgWhsPrice * @PL1_InitialGrossMarginWhs))/100 
SET @Cu1_AvgTargetFOB = (@Cu1_TargetAvgWhsPrice - (@Cu1_TargetAvgWhsPrice * @Cu1_InitialGrossMarginWhs))/100 
SET @Wp1_AvgTargetFOB = 0

INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,LinePlanBusCuCh1,	LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000006', 'Average Target FOB', ISNULL(@LY1_AvgTargetFOB,0), 
ISNULL(@PL1_AvgTargetFOB,0), ISNULL(@Cu1_AvgTargetFOB,0), @LinePlanAttributeItemID1,'0014', @Wp1_AvgTargetFOB )

--=============================================================================================================================
-- <!-- 22 -->
---Projected Wholesale

SELECT @ProjectedWhsText = LinePlanFinancialText
FROM pLinePlanBusiness
WHERE  LinePlanFinancialID = '00000000-0000-0000-0000-000000000007' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1

SET @LY1_ProjectedWhs = @LY1_SalesUnit * @LY1_TargetAvgWhsPrice
SET @PL1_ProjectedWhs = @PL1_SalesUnit * @PL1_TargetAvgWhsPrice
SET @Cu1_ProjectedWhs = @Cu1_SalesUnit * @Cu1_TargetAvgWhsPrice
SET @Wp1_ProjectedWhs  = 0


INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanFinancialID, 	LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,	LinePlanBusCuCh1,LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000007', @ProjectedWhsText, @LY1_ProjectedWhs, 
@PL1_ProjectedWhs, @Cu1_ProjectedWhs, @LinePlanAttributeItemID1,'0016', @Wp1_ProjectedWhs)



--=============================================================================================================================
-- <!-- 23 -->
---Initial Gross Margin Retail
SELECT @InitialGrossMarginRtlText = LinePlanFinancialText
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000010' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1

SET @LY1_InitialGrossMarginRtl = CASE WHEN @LY1_WeightedAverageRetailPrice = 0 OR @LY1_WeightedAverageRetailPrice IS NULL THEN 0 ELSE (@LY1_WeightedAverageRetailPrice - @LY1_AvgTargetFOB)/@LY1_WeightedAverageRetailPrice END
SET @PL1_InitialGrossMarginRtl = CASE WHEN @PL1_WeightedAverageRetailPrice = 0 OR @PL1_WeightedAverageRetailPrice IS NULL THEN 0 ELSE (@PL1_WeightedAverageRetailPrice - @PL1_AvgTargetFOB)/@PL1_WeightedAverageRetailPrice END
SET @Cu1_InitialGrossMarginRtl = CASE WHEN @Cu1_WeightedAverageRetailPrice = 0 OR @Cu1_WeightedAverageRetailPrice IS NULL THEN 0 ELSE (@Cu1_WeightedAverageRetailPrice - @Cu1_AvgTargetFOB)/@Cu1_WeightedAverageRetailPrice END
SET @Wp1_InitialGrossMarginRtl = 0


INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,LinePlanBusCuCh1,LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000010', @InitialGrossMarginRtlText,@LY1_InitialGrossMarginRtl, 
@PL1_InitialGrossMarginRtl, @Cu1_InitialGrossMarginRtl, @LinePlanAttributeItemID1,'0017' , @Wp1_InitialGrossMarginRtl)



--=============================================================================================================================
-- <!-- 19 -->
----Weight Gross Margin WHS
---- Create Temp table


-- StyleCostingCustomField2 Target first cost 
-- StyleCostingCustomField1 Target Retail GBP
-- StyleCostingCustomField3 Flow Through Margin (Margin mark up)
-- StyleCostingCustomField5 Wholesale Margin
-- StyleCostingCustomField6 Target Wholesale Price


SELECT a.StyleID, 
ISNULL(e.StyleCostingCustomField2,0) AS target_first_cost,
ISNULL(e.StyleCostingCustomField1,0) AS target_retail_gbp, 
ISNULL(e.StyleCostingCustomField3,0) AS flow_through_margin,
ISNULL(e.StyleCostingCustomField5,0) AS wholesale_margin, 
ISNULL(e.StyleCostingCustomField6,0) AS target_wholesale_price,
ISNULL(e.UnitsPlan,0) AS units,
(ISNULL(e.StyleCostingCustomField2,0) * ISNULL(e.UnitsPlan,0)) AS extended_1st_cost ,  --Target First Cost X Units
(ISNULL(e.StyleCostingCustomField1,0) * ISNULL(e.UnitsPlan,0)) AS extended_retail_gbp, --Target Retail GBP X Units
(ISNULL(e.StyleCostingCustomField6,0) * ISNULL(e.UnitsPlan,0)) AS extended_wholesale, -- Target wholesale price X Units
ISNULL(e.UnitsActual,0) AS units_act,
(ISNULL(e.StyleCostingCustomField2,0) * ISNULL(e.UnitsActual,0)) AS extended_1st_cost_act ,  --Target First Cost X Units
(ISNULL(e.StyleCostingCustomField1,0) * ISNULL(e.UnitsActual,0)) AS extended_retail_gbp_act, --Target Retail GBP X Units
(ISNULL(e.StyleCostingCustomField6,0) * ISNULL(e.UnitsActual,0)) AS extended_wholesale_act -- Target wholesale price X Units


INTO #tmpBase
FROM pLinePlanItem a 
INNER JOIN pLinePlanRange b  ON a.LinePlanRangeID = b.LinePlanRangeID
INNER JOIN pStyleHeader c ON a.StyleID = c.StyleID 
INNER JOIN pStyleSeasonYear d ON d.StyleID = a.StyleID AND d.LinePlanItemID = a.LinePlanItemID
INNER JOIN pStyleCostingHeader e ON e.StyleID = a.StyleID  AND e.StyleSeasonYearID = d.StyleSeasonYearID

WHERE a.StyleID <>  '00000000-0000-0000-0000-000000000000'
AND b.LinePlanAttributeItemId1 = @LinePlanAttributeItemId1 -- '762f6ecf-ce02-41fb-818f-4d29acd04036'


--SELECT * FROM #tmpBase 

-- Weighted gross margin Retail % / Wholesale %

DECLARE @LY_WGM_RETAIL		DECIMAL (18,3)
DECLARE @LY_WGM_WHOLESALES	DECIMAL (18,3)

DECLARE @PN_WGM_RETAIL		DECIMAL (18,3)
DECLARE @PN_WGM_WHOLESALES	DECIMAL (18,3)

DECLARE @CU_WGM_RETAIL		DECIMAL (18,3)
DECLARE @CU_WGM_WHOLESALES	DECIMAL (18,3)

----------------------------------------------------
DECLARE @SUM_extended_1st_cost DECIMAL (18,3)
DECLARE @SUM_extended_retail_gbp DECIMAL (18,3)
DECLARE @SUM_extended_wholesale DECIMAL (18,3)

DECLARE @SUM_extended_1st_cost_act DECIMAL (18,3)
DECLARE @SUM_extended_retail_gbp_act DECIMAL (18,3)
DECLARE @SUM_extended_wholesale_act DECIMAL (18,3)

SELECT @SUM_extended_1st_cost = ISNULL(SUM (extended_1st_cost),0) FROM #tmpBase
SELECT @SUM_extended_retail_gbp = ISNULL(SUM (extended_retail_gbp),0) FROM #tmpBase
SELECT @SUM_extended_wholesale = ISNULL(SUM (extended_wholesale),0) FROM #tmpBase

SELECT @SUM_extended_1st_cost_act = ISNULL(SUM (extended_1st_cost_act),0) FROM #tmpBase
SELECT @SUM_extended_retail_gbp_act = ISNULL(SUM (extended_retail_gbp_act),0) FROM #tmpBase
SELECT @SUM_extended_wholesale_act = ISNULL(SUM (extended_wholesale_act),0) FROM #tmpBase


--LAST YEAR
SET @LY_WGM_RETAIL = 0
SET @LY_WGM_WHOLESALES = 0

-- PLANNING 
SET @PN_WGM_RETAIL = CASE WHEN @SUM_extended_retail_gbp = 0 THEN 0 ELSE (@SUM_extended_retail_gbp + @SUM_extended_1st_cost)/ @SUM_extended_retail_gbp END
SET @PN_WGM_WHOLESALES = CASE WHEN @SUM_extended_wholesale = 0 THEN 0 ELSE (@SUM_extended_wholesale + @SUM_extended_1st_cost)/ @SUM_extended_wholesale END 

-- actual 
SET @CU_WGM_RETAIL = CASE WHEN @SUM_extended_retail_gbp_act = 0 THEN 0 ELSE (@SUM_extended_retail_gbp_act + @SUM_extended_1st_cost_act)/ @SUM_extended_retail_gbp_act END 
SET @CU_WGM_WHOLESALES = CASE WHEN @SUM_extended_wholesale_act = 0 THEN 0 ELSE (@SUM_extended_wholesale_act + @SUM_extended_1st_cost_act)/ @SUM_extended_wholesale_act END 


DROP TABLE #tmpBase 


INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,LinePlanBusCuCh1,LinePlanAttributeItemID1,	LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000011',  'Weight Gross Margin WHS', 
ISNULL(@LY_WGM_WHOLESALES,0) , ISNULL(@PN_WGM_WHOLESALES,0),  ISNULL(@CU_WGM_WHOLESALES,0),
@LinePlanAttributeItemID1,'0020' , 0 )


INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,LinePlanBusCuCh1,	LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000012',   'Weight Gross Margin Retail', 
ISNULL(@LY_WGM_RETAIL,0) ,  ISNULL(@PN_WGM_RETAIL,0),  ISNULL(@CU_WGM_RETAIL,0),
@LinePlanAttributeItemID1,'0019' , 0)


--=============================================================================================================================


--SELECT * FROM #tmpLinePlanBusiness ORDER BY LinePlanFinancialSort

SELECT 
	#tmpLinePlanBusiness.LinePlanID, 
	#tmpLinePlanBusiness.LinePlanFinancialID, 
	pLinePlanFinancial.LinePlanFinancialText, 
	#tmpLinePlanBusiness.LinePlanFinancialSort, 
	#tmpLinePlanBusiness.LinePlanAttributeItemID1, 
	#tmpLinePlanBusiness.LinePlanAttributeItemID2, 
	#tmpLinePlanBusiness.LinePlanAttributeItemID3, 
	#tmpLinePlanBusiness.LinePlanAttributeItemID4, 
	pLinePlanFinancial.LinePlanFinancialDataType, 
	pLinePlanFinancial.LinePlanFinancialDataFormat, 
	pLinePlanFinancial.LinePlanFinancialCssClass,
	#tmpLinePlanBusiness.LinePlanBusLYCh1,
	#tmpLinePlanBusiness.LinePlanBusPnCh1,
	#tmpLinePlanBusiness.LinePlanBusCuCh1,
	#tmpLinePlanBusiness.LinePlanBusWpCh1
FROM  #tmpLinePlanBusiness INNER JOIN
    pLinePlanFinancial ON #tmpLinePlanBusiness.LinePlanFinancialID = pLinePlanFinancial.LinePlanFinancialID
ORDER BY #tmpLinePlanBusiness.LinePlanFinancialSort



DROP TABLE #tmpLinePlanBusiness


















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Style_MaterialColorway_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - 6/25/2008 - Feature #313

	Burberry wants to see the SAP Code in the Colorway report.  There is a custom "BB_Style_MaterialColorway_Body_LLT.rdl" that is going to
use this SAP Code.  Just needed to add that field to this query.  There were 3 changes to this procedure.  Parts A, B, and C.  Field "SAPCode"
was added to these three sections.  A - was to add the field to the temp table.  B - was to add the field to the INSERT and SELECT portion
of the statement.  C - was to select the field in the final SELECT statement.

#02 - Ryan Cabanas - 1/15/2009
	When an a chip was added from the Image Folder, the 'ColorName' field was getting updated with the Image Number.  Clay isn't sure why it
was set up this way, but he said it shouldn't be this way.  I've commented it out here.

#03 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.

#04 - Ryan Cabanas - September 23, 2009
	Replace the old color image string with the new color image string using function.
Deleted old code.

*/




ALTER         PROCEDURE [dbo].[rpx_Style_MaterialColorway_SELECT]  
(
	@StyleID AS varchar(255), 	
	@StyleSet AS int
)
AS


/*****************/
/*Comment #01 - A*/
/*****************/
--Create temp table.
CREATE TABLE #tempTable
(
	TableRow int identity(0,1),
	MaterialDescription varchar(255),
	StyleMaterialId varchar(50),
	Placement nvarchar(1000),
	MainColor varchar(255),
	SAPCode varchar(50),
	Qty varchar(18),
	MaterialSize varchar(200),
	ColorName varchar(150),
	ColorCode varchar(50),
	FilePath varchar(255),
	MaterialColorNote nvarchar(1000),
	MaterialColorImageID varchar(50),
	MaterialColorImageVersion int
)


/*****************/
/*Comment #01 - B*/
/*****************/
--Get the material colorway squares and put them in the temp table.
INSERT INTO #tempTable(
	MaterialDescription,
	StyleMaterialId,
	Placement,
	MainColor,
	SAPCode,
	Qty,
	MaterialSize,
	ColorName,
	ColorCode,
	FilePath,
	MaterialColorNote,
	MaterialColorImageID,
	MaterialColorImageVersion)
SELECT
	('(' + pStyleMaterials.MaterialNo + ') ' + pStyleMaterials.MaterialName) AS MaterialDescription, 
	CAST(pStyleMaterials.StyleMaterialId AS varchar(50)) AS StyleMaterialId,
	pStyleMaterials.Placement, 
	isnull('(' + pStyleColorway.StyleColorNo + ') ','') +  pStyleColorway.MainColor AS MainColor,
	pStyleColorway.SAPCode,
	pStyleMaterials.Qty,
	pStyleMaterials.MaterialSize,
	pMaterialColor.ColorName,
	pMaterialColor.ColorCode,
	dbo.fnx_GetStreamingColorImagePath(pMaterialColor.ColorFolderID, pMaterialColor.ColorPaletteID) AS FilePath,	--Comment #04	
	pMaterialColor.MaterialColorNote,
	pMaterialColor.MaterialColorImageID,
	pMaterialColor.MaterialColorImageVersion
FROM pStyleColorway LEFT OUTER JOIN pStyleMaterials ON
pStyleColorway.StyleID = pStyleMaterials.StyleID AND
pStyleColorway.StyleSet = pStyleMaterials.StyleSet AND
pStyleMaterials.Colorway = 1 LEFT OUTER JOIN pStyleColorwayItem ON
pStyleMaterials.StyleMaterialID = pStyleColorwayItem.StyleMaterialID AND
pStyleColorway.StyleColorID = pStyleColorwayItem.StyleColorID LEFT OUTER JOIN pMaterialColor ON
pStyleColorwayItem.MaterialColorID = pMaterialColor.MaterialColorID
WHERE pStyleColorway.StyleID = @StyleID AND pStyleColorway.StyleSet = @StyleSet
ORDER BY pStyleColorway.Sort, pStyleColorway.StyleColorName, pStyleColorway.StyleColorID,
pStyleMaterials.MainMaterial DESC, pStyleMaterials.MaterialType,
pStyleMaterials.MaterialSort, pStyleMaterials.MaterialNo

--Update the temp folder for the chips that are images from the Image folder.
UPDATE #tempTable
SET FilePath = dbo.fnx_GetStreamingImagePath(hImage.ImageID, hImage.[Version])	--Comment #03
--	,ColorName = '(' + hImage.ImageNo + ')'  --Comment #02
FROM #tempTable
	INNER JOIN hImage ON	(#tempTable.MaterialColorImageID = hImage.ImageID
							AND #tempTable.MaterialColorImageVersion = hImage.Version)


--Update the temp table to include the "Die To Match (DTM)" feature request.
UPDATE #tempTable
SET ColorCode = ''
WHERE (ColorName IS NULL)
	AND (ColorCode IS NULL)
	AND (FilePath IS NULL)


/*****************/
/*Comment #01 - C*/
/*****************/
--Get the desired columns from the original temp table.
SELECT
	TableRow % 5 AS [Column],
	MaterialDescription, 
	StyleMaterialId,
	Placement, 
	MainColor,
	SAPCode,
	Qty,
	MaterialSize,
	ColorName,
	ColorCode,
	FilePath,
	MaterialColorNote
FROM #tempTable


/*
SELECT *
FROM dbo.pStyleColorway INNER JOIN
    dbo.pStyleColorwayItem ON dbo.pStyleColorway.StyleColorID = dbo.pStyleColorwayItem.StyleColorID INNER JOIN
    dbo.pStyleMaterials ON dbo.pStyleColorwayItem.StyleMaterialID = dbo.pStyleMaterials.StyleMaterialID INNER JOIN
    dbo.pMaterialColor ON dbo.pStyleColorwayItem.MaterialColorID = dbo.pMaterialColor.MaterialColorID
*/

--Drop the Temp Table.
DROP TABLE #tempTable







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Issue_SELECT]'
GO


ALTER PROCEDURE [dbo].[spx_Issue_SELECT] (
	@TeamID  uniqueidentifier 
)

AS

	SELECT a.IssueID,  a.IssueDate,  a.Subject, a.Status , b.FirstName + ' ' + b.LastName as Requester
	FROM dbo.iIssue a WITH (NOLOCK),  dbo.Users b WITH (NOLOCK)
	WHERE a.TeamID =  b.TeamID




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_DesktopAccessComplianceFolderCheck_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_Group_DesktopAccessComplianceFolderCheck_INSERT] (
@GroupID uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

DECLARE @I as int
DECLARE @Row_Count int
DECLARE @ComplianceTypeID int
DECLARE @DeskAccessId int
DECLARE @DeskTableName varchar(100)
DECLARE @DeskTableKey varchar(50)


	BEGIN
	CREATE TABLE #TempUserAccess (
		Id int IDENTITY (1, 1) NOT NULL , 
		ComplianceTypeID int NOT NULL,
		GroupID  uniqueidentifier
	) 
	END

	BEGIN
	
	INSERT INTO #TempUserAccess(ComplianceTypeID) SELECT ComplianceTypeID FROM pComplianceType
	
	
	SET @Row_Count = (SELECT COUNT(*) FROM #TempUserAccess)
	
	SET @I = 1

	WHILE @I <= @Row_Count 
		BEGIN

			SELECT @ComplianceTypeID = ComplianceTypeID FROM #TempUserAccess WHERE ID = @I
			IF (SELECT COUNT(*) FROM sAccessGroupComplianceFolder WITH (NOLOCK) WHERE ComplianceTypeID = @ComplianceTypeID AND GroupID  = @GroupID ) = 0
			BEGIN
				INSERT INTO sAccessGroupComplianceFolder
					(ComplianceTypeID, GroupID,   CUser, CDate, MUser, MDate)
				SELECT ComplianceTypeID, @GroupID , @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate 
				FROM  #TempUserAccess WHERE Id = @I
			END
				
			SET @I = @I + 1
		END

		SELECT * FROM #tempUserAccess

	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleColorway_SeasonColorSelected_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - October 29, 2009
	Modified the select to show not only the color name, but also the
color code.
*/


ALTER PROCEDURE [dbo].[spx_StyleColorway_SeasonColorSelected_SELECT](
@StyleID UNIQUEIDENTIFIER,
@SeasonYearID UNIQUEIDENTIFIER
)
AS


SELECT d.ColorPaletteID
	,d.ColorCode
	,d.ColorName + ' (' + d.ColorCode + ')' AS ColorName		--Comment #01
FROM pStyleColorwaySeasonYear a
INNER JOIN pStyleSeasonYear b ON  a.StyleSeasonYearID = b.StyleSeasonYearID
INNER JOIN pStyleColorway c ON c.StyleColorID  =  a.StyleColorwayID 
INNER JOIN pColorPalette d ON d.ColorPaletteID = c.ColorPaletteID 
WHERE b.StyleID = @StyleID AND b.SeasonYearID = @SeasonYearID

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanMaterialTemp_StyleMaterialUnlink_INSERT]'
GO
ALTER PROCEDURE [dbo].[spx_LinePlanMaterialTemp_StyleMaterialUnlink_INSERT](
@StyleMaterialID uniqueidentifier,
@StyleID uniqueidentifier
)
AS 
/*
	INSERT INTO dbo.pStyleMaterials
		(StyleMaterialMasterID, MainMaterial, Development, MiscColor, StyleSet, StyleID, UOM, Qty, MaterialPrice, Ext, MaterialSize, MaterialID, 
		MaterialPlacement, MaterialPlacementCode, MaterialPlacementDetail, MaterialImageID, MaterialImageVersion, NoColorMatch, SupplierID, 
		ComponentTypeID, MaterialType, MaterialNo, MaterialName, Source, Notes, Placement, VendorPrice, VolumePrice, VolumePriceMinimum, 
		VendorProductionMin, VendorProductionLeadTime, DetailYesNo, ImageType, height, width, CDate, CUser, MDate, MUser, MChange, SChange, 
		DChange, CChange, Action, ColorPlacement, Artwork, License, Colorway, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S, T, U, V, W, X, Y, Z, 
		MaterialLinked, MaterialTrack)
	SELECT '{00000000-0000-0000-0000-000000000000}', 0, Development, MiscColor, StyleSet, @StyleID, UOM, Qty, MaterialPrice, Ext, MaterialSize, 
		MaterialID, MaterialPlacement, MaterialPlacementCode, MaterialPlacementDetail, MaterialImageID, MaterialImageVersion, NoColorMatch, SupplierID, 
		ComponentTypeID, MaterialType, MaterialNo, MaterialName, Source, Notes, Placement, VendorPrice, VolumePrice, VolumePriceMinimum, 
		VendorProductionMin, VendorProductionLeadTime, DetailYesNo, ImageType, height, width, GETDATE() AS CDate, CUser AS CUser, GETDATE() 
		AS MDate, MUser AS MUser, MChange, SChange, DChange, CChange, Action, ColorPlacement, Artwork, License, Colorway, A, B, C, D, E, F, G, H, I, J, K, 
		L, M, N, O, P, Q, R, S, T, U, V, W, X, Y, Z, 0, 0
	FROM  pStyleMaterialTemp WITH (NOLOCK)
	WHERE StyleMaterialID = @StyleMaterialID
*/

	DELETE FROM pStyleMaterialTemp  WHERE StyleMaterialID = @StyleMaterialID




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanBusinessRollup2_SELECT]'
GO


ALTER PROCEDURE [dbo].[spx_LinePlanBusinessRollup2_SELECT]
(
@LinePlanIndex varchar(1),
@LinePlanId varchar(40),
@LinePlanAttributeItemId1 varchar(40),
@LinePlanAttributeItemId2 varchar(40)
)
AS 


DECLARE @tmpLinePlanAttributeItemId1 varchar(36)
DECLARE @tmpLinePlanAttributeItemId2 varchar(36)
DECLARE @tmpLinePlanAttributeItemId3 varchar(36)
DECLARE @tmpLinePlanAttributeItemId4 varchar(36)
DECLARE @Row_Count AS INT
DECLARE @I AS INT


DECLARE @NoOfStyleText VARCHAR(200)
DECLARE @NoOfColorText VARCHAR(200)
DECLARE @NoOfBodyText VARCHAR(200)
DECLARE @NoOfFabricText VARCHAR(200)
DECLARE @NoOfOptionsText VARCHAR(200)
DECLARE @TargetAvgRetailPriceLowText VARCHAR(200)
DECLARE @NoOfStyleLowText VARCHAR(200)
DECLARE @TargetAvgRetailPriceMedText VARCHAR(200)
DECLARE @NoOfStyleMedText VARCHAR(200)
DECLARE @TargetAvgRetailPriceHighText VARCHAR(200)
DECLARE @NoOfStyleHighText VARCHAR(200)
DECLARE @MarkupFactorText VARCHAR(200)
DECLARE @SalesUnitText VARCHAR(200)
DECLARE @ProjectedWhsText VARCHAR(200)
DECLARE @InitialGrossMarginRtlText VARCHAR(200)
DECLARE @WeightedAverageRetailPriceText VARCHAR(200)

DECLARE @LY1_NoOfStyle INTEGER
DECLARE @LY1_NoOfFabric INTEGER
DECLARE @LY1_NoOfBody INTEGER 
DECLARE @LY1_NoOfColor INTEGER
DECLARE @LY1_NoOfOptions INTEGER
DECLARE @LY1_MarkupFactor DECIMAL(18, 3)
DECLARE @LY1_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @LY1_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @LY1_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @LY1_NoOfStyleLow DECIMAL(18, 3)
DECLARE @LY1_NoOfStyleMed DECIMAL(18, 3)
DECLARE @LY1_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @LY1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @LY1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @LY1_SalesUnit DECIMAL(18, 3)
DECLARE @LY1_ProjectedWhs DECIMAL(18, 3)
DECLARE @LY1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY1_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY1_WeightedAverageRetailPrice DECIMAL(18, 3)



DECLARE @PL1_NoOfStyle INTEGER
DECLARE @PL1_NoOfFabric INTEGER
DECLARE @PL1_NoOfBody INTEGER 
DECLARE @PL1_NoOfColor INTEGER
DECLARE @PL1_NoOfOptions INTEGER
DECLARE @PL1_MarkupFactor DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleLow DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleMed DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @PL1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @PL1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @PL1_SalesUnit DECIMAL(18, 3)
DECLARE @PL1_ProjectedWhs DECIMAL(18, 3)
DECLARE @PL1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL1_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL1_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @Cu1_NoOfStyle INTEGER
DECLARE @Cu1_NoOfFabric INTEGER
DECLARE @Cu1_NoOfBody INTEGER 
DECLARE @Cu1_NoOfColor INTEGER
DECLARE @Cu1_NoOfOptions INTEGER
DECLARE @Cu1_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @Cu1_NoOfStyleLow DECIMAL(18, 3)
DECLARE @Cu1_NoOfStyleMed DECIMAL(18, 3)
DECLARE @Cu1_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Cu1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Cu1_SalesUnit DECIMAL(18, 3)
DECLARE @Cu1_ProjectedWhs DECIMAL(18, 3)
DECLARE @Cu1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu1_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu1_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @Wp1_NoOfStyle INT
DECLARE @Wp1_NoOfFabric INT
DECLARE @Wp1_NoOfBody INT
DECLARE @Wp1_NoOfColor INT
DECLARE @Wp1_NoOfOptions INT
DECLARE @Wp1_MarkupFactor DECIMAL(18, 3)
DECLARE @Wp1_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @Wp1_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @Wp1_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @Wp1_NoOfStyleLow DECIMAL(18, 3)
DECLARE @Wp1_NoOfStyleMed DECIMAL(18, 3)
DECLARE @Wp1_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @Wp1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Wp1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Wp1_SalesUnit DECIMAL(18, 3)
DECLARE @Wp1_ProjectedWhs DECIMAL(18, 3)
DECLARE @Wp1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Wp1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp1_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @Wp1_WeightedAverageRetailPrice DECIMAL(18, 3)



SET @Wp1_InitialGrossMarginWhs  = 0 
SET @Wp1_WeightedAverageRetailPrice = 0 
SET @Wp1_InitialGrossMarginRtl = 0 


---- Create Temp table

CREATE TABLE #tmpLinePlanBusiness(
	[LinePlanID] [uniqueidentifier] NULL,
	[LinePlanFinancialID] [uniqueidentifier] NULL,
	[LinePlanFinancialText] [nvarchar](100) NULL,
	[LinePlanAttributeItemID1] [uniqueidentifier] NULL,
	[LinePlanAttributeItemID2] [uniqueidentifier] NULL,
	[LinePlanAttributeItemID3] [uniqueidentifier] NULL,
	[LinePlanAttributeItemID4] [uniqueidentifier] NULL,
	[LinePlanBusLYCh1] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusPnCh1] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusCuCh1] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanFinancialSort] [varchar](5) NULL,
	[LinePlanBusWpCh1] [decimal](18, 3) NULL DEFAULT ((0))
)

--=============================================================================================================================
-- <!-- 1 -->
--- # of Style
SELECT  @NoOfStyleText = LinePlanFinancialText,
@LY1_NoOfStyle = SUM(LinePlanBusLYCh1),@PL1_NoOfStyle = SUM(LinePlanBusPnCh1),@Cu1_NoOfStyle = SUM(LinePlanBusCuCh1),
@Wp1_NoOfStyle = SUM(LinePlanBusWpCh1)
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000004' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanId = @LinePlanId 
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2

INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusPnCh1,LinePlanBusCuCh1,
LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '10000000-0000-0000-0000-000000000004', @NoOfStyleText, 
@LY1_NoOfStyle, @PL1_NoOfStyle, @Cu1_NoOfStyle, @LinePlanAttributeItemID1, '0001' , @Wp1_NoOfStyle)


--=============================================================================================================================
-- <!-- 2 -->
--- # of Fabric
SELECT @NoOfFabricText = LinePlanFinancialText, @LY1_NoOfFabric = SUM(LinePlanBusLYCh1), 
@PL1_NoOfFabric = SUM(LinePlanBusPnCh1), @Cu1_NoOfFabric = SUM(LinePlanBusCuCh1),
@Wp1_NoOfFabric = SUM(LinePlanBusWpCh1)
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000001' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2

--- WORK IN PROGRESS 
SELECT @Wp1_NoOfFabric =  COUNT(  DISTINCT c.MaterialID)
FROM pLinePlanItem a
Inner join pLinePlanRange b ON a.LinePlanRangeID  = b.LinePlanRangeID 
INNER JOIN pStyleMaterials c ON a.StyleID = c.StyleID 
WHERE a.LinePlanID = @LinePlanID 
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND a.StyleID <> '00000000-0000-0000-0000-000000000000'
AND c.MainMaterial =1 
AND c.MaterialID NOT IN  ( 

	-- approved 
	SELECT DISTINCT  e.MaterialID 
	FROM pLinePlanItem a
	INNER JOIN pLineplanRange b ON a.LinePlanRangeID = b.LinePlanRangeID 
	INNER JOIN pStyleSeasonYear c ON  ( a.StyleID = c.StyleID AND c.LinePlanItemID = c.LinePlanItemID  ) 
	INNER JOIN pStyleColorwaySeasonYear d ON d.StyleSeasonYearID = c.StyleSeasonYearID
	INNER JOIN pStyleMaterials e ON e.StyleID = a.StyleID 
	INNER JOIN pStyleColorway f ON f.StyleColorID  = d.StyleColorwayID
	INNER JOIN pStyleSourcing g ON g.StyleSeasonYearID = c.StyleSeasonYearID 
	INNER JOIN pStyleQuoteItem h ON ( h.StyleSourcingID = g.StyleSourcingID AND h.StyleColorID = f.StyleColorID )
	WHERE b.LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
	AND b.LinePlanAttributeItemId2 = @LinePlanAttributeItemID2
	AND a.StyleID <> '00000000-0000-0000-0000-000000000000'
	AND c.LinePlanID = @LinePlanID
	AND d.StyleColorStatus = 200
	AND e.MainMaterial = 1
	AND g.TradePartnerVendorID IS NOT NULL 
	AND h.StyleQuoteItemStatusID = 3
)






INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusPnCh1,LinePlanBusCuCh1,	LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '10000000-0000-0000-0000-000000000001',  @NoOfFabricText, @LY1_NoOfFabric, 
@PL1_NoOfFabric, @Cu1_NoOfFabric, @LinePlanAttributeItemID1,'0002' ,@Wp1_NoOfFabric )

--=============================================================================================================================
-- <!-- 3 -->
--- # of Body
SELECT  @NoOfBodyText = LinePlanFinancialText, @LY1_NoOfBody = SUM(LinePlanBusLYCh1), 
@PL1_NoOfBody = SUM(LinePlanBusPnCh1), @Cu1_NoOfBody = SUM(LinePlanBusCuCh1),
@Wp1_NoOfBody = SUM(LinePlanBusWpCh1)
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000003' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2


-- Work in progress
SELECT @Wp1_NoOfBody = COUNT ( DISTINCT d.BodyID )
FROM pLinePlanItem a
INNER JOIN pLineplanRange b ON a.LinePlanRangeID = b.LinePlanRangeID 
INNER JOIN pStyleSeasonYear c ON  ( a.StyleID = c.StyleID AND c.LinePlanItemID = c.LinePlanItemID  ) 
INNER JOIN pStyleHeader d ON d.StyleID =  a.StyleID 
WHERE b.LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND b.LinePlanAttributeItemID2= @LinePlanAttributeItemID2
AND a.StyleID <> '00000000-0000-0000-0000-000000000000'
AND c.LinePlanID = @LinePlanID
AND d.BodyID IS NOT NULL
AND d.BodyID  NOT IN  ( 
	-- approved 
	SELECT DISTINCT  i.BodyID
	FROM pLinePlanItem a
	INNER JOIN pLineplanRange b ON a.LinePlanRangeID = b.LinePlanRangeID 
	INNER JOIN pStyleSeasonYear c ON  ( a.StyleID = c.StyleID AND c.LinePlanItemID = c.LinePlanItemID  ) 
	INNER JOIN pStyleColorwaySeasonYear d ON d.StyleSeasonYearID = c.StyleSeasonYearID
	INNER JOIN pStyleColorway f ON f.StyleColorID  = d.StyleColorwayID
	INNER JOIN pStyleSourcing g ON g.StyleSeasonYearID = c.StyleSeasonYearID 
	INNER JOIN pStyleQuoteItem h ON ( h.StyleSourcingID = g.StyleSourcingID AND h.StyleColorID = f.StyleColorID )
	INNER JOIN pStyleHeader i ON i.StyleID = a.StyleID
	WHERE b.LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
	AND b.LinePlanAttributeItemId2 = @LinePlanAttributeItemID2
	AND a.StyleID <> '00000000-0000-0000-0000-000000000000'
	AND c.LinePlanID = @LinePlanID
	AND d.StyleColorStatus = 200
	AND g.TradePartnerVendorID IS NOT NULL 
	AND h.StyleQuoteItemStatusID = 3
	AND i.BodyID IS NOT NULL 
)


INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusPnCh1,LinePlanBusCuCh1,	LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '10000000-0000-0000-0000-000000000003', @NoOfBodyText, @LY1_NoOfBody,
@PL1_NoOfBody, @Cu1_NoOfBody, @LinePlanAttributeItemID1,'0003' , @Wp1_NoOfBody)


--=============================================================================================================================
-- <!-- 4 -->
---- # of Color

SELECT @NoOfColorText = LinePlanFinancialText,	@LY1_NoOfColor = SUM(LinePlanBusLYCh1), 
@PL1_NoOfColor = SUM(LinePlanBusPnCh1), @Cu1_NoOfColor = SUM(LinePlanBusCuCh1),
@Wp1_NoOfColor = SUM(LinePlanBusWpCh1)
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000002' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2

-- COLOURS IN PROGRESS
SELECT @Wp1_NoOfColor = COUNT (DISTINCT e.ColorPaletteID)
FROM pLinePlanItem a
INNER JOIN pLineplanRange b ON a.LinePlanRangeID = b.LinePlanRangeID 
INNER JOIN pStyleSeasonYear c ON  ( a.StyleID = c.StyleID AND c.LinePlanItemID = c.LinePlanItemID  ) 
INNER JOIN pStyleColorwaySeasonYear d ON d.StyleSeasonYearID = c.StyleSeasonYearID 
INNER JOIN pStyleColorway e ON e.StyleColorID  = d.StyleColorwayID 
WHERE b.LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND b.LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND a.StyleID <> '00000000-0000-0000-0000-000000000000'
AND c.LinePlanID = @LinePlanID
AND e.ColorPaletteID NOT IN  ( 
	-- approved 
	SELECT DISTINCT  f.ColorPaletteID
	FROM pLinePlanItem a
	INNER JOIN pLineplanRange b ON a.LinePlanRangeID = b.LinePlanRangeID 
	INNER JOIN pStyleSeasonYear c ON  ( a.StyleID = c.StyleID AND c.LinePlanItemID = c.LinePlanItemID  ) 
	INNER JOIN pStyleColorwaySeasonYear d ON d.StyleSeasonYearID = c.StyleSeasonYearID
	INNER JOIN pStyleColorway f ON f.StyleColorID  = d.StyleColorwayID
	INNER JOIN pStyleSourcing g ON g.StyleSeasonYearID = c.StyleSeasonYearID 
	INNER JOIN pStyleQuoteItem h ON ( h.StyleSourcingID = g.StyleSourcingID AND h.StyleColorID = f.StyleColorID )
	WHERE b.LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
	AND b.LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
	AND a.StyleID <> '00000000-0000-0000-0000-000000000000'
	AND c.LinePlanID = @LinePlanID
	AND d.StyleColorStatus = 200
	AND g.TradePartnerVendorID IS NOT NULL 
	AND h.StyleQuoteItemStatusID = 3
)


INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusPnCh1,	LinePlanBusCuCh1,LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES (  @LinePlanID, '10000000-0000-0000-0000-000000000002',@NoOfColorText, @LY1_NoOfColor, 
@PL1_NoOfColor, @Cu1_NoOfColor, @LinePlanAttributeItemID1,'0004' , @Wp1_NoOfColor)



--=============================================================================================================================
-- <!-- 5 -->
---- # of Options

SELECT @NoOfColorText = LinePlanFinancialText,	
@LY1_NoOfOptions = SUM(LinePlanBusLYCh1), 
@PL1_NoOfOptions = SUM(LinePlanBusPnCh1), 
@Cu1_NoOfOptions = SUM(LinePlanBusCuCh1),
@Wp1_NoOfOptions = SUM(LinePlanBusWpCh1)
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000005' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2


INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusPnCh1,LinePlanBusCuCh1,	LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '10000000-0000-0000-0000-000000000005', 'No of Options', 
@LY1_NoOfOptions, @PL1_NoOfOptions,@Cu1_NoOfOptions,
@LinePlanAttributeItemID1,	'0005' , @Wp1_NoOfOptions)

--=============================================================================================================================
-- <!-- 6 -->
--- Markup Factor
SELECT @MarkupFactorText = LinePlanFinancialText,
@LY1_MarkupFactor = AVG(LinePlanBusLYCh1), 
@PL1_MarkupFactor = AVG(LinePlanBusPnCh1), 	
@Cu1_MarkupFactor = AVG(LinePlanBusCuCh1),
@Wp1_MarkupFactor = NULL
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000005' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2

INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusPnCh1,	LinePlanBusCuCh1,LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000005', @MarkupFactorText, @LY1_MarkupFactor, 
@PL1_MarkupFactor, @Cu1_MarkupFactor, @LinePlanAttributeItemID1,'0006' , @Wp1_MarkupFactor)


--=============================================================================================================================
-- <!-- 8 -->
--- Target Avg Retail Price (low)
SELECT 	@TargetAvgRetailPriceLowText = LinePlanFinancialText, 
@LY1_TargetAvgRetailPriceLow = AVG(LinePlanBusLYCh1), 
@PL1_TargetAvgRetailPriceLow = AVG(LinePlanBusPnCh1), 
@Cu1_TargetAvgRetailPriceLow = AVG(LinePlanBusCuCh1),
@Wp1_TargetAvgRetailPriceLow = NULL
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000020' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2

INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,	LinePlanBusCuCh1,LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000020', @TargetAvgRetailPriceLowText, @LY1_TargetAvgRetailPriceLow, 
@PL1_TargetAvgRetailPriceLow, @Cu1_TargetAvgRetailPriceLow, @LinePlanAttributeItemID1,'0007',  @Wp1_TargetAvgRetailPriceLow)


--=============================================================================================================================
-- <!-- 9 -->
--- # of Style low
SELECT @NoOfStyleLowText = LinePlanFinancialText,@LY1_NoOfStyleLow = SUM(LinePlanBusLYCh1), 
@PL1_NoOfStyleLow = SUM(LinePlanBusPnCh1), 	@Cu1_NoOfStyleLow = SUM(LinePlanBusCuCh1),
@Wp1_NoOfStyleLow = NULL
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000021' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2

INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusPnCh1,LinePlanBusCuCh1,	LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000021', @NoOfStyleLowText, @LY1_NoOfStyleLow, 
@PL1_NoOfStyleLow, @Cu1_NoOfStyleLow, @LinePlanAttributeItemID1,'0008' , @Wp1_NoOfStyleLow)

--=============================================================================================================================
-- <!-- 10 -->
--- Target Avg Retail Price (Med)
SELECT @TargetAvgRetailPriceMedText = LinePlanFinancialText,@LY1_TargetAvgRetailPriceMed = AVG(LinePlanBusLYCh1), 
@PL1_TargetAvgRetailPriceMed = AVG(LinePlanBusPnCh1), @Cu1_TargetAvgRetailPriceMed = AVG(LinePlanBusCuCh1),
@Wp1_TargetAvgRetailPriceMed = NULL
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000022' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2

INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1, LinePlanBusCuCh1,	LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES (@LinePlanID, '00000000-0000-0000-0000-000000000022', @TargetAvgRetailPriceMedText, @LY1_TargetAvgRetailPriceMed, 
@PL1_TargetAvgRetailPriceMed, @Cu1_TargetAvgRetailPriceMed, @LinePlanAttributeItemID1,'0009' , @Wp1_TargetAvgRetailPriceMed)


--=============================================================================================================================
-- <!-- 11 -->
--- # of Style Med
SELECT @NoOfStyleMedText = LinePlanFinancialText, @LY1_NoOfStyleMed = SUM(LinePlanBusLYCh1), 
@PL1_NoOfStyleMed = SUM(LinePlanBusPnCh1), @Cu1_NoOfStyleMed = SUM(LinePlanBusCuCh1),
@Wp1_NoOfStyleMed  = NULL
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000023' AND 	LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2

INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,	LinePlanBusPnCh1,LinePlanBusCuCh1,LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWPCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000023', @NoOfStyleMedText, @LY1_NoOfStyleMed, 
@PL1_NoOfStyleMed, @Cu1_NoOfStyleMed, @LinePlanAttributeItemID1,'0010' , @Wp1_NoOfStyleMed)


--=============================================================================================================================
-- <!-- 12 -->
--- Target Avg Retail Price (Hi)
SELECT @TargetAvgRetailPriceHighText = LinePlanFinancialText,
@LY1_TargetAvgRetailPriceHigh = AVG(LinePlanBusLYCh1), @PL1_TargetAvgRetailPriceHigh = AVG(LinePlanBusPnCh1), 
@Cu1_TargetAvgRetailPriceHigh = AVG(LinePlanBusCuCh1), @Wp1_TargetAvgRetailPriceHigh  = NULL
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000024' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2

INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,LinePlanBusCuCh1,LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000024',@TargetAvgRetailPriceHighText, @LY1_TargetAvgRetailPriceHigh, 
@PL1_TargetAvgRetailPriceHigh, @Cu1_TargetAvgRetailPriceHigh,@LinePlanAttributeItemID1,'0011', @Wp1_TargetAvgRetailPriceHigh)

--=============================================================================================================================
-- <!-- 13 -->
--- # of Style Hi
SELECT @NoOfStyleHighText = LinePlanFinancialText,@LY1_NoOfStyleHigh = SUM(LinePlanBusLYCh1), 
@PL1_NoOfStyleHigh = SUM(LinePlanBusPnCh1), @Cu1_NoOfStyleHigh = SUM(LinePlanBusCuCh1),
@Wp1_NoOfStyleHigh = NULL
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000025' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2

INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,LinePlanBusCuCh1,	LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1 )
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000025', @NoOfStyleHighText, @LY1_NoOfStyleHigh, 
@PL1_NoOfStyleHigh, @Cu1_NoOfStyleHigh, @LinePlanAttributeItemID1,'0012' , @Wp1_NoOfStyleHigh)


--=============================================================================================================================
-- <!-- 16 -->
---Sales Unit

SELECT @SalesUnitText = LinePlanFinancialText, @LY1_SalesUnit = SUM(LinePlanBusLYCh1), 
@PL1_SalesUnit = SUM(LinePlanBusPnCh1), @Cu1_SalesUnit = SUM(LinePlanBusCuCh1),
@Wp1_SalesUnit = 0
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000008' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2

INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,LinePlanBusCuCh1,LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000008', @SalesUnitText, @LY1_SalesUnit, 
@PL1_SalesUnit, @Cu1_SalesUnit, @LinePlanAttributeItemID1,'0015' , @Wp1_SalesUnit)



--=============================================================================================================================
-- <!-- 18 -->
-- 'Weighted average retail price'
/*
(
(Target Average Retail Price (Low) x Number of styles - Low) + 
(Target Average Retail Price (Med) x Number of styles - Med) + 
(Target Average Retail Price (High) x Number of styles - High)
) / Number of Styles

*/
SET @LY1_WeightedAverageRetailPrice = CASE WHEN @LY1_NoOfStyle = 0 OR @LY1_NoOfStyle IS NULL THEN 0 ELSE  (((@LY1_TargetAvgRetailPriceLow * @LY1_NoOfStyleLow ) + (@LY1_TargetAvgRetailPriceMed * @LY1_NoOfStyleMed ) + (@LY1_TargetAvgRetailPriceHigh * @LY1_NoOfStyleHigh )) / @LY1_NoOfStyle ) END
SET @PL1_WeightedAverageRetailPrice = CASE WHEN @PL1_NoOfStyle = 0 OR @PL1_NoOfStyle IS NULL THEN 0 ELSE  (((@PL1_TargetAvgRetailPriceLow * @PL1_NoOfStyleLow ) + (@PL1_TargetAvgRetailPriceMed * @PL1_NoOfStyleMed ) + (@PL1_TargetAvgRetailPriceHigh * @PL1_NoOfStyleHigh )) / @PL1_NoOfStyle ) END
SET @Cu1_WeightedAverageRetailPrice = CASE WHEN @Cu1_NoOfStyle = 0 OR @Cu1_NoOfStyle IS NULL THEN 0 ELSE  (((@Cu1_TargetAvgRetailPriceLow * @Cu1_NoOfStyleLow ) + (@Cu1_TargetAvgRetailPriceMed * @Cu1_NoOfStyleMed ) + (@Cu1_TargetAvgRetailPriceHigh * @Cu1_NoOfStyleHigh )) / @Cu1_NoOfStyle ) END
SET @Wp1_WeightedAverageRetailPrice = 0 


SELECT @WeightedAverageRetailPriceText = LinePlanFinancialText
FROM pLinePlanBusiness
WHERE  LinePlanFinancialID = '00000000-0000-0000-0000-000000000026' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2


INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanFinancialID, 	LinePlanFinancialText,
LinePlanBusLYCh1,
LinePlanBusPnCh1,	
LinePlanBusCuCh1,
LinePlanBusWpCh1,
LinePlanAttributeItemID1,LinePlanFinancialSort )
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000026', @WeightedAverageRetailPriceText, 
@LY1_WeightedAverageRetailPrice, 
@PL1_WeightedAverageRetailPrice,
@Cu1_WeightedAverageRetailPrice,
@Wp1_WeightedAverageRetailPrice,
@LinePlanAttributeItemID1,'0020' )


--=============================================================================================================================
-- <!-- 19 -->
--- Target Avg Whs Price 
--- Weighted average retail price / Markup Factor

SET @LY1_TargetAvgWhsPrice = CASE WHEN @LY1_MarkupFactor = 0 OR @LY1_MarkupFactor IS NULL THEN 0 ELSE @LY1_WeightedAverageRetailPrice / @LY1_MarkupFactor END  
SET @PL1_TargetAvgWhsPrice = CASE WHEN @PL1_MarkupFactor = 0 OR @PL1_MarkupFactor IS NULL THEN 0 ELSE @PL1_WeightedAverageRetailPrice / @PL1_MarkupFactor END
SET @Cu1_TargetAvgWhsPrice = CASE WHEN @Cu1_MarkupFactor = 0 OR @Cu1_MarkupFactor IS NULL THEN 0 ELSE @Cu1_WeightedAverageRetailPrice / @Cu1_MarkupFactor END
SET @Wp1_TargetAvgWhsPrice = 0

INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,LinePlanBusCuCh1,LinePlanAttributeItemID1,	LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000009', 'Target Avg Whs Price ', @LY1_TargetAvgWhsPrice, 
@PL1_TargetAvgWhsPrice, @Cu1_TargetAvgWhsPrice, @LinePlanAttributeItemID1,'0013' , @Wp1_TargetAvgWhsPrice)



--=============================================================================================================================
-- <!-- 20 -->
--Calculate Initial Gross Margin Wholesale %

SELECT 
@LY1_InitialGrossMarginWhs = AVG(LinePlanBusLYCh1), 
@PL1_InitialGrossMarginWhs = AVG(LinePlanBusPnCh1), 	
@Cu1_InitialGrossMarginWhs = AVG(LinePlanBusCuCh1)
FROM pLinePlanBusiness
WHERE  LinePlanFinancialID = '00000000-0000-0000-0000-000000000013' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2


INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,LinePlanBusCuCh1,LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000013', 'Initial Gross Margin Wholesale %', @LY1_InitialGrossMarginWhs, 
@PL1_InitialGrossMarginWhs,	@Cu1_InitialGrossMarginWhs, @LinePlanAttributeItemID1,'0018' , @Wp1_InitialGrossMarginWhs)



--=============================================================================================================================
-- <!-- 21 -->
---Average Target FOB

SET @LY1_AvgTargetFOB = (@LY1_TargetAvgWhsPrice - (@LY1_TargetAvgWhsPrice * @LY1_InitialGrossMarginWhs))/100 
SET @PL1_AvgTargetFOB = (@PL1_TargetAvgWhsPrice - (@PL1_TargetAvgWhsPrice * @PL1_InitialGrossMarginWhs))/100 
SET @Cu1_AvgTargetFOB = (@Cu1_TargetAvgWhsPrice - (@Cu1_TargetAvgWhsPrice * @Cu1_InitialGrossMarginWhs))/100 
SET @Wp1_AvgTargetFOB = 0

INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,LinePlanBusCuCh1,	LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000006', 'Average Target FOB', ISNULL(@LY1_AvgTargetFOB,0), 
ISNULL(@PL1_AvgTargetFOB,0), ISNULL(@Cu1_AvgTargetFOB,0), @LinePlanAttributeItemID1,'0014', @Wp1_AvgTargetFOB )



--=============================================================================================================================
-- <!-- 22 -->
---Projected Wholesale

SELECT @ProjectedWhsText = LinePlanFinancialText
FROM pLinePlanBusiness
WHERE  LinePlanFinancialID = '00000000-0000-0000-0000-000000000007' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2

SET @LY1_ProjectedWhs = @LY1_SalesUnit * @LY1_TargetAvgWhsPrice
SET @PL1_ProjectedWhs = @PL1_SalesUnit * @PL1_TargetAvgWhsPrice
SET @Cu1_ProjectedWhs = @Cu1_SalesUnit * @Cu1_TargetAvgWhsPrice
SET @Wp1_ProjectedWhs  = 0


INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanFinancialID, 	LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,	LinePlanBusCuCh1,LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000007', @ProjectedWhsText, @LY1_ProjectedWhs, 
@PL1_ProjectedWhs, @Cu1_ProjectedWhs, @LinePlanAttributeItemID1,'0016', @Wp1_ProjectedWhs)


--=============================================================================================================================
-- <!-- 23 -->
---Initial Gross Margin Retail
SELECT @InitialGrossMarginRtlText = LinePlanFinancialText
FROM pLinePlanBusiness
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000010' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2

SET @LY1_InitialGrossMarginRtl = CASE WHEN @LY1_WeightedAverageRetailPrice = 0 OR @LY1_WeightedAverageRetailPrice IS NULL THEN 0 ELSE (@LY1_WeightedAverageRetailPrice - @LY1_AvgTargetFOB)/@LY1_WeightedAverageRetailPrice END
SET @PL1_InitialGrossMarginRtl = CASE WHEN @PL1_WeightedAverageRetailPrice = 0 OR @PL1_WeightedAverageRetailPrice IS NULL THEN 0 ELSE (@PL1_WeightedAverageRetailPrice - @PL1_AvgTargetFOB)/@PL1_WeightedAverageRetailPrice END
SET @Cu1_InitialGrossMarginRtl = CASE WHEN @Cu1_WeightedAverageRetailPrice = 0 OR @Cu1_WeightedAverageRetailPrice IS NULL THEN 0 ELSE (@Cu1_WeightedAverageRetailPrice - @Cu1_AvgTargetFOB)/@Cu1_WeightedAverageRetailPrice END
SET @Wp1_InitialGrossMarginRtl = 0


INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,LinePlanBusCuCh1,LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000010', @InitialGrossMarginRtlText,@LY1_InitialGrossMarginRtl, 
@PL1_InitialGrossMarginRtl, @Cu1_InitialGrossMarginRtl, @LinePlanAttributeItemID1,'0017' , @Wp1_InitialGrossMarginRtl)




--=============================================================================================================================
-- <!-- 19 -->
----Weight Gross Margin WHS


-- StyleCostingCustomField2 Target first cost 
-- StyleCostingCustomField1 Target Retail GBP
-- StyleCostingCustomField3 Flow Through Margin (Margin mark up)
-- StyleCostingCustomField5 Wholesale Margin
-- StyleCostingCustomField6 Target Wholesale Price


SELECT a.StyleID, 
ISNULL(e.StyleCostingCustomField2,0) AS target_first_cost,
ISNULL(e.StyleCostingCustomField1,0) AS target_retail_gbp, 
ISNULL(e.StyleCostingCustomField3,0) AS flow_through_margin,
ISNULL(e.StyleCostingCustomField5,0) AS wholesale_margin, 
ISNULL(e.StyleCostingCustomField6,0) AS target_wholesale_price,
ISNULL(e.UnitsPlan,0) AS units,
(ISNULL(e.StyleCostingCustomField2,0) * ISNULL(e.UnitsPlan,0)) AS extended_1st_cost ,  --Target First Cost X Units
(ISNULL(e.StyleCostingCustomField1,0) * ISNULL(e.UnitsPlan,0)) AS extended_retail_gbp, --Target Retail GBP X Units
(ISNULL(e.StyleCostingCustomField6,0) * ISNULL(e.UnitsPlan,0)) AS extended_wholesale, -- Target wholesale price X Units
ISNULL(e.UnitsActual,0) AS units_act,
(ISNULL(e.StyleCostingCustomField2,0) * ISNULL(e.UnitsActual,0)) AS extended_1st_cost_act ,  --Target First Cost X Units
(ISNULL(e.StyleCostingCustomField1,0) * ISNULL(e.UnitsActual,0)) AS extended_retail_gbp_act, --Target Retail GBP X Units
(ISNULL(e.StyleCostingCustomField6,0) * ISNULL(e.UnitsActual,0)) AS extended_wholesale_act -- Target wholesale price X Units


INTO #tmpBase
FROM pLinePlanItem a 
INNER JOIN pLinePlanRange b  ON a.LinePlanRangeID = b.LinePlanRangeID
INNER JOIN pStyleHeader c ON a.StyleID = c.StyleID 
INNER JOIN pStyleSeasonYear d ON d.StyleID = a.StyleID AND d.LinePlanItemID = a.LinePlanItemID
INNER JOIN pStyleCostingHeader e ON e.StyleID = a.StyleID  AND e.StyleSeasonYearID = d.StyleSeasonYearID

WHERE a.StyleID <>  '00000000-0000-0000-0000-000000000000'
AND b.LinePlanAttributeItemId1 = @LinePlanAttributeItemId1 -- '762f6ecf-ce02-41fb-818f-4d29acd04036'
AND b.LinePlanAttributeItemId2 = @LinePlanAttributeItemId2  -- '40e7bf13-30a6-4bda-9c5a-b47166e03e78'

--SELECT * FROM #tmpBase 

-- Weighted gross margin Retail % / Wholesale %

DECLARE @LY_WGM_RETAIL		DECIMAL (18,3)
DECLARE @LY_WGM_WHOLESALES	DECIMAL (18,3)

DECLARE @PN_WGM_RETAIL		DECIMAL (18,3)
DECLARE @PN_WGM_WHOLESALES	DECIMAL (18,3)

DECLARE @CU_WGM_RETAIL		DECIMAL (18,3)
DECLARE @CU_WGM_WHOLESALES	DECIMAL (18,3)

----------------------------------------------------
DECLARE @SUM_extended_1st_cost DECIMAL (18,3)
DECLARE @SUM_extended_retail_gbp DECIMAL (18,3)
DECLARE @SUM_extended_wholesale DECIMAL (18,3)

DECLARE @SUM_extended_1st_cost_act DECIMAL (18,3)
DECLARE @SUM_extended_retail_gbp_act DECIMAL (18,3)
DECLARE @SUM_extended_wholesale_act DECIMAL (18,3)

SELECT @SUM_extended_1st_cost = ISNULL(SUM (extended_1st_cost),0) FROM #tmpBase
SELECT @SUM_extended_retail_gbp = ISNULL(SUM (extended_retail_gbp),0) FROM #tmpBase
SELECT @SUM_extended_wholesale = ISNULL(SUM (extended_wholesale),0) FROM #tmpBase

SELECT @SUM_extended_1st_cost_act = ISNULL(SUM (extended_1st_cost_act),0) FROM #tmpBase
SELECT @SUM_extended_retail_gbp_act = ISNULL(SUM (extended_retail_gbp_act),0) FROM #tmpBase
SELECT @SUM_extended_wholesale_act = ISNULL(SUM (extended_wholesale_act),0) FROM #tmpBase


--LAST YEAR
SET @LY_WGM_RETAIL = 0
SET @LY_WGM_WHOLESALES = 0

-- PLANNING 
SET @PN_WGM_RETAIL = CASE WHEN @SUM_extended_retail_gbp = 0 THEN 0 ELSE (@SUM_extended_retail_gbp + @SUM_extended_1st_cost)/ @SUM_extended_retail_gbp END
SET @PN_WGM_WHOLESALES = CASE WHEN @SUM_extended_wholesale = 0 THEN 0 ELSE (@SUM_extended_wholesale + @SUM_extended_1st_cost)/ @SUM_extended_wholesale END 

-- actual 
SET @CU_WGM_RETAIL = CASE WHEN @SUM_extended_retail_gbp_act = 0 THEN 0 ELSE (@SUM_extended_retail_gbp_act + @SUM_extended_1st_cost_act)/ @SUM_extended_retail_gbp_act END 
SET @CU_WGM_WHOLESALES = CASE WHEN @SUM_extended_wholesale_act = 0 THEN 0 ELSE (@SUM_extended_wholesale_act + @SUM_extended_1st_cost_act)/ @SUM_extended_wholesale_act END 


DROP TABLE #tmpBase 


INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,LinePlanBusCuCh1,LinePlanAttributeItemID1,	LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000011',  'Weight Gross Margin WHS', 
ISNULL(@LY_WGM_WHOLESALES,0) , ISNULL(@PN_WGM_WHOLESALES,0),  ISNULL(@CU_WGM_WHOLESALES,0),
@LinePlanAttributeItemID1,'0020' , 0 )


INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,LinePlanBusCuCh1,	LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000012',   'Weight Gross Margin Retail', 
ISNULL(@LY_WGM_RETAIL,0) ,  ISNULL(@PN_WGM_RETAIL,0),  ISNULL(@CU_WGM_RETAIL,0),
@LinePlanAttributeItemID1,'0019' , 0)



--=============================================================================================================================


--SELECT * FROM #tmpLinePlanBusiness ORDER BY LinePlanFinancialSort

SELECT 	#tmpLinePlanBusiness.LinePlanID, 
	#tmpLinePlanBusiness.LinePlanFinancialID, 
	pLinePlanFinancial.LinePlanFinancialText, 
	#tmpLinePlanBusiness.LinePlanFinancialSort, 
	#tmpLinePlanBusiness.LinePlanAttributeItemID1, 
	#tmpLinePlanBusiness.LinePlanAttributeItemID2, 
	#tmpLinePlanBusiness.LinePlanAttributeItemID3, 
	#tmpLinePlanBusiness.LinePlanAttributeItemID4, 
	pLinePlanFinancial.LinePlanFinancialDataType, 
	pLinePlanFinancial.LinePlanFinancialDataFormat, 
	pLinePlanFinancial.LinePlanFinancialCssClass,
	#tmpLinePlanBusiness.LinePlanBusLYCh1,
	#tmpLinePlanBusiness.LinePlanBusPnCh1,
	#tmpLinePlanBusiness.LinePlanBusCuCh1,
	#tmpLinePlanBusiness.LinePlanBusWpCh1
FROM  #tmpLinePlanBusiness INNER JOIN
    pLinePlanFinancial ON #tmpLinePlanBusiness.LinePlanFinancialID = pLinePlanFinancial.LinePlanFinancialID
ORDER BY #tmpLinePlanBusiness.LinePlanFinancialSort

--DROP TABLE #TempTable
--DROP TABLE #tmpLinePlanOptions
--DROP TABLE #tmpLinePlanWeightGrossMarginRtl
--DROP TABLE #tmpLinePlanWeightGrossMarginWhs
DROP TABLE #tmpLinePlanBusiness


















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_LineFolder_MainMaterial_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.  Needed to add the 'Version' field to the temp table for
the image stream and get the 'Version' from 'hImage' to put in the temp table.
*/


ALTER          PROCEDURE [dbo].[rpx_LineFolder_MainMaterial_SELECT] 
(
	@LineFolderID AS varchar(50)
)
AS


CREATE TABLE #tempLineFolderStyles
(
	TableRow int identity(0,1),
	StyleID varchar(50),
	StyleNo varchar(50),
	[Description] nvarchar(255),
	ImageID varchar(50),
	ImageHistoryID varchar(50),
	LineFolderItemDrop varchar(5),
	LineFolderItemDropUser nvarchar(255),
	LineFolderItemDropDate datetime,
	SizeClass nvarchar(50),
	SizeRange nvarchar(50),
	MaterialName nvarchar(100),
	MaterialNo nvarchar(50),
	[Version] int	--Comment #01
)

/*Insert info into temp table.*/
INSERT INTO #tempLineFolderStyles(StyleID, StyleNo, [Description], ImageID, ImageHistoryID,
	LineFolderItemDrop, LineFolderItemDropUser,	LineFolderItemDropDate, SizeClass, SizeRange, MaterialName,
	MaterialNo, [Version])	--Comment #01
SELECT b.StyleID, b.StyleNo, b.[Description], c.ImageID, c.ImageHistoryID,
	a.LineFolderItemDrop, a.LineFolderItemDropUser, a.LineFolderItemDropDate, b.SizeClass, b.SizeRange, d.MaterialName,
	d.MaterialNo, c.[Version]	--Comment #01
FROM pLineFolderItem a INNER JOIN pStyleHeader b ON
a.StyleID = b.StyleID INNER JOIN hImage c ON
b.DesignSketchID = c.ImageID AND b.DesignSketchVersion = c.Version LEFT OUTER JOIN pMaterial d ON
b.MaterialID = d.MaterialID
WHERE a.LineFolderID = @LineFolderID
ORDER BY a.LineFolderItemSort, b.StyleNo, b.Description

/*Select the information how you want for the report.*/
SELECT
	TableRow % 3 AS [Column],
	StyleID,
	StyleNo,
	[Description],
	dbo.fnx_GetStreamingImagePath(ImageID, [Version]) AS FilePath,	--Comment #01
	@LineFolderID AS LineFolderID,
	LineFolderItemDrop,
	'Dropped By ' + LineFolderItemDropUser + ' - ' + CAST(LineFolderItemDropDate AS varchar(50)) AS DroppedInfo,
	SizeClass,
	SizeRange,
	MaterialName,
	MaterialNo
FROM #tempLineFolderStyles

DROP TABLE #tempLineFolderStyles





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_DesktopAccessControlPanelCheck_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_Group_DesktopAccessControlPanelCheck_INSERT] (
@GroupID uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

DECLARE @I as int
DECLARE @Row_Count int
DECLARE @ControlPanelId int
DECLARE @DeskAccessId int
DECLARE @DeskTableName varchar(100)
DECLARE @DeskTableKey varchar(50)


	BEGIN
	CREATE TABLE #TempUserAccess (
		Id int IDENTITY (1, 1) NOT NULL , 
		ControlPanelId int NOT NULL,
		GroupID  uniqueidentifier
	) 
	END

	BEGIN
	
	INSERT INTO #TempUserAccess(ControlPanelId) SELECT ControlPanelId FROM pControlPanel
	
	
	SET @Row_Count = (SELECT COUNT(*) FROM #TempUserAccess)
	
	SET @I = 1

	WHILE @I <= @Row_Count 
		BEGIN

			SELECT @ControlPanelId = ControlPanelId FROM #TempUserAccess WHERE ID = @I
			IF (SELECT COUNT(*) FROM sAccessGroupControlPanel WITH (NOLOCK) WHERE ControlPanelId = @ControlPanelId AND GroupID  = @GroupID  ) = 0
			BEGIN
				INSERT INTO sAccessGroupControlPanel
					(ControlPanelId, GroupID, CUser, CDate, MUser, MDate)
				SELECT ControlPanelId, @GroupID, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate 
				FROM  #TempUserAccess WHERE Id = @I
			END
				
			SET @I = @I + 1
		END

		SELECT * FROM #tempUserAccess

	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Style_Header_Image_SELECT]'
GO




/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.

#02 - Ryan Cabanas - November 3, 2009
	Pass the 'Season' and 'Year' information to the report.
*/


ALTER    PROCEDURE [dbo].[rpx_Style_Header_Image_SELECT]
(
	@StyleID varchar(255)
	,@SeasonYearID NVARCHAR(50) = '00000000-0000-0000-0000-000000000000'
)
AS


--Comment #02
/*Declare variables.*/
DECLARE @Season nvarchar(50)
DECLARE @Year nvarchar(50)

--Comment #02
/*Get 'Season' and 'Year'.*/
SELECT @Season = Season
	,@Year = [Year]
FROM pSeasonYear
WHERE SeasonYearID = @SeasonYearID


SELECT dbo.fnx_GetStreamingImagePath(hImage.ImageID, hImage.[Version]) AS FilePath,	--Comment #01
	pStyleHeader.StyleNo,
	pStyleHeader.SizeClass, 
	pStyleHeader.SizeRange,
	pStyleHeader.[Description],
	@Season AS Season,	--Comment #02
	@Year AS [Year]		--Comment #02
FROM	pStyleHeader LEFT OUTER JOIN hImage ON
	pStyleHeader.DesignSketchID = hImage.ImageID AND
	pStyleHeader.DesignSketchVersion = hImage.Version
WHERE pStyleHeader.StyleID = @StyleID





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanBusinessRollup3_SELECT]'
GO


ALTER PROCEDURE [dbo].[spx_LinePlanBusinessRollup3_SELECT]
(
@LinePlanIndex varchar(1),
@LinePlanId varchar(40),
@LinePlanAttributeItemId1 varchar(40),
@LinePlanAttributeItemId2 varchar(40),
@LinePlanAttributeItemId3 varchar(40)
)
AS 


DECLARE @NoOfStyleText VARCHAR(200)
DECLARE @NoOfColorText VARCHAR(200)
DECLARE @NoOfBodyText VARCHAR(200)
DECLARE @NoOfFabricText VARCHAR(200)
DECLARE @NoOfOptionsText VARCHAR(200)
DECLARE @TargetAvgRetailPriceLowText VARCHAR(200)
DECLARE @NoOfStyleLowText VARCHAR(200)
DECLARE @TargetAvgRetailPriceMedText VARCHAR(200)
DECLARE @NoOfStyleMedText VARCHAR(200)
DECLARE @TargetAvgRetailPriceHighText VARCHAR(200)
DECLARE @NoOfStyleHighText VARCHAR(200)
DECLARE @MarkupFactorText VARCHAR(200)
DECLARE @SalesUnitText VARCHAR(200)
DECLARE @ProjectedWhsText VARCHAR(200)
DECLARE @InitialGrossMarginRtlText VARCHAR(200)
DECLARE @WeightedAverageRetailPriceText VARCHAR(200)

DECLARE @LY1_NoOfStyle INTEGER
DECLARE @LY1_NoOfFabric INTEGER
DECLARE @LY1_NoOfBody INTEGER 
DECLARE @LY1_NoOfColor INTEGER
DECLARE @LY1_NoOfOptions INTEGER
DECLARE @LY1_MarkupFactor DECIMAL(18, 3)
DECLARE @LY1_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @LY1_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @LY1_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @LY1_NoOfStyleLow DECIMAL(18, 3)
DECLARE @LY1_NoOfStyleMed DECIMAL(18, 3)
DECLARE @LY1_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @LY1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @LY1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @LY1_SalesUnit DECIMAL(18, 3)
DECLARE @LY1_ProjectedWhs DECIMAL(18, 3)
DECLARE @LY1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY1_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY1_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @LY2_NoOfStyle INTEGER
DECLARE @LY2_NoOfFabric INTEGER
DECLARE @LY2_NoOfBody INTEGER 
DECLARE @LY2_NoOfColor INTEGER
DECLARE @LY2_NoOfOptions INTEGER
DECLARE @LY2_MarkupFactor DECIMAL(18, 3)
DECLARE @LY2_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @LY2_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @LY2_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @LY2_NoOfStyleLow DECIMAL(18, 3)
DECLARE @LY2_NoOfStyleMed DECIMAL(18, 3)
DECLARE @LY2_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @LY2_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @LY2_AvgTargetFOB DECIMAL(18, 3)
DECLARE @LY2_SalesUnit DECIMAL(18, 3)
DECLARE @LY2_ProjectedWhs DECIMAL(18, 3)
DECLARE @LY2_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY2_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY2_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY2_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY2_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @LY3_NoOfStyle INTEGER
DECLARE @LY3_NoOfFabric INTEGER
DECLARE @LY3_NoOfBody INTEGER 
DECLARE @LY3_NoOfColor INTEGER
DECLARE @LY3_NoOfOptions INTEGER
DECLARE @LY3_MarkupFactor DECIMAL(18, 3)
DECLARE @LY3_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @LY3_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @LY3_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @LY3_NoOfStyleLow DECIMAL(18, 3)
DECLARE @LY3_NoOfStyleMed DECIMAL(18, 3)
DECLARE @LY3_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @LY3_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @LY3_AvgTargetFOB DECIMAL(18, 3)
DECLARE @LY3_SalesUnit DECIMAL(18, 3)
DECLARE @LY3_ProjectedWhs DECIMAL(18, 3)
DECLARE @LY3_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY3_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY3_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY3_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY3_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @LY4_NoOfStyle INTEGER
DECLARE @LY4_NoOfFabric INTEGER
DECLARE @LY4_NoOfBody INTEGER 
DECLARE @LY4_NoOfColor INTEGER
DECLARE @LY4_NoOfOptions INTEGER
DECLARE @LY4_MarkupFactor DECIMAL(18, 3)
DECLARE @LY4_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @LY4_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @LY4_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @LY4_NoOfStyleLow DECIMAL(18, 3)
DECLARE @LY4_NoOfStyleMed DECIMAL(18, 3)
DECLARE @LY4_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @LY4_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @LY4_AvgTargetFOB DECIMAL(18, 3)
DECLARE @LY4_SalesUnit DECIMAL(18, 3)
DECLARE @LY4_ProjectedWhs DECIMAL(18, 3)
DECLARE @LY4_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY4_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY4_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY4_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY4_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @PL1_NoOfStyle INTEGER
DECLARE @PL1_NoOfFabric INTEGER
DECLARE @PL1_NoOfBody INTEGER 
DECLARE @PL1_NoOfColor INTEGER
DECLARE @PL1_NoOfOptions INTEGER
DECLARE @PL1_MarkupFactor DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleLow DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleMed DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @PL1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @PL1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @PL1_SalesUnit DECIMAL(18, 3)
DECLARE @PL1_ProjectedWhs DECIMAL(18, 3)
DECLARE @PL1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL1_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL1_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @PL2_NoOfStyle INTEGER
DECLARE @PL2_NoOfFabric INTEGER
DECLARE @PL2_NoOfBody INTEGER 
DECLARE @PL2_NoOfColor INTEGER
DECLARE @PL2_NoOfOptions INTEGER
DECLARE @PL2_MarkupFactor DECIMAL(18, 3)
DECLARE @PL2_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @PL2_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @PL2_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @PL2_NoOfStyleLow DECIMAL(18, 3)
DECLARE @PL2_NoOfStyleMed DECIMAL(18, 3)
DECLARE @PL2_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @PL2_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @PL2_AvgTargetFOB DECIMAL(18, 3)
DECLARE @PL2_SalesUnit DECIMAL(18, 3)
DECLARE @PL2_ProjectedWhs DECIMAL(18, 3)
DECLARE @PL2_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL2_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL2_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL2_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL2_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @PL3_NoOfStyle INTEGER
DECLARE @PL3_NoOfFabric INTEGER
DECLARE @PL3_NoOfBody INTEGER 
DECLARE @PL3_NoOfColor INTEGER
DECLARE @PL3_NoOfOptions INTEGER
DECLARE @PL3_MarkupFactor DECIMAL(18, 3)
DECLARE @PL3_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @PL3_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @PL3_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @PL3_NoOfStyleLow DECIMAL(18, 3)
DECLARE @PL3_NoOfStyleMed DECIMAL(18, 3)
DECLARE @PL3_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @PL3_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @PL3_AvgTargetFOB DECIMAL(18, 3)
DECLARE @PL3_SalesUnit DECIMAL(18, 3)
DECLARE @PL3_ProjectedWhs DECIMAL(18, 3)
DECLARE @PL3_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL3_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL3_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL3_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL3_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @PL4_NoOfStyle INTEGER
DECLARE @PL4_NoOfFabric INTEGER
DECLARE @PL4_NoOfBody INTEGER 
DECLARE @PL4_NoOfColor INTEGER
DECLARE @PL4_NoOfOptions INTEGER
DECLARE @PL4_MarkupFactor DECIMAL(18, 3)
DECLARE @PL4_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @PL4_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @PL4_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @PL4_NoOfStyleLow DECIMAL(18, 3)
DECLARE @PL4_NoOfStyleMed DECIMAL(18, 3)
DECLARE @PL4_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @PL4_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @PL4_AvgTargetFOB DECIMAL(18, 3)
DECLARE @PL4_SalesUnit DECIMAL(18, 3)
DECLARE @PL4_ProjectedWhs DECIMAL(18, 3)
DECLARE @PL4_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL4_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL4_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL4_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL4_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @Cu1_NoOfStyle INTEGER
DECLARE @Cu1_NoOfFabric INTEGER
DECLARE @Cu1_NoOfBody INTEGER 
DECLARE @Cu1_NoOfColor INTEGER
DECLARE @Cu1_NoOfOptions INTEGER
DECLARE @Cu1_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @Cu1_NoOfStyleLow DECIMAL(18, 3)
DECLARE @Cu1_NoOfStyleMed DECIMAL(18, 3)
DECLARE @Cu1_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Cu1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Cu1_SalesUnit DECIMAL(18, 3)
DECLARE @Cu1_ProjectedWhs DECIMAL(18, 3)
DECLARE @Cu1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu1_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu1_WeightedAverageRetailPrice DECIMAL(18, 3)


DECLARE @Cu2_NoOfStyle INTEGER
DECLARE @Cu2_NoOfFabric INTEGER
DECLARE @Cu2_NoOfBody INTEGER 
DECLARE @Cu2_NoOfColor INTEGER
DECLARE @Cu2_NoOfOptions INTEGER
DECLARE @Cu2_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu2_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @Cu2_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @Cu2_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @Cu2_NoOfStyleLow DECIMAL(18, 3)
DECLARE @Cu2_NoOfStyleMed DECIMAL(18, 3)
DECLARE @Cu2_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @Cu2_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Cu2_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Cu2_SalesUnit DECIMAL(18, 3)
DECLARE @Cu2_ProjectedWhs DECIMAL(18, 3)
DECLARE @Cu2_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu2_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu2_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu2_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu2_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @Cu3_NoOfStyle INTEGER
DECLARE @Cu3_NoOfFabric INTEGER
DECLARE @Cu3_NoOfBody INTEGER 
DECLARE @Cu3_NoOfColor INTEGER
DECLARE @Cu3_NoOfOptions INTEGER
DECLARE @Cu3_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu3_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @Cu3_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @Cu3_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @Cu3_NoOfStyleLow DECIMAL(18, 3)
DECLARE @Cu3_NoOfStyleMed DECIMAL(18, 3)
DECLARE @Cu3_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @Cu3_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Cu3_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Cu3_SalesUnit DECIMAL(18, 3)
DECLARE @Cu3_ProjectedWhs DECIMAL(18, 3)
DECLARE @Cu3_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu3_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu3_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu3_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu3_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @Cu4_NoOfStyle INTEGER
DECLARE @Cu4_NoOfFabric INTEGER
DECLARE @Cu4_NoOfBody INTEGER 
DECLARE @Cu4_NoOfColor INTEGER
DECLARE @Cu4_NoOfOptions INTEGER
DECLARE @Cu4_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu4_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @Cu4_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @Cu4_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @Cu4_NoOfStyleLow DECIMAL(18, 3)
DECLARE @Cu4_NoOfStyleMed DECIMAL(18, 3)
DECLARE @Cu4_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @Cu4_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Cu4_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Cu4_SalesUnit DECIMAL(18, 3)
DECLARE @Cu4_ProjectedWhs DECIMAL(18, 3)
DECLARE @Cu4_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu4_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu4_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu4_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu4_WeightedAverageRetailPrice DECIMAL(18, 3)

---- Create Temp table
CREATE TABLE #tmpLinePlanBusiness(
	[LinePlanID] [uniqueidentifier] NULL,
	[LinePlanFinancialID] [uniqueidentifier] NULL,
	[LinePlanFinancialText] [nvarchar](100) NULL,
	[LinePlanAttributeItemID1] [uniqueidentifier] NULL,
	[LinePlanAttributeItemID2] [uniqueidentifier] NULL,
	[LinePlanAttributeItemID3] [uniqueidentifier] NULL,
	[LinePlanAttributeItemID4] [uniqueidentifier] NULL,
	[LinePlanBusLYCh1] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusLYCh2] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusLYCh3] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusLYCh4] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusLYCh5] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusPnCh1] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusPnCh2] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusPnCh3] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusPnCh4] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusPnCh5] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusCuCh1] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusCuCh2] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusCuCh3] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusCuCh4] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusCuCh5] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusWpCh1] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusWpCh2] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusWpCh3] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusWpCh4] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanFinancialSort] [varchar](5) NULL
)


--- # of Style
SELECT  
	@NoOfStyleText = LinePlanFinancialText,
	@LY1_NoOfStyle = SUM(LinePlanBusLYCh1), 
	@LY2_NoOfStyle = SUM(LinePlanBusLYCh2),
	@LY3_NoOfStyle = SUM(LinePlanBusLYCh3), 
	@LY4_NoOfStyle = SUM(LinePlanBusLYCh4), 
	@PL1_NoOfStyle = SUM(LinePlanBusPnCh1), 
	@PL2_NoOfStyle = SUM(LinePlanBusPnCh2), 
	@PL3_NoOfStyle = SUM(LinePlanBusPnCh3), 
	@PL4_NoOfStyle = SUM(LinePlanBusPnCh4), 
	@Cu1_NoOfStyle = SUM(LinePlanBusCuCh1), 
	@Cu2_NoOfStyle = SUM(LinePlanBusCuCh2), 
	@Cu3_NoOfStyle = SUM(LinePlanBusCuCh3), 
	@Cu4_NoOfStyle = SUM(LinePlanBusCuCh4) 
FROM pLinePlanBusiness
WHERE (LinePlanFinancialID = '10000000-0000-0000-0000-000000000004') AND 
	LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND
	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND
	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3

INSERT INTO #tmpLinePlanBusiness(
	LinePlanID, 
	LinePlanFinancialID, 
	LinePlanFinancialText,
	LinePlanBusLYCh1,
	LinePlanBusLYCh2,
	LinePlanBusLYCh3,
	LinePlanBusLYCh4,
	LinePlanBusPnCh1,
	LinePlanBusPnCh2,
	LinePlanBusPnCh3,
	LinePlanBusPnCh4,
	LinePlanBusCuCh1,
	LinePlanBusCuCh2,
	LinePlanBusCuCh3,
	LinePlanBusCuCh4,
	LinePlanAttributeItemID1,
	LinePlanFinancialSort)
VALUES (   
	@LinePlanID, 
	'10000000-0000-0000-0000-000000000004',     
	@NoOfStyleText, 
	@LY1_NoOfStyle, 
	@LY2_NoOfStyle, 
	@LY3_NoOfStyle, 
	@LY4_NoOfStyle, 
	@PL1_NoOfStyle, 
	@PL2_NoOfStyle, 
	@PL3_NoOfStyle, 
	@PL4_NoOfStyle, 
	@Cu1_NoOfStyle, 
	@Cu2_NoOfStyle, 
	@Cu3_NoOfStyle, 
	@Cu4_NoOfStyle, 
	@LinePlanAttributeItemID1,
	'0001')

--- # of Fabric
SELECT 
	@NoOfFabricText = LinePlanFinancialText,
	@LY1_NoOfFabric = SUM(LinePlanBusLYCh1), 
	@LY2_NoOfFabric = SUM(LinePlanBusLYCh2),
	@LY3_NoOfFabric = SUM(LinePlanBusLYCh3), 
	@LY4_NoOfFabric = SUM(LinePlanBusLYCh4), 
	@PL1_NoOfFabric = SUM(LinePlanBusPnCh1), 
	@PL2_NoOfFabric = SUM(LinePlanBusPnCh2), 
	@PL3_NoOfFabric = SUM(LinePlanBusPnCh3), 
	@PL4_NoOfFabric = SUM(LinePlanBusPnCh4), 
	@Cu1_NoOfFabric = SUM(LinePlanBusCuCh1), 
	@Cu2_NoOfFabric = SUM(LinePlanBusCuCh2), 
	@Cu3_NoOfFabric = SUM(LinePlanBusCuCh3), 
	@Cu4_NoOfFabric = SUM(LinePlanBusCuCh4) 
FROM pLinePlanBusiness
WHERE (LinePlanFinancialID = '10000000-0000-0000-0000-000000000001') AND 
	LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND
	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND
	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3

INSERT INTO #tmpLinePlanBusiness(
	LinePlanID, 
	LinePlanFinancialID, 
	LinePlanFinancialText,
	LinePlanBusLYCh1,
	LinePlanBusLYCh2,
	LinePlanBusLYCh3,
	LinePlanBusLYCh4,
	LinePlanBusPnCh1,
	LinePlanBusPnCh2,
	LinePlanBusPnCh3,
	LinePlanBusPnCh4,
	LinePlanBusCuCh1,
	LinePlanBusCuCh2,
	LinePlanBusCuCh3,
	LinePlanBusCuCh4,
	LinePlanAttributeItemID1,
	LinePlanFinancialSort)
VALUES (   
	@LinePlanID, 
	'10000000-0000-0000-0000-000000000001',     
	@NoOfFabricText, 
	@LY1_NoOfFabric, 
	@LY2_NoOfFabric, 
	@LY3_NoOfFabric, 
	@LY4_NoOfFabric, 
	@PL1_NoOfFabric, 
	@PL2_NoOfFabric, 
	@PL3_NoOfFabric, 
	@PL4_NoOfFabric, 
	@Cu1_NoOfFabric, 
	@Cu2_NoOfFabric, 
	@Cu3_NoOfFabric, 
	@Cu4_NoOfFabric, 
	@LinePlanAttributeItemID1,
	'0002')


--- # of Body
SELECT  
	@NoOfBodyText = LinePlanFinancialText,
	@LY1_NoOfBody = SUM(LinePlanBusLYCh1), 
	@LY2_NoOfBody = SUM(LinePlanBusLYCh2),
	@LY3_NoOfBody = SUM(LinePlanBusLYCh3), 
	@LY4_NoOfBody = SUM(LinePlanBusLYCh4), 
	@PL1_NoOfBody = SUM(LinePlanBusPnCh1), 
	@PL2_NoOfBody = SUM(LinePlanBusPnCh2), 
	@PL3_NoOfBody = SUM(LinePlanBusPnCh3), 
	@PL4_NoOfBody = SUM(LinePlanBusPnCh4), 
	@Cu1_NoOfBody = SUM(LinePlanBusCuCh1), 
	@Cu2_NoOfBody = SUM(LinePlanBusCuCh2), 
	@Cu3_NoOfBody = SUM(LinePlanBusCuCh3), 
	@Cu4_NoOfBody = SUM(LinePlanBusCuCh4) 
FROM pLinePlanBusiness
WHERE     (LinePlanFinancialID = '10000000-0000-0000-0000-000000000003') AND 
	LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND
	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND
	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3

INSERT INTO #tmpLinePlanBusiness(
	LinePlanID, 
	LinePlanFinancialID, 
	LinePlanFinancialText,
	LinePlanBusLYCh1,
	LinePlanBusLYCh2,
	LinePlanBusLYCh3,
	LinePlanBusLYCh4,
	LinePlanBusPnCh1,
	LinePlanBusPnCh2,
	LinePlanBusPnCh3,
	LinePlanBusPnCh4,
	LinePlanBusCuCh1,
	LinePlanBusCuCh2,
	LinePlanBusCuCh3,
	LinePlanBusCuCh4,
	LinePlanAttributeItemID1,
	LinePlanFinancialSort)
VALUES (   
	@LinePlanID, 
	'10000000-0000-0000-0000-000000000003',     
	@NoOfBodyText, 
	@LY1_NoOfBody, 
	@LY2_NoOfBody, 
	@LY3_NoOfBody, 
	@LY4_NoOfBody, 
	@PL1_NoOfBody, 
	@PL2_NoOfBody, 
	@PL3_NoOfBody, 
	@PL4_NoOfBody, 
	@Cu1_NoOfBody, 
	@Cu2_NoOfBody, 
	@Cu3_NoOfBody, 
	@Cu4_NoOfBody, 
	@LinePlanAttributeItemID1,
	'0003')


---- # of Color
SELECT  
	@NoOfColorText = LinePlanFinancialText,
	@LY1_NoOfColor = SUM(LinePlanBusLYCh1), 
	@LY2_NoOfColor = SUM(LinePlanBusLYCh2),
	@LY3_NoOfColor = SUM(LinePlanBusLYCh3), 
	@LY4_NoOfColor = SUM(LinePlanBusLYCh4), 
	@PL1_NoOfColor = SUM(LinePlanBusPnCh1), 
	@PL2_NoOfColor = SUM(LinePlanBusPnCh2), 
	@PL3_NoOfColor = SUM(LinePlanBusPnCh3), 
	@PL4_NoOfColor = SUM(LinePlanBusPnCh4), 
	@Cu1_NoOfColor = SUM(LinePlanBusCuCh1), 
	@Cu2_NoOfColor = SUM(LinePlanBusCuCh2), 
	@Cu3_NoOfColor = SUM(LinePlanBusCuCh3), 
	@Cu4_NoOfColor = SUM(LinePlanBusCuCh4) 
FROM pLinePlanBusiness
WHERE     (LinePlanFinancialID = '10000000-0000-0000-0000-000000000002') AND 
	LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND
	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND
	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3

INSERT INTO #tmpLinePlanBusiness(
	LinePlanID, 
	LinePlanFinancialID, 
	LinePlanFinancialText,
	LinePlanBusLYCh1,
	LinePlanBusLYCh2,
	LinePlanBusLYCh3,
	LinePlanBusLYCh4,
	LinePlanBusPnCh1,
	LinePlanBusPnCh2,
	LinePlanBusPnCh3,
	LinePlanBusPnCh4,
	LinePlanBusCuCh1,
	LinePlanBusCuCh2,
	LinePlanBusCuCh3,
	LinePlanBusCuCh4,
	LinePlanAttributeItemID1,
	LinePlanFinancialSort)
VALUES (  
	@LinePlanID, 
	'10000000-0000-0000-0000-000000000002',     
	@NoOfColorText, 
	@LY1_NoOfColor, 
	@LY2_NoOfColor, 
	@LY3_NoOfColor, 
	@LY4_NoOfColor, 
	@PL1_NoOfColor, 
	@PL2_NoOfColor, 
	@PL3_NoOfColor, 
	@PL4_NoOfColor, 
	@Cu1_NoOfColor, 
	@Cu2_NoOfColor, 
	@Cu3_NoOfColor, 
	@Cu4_NoOfColor, 
	@LinePlanAttributeItemID1,
	'0004')

---- # of Options
INSERT INTO #tmpLinePlanBusiness(
	LinePlanID, 
	LinePlanFinancialID, 
	LinePlanFinancialText,
	LinePlanBusLYCh1,
	LinePlanBusLYCh2,
	LinePlanBusLYCh3,
	LinePlanBusLYCh4,
	LinePlanBusPnCh1,
	LinePlanBusPnCh2,
	LinePlanBusPnCh3,
	LinePlanBusPnCh4,
	LinePlanBusCuCh1,
	LinePlanBusCuCh2,
	LinePlanBusCuCh3,
	LinePlanBusCuCh4,
	LinePlanAttributeItemID1,
	LinePlanFinancialSort)
VALUES (  
	@LinePlanID, 
	'10000000-0000-0000-0000-000000000005',     
	'No of Options', 
	(@LY1_NoOfStyle * @LY1_NoOfFabric * @LY1_NoOfColor), 
	(@LY2_NoOfStyle * @LY2_NoOfFabric * @LY2_NoOfColor), 
	(@LY3_NoOfStyle * @LY3_NoOfFabric * @LY3_NoOfColor), 
	(@LY4_NoOfStyle * @LY4_NoOfFabric * @LY4_NoOfColor), 
	(@PL1_NoOfStyle * @PL1_NoOfFabric * @PL1_NoOfColor), 
	(@PL2_NoOfStyle * @PL2_NoOfFabric * @PL2_NoOfColor), 
	(@PL3_NoOfStyle * @PL3_NoOfFabric * @PL3_NoOfColor), 
	(@PL4_NoOfStyle * @PL4_NoOfFabric * @PL4_NoOfColor), 
	(@Cu1_NoOfStyle * @Cu1_NoOfFabric * @Cu1_NoOfColor), 
	(@Cu2_NoOfStyle * @Cu2_NoOfFabric * @Cu2_NoOfColor), 
	(@Cu3_NoOfStyle * @Cu3_NoOfFabric * @Cu3_NoOfColor), 
	(@Cu4_NoOfStyle * @Cu4_NoOfFabric * @Cu4_NoOfColor), 
	@LinePlanAttributeItemID1,
	'0005')

--- Markup Factor
SELECT 
	@MarkupFactorText = LinePlanFinancialText,
	@LY1_MarkupFactor = AVG(LinePlanBusLYCh1), 
	@LY2_MarkupFactor = AVG(LinePlanBusLYCh2),
	@LY3_MarkupFactor = AVG(LinePlanBusLYCh3), 
	@LY4_MarkupFactor = AVG(LinePlanBusLYCh4), 
	@PL1_MarkupFactor = AVG(LinePlanBusPnCh1), 
	@PL2_MarkupFactor = AVG(LinePlanBusPnCh2), 
	@PL3_MarkupFactor = AVG(LinePlanBusPnCh3), 
	@PL4_MarkupFactor = AVG(LinePlanBusPnCh4), 
	@Cu1_MarkupFactor = AVG(LinePlanBusCuCh1), 
	@Cu2_MarkupFactor = AVG(LinePlanBusCuCh2), 
	@Cu3_MarkupFactor = AVG(LinePlanBusCuCh3), 
	@Cu4_MarkupFactor = AVG(LinePlanBusCuCh4) 
FROM pLinePlanBusiness
WHERE (LinePlanFinancialID = '00000000-0000-0000-0000-000000000005') AND 
	LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND
	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND
	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3


INSERT INTO #tmpLinePlanBusiness(
	LinePlanID, 
	LinePlanFinancialID, 
	LinePlanFinancialText,
	LinePlanBusLYCh1,
	LinePlanBusLYCh2,
	LinePlanBusLYCh3,
	LinePlanBusLYCh4,
	LinePlanBusPnCh1,
	LinePlanBusPnCh2,
	LinePlanBusPnCh3,
	LinePlanBusPnCh4,
	LinePlanBusCuCh1,
	LinePlanBusCuCh2,
	LinePlanBusCuCh3,
	LinePlanBusCuCh4,
	LinePlanAttributeItemID1,
	LinePlanFinancialSort)
VALUES (  
	@LinePlanID, 
	'00000000-0000-0000-0000-000000000005',     
	@MarkupFactorText, 
	@LY1_MarkupFactor, 
	@LY2_MarkupFactor, 
	@LY3_MarkupFactor, 
	@LY4_MarkupFactor, 
	@PL1_MarkupFactor, 
	@PL2_MarkupFactor, 
	@PL3_MarkupFactor, 
	@PL4_MarkupFactor, 
	@Cu1_MarkupFactor, 
	@Cu2_MarkupFactor, 
	@Cu3_MarkupFactor, 
	@Cu4_MarkupFactor, 
	@LinePlanAttributeItemID1,
	'0006')

---Initial Gross Margin Retail
SELECT 
	@InitialGrossMarginRtlText = LinePlanFinancialText,
	@LY1_InitialGrossMarginRtl = AVG(LinePlanBusLYCh1), 
	@LY2_InitialGrossMarginRtl = AVG(LinePlanBusLYCh2),
	@LY3_InitialGrossMarginRtl = AVG(LinePlanBusLYCh3), 
	@LY4_InitialGrossMarginRtl = AVG(LinePlanBusLYCh4), 
	@PL1_InitialGrossMarginRtl = AVG(LinePlanBusPnCh1), 
	@PL2_InitialGrossMarginRtl = AVG(LinePlanBusPnCh2), 
	@PL3_InitialGrossMarginRtl = AVG(LinePlanBusPnCh3), 
	@PL4_InitialGrossMarginRtl = AVG(LinePlanBusPnCh4), 
	@Cu1_InitialGrossMarginRtl = AVG(LinePlanBusCuCh1), 
	@Cu2_InitialGrossMarginRtl = AVG(LinePlanBusCuCh2), 
	@Cu3_InitialGrossMarginRtl = AVG(LinePlanBusCuCh3), 
	@Cu4_InitialGrossMarginRtl = AVG(LinePlanBusCuCh4) 
FROM pLinePlanBusiness
WHERE (LinePlanFinancialID = '00000000-0000-0000-0000-000000000010') AND 
	LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND
	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND
	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3

INSERT INTO #tmpLinePlanBusiness(
	LinePlanID, 
	LinePlanFinancialID, 
	LinePlanFinancialText,
	LinePlanBusLYCh1,
	LinePlanBusLYCh2,
	LinePlanBusLYCh3,
	LinePlanBusLYCh4,
	LinePlanBusPnCh1,
	LinePlanBusPnCh2,
	LinePlanBusPnCh3,
	LinePlanBusPnCh4,
	LinePlanBusCuCh1,
	LinePlanBusCuCh2,
	LinePlanBusCuCh3,
	LinePlanBusCuCh4,
	LinePlanAttributeItemID1,
	LinePlanFinancialSort)
VALUES (   
	@LinePlanID, 
	'00000000-0000-0000-0000-000000000010',     
	@InitialGrossMarginRtlText, 
	@LY1_InitialGrossMarginRtl, 
	@LY2_InitialGrossMarginRtl, 
	@LY3_InitialGrossMarginRtl, 
	@LY4_InitialGrossMarginRtl, 
	@PL1_InitialGrossMarginRtl, 
	@PL2_InitialGrossMarginRtl, 
	@PL3_InitialGrossMarginRtl, 
	@PL4_InitialGrossMarginRtl, 
	@Cu1_InitialGrossMarginRtl, 
	@Cu2_InitialGrossMarginRtl, 
	@Cu3_InitialGrossMarginRtl, 
	@Cu4_InitialGrossMarginRtl, 
	@LinePlanAttributeItemID1,
	'0017')


--- Target Avg Retail Price (low)
SELECT 
	@TargetAvgRetailPriceLowText = LinePlanFinancialText,
	@LY1_TargetAvgRetailPriceLow = AVG(LinePlanBusLYCh1), 
	@LY2_TargetAvgRetailPriceLow = AVG(LinePlanBusLYCh2),
	@LY3_TargetAvgRetailPriceLow = AVG(LinePlanBusLYCh3), 
	@LY4_TargetAvgRetailPriceLow = AVG(LinePlanBusLYCh4), 
	@PL1_TargetAvgRetailPriceLow = AVG(LinePlanBusPnCh1), 
	@PL2_TargetAvgRetailPriceLow = AVG(LinePlanBusPnCh2), 
	@PL3_TargetAvgRetailPriceLow = AVG(LinePlanBusPnCh3), 
	@PL4_TargetAvgRetailPriceLow = AVG(LinePlanBusPnCh4), 
	@Cu1_TargetAvgRetailPriceLow = AVG(LinePlanBusCuCh1), 
	@Cu2_TargetAvgRetailPriceLow = AVG(LinePlanBusCuCh2), 
	@Cu3_TargetAvgRetailPriceLow = AVG(LinePlanBusCuCh3), 
	@Cu4_TargetAvgRetailPriceLow = AVG(LinePlanBusCuCh4) 
FROM pLinePlanBusiness
WHERE (LinePlanFinancialID = '00000000-0000-0000-0000-000000000020') AND 
	LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND
	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND
	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3

INSERT INTO #tmpLinePlanBusiness(
	LinePlanID, 
	LinePlanFinancialID, 
	LinePlanFinancialText,
	LinePlanBusLYCh1,
	LinePlanBusLYCh2,
	LinePlanBusLYCh3,
	LinePlanBusLYCh4,
	LinePlanBusPnCh1,
	LinePlanBusPnCh2,
	LinePlanBusPnCh3,
	LinePlanBusPnCh4,
	LinePlanBusCuCh1,
	LinePlanBusCuCh2,
	LinePlanBusCuCh3,
	LinePlanBusCuCh4,
	LinePlanAttributeItemID1,
	LinePlanFinancialSort)
VALUES (  
	@LinePlanID, 
	'00000000-0000-0000-0000-000000000020',     
	@TargetAvgRetailPriceLowText, 
	@LY1_TargetAvgRetailPriceLow, 
	@LY2_TargetAvgRetailPriceLow, 
	@LY3_TargetAvgRetailPriceLow, 
	@LY4_TargetAvgRetailPriceLow, 
	@PL1_TargetAvgRetailPriceLow, 
	@PL2_TargetAvgRetailPriceLow, 
	@PL3_TargetAvgRetailPriceLow, 
	@PL4_TargetAvgRetailPriceLow, 
	@Cu1_TargetAvgRetailPriceLow, 
	@Cu2_TargetAvgRetailPriceLow, 
	@Cu3_TargetAvgRetailPriceLow, 
	@Cu4_TargetAvgRetailPriceLow, 
	@LinePlanAttributeItemID1,
	'0007')

--- # of Style low
SELECT 
	@NoOfStyleMedText = LinePlanFinancialText,
	@LY1_NoOfStyleMed = SUM(LinePlanBusLYCh1), 
	@LY2_NoOfStyleMed = SUM(LinePlanBusLYCh2),
	@LY3_NoOfStyleMed = SUM(LinePlanBusLYCh3), 
	@LY4_NoOfStyleMed = SUM(LinePlanBusLYCh4), 
	@PL1_NoOfStyleMed = SUM(LinePlanBusPnCh1), 
	@PL2_NoOfStyleMed = SUM(LinePlanBusPnCh2), 
	@PL3_NoOfStyleMed = SUM(LinePlanBusPnCh3), 
	@PL4_NoOfStyleMed = SUM(LinePlanBusPnCh4), 
	@Cu1_NoOfStyleMed = SUM(LinePlanBusCuCh1), 
	@Cu2_NoOfStyleMed = SUM(LinePlanBusCuCh2), 
	@Cu3_NoOfStyleMed = SUM(LinePlanBusCuCh3), 
	@Cu4_NoOfStyleMed = SUM(LinePlanBusCuCh4) 
FROM pLinePlanBusiness
WHERE (LinePlanFinancialID = '00000000-0000-0000-0000-000000000021') AND 
	LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND
	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND
	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3

INSERT INTO #tmpLinePlanBusiness(
	LinePlanID, 
	LinePlanFinancialID, 
	LinePlanFinancialText,
	LinePlanBusLYCh1,
	LinePlanBusLYCh2,
	LinePlanBusLYCh3,
	LinePlanBusLYCh4,
	LinePlanBusPnCh1,
	LinePlanBusPnCh2,
	LinePlanBusPnCh3,
	LinePlanBusPnCh4,
	LinePlanBusCuCh1,
	LinePlanBusCuCh2,
	LinePlanBusCuCh3,
	LinePlanBusCuCh4,
	LinePlanAttributeItemID1,
	LinePlanFinancialSort)
VALUES (    
	@LinePlanID, 
	'00000000-0000-0000-0000-000000000021',     
	@NoOfStyleMedText, 
	@LY1_NoOfStyleMed, 
	@LY2_NoOfStyleMed, 
	@LY3_NoOfStyleMed, 
	@LY4_NoOfStyleMed, 
	@PL1_NoOfStyleMed, 
	@PL2_NoOfStyleMed, 
	@PL3_NoOfStyleMed, 
	@PL4_NoOfStyleMed, 
	@Cu1_NoOfStyleMed, 
	@Cu2_NoOfStyleMed, 
	@Cu3_NoOfStyleMed, 
	@Cu4_NoOfStyleMed, 
	@LinePlanAttributeItemID1,
	'0008')

--- Target Avg Retail Price (Med)
SELECT 
	@TargetAvgRetailPriceMedText = LinePlanFinancialText,
	@LY1_TargetAvgRetailPriceMed = AVG(LinePlanBusLYCh1), 
	@LY2_TargetAvgRetailPriceMed = AVG(LinePlanBusLYCh2),
	@LY3_TargetAvgRetailPriceMed = AVG(LinePlanBusLYCh3), 
	@LY4_TargetAvgRetailPriceMed = AVG(LinePlanBusLYCh4), 
	@PL1_TargetAvgRetailPriceMed = AVG(LinePlanBusPnCh1), 
	@PL2_TargetAvgRetailPriceMed = AVG(LinePlanBusPnCh2), 
	@PL3_TargetAvgRetailPriceMed = AVG(LinePlanBusPnCh3), 
	@PL4_TargetAvgRetailPriceMed = AVG(LinePlanBusPnCh4), 
	@Cu1_TargetAvgRetailPriceMed = AVG(LinePlanBusCuCh1), 
	@Cu2_TargetAvgRetailPriceMed = AVG(LinePlanBusCuCh2), 
	@Cu3_TargetAvgRetailPriceMed = AVG(LinePlanBusCuCh3), 
	@Cu4_TargetAvgRetailPriceMed = AVG(LinePlanBusCuCh4) 
FROM pLinePlanBusiness
WHERE (LinePlanFinancialID = '00000000-0000-0000-0000-000000000022') AND 
	LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND
	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND
	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3

INSERT INTO #tmpLinePlanBusiness(
	LinePlanID, 
	LinePlanFinancialID, 
	LinePlanFinancialText,
	LinePlanBusLYCh1,
	LinePlanBusLYCh2,
	LinePlanBusLYCh3,
	LinePlanBusLYCh4,
	LinePlanBusPnCh1,
	LinePlanBusPnCh2,
	LinePlanBusPnCh3,
	LinePlanBusPnCh4,
	LinePlanBusCuCh1,
	LinePlanBusCuCh2,
	LinePlanBusCuCh3,
	LinePlanBusCuCh4,
	LinePlanAttributeItemID1,
	LinePlanFinancialSort)
VALUES (  
	@LinePlanID, 
	'00000000-0000-0000-0000-000000000022',     
	@TargetAvgRetailPriceMedText, 
	@LY1_TargetAvgRetailPriceMed, 
	@LY2_TargetAvgRetailPriceMed, 
	@LY3_TargetAvgRetailPriceMed, 
	@LY4_TargetAvgRetailPriceMed, 
	@PL1_TargetAvgRetailPriceMed, 
	@PL2_TargetAvgRetailPriceMed, 
	@PL3_TargetAvgRetailPriceMed, 
	@PL4_TargetAvgRetailPriceMed, 
	@Cu1_TargetAvgRetailPriceMed, 
	@Cu2_TargetAvgRetailPriceMed, 
	@Cu3_TargetAvgRetailPriceMed, 
	@Cu4_TargetAvgRetailPriceMed, 
	@LinePlanAttributeItemID1,
	'0009')

--- # of Style Med
SELECT 
	@NoOfStyleMedText = LinePlanFinancialText,
	@LY1_NoOfStyleMed = SUM(LinePlanBusLYCh1), 
	@LY2_NoOfStyleMed = SUM(LinePlanBusLYCh2),
	@LY3_NoOfStyleMed = SUM(LinePlanBusLYCh3), 
	@LY4_NoOfStyleMed = SUM(LinePlanBusLYCh4), 
	@PL1_NoOfStyleMed = SUM(LinePlanBusPnCh1), 
	@PL2_NoOfStyleMed = SUM(LinePlanBusPnCh2), 
	@PL3_NoOfStyleMed = SUM(LinePlanBusPnCh3), 
	@PL4_NoOfStyleMed = SUM(LinePlanBusPnCh4), 
	@Cu1_NoOfStyleMed = SUM(LinePlanBusCuCh1), 
	@Cu2_NoOfStyleMed = SUM(LinePlanBusCuCh2), 
	@Cu3_NoOfStyleMed = SUM(LinePlanBusCuCh3), 
	@Cu4_NoOfStyleMed = SUM(LinePlanBusCuCh4) 
FROM pLinePlanBusiness
WHERE (LinePlanFinancialID = '00000000-0000-0000-0000-000000000023') AND 
	LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND
	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND
	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3

INSERT INTO #tmpLinePlanBusiness(
	LinePlanID, 
	LinePlanFinancialID, 
	LinePlanFinancialText,
	LinePlanBusLYCh1,
	LinePlanBusLYCh2,
	LinePlanBusLYCh3,
	LinePlanBusLYCh4,
	LinePlanBusPnCh1,
	LinePlanBusPnCh2,
	LinePlanBusPnCh3,
	LinePlanBusPnCh4,
	LinePlanBusCuCh1,
	LinePlanBusCuCh2,
	LinePlanBusCuCh3,
	LinePlanBusCuCh4,
	LinePlanAttributeItemID1,
	LinePlanFinancialSort)
VALUES (   
	@LinePlanID, 
	'00000000-0000-0000-0000-000000000023',     
	@NoOfStyleMedText, 
	@LY1_NoOfStyleMed, 
	@LY2_NoOfStyleMed, 
	@LY3_NoOfStyleMed, 
	@LY4_NoOfStyleMed, 
	@PL1_NoOfStyleMed, 
	@PL2_NoOfStyleMed, 
	@PL3_NoOfStyleMed, 
	@PL4_NoOfStyleMed, 
	@Cu1_NoOfStyleMed, 
	@Cu2_NoOfStyleMed, 
	@Cu3_NoOfStyleMed, 
	@Cu4_NoOfStyleMed, 
	@LinePlanAttributeItemID1,
	'0010')


--- Target Avg Retail Price (Hi)
SELECT 
	@TargetAvgRetailPriceHighText = LinePlanFinancialText,
	@LY1_TargetAvgRetailPriceHigh = AVG(LinePlanBusLYCh1), 
	@LY2_TargetAvgRetailPriceHigh = AVG(LinePlanBusLYCh2),
	@LY3_TargetAvgRetailPriceHigh = AVG(LinePlanBusLYCh3), 
	@LY4_TargetAvgRetailPriceHigh = AVG(LinePlanBusLYCh4), 
	@PL1_TargetAvgRetailPriceHigh = AVG(LinePlanBusPnCh1), 
	@PL2_TargetAvgRetailPriceHigh = AVG(LinePlanBusPnCh2), 
	@PL3_TargetAvgRetailPriceHigh = AVG(LinePlanBusPnCh3), 
	@PL4_TargetAvgRetailPriceHigh = AVG(LinePlanBusPnCh4), 
	@Cu1_TargetAvgRetailPriceHigh = AVG(LinePlanBusCuCh1), 
	@Cu2_TargetAvgRetailPriceHigh = AVG(LinePlanBusCuCh2), 
	@Cu3_TargetAvgRetailPriceHigh = AVG(LinePlanBusCuCh3), 
	@Cu4_TargetAvgRetailPriceHigh = AVG(LinePlanBusCuCh4) 
FROM pLinePlanBusiness
WHERE (LinePlanFinancialID = '00000000-0000-0000-0000-000000000024') AND 
	LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND
	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND
	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3

INSERT INTO #tmpLinePlanBusiness(
	LinePlanID, 
	LinePlanFinancialID, 
	LinePlanFinancialText,
	LinePlanBusLYCh1,
	LinePlanBusLYCh2,
	LinePlanBusLYCh3,
	LinePlanBusLYCh4,
	LinePlanBusPnCh1,
	LinePlanBusPnCh2,
	LinePlanBusPnCh3,
	LinePlanBusPnCh4,
	LinePlanBusCuCh1,
	LinePlanBusCuCh2,
	LinePlanBusCuCh3,
	LinePlanBusCuCh4,
	LinePlanAttributeItemID1,
	LinePlanFinancialSort)
VALUES (  
	@LinePlanID, 
	'00000000-0000-0000-0000-000000000024',     
	@TargetAvgRetailPriceHighText, 
	@LY1_TargetAvgRetailPriceHigh, 
	@LY2_TargetAvgRetailPriceHigh, 
	@LY3_TargetAvgRetailPriceHigh, 
	@LY4_TargetAvgRetailPriceHigh, 
	@PL1_TargetAvgRetailPriceHigh, 
	@PL2_TargetAvgRetailPriceHigh, 
	@PL3_TargetAvgRetailPriceHigh, 
	@PL4_TargetAvgRetailPriceHigh, 
	@Cu1_TargetAvgRetailPriceHigh, 
	@Cu2_TargetAvgRetailPriceHigh, 
	@Cu3_TargetAvgRetailPriceHigh, 
	@Cu4_TargetAvgRetailPriceHigh, 
	@LinePlanAttributeItemID1,
	'0011')

--- # of Style Hi
SELECT 
	@NoOfStyleHighText = LinePlanFinancialText,
	@LY1_NoOfStyleHigh = SUM(LinePlanBusLYCh1), 
	@LY2_NoOfStyleHigh = SUM(LinePlanBusLYCh2),
	@LY3_NoOfStyleHigh = SUM(LinePlanBusLYCh3), 
	@LY4_NoOfStyleHigh = SUM(LinePlanBusLYCh4), 
	@PL1_NoOfStyleHigh = SUM(LinePlanBusPnCh1), 
	@PL2_NoOfStyleHigh = SUM(LinePlanBusPnCh2), 
	@PL3_NoOfStyleHigh = SUM(LinePlanBusPnCh3), 
	@PL4_NoOfStyleHigh = SUM(LinePlanBusPnCh4), 
	@Cu1_NoOfStyleHigh = SUM(LinePlanBusCuCh1), 
	@Cu2_NoOfStyleHigh = SUM(LinePlanBusCuCh2), 
	@Cu3_NoOfStyleHigh = SUM(LinePlanBusCuCh3), 
	@Cu4_NoOfStyleHigh = SUM(LinePlanBusCuCh4) 
FROM pLinePlanBusiness
WHERE (LinePlanFinancialID = '00000000-0000-0000-0000-000000000025') AND 
	LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND
	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND
	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3


INSERT INTO #tmpLinePlanBusiness(
	LinePlanID, 
	LinePlanFinancialID, 
	LinePlanFinancialText,
	LinePlanBusLYCh1,
	LinePlanBusLYCh2,
	LinePlanBusLYCh3,
	LinePlanBusLYCh4,
	LinePlanBusPnCh1,
	LinePlanBusPnCh2,
	LinePlanBusPnCh3,
	LinePlanBusPnCh4,
	LinePlanBusCuCh1,
	LinePlanBusCuCh2,
	LinePlanBusCuCh3,
	LinePlanBusCuCh4,
	LinePlanAttributeItemID1,
	LinePlanFinancialSort)
VALUES (   
	@LinePlanID, 
	'00000000-0000-0000-0000-000000000025',     
	@NoOfStyleHighText, 
	@LY1_NoOfStyleHigh, 
	@LY2_NoOfStyleHigh, 
	@LY3_NoOfStyleHigh, 
	@LY4_NoOfStyleHigh, 
	@PL1_NoOfStyleHigh, 
	@PL2_NoOfStyleHigh, 
	@PL3_NoOfStyleHigh, 
	@PL4_NoOfStyleHigh, 
	@Cu1_NoOfStyleHigh, 
	@Cu2_NoOfStyleHigh, 
	@Cu3_NoOfStyleHigh, 
	@Cu4_NoOfStyleHigh, 
	@LinePlanAttributeItemID1,
	'0012')


--- Target Avg Whs Price 
--- Target Avg Retail Price (Med) / Markup Factor
--- @LY1_TargetAvgRetailPriceMed / @LY1_NoOfStyleMed

	SET @LY1_TargetAvgWhsPrice = CASE WHEN @LY1_MarkupFactor = 0 THEN 0 ELSE @LY1_TargetAvgRetailPriceMed / @LY1_MarkupFactor END  
	SET @LY2_TargetAvgWhsPrice = CASE WHEN @LY2_MarkupFactor = 0 THEN 0 ELSE @LY2_TargetAvgRetailPriceMed / @LY2_MarkupFactor END 
	SET @LY3_TargetAvgWhsPrice = CASE WHEN @LY3_MarkupFactor = 0 THEN 0 ELSE @LY3_TargetAvgRetailPriceMed / @LY3_MarkupFactor END
	SET @LY4_TargetAvgWhsPrice = CASE WHEN @LY4_MarkupFactor = 0 THEN 0 ELSE @LY4_TargetAvgRetailPriceMed / @LY4_MarkupFactor END 
	SET @PL1_TargetAvgWhsPrice = CASE WHEN @PL1_MarkupFactor = 0 THEN 0 ELSE @PL1_TargetAvgRetailPriceMed / @PL1_MarkupFactor END
	SET @PL2_TargetAvgWhsPrice = CASE WHEN @PL2_MarkupFactor = 0 THEN 0 ELSE @PL2_TargetAvgRetailPriceMed / @PL2_MarkupFactor END
	SET @PL3_TargetAvgWhsPrice = CASE WHEN @PL3_MarkupFactor = 0 THEN 0 ELSE @PL3_TargetAvgRetailPriceMed / @PL3_MarkupFactor END
	SET @PL4_TargetAvgWhsPrice = CASE WHEN @PL4_MarkupFactor = 0 THEN 0 ELSE @PL4_TargetAvgRetailPriceMed / @PL4_MarkupFactor END
	SET @Cu1_TargetAvgWhsPrice = CASE WHEN @Cu1_MarkupFactor = 0 THEN 0 ELSE @Cu1_TargetAvgRetailPriceMed / @Cu1_MarkupFactor END
	SET @Cu2_TargetAvgWhsPrice = CASE WHEN @Cu2_MarkupFactor = 0 THEN 0 ELSE @Cu2_TargetAvgRetailPriceMed / @Cu2_MarkupFactor END
	SET @Cu3_TargetAvgWhsPrice = CASE WHEN @Cu3_MarkupFactor = 0 THEN 0 ELSE @Cu3_TargetAvgRetailPriceMed / @Cu3_MarkupFactor END
	SET @Cu4_TargetAvgWhsPrice = CASE WHEN @Cu4_MarkupFactor = 0 THEN 0 ELSE @Cu4_TargetAvgRetailPriceMed / @Cu4_MarkupFactor END 

INSERT INTO #tmpLinePlanBusiness(
	LinePlanID, 
	LinePlanFinancialID, 
	LinePlanFinancialText,
	LinePlanBusLYCh1,
	LinePlanBusLYCh2,
	LinePlanBusLYCh3,
	LinePlanBusLYCh4,
	LinePlanBusPnCh1,
	LinePlanBusPnCh2,
	LinePlanBusPnCh3,
	LinePlanBusPnCh4,
	LinePlanBusCuCh1,
	LinePlanBusCuCh2,
	LinePlanBusCuCh3,
	LinePlanBusCuCh4,
	LinePlanAttributeItemID1,
	LinePlanFinancialSort)
VALUES (    
	@LinePlanID, 
	'00000000-0000-0000-0000-000000000009',     
	'Target Avg Whs Price ', 
	@LY1_TargetAvgWhsPrice, 
	@LY2_TargetAvgWhsPrice, 
	@LY3_TargetAvgWhsPrice, 
	@LY4_TargetAvgWhsPrice, 
	@PL1_TargetAvgWhsPrice, 
	@PL2_TargetAvgWhsPrice, 
	@PL3_TargetAvgWhsPrice, 
	@PL4_TargetAvgWhsPrice, 
	@Cu1_TargetAvgWhsPrice, 
	@Cu2_TargetAvgWhsPrice, 
	@Cu3_TargetAvgWhsPrice, 
	@Cu4_TargetAvgWhsPrice, 
	@LinePlanAttributeItemID1,
	'0013')

---Average Target FOB

	SET @LY1_AvgTargetFOB = (@LY1_TargetAvgRetailPriceMed - (@LY1_TargetAvgRetailPriceMed * @LY1_InitialGrossMarginRtl)) 
	SET @LY2_AvgTargetFOB = (@LY2_TargetAvgRetailPriceMed - (@LY2_TargetAvgRetailPriceMed * @LY2_InitialGrossMarginRtl)) 
	SET @LY3_AvgTargetFOB = (@LY3_TargetAvgRetailPriceMed - (@LY3_TargetAvgRetailPriceMed * @LY3_InitialGrossMarginRtl))  
	SET @LY4_AvgTargetFOB = (@LY4_TargetAvgRetailPriceMed - (@LY4_TargetAvgRetailPriceMed * @LY4_InitialGrossMarginRtl)) 
	SET @PL1_AvgTargetFOB = (@PL1_TargetAvgRetailPriceMed - (@PL1_TargetAvgRetailPriceMed * @PL1_InitialGrossMarginRtl)) 
	SET @PL2_AvgTargetFOB = (@PL2_TargetAvgRetailPriceMed - (@PL2_TargetAvgRetailPriceMed * @PL2_InitialGrossMarginRtl)) 
	SET @PL3_AvgTargetFOB = (@PL3_TargetAvgRetailPriceMed - (@PL3_TargetAvgRetailPriceMed * @PL3_InitialGrossMarginRtl)) 
	SET @PL4_AvgTargetFOB = (@PL4_TargetAvgRetailPriceMed - (@PL4_TargetAvgRetailPriceMed * @PL4_InitialGrossMarginRtl)) 
	SET @Cu1_AvgTargetFOB = (@Cu1_TargetAvgRetailPriceMed - (@Cu1_TargetAvgRetailPriceMed * @Cu1_InitialGrossMarginRtl)) 
	SET @Cu2_AvgTargetFOB = (@Cu2_TargetAvgRetailPriceMed - (@Cu2_TargetAvgRetailPriceMed * @Cu2_InitialGrossMarginRtl)) 
	SET @Cu3_AvgTargetFOB = (@Cu3_TargetAvgRetailPriceMed - (@Cu3_TargetAvgRetailPriceMed * @Cu3_InitialGrossMarginRtl)) 
	SET @Cu4_AvgTargetFOB = (@Cu4_TargetAvgRetailPriceMed - (@Cu4_TargetAvgRetailPriceMed * @Cu4_InitialGrossMarginRtl))

INSERT INTO #tmpLinePlanBusiness(
	LinePlanID, 
	LinePlanFinancialID, 
	LinePlanFinancialText,
	LinePlanBusLYCh1,
	LinePlanBusLYCh2,
	LinePlanBusLYCh3,
	LinePlanBusLYCh4,
	LinePlanBusPnCh1,
	LinePlanBusPnCh2,
	LinePlanBusPnCh3,
	LinePlanBusPnCh4,
	LinePlanBusCuCh1,
	LinePlanBusCuCh2,
	LinePlanBusCuCh3,
	LinePlanBusCuCh4,
	LinePlanAttributeItemID1,
	LinePlanFinancialSort)
VALUES (  
	@LinePlanID, 
	'00000000-0000-0000-0000-000000000006',     
	'Average Target FOB', 
	ISNULL(@LY1_AvgTargetFOB,0), 
	ISNULL(@LY2_AvgTargetFOB,0), 
	ISNULL(@LY3_AvgTargetFOB,0), 
	ISNULL(@LY4_AvgTargetFOB,0), 
	ISNULL(@PL1_AvgTargetFOB,0), 
	ISNULL(@PL2_AvgTargetFOB,0), 
	ISNULL(@PL3_AvgTargetFOB,0), 
	ISNULL(@PL4_AvgTargetFOB,0), 
	ISNULL(@Cu1_AvgTargetFOB,0), 
	ISNULL(@Cu2_AvgTargetFOB,0), 
	ISNULL(@Cu3_AvgTargetFOB,0), 
	ISNULL(@Cu4_AvgTargetFOB,0), 
	@LinePlanAttributeItemID1,
	'0014')


---Sales Unit
SELECT 
	@SalesUnitText = LinePlanFinancialText,
	@LY1_SalesUnit = SUM(LinePlanBusLYCh1), 
	@LY2_SalesUnit = SUM(LinePlanBusLYCh2),
	@LY3_SalesUnit = SUM(LinePlanBusLYCh3), 
	@LY4_SalesUnit = SUM(LinePlanBusLYCh4), 
	@PL1_SalesUnit = SUM(LinePlanBusPnCh1), 
	@PL2_SalesUnit = SUM(LinePlanBusPnCh2), 
	@PL3_SalesUnit = SUM(LinePlanBusPnCh3), 
	@PL4_SalesUnit = SUM(LinePlanBusPnCh4), 
	@Cu1_SalesUnit = SUM(LinePlanBusCuCh1), 
	@Cu2_SalesUnit = SUM(LinePlanBusCuCh2), 
	@Cu3_SalesUnit = SUM(LinePlanBusCuCh3), 
	@Cu4_SalesUnit = SUM(LinePlanBusCuCh4) 
FROM pLinePlanBusiness
WHERE     (LinePlanFinancialID = '00000000-0000-0000-0000-000000000008') AND 
	LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND
	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND
	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3

INSERT INTO #tmpLinePlanBusiness(
	LinePlanID, 
	LinePlanFinancialID, 
	LinePlanFinancialText,
	LinePlanBusLYCh1,
	LinePlanBusLYCh2,
	LinePlanBusLYCh3,
	LinePlanBusLYCh4,
	LinePlanBusPnCh1,
	LinePlanBusPnCh2,
	LinePlanBusPnCh3,
	LinePlanBusPnCh4,
	LinePlanBusCuCh1,
	LinePlanBusCuCh2,
	LinePlanBusCuCh3,
	LinePlanBusCuCh4,
	LinePlanAttributeItemID1,
	LinePlanFinancialSort)
VALUES (    
	@LinePlanID, 
	'00000000-0000-0000-0000-000000000008',     
	@SalesUnitText, 
	@LY1_SalesUnit, 
	@LY2_SalesUnit, 
	@LY3_SalesUnit, 
	@LY4_SalesUnit, 
	@PL1_SalesUnit, 
	@PL2_SalesUnit, 
	@PL3_SalesUnit, 
	@PL4_SalesUnit, 
	@Cu1_SalesUnit, 
	@Cu2_SalesUnit, 
	@Cu3_SalesUnit, 
	@Cu4_SalesUnit, 
	@LinePlanAttributeItemID1,
	'0015')

---Projected Wholesale
SELECT 
	@ProjectedWhsText = LinePlanFinancialText,
	@LY1_ProjectedWhs = SUM(LinePlanBusLYCh1), 
	@LY2_ProjectedWhs = SUM(LinePlanBusLYCh2),
	@LY3_ProjectedWhs = SUM(LinePlanBusLYCh3), 
	@LY4_ProjectedWhs = SUM(LinePlanBusLYCh4), 
	@PL1_ProjectedWhs = SUM(LinePlanBusPnCh1), 
	@PL2_ProjectedWhs = SUM(LinePlanBusPnCh2), 
	@PL3_ProjectedWhs = SUM(LinePlanBusPnCh3), 
	@PL4_ProjectedWhs = SUM(LinePlanBusPnCh4), 
	@Cu1_ProjectedWhs = SUM(LinePlanBusCuCh1), 
	@Cu2_ProjectedWhs = SUM(LinePlanBusCuCh2), 
	@Cu3_ProjectedWhs = SUM(LinePlanBusCuCh3), 
	@Cu4_ProjectedWhs = SUM(LinePlanBusCuCh4) 
FROM pLinePlanBusiness
WHERE     (LinePlanFinancialID = '00000000-0000-0000-0000-000000000007') AND 
	LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND
	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND
	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3

INSERT INTO #tmpLinePlanBusiness(
	LinePlanID, 
	LinePlanFinancialID, 
	LinePlanFinancialText,
	LinePlanBusLYCh1,
	LinePlanBusLYCh2,
	LinePlanBusLYCh3,
	LinePlanBusLYCh4,
	LinePlanBusPnCh1,
	LinePlanBusPnCh2,
	LinePlanBusPnCh3,
	LinePlanBusPnCh4,
	LinePlanBusCuCh1,
	LinePlanBusCuCh2,
	LinePlanBusCuCh3,
	LinePlanBusCuCh4,
	LinePlanAttributeItemID1,
	LinePlanFinancialSort)
VALUES (    
	@LinePlanID, 
	'00000000-0000-0000-0000-000000000007',     
	@ProjectedWhsText, 
	@LY1_ProjectedWhs, 
	@LY2_ProjectedWhs, 
	@LY3_ProjectedWhs, 
	@LY4_ProjectedWhs, 
	@PL1_ProjectedWhs, 
	@PL2_ProjectedWhs, 
	@PL3_ProjectedWhs, 
	@PL4_ProjectedWhs, 
	@Cu1_ProjectedWhs, 
	@Cu2_ProjectedWhs, 
	@Cu3_ProjectedWhs, 
	@Cu4_ProjectedWhs, 
	@LinePlanAttributeItemID1,
	'0016')


--Calculate Initial Gross Margin Wholesale %

	SET @LY1_InitialGrossMarginWhs = CASE WHEN @LY1_TargetAvgWhsPrice = 0 THEN 0 ELSE (@LY1_TargetAvgWhsPrice - @LY1_AvgTargetFOB) / @LY1_TargetAvgWhsPrice END 
	SET @LY2_InitialGrossMarginWhs = CASE WHEN @LY2_TargetAvgWhsPrice = 0 THEN 0 ELSE (@LY2_TargetAvgWhsPrice - @LY2_AvgTargetFOB) / @LY2_TargetAvgWhsPrice END 
	SET @LY3_InitialGrossMarginWhs = CASE WHEN @LY3_TargetAvgWhsPrice = 0 THEN 0 ELSE (@LY3_TargetAvgWhsPrice - @LY3_AvgTargetFOB) / @LY3_TargetAvgWhsPrice END 
	SET @LY4_InitialGrossMarginWhs = CASE WHEN @LY4_TargetAvgWhsPrice = 0 THEN 0 ELSE (@LY4_TargetAvgWhsPrice - @LY4_AvgTargetFOB) / @LY4_TargetAvgWhsPrice END 
	SET @PL1_InitialGrossMarginWhs = CASE WHEN @PL1_TargetAvgWhsPrice = 0 THEN 0 ELSE (@PL1_TargetAvgWhsPrice - @PL1_AvgTargetFOB) / @PL1_TargetAvgWhsPrice END 
	SET @PL2_InitialGrossMarginWhs = CASE WHEN @PL2_TargetAvgWhsPrice = 0 THEN 0 ELSE (@PL2_TargetAvgWhsPrice - @PL2_AvgTargetFOB) / @PL2_TargetAvgWhsPrice END 
	SET @PL3_InitialGrossMarginWhs = CASE WHEN @PL3_TargetAvgWhsPrice = 0 THEN 0 ELSE (@PL3_TargetAvgWhsPrice - @PL3_AvgTargetFOB) / @PL3_TargetAvgWhsPrice END  
	SET @PL4_InitialGrossMarginWhs = CASE WHEN @PL4_TargetAvgWhsPrice = 0 THEN 0 ELSE (@PL4_TargetAvgWhsPrice - @PL4_AvgTargetFOB) / @PL4_TargetAvgWhsPrice END 
	SET @Cu1_InitialGrossMarginWhs = CASE WHEN @Cu1_TargetAvgWhsPrice = 0 THEN 0 ELSE (@Cu1_TargetAvgWhsPrice - @Cu1_AvgTargetFOB) / @Cu1_TargetAvgWhsPrice END 
	SET @Cu2_InitialGrossMarginWhs = CASE WHEN @Cu2_TargetAvgWhsPrice = 0 THEN 0 ELSE (@Cu2_TargetAvgWhsPrice - @Cu2_AvgTargetFOB) / @Cu2_TargetAvgWhsPrice END  
	SET @Cu3_InitialGrossMarginWhs = CASE WHEN @Cu3_TargetAvgWhsPrice = 0 THEN 0 ELSE (@Cu3_TargetAvgWhsPrice - @Cu3_AvgTargetFOB) / @Cu3_TargetAvgWhsPrice END 
	SET @Cu4_InitialGrossMarginWhs = CASE WHEN @Cu4_TargetAvgWhsPrice = 0 THEN 0 ELSE (@Cu4_TargetAvgWhsPrice - @Cu4_AvgTargetFOB) / @Cu4_TargetAvgWhsPrice END 

INSERT INTO #tmpLinePlanBusiness(
	LinePlanID, 
	LinePlanFinancialID, 
	LinePlanFinancialText,
	LinePlanBusLYCh1,
	LinePlanBusLYCh2,
	LinePlanBusLYCh3,
	LinePlanBusLYCh4,
	LinePlanBusPnCh1,
	LinePlanBusPnCh2,
	LinePlanBusPnCh3,
	LinePlanBusPnCh4,
	LinePlanBusCuCh1,
	LinePlanBusCuCh2,
	LinePlanBusCuCh3,
	LinePlanBusCuCh4,
	LinePlanAttributeItemID1,
	LinePlanFinancialSort)
VALUES (     
	@LinePlanID, 
	'00000000-0000-0000-0000-000000000013',     
	'Initial Gross Margin Wholesale %', 
	@LY1_ProjectedWhs, 
	@LY2_ProjectedWhs, 
	@LY3_ProjectedWhs, 
	@LY4_ProjectedWhs, 
	@PL1_ProjectedWhs, 
	@PL2_ProjectedWhs, 
	@PL3_ProjectedWhs, 
	@PL4_ProjectedWhs, 
	@Cu1_ProjectedWhs, 
	@Cu2_ProjectedWhs, 
	@Cu3_ProjectedWhs, 
	@Cu4_ProjectedWhs, 
	@LinePlanAttributeItemID1,
	'0018')


----Weight Gross Margin Retail
	SET @LY1_WeightGrossMarginWhs = CASE WHEN @LY1_SalesUnit = 0 OR @LY1_TargetAvgRetailPriceMed = 0 THEN 0 ELSE ((@LY1_SalesUnit * @LY1_TargetAvgRetailPriceMed) - (@LY1_AvgTargetFOB * @LY1_SalesUnit)) / (@LY1_SalesUnit * @LY1_TargetAvgRetailPriceMed) END 
	SET @LY2_WeightGrossMarginWhs = CASE WHEN @LY2_SalesUnit = 0 OR @LY2_TargetAvgRetailPriceMed = 0 THEN 0 ELSE ((@LY2_SalesUnit * @LY2_TargetAvgRetailPriceMed) - (@LY2_AvgTargetFOB * @LY2_SalesUnit)) / (@LY2_SalesUnit * @LY2_TargetAvgRetailPriceMed) END 
	SET @LY3_WeightGrossMarginWhs = CASE WHEN @LY3_SalesUnit = 0 OR @LY3_TargetAvgRetailPriceMed = 0 THEN 0 ELSE ((@LY3_SalesUnit * @LY3_TargetAvgRetailPriceMed) - (@LY3_AvgTargetFOB * @LY3_SalesUnit)) / (@LY3_SalesUnit * @LY3_TargetAvgRetailPriceMed) END 
	SET @LY4_WeightGrossMarginWhs = CASE WHEN @LY4_SalesUnit = 0 OR @LY4_TargetAvgRetailPriceMed = 0 THEN 0 ELSE ((@LY4_SalesUnit * @LY4_TargetAvgRetailPriceMed) - (@LY4_AvgTargetFOB * @LY4_SalesUnit)) / (@LY4_SalesUnit * @LY4_TargetAvgRetailPriceMed) END 
	SET @PL1_WeightGrossMarginWhs = CASE WHEN @PL1_SalesUnit = 0 OR @PL1_TargetAvgRetailPriceMed = 0 THEN 0 ELSE ((@PL1_SalesUnit * @PL1_TargetAvgRetailPriceMed) - (@PL1_AvgTargetFOB * @PL1_SalesUnit)) / (@PL1_SalesUnit * @PL1_TargetAvgRetailPriceMed) END 
	SET @PL2_WeightGrossMarginWhs = CASE WHEN @PL2_SalesUnit = 0 OR @PL2_TargetAvgRetailPriceMed = 0 THEN 0 ELSE ((@PL2_SalesUnit * @PL2_TargetAvgRetailPriceMed) - (@PL2_AvgTargetFOB * @PL2_SalesUnit)) / (@PL2_SalesUnit * @PL2_TargetAvgRetailPriceMed) END 
	SET @PL3_WeightGrossMarginWhs = CASE WHEN @PL3_SalesUnit = 0 OR @PL3_TargetAvgRetailPriceMed = 0 THEN 0 ELSE ((@PL3_SalesUnit * @PL3_TargetAvgRetailPriceMed) - (@PL3_AvgTargetFOB * @PL3_SalesUnit)) / (@PL3_SalesUnit * @PL3_TargetAvgRetailPriceMed) END  
	SET @PL4_WeightGrossMarginWhs = CASE WHEN @PL4_SalesUnit = 0 OR @PL4_TargetAvgRetailPriceMed = 0 THEN 0 ELSE ((@PL4_SalesUnit * @PL4_TargetAvgRetailPriceMed) - (@PL4_AvgTargetFOB * @PL4_SalesUnit)) / (@PL4_SalesUnit * @PL4_TargetAvgRetailPriceMed) END 
	SET @Cu1_WeightGrossMarginWhs = CASE WHEN @Cu1_SalesUnit = 0 OR @Cu1_TargetAvgRetailPriceMed = 0 THEN 0 ELSE ((@Cu1_SalesUnit * @Cu1_TargetAvgRetailPriceMed) - (@Cu1_AvgTargetFOB * @Cu1_SalesUnit)) / (@Cu1_SalesUnit * @Cu1_TargetAvgRetailPriceMed) END 
	SET @Cu2_WeightGrossMarginWhs = CASE WHEN @Cu2_SalesUnit = 0 OR @Cu2_TargetAvgRetailPriceMed = 0 THEN 0 ELSE ((@Cu2_SalesUnit * @Cu2_TargetAvgRetailPriceMed) - (@Cu2_AvgTargetFOB * @Cu2_SalesUnit)) / (@Cu2_SalesUnit * @Cu2_TargetAvgRetailPriceMed) END  
	SET @Cu3_WeightGrossMarginWhs = CASE WHEN @Cu3_SalesUnit = 0 OR @Cu3_TargetAvgRetailPriceMed = 0 THEN 0 ELSE ((@Cu3_SalesUnit * @Cu3_TargetAvgRetailPriceMed) - (@Cu3_AvgTargetFOB * @Cu3_SalesUnit)) / (@Cu3_SalesUnit * @Cu3_TargetAvgRetailPriceMed) END 
	SET @Cu4_WeightGrossMarginWhs = CASE WHEN @Cu4_SalesUnit = 0 OR @Cu4_TargetAvgRetailPriceMed = 0 THEN 0 ELSE ((@Cu4_SalesUnit * @Cu4_TargetAvgRetailPriceMed) - (@Cu4_AvgTargetFOB * @Cu4_SalesUnit)) / (@Cu4_SalesUnit * @Cu4_TargetAvgRetailPriceMed) END 

INSERT INTO #tmpLinePlanBusiness(
	LinePlanID, 
	LinePlanFinancialID, 
	LinePlanFinancialText,
	LinePlanBusLYCh1,
	LinePlanBusLYCh2,
	LinePlanBusLYCh3,
	LinePlanBusLYCh4,
	LinePlanBusPnCh1,
	LinePlanBusPnCh2,
	LinePlanBusPnCh3,
	LinePlanBusPnCh4,
	LinePlanBusCuCh1,
	LinePlanBusCuCh2,
	LinePlanBusCuCh3,
	LinePlanBusCuCh4,
	LinePlanAttributeItemID1,
	LinePlanFinancialSort)
VALUES (   
	@LinePlanID, 
	'00000000-0000-0000-0000-000000000012',     
	'Weight Gross Margin Retail', 
	@LY1_ProjectedWhs, 
	@LY2_ProjectedWhs, 
	@LY3_ProjectedWhs, 
	@LY4_ProjectedWhs, 
	@PL1_ProjectedWhs, 
	@PL2_ProjectedWhs, 
	@PL3_ProjectedWhs, 
	@PL4_ProjectedWhs, 
	@Cu1_ProjectedWhs, 
	@Cu2_ProjectedWhs, 
	@Cu3_ProjectedWhs, 
	@Cu4_ProjectedWhs, 
	@LinePlanAttributeItemID1,
	'0019')

----Weight Gross Margin WHS
--- ProjectedWhs 
	SET @LY1_WeightGrossMarginWhs = CASE WHEN @LY1_ProjectedWhs = 0 THEN 0 ELSE ((@LY1_ProjectedWhs - (@LY1_SalesUnit * @LY1_AvgTargetFOB))) / @LY1_ProjectedWhs END 
	SET @LY2_WeightGrossMarginWhs = CASE WHEN @LY2_ProjectedWhs = 0 THEN 0 ELSE ((@LY2_ProjectedWhs - (@LY2_SalesUnit * @LY2_AvgTargetFOB))) / @LY2_ProjectedWhs END 
	SET @LY3_WeightGrossMarginWhs = CASE WHEN @LY3_ProjectedWhs = 0 THEN 0 ELSE ((@LY3_ProjectedWhs - (@LY3_SalesUnit * @LY3_AvgTargetFOB))) / @LY3_ProjectedWhs END 
	SET @LY4_WeightGrossMarginWhs = CASE WHEN @LY4_ProjectedWhs = 0 THEN 0 ELSE ((@LY4_ProjectedWhs - (@LY4_SalesUnit * @LY4_AvgTargetFOB))) / @LY4_ProjectedWhs END 
	SET @PL1_WeightGrossMarginWhs = CASE WHEN @PL1_ProjectedWhs = 0 THEN 0 ELSE ((@PL1_ProjectedWhs - (@PL1_SalesUnit * @PL1_AvgTargetFOB))) / @PL1_ProjectedWhs END 
	SET @PL2_WeightGrossMarginWhs = CASE WHEN @PL2_ProjectedWhs = 0 THEN 0 ELSE ((@PL2_ProjectedWhs - (@PL2_SalesUnit * @PL2_AvgTargetFOB))) / @PL2_ProjectedWhs END 
	SET @PL3_WeightGrossMarginWhs = CASE WHEN @PL3_ProjectedWhs = 0 THEN 0 ELSE ((@PL3_ProjectedWhs - (@PL3_SalesUnit * @PL3_AvgTargetFOB))) / @PL3_ProjectedWhs END  
	SET @PL4_WeightGrossMarginWhs = CASE WHEN @PL4_ProjectedWhs = 0 THEN 0 ELSE ((@PL4_ProjectedWhs - (@PL4_SalesUnit * @PL4_AvgTargetFOB))) / @PL4_ProjectedWhs END 
	SET @Cu1_WeightGrossMarginWhs = CASE WHEN @Cu1_ProjectedWhs = 0 THEN 0 ELSE ((@Cu1_ProjectedWhs - (@Cu1_SalesUnit * @Cu1_AvgTargetFOB))) / @Cu1_ProjectedWhs END 
	SET @Cu2_WeightGrossMarginWhs = CASE WHEN @Cu2_ProjectedWhs = 0 THEN 0 ELSE ((@Cu2_ProjectedWhs - (@Cu2_SalesUnit * @Cu2_AvgTargetFOB))) / @Cu2_ProjectedWhs END  
	SET @Cu3_WeightGrossMarginWhs = CASE WHEN @Cu3_ProjectedWhs = 0 THEN 0 ELSE ((@Cu3_ProjectedWhs - (@Cu3_SalesUnit * @Cu3_AvgTargetFOB))) / @Cu3_ProjectedWhs END 
	SET @Cu4_WeightGrossMarginWhs = CASE WHEN @Cu4_ProjectedWhs = 0 THEN 0 ELSE ((@Cu4_ProjectedWhs - (@Cu4_SalesUnit * @Cu4_AvgTargetFOB))) / @Cu4_ProjectedWhs END 

INSERT INTO #tmpLinePlanBusiness(
	LinePlanID, 
	LinePlanFinancialID, 
	LinePlanFinancialText,
	LinePlanBusLYCh1,
	LinePlanBusLYCh2,
	LinePlanBusLYCh3,
	LinePlanBusLYCh4,
	LinePlanBusPnCh1,
	LinePlanBusPnCh2,
	LinePlanBusPnCh3,
	LinePlanBusPnCh4,
	LinePlanBusCuCh1,
	LinePlanBusCuCh2,
	LinePlanBusCuCh3,
	LinePlanBusCuCh4,
	LinePlanAttributeItemID1,
	LinePlanFinancialSort)
VALUES (     
	@LinePlanID, 
	'00000000-0000-0000-0000-000000000011',     
	'Weight Gross Margin WHS', 
	@LY1_WeightGrossMarginWhs, 
	@LY2_WeightGrossMarginWhs, 
	@LY3_WeightGrossMarginWhs, 
	@LY4_WeightGrossMarginWhs, 
	@PL1_WeightGrossMarginWhs, 
	@PL2_WeightGrossMarginWhs, 
	@PL3_WeightGrossMarginWhs, 
	@PL4_WeightGrossMarginWhs, 
	@Cu1_WeightGrossMarginWhs, 
	@Cu2_WeightGrossMarginWhs, 
	@Cu3_WeightGrossMarginWhs, 
	@Cu4_WeightGrossMarginWhs, 
	@LinePlanAttributeItemID1,
	'0020')


--================================================================================================================
-- 'Weighted average retail price'

SELECT 
	@WeightedAverageRetailPriceText = LinePlanFinancialText,
	@LY1_WeightedAverageRetailPrice = AVG(LinePlanBusLYCh1),  @LY2_WeightedAverageRetailPrice = AVG(LinePlanBusLYCh2),
	@LY3_WeightedAverageRetailPrice = AVG(LinePlanBusLYCh3),  @LY4_WeightedAverageRetailPrice = AVG(LinePlanBusLYCh4), 

	@PL1_WeightedAverageRetailPrice = AVG(LinePlanBusPnCh1), @PL2_WeightedAverageRetailPrice = AVG(LinePlanBusPnCh2), 
	@PL3_WeightedAverageRetailPrice = AVG(LinePlanBusPnCh3), @PL4_WeightedAverageRetailPrice = AVG(LinePlanBusPnCh4), 

	@Cu1_WeightedAverageRetailPrice = AVG(LinePlanBusCuCh1), @Cu2_WeightedAverageRetailPrice = AVG(LinePlanBusCuCh2), 
	@Cu3_WeightedAverageRetailPrice = AVG(LinePlanBusCuCh3), @Cu4_WeightedAverageRetailPrice = AVG(LinePlanBusCuCh4) 
FROM pLinePlanBusiness
WHERE (LinePlanFinancialID = '00000000-0000-0000-0000-000000000026') AND 
	LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND
	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND
	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3


INSERT INTO #tmpLinePlanBusiness(
	LinePlanID, 
	LinePlanFinancialID, 
	LinePlanFinancialText,
	LinePlanBusLYCh1,
	LinePlanBusLYCh2,
	LinePlanBusLYCh3,
	LinePlanBusLYCh4,
	LinePlanBusPnCh1,
	LinePlanBusPnCh2,
	LinePlanBusPnCh3,
	LinePlanBusPnCh4,
	LinePlanBusCuCh1,
	LinePlanBusCuCh2,
	LinePlanBusCuCh3,
	LinePlanBusCuCh4,
	LinePlanAttributeItemID1,
	LinePlanFinancialSort)
VALUES (  
	@LinePlanID, 
	'00000000-0000-0000-0000-000000000026',     
	@MarkupFactorText, 
	@LY1_WeightedAverageRetailPrice, 
	@LY2_WeightedAverageRetailPrice, 
	@LY3_WeightedAverageRetailPrice,
	@LY4_WeightedAverageRetailPrice, 
	@PL1_WeightedAverageRetailPrice, 
	@PL2_WeightedAverageRetailPrice, 
	@PL3_WeightedAverageRetailPrice, 
	@PL4_WeightedAverageRetailPrice, 
	@Cu1_WeightedAverageRetailPrice, 
	@Cu2_WeightedAverageRetailPrice, 
	@Cu3_WeightedAverageRetailPrice, 
	@Cu4_WeightedAverageRetailPrice, 
	@LinePlanAttributeItemID1,
	'0021')

--================================================================================================================

--SELECT * FROM #tmpLinePlanBusiness ORDER BY LinePlanFinancialSort

SELECT 
	#tmpLinePlanBusiness.LinePlanID, 
	#tmpLinePlanBusiness.LinePlanFinancialID, 
	pLinePlanFinancial.LinePlanFinancialText, 
	#tmpLinePlanBusiness.LinePlanFinancialSort, 
	#tmpLinePlanBusiness.LinePlanAttributeItemID1, 
	#tmpLinePlanBusiness.LinePlanAttributeItemID2, 
	#tmpLinePlanBusiness.LinePlanAttributeItemID3, 
	#tmpLinePlanBusiness.LinePlanAttributeItemID4, 
	pLinePlanFinancial.LinePlanFinancialDataType, 
	pLinePlanFinancial.LinePlanFinancialDataFormat, 
	pLinePlanFinancial.LinePlanFinancialCssClass,
	#tmpLinePlanBusiness.LinePlanBusLYCh1,
	#tmpLinePlanBusiness.LinePlanBusLYCh2,
	#tmpLinePlanBusiness.LinePlanBusLYCh3,
	#tmpLinePlanBusiness.LinePlanBusLYCh4,
	#tmpLinePlanBusiness.LinePlanBusPnCh1,
	#tmpLinePlanBusiness.LinePlanBusPnCh2,
	#tmpLinePlanBusiness.LinePlanBusPnCh3,
	#tmpLinePlanBusiness.LinePlanBusPnCh4,
	#tmpLinePlanBusiness.LinePlanBusCuCh1,
	#tmpLinePlanBusiness.LinePlanBusCuCh2,
	#tmpLinePlanBusiness.LinePlanBusCuCh3,
	#tmpLinePlanBusiness.LinePlanBusCuCh4
FROM  #tmpLinePlanBusiness INNER JOIN
    pLinePlanFinancial ON #tmpLinePlanBusiness.LinePlanFinancialID = pLinePlanFinancial.LinePlanFinancialID


DROP TABLE #tmpLinePlanBusiness












GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_DesktopAccessCostingCheck_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_Group_DesktopAccessCostingCheck_INSERT] (
@GroupID uniqueidentifier, 
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

DECLARE @I as int
DECLARE @Row_Count int
DECLARE @StyleTypeID int 
DECLARE @DeskAccessId int
DECLARE @DeskTableName varchar(100)
DECLARE @DeskTableKey varchar(50)


	BEGIN
	CREATE TABLE #TempGroupAccess (
		Id int IDENTITY (1, 1) NOT NULL , 
		StyleTypeID int NOT NULL,
		GroupID uniqueidentifier 
	) 
	END

	BEGIN
	
	INSERT INTO #TempGroupAccess( StyleTypeID) SELECT StyleTypeID FROM pStyleType
	
	
	SET @Row_Count = (SELECT COUNT(*) FROM #TempGroupAccess)
	
	SET @I = 1

	WHILE @I <= @Row_Count 
		BEGIN

			SELECT @StyleTypeID = StyleTypeID FROM #TempGroupAccess WHERE ID = @I
			IF (SELECT COUNT(*) FROM sAccessGroupCosting WITH (NOLOCK)  WHERE StyleTypeId = @StyleTypeID  AND GroupID = @GroupID ) = 0
			BEGIN
				INSERT INTO sAccessGroupCosting
					( StyleTypeId, GroupID, CUser, CDate, MUser, MDate)
				SELECT StyleTypeId, @GroupID, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate 
				FROM  #TempGroupAccess WHERE Id = @I
			END
				
			SET @I = @I + 1
		END

		SELECT * FROM #tempGroupAccess

	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[dpx_SampleRequestSubmit_StatusByAgent_SELECT]'
GO
CREATE PROCEDURE [dbo].[dpx_SampleRequestSubmit_StatusByAgent_SELECT]
(
	@SeasonYearID uniqueidentifier = NULL
)

AS

IF @SeasonYearID IS NULL OR @SeasonYearID = '00000000-0000-0000-0000-000000000000'
BEGIN 
	SELECT TOP 1 @SeasonYearID = SeasonYearID FROM pSeasonYear WHERE CurrentSeason = 1
END

CREATE TABLE #tempStyleSeasonYear(
	StyleID uniqueidentifier,
	SeasonYearID uniqueidentifier
)

INSERT INTO #tempStyleSeasonYear (StyleID, SeasonYearID)
SELECT StyleID, SeasonYearID FROM pStyleSeasonYear 
WHERE SeasonYearID = @SeasonYearID

SELECT  COUNT(*) AS COUNT, dbo.pSampleRequestWorkflow.TradePartnerID, dbo.uTradePartner.TradePartnerName, 
	CASE WHEN pSampleRequestSubmitStatus.StatusID = 0 AND pSampleRequestWorkflow.Submit <> 1 THEN 1
	ELSE pSampleRequestSubmitStatus.StatusID
	END AS StatusID, 
	CASE WHEN pSampleRequestSubmitStatus.StatusID = 0 AND pSampleRequestWorkflow.Submit <> 1 THEN 'Resubmit'
	ELSE pSampleRequestSubmitStatus.Status
	END AS Status
FROM  dbo.pSampleRequestWorkflow INNER JOIN
  dbo.uTradePartner ON dbo.pSampleRequestWorkflow.TradePartnerID = dbo.uTradePartner.TradePartnerID INNER JOIN
  dbo.pSampleRequestSubmitStatus ON dbo.pSampleRequestWorkflow.Status = dbo.pSampleRequestSubmitStatus.StatusID
WHERE pSampleRequestWorkflow.StyleId IN (SELECT StyleID FROM #tempStyleSeasonYear)
GROUP BY dbo.pSampleRequestWorkflow.TradePartnerID, dbo.uTradePartner.TradePartnerName, dbo.pSampleRequestSubmitStatus.Status, 
                      dbo.pSampleRequestSubmitStatus.StatusID, pSampleRequestWorkflow.Submit
ORDER BY TradePartnerName

DROP TABLE #tempStyleSeasonYear
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleColorway_Summary_SELECT]'
GO




CREATE  PROCEDURE [dbo].[spx_StyleColorway_Summary_SELECT]  (
@StyleID UNIQUEIDENTIFIER , 
@StyleSet INT,
@SeasonYearID NVARCHAR(50) =''
)
AS 


IF @SeasonYearID = '' 
BEGIN
	SELECT TOP 1 @SeasonYearID = SeasonYearID FROM pStyleSeasonYear WHERE StyleID = @StyleID
END 


DECLARE @StyleSeasonYearID  UNIQUEIDENTIFIER 
DECLARE @LinePlanItemID UNIQUEIDENTIFIER 
DECLARE @LinePlanRangeID UNIQUEIDENTIFIER 


SELECT @StyleSeasonYearID  = StyleSeasonYearID  , @LinePlanItemID = LinePlanItemID
FROM  pStyleSeasonYear
WHERE StyleID = @StyleID 
AND SeasonYearID  = @SeasonYearID 



IF @LinePlanItemID  IS NOT NULL
BEGIN 
	SELECT @LinePlanRangeID = LinePlanRangeID FROM pLinePlanItem  WHERE LinePlanItemID = @LinePlanItemID 

	-- LinePlanStyle 
	SELECT a.StyleColorwayID as StyleColorID , c.StyleColorName, c.StyleColorNo, c.MainColor, 
	c.Sort, c.PLMCode, c.SAPCode,
    '<A HREF=''Style_Colorway_LinePlan_Select.aspx?SN=' + CAST ( @StyleSet AS NVARCHAR(50)) +
	'&SID=' + CAST(@StyleID AS NVARCHAR(50)) +
    '&SCID=' + CAST(a.StyleColorwayID AS NVARCHAR(50)) +
	'&LPID=' + CAST(b.LinePlanID AS NVARCHAR(50)) +
	'&LPRID=' + CAST(@LinePlanRangeID AS NVARCHAR(50))  + 
	'&SYID='  + CAST(b.SeasonYearID AS NVARCHAR(50))  +
	'''><IMG BORDER=''0'' ALT=''...'' src=''../System/Icons/icon_search.gif''></A>' 
	AS SearchImage, c.ColorPaletteID
	FROM  pStyleColorwaySeasonYear a
	INNER JOIN pStyleColorway c ON a.StylecolorwayID =  c.StylecolorID
	INNER JOIN pStyleSeasonYear b ON a.StyleSeasonYearID =  b.StyleSeasonYearID
	WHERE a.StyleSeasonYearID = @StyleSeasonYearID 


END
ELSE
BEGIN

	-- No a lineplan Style 
	SELECT a.StyleColorwayID as StyleColorID , c.StyleColorName, c.StyleColorNo, c.MainColor,
	c.Sort, c.PLMCode, c.SAPCode,
	'<A HREF=''Style_Colorway_Select_Palette.aspx?UPDT=1&SN=' + CAST ( @StyleSet AS NVARCHAR(50)) +
	'&SID=' +  CAST(@StyleID AS NVARCHAR(50)) +
	'&SCID=' +  CAST(a.StyleColorwayID AS NVARCHAR(50)) +
	'&SYID=' +  CAST(b.SeasonYearID AS NVARCHAR(50)) + '''><IMG BORDER=''0'' ALT=''...'' src=''../System/Icons/icon_search.gif''></A>' 
	AS SearchImage, c.ColorPaletteID
	FROM pStyleColorwaySeasonYear a
	INNER JOIN pStyleColorway c ON a.StylecolorwayID =  c.StyleColorID 
	INNER JOIN pStyleSeasonYear b ON a.StyleSeasonYearID =  b.StyleSeasonYearID
	WHERE a.StyleSeasonYearID = @StyleSeasonYearID 

END 





























GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanRangeCurrentRollup1_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_LinePlanRangeCurrentRollup1_SELECT] (
@LinePlanIndex varchar(1),
@LinePlanId varchar(40),
@LinePlanAttributeItemId1 varchar(40)
)
AS 


DECLARE
	@SLinePlanRangeDelCO4 int,
	@SLinePlanRangeDelNV4 int,
	@SLinePlanRangeDelN4 int,
	@FLinePlanRangeDel4 int,
	@BLinePlanRangeDel4 int,
	@CLinePlanRangeDel4 int,
	
	@SLinePlanRange VARCHAR(100),
	@SLinePlanRangeID UNIQUEIDENTIFIER, 
	@FLinePlanRange VARCHAR(100),
	@FLinePlanRangeID UNIQUEIDENTIFIER, 
	@BLinePlanRange VARCHAR(100),
	@BLinePlanRangeID UNIQUEIDENTIFIER ,
	@CLinePlanRange VARCHAR(100),
	@CLinePlanRangeID UNIQUEIDENTIFIER 


CREATE TABLE #tmpLinePlanRange(
	LinePlanRangeID uniqueidentifier NULL,
	LinePlanID uniqueidentifier NULL,
	LinePlanFinancialID uniqueidentifier NULL,
	LinePlanRange nvarchar(100) NULL,

	LinePlanAttributeItemID1 uniqueidentifier NULL,
	LinePlanAttributeItemID2 uniqueidentifier NULL,
	LinePlanAttributeItemID3 uniqueidentifier NULL,
	LinePlanAttributeItemID4 uniqueidentifier NULL,


	LinePlanRangeDelCO1 int NULL,
	LinePlanRangeDelNV1 int NULL,
	LinePlanRangeDelN1 int NULL,
	LinePlanRangeDelTL1 int NULL,

	LinePlanRangeDelCO2 int NULL,
	LinePlanRangeDelNV2 int NULL,
	LinePlanRangeDelN2 int NULL,
	LinePlanRangeDelTL2 int NULL,

	LinePlanRangeDelCO3 int NULL,
	LinePlanRangeDelNV3 int NULL,
	LinePlanRangeDelN3 int NULL,
	LinePlanRangeDelTL3 int NULL,

	LinePlanRangeDelCO4 int NULL,
	LinePlanRangeDelNV4 int NULL,
	LinePlanRangeDelN4 int NULL,
	LinePlanRangeDelTL4 int NULL,

	LinePlanRangeDelAVCO int NULL,
	LinePlanRangeDelAVNV int NULL,
	LinePlanRangeDelAVN int NULL,
	LinePlanRangeSort varchar(5) NULL
)


SET @SLinePlanRangeDelCO4 = 0 
SET @SLinePlanRangeDelNV4 = 0 
SET @SLinePlanRangeDelN4 = 0 
SET @FLinePlanRangeDel4 = 0 
SET @BLinePlanRangeDel4 = 0 
SET @CLinePlanRangeDel4 = 0 


SELECT c.MostLikelyVendor, c.TradePartnerVendorID, a.LinePlanRangeTypeID , 
a.StyleID , i.MaterialID, h.BodyID, 
g.ColorPaletteID,
f.StyleColorDelivery1, f.StyleColorDelivery2, f.StyleColorDelivery3, f.StyleColorDelivery4
INTO #tmp
FROM pLinePlanItem a
INNER JOIN pLinePlanRange b ON a.LinePlanRangeID = b.LinePlanRangeID 
INNER JOIN pStyleSeasonYear c ON (c.StyleID = a.StyleID AND  c.LinePlanItemID = a.LinePlanItemID)
INNER JOIN pStyleSourcing d ON  d.StyleSeasonYearID = c.StyleSeasonYearID  
INNER JOIN pStyleQuoteItem e ON e.StyleSourcingID =  d.StyleSourcingID
INNER JOIN pStyleColorwaySeasonYear f ON ( f.StyleSeasonYearID = c.StyleSeasonYearID 
AND f.StyleColorwayID = e.StyleColorID )
INNER JOIN pStyleColorway g ON g.StyleColorID = f.StyleColorwayID 
INNER JOIN pStyleHeader h ON h.StyleID = e.StyleID 
LEFT OUTER JOIN pStyleMaterials i ON i.StyleID = e.StyleID 
WHERE b.LinePlanAttributeItemId1 = @LinePlanAttributeItemId1
AND b.LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'
AND a.StyleID <>  '00000000-0000-0000-0000-000000000000'
AND e.StyleQuoteItemStatusID = 3 
AND f.StyleColorStatus = 200
AND c.TradePartnerVendorID IS NOT NULL
AND i.MainMaterial = 1  
ORDER BY a.LinePlanRangeTypeID , c.StyleID


---  =======================================================================================================
--- DELIVERY 1 
DECLARE
	@SLinePlanRangeDelCO1 int,	@SLinePlanRangeDelNV1 int,	@SLinePlanRangeDelN1 int,
	@FLinePlanRangeDel1 int,	@BLinePlanRangeDel1 int,	@CLinePlanRangeDel1 int

SELECT @SLinePlanRangeDelCO1 = COUNT(DISTINCT StyleID) FROM #tmp WHERE StyleColorDelivery1 = 1 AND LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001'
SELECT @SLinePlanRangeDelN1  = COUNT(DISTINCT StyleID) FROM #tmp WHERE StyleColorDelivery1 = 1 AND LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003'
SELECT @SLinePlanRangeDelNV1  =  0
SELECT @FLinePlanRangeDel1 = COUNT(DISTINCT MaterialID) FROM #tmp WHERE StyleColorDelivery1 = 1 AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' ) AND MaterialID IS NOT NULL
SELECT @BLinePlanRangeDel1 = COUNT(DISTINCT BodyID) FROM #tmp WHERE StyleColorDelivery1 = 1 AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' ) AND BodyID IS NOT NULL
SELECT @CLinePlanRangeDel1 =  COUNT(DISTINCT(ColorPaletteID)) FROM #tmp WHERE StyleColorDelivery1 = 1 AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' )

/*
SELECT @SLinePlanRangeDelCO1 AS SLinePlanRangeDelCO1,
@SLinePlanRangeDelN1  AS SLinePlanRangeDelN1 ,
@FLinePlanRangeDel1 AS FLinePlanRangeDel1,
@BLinePlanRangeDel1  AS BLinePlanRangeDel1,
@CLinePlanRangeDel1  AS CLinePlanRangeDel1 
*/

---  =======================================================================================================
--- DELIVERY 2
DECLARE
	@SLinePlanRangeDelCO2 int,	@SLinePlanRangeDelNV2 int,	@SLinePlanRangeDelN2 int,
	@FLinePlanRangeDel2 int,	@BLinePlanRangeDel2 int,	@CLinePlanRangeDel2 int

SELECT @SLinePlanRangeDelCO2 = COUNT(DISTINCT StyleID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1) AND LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001'
SELECT @SLinePlanRangeDelN2  = COUNT(DISTINCT StyleID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1)  AND LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003'
SELECT @SLinePlanRangeDelNV2  =  0
SELECT @FLinePlanRangeDel2 = COUNT(DISTINCT MaterialID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1) AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' ) AND MaterialID IS NOT NULL
SELECT @BLinePlanRangeDel2 = COUNT(DISTINCT BodyID) FROM #tmp WHERE  (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1) AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' ) AND BodyID IS NOT NULL
SELECT @CLinePlanRangeDel2 =  COUNT(DISTINCT(ColorPaletteID)) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1) AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' )

/*
SELECT @SLinePlanRangeDelCO2 AS SLinePlanRangeDelCO2,
@SLinePlanRangeDelN2  AS SLinePlanRangeDelN2 ,
@FLinePlanRangeDel2 AS FLinePlanRangeDel2,
@BLinePlanRangeDel2  AS BLinePlanRangeDel2,
@CLinePlanRangeDel2  AS CLinePlanRangeDel2 
*/


---  =======================================================================================================
--- DELIVERY 3
DECLARE
	@SLinePlanRangeDelCO3 int,	@SLinePlanRangeDelNV3 int,	@SLinePlanRangeDelN3 int,
	@FLinePlanRangeDel3 int,	@BLinePlanRangeDel3 int,	@CLinePlanRangeDel3 int

SELECT @SLinePlanRangeDelCO3 = COUNT(DISTINCT StyleID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1 OR StyleColorDelivery3 = 1) AND LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001'
SELECT @SLinePlanRangeDelN3  = COUNT(DISTINCT StyleID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1 OR StyleColorDelivery3 = 1) AND LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003'
SELECT @SLinePlanRangeDelNV3  =  0
SELECT @FLinePlanRangeDel3 = COUNT(DISTINCT MaterialID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1 OR StyleColorDelivery3 = 1)  AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' ) AND MaterialID IS NOT NULL
SELECT @BLinePlanRangeDel3 = COUNT(DISTINCT BodyID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1 OR StyleColorDelivery3 = 1)  AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' ) AND BodyID IS NOT NULL
SELECT @CLinePlanRangeDel3 =  COUNT(DISTINCT(ColorPaletteID)) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1 OR StyleColorDelivery3 = 1)  AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' )

/*
SELECT @SLinePlanRangeDelCO3 AS SLinePlanRangeDelCO3,
@SLinePlanRangeDelN3  AS SLinePlanRangeDelN3 ,
@FLinePlanRangeDel3 AS FLinePlanRangeDel3,
@BLinePlanRangeDel3  AS BLinePlanRangeDel3,
@CLinePlanRangeDel3  AS CLinePlanRangeDel3 
*/


DROP TABLE  #tmp



SELECT @SLinePlanRange = LinePlanRange, @SLinePlanRangeID = LinePlanRangeID 
FROM   pLinePlanRange
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND	LinePlanId = @LinePlanID
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanRange, LinePlanAttributeItemID1, 
LinePlanRangeSort, LineplanRangeID


select @FLinePlanRange = LinePlanRange, @FLinePlanRangeID = LinePlanRangeID 
FROM   pLinePlanRange
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000001'
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND	LinePlanId = @LinePlanID
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanRange, LinePlanAttributeItemID1, 
LinePlanRangeSort, LineplanRangeID

select @CLinePlanRange = LinePlanRange, @CLinePlanRangeID = LinePlanRangeID 
FROM   pLinePlanRange
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000002'
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND	LinePlanId = @LinePlanID
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanRange, LinePlanAttributeItemID1, 
LinePlanRangeSort, LineplanRangeID

select @BLinePlanRange = LinePlanRange, @BLinePlanRangeID = LinePlanRangeID 
FROM   pLinePlanRange
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000003'
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND	LinePlanId = @LinePlanID
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanRange, LinePlanAttributeItemID1, 
LinePlanRangeSort, LineplanRangeID



INSERT INTO #tmpLinePlanRange (
LinePlanID, LineplanRangeID, LinePlanFinancialID, LinePlanRange, 
LinePlanRangeDelCO1, LinePlanRangeDelNV1, LinePlanRangeDelN1, LinePlanRangeDelTL1, 
LinePlanRangeDelCO2, LinePlanRangeDelNV2, LinePlanRangeDelN2, LinePlanRangeDelTL2, 
LinePlanRangeDelCO3, LinePlanRangeDelNV3, LinePlanRangeDelN3, LinePlanRangeDelTL3, 
LinePlanRangeDelCO4, LinePlanRangeDelNV4, LinePlanRangeDelN4, LinePlanRangeDelTL4 )
VALUES (
@LinePlanID,@SLineplanRangeID ,'10000000-0000-0000-0000-000000000004', @SLinePlanRange,
@SLinePlanRangeDelCO1, @SLinePlanRangeDelNV1, @SLinePlanRangeDelN1, @SLinePlanRangeDelCO1+@SLinePlanRangeDelNV1+@SLinePlanRangeDelN1,
@SLinePlanRangeDelCO2, @SLinePlanRangeDelNV2, @SLinePlanRangeDelN2, @SLinePlanRangeDelCO2+@SLinePlanRangeDelNV2+@SLinePlanRangeDelN2,
@SLinePlanRangeDelCO3, @SLinePlanRangeDelNV3, @SLinePlanRangeDelN3, @SLinePlanRangeDelCO3+@SLinePlanRangeDelNV3+@SLinePlanRangeDelN3,
@SLinePlanRangeDelCO4, @SLinePlanRangeDelNV4, @SLinePlanRangeDelN4, @SLinePlanRangeDelCO4+@SLinePlanRangeDelNV4+@SLinePlanRangeDelN4 )


INSERT INTO #tmpLinePlanRange (
LinePlanID, LineplanRangeID, LinePlanFinancialID, LinePlanRange, 
LinePlanRangeDelTL1, LinePlanRangeDelTL2, LinePlanRangeDelTL3, LinePlanRangeDelTL4 )
VALUES (
@LinePlanID,@FLineplanRangeID ,'10000000-0000-0000-0000-000000000001', @FLinePlanRange,
@FLinePlanRangeDel1, @FLinePlanRangeDel2, @FLinePlanRangeDel3, @FLinePlanRangeDel4
)

INSERT INTO #tmpLinePlanRange (
LinePlanID, LineplanRangeID, LinePlanFinancialID, LinePlanRange, 
LinePlanRangeDelTL1, LinePlanRangeDelTL2, LinePlanRangeDelTL3, LinePlanRangeDelTL4 )
VALUES (
@LinePlanID,@BLineplanRangeID ,'10000000-0000-0000-0000-000000000003', @BLinePlanRange,
@BLinePlanRangeDel1, @BLinePlanRangeDel2, @BLinePlanRangeDel3, @BLinePlanRangeDel4
)


INSERT INTO #tmpLinePlanRange (
LinePlanID, LineplanRangeID, LinePlanFinancialID, LinePlanRange, 
LinePlanRangeDelTL1, LinePlanRangeDelTL2, LinePlanRangeDelTL3, LinePlanRangeDelTL4 )
VALUES (
@LinePlanID,@CLineplanRangeID ,'10000000-0000-0000-0000-000000000002', @CLinePlanRange,
@CLinePlanRangeDel1, @CLinePlanRangeDel2, @CLinePlanRangeDel3, @CLinePlanRangeDel4
)


SELECT #tmpLinePlanRange.*, 
pLinePlanFinancial.LinePlanFinancialDataType, 
pLinePlanFinancial.LinePlanFinancialDataFormat, 
pLinePlanFinancial.LinePlanFinancialCssClass
FROM #tmpLinePlanRange 
INNER JOIN pLinePlanFinancial ON #tmpLinePlanRange.LinePlanFinancialID = pLinePlanFinancial.LinePlanFinancialID


DROP TABLE #tmpLinePlanRange











GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanColorAllocationFilter_SELECT]'
GO


ALTER PROCEDURE [dbo].[spx_LinePlanColorAllocationFilter_SELECT]
(
@LinePlanId varchar(40),
@LinePlanIndex VARCHAR (1) , 
@LinePlanAttributeItemId1 UNIQUEIDENTIFIER, 
@LinePlanAttributeItemId2 UNIQUEIDENTIFIER, 
@LinePlanAttributeItemId3 UNIQUEIDENTIFIER, 
@LinePlanAttributeItemId4 UNIQUEIDENTIFIER,
@ColorPaletteID varchar(40)
)
AS 


IF @LinePlanIndex  = '0' 
BEGIN 

	SELECT pLinePlanRange.LinePlanRangeID, pLinePlanAttributeItem_1.LinePlanAttributeItemID AS LinePlanAttributeItemID1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeItemID AS LinePlanAttributeItemID2, pLinePlanAttributeItem_3.LinePlanAttributeItemID AS LinePlanAttributeItemID3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeItemID AS LinePlanAttributeItemID4, pLinePlanAttributeItem_1.LinePlanAttributeText AS LinePlanAttributeHeader1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeText AS LinePlanAttributeHeader2, pLinePlanAttributeItem_3.LinePlanAttributeText AS LinePlanAttributeHeader3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeText AS LinePlanAttributeHeader4
	FROM dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_3 RIGHT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_1 RIGHT OUTER JOIN
	  dbo.pLinePlanRange ON pLinePlanAttributeItem_1.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID1 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_2 ON dbo.pLinePlanRange.LinePlanAttributeItemID2 = pLinePlanAttributeItem_2.LinePlanAttributeItemID ON 
	  pLinePlanAttributeItem_3.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID3 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_4 ON dbo.pLinePlanRange.LinePlanAttributeItemID4 = pLinePlanAttributeItem_4.LinePlanAttributeItemID
	WHERE pLinePlanRange.LinePlanID = @LinePlanID AND pLinePlanRange.LinePlanFinancialID = '10000000-0000-0000-0000-000000000002' AND 
		pLinePlanRange.LinePlanRangeID NOT IN (SELECT LinePlanRangeID FROM pLinePlanColorItem WHERE 
		ColorPaletteID = @ColorPaletteID) 
	ORDER BY LinePlanAttributeHeader1, LinePlanAttributeHeader2, LinePlanAttributeHeader3, LinePlanAttributeHeader4


END
ELSE IF @LinePlanIndex  = '1' 
BEGIN 

	SELECT pLinePlanRange.LinePlanRangeID, pLinePlanAttributeItem_1.LinePlanAttributeItemID AS LinePlanAttributeItemID1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeItemID AS LinePlanAttributeItemID2, pLinePlanAttributeItem_3.LinePlanAttributeItemID AS LinePlanAttributeItemID3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeItemID AS LinePlanAttributeItemID4, pLinePlanAttributeItem_1.LinePlanAttributeText AS LinePlanAttributeHeader1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeText AS LinePlanAttributeHeader2, pLinePlanAttributeItem_3.LinePlanAttributeText AS LinePlanAttributeHeader3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeText AS LinePlanAttributeHeader4
	FROM dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_3 RIGHT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_1 RIGHT OUTER JOIN
	  dbo.pLinePlanRange ON pLinePlanAttributeItem_1.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID1 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_2 ON dbo.pLinePlanRange.LinePlanAttributeItemID2 = pLinePlanAttributeItem_2.LinePlanAttributeItemID ON 
	  pLinePlanAttributeItem_3.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID3 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_4 ON dbo.pLinePlanRange.LinePlanAttributeItemID4 = pLinePlanAttributeItem_4.LinePlanAttributeItemID
	WHERE pLinePlanRange.LinePlanID = @LinePlanID AND pLinePlanRange.LinePlanFinancialID = '10000000-0000-0000-0000-000000000002' AND 
		pLinePlanRange.LinePlanRangeID NOT IN (SELECT LinePlanRangeID FROM pLinePlanColorItem WHERE 
		ColorPaletteID = @ColorPaletteID) 
	AND pLinePlanAttributeItem_1.LinePlanAttributeItemID  = @LinePlanAttributeItemId1
	ORDER BY LinePlanAttributeHeader1, LinePlanAttributeHeader2, LinePlanAttributeHeader3, LinePlanAttributeHeader4


END 
ELSE IF @LinePlanIndex  = '2' 
BEGIN 


	SELECT pLinePlanRange.LinePlanRangeID, pLinePlanAttributeItem_1.LinePlanAttributeItemID AS LinePlanAttributeItemID1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeItemID AS LinePlanAttributeItemID2, pLinePlanAttributeItem_3.LinePlanAttributeItemID AS LinePlanAttributeItemID3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeItemID AS LinePlanAttributeItemID4, pLinePlanAttributeItem_1.LinePlanAttributeText AS LinePlanAttributeHeader1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeText AS LinePlanAttributeHeader2, pLinePlanAttributeItem_3.LinePlanAttributeText AS LinePlanAttributeHeader3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeText AS LinePlanAttributeHeader4
	FROM dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_3 RIGHT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_1 RIGHT OUTER JOIN
	  dbo.pLinePlanRange ON pLinePlanAttributeItem_1.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID1 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_2 ON dbo.pLinePlanRange.LinePlanAttributeItemID2 = pLinePlanAttributeItem_2.LinePlanAttributeItemID ON 
	  pLinePlanAttributeItem_3.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID3 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_4 ON dbo.pLinePlanRange.LinePlanAttributeItemID4 = pLinePlanAttributeItem_4.LinePlanAttributeItemID
	WHERE pLinePlanRange.LinePlanID = @LinePlanID AND pLinePlanRange.LinePlanFinancialID = '10000000-0000-0000-0000-000000000002' AND 
		pLinePlanRange.LinePlanRangeID NOT IN (SELECT LinePlanRangeID FROM pLinePlanColorItem WHERE 
		ColorPaletteID = @ColorPaletteID) 
	AND pLinePlanAttributeItem_1.LinePlanAttributeItemID  = @LinePlanAttributeItemId1
	AND pLinePlanAttributeItem_2.LinePlanAttributeItemID  = @LinePlanAttributeItemId2
	ORDER BY LinePlanAttributeHeader1, LinePlanAttributeHeader2, LinePlanAttributeHeader3, LinePlanAttributeHeader4


END 
ELSE IF @LinePlanIndex  = '3' 
BEGIN 

	SELECT pLinePlanRange.LinePlanRangeID, pLinePlanAttributeItem_1.LinePlanAttributeItemID AS LinePlanAttributeItemID1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeItemID AS LinePlanAttributeItemID2, pLinePlanAttributeItem_3.LinePlanAttributeItemID AS LinePlanAttributeItemID3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeItemID AS LinePlanAttributeItemID4, pLinePlanAttributeItem_1.LinePlanAttributeText AS LinePlanAttributeHeader1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeText AS LinePlanAttributeHeader2, pLinePlanAttributeItem_3.LinePlanAttributeText AS LinePlanAttributeHeader3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeText AS LinePlanAttributeHeader4
	FROM dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_3 RIGHT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_1 RIGHT OUTER JOIN
	  dbo.pLinePlanRange ON pLinePlanAttributeItem_1.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID1 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_2 ON dbo.pLinePlanRange.LinePlanAttributeItemID2 = pLinePlanAttributeItem_2.LinePlanAttributeItemID ON 
	  pLinePlanAttributeItem_3.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID3 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_4 ON dbo.pLinePlanRange.LinePlanAttributeItemID4 = pLinePlanAttributeItem_4.LinePlanAttributeItemID
	WHERE pLinePlanRange.LinePlanID = @LinePlanID AND pLinePlanRange.LinePlanFinancialID = '10000000-0000-0000-0000-000000000002' AND 
		pLinePlanRange.LinePlanRangeID NOT IN (SELECT LinePlanRangeID FROM pLinePlanColorItem WHERE 
		ColorPaletteID = @ColorPaletteID) 
	AND pLinePlanAttributeItem_1.LinePlanAttributeItemID  = @LinePlanAttributeItemId1
	AND pLinePlanAttributeItem_2.LinePlanAttributeItemID  = @LinePlanAttributeItemId2
	AND pLinePlanAttributeItem_3.LinePlanAttributeItemID  = @LinePlanAttributeItemId3
	ORDER BY LinePlanAttributeHeader1, LinePlanAttributeHeader2, LinePlanAttributeHeader3, LinePlanAttributeHeader4

END 
ELSE IF @LinePlanIndex  = '4' 
BEGIN 

	SELECT pLinePlanRange.LinePlanRangeID, pLinePlanAttributeItem_1.LinePlanAttributeItemID AS LinePlanAttributeItemID1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeItemID AS LinePlanAttributeItemID2, pLinePlanAttributeItem_3.LinePlanAttributeItemID AS LinePlanAttributeItemID3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeItemID AS LinePlanAttributeItemID4, pLinePlanAttributeItem_1.LinePlanAttributeText AS LinePlanAttributeHeader1, 
	  pLinePlanAttributeItem_2.LinePlanAttributeText AS LinePlanAttributeHeader2, pLinePlanAttributeItem_3.LinePlanAttributeText AS LinePlanAttributeHeader3, 
	  pLinePlanAttributeItem_4.LinePlanAttributeText AS LinePlanAttributeHeader4
	FROM dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_3 RIGHT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_1 RIGHT OUTER JOIN
	  dbo.pLinePlanRange ON pLinePlanAttributeItem_1.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID1 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_2 ON dbo.pLinePlanRange.LinePlanAttributeItemID2 = pLinePlanAttributeItem_2.LinePlanAttributeItemID ON 
	  pLinePlanAttributeItem_3.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID3 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_4 ON dbo.pLinePlanRange.LinePlanAttributeItemID4 = pLinePlanAttributeItem_4.LinePlanAttributeItemID
	WHERE pLinePlanRange.LinePlanID = @LinePlanID AND pLinePlanRange.LinePlanFinancialID = '10000000-0000-0000-0000-000000000002' AND 
		pLinePlanRange.LinePlanRangeID NOT IN (SELECT LinePlanRangeID FROM pLinePlanColorItem WHERE 
		ColorPaletteID = @ColorPaletteID) 
	AND pLinePlanAttributeItem_1.LinePlanAttributeItemID  = @LinePlanAttributeItemId1
	AND pLinePlanAttributeItem_2.LinePlanAttributeItemID  = @LinePlanAttributeItemId2
	AND pLinePlanAttributeItem_3.LinePlanAttributeItemID  = @LinePlanAttributeItemId3
	AND pLinePlanAttributeItem_4.LinePlanAttributeItemID  = @LinePlanAttributeItemId4
	ORDER BY LinePlanAttributeHeader1, LinePlanAttributeHeader2, LinePlanAttributeHeader3, LinePlanAttributeHeader4

END 















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleRequestGridTeam_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_SampleRequestGridTeam_SELECT] 
(
@TradePartnerVendorID nvarchar(50),
@TeamID nvarchar(50),
@StyleNo nvarchar(200),
@StyleDescription nvarchar(200)
)
AS

DECLARE @UserID varchar(10), @sql varchar(8000), @delim varchar(1), @select varchar(8000), @enddate varchar(100), @duedate varchar(100), @pivot varchar(100), @table varchar(100)

SET NOCOUNT ON
SET ANSI_WARNINGS OFF

SELECT @UserID = UserID FROM Users WHERE TeamID = @TeamID

SELECT @select = 'SELECT dbo.pSampleRequestWorkflow.SampleRequestTradeID, 
dbo.pSampleRequestWorkflow.StyleColorID, dbo.pSampleRequestWorkflow.StyleID, 
dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.StyleNo AS [Style No], 
dbo.pStyleHeader.SizeRange AS [Size], dbo.pStyleHeader.Description, 
CASE 
WHEN pSampleRequestWorkflow.StyleSet = 1 THEN 
	CASE WHEN dbo.pStyleHeader.PC1 Is Not Null THEN dbo.pStyleHeader.PC1 ELSE ''1st Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 2 THEN 
	CASE WHEN dbo.pStyleHeader.PC2 Is Not Null THEN dbo.pStyleHeader.PC2 ELSE ''2nd Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 3 THEN 
	CASE WHEN dbo.pStyleHeader.PC3 Is Not Null THEN dbo.pStyleHeader.PC3 ELSE ''3rd Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 4 THEN 
	CASE WHEN dbo.pStyleHeader.PC4 Is Not Null THEN dbo.pStyleHeader.PC4 ELSE ''4th Set'' END 
END AS [Style Set], dbo.pStyleColorway.MainColor AS Color FROM dbo.pSampleRequestWorkflow WITH (NOLOCK) INNER JOIN 
dbo.pStyleHeader WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.StyleID = dbo.pStyleHeader.StyleID INNER JOIN 
dbo.pStyleColorway WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.StyleColorID = dbo.pStyleColorway.StyleColorID
GROUP BY dbo.pSampleRequestWorkflow.SampleRequestTradeID, dbo.pSampleRequestWorkflow.StyleID, dbo.pSampleRequestWorkflow.StyleColorID, 
dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.SizeRange, dbo.pStyleHeader.Description, 
dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.Pc1, dbo.pStyleHeader.Pc2, dbo.pStyleHeader.Pc3, dbo.pStyleHeader.Pc4, 
dbo.pSampleRequestWorkflow.TradePartnerVendorID, dbo.pSampleRequestWorkflow.AssignedTo, dbo.pStyleColorway.MainColor
HAVING dbo.pSampleRequestWorkflow.TradePartnerVendorID = ''' + @TradePartnerVendorID + ''' AND dbo.pSampleRequestWorkflow.AssignedTo = ''' + @UserId + ''' '

IF @StyleNo IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.StyleNo LIKE ''%' + @StyleNo + '%''' 
IF @StyleDescription IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.Description LIKE ''%' + @StyleDescription + '%''' 

SELECT @select = @select + ' ORDER BY dbo.pStyleHeader.StyleNo, dbo.pSampleRequestWorkflow.StyleSet '

SELECT @enddate = 'MAX(dbo.pSampleRequestWorkflow.EndDate)'
SELECT @duedate = 'MAX(dbo.pSampleRequestWorkflow.DueDate)'
SELECT @pivot = 'pSampleRequestWorkflow.SampleWorkflowID'
SELECt @table = 'pSampleRequestWorkflow WITH (NOLOCK)'

EXEC ('SELECT ' + @pivot + ' AS tb_pivot INTO ##tmpSampleWorkflow FROM ' + @table + ' WHERE 1=2')
EXEC ('INSERT INTO ##tmpSampleWorkflow SELECT DISTINCT ' + @pivot + ' FROM ' + @table + ' WHERE TradePartnerVendorID = ''{' + @TradePartnerVendorID + '}''' + ' 
AND dbo.pSampleRequestWorkflow.AssignedTo = ''' + @UserId + ''' AND ' + @pivot + ' Is Not Null')

SELECT @sql='',  @duedate=stuff(@duedate, len(@duedate), 1, ' END)' )
SELECT @sql=@sql + '',  @enddate=stuff(@enddate, len(@enddate), 1, ' END)' )

SELECT @delim=CASE Sign( CharIndex('char', data_type) + CharIndex('date', data_type) ) 
WHEN 0 THEN '''' ELSE '''' END 
FROM tempdb.information_schema.columns 
WHERE table_name='##tmpSampleWorkflow' AND column_name='tb_pivot'

SELECT @sql=@sql + '''D_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@duedate,charindex( '(', @duedate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
+ '''E_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@enddate,charindex( '(', @enddate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
FROM ##tmpSampleWorkflow

SELECT @sql=left(@sql, len(@sql)-1)

SELECT @select=stuff(@select, charindex(' FROM ', @select)+1, 0, ', ' + @sql + ' ')

DROP TABLE ##tmpSampleWorkflow

EXEC (@select)


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rpx_ControlPanel_POMLibrary_SmallImage_SELECT]'
GO



/*
Comments:

#01 - Ryan Cabanas - September 25, 2009
	Replace the old pom image string with the new image string using function.
Deleted old code.

#02 - Ryan Cabanas - September 25, 2009
	Smaller image version of this procedure.
*/



create  PROCEDURE [dbo].[rpx_ControlPanel_POMLibrary_SmallImage_SELECT]

AS


/*Creat temporary table*/
CREATE     TABLE #TempHowTo
(	
	RowNumber int identity(0,1),
	POM nvarchar(5),
	PointMeasur nvarchar(200),
	HowToMeasurText nvarchar(4000),
	FilePath nvarchar(255)
)


/*Insert values into the temporary table*/
INSERT INTO #TempHowTo(POM, PointMeasur, HowToMeasurText, FilePath)
SELECT	POM,
		PointMeasur,
		HowToMeasurText,
		dbo.fnx_GetStreamingPOMImageSmallPath(POMLibraryID) AS FilePath	--Comment #01, #02
FROM pPOMLibrary WITH (NOLOCK)
ORDER BY POM

/*Select the temporary table*/
SELECT	RowNumber % 4 AS Columns, POM, PointMeasur, HowToMeasurText, FilePath
FROM	#TempHowTo
ORDER BY POM, Columns DESC

DROP TABLE #TempHowTo


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_DesktopAccessFolder_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_Group_DesktopAccessFolder_SELECT](
	@GroupID uniqueidentifier
)
AS 


	SELECT a.DeskGroupAccessId,  a.GroupID, a.DeskAccessId, 
		b.DeskFolderUrl , b.DeskGroupFolderUrl ,  b.DeskFolderId,  b.DeskFolderName,  b.DeskSubFolder
	FROM  cDeskGroupFolderAccess  a WITH (NOLOCK)  INNER JOIN  cDesktopFolder  b WITH (NOLOCK) ON  a.DeskFolderId =  b.DeskFolderId
	WHERE a.GroupID = @GroupID 
	ORDER BY b.DeskFolderId



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_SampleRequestSubmit_SpecImage_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.
*/



ALTER   PROCEDURE [dbo].[rpx_SampleRequestSubmit_SpecImage_SELECT]
(	
	@SampleRequestSubmitID varchar(50)	
)
AS

DECLARE @StyleID varchar(50)
DECLARE	@StyleSet int
DECLARE @SpecSketchID varchar(50)
DECLARE @SpecSketchVersion nvarchar(255)
DECLARE @ImageHistoryID varchar(50)
DECLARE @SQLStr nvarchar(255)

/*Get some values.*/
SELECT
	@StyleID = StyleID,
	@StyleSet = StyleSet
FROM pSampleRequestSubmit
WHERE SampleRequestSubmitID = @SampleRequestSubmitID

IF (@StyleSet = 1)
	BEGIN
		SELECT @SpecSketchID = SpecSketchID1, @SpecSketchVersion = SpecSketchVersion1
		FROM pStyleImage
		WHERE StyleID = @StyleID
	END
ELSE IF (@StyleSet = 2)
	BEGIN
		SELECT @SpecSketchID = SpecSketchID2, @SpecSketchVersion = SpecSketchVersion2
		FROM pStyleImage
		WHERE StyleID = @StyleID
	END
ELSE IF (@StyleSet = 3)
	BEGIN
		SELECT @SpecSketchID = SpecSketchID3, @SpecSketchVersion = SpecSketchVersion3
		FROM pStyleImage
		WHERE StyleID = @StyleID
	END
ELSE IF (@StyleSet = 4)
	BEGIN
		SELECT @SpecSketchID = SpecSketchID4, @SpecSketchVersion = SpecSketchVersion4
		FROM pStyleImage
		WHERE StyleID = @StyleID
	END

SELECT @ImageHistoryID = ImageHistoryID
FROM hImage
WHERE (ImageID = @SpecSketchID) AND (Version = @SpecSketchVersion)


SET @SQLStr = dbo.fnx_GetStreamingImagePath(@SpecSketchID, @SpecSketchVersion)	--Comment #01


SELECT @SQLStr AS ImagePath




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleAttributeTableList_SELECTED]'
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[spx_StyleAttributeTableList_SELECTED]
(
@StyleId varchar(50),
@StyleAttributeTableId varchar(5)
)
AS 


DECLARE @StyleAttributeTable varchar(200)
DECLARE @StyleAttributeText varchar(200)
DECLARE @StyleAttributeSql varchar(4000)

SELECT @StyleAttributeTable = StyleAttributeTable, @StyleAttributeText = StyleAttributeText FROM pStyleAttributeTable WITH (NOLOCK) WHERE (StyleAttributeTableId = @StyleAttributeTableId)


DECLARE @SQL NVARCHAR(4000)
SET @SQL = '
DELETE FROM pStyleAttribute
WHERE StyleAttributeId IN ( 
	SELECT a.StyleAttributeId 
	FROM  pStyleAttribute a
	LEFT OUTER JOIN  ' +  @StyleAttributeTable +  ' b ON b.CustomKey  = a.StyleAttributeValue
	WHERE a.StyleAttributeTableId  = ' + @StyleAttributeTableId + '  
	AND b.CustomKey IS NULL
)	
'
EXEC (@SQL)

IF @@ROWCOUNT > 0  
BEGIN

	DECLARE @text NVARCHAR(4000)
	SET @text= ''
	SELECT @text = @text +  StyleAttributeText + ', ' FROM pStyleAttribute 
	WHERE StyleId = @StyleId 
	
	IF LEN (@text) > 0 
	BEGIN 
		UPDATE pStyleHeader Set StyleAttribute = @text
		WHERE StyleID = @StyleID
	END 
		
END 

SET @StyleAttributeSql = 'SELECT * FROM ' + @StyleAttributeTable + ' WHERE Active = 1 AND 
	CustomKey IN (SELECT StyleAttributeValue FROM pStyleAttribute WITH (NOLOCK) WHERE  StyleAttributeTableId = ''' + @StyleAttributeTableId + ''' AND StyleID =  ''' + @StyleID + ''') ORDER BY ' + @StyleAttributeText + ''

EXEC (@StyleAttributeSql)

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanRangeCurrentRollup2_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO




ALTER PROCEDURE [dbo].[spx_LinePlanRangeCurrentRollup2_SELECT] (
@LinePlanIndex varchar(1),
@LinePlanId varchar(40),
@LinePlanAttributeItemId1 varchar(40),
@LinePlanAttributeItemId2 varchar(40)
)
AS 


DECLARE
	@SLinePlanRangeDelCO4 int,
	@SLinePlanRangeDelNV4 int,
	@SLinePlanRangeDelN4 int,
	@FLinePlanRangeDel4 int,
	@BLinePlanRangeDel4 int,
	@CLinePlanRangeDel4 int,
	
	@SLinePlanRange VARCHAR(100),
	@SLinePlanRangeID UNIQUEIDENTIFIER, 
	@FLinePlanRange VARCHAR(100),
	@FLinePlanRangeID UNIQUEIDENTIFIER, 
	@BLinePlanRange VARCHAR(100),
	@BLinePlanRangeID UNIQUEIDENTIFIER ,
	@CLinePlanRange VARCHAR(100),
	@CLinePlanRangeID UNIQUEIDENTIFIER 


CREATE TABLE #tmpLinePlanRange(
	LinePlanRangeID uniqueidentifier NULL,
	LinePlanID uniqueidentifier NULL,
	LinePlanFinancialID uniqueidentifier NULL,
	LinePlanRange nvarchar(100) NULL,

	LinePlanAttributeItemID1 uniqueidentifier NULL,
	LinePlanAttributeItemID2 uniqueidentifier NULL,
	LinePlanAttributeItemID3 uniqueidentifier NULL,
	LinePlanAttributeItemID4 uniqueidentifier NULL,


	LinePlanRangeDelCO1 int NULL,
	LinePlanRangeDelNV1 int NULL,
	LinePlanRangeDelN1 int NULL,
	LinePlanRangeDelTL1 int NULL,

	LinePlanRangeDelCO2 int NULL,
	LinePlanRangeDelNV2 int NULL,
	LinePlanRangeDelN2 int NULL,
	LinePlanRangeDelTL2 int NULL,

	LinePlanRangeDelCO3 int NULL,
	LinePlanRangeDelNV3 int NULL,
	LinePlanRangeDelN3 int NULL,
	LinePlanRangeDelTL3 int NULL,

	LinePlanRangeDelCO4 int NULL,
	LinePlanRangeDelNV4 int NULL,
	LinePlanRangeDelN4 int NULL,
	LinePlanRangeDelTL4 int NULL,

	LinePlanRangeDelAVCO int NULL,
	LinePlanRangeDelAVNV int NULL,
	LinePlanRangeDelAVN int NULL,
	LinePlanRangeSort varchar(5) NULL
)


SET @SLinePlanRangeDelCO4 = 0 
SET @SLinePlanRangeDelNV4 = 0 
SET @SLinePlanRangeDelN4 = 0 
SET @FLinePlanRangeDel4 = 0 
SET @BLinePlanRangeDel4 = 0 
SET @CLinePlanRangeDel4 = 0 


SELECT c.MostLikelyVendor, c.TradePartnerVendorID, a.LinePlanRangeTypeID , 
a.StyleID , i.MaterialID, h.BodyID, 
g.ColorPaletteID,
f.StyleColorDelivery1, f.StyleColorDelivery2, f.StyleColorDelivery3, f.StyleColorDelivery4
INTO #tmp
FROM pLinePlanItem a
INNER JOIN pLinePlanRange b ON a.LinePlanRangeID = b.LinePlanRangeID 
INNER JOIN pStyleSeasonYear c ON (c.StyleID = a.StyleID AND  c.LinePlanItemID = a.LinePlanItemID)
INNER JOIN pStyleSourcing d ON  d.StyleSeasonYearID = c.StyleSeasonYearID  
INNER JOIN pStyleQuoteItem e ON e.StyleSourcingID =  d.StyleSourcingID
INNER JOIN pStyleColorwaySeasonYear f ON ( f.StyleSeasonYearID = c.StyleSeasonYearID 
AND f.StyleColorwayID = e.StyleColorID )
INNER JOIN pStyleColorway g ON g.StyleColorID = f.StyleColorwayID 
INNER JOIN pStyleHeader h ON h.StyleID = e.StyleID 
LEFT OUTER JOIN pStyleMaterials i ON i.StyleID = e.StyleID 
WHERE b.LinePlanAttributeItemId1 = @LinePlanAttributeItemId1
and b.LinePlanAttributeItemId2 = @LinePlanAttributeItemId2
AND b.LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'
AND a.StyleID <>  '00000000-0000-0000-0000-000000000000'
AND e.StyleQuoteItemStatusID = 3 
AND f.StyleColorStatus = 200
AND c.TradePartnerVendorID IS NOT NULL
AND i.MainMaterial = 1  
ORDER BY a.LinePlanRangeTypeID , c.StyleID


---  =======================================================================================================
--- DELIVERY 1 
DECLARE
	@SLinePlanRangeDelCO1 int,	@SLinePlanRangeDelNV1 int,	@SLinePlanRangeDelN1 int,
	@FLinePlanRangeDel1 int,	@BLinePlanRangeDel1 int,	@CLinePlanRangeDel1 int

SELECT @SLinePlanRangeDelCO1 = COUNT(DISTINCT StyleID) FROM #tmp WHERE StyleColorDelivery1 = 1 AND LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001'
SELECT @SLinePlanRangeDelN1  = COUNT(DISTINCT StyleID) FROM #tmp WHERE StyleColorDelivery1 = 1 AND LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003'
SELECT @SLinePlanRangeDelNV1  =  0
SELECT @FLinePlanRangeDel1 = COUNT(DISTINCT MaterialID) FROM #tmp WHERE StyleColorDelivery1 = 1 AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' ) AND MaterialID IS NOT NULL
SELECT @BLinePlanRangeDel1 = COUNT(DISTINCT BodyID) FROM #tmp WHERE StyleColorDelivery1 = 1 AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' ) AND BodyID IS NOT NULL
SELECT @CLinePlanRangeDel1 =  COUNT(DISTINCT(ColorPaletteID)) FROM #tmp WHERE StyleColorDelivery1 = 1 AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' )

/*
SELECT @SLinePlanRangeDelCO1 AS SLinePlanRangeDelCO1,
@SLinePlanRangeDelN1  AS SLinePlanRangeDelN1 ,
@FLinePlanRangeDel1 AS FLinePlanRangeDel1,
@BLinePlanRangeDel1  AS BLinePlanRangeDel1,
@CLinePlanRangeDel1  AS CLinePlanRangeDel1 
*/

---  =======================================================================================================
--- DELIVERY 2
DECLARE
	@SLinePlanRangeDelCO2 int,	@SLinePlanRangeDelNV2 int,	@SLinePlanRangeDelN2 int,
	@FLinePlanRangeDel2 int,	@BLinePlanRangeDel2 int,	@CLinePlanRangeDel2 int

SELECT @SLinePlanRangeDelCO2 = COUNT(DISTINCT StyleID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1) AND LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001'
SELECT @SLinePlanRangeDelN2  = COUNT(DISTINCT StyleID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1) AND LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003'
SELECT @SLinePlanRangeDelNV2  =  0
SELECT @FLinePlanRangeDel2 = COUNT(DISTINCT MaterialID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1) AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' ) AND MaterialID IS NOT NULL
SELECT @BLinePlanRangeDel2 = COUNT(DISTINCT BodyID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1)  AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' ) AND BodyID IS NOT NULL
SELECT @CLinePlanRangeDel2 =  COUNT(DISTINCT(ColorPaletteID)) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1)  AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' )

/*
SELECT @SLinePlanRangeDelCO2 AS SLinePlanRangeDelCO2,
@SLinePlanRangeDelN2  AS SLinePlanRangeDelN2 ,
@FLinePlanRangeDel2 AS FLinePlanRangeDel2,
@BLinePlanRangeDel2  AS BLinePlanRangeDel2,
@CLinePlanRangeDel2  AS CLinePlanRangeDel2 
*/


---  =======================================================================================================
--- DELIVERY 3
DECLARE
	@SLinePlanRangeDelCO3 int,	@SLinePlanRangeDelNV3 int,	@SLinePlanRangeDelN3 int,
	@FLinePlanRangeDel3 int,	@BLinePlanRangeDel3 int,	@CLinePlanRangeDel3 int

SELECT @SLinePlanRangeDelCO3 = COUNT(DISTINCT StyleID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1 OR StyleColorDelivery3 = 1)  AND LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001'
SELECT @SLinePlanRangeDelN3  = COUNT(DISTINCT StyleID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1 OR StyleColorDelivery3 = 1) AND LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003'
SELECT @SLinePlanRangeDelNV3  =  0
SELECT @FLinePlanRangeDel3 = COUNT(DISTINCT MaterialID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1 OR StyleColorDelivery3 = 1)  AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' ) AND MaterialID IS NOT NULL
SELECT @BLinePlanRangeDel3 = COUNT(DISTINCT BodyID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1 OR StyleColorDelivery3 = 1)  AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' ) AND BodyID IS NOT NULL
SELECT @CLinePlanRangeDel3 =  COUNT(DISTINCT(ColorPaletteID)) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1 OR StyleColorDelivery3 = 1)  AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' )

/*
SELECT @SLinePlanRangeDelCO3 AS SLinePlanRangeDelCO3,
@SLinePlanRangeDelN3  AS SLinePlanRangeDelN3 ,
@FLinePlanRangeDel3 AS FLinePlanRangeDel3,
@BLinePlanRangeDel3  AS BLinePlanRangeDel3,
@CLinePlanRangeDel3  AS CLinePlanRangeDel3 
*/


DROP TABLE  #tmp



SELECT @SLinePlanRange = LinePlanRange, @SLinePlanRangeID = LinePlanRangeID 
FROM   pLinePlanRange
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND	LinePlanId = @LinePlanID
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanRange, LinePlanAttributeItemID1, 
LinePlanAttributeItemID2, LinePlanRangeSort, LineplanRangeID


select @FLinePlanRange = LinePlanRange, @FLinePlanRangeID = LinePlanRangeID 
FROM   pLinePlanRange
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000001'
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND	LinePlanId = @LinePlanID
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanRange, LinePlanAttributeItemID1, 
LinePlanAttributeItemID2,  LinePlanRangeSort, LineplanRangeID

select @CLinePlanRange = LinePlanRange, @CLinePlanRangeID = LinePlanRangeID 
FROM   pLinePlanRange
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000002'
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND	LinePlanId = @LinePlanID
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanRange, LinePlanAttributeItemID1, 
LinePlanAttributeItemID2, LinePlanRangeSort, LineplanRangeID

select @BLinePlanRange = LinePlanRange, @BLinePlanRangeID = LinePlanRangeID 
FROM   pLinePlanRange
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000003'
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND	LinePlanId = @LinePlanID
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanRange, LinePlanAttributeItemID1, 
LinePlanAttributeItemID2, LinePlanRangeSort, LineplanRangeID




INSERT INTO #tmpLinePlanRange (
LinePlanID, LineplanRangeID, LinePlanFinancialID, LinePlanRange, 
LinePlanRangeDelCO1, LinePlanRangeDelNV1, LinePlanRangeDelN1, LinePlanRangeDelTL1, 
LinePlanRangeDelCO2, LinePlanRangeDelNV2, LinePlanRangeDelN2, LinePlanRangeDelTL2, 
LinePlanRangeDelCO3, LinePlanRangeDelNV3, LinePlanRangeDelN3, LinePlanRangeDelTL3, 
LinePlanRangeDelCO4, LinePlanRangeDelNV4, LinePlanRangeDelN4, LinePlanRangeDelTL4 )
VALUES (
@LinePlanID,@SLineplanRangeID ,'10000000-0000-0000-0000-000000000004', @SLinePlanRange,
@SLinePlanRangeDelCO1, @SLinePlanRangeDelNV1, @SLinePlanRangeDelN1, @SLinePlanRangeDelCO1+@SLinePlanRangeDelNV1+@SLinePlanRangeDelN1,
@SLinePlanRangeDelCO2, @SLinePlanRangeDelNV2, @SLinePlanRangeDelN2, @SLinePlanRangeDelCO2+@SLinePlanRangeDelNV2+@SLinePlanRangeDelN2,
@SLinePlanRangeDelCO3, @SLinePlanRangeDelNV3, @SLinePlanRangeDelN3, @SLinePlanRangeDelCO3+@SLinePlanRangeDelNV3+@SLinePlanRangeDelN3,
@SLinePlanRangeDelCO4, @SLinePlanRangeDelNV4, @SLinePlanRangeDelN4, @SLinePlanRangeDelCO4+@SLinePlanRangeDelNV4+@SLinePlanRangeDelN4 )


INSERT INTO #tmpLinePlanRange (
LinePlanID, LineplanRangeID, LinePlanFinancialID, LinePlanRange, 
LinePlanRangeDelTL1, LinePlanRangeDelTL2, LinePlanRangeDelTL3, LinePlanRangeDelTL4 )
VALUES (
@LinePlanID,@FLineplanRangeID ,'10000000-0000-0000-0000-000000000001', @FLinePlanRange,
@FLinePlanRangeDel1, @FLinePlanRangeDel2, @FLinePlanRangeDel3, @FLinePlanRangeDel4
)

INSERT INTO #tmpLinePlanRange (
LinePlanID, LineplanRangeID, LinePlanFinancialID, LinePlanRange, 
LinePlanRangeDelTL1, LinePlanRangeDelTL2, LinePlanRangeDelTL3, LinePlanRangeDelTL4 )
VALUES (
@LinePlanID,@BLineplanRangeID ,'10000000-0000-0000-0000-000000000003', @BLinePlanRange,
@BLinePlanRangeDel1, @BLinePlanRangeDel2, @BLinePlanRangeDel3, @BLinePlanRangeDel4
)


INSERT INTO #tmpLinePlanRange (
LinePlanID, LineplanRangeID, LinePlanFinancialID, LinePlanRange, 
LinePlanRangeDelTL1, LinePlanRangeDelTL2, LinePlanRangeDelTL3, LinePlanRangeDelTL4 )
VALUES (
@LinePlanID,@CLineplanRangeID ,'10000000-0000-0000-0000-000000000002', @CLinePlanRange,
@CLinePlanRangeDel1, @CLinePlanRangeDel2, @CLinePlanRangeDel3, @CLinePlanRangeDel4
)


SELECT #tmpLinePlanRange.*, 
pLinePlanFinancial.LinePlanFinancialDataType, 
pLinePlanFinancial.LinePlanFinancialDataFormat, 
pLinePlanFinancial.LinePlanFinancialCssClass
FROM #tmpLinePlanRange 
INNER JOIN pLinePlanFinancial ON #tmpLinePlanRange.LinePlanFinancialID = pLinePlanFinancial.LinePlanFinancialID


DROP TABLE #tmpLinePlanRange










GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanColorItemTemp_INSERT]'
GO

CREATE PROCEDURE [dbo].[spx_LinePlanColorItemTemp_INSERT] (
@LinePlanColorItemID UNIQUEIDENTIFIER , 
@LinePlanColorGroupID UNIQUEIDENTIFIER 
)
AS

IF (SELECT COUNT(*) FROM pLinePlanColorItemTemp WHERE LinePlanColorItemID = @LinePlanColorItemID 
	AND LinePlanColorGroupID = @LinePlanColorGroupID) = 0

BEGIN
	INSERT INTO pLinePlanColorItemTemp (LinePlanId, LinePlanRangeID, ColorPaletteID, LinePlanColorGroupID, LinePlanColorItemID)
	SELECT LinePlanID, LinePlanRangeID, ColorPaletteID, @LinePlanColorGroupID, @LinePlanColorItemID FROM pLinePlanColorItem 
		WHERE LinePlanColorItemID = @LinePlanColorItemID 
END



















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[xCustom9]'
GO
ALTER TABLE [dbo].[xCustom9] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_xCustom9_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_xCustom9] on [dbo].[xCustom9]'
GO
ALTER TABLE [dbo].[xCustom9] ADD CONSTRAINT [PK_xCustom9] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSeasonYear_SELECT]'
GO


ALTER PROCEDURE [dbo].[spx_StyleSeasonYear_SELECT](@StyleId uniqueidentifier)
AS 

SELECT pSeasonYear.Season + ' ' + pSeasonYear.Year AS SeasonYear
FROM  pStyleSeasonYear INNER JOIN
  pSeasonYear ON pStyleSeasonYear.SeasonYearID = pSeasonYear.SeasonYearID
WHERE StyleID = @StyleID
ORDER BY pSeasonYear.CurrentSeason DESC, pSeasonYear.Year DESC  , pSeasonYear.Season

--ORDER BY pSeasonYear.Sort DESC








GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_DesktopAccessFolder_UPDATE]'
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[spx_Group_DesktopAccessFolder_UPDATE] (  
@DeskGroupAccessId uniqueidentifier,  
@DeskAccessId int,  
@mUser nvarchar(200),  
@mDate datetime  
)  
AS   
  
DECLARE @DeskFolderId int  
DECLARE @GroupID  uniqueidentifier  
  
SELECT @DeskFolderId = DeskFolderId, 
       @GroupID     = GroupID 
 FROM  cDeskGroupFolderAccess   
WHERE  DeskGroupAccessId = @DeskGroupAccessId  
  
UPDATE  cDeskGroupFolderAccess  
   SET  DeskAccessId = @DeskAccessId,
               MUser = @mUser,
               MDate = @mDate  
 WHERE  DeskGroupAccessId = @DeskGroupAccessId  
  
--  
--  RESET PERMISIONS FOR USERS
--
   
IF @DeskAccessId  =  0   
BEGIN   
  
 IF  @DeskFolderId  = 2    
 BEGIN  
  DELETE FROM sAccessGroupStyleFolder where GroupID=  @GroupID   
  DELETE FROM sAccessStyleFolder where TeamID IN  ( SELECT DISTINCT TeamID from uUserGroup where GroupID=  @GroupID )   
 END   
  
 ELSE IF @DeskFolderId  = 3  
 BEGIN   
  DELETE FROM sAccessGroupLineFolder where GroupID=  @GroupID   
  DELETE FROM sAccessLineFolder where TeamID IN  ( SELECT DISTINCT TeamID from uUserGroup where GroupID=  @GroupID )    
 END   
   
 ELSE IF @DeskFolderId  = 4  
 BEGIN   
  DELETE FROM sAccessGroupQuotationFolder  where GroupID=  @GroupID   
  DELETE FROM sAccessQuotationFolder  where TeamID IN  ( SELECT DISTINCT TeamID from uUserGroup where GroupID=  @GroupID )   
 END   
  
 ELSE IF @DeskFolderId  = 5  
 BEGIN   
  DELETE FROM sAccessGroupSampleFolder  where GroupID=  @GroupID   
  DELETE FROM sAccessSampleFolder  where TeamID IN  ( SELECT DISTINCT TeamID from uUserGroup where GroupID=  @GroupID )   
 END   
  
 ELSE IF @DeskFolderId  = 6  
 BEGIN  
  DELETE FROM sAccessGroupImageFolder  where GroupID=  @GroupID   
  DELETE FROM sAccessImageFolder  where TeamID IN  ( SELECT DISTINCT TeamID from uUserGroup where GroupID=  @GroupID )   
  
 END   
  
 ELSE IF @DeskFolderId  = 7  
 BEGIN   
  DELETE FROM sAccessGroupColorFolder  where GroupID=  @GroupID   
  DELETE FROM sAccessColorFolder  where TeamID IN  ( SELECT DISTINCT TeamID from uUserGroup where GroupID=  @GroupID )   
 END  
  
 ELSE IF @DeskFolderId  = 8  
 BEGIN  
  DELETE FROM sAccessGroupMaterialFolder where GroupID=  @GroupID   
  DELETE FROM sAccessMaterialFolder where TeamID IN  ( SELECT DISTINCT TeamID from uUserGroup where GroupID=  @GroupID )   
 END  
  
 ELSE IF @DeskFolderId  = 9  
 BEGIN  
  DELETE FROM sAccessGroupComplianceFolder  where GroupID=  @GroupID   
  DELETE FROM sAccessComplianceFolder  where TeamID IN  ( SELECT DISTINCT TeamID from uUserGroup where GroupID=  @GroupID )   
 END  
  
 ELSE IF @DeskFolderId  = 10  
 BEGIN  
  DELETE FROM sAccessGroupControlPanel  where GroupID=  @GroupID   
  DELETE FROM sAccessControlPanel  where TeamID IN  ( SELECT DISTINCT TeamID from uUserGroup where GroupID=  @GroupID )   
 END  
  
 ELSE IF @DeskFolderId  = 11  
 BEGIN   
  DELETE FROM sAccessGroupShareFolder  where GroupID=  @GroupID   
  DELETE FROM sAccessShareFolder  where TeamID IN  ( SELECT DISTINCT TeamID from uUserGroup where GroupID=  @GroupID )    
 END  
 ELSE IF @DeskFolderId  = 12  
 BEGIN   
  DELETE FROM sAccessGroupCosting where GroupID=  @GroupID   
  DELETE FROM sAccessCosting where TeamID IN  ( SELECT DISTINCT TeamID from uUserGroup where GroupID=  @GroupID )    
 END  
ELSE IF @DeskFolderId  = 14  
 BEGIN   
  DELETE FROM sAccessGroupBodyFolder where GroupID=  @GroupID   
  DELETE FROM sAccessBodyFolder where TeamID IN  ( SELECT DISTINCT TeamID from uUserGroup where GroupID=  @GroupID )    
 END 
  
  
END   
    
UPDATE cDeskUserFolderAccess 
   SET DeskAccessId = @DeskAccessId
 WHERE DeskFolderId = @DeskFolderId 
   AND TeamID IN ( SELECT DISTINCT TeamID from uUserGroup where GroupID = @GroupID )   
  
If @DeskFolderId = 10  
BEGIN  
 IF @DeskAccessId = 1  
    BEGIN  
         UPDATE sAccessGroupControlPanel 
            SET   AccessRoleId = 0,   
                    AccessView = 0,   
                  AccessCreate = 0,   
                  AccessModify = 0,   
                  AccessDelete = 0,   
                   AccessPrint = 0,  
                         MUser = @mUser,   
                         MDate = @mDate  
          WHERE GroupID = @GroupID  
      END  
END  
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[dpx_SampleRequestSubmit_SubmitByAgent_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[dpx_SampleRequestSubmit_SubmitByAgent_SELECT]
(
	@SeasonYearID uniqueidentifier = NULL,
	@TradePartnerID uniqueidentifier = NULL
)

AS

IF @SeasonYearID IS NULL OR @SeasonYearID = '00000000-0000-0000-0000-000000000000'
BEGIN 
	SELECT TOP 1 @SeasonYearID = SeasonYearID FROM pSeasonYear WHERE CurrentSeason = 1
END

CREATE TABLE #tempStyleSeasonYear(
	StyleID uniqueidentifier,
	SeasonYearID uniqueidentifier
)

INSERT INTO #tempStyleSeasonYear (StyleID, SeasonYearID)
SELECT StyleID, SeasonYearID FROM pStyleSeasonYear 
WHERE SeasonYearID = @SeasonYearID

SELECT COUNT(*) AS COUNT, dbo.pSampleWorkflow.SampleWorkflow, 
	CASE WHEN pSampleRequestSubmitStatus.StatusID = 0 AND pSampleRequestWorkflow.Submit <> 1 THEN 1
	ELSE pSampleRequestSubmitStatus.StatusID
	END AS StatusID, 
	CASE WHEN pSampleRequestSubmitStatus.StatusID = 0 AND pSampleRequestWorkflow.Submit <> 1 THEN 'Resubmit'
	ELSE pSampleRequestSubmitStatus.Status
	END AS Status
FROM         dbo.pSampleRequestWorkflow INNER JOIN
                      dbo.pSampleWorkflow ON dbo.pSampleRequestWorkflow.SampleWorkflowID = dbo.pSampleWorkflow.SampleWorkflowID INNER JOIN
                      dbo.pSampleRequestSubmitStatus ON dbo.pSampleRequestWorkflow.Status = dbo.pSampleRequestSubmitStatus.StatusID
WHERE pSampleRequestWorkflow.StyleId IN (SELECT StyleID FROM #tempStyleSeasonYear) AND  (dbo.pSampleRequestWorkflow.TradePartnerID = @TradePartnerID)
GROUP BY dbo.pSampleWorkflow.SampleWorkflow, dbo.pSampleRequestSubmitStatus.Status, dbo.pSampleRequestSubmitStatus.StatusID, 
                      dbo.pSampleRequestWorkflow.TradePartnerID, pSampleRequestWorkflow.Submit  
ORDER BY dbo.pSampleRequestSubmitStatus.StatusID


DROP TABLE #tempStyleSeasonYear

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanRangeCurrentRollup3_SELECT]'
GO




ALTER PROCEDURE [dbo].[spx_LinePlanRangeCurrentRollup3_SELECT]
(
@LinePlanIndex varchar(1),
@LinePlanId varchar(40),
@LinePlanAttributeItemId1 varchar(40),
@LinePlanAttributeItemId2 varchar(40),
@LinePlanAttributeItemId3 varchar(40)
)
AS 


DECLARE
	@SLinePlanRangeDelCO4 int,
	@SLinePlanRangeDelNV4 int,
	@SLinePlanRangeDelN4 int,
	@FLinePlanRangeDel4 int,
	@BLinePlanRangeDel4 int,
	@CLinePlanRangeDel4 int,
	
	@SLinePlanRange VARCHAR(100),
	@SLinePlanRangeID UNIQUEIDENTIFIER, 
	@FLinePlanRange VARCHAR(100),
	@FLinePlanRangeID UNIQUEIDENTIFIER, 
	@BLinePlanRange VARCHAR(100),
	@BLinePlanRangeID UNIQUEIDENTIFIER ,
	@CLinePlanRange VARCHAR(100),
	@CLinePlanRangeID UNIQUEIDENTIFIER 


CREATE TABLE #tmpLinePlanRange(
	LinePlanRangeID uniqueidentifier NULL,
	LinePlanID uniqueidentifier NULL,
	LinePlanFinancialID uniqueidentifier NULL,
	LinePlanRange nvarchar(100) NULL,

	LinePlanAttributeItemID1 uniqueidentifier NULL,
	LinePlanAttributeItemID2 uniqueidentifier NULL,
	LinePlanAttributeItemID3 uniqueidentifier NULL,
	LinePlanAttributeItemID4 uniqueidentifier NULL,


	LinePlanRangeDelCO1 int NULL,
	LinePlanRangeDelNV1 int NULL,
	LinePlanRangeDelN1 int NULL,
	LinePlanRangeDelTL1 int NULL,

	LinePlanRangeDelCO2 int NULL,
	LinePlanRangeDelNV2 int NULL,
	LinePlanRangeDelN2 int NULL,
	LinePlanRangeDelTL2 int NULL,

	LinePlanRangeDelCO3 int NULL,
	LinePlanRangeDelNV3 int NULL,
	LinePlanRangeDelN3 int NULL,
	LinePlanRangeDelTL3 int NULL,

	LinePlanRangeDelCO4 int NULL,
	LinePlanRangeDelNV4 int NULL,
	LinePlanRangeDelN4 int NULL,
	LinePlanRangeDelTL4 int NULL,

	LinePlanRangeDelAVCO int NULL,
	LinePlanRangeDelAVNV int NULL,
	LinePlanRangeDelAVN int NULL,
	LinePlanRangeSort varchar(5) NULL
)


SET @SLinePlanRangeDelCO4 = 0 
SET @SLinePlanRangeDelNV4 = 0 
SET @SLinePlanRangeDelN4 = 0 
SET @FLinePlanRangeDel4 = 0 
SET @BLinePlanRangeDel4 = 0 
SET @CLinePlanRangeDel4 = 0 

DECLARE @LinePlanRangeID UNIQUEIDENTIFIER

SELECT @LinePlanRangeID =  LinePlanRangeID FROM pLinePlanRange 
WHERE LinePlanAttributeItemId1 = @LinePlanAttributeItemId1
AND LinePlanAttributeItemId2 = @LinePlanAttributeItemId2
AND LinePlanAttributeItemId3 = @LinePlanAttributeItemId3
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'


SELECT b.MostLikelyVendor, b.TradePartnerVendorID, e.LinePlanRangeTypeID , c.StyleID , g.MaterialID, h.BodyID, -- c.StyleSourcingID , c.StyleColorID , 
f.ColorPaletteID,
d.StyleColorDelivery1,d.StyleColorDelivery2, d.StyleColorDelivery3, d.StyleColorDelivery4
INTO #tmp
FROM pStyleQuoteItem c 
INNER JOIN pStyleSourcing a ON a.StyleSourcingID =  c.StyleSourcingID
INNER JOIN pStyleSeasonYear b ON b.StyleSeasonYearID = a.StyleSeasonYearID
INNER JOIN pStyleColorwaySeasonYear d ON  ( d.StyleSeasonYearID = b.StyleSeasonYearID AND d.StyleColorwayID =  c.StyleColorID )
INNER JOIN pLinePlanItem e ON e.LinePlanItemID =  b.LinePlanItemID 
INNER JOIN pStyleColorway f ON f.StyleColorID = d.StyleColorwayID 
INNER JOIN pStyleHeader h ON h.StyleID = c.StyleID 
LEFT OUTER JOIN pStyleMaterials g ON g.StyleID = c.StyleID 
WHERE b.LinePlanItemID  IN ( 
	SELECT a.LinePlanItemID
	FROM pLinePlanItem a
	WHERE a.LinePlanID = @LinePlanID
	AND a.StyleID <>  '00000000-0000-0000-0000-000000000000'
	AND a.LinePlanRangeID = @LinePlanRangeID
) 
AND c.StyleQuoteItemStatusID = 3 
AND d.StyleColorStatus = 200
AND b.TradePartnerVendorID IS NOT NULL
AND g.MainMaterial = 1  
ORDER BY e.LinePlanRangeTypeID , c.StyleID



---  =======================================================================================================
--- DELIVERY 1 
DECLARE
	@SLinePlanRangeDelCO1 int,	@SLinePlanRangeDelNV1 int,	@SLinePlanRangeDelN1 int,
	@FLinePlanRangeDel1 int,	@BLinePlanRangeDel1 int,	@CLinePlanRangeDel1 int



SELECT @SLinePlanRangeDelCO1 = COUNT(DISTINCT StyleID) FROM #tmp WHERE StyleColorDelivery1 = 1 AND LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001'
SELECT @SLinePlanRangeDelN1  = COUNT(DISTINCT StyleID) FROM #tmp WHERE StyleColorDelivery1 = 1 AND LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003'
SELECT @SLinePlanRangeDelNV1  =  0
SELECT @FLinePlanRangeDel1 = COUNT(DISTINCT MaterialID) FROM #tmp WHERE StyleColorDelivery1 = 1 AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' ) AND MaterialID IS NOT NULL
SELECT @BLinePlanRangeDel1 = COUNT(DISTINCT BodyID) FROM #tmp WHERE StyleColorDelivery1 = 1 AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' ) AND BodyID IS NOT NULL
SELECT @CLinePlanRangeDel1 =  COUNT(DISTINCT(ColorPaletteID)) FROM #tmp WHERE StyleColorDelivery1 = 1 AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' )


/*
SELECT @SLinePlanRangeDelCO1 AS SLinePlanRangeDelCO1,
@SLinePlanRangeDelN1  AS SLinePlanRangeDelN1 ,
@FLinePlanRangeDel1 AS FLinePlanRangeDel1,
@BLinePlanRangeDel1  AS BLinePlanRangeDel1,
@CLinePlanRangeDel1  AS CLinePlanRangeDel1 
*/

---  =======================================================================================================
--- DELIVERY 2
DECLARE
	@SLinePlanRangeDelCO2 int,	@SLinePlanRangeDelNV2 int,	@SLinePlanRangeDelN2 int,
	@FLinePlanRangeDel2 int,	@BLinePlanRangeDel2 int,	@CLinePlanRangeDel2 int

SELECT @SLinePlanRangeDelCO2 = COUNT(DISTINCT StyleID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1) AND LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001'
SELECT @SLinePlanRangeDelN2  = COUNT(DISTINCT StyleID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1) AND LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003'
SELECT @SLinePlanRangeDelNV2  =  0
SELECT @FLinePlanRangeDel2 = COUNT(DISTINCT MaterialID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1) AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' ) AND MaterialID IS NOT NULL
SELECT @BLinePlanRangeDel2 = COUNT(DISTINCT BodyID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1) AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' ) AND BodyID IS NOT NULL
SELECT @CLinePlanRangeDel2 =  COUNT(DISTINCT(ColorPaletteID)) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1) AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' )

/*
SELECT @SLinePlanRangeDelCO2 AS SLinePlanRangeDelCO2,
@SLinePlanRangeDelN2  AS SLinePlanRangeDelN2 ,
@FLinePlanRangeDel2 AS FLinePlanRangeDel2,
@BLinePlanRangeDel2  AS BLinePlanRangeDel2,
@CLinePlanRangeDel2  AS CLinePlanRangeDel2 
*/


---  =======================================================================================================
--- DELIVERY 3
DECLARE
	@SLinePlanRangeDelCO3 int,	@SLinePlanRangeDelNV3 int,	@SLinePlanRangeDelN3 int,
	@FLinePlanRangeDel3 int,	@BLinePlanRangeDel3 int,	@CLinePlanRangeDel3 int

SELECT @SLinePlanRangeDelCO3 = COUNT(DISTINCT StyleID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1 OR StyleColorDelivery3 = 1) AND LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001'
SELECT @SLinePlanRangeDelN3  = COUNT(DISTINCT StyleID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1 OR StyleColorDelivery3 = 1) AND LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003'
SELECT @SLinePlanRangeDelNV3  =  0
SELECT @FLinePlanRangeDel3 = COUNT(DISTINCT MaterialID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1 OR StyleColorDelivery3 = 1) AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' ) AND MaterialID IS NOT NULL
SELECT @BLinePlanRangeDel3 = COUNT(DISTINCT BodyID) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1 OR StyleColorDelivery3 = 1) AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' ) AND BodyID IS NOT NULL
SELECT @CLinePlanRangeDel3 =  COUNT(DISTINCT(ColorPaletteID)) FROM #tmp WHERE (StyleColorDelivery1 = 1 OR StyleColorDelivery2 = 1 OR StyleColorDelivery3 = 1) AND ( LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000001' OR LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' )

/*
SELECT @SLinePlanRangeDelCO3 AS SLinePlanRangeDelCO3,
@SLinePlanRangeDelN3  AS SLinePlanRangeDelN3 ,
@FLinePlanRangeDel3 AS FLinePlanRangeDel3,
@BLinePlanRangeDel3  AS BLinePlanRangeDel3,
@CLinePlanRangeDel3  AS CLinePlanRangeDel3 
*/


DROP TABLE  #tmp


SELECT @SLinePlanRange = LinePlanRange, @SLinePlanRangeID = LinePlanRangeID 
FROM   pLinePlanRange
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3
AND	LinePlanId = @LinePlanID
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanRange, LinePlanAttributeItemID1, 
LinePlanAttributeItemID2, LinePlanAttributeItemID3, LinePlanRangeSort, LineplanRangeID


select @FLinePlanRange = LinePlanRange, @FLinePlanRangeID = LinePlanRangeID 
FROM   pLinePlanRange
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000001'
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3
AND	LinePlanId = @LinePlanID
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanRange, LinePlanAttributeItemID1, 
LinePlanAttributeItemID2, LinePlanAttributeItemID3, LinePlanRangeSort, LineplanRangeID

select @CLinePlanRange = LinePlanRange, @CLinePlanRangeID = LinePlanRangeID 
FROM   pLinePlanRange
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000002'
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3
AND	LinePlanId = @LinePlanID
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanRange, LinePlanAttributeItemID1, 
LinePlanAttributeItemID2, LinePlanAttributeItemID3, LinePlanRangeSort, LineplanRangeID

select @BLinePlanRange = LinePlanRange, @BLinePlanRangeID = LinePlanRangeID 
FROM   pLinePlanRange
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000003'
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3
AND	LinePlanId = @LinePlanID
GROUP BY LinePlanID, LinePlanFinancialID, LinePlanRange, LinePlanAttributeItemID1, 
LinePlanAttributeItemID2, LinePlanAttributeItemID3, LinePlanRangeSort, LineplanRangeID




INSERT INTO #tmpLinePlanRange (
LinePlanID, LineplanRangeID, LinePlanFinancialID, LinePlanRange, 
LinePlanRangeDelCO1, LinePlanRangeDelNV1, LinePlanRangeDelN1, LinePlanRangeDelTL1, 
LinePlanRangeDelCO2, LinePlanRangeDelNV2, LinePlanRangeDelN2, LinePlanRangeDelTL2, 
LinePlanRangeDelCO3, LinePlanRangeDelNV3, LinePlanRangeDelN3, LinePlanRangeDelTL3, 
LinePlanRangeDelCO4, LinePlanRangeDelNV4, LinePlanRangeDelN4, LinePlanRangeDelTL4 )
VALUES (
@LinePlanID,@SLineplanRangeID ,'10000000-0000-0000-0000-000000000004', @SLinePlanRange,
@SLinePlanRangeDelCO1, @SLinePlanRangeDelNV1, @SLinePlanRangeDelN1, @SLinePlanRangeDelCO1+@SLinePlanRangeDelNV1+@SLinePlanRangeDelN1,
@SLinePlanRangeDelCO2, @SLinePlanRangeDelNV2, @SLinePlanRangeDelN2, @SLinePlanRangeDelCO2+@SLinePlanRangeDelNV2+@SLinePlanRangeDelN2,
@SLinePlanRangeDelCO3, @SLinePlanRangeDelNV3, @SLinePlanRangeDelN3, @SLinePlanRangeDelCO3+@SLinePlanRangeDelNV3+@SLinePlanRangeDelN3,
@SLinePlanRangeDelCO4, @SLinePlanRangeDelNV4, @SLinePlanRangeDelN4, @SLinePlanRangeDelCO4+@SLinePlanRangeDelNV4+@SLinePlanRangeDelN4 )


INSERT INTO #tmpLinePlanRange (
LinePlanID, LineplanRangeID, LinePlanFinancialID, LinePlanRange, 
LinePlanRangeDelTL1, LinePlanRangeDelTL2, LinePlanRangeDelTL3, LinePlanRangeDelTL4 )
VALUES (
@LinePlanID,@FLineplanRangeID ,'10000000-0000-0000-0000-000000000001', @FLinePlanRange,
@FLinePlanRangeDel1, @FLinePlanRangeDel2, @FLinePlanRangeDel3, @FLinePlanRangeDel4
)

INSERT INTO #tmpLinePlanRange (
LinePlanID, LineplanRangeID, LinePlanFinancialID, LinePlanRange, 
LinePlanRangeDelTL1, LinePlanRangeDelTL2, LinePlanRangeDelTL3, LinePlanRangeDelTL4 )
VALUES (
@LinePlanID,@BLineplanRangeID ,'10000000-0000-0000-0000-000000000003', @BLinePlanRange,
@BLinePlanRangeDel1, @BLinePlanRangeDel2, @BLinePlanRangeDel3, @BLinePlanRangeDel4
)


INSERT INTO #tmpLinePlanRange (
LinePlanID, LineplanRangeID, LinePlanFinancialID, LinePlanRange, 
LinePlanRangeDelTL1, LinePlanRangeDelTL2, LinePlanRangeDelTL3, LinePlanRangeDelTL4 )
VALUES (
@LinePlanID,@CLineplanRangeID ,'10000000-0000-0000-0000-000000000002', @CLinePlanRange,
@CLinePlanRangeDel1, @CLinePlanRangeDel2, @CLinePlanRangeDel3, @CLinePlanRangeDel4
)


SELECT #tmpLinePlanRange.*, 
pLinePlanFinancial.LinePlanFinancialDataType, 
pLinePlanFinancial.LinePlanFinancialDataFormat, 
pLinePlanFinancial.LinePlanFinancialCssClass
FROM #tmpLinePlanRange 
INNER JOIN pLinePlanFinancial ON #tmpLinePlanRange.LinePlanFinancialID = pLinePlanFinancial.LinePlanFinancialID


DROP TABLE #tmpLinePlanRange










GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanItemColor_SELECT]'
GO


ALTER PROCEDURE [dbo].[spx_LinePlanItemColor_SELECT](
@LinePlanID UNIQUEIDENTIFIER
)
AS

SELECT pColorPalette.ColorPaletteID, pColorPalette.ColorFolderID, pColorPalette.ColorCode, pColorPalette.ColorName, pColorPalette.ColorSource, 
  pColorPalette.ColorNotes, pColorPalette.Hex, pColorPalette.R, pColorPalette.G, pColorPalette.B, pColorPalette.C, pColorPalette.M, pColorPalette.Y, 
  pColorPalette.K, pColorPalette.H, pColorPalette.S, pColorPalette.L, pColorPalette.LAB_L, pColorPalette.LAB_A, pColorPalette.LAB_B, 
  pColorPalette.CUser, pColorPalette.CDate, pColorPalette.MUser, pColorPalette.MDate, pColorPalette.ColorID, pColorPalette.Change, 
  pColorPalette.Action, pColorPalette.Active, pColorPalette.Sort, pColorPalette.ColorImage, pColorPalette.ColorImageType, 
  pColorPalette.CopyColorPaletteID, pLinePlanColorItem.LinePlanID
FROM pColorPalette INNER JOIN
  pLinePlanColorItem ON pColorPalette.ColorPaletteID = pLinePlanColorItem.ColorPaletteID
WHERE pLinePlanColorItem.LinePlanID = @LinePlanID
ORDER BY pColorPalette.ColorName
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSeasonYear_SELECTED]'
GO

ALTER PROCEDURE [dbo].[spx_StyleSeasonYear_SELECTED]  (
@StyleID UNIQUEIDENTIFIER
)
AS 

/*
SELECT  SeasonYearID , [Season] + ' ' + [Year] AS SeasonYear FROM  pSeasonYear 
WHERE SeasonYearID IN (SELECT SeasonYearID FROM pStyleSeasonYear WHERE StyleID = @StyleID)
ORDER BY Sort
*/

SELECT b.SeasonYearID , b.Season + ' ' + b.Year AS SeasonYear 
FROM pStyleSeasonYear a
INNER JOIN pSeasonYear b ON a.SeasonYearID = b.SeasonYearID  
WHERE StyleID = @StyleID 
ORDER BY b.CurrentSeason DESC, b.Year DESC, b.Season 













GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleCosting_INSERT]'
GO



ALTER PROCEDURE [dbo].[spx_StyleCosting_INSERT]
(@StyleCostingId uniqueidentifier,
@StyleId uniqueidentifier,
@StyleCostingTypeId int,
@StyleCostingDate datetime,
@StyleCostingStatus nvarchar(200),
@CreatedBy nvarchar(200),
@CreatedDate datetime,
@StyleSeasonYearID UNIQUEIDENTIFIER 
)
AS 

/***********************************************
New statements added by Ryan Cabanas on 8/26/08.
************************************************/
--DECLARE @DUMMY INT
--SELECT 1


/************************************************************
Original statements commented out by Ryan Cabanas on 8/26/08.
*************************************************************/

DECLARE
@Variance decimal(18,3),
@ImportVariance decimal(18,3),
@DomesticVariance decimal(18,3),
@IndirectVariance decimal(18,3),
@Commission decimal(18,3),
@BrokerHarborFee decimal(18,3)

SELECT 
@ImportVariance = ImportVariance,
@DomesticVariance = DomesticVariance,
@IndirectVariance = IndirectVariance,
@Commission = Commission, 
@BrokerHarborFee = BrokerHarborFee 
FROM pStyleCostingPreference 

INSERT INTO dbo.pStyleCosting
(StyleCostingID, StyleID, StyleCostingTypeID, StyleCostingDate, StyleCostingStatus, CUser, CDate, MUser, MDate, Active, StyleSeasonYearID)
VALUES (@StyleCostingId, @StyleId, @StyleCostingTypeId, @StyleCostingDate, @StyleCostingStatus, @CreatedBy, @CreatedDate, @CreatedBy, 
@CreatedDate, 1, @StyleSeasonYearID)


DECLARE @StyleCategoryID uniqueidentifier
SELECT @StyleCategoryID = StyleCategory FROM pStyleHeader WHERE StyleID = @StyleID

DECLARE @FreightType int
DECLARE @ContainerCost bit
DECLARE @FreightMethod int

SELECT @ContainerCost = StyleCategoryContainerCost, @FreightType = StyleCategoryFreightType FROM pStyleCategory WHERE StyleCategoryID = @StyleCategoryID

IF @ContainerCost = 1
	BEGIN
		SET @FreightMethod = 2 --By Boat
	END
ELSE
	BEGIN
		IF @FreightType = 1 SET @FreightMethod = 1 --By Air
		IF @FreightType = 2 SET @FreightMethod = 2 --By BOAT
	END

/*
--Costing Type
1 = Air
2 = Boat
3 = Domestic
4 = Indirect
*/

IF @FreightType = 1
	SET @Variance = @ImportVariance
ELSE IF @FreightType = 2
	SET @Variance = @ImportVariance	
ELSE IF @StyleCostingTypeID = 3
	SET @Variance = @DomesticVariance
ELSE IF @StyleCostingTypeID = 4 
	SET @Variance = @IndirectVariance

DECLARE @CostType int
IF @StyleCostingTypeID = 1
	BEGIN
		IF @FreightType = 1 SET @CostType = 1
		IF @FreightType = 2 SET @CostType = 2
		
	END
ELSE IF @StyleCostingTypeID = 3
	SET @CostType = 3
	
ELSE IF @StyleCostingTypeID = 4
	SET @CostType = 4	 
	

/*
IF @StyleCostingTypeId = 1 
	BEGIN
		SET @FreightType = 1
	END
ELSE IF @StyleCostingTypeId = 2
	BEGIN
		SET @FreightType = 2
	END
ELSE
	BEGIN
		SET @FreightType = 0
	END	
--SELECT @AirCharge = AirCharge, @SeaCharge = SeaCharge FROM pStyleCostingPreference	
*/


DECLARE
@StyleCostingCustomField1 decimal(18,3),	--Sample Weight
@StyleCostingCustomField2 decimal(18,3),	--Target Retail
@StyleCostingCustomField3 decimal(18,3),	--Target Margin %
@StyleCostingCustomField4 decimal(18,3),	--Misc Cost
@StyleCostingCustomField5 int,				--Freight Type
@StyleCostingCustomField6 decimal(18,3),	--Inland Cost
@StyleCostingCustomField7 decimal(18,3),	--Freight Cost 
@StyleCostingCustomField8 decimal(10,3),	--Royalty %
@StyleCostingCustomField9 decimal(18,3),	--Commision %
@StyleCostingCustomField10 decimal(18,3),	--Variance %
@StyleCostingCustomField11 decimal(18,3),	--Duty %
@StyleCostingCustomField12 decimal(18,3),	--Surcharge	
@StyleCostingCustomField13 decimal(18,3),	--Broker Harbor Fee
@StyleCostingCustomField14 decimal(18,3),	--Target First Cost
@StyleCostingCustomField15 decimal(18,3),	--NA
@StyleCostingCustomField16 decimal(18,3),	--Cost Type
@StyleCostingCustomField17 varchar(15),		--Ship Date
@StyleCostingCustomField18 decimal(18,3),	--Units
@StyleCostingCustomField19 decimal(18,3),	--First Cost
@StyleCostingCustomField20 decimal(18,3),	--NA
@StyleCostingCustomField21 decimal(18,3),	--NA
@StyleCostingCustomField22 decimal(18,3),	--NA
@StyleCostingCustomField23 decimal(18,3),	--NA
@StyleCostingCustomField24 decimal(18,3),	--NA	
@StyleCostingCustomField25 decimal(18,3),	--NA	
@StyleCostingCustomField26 decimal(18,3),	--NA	
@StyleCostingCustomField27 decimal(18,3),	--NA	
@StyleCostingCustomField28 decimal(18,3),	--NA
@StyleCostingCustomField29 decimal(18,3),	--NA	
@StyleCostingCustomField30 decimal(18,3)	--NA


	SET @StyleCostingCustomField1 = 0 
	SET @StyleCostingCustomField2 = 0 
    SET @StyleCostingCustomField3 = 0 
    SET @StyleCostingCustomField4 = 0 
    SET @StyleCostingCustomField5 = @FreightType 
    SET @StyleCostingCustomField6 = 0 
    SET @StyleCostingCustomField7 = 0 
    SET @StyleCostingCustomField8 = 0 
    SET @StyleCostingCustomField9 = @Commission
	SET @StyleCostingCustomField10 = @Variance
    SET @StyleCostingCustomField11 = 0 
    SET @StyleCostingCustomField12 = 0 
    SET @StyleCostingCustomField13 = @BrokerHarborFee 
    SET @StyleCostingCustomField14 = 0 
    SET @StyleCostingCustomField15 = 0 
    SET @StyleCostingCustomField16 = @CostType
    SET @StyleCostingCustomField17 = NULL 
    SET @StyleCostingCustomField18 = 0 
    SET @StyleCostingCustomField19 = 0 
    SET @StyleCostingCustomField20 = 0 
    SET @StyleCostingCustomField21 = 0 
    SET @StyleCostingCustomField22 = 0 
    SET @StyleCostingCustomField23 = 0 
    SET @StyleCostingCustomField24 = 0 
    SET @StyleCostingCustomField25 = NULL 
    SET @StyleCostingCustomField26 = NULL 
    SET @StyleCostingCustomField27 = NULL 
    SET @StyleCostingCustomField28 = NULL 
    SET @StyleCostingCustomField29 = NULL 
    SET @StyleCostingCustomField30 = NULL


DECLARE @WeightVolume int
IF @StyleCostingTypeID = 1  
	BEGIN
		IF @ContainerCost =1
			SET @WeightVolume = 2
		ELSE
			SET @WeightVolume = 1 		
	END
ELSE 
	BEGIN
		SET @WeightVolume = 1 
	END

UPDATE dbo.pStyleCosting
SET 
    StyleQuotaDutyID = '{00000000-0000-0000-0000-000000000000}',	
    StyleCostingFreightTypeID = @WeightVolume,
    StyleCostingCustomField1 = @StyleCostingCustomField1, 
    StyleCostingCustomField2 = @StyleCostingCustomField2, 
    StyleCostingCustomField3 = @StyleCostingCustomField3, 
    StyleCostingCustomField4 = @StyleCostingCustomField4, 
    StyleCostingCustomField5 = @StyleCostingCustomField5, 
    StyleCostingCustomField6 = @StyleCostingCustomField6, 
    StyleCostingCustomField7 = @StyleCostingCustomField7, 
    StyleCostingCustomField8 = @StyleCostingCustomField8, 
    StyleCostingCustomField9 = @StyleCostingCustomField9, 
    StyleCostingCustomField10 = @StyleCostingCustomField10, 
    StyleCostingCustomField11 = @StyleCostingCustomField11, 
    StyleCostingCustomField12 = @StyleCostingCustomField12, 
    StyleCostingCustomField13 = @StyleCostingCustomField13, 
    StyleCostingCustomField14 = @StyleCostingCustomField14, 
    StyleCostingCustomField15 = @StyleCostingCustomField15, 
    StyleCostingCustomField16 = @StyleCostingCustomField16, 
    StyleCostingCustomField17 = @StyleCostingCustomField17, 
    StyleCostingCustomField18 = @StyleCostingCustomField18, 
    StyleCostingCustomField19 = @StyleCostingCustomField19, 
    StyleCostingCustomField20 = @StyleCostingCustomField20, 
    StyleCostingCustomField21 = @StyleCostingCustomField21, 
    StyleCostingCustomField22 = @StyleCostingCustomField22, 
    StyleCostingCustomField23 = @StyleCostingCustomField23, 
    StyleCostingCustomField24 = @StyleCostingCustomField24, 
    StyleCostingCustomField25 = @StyleCostingCustomField25, 
    StyleCostingCustomField26 = @StyleCostingCustomField26, 
    StyleCostingCustomField27 = @StyleCostingCustomField27, 
    StyleCostingCustomField28 = @StyleCostingCustomField28, 
    StyleCostingCustomField29 = @StyleCostingCustomField29, 
    StyleCostingCustomField30 = @StyleCostingCustomField30
WHERE  (StyleCostingID = @StyleCostingId)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_LinePlanColor_SEL]'
GO
ALTER VIEW dbo.vwx_LinePlanColor_SEL
AS
SELECT     TOP (100) PERCENT dbo.pLinePlanColor.LinePlanColorID, dbo.pLinePlanColor.LinePlanID, dbo.pLinePlanColor.CUser, dbo.pLinePlanColor.CDate, 
                      dbo.pLinePlanColor.MUser, dbo.pLinePlanColor.MDate, dbo.pColorPalette.ColorPaletteID, dbo.pColorPalette.ColorFolderID, 
                      dbo.pColorPalette.ColorCode, dbo.pColorPalette.ColorName, dbo.pColorPalette.ColorSource, dbo.pColorPalette.ColorNotes, dbo.pColorPalette.Hex, 
                      dbo.pColorPalette.ColorImage, dbo.pColorPalette.ColorImageType, dbo.pColorPalette.CopyColorPaletteID, dbo.pColorPalette.Active, 
                      dbo.pColorPalette.Sort
FROM         dbo.pColorPalette INNER JOIN
                      dbo.pLinePlanColor ON dbo.pColorPalette.ColorPaletteID = dbo.pLinePlanColor.ColorPaletteID
ORDER BY dbo.pColorPalette.ColorName


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[dpx_SampleRequestSubmit_SubmitByStyle_SELECT]'
GO
CREATE PROCEDURE [dbo].[dpx_SampleRequestSubmit_SubmitByStyle_SELECT]
(
	@SeasonYearID uniqueidentifier = NULL,
	@TradePartnerID uniqueidentifier
)

AS

IF @SeasonYearID IS NULL OR @SeasonYearID = '00000000-0000-0000-0000-000000000000'
BEGIN 
	SELECT TOP 1 @SeasonYearID = SeasonYearID FROM pSeasonYear WHERE CurrentSeason = 1
END

CREATE TABLE #tempStyleSeasonYear(
	StyleID uniqueidentifier,
	SeasonYearID uniqueidentifier
)

INSERT INTO #tempStyleSeasonYear (StyleID, SeasonYearID)
SELECT StyleID, SeasonYearID FROM pStyleSeasonYear 
WHERE SeasonYearID = @SeasonYearID

SELECT TOP (100) PERCENT COUNT(*) AS COUNT, dbo.pSampleWorkflow.SampleWorkflow, 
	CASE WHEN pSampleRequestSubmitStatus.StatusID = 0 AND pSampleRequestWorkflow.Submit <> 1 THEN 1
	ELSE pSampleRequestSubmitStatus.StatusID
	END AS StatusID, 
	CASE WHEN pSampleRequestSubmitStatus.StatusID = 0 AND pSampleRequestWorkflow.Submit <> 1 THEN 'Resubmit'
	ELSE pSampleRequestSubmitStatus.Status
	END AS Status, dbo.pStyleHeader.StyleNo, 
	dbo.pStyleHeader.Description,  dbo.pSampleRequestWorkflow.Submit, pSampleRequestWorkflow.SampleWorkflowID, 
	dbo.pStyleHeader.StyleID
FROM dbo.pSampleRequestWorkflow INNER JOIN
	dbo.pSampleWorkflow ON dbo.pSampleRequestWorkflow.SampleWorkflowID = dbo.pSampleWorkflow.SampleWorkflowID INNER JOIN
	dbo.pSampleRequestSubmitStatus ON dbo.pSampleRequestWorkflow.Status = dbo.pSampleRequestSubmitStatus.StatusID INNER JOIN
	dbo.pStyleHeader ON dbo.pSampleRequestWorkflow.StyleID = dbo.pStyleHeader.StyleID
WHERE pSampleRequestWorkflow.StyleId IN (SELECT StyleID FROM #tempStyleSeasonYear) AND  (dbo.pSampleRequestWorkflow.TradePartnerID = @TradePartnerID)
GROUP BY dbo.pSampleWorkflow.SampleWorkflow, dbo.pSampleRequestSubmitStatus.Status, dbo.pSampleRequestSubmitStatus.StatusID, 
	dbo.pSampleRequestWorkflow.TradePartnerID, dbo.pStyleHeader.StyleNo, dbo.pSampleRequestWorkflow.Submit, pSampleRequestWorkflow.SampleWorkflowID,
	dbo.pStyleHeader.Description, dbo.pStyleHeader.StyleID
ORDER BY pStyleHeader.StyleNo, pSampleRequestWorkflow.SampleWorkflowID

DROP TABLE #tempStyleSeasonYear
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleColorwayDelivery_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_StyleColorwayDelivery_SELECT]  (
@StyleID UNIQUEIDENTIFIER, 
@SeasonYearID UNIQUEIDENTIFIER 
)
AS 


SELECT a.StylecolorwaySeasonYearId , a.StyleSeasonYearID , a.StyleColorwayID ,a.StyleID, 
a.StyleColorDelivery1, a.StyleColorDelivery2, a.StyleColorDelivery3, a.StyleColorDelivery4,
a.StyleColorStatus, a.Units, a.CustomField1, a.ColorType, a.SampleStatus,
c.StyleColorID, d.ColorPaletteID , d.ColorFolderID, d.ColorName
FROM pStyleColorwaySeasonYear a
INNER JOIN pStyleSeasonYear b ON a.StyleSeasonYearID = b.StyleSeasonYearID 
INNER JOIN pStyleColorway c ON  a.StyleColorwayID = c.StyleColorID 
INNER JOIN pColorPalette d ON c.ColorPaletteID = d.ColorPaletteID
WHERE b.SeasonYearID = @SeasonYearID
AND b.StyleID = @StyleID
ORDER BY c.Sort, c.StyleColorName





















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanItemColorNewCopy_SELECT]'
GO


ALTER PROCEDURE [dbo].[spx_LinePlanItemColorNewCopy_SELECT] (
@LinePlanID UNIQUEIDENTIFIER,
@LinePlanRangeID UNIQUEIDENTIFIER
)
AS

SELECT pColorPalette.ColorPaletteID, pColorPalette.ColorFolderID, pColorPalette.ColorCode, pColorPalette.ColorName, pColorPalette.ColorSource, pColorPalette.ColorNotes, 
      pColorPalette.Hex, pColorPalette.R, pColorPalette.G, pColorPalette.B, pColorPalette.C, pColorPalette.M, pColorPalette.Y, pColorPalette.K, pColorPalette.H, 
      pColorPalette.S, pColorPalette.L, pColorPalette.LAB_L, pColorPalette.LAB_A, pColorPalette.LAB_B, pColorPalette.CUser, pColorPalette.CDate, pColorPalette.MUser, 
      pColorPalette.MDate, pColorPalette.ColorID, pColorPalette.Change, pColorPalette.Action, pColorPalette.Active, pColorPalette.Sort, pColorPalette.ColorImage, 
      pColorPalette.ColorImageType, pColorPalette.CopyColorPaletteID, pLinePlanColorItem.LinePlanID, pLinePlanColorItem.LinePlanColorItemID, 
      pLinePlanColorItem.LinePlanColorID, pLinePlanColorItem.LinePlanRangeID,
'<img src="../System/Control/ColorStream.ashx?S=20&CFID=' + CAST(pColorPalette.ColorFolderID AS NVARCHAR(50)) 
+ '&CPID=' + CAST(pColorPalette.ColorPaletteID AS NVARCHAR(50)) +  '" border="0" />'
 AS ColorUrl, 0 AS Units, 
0 AS StyleColorDelivery1,
0 AS StyleColorDelivery2,
0 AS StyleColorDelivery3,
0 AS StyleColorDelivery4

FROM  pColorPalette INNER JOIN
      pLinePlanColorItem ON pColorPalette.ColorPaletteID = pLinePlanColorItem.ColorPaletteID
WHERE pLinePlanColorItem.LinePlanID = @LinePlanID AND pLinePlanColorItem.LinePlanRangeID IN (SELECT LinePlanRangeID FROM pLinePlanRange WHERE 
        LinePlanFinancialID = '10000000-0000-0000-0000-000000000002' AND
        (ISNULL(CAST(LinePlanAttributeItemID1 AS VARCHAR(40)),'') + ISNULL(CAST(LinePlanAttributeItemID2 AS VARCHAR(40)),'') + ISNULL(CAST(LinePlanAttributeItemID3 AS VARCHAR(40)),'') + ISNULL(CAST(LinePlanAttributeItemID4 AS VARCHAR(40)),'')) IN 
        (SELECT ISNULL(CAST(LinePlanAttributeItemID1 AS VARCHAR(40)),'') + ISNULL(CAST(LinePlanAttributeItemID2 AS VARCHAR(40)),'') + ISNULL(CAST(LinePlanAttributeItemID3 AS VARCHAR(40)),'') + ISNULL(CAST(LinePlanAttributeItemID4 AS VARCHAR(40)),'') 
        FROM pLinePlanRange WHERE LinePlanRangeID = @LinePlanRangeID))
ORDER BY pColorPalette.ColorName





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleRequestGroupTemp_INSERT]'
GO


ALTER PROCEDURE [dbo].[spx_SampleRequestGroupTemp_INSERT]
(
@SampleRequestGroupID uniqueidentifier,
@StyleID uniqueidentifier,
@TechPackID uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate nvarchar(100),
@SeasonYearID NVARCHAR(40) = NULL 
)

AS

IF (SELECT COUNT(*) FROM pSampleRequestGroupTemp WITH (NOLOCK) WHERE SampleRequestGroupID = @SampleRequestGroupID)  = 0

	BEGIN
		 INSERT INTO pSampleRequestGroupTemp
        		 (SampleRequestGroupID, StyleID, TechPackID, CUser, CDate, MUser, MDate , SeasonYearID)
		VALUES (@SampleRequestGroupID, @StyleID, @TechPackID,  @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate, @SeasonYearID)
	END	
	
ELSE

	BEGIN
	
		UPDATE pSampleRequestGroupTemp
		SET  TechPackID = @TechPackID, StyleID = @StyleID, MUser = @CreatedBy, MDate = @CreatedDate , 
		SeasonYearID = @SeasonYearID
		WHERE (SampleRequestGroupID = @SampleRequestGroupID)
	
	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_TradePartnerVendor_Rate_INSERT]'
GO
CREATE PROCEDURE [dbo].[spx_TradePartnerVendor_Rate_INSERT] (
@TradePartnerVendorRateID UNIQUEIDENTIFIER,
@NewTradePartnerVendorRateID UNIQUEIDENTIFIER,
@FieldsSelected NVARCHAR(4000) ,
@CUser NVARCHAR(200), 
@CDate DATETIME 
)
AS 
	
INSERT INTO  pTradePartnerVendorRate ( TradePartnerVendorRateID , CUser, CDate, MUser, MDate )
VALUES (@NewTradePartnerVendorRateID, @CUser, @CDate, @CUser, @CDate )  
	
/***
** Copy all Items
***/	
DECLARE @SQL AS NVARCHAR(4000)
IF LEN (@FieldsSelected) > 0 
BEGIN 
	SET @SQL = 'INSERT INTO pTradePartnerVendorRateItem( TradepartnerVendorRateItemID, TradePartnerVendorRateID, StyleCategoryID, 
	CDate, CUser, MUser, MDate, ' +  @FieldsSelected + ') 
	SELECT NewID(), ''' + CAST(@NewTradePartnerVendorRateID AS NVARCHAR(40))  + ''', StyleCategoryID, '''  +
	CAST(@CDate AS NVARCHAR(20))  + ''', ''' +  @CUser + ''',  ''' +  @CUser + ''',  ''' +  CAST(@CDate AS NVARCHAR(20)) + ''', ' + @FieldsSelected + '
	FROM pTradePartnerVendorRateItem WHERE TradePartnerVendorRateID =  '''  + CAST(@TradePartnerVendorRateID  AS NVARCHAR(40)) + ''' '
END 
ELSE 
BEGIN
	SET @SQL = 'INSERT INTO pTradePartnerVendorRateItem( TradepartnerVendorRateItemID, TradePartnerVendorRateID, StyleCategoryID, 
	CDate, CUser, MUser, MDate )   
	SELECT NewID(), ''' + CAST(@NewTradePartnerVendorRateID AS NVARCHAR(40))  + ''', StyleCategoryID, '''  +
	CAST(@CDate AS NVARCHAR(20))  + ''', ''' +  @CUser + ''',  ''' +  @CUser + ''',  ''' +  CAST(@CDate AS NVARCHAR(20)) + '''  
	FROM pTradePartnerVendorRateItem WHERE TradePartnerVendorRateID =  '''  + CAST(@TradePartnerVendorRateID  AS NVARCHAR(40)) + ''' '
END 

PRINT @SQL 
EXEC (@SQL) 
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_DesktopAccessImageFolderCheck_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_Group_DesktopAccessImageFolderCheck_INSERT] (
@GroupID uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

DECLARE @I as int
DECLARE @Row_Count int
DECLARE @ImageTypeID uniqueidentifier
DECLARE @DeskAccessId int
DECLARE @DeskTableName varchar(100)
DECLARE @DeskTableKey varchar(50)


	BEGIN
	CREATE TABLE #TempUserAccess (
		Id int IDENTITY (1, 1) NOT NULL , 
		ImageTypeID uniqueidentifier NOT NULL,
		GroupID  uniqueidentifier
	) 
	END

	BEGIN
	
	INSERT INTO #TempUserAccess(ImageTypeID) SELECT ImageTypeID FROM pImageType WHERE Active = 1
	
	
	SET @Row_Count = (SELECT COUNT(*) FROM #TempUserAccess)
	
	SET @I = 1

	WHILE @I <= @Row_Count 
		BEGIN

			SELECT @ImageTypeID = ImageTypeID FROM #TempUserAccess WHERE ID = @I
			IF (SELECT COUNT(*) FROM sAccessGroupImageFolder WITH (NOLOCK) WHERE ImageTypeId = @ImageTypeId AND GroupID = @GroupID  ) = 0
			BEGIN
				INSERT INTO sAccessGroupImageFolder
					(ImageTypeId, GroupID,  CUser, CDate, MUser, MDate)
				SELECT ImageTypeId, @GroupID , @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate 
				FROM  #TempUserAccess WHERE Id = @I
			END
				
			SET @I = @I + 1
		END

		SELECT * FROM #tempUserAccess

	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleMaterialLink_INSERT]'
GO




/*
Comments:

#01 - Ryan Cabanas - 11/5/2008
	The field "StyleColorNo" has been increased from "nvarchar(10)" to "nvarchar(200)" in two temp tables below because this field has been
increased to "nvarchar(200)" in the "pStyelColorway" table and was not updated here.  This procedure has been updated before, but overwritten.
Please do not overwrite this change.  Make your changes, but please do not overwrite this change.
*/



ALTER  PROCEDURE [dbo].[spx_StyleMaterialLink_INSERT]
(
@StyleID uniqueidentifier,
@NewStyleID uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate nvarchar(50)
)
AS

SET NOCOUNT ON

CREATE TABLE [dbo].[#tempStyleMaterials] (
	[RecID] int IDENTITY(1,1)  NOT NULL,
	[StyleMaterialID]  uniqueidentifier ROWGUIDCOL  NOT NULL ,
	[StyleMaterialMasterID] [uniqueidentifier],
	[CopyStyleMaterialID] [uniqueidentifier],
	[MainMaterial] [int],
	[Development] [bit],
	[StyleSet] [int],
	[StyleID] [uniqueidentifier],
	[UOM] [nvarchar] (50),
	[Qty] [nvarchar] (18),
	[MaterialPrice] [money],
	[Ext] [money],
	[MaterialSize] [nvarchar] (200),
	[MaterialID] [uniqueidentifier],
	[MaterialPlacement] [bit],
	[MaterialPlacementCode] [nvarchar] (4),
	[MaterialPlacementDetail] [nvarchar] (200),
	[MaterialImageID] [uniqueidentifier],
	[MaterialImageVersion] [int],
	[NoColorMatch] [int],
	[SupplierID] [nvarchar] (50),
	[ComponentTypeID] [int],
	[MaterialType] [int],
	[MaterialNo] [nvarchar] (50),
	[MaterialName] [nvarchar] (200),
	[A] [nvarchar] (100),
	[B] [nvarchar] (100),
	[C] [nvarchar] (100),
	[D] [nvarchar] (100),
	[E] [nvarchar] (100),
	[F] [nvarchar] (100),
	[G] [nvarchar] (100),
	[H] [nvarchar] (100),
	[I] [nvarchar] (100),
	[J] [nvarchar] (100),
	[K] [nvarchar] (100),
	[L] [nvarchar] (100),
	[M] [nvarchar] (100),
	[N] [nvarchar] (100),
	[O] [nvarchar] (100),
	[P] [nvarchar] (100),
	[Q] [nvarchar] (100),
	[R] [nvarchar] (100),
	[S] [nvarchar] (100),
	[T] [nvarchar] (100),
	[U] [nvarchar] (100),
	[V] [nvarchar] (100),
	[W] [nvarchar] (100),
	[X] [nvarchar] (100),
	[Y] [nvarchar] (100),
	[Z] [nvarchar] (100),
	[Source] [nvarchar] (200),
	[Notes] [nvarchar] (4000),
	[Placement] [nvarchar] (4000),
	[VendorPrice] [decimal](19, 3),
	[VolumePrice] [decimal](19, 3),
	[VolumePriceMinimum] [nvarchar] (50),
	[VendorProductionMin] [nvarchar] (50),
	[VendorProductionLeadTime] [nvarchar] (50),
	[DetailYesNo] [int],
	[ImageType] [nvarchar] (50),
	[height] [nvarchar] (18),
	[width] [nvarchar] (18),
	[CDate] [datetime],
	[CUser] [nvarchar] (200),
	[MDate] [datetime],
	[MUser] [nvarchar] (200),
	[MChange] [int],
	[SChange] [int],
	[DChange] [int],
	[CChange] [int],
	[Action] [nvarchar] (50),
	[ColorPlacement] [nvarchar] (4000),
	[Artwork] INT,
	[License] INT,
	[Colorway] INT,
	[MaterialSort] [varchar] (5),
	[MaterialTrack] [int],
	[MaterialLinked] [int],
	[MaterialLining] [int]
)

CREATE TABLE [dbo].[#tempCopyStyleMaterials] (
	[RecID] int IDENTITY(1,1)  NOT NULL,
	[StyleMaterialID]  uniqueidentifier ROWGUIDCOL  NOT NULL ,
	[StyleMaterialMasterID] [uniqueidentifier],
	[CopyStyleMaterialID] [uniqueidentifier],
	[MainMaterial] [int],
	[Development] [bit],
	[StyleSet] [int],
	[StyleID] [uniqueidentifier],
	[UOM] [nvarchar] (50),
	[Qty] [nvarchar] (18),
	[MaterialPrice] [money],
	[Ext] [money],
	[MaterialSize] [nvarchar] (200),
	[MaterialID] [uniqueidentifier],
	[MaterialPlacement] [bit],
	[MaterialPlacementCode] [nvarchar] (4),
	[MaterialPlacementDetail] [nvarchar] (200),
	[MaterialImageID] [uniqueidentifier],
	[MaterialImageVersion] [int],
	[NoColorMatch] [int],
	[SupplierID] [nvarchar] (50),
	[ComponentTypeID] [int],
	[MaterialType] [int],
	[MaterialNo] [nvarchar] (50),
	[MaterialName] [nvarchar] (200),
	[A] [nvarchar] (100),
	[B] [nvarchar] (100),
	[C] [nvarchar] (100),
	[D] [nvarchar] (100),
	[E] [nvarchar] (100),
	[F] [nvarchar] (100),
	[G] [nvarchar] (100),
	[H] [nvarchar] (100),
	[I] [nvarchar] (100),
	[J] [nvarchar] (100),
	[K] [nvarchar] (100),
	[L] [nvarchar] (100),
	[M] [nvarchar] (100),
	[N] [nvarchar] (100),
	[O] [nvarchar] (100),
	[P] [nvarchar] (100),
	[Q] [nvarchar] (100),
	[R] [nvarchar] (100),
	[S] [nvarchar] (100),
	[T] [nvarchar] (100),
	[U] [nvarchar] (100),
	[V] [nvarchar] (100),
	[W] [nvarchar] (100),
	[X] [nvarchar] (100),
	[Y] [nvarchar] (100),
	[Z] [nvarchar] (100),
	[Source] [nvarchar] (200),
	[Notes] [nvarchar] (4000),
	[Placement] [nvarchar] (4000),
	[VendorPrice] [decimal](19, 3),
	[VolumePrice] [decimal](19, 3),
	[VolumePriceMinimum] [nvarchar] (50),
	[VendorProductionMin] [nvarchar] (50),
	[VendorProductionLeadTime] [nvarchar] (50),
	[DetailYesNo] [int],
	[ImageType] [nvarchar] (50),
	[height] [nvarchar] (18),
	[width] [nvarchar] (18),
	[CDate] [datetime],
	[CUser] [nvarchar] (200),
	[MDate] [datetime],
	[MUser] [nvarchar] (200),
	[MChange] [int],
	[SChange] [int],
	[DChange] [int],
	[CChange] [int],
	[Action] [nvarchar] (50),
	[ColorPlacement] [nvarchar] (4000),
	[Artwork] INT,
	[License] INT,
	[Colorway] INT,
	[MaterialSort] [varchar] (5),
	[MaterialTrack] [int],
	[MaterialLinked] [int],
	[MaterialLining] [int]
)

CREATE TABLE [dbo].[#tempStyleColorway] (
	[RecID] int IDENTITY(1,1)  NOT NULL,
	[StyleColorID]  uniqueidentifier ROWGUIDCOL  NOT NULL ,
	[StyleID] [uniqueidentifier],
	[StyleSet] [int],
	[StyleColorStandardID] [uniqueidentifier],
	[StyleColorNo] [nvarchar] (200) ,		--Comment #01
	[StyleColorName] [nvarchar] (200) ,
	[MainColor] [nvarchar] (100) ,
	[Sort] [nvarchar] (10) ,
	[Version] [int],
	[CDate] [datetime],
	[CUser] [nvarchar] (200),
	[MDate] [datetime],
	[MUser] [nvarchar] (200) ,
	CopyStyleColorID UNIQUEIDENTIFIER ,
	ColorPaletteID UNIQUEIDENTIFIER 
) 

CREATE TABLE [dbo].[#tempCopyStyleColorway] (
	[RecID] int IDENTITY(1,1)  NOT NULL,
	[StyleColorID]  uniqueidentifier ROWGUIDCOL  NOT NULL ,
	[StyleID] [uniqueidentifier],
	[StyleSet] [int],
	[StyleColorStandardID] [uniqueidentifier],
	[StyleColorNo] [nvarchar] (200) ,		--Comment #01
	[StyleColorName] [nvarchar] (200) ,
	[MainColor] [nvarchar] (100) ,
	[Sort] [nvarchar] (10) ,
	[Version] [int],
	[CDate] [datetime],
	[CUser] [nvarchar] (200),
	[MDate] [datetime],
	[MUser] [nvarchar] (200) ,
	CopyStyleColorID UNIQUEIDENTIFIER , 
	ColorPaletteID UNIQUEIDENTIFIER
) 

CREATE TABLE [dbo].[#tempStyleColorwayItem] (
	[RecID] int IDENTITY(1,1)  NOT NULL,
	[StyleColorItemID]  uniqueidentifier,
	[StyleColorItemMasterID] [uniqueidentifier], 
	[StyleColorID] [uniqueidentifier],
	[StyleID] [uniqueidentifier],
	[StyleSet] [int],
	[StyleMaterialID] [uniqueidentifier],
	[MaterialID] [uniqueidentifier],
	[MaterialColorID] [uniqueidentifier],
	[CDate] [datetime],
	[CUser] [nvarchar] (200),
	[MDate] [datetime],
	[MUser] [nvarchar] (200)
) 

CREATE TABLE [dbo].[#tempCopyStyleColorwayItem] (
	[RecID] int IDENTITY(1,1)  NOT NULL,
	[StyleColorItemID]  uniqueidentifier,
	[StyleColorItemMasterID] [uniqueidentifier], 
	[StyleColorID] [uniqueidentifier],
	[StyleID] [uniqueidentifier],
	[StyleSet] [int],
	[StyleMaterialID] [uniqueidentifier],
	[MaterialID] [uniqueidentifier],
	[MaterialColorID] [uniqueidentifier],
	[CDate] [datetime],
	[CUser] [nvarchar] (200),
	[MDate] [datetime],
	[MUser] [nvarchar] (200)
) 

DECLARE @Row_Count int
DECLARE @Row_Loop int
DECLARE @Row_Color_Count int
DECLARE @Row_Color_Loop int

BEGIN
	INSERT INTO dbo.#tempStyleColorway
    		(StyleColorID, StyleID, StyleSet, StyleColorStandardID, StyleColorNo, StyleColorName, MainColor, Sort, Version, CDate, CUser, MDate, MUser , ColorPaletteID)
	SELECT StyleColorID, StyleID, StyleSet, StyleColorStandardID, StyleColorNo, StyleColorName, MainColor, Sort, Version, @CreatedDate AS CDate, @CreatedBy AS CUser, 
    		@CreatedDate AS MDate, @CreatedBy AS MUser, ColorPaletteID
	FROM dbo.pStyleColorway
	WHERE (StyleID = @StyleID) 


DECLARE @StyleColorID uniqueidentifier 	
DECLARE @NewStyleColorID uniqueidentifier 	
	
SET @Row_Loop = 1
SET @Row_Count = (SELECT COUNT(*) FROM #tempStyleColorway)

	WHILE @Row_Loop <= @Row_Count 
		BEGIN
			
			SELECT @StyleColorID = StyleColorID FROM  #tempStyleColorway WHERE RecID = @Row_Loop
			
				SET @NewStyleColorID = newid()
			
				INSERT INTO dbo.#tempCopyStyleColorway
				(StyleColorID, StyleID, StyleSet, StyleColorStandardID, StyleColorNo, StyleColorName, MainColor, Sort, Version, CDate, CUser, MDate, MUser , CopyStyleColorID, ColorPaletteID)
				SELECT @NewStyleColorID, @NewStyleID, StyleSet, StyleColorStandardID, StyleColorNo, StyleColorName, MainColor, Sort, Version, @CreatedDate AS CDate, @CreatedBy AS CUser, 
				@CreatedDate AS MDate, @CreatedBy AS MUser , CopyStyleColorID, ColorPaletteID
				FROM dbo.pStyleColorway
				WHERE (StyleColorID = @StyleColorID)
					
			
			SET @Row_Loop = @Row_Loop + 1
		END
END	
	
-- FIX StyleColorItemMasterID	
BEGIN	
	INSERT INTO dbo.#tempStyleColorwayItem
	(StyleColorItemID, StyleColorItemMasterID, StyleColorID, StyleID, StyleSet, StyleMaterialID, MaterialID, MaterialColorID, CDate, CUser, MDate, MUser)
	SELECT StyleColorItemID, StyleColorItemMasterID, StyleColorID, StyleID, StyleSet, StyleMaterialID, MaterialID, MaterialColorID, CDate, CUser, MDate, MUser
	FROM  dbo.pStyleColorwayItem
	WHERE (StyleID = @StyleID) 
	
	SET @Row_Loop = 1
	SET @Row_Count = (SELECT COUNT(*) FROM #tempStyleColorwayItem)
	
	DECLARE @StyleColorItemID uniqueidentifier 	
	DECLARE @StyleColorItemMasterID  uniqueidentifier 	

	WHILE @Row_Loop <= @Row_Count 
		BEGIN
			
			SELECT @StyleColorItemMasterID = StyleColorItemMasterID, @StyleColorItemID = StyleColorItemID FROM  #tempStyleColorwayItem WHERE RecID = @Row_Loop
	
			IF @StyleColorItemMasterID IS NULL
			BEGIN
			UPDATE pStyleColorwayItem SET StyleColorItemMasterID = newid() WHERE StyleColorItemID = @StyleColorItemID
			END	
					
			
			SET @Row_Loop = @Row_Loop + 1
		END
			
END	
		
--SELECT * FROM #tempStyleColorway
--SELECT * FROM #tempCopyStyleColorway

---Style Material--------------------------------------------

BEGIN

	INSERT INTO dbo.#tempStyleMaterials
	(StyleMaterialID, MainMaterial, StyleSet, StyleID, UOM, Qty, MaterialPrice, Ext, MaterialSize, MaterialID, MaterialImageID, 
	MaterialImageVersion, NoColorMatch, SupplierID, ComponentTypeID, MaterialType, MaterialNo, MaterialName, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O,
	P, Q, R, S,  T, U, V, W, X, Y, Z,Source, Notes, Placement, VendorPrice, VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, 
	DetailYesNo, ImageType, ColorPlacement, Artwork, License, Colorway, CDate, CUser, MDate, MUser, MChange,  SChange, DChange, 
	CChange, Action, StyleMaterialMasterID, Development, MaterialTrack, MaterialLinked, MaterialSort, MaterialLining)
	SELECT StyleMaterialID, MainMaterial, StyleSet, StyleID, UOM, 
	Qty, MaterialPrice, Ext, MaterialSize, MaterialID, MaterialImageID, MaterialImageVersion, NoColorMatch, SupplierID, 
	ComponentTypeID, MaterialType, MaterialNo, MaterialName, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S,  T, U, V, W, X, Y, Z,Source, Notes, 
	Placement AS Placement, VendorPrice, VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, DetailYesNo, 
	ImageType, ColorPlacement, Artwork, License, Colorway, @CreatedDate AS CDate, @CreatedBy AS CUser, 
	@CreatedDate AS MDate, @CreatedBy AS MUser, MChange, SChange, DChange, CChange, Action, StyleMaterialMasterID, 
	Development, MaterialTrack, MaterialLinked, MaterialSort, MaterialLining
	FROM dbo.pStyleMaterials
	WHERE (StyleID = @StyleID)

	DECLARE @StyleMaterialMasterID uniqueidentifier
	DECLARE @StyleMaterialID uniqueidentifier
	DECLARE @NewStyleMaterialID uniqueidentifier
	DECLARE @Colorway INT

	SET @Row_Loop = 1
	SET @Row_Count = (SELECT COUNT(*) FROM #tempStyleMaterials)
	
	WHILE @Row_Loop <= @Row_Count 
	
		BEGIN
		
			SELECT @StyleMaterialMasterID = StyleMaterialMasterID, @StyleMaterialID = StyleMaterialID, @Colorway = Colorway FROM #tempStyleMaterials WHERE RecID = @Row_Loop
			
			IF @StyleMaterialMasterID IS NULL
			BEGIN
			UPDATE pStyleMaterials SET StyleMaterialMasterID = newid() WHERE StyleMaterialID = @StyleMaterialID
			END
			
			BEGIN
			
				SET @NewStyleMaterialID = newid()
		
				INSERT INTO dbo.#tempCopyStyleMaterials
				(StyleMaterialID, MainMaterial, StyleSet, StyleID, UOM, Qty, MaterialPrice, Ext, MaterialSize, MaterialID, MaterialImageID, 
				MaterialImageVersion, NoColorMatch, SupplierID, ComponentTypeID, MaterialType, MaterialNo, MaterialName, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O,
				P, Q, R, S, T, U, V, W, X, Y, Z,Source, Notes, Placement, VendorPrice, VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, 
				DetailYesNo, ImageType, ColorPlacement, Artwork, License, Colorway, CDate, CUser, MDate, MUser, MChange,  SChange, DChange, 
				CChange, Action, StyleMaterialMasterID, Development, MaterialTrack, MaterialLinked, MaterialSort, MaterialLining)
				SELECT @NewStyleMaterialID, MainMaterial, StyleSet, @NewStyleID AS StyleID, UOM, 
				Qty, MaterialPrice, Ext, MaterialSize, MaterialID, MaterialImageID, MaterialImageVersion, NoColorMatch, SupplierID, 
				ComponentTypeID, MaterialType, MaterialNo, MaterialName, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S,  T, U, V, W, X, Y, Z,Source, Notes, 
				Placement AS Placement, VendorPrice, VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, DetailYesNo, 
				ImageType, ColorPlacement, Artwork, License, Colorway, @CreatedDate AS CDate, @CreatedBy AS CUser, 
				@CreatedDate AS MDate, @CreatedBy AS MUser, MChange, SChange, DChange, CChange, Action, StyleMaterialMasterID, 
				Development, MaterialTrack, MaterialLinked, MaterialSort, MaterialLining
				FROM dbo.pStyleMaterials
				WHERE StyleMaterialID = @StyleMaterialID
				
			--END
			
			--BEGIN	
			
			---Style Colorway--------------------------------------------
			
			SET @Row_Color_Loop = 1
			SET @Row_Color_Count = (SELECT COUNT(*) FROM #tempStyleColorway)
															
				IF @Colorway = 1
				BEGIN
					WHILE @Row_Color_Loop <= @Row_Color_Count
					
						BEGIN
							
							SELECT @StyleColorID = StyleColorID FROM  #tempStyleColorway WHERE RecID = @Row_Color_Loop
							SELECT @NewStyleColorID = StyleColorID FROM  #tempCopyStyleColorway WHERE RecID = @Row_Color_Loop
		
							INSERT INTO dbo.#tempCopyStyleColorwayItem
							(StyleColorItemID, StyleColorItemMasterID, StyleColorID, StyleID, StyleSet, StyleMaterialID, MaterialID, MaterialColorID, CDate, CUser, MDate, MUser)
							SELECT newid() AS StyleColorItemID, StyleColorItemMasterID, @NewStyleColorID, @NewStyleID, StyleSet, @NewStyleMaterialID, MaterialID, MaterialColorID, CDate, CUser, MDate, MUser
							FROM  #tempStyleColorwayItem
							WHERE StyleColorID = @StyleColorID AND StyleMaterialID = @StyleMaterialID		
									
							SET @Row_Color_Loop = @Row_Color_Loop + 1
							
						END
					
				END

			END			
			
			SET @Row_Loop = @Row_Loop + 1
			
		END
END

--SELECT @Row_Color_Loop
--SELECT @Row_Loop

--SELECT COUNT(*) FROM #tempCopyStyleColorwayItem
--SELECT COUNT(*) FROM #tempStyleColorwayItem

--DELETE #tempStyleMaterials

--SELECT * FROM #tempCopyStyleMaterials ORDER BY MaterialID, StyleMaterialID
--SELECT * FROM #tempCopyStyleColorwayItem ORDER BY MaterialID, StyleMaterialID

--SELECT * FROM #tempStyleMaterials ORDER BY MaterialID, StyleMaterialID
--SELECT * FROM #tempStyleColorwayItem ORDER BY MaterialID, StyleMaterialID

--INSERT Material

BEGIN

	INSERT INTO dbo.pStyleMaterials
	(StyleMaterialID, MainMaterial, StyleSet, StyleID, UOM, Qty, MaterialPrice, Ext, MaterialSize, MaterialID, MaterialImageID, 
	MaterialImageVersion, NoColorMatch, SupplierID, ComponentTypeID, MaterialType, MaterialNo, MaterialName, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O,
	P, Q, R, S,  T, U, V, W, X, Y, Z,Source, Notes, Placement, VendorPrice, VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, 
	DetailYesNo, ImageType, ColorPlacement, Artwork, License, Colorway, CDate, CUser, MDate, MUser, MChange,  SChange, DChange, 
	CChange, Action, StyleMaterialMasterID, Development, MaterialTrack, MaterialLinked, MaterialSort, MaterialLining)
	SELECT StyleMaterialID, MainMaterial, StyleSet, StyleID, UOM, 
	Qty, MaterialPrice, Ext, MaterialSize, MaterialID, MaterialImageID, MaterialImageVersion, NoColorMatch, SupplierID, 
	ComponentTypeID, MaterialType, MaterialNo, MaterialName, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S,  T, U, V, W, X, Y, Z,Source, Notes, 
	Placement AS Placement, VendorPrice, VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, DetailYesNo, 
	ImageType, ColorPlacement, Artwork, License, Colorway, CDate, CUser, 
	MDate, MUser, MChange, SChange, DChange, CChange, Action, StyleMaterialMasterID, 
	Development, MaterialTrack, MaterialLinked, MaterialSort, MaterialLining
	FROM dbo.#tempCopyStyleMaterials WHERE MaterialLinked = 1
	
	INSERT INTO dbo.pStyleColorway
	(StyleColorID, StyleID, StyleSet, StyleColorStandardID, StyleColorNo, StyleColorName, MainColor, Sort, Version, CDate, CUser, MDate, MUser , CopyStyleColorID, ColorPaletteID)
	SELECT StyleColorID, StyleID, StyleSet, StyleColorStandardID, StyleColorNo, StyleColorName, MainColor, Sort, Version, CDate, CUser, MDate, MUser , CopyStyleColorID, ColorPaletteID
	FROM dbo.#tempCopyStyleColorway
	
	INSERT INTO dbo.pStyleColorwayItem
	(StyleColorItemID, StyleColorItemMasterID, StyleColorID, StyleID, StyleSet, StyleMaterialID, MaterialID, MaterialColorID, CDate, CUser, MDate, MUser)
	SELECT StyleColorItemID, StyleColorItemMasterID, StyleColorID, StyleID, StyleSet, StyleMaterialID, MaterialID, MaterialColorID, CDate, CUser, MDate, MUser
	FROM  dbo.#tempCopyStyleColorwayItem	

END


















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanItemID_SELECT]'
GO



ALTER PROCEDURE [dbo].[spx_LinePlanItemID_SELECT](
@LinePlanRangeTypeID UNIQUEIDENTIFIER,
@LinePlanRangeID UNIQUEIDENTIFIER,
@LinePlanID UNIQUEIDENTIFIER,
@LinePlanIndex INT, 
@LinePlanItemID UNIQUEIDENTIFIER
)
AS


DECLARE @StyleID UNIQUEIDENTIFIER
DECLARE @LinePlanStyleAttributeItemID UNIQUEIDENTIFIER


SELECT  @LinePlanRangeID = LinePlanRangeID, @StyleID = StyleID, @LinePlanStyleAttributeItemID = LinePlanStyleAttributeItemID 
FROM pLinePlanItem WHERE LinePlanItemID  = @LinePlanItemID

IF @StyleID  = '00000000-0000-0000-0000-000000000000'
BEGIN
	SELECT @LinePlanItemID AS LinePlanItemID
END 
ELSE 
BEGIN 



	BEGIN
		CREATE TABLE #LinePlanItemAvail (ID int NOT NULL IDENTITY (1, 1),LinePlanItemID uniqueidentifier)
	END

	BEGIN
		
		IF @LinePlanStyleAttributeItemID IS NULL 
			INSERT INTO #LinePlanItemAvail (LinePlanItemID) 
			SELECT LinePlanItemID FROM pLinePlanItem WITH (NOLOCK) 
			WHERE LinePlanID = @LinePlanID AND LinePlanRangeID = @LinePlanRangeID 
			AND  LinePlanRangeTypeID = @LinePlanRangeTypeID AND StyleID = '00000000-0000-0000-0000-000000000000'
			AND @LinePlanStyleAttributeItemID IS NULL
		ELSE
			INSERT INTO #LinePlanItemAvail (LinePlanItemID) 
			SELECT LinePlanItemID FROM pLinePlanItem WITH (NOLOCK) 
			WHERE LinePlanID = @LinePlanID AND LinePlanRangeID = @LinePlanRangeID 
			AND LinePlanRangeTypeID = @LinePlanRangeTypeID AND StyleID = '00000000-0000-0000-0000-000000000000'
			AND LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID 
		
	END

	BEGIN
		SELECT LinePlanItemID FROM #LinePlanItemAvail WHERE ID = @LinePlanIndex
	END


	BEGIN
		DROP TABLE #LinePlanItemAvail
	END


END 


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_TradePartnerVendor_RateCopyLogic_SELECT]'
GO
CREATE PROCEDURE [dbo].[spx_TradePartnerVendor_RateCopyLogic_SELECT](
@TradePartnerVendorRateID UNIQUEIDENTIFIER, 
@Params NVARCHAR (4000)
)
AS 

DECLARE @TradepartnerVendorID UNIQUEIDENTIFIER 
DECLARE @SQL NVARCHAR(4000)
DECLARE @ParmDefinition NVARCHAR(100)
DECLARE @Total INT 
DECLARE @Msg NVARCHAR(500)

SELECT @TradepartnerVendorID = TradepartnerVendorID
FROM pTradePartnerVendorRate 
WHERE TradePartnerVendorRateID  = @TradePartnerVendorRateID


SET @SQL  = 'SELECT @pTotal = COUNT(*) FROM pTradePartnerVendorRate WHERE TradePartnerVendorID = ''' + 
CAST(@TradepartnerVendorID AS NVARCHAR(40))  + ''' AND ' + @Params

SET @ParmDefinition = '@pTotal INT OUTPUT'	
EXECUTE sp_executesql @sql, @ParmDefinition, @pTotal = @Total OUTPUT

IF @Total > 0 
	SET @Msg = 'Duplicate Season and Year'
	

SELECT @Msg  AS Msg 
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_LinePlanItemCost_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - October 28, 2009
	JOINED table 'pLinePlanRange' to get 'Brand', 'Product Category', and 'SeasonYearID'
information at Line Plan Costing level for the new "Price Band" dropdown.  Featuer #1229.

#02 - Ryan Cabanas - November 2, 2009
	Need to add field 'pStyleCostingHeader.StyleCostingCustomField35' to the view to
allow for the query lookup for the dropdown after you've made a selection.
*/


ALTER VIEW [dbo].[vwx_LinePlanItemCost_SELECT]
AS
SELECT     a.StyleID, a.StyleCostingTypeID, a.StyleQuotaDutyID, a.StyleCostingDate, a.StyleCostingStatus, a.StyleCostingCustomField1, 
                      a.StyleCostingCustomField2, a.StyleCostingCustomField3, a.StyleCostingCustomField4, a.StyleCostingCustomField5, a.StyleCostingCustomField6, 
                      a.StyleCostingCustomField7, a.StyleCostingCustomField8, a.StyleCostingCustomField9, a.StyleCostingCustomField10, a.StyleCostingCustomField11, 
                      a.StyleCostingCustomField12, a.StyleCostingCustomField13, a.StyleCostingCustomField14, a.StyleCostingCustomField15, 
                      a.StyleCostingCustomField16, a.StyleCostingCustomField17, a.StyleCostingCustomField18, a.StyleCostingCustomField19, 
                      a.StyleCostingCustomField20, a.StyleCostingCustomField21, a.StyleCostingCustomField22, a.StyleCostingCustomField23, 
                      a.StyleCostingCustomField24, a.StyleCostingCustomField25, a.StyleCostingCustomField26, a.StyleCostingCustomField27, 
                      a.StyleCostingCustomField28, a.StyleCostingCustomField29, a.StyleCostingCustomField30, a.CUser, a.CDate, a.MUser, a.MDate, a.Active, b.StyleNo, 
                      b.Description, b.StyleType, b.StyleCategory, c.LinePlanID, c.LinePlanItemID, d.LinePlanRangeID, b.MaterialNo, b.MaterialName, b.CustomField1, 
                      b.CustomField2, b.CustomField3, b.CustomField4, b.CustomField5, b.CustomField6, b.CustomField7, b.CustomField8, b.CustomField9, 
                      b.CustomField10, b.CustomField11, b.CustomField12, b.CustomField13, b.CustomField14, b.CustomField15, b.CustomField16, b.CustomField17, 
                      b.CustomField18, b.CustomField19, b.CustomField20, b.CustomField21, b.CustomField22, b.CustomField23, b.CustomField24, b.CustomField25, 
                      b.CustomField26, b.CustomField27, b.CustomField28, b.CustomField29, b.CustomField30, b.SizeClass, b.SizeRange, f.AttributeName
					  ,g.LinePlanAttributeText2 AS Brand, g.LinePlanAttributeText3 AS Category, c.SeasonYearID, a.StyleCostingCustomField35		--Comment #01, #02
FROM  dbo.pStyleCostingHeader AS a 
INNER JOIN dbo.pStyleHeader AS b ON b.StyleID = a.StyleID 
LEFT OUTER JOIN dbo.pStyleSeasonYear AS c ON c.StyleSeasonYearID = a.StyleSeasonYearID 
LEFT OUTER JOIN dbo.pLinePlanItem AS d ON c.LinePlanItemID = d.LinePlanItemID
LEFT OUTER JOIN pLinePlanStyleAttributeItem e ON e.LinePlanStyleAttributeItemID = d.LinePlanStyleAttributeItemID
LEFT OUTER JOIN pLinePlanStyleAttribute f ON f.LinePlanStyleAttributeID = e.LinePlanStyleAttributeID
INNER JOIN pLinePlanRange g ON d.LinePlanRangeID = g.LinePlanRangeID		--Comment #01
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_DesktopAccessLineFolderCheck_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_Group_DesktopAccessLineFolderCheck_INSERT] (
@GroupID  uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

IF (SELECT COUNT(*) FROM sAccessGroupLineFolder WITH (NOLOCK) WHERE LineTypeId = 1 AND GroupID  = @GroupID ) = 0
	BEGIN
		INSERT INTO sAccessGroupLineFolder
			(LineTypeId, GroupID, CUser, CDate, MUser, MDate)
		VALUES (1, @GroupID, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate) 
	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_LineFolder_MainMaterial20_Image_SELECT]'
GO


/******************
 * 4/25/2007 - 11:24pm EST - Ryan Cabanas - In the first INSERT SELECT statement, I added "OR b.LineFolderItemColorDrop IS NULL"
 * to the end of the JOIN.
 *****************/


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old color image string with the new color image string using function.
Deleted old code.
*/



ALTER           PROCEDURE [dbo].[rpx_LineFolder_MainMaterial20_Image_SELECT]
( 
	@LineFolderID varchar(50),
	@StyleID varchar(50)
)
AS

DECLARE @TotalCount int
DECLARE @RowCounter int
DECLARE @StyleColorID nvarchar(50)
DECLARE @StyleColorName nvarchar(200)
DECLARE @StyleColorNo nvarchar(10)


CREATE TABLE #tempStyleColorways
(
	TableRow int identity(1,1),
	StyleColorID varchar(50),
	StyleID varchar(50),
	StyleColorName nvarchar(200),
	StyleColorNo nvarchar(10)
)

CREATE TABLE #tempMainMaterialImages
(
	TableRow int identity(0,1),
	FilePath varchar(255),
	StyleID varchar(50),
	ColorName nvarchar(150),
	ColorCode nvarchar(50),
	ColorFolderID varchar(50),
	ColorPaletteID varchar(50),
	MainColor nvarchar(50),
	MainColorNo nvarchar(10),
	NoImage int
)

/*Get the colorways that are active for the style.*/
INSERT INTO #tempStyleColorways (StyleColorID, StyleID, StyleColorNo, StyleColorName)
SELECT a.StyleColorID, a.StyleID, a.StyleColorNo, a.StyleColorName
FROM pStyleColorway a INNER JOIN pLineFolderItemColor b ON
a.StyleID = b.StyleID AND a.StyleColorID = b.StyleColorID AND
(b.LineFolderItemColorDrop = 0 OR b.LineFolderItemColorDrop IS NULL)
WHERE b.LineFolderID = @LineFolderID AND b.StyleID = @StyleID
ORDER BY a.Sort, a.StyleColorName, a.StyleColorID

/*Get the count and set the counter.*/
SELECT @TotalCount = COUNT(*) FROM #tempStyleColorways
SET @RowCounter = 1

/*Begin loop to get final record data one at a time in order to capture blanks, as well.*/
WHILE (@RowCounter <= @TotalCount)
	BEGIN
		/*Get the active colorways one at a time.*/
		SELECT
			@StyleColorID = StyleColorID,
			@StyleColorName = StyleColorName,
			@StyleColorNo = StyleColorNo
		FROM #tempStyleColorways
		WHERE TableRow = @RowCounter

		/*Put a real, or bogus, record into the temp table.*/
		IF (SELECT COUNT(*)
			FROM pStyleColorwayItem INNER JOIN pMaterialColor ON
				pStyleColorwayItem.MaterialColorID = pMaterialColor.MaterialColorID INNER JOIN pStyleColorway ON
				pStyleColorwayItem.StyleColorID = pStyleColorway.StyleColorID INNER JOIN pLineFolderItemColor ON
				pStyleColorway.StyleColorID = pLineFolderItemColor.StyleColorID INNER JOIN pStyleMaterials ON
				pStyleColorwayItem.StyleMaterialID = pStyleMaterials.StyleMaterialID LEFT OUTER JOIN pLineFolderItem ON
				pLineFolderItemColor.LineFolderItemID = pLineFolderItem.LineFolderItemID
			WHERE	(pStyleMaterials.MainMaterial = 1) AND (pLineFolderItemColor.LineFolderID = @LineFolderID) AND
					(pLineFolderItemColor.StyleID = @StyleID) AND (pLineFolderItemColor.StyleColorID = @StyleColorID)
		   ) = 0
			BEGIN
				/*Put a blank in for Styles that have no images.*/
				INSERT INTO #tempMainMaterialImages (StyleID, ColorName, ColorCode,	ColorFolderID, ColorPaletteID, MainColor, MainColorNo, NoImage)
				VALUES (@StyleID, NULL, NULL, NULL, NULL, @StyleColorName, @StyleColorNo, 1)
		
			END
		ELSE
			BEGIN
				/*Put records in for Main Materials with chips.*/
				INSERT INTO #tempMainMaterialImages (StyleID, ColorName, ColorCode,	ColorFolderID, ColorPaletteID, MainColor, MainColorNo, NoImage)
				SELECT
					pLineFolderItemColor.StyleID, 
					pMaterialColor.ColorName,
					pMaterialColor.ColorCode,
					pMaterialColor.ColorFolderID,
					pMaterialColor.ColorPaletteID,
					pStyleColorway.MainColor,
					pStyleColorway.StyleColorNo,
					0 AS NoImage
				FROM pStyleColorwayItem INNER JOIN
					pMaterialColor ON pStyleColorwayItem.MaterialColorID = pMaterialColor.MaterialColorID INNER JOIN
					pStyleColorway ON pStyleColorwayItem.StyleColorID = pStyleColorway.StyleColorID INNER JOIN
					pLineFolderItemColor ON pStyleColorway.StyleColorID = pLineFolderItemColor.StyleColorID INNER JOIN
					pStyleMaterials ON pStyleColorwayItem.StyleMaterialID = pStyleMaterials.StyleMaterialID LEFT OUTER JOIN
					pLineFolderItem ON pLineFolderItemColor.LineFolderItemID = pLineFolderItem.LineFolderItemID
				WHERE	(pStyleMaterials.MainMaterial = 1) AND (pLineFolderItemColor.LineFolderID = @LineFolderID) AND
						(pLineFolderItemColor.StyleID = @StyleID) AND (pLineFolderItemColor.StyleColorID = @StyleColorID)

			END

		SET @RowCounter = @RowCounter + 1
	END

/*Create the URL for the Images.*/
UPDATE #tempMainMaterialImages
SET FilePath = dbo.fnx_GetStreamingColorImagePath(ColorFolderID, ColorPaletteID)	--Comment #01
FROM #tempMainMaterialImages

SELECT 
	TableRow % 5 AS [Column],
	FilePath,
	StyleID,
	ColorName,
	ColorCode,
	MainColor,
	MainColorNo,
	NoImage
FROM #tempMainMaterialImages

DROP TABLE #tempStyleColorways
DROP TABLE #tempMainMaterialImages







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rpx_Style_SeasonalMaterialColorwaySample_SELECT]'
GO
/*
Comments:

#01 - Ryan Cabanas - 6/25/2008 - Feature #313

	Burberry wants to see the SAP Code in the Colorway report.  There is a custom "BB_Style_MaterialColorway_Body_LLT.rdl" that is going to
use this SAP Code.  Just needed to add that field to this query.  There were 3 changes to this procedure.  Parts A, B, and C.  Field "SAPCode"
was added to these three sections.  A - was to add the field to the temp table.  B - was to add the field to the INSERT and SELECT portion
of the statement.  C - was to select the field in the final SELECT statement.

#02 - Ryan Cabanas - 1/15/2009
	When an a chip was added from the Image Folder, the 'ColorName' field was getting updated with the Image Number.  Clay isn't sure why it
was set up this way, but he said it shouldn't be this way.  I've commented it out here.

#03 - Ryan Cabanas - June 8, 2009
	This new procedure has been created 'rpx_Style_SeasonalMaterialColorway_SELECT' for the new Seasonal Colorway
feature that we now have.

#04 - Ryan Cabanas - September 28, 2009
	Need to add new fields to the temp table to hold the sort values that are used so that sorting can be
worked with later when creating the Row and Column values.

#05 - Ryan Cabanas - September 28, 2009
	Create a couple of temp table to handle sorting for the materials and the colors.  These will be used
to do proper sorting at the final SELECT.  Commented out the old sorting in the initial INSERT/SELECT.

#06 - Ryan Cabanas - September 28, 2009
	Need to add a 'Group Color Column' that will keep the colors together in the report as the priority.
Also need to do this for Landscape reports versus Portrait reports.

#07 - Artemio Gomez - October 6, 2009
	Filter items based on Sample status

#08 - Ryan Cabanas - October 8, 2009
	Replace the old image string with the new image string using function.
Deleted old code.

#09 - Ryan Cabanas - October 8, 2009
	Replace the old color image string with the new color image string using function.
Deleted old code.
*/




create        PROCEDURE [dbo].[rpx_Style_SeasonalMaterialColorwaySample_SELECT]  
(
	@StyleID AS varchar(255), 	
	@StyleSet AS int,
	@SeasonYearID varchar(255)	--Comment #03
)
AS



--/*Testing.*/
--BEGIN
--	DECLARE @StyleID varchar(255)
--	DECLARE @StyleSet int
--	DECLARE @SeasonYearID varchar(255)
--	SET @StyleID = 'f5bc96b7-5dea-4a2b-936b-f8bdea47229e'
--	SET @StyleSet = 1
--	SET @SeasonYearID = 'B2965D2D-2AE5-4B8D-9B77-477728946DD9'
--END




/*****************/
/*Comment #01 - A*/
/*****************/
--Create temp table.
CREATE TABLE #tempTable
(
	TableRow int identity(0,1)
	,MaterialDescription varchar(255)
	,StyleMaterialId varchar(50)
	,Placement nvarchar(1000)
	,MainColor varchar(255)
	,SAPCode varchar(50)
	,Qty varchar(18)
	,MaterialSize varchar(200)
	,ColorName varchar(150)
	,ColorCode varchar(50)
	,FilePath varchar(255)
	,MaterialColorNote nvarchar(1000)
	,MaterialColorImageID varchar(50)
	,MaterialColorImageVersion int
	,StyleColorSort nvarchar(10)		--Comment #04
	,StyleColorName nvarchar(200)		--Comment #04
	,StyleColorID nvarchar(200)			--Comment #04
	,MainMaterial int					--Comment #04
	,MaterialType int					--Comment #04
	,MaterialSort varchar(5)			--Comment #04
	,MaterialNo nvarchar(50)			--Comment #04
	,Row int							--Comment #04
	,[Column] int						--Comment #04
	,GroupColorColumnLandscape int		--Comment #06
	,GroupColorColumnPortrait int		--Comment #06
)

--Comment #05
CREATE TABLE #tempMaterialSort(
	TableRow int identity(0,1)
	,StyleMaterialId varchar(50)
	,MainMaterial int
	,MaterialType int
	,MaterialSort varchar(5)
	,MaterialNo nvarchar(50)
)

--Comment #05
CREATE TABLE #tempColorSort(
	TableRow int identity(0,1)
	,MainColor varchar(50)
	,StyleColorSort nvarchar(10)
	,StyleColorName nvarchar(200)
	,StyleColorID nvarchar(200)
	,GroupColorColumnLandscape int	--Comment #06
	,GroupColorColumnPortrait int	--Comment #06
)


DECLARE @ImageFolderColorPath varchar(200)
DECLARE @ImageFolderPath varchar(200)

SET @ImageFolderColorPath = (SELECT TOP 1 SettingValue FROM rReportSetting WHERE SettingType = 'ImageColorPath')
SET @ImageFolderPath = (SELECT TOP 1 SettingValue FROM rReportSetting WHERE SettingType = 'ImagePath')


/*****************/
/*Comment #01 - B*/
/*****************/
--Get the material colorway squares and put them in the temp table.
INSERT INTO #tempTable(
	MaterialDescription
	,StyleMaterialId
	,Placement
	,MainColor
	,SAPCode
	,Qty
	,MaterialSize
	,ColorName
	,ColorCode
	,FilePath
	,MaterialColorNote
	,MaterialColorImageID
	,MaterialColorImageVersion
	,StyleColorSort			--Comment #04
	,StyleColorName			--Comment #04
	,StyleColorID			--Comment #04
	,MainMaterial			--Comment #04
	,MaterialType			--Comment #04
	,MaterialSort			--Comment #04
	,MaterialNo				--Comment #04
)
SELECT
	('(' + pStyleMaterials.MaterialNo + ') ' + pStyleMaterials.MaterialName) AS MaterialDescription
	,CAST(pStyleMaterials.StyleMaterialId AS varchar(50)) AS StyleMaterialId
	,pStyleMaterials.Placement
	,isnull('(' + pStyleColorway.StyleColorNo + ') ','') +  pStyleColorway.MainColor AS MainColor
	,pStyleColorway.SAPCode
	,pStyleMaterials.Qty
	,pStyleMaterials.MaterialSize
	,pMaterialColor.ColorName
	,pMaterialColor.ColorCode
	,dbo.fnx_GetStreamingColorImagePath(pMaterialColor.ColorFolderID, pMaterialColor.ColorPaletteID) AS FilePath	--Comment #09
	,pMaterialColor.MaterialColorNote
	,pMaterialColor.MaterialColorImageID
	,pMaterialColor.MaterialColorImageVersion
	,pStyleColorway.Sort AS StyleColorSort						--Comment #04
	,pStyleColorway.StyleColorName								--Comment #04
	,CAST(pStyleColorway.StyleColorID AS nvarchar(200))			--Comment #04
	,pStyleMaterials.MainMaterial								--Comment #04
	,pStyleMaterials.MaterialType								--Comment #04
	,pStyleMaterials.MaterialSort								--Comment #04
	,pStyleMaterials.MaterialNo									--Comment #04
FROM pStyleColorway
	LEFT OUTER JOIN pStyleMaterials ON	pStyleColorway.StyleID = pStyleMaterials.StyleID
										AND pStyleColorway.StyleSet = pStyleMaterials.StyleSet
										AND pStyleMaterials.Colorway = 1
	LEFT OUTER JOIN pStyleColorwayItem ON	pStyleMaterials.StyleMaterialID = pStyleColorwayItem.StyleMaterialID
											AND pStyleColorway.StyleColorID = pStyleColorwayItem.StyleColorID
	LEFT OUTER JOIN pMaterialColor ON pStyleColorwayItem.MaterialColorID = pMaterialColor.MaterialColorID
	INNER JOIN pStyleColorwaySeasonYear ON	pStyleColorway.StyleID = pStyleColorwaySeasonYear.StyleID						--Comment #03
											AND pStyleColorway.StyleColorID = pStyleColorwaySeasonYear.StyleColorwayID		--Comment #03
	INNER JOIN pStyleSeasonYear ON	pStyleColorwaySeasonYear.StyleSeasonYearID = pStyleSeasonYear.StyleSeasonYearID			--Comment #03
									AND pStyleColorwaySeasonYear.StyleID = pStyleSeasonYear.StyleID							--Comment #03
WHERE pStyleColorway.StyleID = @StyleID
	AND pStyleColorway.StyleSet = @StyleSet
	AND pStyleSeasonYear.SeasonYearID = @SeasonYearID
	AND (pStyleColorwaySeasonYear.SampleStatus = 200 OR pStyleColorwaySeasonYear.SampleStatus = 300)  					--Comment #07
--ORDER BY pStyleColorway.Sort				--Comment #05
--	,pStyleColorway.StyleColorName			--Comment #05
--	,pStyleColorway.StyleColorID			--Comment #05
--	,pStyleMaterials.MainMaterial DESC		--Comment #05
--	,pStyleMaterials.MaterialType			--Comment #05
--	,pStyleMaterials.MaterialSort			--Comment #05
--	,pStyleMaterials.MaterialNo				--Comment #05

--Update the temp folder for the chips that are images from the Image folder.
UPDATE #tempTable
SET FilePath = dbo.fnx_GetStreamingImagePath(hImage.ImageID, hImage.[Version])	--Comment #08
--	ColorName = '(' + hImage.ImageNo + ')'  --Comment #02
FROM #tempTable
	INNER JOIN hImage ON	(#tempTable.MaterialColorImageID = hImage.ImageID
							AND #tempTable.MaterialColorImageVersion = hImage.Version)


--Update the temp table to include the "Die To Match (DTM)" feature request.
UPDATE #tempTable
SET ColorCode = ''
WHERE (ColorName IS NULL)
	AND (ColorCode IS NULL)
	AND (FilePath IS NULL)


--Comment #05
BEGIN
	/*Get the materials and put them in temp table to sort.*/
	INSERT INTO #tempMaterialSort(
		StyleMaterialId
		,MainMaterial
		,MaterialType
		,MaterialSort
		,MaterialNo
	)
	SELECT
		StyleMaterialId
		,MainMaterial
		,MaterialType
		,MaterialSort
		,MaterialNo
	FROM #tempTable
	GROUP BY
		StyleMaterialId
		,MainMaterial
		,MaterialType
		,MaterialSort
		,MaterialNo
	ORDER BY 
		MainMaterial DESC
		,MaterialType
		,MaterialSort
		,MaterialNo

	/*Get the colors and put them in temp table to sort.*/
	INSERT INTO #tempColorSort(
		MainColor
		,StyleColorSort
		,StyleColorName
		,StyleColorID
	)
	SELECT
		MainColor
		,StyleColorSort
		,StyleColorName
		,StyleColorID
	FROM #tempTable
	GROUP BY
		MainColor
		,StyleColorSort
		,StyleColorName
		,StyleColorID
	ORDER BY 
		StyleColorSort
		,StyleColorName
		,StyleColorID

	--Comment #06
	/*Declare variables.*/
	DECLARE @TotalCount int
	DECLARE @RowCounter int
	DECLARE @GroupCountLandscape int
	DECLARE @GroupCutOffLandscape int
	DECLARE @GroupCountPortrait int
	DECLARE @GroupCutOffPortrait int

	--Comment #06
	/*Get counts.*/
	SELECT @TotalCount = COUNT(*) from #tempColorSort
	SET @RowCounter = 0
	SET @GroupCountLandscape = 0
	SET @GroupCutOffLandscape = 6
	SET @GroupCountPortrait = 0
	SET @GroupCutOffPortrait = 3

	--Comment #06
	/*Loop to set 'Group Color Column' values.*/
	WHILE(@RowCounter < @TotalCount)
		BEGIN
			/*Update the 'Group Color Column' value.*/
			UPDATE #tempColorSort
			SET GroupColorColumnLandscape = @GroupCountLandscape
				,GroupColorColumnPortrait = @GroupCountPortrait
			WHERE TableRow = @RowCounter

			/*Up 'Group Color Column' count, if necessary, for landscape.*/
			IF(@RowCounter % @GroupCutOffLandscape = @GroupCutOffLandscape - 1)
				BEGIN
					SET @GroupCountLandscape = @GroupCountLandscape + 1
				END

			/*Up 'Group Color Column' count, if necessary, for portrait.*/
			IF(@RowCounter % @GroupCutOffPortrait = @GroupCutOffPortrait - 1)
				BEGIN
					SET @GroupCountPortrait = @GroupCountPortrait + 1
				END

			/*Up row counter.*/
			SET @RowCounter = @RowCounter + 1
		END

	/*Update main temp table with Row and Column values.*/
	UPDATE #tempTable
	SET Row = #tempMaterialSort.TableRow
		,[Column] = #tempColorSort.TableRow
		,GroupColorColumnLandscape = #tempColorSort.GroupColorColumnLandscape
		,GroupColorColumnPortrait = #tempColorSort.GroupColorColumnPortrait
	FROM #tempTable
		INNER JOIN #tempMaterialSort	ON	#tempTable.StyleMaterialID = #tempMaterialSort.StyleMaterialID
		INNER JOIN #tempColorSort	ON	#tempTable.MainColor = #tempColorSort.MainColor
END


/*****************/
/*Comment #01 - C*/
/*****************/
--Get the desired columns from the original temp table.
SELECT
	Row		--Comment #05
	,[Column]	--Comment #05
	,GroupColorColumnLandscape	--Comment #06
	,GroupColorColumnPortrait	--Comment #06
	,MaterialDescription
	,StyleMaterialId
	,Placement
	,MainColor
	,SAPCode
	,Qty
	,MaterialSize
	,ColorName
	,ColorCode
	,FilePath
	,MaterialColorNote
FROM #tempTable
ORDER BY
	Row		--Comment #05
	,[Column]	--Comment #05


/*
SELECT *
FROM dbo.pStyleColorway INNER JOIN
    dbo.pStyleColorwayItem ON dbo.pStyleColorway.StyleColorID = dbo.pStyleColorwayItem.StyleColorID INNER JOIN
    dbo.pStyleMaterials ON dbo.pStyleColorwayItem.StyleMaterialID = dbo.pStyleMaterials.StyleMaterialID INNER JOIN
    dbo.pMaterialColor ON dbo.pStyleColorwayItem.MaterialColorID = dbo.pMaterialColor.MaterialColorID
*/

--Drop the Temp Table.
DROP TABLE #tempTable
DROP TABLE #tempMaterialSort	--Comment #05
DROP TABLE #tempColorSort		--Comment #05
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_Style_LinePlan_COUNT_SELECT]'
GO


CREATE PROCEDURE dbo.spx_Style_LinePlan_COUNT_SELECT (
@StyleID  UNIQUEIDENTIFIER
)
AS

SELECT COUNT(*)
from pStyleSeasonYear a 
INNER JOIN pLinePlanItem  b ON a.LinePlanItemID =  b.LinePlanItemID 
WHERE a.StyleID  = @StyleID  
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_LinePlanShowroomItem_SEL]'
GO

ALTER VIEW [dbo].[vwx_LinePlanShowroomItem_SEL]
AS


SELECT  j.AttributeName, h.LinePlanStyleAttributeItemID , f.LinePlanFinancialID, f.LinePlanAttributeItemID1, f.LinePlanAttributeItemID2, f.LinePlanAttributeItemID3, 
f.LinePlanAttributeItemID4, 
a.LinePlanShowroomStyleColorID, a.LinePlanID, a.LinePlanRangeID, a.StyleColorID, a.ShowroomID, a.CUser, 
a.CDate, a.MUser, a.MDate, a.Price, 
a.Qty, a.TradePartnerVendorID, b.StyleColorNo, b.StyleColorName, b.ColorPaletteID, c.ColorFolderID, 
d.StyleID, d.StyleNo, d.Description, 
d.DesignSketchID, d.DesignSketchVersion, e.Custom AS ShowroomName, g.VendorName, d.MaterialNo, d.MaterialName
FROM         dbo.pLinePlanShowroomStyleColor AS a 
INNER JOIN dbo.pStyleColorway AS b ON a.StyleColorID = b.StyleColorID 
INNER JOIN dbo.pColorPalette AS c ON c.ColorPaletteID = b.ColorPaletteID 
INNER JOIN dbo.pStyleHeader AS d ON b.StyleID = d.StyleID 
INNER JOIN dbo.pShowroom AS e ON e.CustomID = a.ShowroomID 
INNER JOIN dbo.pLinePlanRange AS f ON f.LinePlanRangeID = a.LinePlanRangeID 
INNER JOIN dbo.pLinePlanItem AS h ON h.LinePlanRangeID = a.LinePlanRangeID AND h.StyleID = a.StyleID
LEFT OUTER JOIN dbo.pLinePlanStyleAttributeItem i ON i.LinePlanStyleAttributeItemID = h.LinePlanStyleAttributeItemID
LEFT OUTER JOIN dbo.pLinePlanStyleAttribute j ON j.LinePlanStyleAttributeID = i.LinePlanStyleAttributeID
LEFT OUTER JOIN  dbo.uTradePartnerVendor AS g ON g.TradePartnerVendorID = a.TradePartnerVendorID
WHERE     (a.Qty <> 0)




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rpx_Style_SeasonalMaterialColorwayProd_SELECT]'
GO
/*
Comments:

#01 - Ryan Cabanas - 6/25/2008 - Feature #313

	Burberry wants to see the SAP Code in the Colorway report.  There is a custom "BB_Style_MaterialColorway_Body_LLT.rdl" that is going to
use this SAP Code.  Just needed to add that field to this query.  There were 3 changes to this procedure.  Parts A, B, and C.  Field "SAPCode"
was added to these three sections.  A - was to add the field to the temp table.  B - was to add the field to the INSERT and SELECT portion
of the statement.  C - was to select the field in the final SELECT statement.

#02 - Ryan Cabanas - 1/15/2009
	When an a chip was added from the Image Folder, the 'ColorName' field was getting updated with the Image Number.  Clay isn't sure why it
was set up this way, but he said it shouldn't be this way.  I've commented it out here.

#03 - Ryan Cabanas - June 8, 2009
	This new procedure has been created 'rpx_Style_SeasonalMaterialColorway_SELECT' for the new Seasonal Colorway
feature that we now have.

#04 - Ryan Cabanas - September 28, 2009
	Need to add new fields to the temp table to hold the sort values that are used so that sorting can be
worked with later when creating the Row and Column values.

#05 - Ryan Cabanas - September 28, 2009
	Create a couple of temp table to handle sorting for the materials and the colors.  These will be used
to do proper sorting at the final SELECT.  Commented out the old sorting in the initial INSERT/SELECT.

#06 - Ryan Cabanas - September 28, 2009
	Need to add a 'Group Color Column' that will keep the colors together in the report as the priority.
Also need to do this for Landscape reports versus Portrait reports.

#07 - Artemio Gomez - October 6, 2009
	Filter items based on Production status

#08 - Artemio Gomez - October 7, 2009
	Burberry changes colour logic.  When "Prod. Status" is set to "Dropped", no matter what the "Sample
Status" dropdown is set to, that colour should not show on the "Production Ready Tech Pack".

#09 - Ryan Cabanas - October 8, 2009
	Replace the old image string with the new image string using function.
Deleted old code.

#10 - Ryan Cabanas - October 8, 2009
	Replace the old color image string with the new color image string using function.
Deleted old code.
*/




CREATE         PROCEDURE [dbo].[rpx_Style_SeasonalMaterialColorwayProd_SELECT]  
(
	@StyleID AS varchar(255), 	
	@StyleSet AS int,
	@SeasonYearID varchar(255)	--Comment #03
)
AS



--/*Testing.*/
--BEGIN
--	DECLARE @StyleID varchar(255)
--	DECLARE @StyleSet int
--	DECLARE @SeasonYearID varchar(255)
--	SET @StyleID = 'f5bc96b7-5dea-4a2b-936b-f8bdea47229e'
--	SET @StyleSet = 1
--	SET @SeasonYearID = 'B2965D2D-2AE5-4B8D-9B77-477728946DD9'
--END




/*****************/
/*Comment #01 - A*/
/*****************/
--Create temp table.
CREATE TABLE #tempTable
(
	TableRow int identity(0,1)
	,MaterialDescription varchar(255)
	,StyleMaterialId varchar(50)
	,Placement nvarchar(1000)
	,MainColor varchar(255)
	,SAPCode varchar(50)
	,Qty varchar(18)
	,MaterialSize varchar(200)
	,ColorName varchar(150)
	,ColorCode varchar(50)
	,FilePath varchar(255)
	,MaterialColorNote nvarchar(1000)
	,MaterialColorImageID varchar(50)
	,MaterialColorImageVersion int
	,StyleColorSort nvarchar(10)		--Comment #04
	,StyleColorName nvarchar(200)		--Comment #04
	,StyleColorID nvarchar(200)			--Comment #04
	,MainMaterial int					--Comment #04
	,MaterialType int					--Comment #04
	,MaterialSort varchar(5)			--Comment #04
	,MaterialNo nvarchar(50)			--Comment #04
	,Row int							--Comment #04
	,[Column] int						--Comment #04
	,GroupColorColumnLandscape int		--Comment #06
	,GroupColorColumnPortrait int		--Comment #06
)

--Comment #05
CREATE TABLE #tempMaterialSort(
	TableRow int identity(0,1)
	,StyleMaterialId varchar(50)
	,MainMaterial int
	,MaterialType int
	,MaterialSort varchar(5)
	,MaterialNo nvarchar(50)
)

--Comment #05
CREATE TABLE #tempColorSort(
	TableRow int identity(0,1)
	,MainColor varchar(50)
	,StyleColorSort nvarchar(10)
	,StyleColorName nvarchar(200)
	,StyleColorID nvarchar(200)
	,GroupColorColumnLandscape int	--Comment #06
	,GroupColorColumnPortrait int	--Comment #06
)


DECLARE @ImageFolderColorPath varchar(200)
DECLARE @ImageFolderPath varchar(200)

SET @ImageFolderColorPath = (SELECT TOP 1 SettingValue FROM rReportSetting WHERE SettingType = 'ImageColorPath')
SET @ImageFolderPath = (SELECT TOP 1 SettingValue FROM rReportSetting WHERE SettingType = 'ImagePath')


/*****************/
/*Comment #01 - B*/
/*****************/
--Get the material colorway squares and put them in the temp table.
INSERT INTO #tempTable(
	MaterialDescription
	,StyleMaterialId
	,Placement
	,MainColor
	,SAPCode
	,Qty
	,MaterialSize
	,ColorName
	,ColorCode
	,FilePath
	,MaterialColorNote
	,MaterialColorImageID
	,MaterialColorImageVersion
	,StyleColorSort			--Comment #04
	,StyleColorName			--Comment #04
	,StyleColorID			--Comment #04
	,MainMaterial			--Comment #04
	,MaterialType			--Comment #04
	,MaterialSort			--Comment #04
	,MaterialNo				--Comment #04
)
SELECT
	('(' + pStyleMaterials.MaterialNo + ') ' + pStyleMaterials.MaterialName) AS MaterialDescription
	,CAST(pStyleMaterials.StyleMaterialId AS varchar(50)) AS StyleMaterialId
	,pStyleMaterials.Placement
	,isnull('(' + pStyleColorway.StyleColorNo + ') ','') +  pStyleColorway.MainColor AS MainColor
	,pStyleColorway.SAPCode
	,pStyleMaterials.Qty
	,pStyleMaterials.MaterialSize
	,pMaterialColor.ColorName
	,pMaterialColor.ColorCode
	,dbo.fnx_GetStreamingColorImagePath(pMaterialColor.ColorFolderID, pMaterialColor.ColorPaletteID) AS FilePath	--Comment #10
	,pMaterialColor.MaterialColorNote
	,pMaterialColor.MaterialColorImageID
	,pMaterialColor.MaterialColorImageVersion
	,pStyleColorway.Sort AS StyleColorSort						--Comment #04
	,pStyleColorway.StyleColorName								--Comment #04
	,CAST(pStyleColorway.StyleColorID AS nvarchar(200))			--Comment #04
	,pStyleMaterials.MainMaterial								--Comment #04
	,pStyleMaterials.MaterialType								--Comment #04
	,pStyleMaterials.MaterialSort								--Comment #04
	,pStyleMaterials.MaterialNo									--Comment #04
FROM pStyleColorway
	LEFT OUTER JOIN pStyleMaterials ON	pStyleColorway.StyleID = pStyleMaterials.StyleID
										AND pStyleColorway.StyleSet = pStyleMaterials.StyleSet
										AND pStyleMaterials.Colorway = 1
	LEFT OUTER JOIN pStyleColorwayItem ON	pStyleMaterials.StyleMaterialID = pStyleColorwayItem.StyleMaterialID
											AND pStyleColorway.StyleColorID = pStyleColorwayItem.StyleColorID
	LEFT OUTER JOIN pMaterialColor ON pStyleColorwayItem.MaterialColorID = pMaterialColor.MaterialColorID
	INNER JOIN pStyleColorwaySeasonYear ON	pStyleColorway.StyleID = pStyleColorwaySeasonYear.StyleID						--Comment #03
											AND pStyleColorway.StyleColorID = pStyleColorwaySeasonYear.StyleColorwayID		--Comment #03
	INNER JOIN pStyleSeasonYear ON	pStyleColorwaySeasonYear.StyleSeasonYearID = pStyleSeasonYear.StyleSeasonYearID			--Comment #03
									AND pStyleColorwaySeasonYear.StyleID = pStyleSeasonYear.StyleID							--Comment #03
WHERE pStyleColorway.StyleID = @StyleID
	AND pStyleColorway.StyleSet = @StyleSet
	AND pStyleSeasonYear.SeasonYearID = @SeasonYearID
	AND (pStyleColorwaySeasonYear.SampleStatus = 200 OR pStyleColorwaySeasonYear.SampleStatus = 300 
			OR pStyleColorwaySeasonYear.StyleColorStatus = 200 OR pStyleColorwaySeasonYear.StyleColorStatus = 300)			--Comment #07
	AND pStyleColorwaySeasonYear.StyleColorStatus <> 0																		--Comment #08
--ORDER BY pStyleColorway.Sort				--Comment #05
--	,pStyleColorway.StyleColorName			--Comment #05
--	,pStyleColorway.StyleColorID			--Comment #05
--	,pStyleMaterials.MainMaterial DESC		--Comment #05
--	,pStyleMaterials.MaterialType			--Comment #05
--	,pStyleMaterials.MaterialSort			--Comment #05
--	,pStyleMaterials.MaterialNo				--Comment #05

--Update the temp folder for the chips that are images from the Image folder.
UPDATE #tempTable
SET FilePath = dbo.fnx_GetStreamingImagePath(hImage.ImageID, hImage.[Version])	--Comment #09
--	ColorName = '(' + hImage.ImageNo + ')'  --Comment #02
FROM #tempTable
	INNER JOIN hImage ON	(#tempTable.MaterialColorImageID = hImage.ImageID
							AND #tempTable.MaterialColorImageVersion = hImage.Version)


--Update the temp table to include the "Die To Match (DTM)" feature request.
UPDATE #tempTable
SET ColorCode = ''
WHERE (ColorName IS NULL)
	AND (ColorCode IS NULL)
	AND (FilePath IS NULL)


--Comment #05
BEGIN
	/*Get the materials and put them in temp table to sort.*/
	INSERT INTO #tempMaterialSort(
		StyleMaterialId
		,MainMaterial
		,MaterialType
		,MaterialSort
		,MaterialNo
	)
	SELECT
		StyleMaterialId
		,MainMaterial
		,MaterialType
		,MaterialSort
		,MaterialNo
	FROM #tempTable
	GROUP BY
		StyleMaterialId
		,MainMaterial
		,MaterialType
		,MaterialSort
		,MaterialNo
	ORDER BY 
		MainMaterial DESC
		,MaterialType
		,MaterialSort
		,MaterialNo

	/*Get the colors and put them in temp table to sort.*/
	INSERT INTO #tempColorSort(
		MainColor
		,StyleColorSort
		,StyleColorName
		,StyleColorID
	)
	SELECT
		MainColor
		,StyleColorSort
		,StyleColorName
		,StyleColorID
	FROM #tempTable
	GROUP BY
		MainColor
		,StyleColorSort
		,StyleColorName
		,StyleColorID
	ORDER BY 
		StyleColorSort
		,StyleColorName
		,StyleColorID

	--Comment #06
	/*Declare variables.*/
	DECLARE @TotalCount int
	DECLARE @RowCounter int
	DECLARE @GroupCountLandscape int
	DECLARE @GroupCutOffLandscape int
	DECLARE @GroupCountPortrait int
	DECLARE @GroupCutOffPortrait int

	--Comment #06
	/*Get counts.*/
	SELECT @TotalCount = COUNT(*) from #tempColorSort
	SET @RowCounter = 0
	SET @GroupCountLandscape = 0
	SET @GroupCutOffLandscape = 6
	SET @GroupCountPortrait = 0
	SET @GroupCutOffPortrait = 3

	--Comment #06
	/*Loop to set 'Group Color Column' values.*/
	WHILE(@RowCounter < @TotalCount)
		BEGIN
			/*Update the 'Group Color Column' value.*/
			UPDATE #tempColorSort
			SET GroupColorColumnLandscape = @GroupCountLandscape
				,GroupColorColumnPortrait = @GroupCountPortrait
			WHERE TableRow = @RowCounter

			/*Up 'Group Color Column' count, if necessary, for landscape.*/
			IF(@RowCounter % @GroupCutOffLandscape = @GroupCutOffLandscape - 1)
				BEGIN
					SET @GroupCountLandscape = @GroupCountLandscape + 1
				END

			/*Up 'Group Color Column' count, if necessary, for portrait.*/
			IF(@RowCounter % @GroupCutOffPortrait = @GroupCutOffPortrait - 1)
				BEGIN
					SET @GroupCountPortrait = @GroupCountPortrait + 1
				END

			/*Up row counter.*/
			SET @RowCounter = @RowCounter + 1
		END

	/*Update main temp table with Row and Column values.*/
	UPDATE #tempTable
	SET Row = #tempMaterialSort.TableRow
		,[Column] = #tempColorSort.TableRow
		,GroupColorColumnLandscape = #tempColorSort.GroupColorColumnLandscape
		,GroupColorColumnPortrait = #tempColorSort.GroupColorColumnPortrait
	FROM #tempTable
		INNER JOIN #tempMaterialSort	ON	#tempTable.StyleMaterialID = #tempMaterialSort.StyleMaterialID
		INNER JOIN #tempColorSort	ON	#tempTable.MainColor = #tempColorSort.MainColor
END


/*****************/
/*Comment #01 - C*/
/*****************/
--Get the desired columns from the original temp table.
SELECT
	Row		--Comment #05
	,[Column]	--Comment #05
	,GroupColorColumnLandscape	--Comment #06
	,GroupColorColumnPortrait	--Comment #06
	,MaterialDescription
	,StyleMaterialId
	,Placement
	,MainColor
	,SAPCode
	,Qty
	,MaterialSize
	,ColorName
	,ColorCode
	,FilePath
	,MaterialColorNote
FROM #tempTable
ORDER BY
	Row		--Comment #05
	,[Column]	--Comment #05


/*
SELECT *
FROM dbo.pStyleColorway INNER JOIN
    dbo.pStyleColorwayItem ON dbo.pStyleColorway.StyleColorID = dbo.pStyleColorwayItem.StyleColorID INNER JOIN
    dbo.pStyleMaterials ON dbo.pStyleColorwayItem.StyleMaterialID = dbo.pStyleMaterials.StyleMaterialID INNER JOIN
    dbo.pMaterialColor ON dbo.pStyleColorwayItem.MaterialColorID = dbo.pMaterialColor.MaterialColorID
*/

--Drop the Temp Table.
DROP TABLE #tempTable
DROP TABLE #tempMaterialSort	--Comment #05
DROP TABLE #tempColorSort		--Comment #05
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Issue_Team_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_Issue_Team_INSERT] (
	@IssueID  uniqueidentifier,
	@Email varchar ( 250) 
)
as

	DECLARE @TeamID as uniqueidentifier 

	SELECT @TeamID = TeamID FROM dbo.Users WITH (NOLOCK)  WHERE Email = @Email 
	

	IF  @TeamID IS NOT NULL  
	BEGIN
		INSERT INTO dbo.iIssueTeam ( IssueID , TeamID ) 
		VALUES ( @IssueID , @TeamID ) 
	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_LinePlanStyleItem_SEL]'
GO
ALTER VIEW dbo.vwx_LinePlanStyleItem_SEL
AS
SELECT     a.LinePlanItemID, a.LinePlanRangeID, a.LinePlanRangeTypeID, a.LinePlanID, a.CUser, a.CDate, a.MUser, a.MDate, a.StyleTypeID, b.StyleID, 
                      b.StyleType, b.StyleNo, b.TempID, b.TempNo, b.ConceptNo, b.SpecNo, b.Description, b.SizeClass, b.SizeRange, b.StyleSet, b.DesignSketchID, 
                      b.DesignSketchVersion, b.CustomField1, b.CustomField2, b.CustomField3, b.CustomField4, b.CustomField5, b.CustomField6, b.CustomField7, 
                      b.CustomField8, b.CustomField9, b.CustomField10, b.CustomField11, b.CustomField12, b.CustomField13, b.CustomField14, b.CustomField15, 
                      d.StyleCostingTypeID, d.StyleQuotaDutyID, d.StyleCostingDate, d.StyleCostingStatus, CASE WHEN d .StyleCostingCustomField1 IS NULL 
                      THEN 0 ELSE d .StyleCostingCustomField1 END AS StyleCostingCustomField1, d.StyleCostingCustomField2, d.StyleCostingCustomField3, 
                      d.StyleCostingCustomField4, d.StyleCostingCustomField5, d.StyleCostingCustomField6, d.StyleCostingCustomField7, d.StyleCostingCustomField8, 
                      d.StyleCostingCustomField9, d.StyleCostingCustomField10, d.StyleCostingCustomField11, d.StyleCostingCustomField12, 
                      d.StyleCostingCustomField13, d.StyleCostingCustomField14, d.StyleCostingCustomField15, d.StyleCostingCustomField16, 
                      d.StyleCostingCustomField17, d.StyleCostingCustomField18, d.StyleCostingCustomField19, d.StyleCostingCustomField20, 
                      d.StyleCostingCustomField21, d.StyleCostingCustomField22, d.StyleCostingCustomField23, d.StyleCostingCustomField24, 
                      d.StyleCostingCustomField25, d.StyleCostingCustomField26, d.StyleCostingCustomField27, d.StyleCostingCustomField28, 
                      d.StyleCostingCustomField29, d.StyleCostingCustomField30, d.Active, d.StyleCostingCustomField31, d.StyleCostingCustomField32, 
                      d.StyleCostingCustomField33, d.StyleCostingCustomField34, d.StyleCostingCustomField35, c.SeasonYearID, e.AttributeName, b.MaterialID, 
                      b.MaterialImageID, b.MaterialImageVersion, b.MaterialNo, b.MaterialName
FROM         dbo.pStyleHeader AS b RIGHT OUTER JOIN
                      dbo.pLinePlanItem AS a ON b.StyleID = a.StyleID LEFT OUTER JOIN
                      dbo.pStyleSeasonYear AS c ON a.StyleID = c.StyleID AND a.LinePlanItemID = c.LinePlanItemID LEFT OUTER JOIN
                      dbo.pStyleCostingHeader AS d ON d.StyleSeasonYearID = c.StyleSeasonYearID LEFT OUTER JOIN
                      dbo.pLinePlanStyleAttributeItem AS e ON e.LinePlanStyleAttributeItemID = a.LinePlanStyleAttributeItemID



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_DesktopAccessQuotationFolderCheck_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_Group_DesktopAccessQuotationFolderCheck_INSERT] (
@GroupID uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

DECLARE @I as int
DECLARE @Row_Count int
DECLARE @StyleTypeID int 
DECLARE @DeskAccessId int
DECLARE @DeskTableName varchar(100)
DECLARE @DeskTableKey varchar(50)


	BEGIN
	CREATE TABLE #TempUserAccess (
		Id int IDENTITY (1, 1) NOT NULL , 
		StyleTypeID int NOT NULL,
		GroupID uniqueidentifier
	) 
	END

	BEGIN
	
	INSERT INTO #TempUserAccess( StyleTypeID) SELECT StyleTypeID FROM pStyleType
	
	
	SET @Row_Count = (SELECT COUNT(*) FROM #TempUserAccess)
	
	SET @I = 1

	WHILE @I <= @Row_Count 
		BEGIN

			SELECT @StyleTypeID = StyleTypeID FROM #TempUserAccess WHERE ID = @I

			IF (SELECT COUNT(*) FROM sAccessGroupQuotationFolder WITH (NOLOCK) WHERE StyleTypeID = @StyleTypeID  AND GroupID = @GroupID  ) = 0
			BEGIN
				INSERT INTO sAccessGroupQuotationFolder
					( StyleTypeID, GroupID , CUser, CDate, MUser, MDate)
				SELECT StyleTypeId, @GroupID, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate 
				FROM  #TempUserAccess WHERE Id = @I
			END
				
			SET @I = @I + 1
		END

		SELECT * FROM #tempUserAccess

	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Style_ImageSummary_2_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.
*/


ALTER PROCEDURE [dbo].[rpx_Style_ImageSummary_2_SELECT] 
	@StyleID AS varchar(255), 
	@StyleSet As int
AS

 
CREATE TABLE #tempArtworkImages
(
	TableRow int identity(0,1),
	MaterialDescription nvarchar(255),
	FilePath nvarchar(255)
)


/*Insert the images into the temp table so that they can be arranged for a matrix.*/

SELECT     dbo.pStyleImageItem.ImageID, dbo.pStyleImageItem.ImageVersion, 'Detail' AS Folder, dbo.pImage.ImageCode AS ImageNo, dbo.pImage.ImageDescription
FROM         dbo.pStyleImageItem INNER JOIN
                      dbo.pImage ON dbo.pStyleImageItem.ImageID = dbo.pImage.ImageID WHERE  StyleID = @StyleID AND ImageVersion <> 0
UNION
SELECT MaterialImageID, MaterialImageVersion, 'Material' AS Folder, MaterialNo, MaterialName  FROM pStyleMaterials WHERE  StyleID = @StyleID AND MaterialImageVersion <> 0
UNION
SELECT MaterialImageID, MaterialImageVersion, 'Licensee' AS Folder, MaterialNo, MaterialName   FROM pStyleMaterials WHERE  StyleID = @StyleID AND License = 1 AND MaterialImageVersion <> 0
UNION
SELECT MaterialImageID, MaterialImageVersion, 'Artwork' AS Folder, MaterialNo, MaterialName   FROM pStyleMaterials WHERE  StyleID = @StyleID AND Artwork = 1 AND MaterialImageVersion <> 0
UNION
SELECT  DesignSketchID, DesignSketchVersion, 'Design' AS Folder, 'Design Sketch' AS ImageNo, 'Design Sketch' As ImageDescription  FROM  pStyleHeader WHERE  dbo.pStyleHeader.StyleID = @StyleID AND DesignSketchVersion <> 0
UNION
SELECT TechSketchID,  TechSketchVersion, 'Tech' AS Folder, 'Tech Sketch' AS ImageNo, 'Tech Sketch' As ImageDescription    FROM  pStyleHeader WHERE  dbo.pStyleHeader.StyleID = @StyleID AND TechSketchVersion <> 0
UNION
SELECT ConceptSketchID, ConceptSketchVersion, 'Concept' AS Folder, 'Concept Sketch' AS ImageNo, 'Concept Sketch' As ImageDescription    FROM  pStyleHeader WHERE  dbo.pStyleHeader.StyleID = @StyleID AND ConceptSketchVersion <> 0
UNION
SELECT SpecSketchID1, SpecSketchVersion1, 'Spec' AS Folder, 'Spec Sketch (1)' AS ImageNo, 'Spec Sketch (1)' As ImageDescription    FROM pStyleImage WHERE  StyleID = @StyleID AND SpecSketchVersion1 <> 0
UNION
SELECT SpecSketchID2, SpecSketchVersion2, 'Spec' AS Folder, 'Spec Sketch (2)' AS ImageNo, 'Spec Sketch (2)' As ImageDescription    FROM pStyleImage WHERE  StyleID = @StyleID AND SpecSketchVersion2 <> 0
UNION
SELECT SpecSketchID3, SpecSketchVersion3, 'Spec' AS Folder, 'Spec Sketch (3)' AS ImageNo, 'Spec Sketch (3)' As ImageDescription    FROM pStyleImage WHERE  StyleID = @StyleID AND SpecSketchVersion3 <> 0
UNION 
SELECT SpecSketchID4, SpecSketchVersion4, 'Spec' AS Folder, 'Spec Sketch (4)' AS ImageNo, 'Spec Sketch (4)' As ImageDescription    FROM pStyleImage WHERE  StyleID = @StyleID AND SpecSketchVersion4 <> 0



INSERT INTO #tempArtworkImages (MaterialDescription, FilePath)
SELECT ('(' + sm.MaterialNo + ') ' + sm.MaterialName) AS MaterialDescription, 
	(dbo.fnx_GetStreamingImagePath(hi.ImageID, hi.[Version])) AS FilePath	--Comment #01
FROM	pStyleMaterials sm, hImage hi 
WHERE ((sm.MaterialImageID = hi.ImageID) 
	AND (sm.MaterialImageVersion = hi.Version) 
	AND (sm.StyleSet =  @StyleSet) 
	AND (sm.StyleID = @StyleID))
	AND (sm.Artwork = 1)
ORDER BY sm.MainMaterial DESC, sm.MaterialType, sm.MaterialSort, sm.MaterialNo

SELECT
	TableRow % 2 AS [Column],
	MaterialDescription,
	FilePath
FROM #tempArtworkImages

DROP TABLE #tempArtworkImages









GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanItemNewLogic_UPDATE]'
GO

/* #01 - Clay Parker - Oct 1 2009
The field Division was not updating from the LinePlan onto the style header of the style. 
	#02 - Clayton Parker - Feb 8, 2010
Modified the Attributes section to include new attributes that were created for Feature #1316

*/


ALTER PROCEDURE [dbo].[spx_LinePlanItemNewLogic_UPDATE](
@LinePlanItemID UNIQUEIDENTIFIER , 
@StyleID UNIQUEIDENTIFIER , 
@CUser NVARCHAR(200), 
@CDate DATETIME
)
AS


DECLARE @LinePlanID  UNIQUEIDENTIFIER 
DECLARE @AttributeName NVARCHAR(200)	
DECLARE @LinePlanAttributeType NVARCHAR(200)	
DECLARE @Division NVARCHAR(200) -- #01

-- Start #01 
Select @Division = b.LinePlanAttributeText1 
from pLinePlanItem a
INNER JOIN pLinePlanRange b ON a.LinePlanRangeID = b.LinePlanRangeID
Where LinePlanItemId= @LinePlanItemID
AND b.LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'

UPDATE pStyleHeader
Set CustomField2 = @Division
Where StyleID = @StyleID


-- End #01

UPDATE pLinePlanItem SET 
	StyleID = @StyleID,
	MDate = @CDate,
	MUser = @CUser
WHERE LinePlanItemID = @LinePlanItemID 


SELECT @LinePlanAttributeType  = d.LinePlanAttributeType, @AttributeName  = c.AttributeName  
FROM pLinePlanItem a 
INNER JOIN pLinePlanStyleAttributeItem  b ON a.LinePlanStyleAttributeItemID   = b.LinePlanStyleAttributeItemID  
INNER JOIN pLinePlanStyleAttribute  c ON b.LinePlanStyleAttributeID = c.LinePlanStyleAttributeID 
INNER JOIN pLinePlanAttributeType d ON d.LinePlanAttributeTypeID = c.LinePlanAttributeTypeID 
WHERE  a.LinePlanItemID = @LinePlanItemID


IF @LinePlanAttributeType IS NOT NULL  AND @AttributeName  IS NOT NULL 
BEGIN

	IF LTRIM(RTRIM(LOWER(@LinePlanAttributeType))) = 'group' 
	BEGIN
		UPDATE pStyleHeader SET CustomField10 = @AttributeName WHERE StyleID = @StyleID 
	END 
	ELSE IF LTRIM(RTRIM(LOWER(@LinePlanAttributeType))) = 'style level' 
	BEGIN
		UPDATE pStyleHeader SET CustomField20 = @AttributeName WHERE StyleID = @StyleID 
	END 
	ELSE IF LTRIM(RTRIM(LOWER(@LinePlanAttributeType))) = 'Fabrication'						--Comment #02
	BEGIN
		UPDATE pStyleHeader SET CustomField17 = @AttributeName WHERE StyleID = @StyleID 
	END 
	ELSE IF LTRIM(RTRIM(LOWER(@LinePlanAttributeType))) = 'Denim Fit'						--Comment #02
	BEGIN
		UPDATE pStyleHeader SET CustomField18 = @AttributeName WHERE StyleID = @StyleID 
	END 
	ELSE IF LTRIM(RTRIM(LOWER(@LinePlanAttributeType))) = 'Treatment'						--Comment #02
	BEGIN
		UPDATE pStyleHeader SET CustomField19 = @AttributeName WHERE StyleID = @StyleID 
	END 
	ELSE IF LTRIM(RTRIM(LOWER(@LinePlanAttributeType))) = 'Branding'						--Comment #02
	BEGIN
		UPDATE pStyleHeader SET CustomField21 = @AttributeName WHERE StyleID = @StyleID 
	END

END 





/*
SELECT @LinePlanID = LinePlanID FROM pLinePlanItem WHERE LinePlanItemID =  @LinePlanItemID 
UPDATE pStyleHeader 
SET StyleWorkflowID = '10000000-1000-1000-1000-100000000000',
StyleStatusID  = 0,
LinePlanID = @LinePlanID , 
LinePlanItemID = @LinePlanItemID
WHERE StyleID =@StyleID
*/














GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rpx_Style_Header_Image_Small_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.

#02 - Ryan Cabanas - September 25, 2009
	Made this new procedure to control the smaller image in upper right
corner of Tech Packs.  Based off of a copy of 'rpx_Style_Header_Image_SELECT',
but calling upon a slightly different function to get a lower quality image
that is smaller in size.
*/


create    PROCEDURE [dbo].[rpx_Style_Header_Image_Small_SELECT] 
	@StyleID varchar(255) 	
AS


SELECT dbo.fnx_GetStreamingImageSmallPath(hImage.ImageID, hImage.[Version]) AS FilePath,	--Comment #01, #02
	pStyleHeader.StyleNo,
	pStyleHeader.SizeClass, 
	pStyleHeader.SizeRange,
	pStyleHeader.[Description] 
FROM	pStyleHeader LEFT OUTER JOIN hImage ON
	pStyleHeader.DesignSketchID = hImage.ImageID AND
	pStyleHeader.DesignSketchVersion = hImage.Version
WHERE pStyleHeader.StyleID = @StyleID

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleUPC_SELECTED]'
GO

ALTER PROCEDURE [dbo].[spx_StyleUPC_SELECTED](@StyleID uniqueidentifier)
AS SELECT     dbo.pStyleColorway.StyleColorID, dbo.pStyleColorway.StyleID, dbo.pStyleColorway.StyleColorStandardID, dbo.pStyleColorway.StyleColorNo, 
                      dbo.pStyleColorway.StyleColorName, dbo.pStyleColorway.MainColor, dbo.pStyleColorway.Sort, dbo.pStyleColorway.Version, 
                      dbo.pStyleColorway.CDate, dbo.pStyleColorway.CUser, dbo.pStyleColorway.MDate, dbo.pStyleColorway.MUser, dbo.pStyleUPC.UPCCode, 
                      dbo.pStyleUPC.UPCCustomField1, dbo.pStyleUPC.UPCCustomField2, dbo.pStyleUPC.StyleUPCID
FROM         dbo.pStyleColorway WITH (NOLOCK) INNER JOIN
                      dbo.pStyleUPC WITH (NOLOCK) ON dbo.pStyleColorway.StyleColorID = dbo.pStyleUPC.StyleColorID
WHERE     (dbo.pStyleColorway.StyleID = @StyleID)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_DesktopAccessSampleFolderCheck_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_Group_DesktopAccessSampleFolderCheck_INSERT] (
@GroupID uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

DECLARE @I as int
DECLARE @Row_Count int
DECLARE @SampleTypeID nvarchar (5)
DECLARE @DeskAccessId int
DECLARE @DeskTableName varchar(100)
DECLARE @DeskTableKey varchar(50)


	BEGIN
	CREATE TABLE #TempUserAccess (
		Id int IDENTITY (1, 1) NOT NULL , 
		SampleTypeID nvarchar (5)  NOT NULL,
		GroupID uniqueidentifier
	) 
	END

	BEGIN
	
	INSERT INTO #TempUserAccess( SampleTypeID) SELECT SampleWorkflowID FROM pSampleWorkflow
	
	
	SET @Row_Count = (SELECT COUNT(*) FROM #TempUserAccess)
	
	SET @I = 1

	WHILE @I <= @Row_Count 
		BEGIN

			SELECT @SampleTypeID =  SampleTypeID FROM #TempUserAccess WHERE ID = @I
			IF (SELECT COUNT(*) FROM sAccessGroupSampleFolder WITH (NOLOCK) WHERE SampleTypeId = @SampleTypeID  AND GroupID = @GroupID ) = 0
			BEGIN
				INSERT INTO sAccessGroupSampleFolder
					( SampleTypeId, GroupID,  CUser, CDate, MUser, MDate)
				SELECT SampleTypeId, @GroupID,  @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate 
				FROM  #TempUserAccess WHERE Id = @I
			END
				
			SET @I = @I + 1
		END

		SELECT * FROM #tempUserAccess

	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanItemNonApparelAttribute_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_LinePlanItemNonApparelAttribute_SELECT](
@LinePlanItemID UNIQUEIDENTIFIER
)
AS 

--DECLARE @LinePlanItemID UNIQUEIDENTIFIER
--SET @LinePlanItemID = '64212075-b5c9-4860-8b2f-381afbe12a7b'

DECLARE @LinePlanID UNIQUEIDENTIFIER
DECLARE @LinePlanRangeID UNIQUEIDENTIFIER
DECLARE @AttributeID UNIQUEIDENTIFIER
DECLARE @AttributeName NVARCHAR(200)
DECLARE @AttributeAvailable INT


SELECT @LinePlanRangeID = pLinePlanItem.LinePlanRangeID, @LinePlanID = pLinePlanItem.LinePlanID, 
  @AttributeID = pLinePlanStyleAttributeItem.AttributeID, @AttributeName = pLinePlanStyleAttributeItem.AttributeName
FROM pLinePlanItem INNER JOIN
  pLinePlanStyleAttributeItem ON pLinePlanItem.LinePlanStyleAttributeItemID = pLinePlanStyleAttributeItem.LinePlanStyleAttributeItemID
WHERE (pLinePlanItem.LinePlanItemID = @LinePlanItemID)

SELECT @AttributeAvailable = COUNT(*) FROM pLinePlanItem INNER JOIN
  pLinePlanStyleAttributeItem ON pLinePlanItem.LinePlanStyleAttributeItemID = pLinePlanStyleAttributeItem.LinePlanStyleAttributeItemID
WHERE (pLinePlanItem.LinePlanID = @LinePlanID 
		AND pLinePlanItem.LinePlanRangeID = @LinePlanRangeID 
		AND pLinePlanStyleAttributeItem.AttributeID = @AttributeID)

SELECT @AttributeID AS AttributeID, @AttributeName AS AttributeName, @AttributeAvailable AS AttributeAvailable







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleColorwayItems_AutoColorLogic_UPDATE]'
GO

/*
Comment #01 - Clayton Parker Dec 16 2009
	Burberry requested that the main material auto selection only pull through colors by ColorCode
	and not ColorName. I disabled the ColorName match.
*/

CREATE PROCEDURE [dbo].[spx_StyleColorwayItems_AutoColorLogic_UPDATE] (
@StyleID UNIQUEIDENTIFIER,
@StyleSet INT, 
@SeasonYearID UNIQUEIDENTIFIER,
@MUser NVARCHAR(200),
@MDate DATETIME
)
AS 



CREATE TABLE #sc(
ROW_ID INT IDENTITY(1,1),
StyleColorID UNIQUEIDENTIFIER,
ColorPaletteID UNIQUEIDENTIFIER,
ColorName NVARCHAR(200),
ColorCode NVARCHAR(200)
)

CREATE TABLE #mat (
ROW_ID INT IDENTITY(1,1),
StyleMaterialID UNIQUEIDENTIFIER,
MaterialID UNIQUEIDENTIFIER,
MainMaterial INT
)

INSERT INTO  #mat( StyleMaterialID, MaterialID, MainMaterial ) 
SELECT a.StyleMaterialID, a.MaterialID, a.MainMaterial  
FROM pStyleMaterials a
WHERE a.StyleID = @StyleID
AND a.StyleSet =  @StyleSet

INSERT INTO #sc (StyleColorID, ColorPaletteID, ColorName, ColorCode)
SELECT c.StyleColorID ,c.ColorPaletteID , d.ColorName, d.ColorCode
FROM pStyleColorwaySeasonYear a
INNER JOIN pStyleSeasonYear b ON a.StyleSeasonYearID = b.StyleSeasonYearID 
INNER JOIN pStyleColorway c ON a.StyleColorwayID = c.StyleColorID 
INNER JOIN pColorPalette d ON d.ColorPaletteID =  c.ColorPaletteID
WHERE b.StyleID = @StyleID
AND b.SeasonYearID = @SeasonYearID



DECLARE @TOTAL_M INT
DECLARE @ROW_M INT
DECLARE @TOTAL_C INT
DECLARE @ROW_C INT

DECLARE @StyleMaterialID UNIQUEIDENTIFIER
DECLARE @MaterialID UNIQUEIDENTIFIER
DECLARE @MainMaterial INT 
DECLARE @MaterialColorID UNIQUEIDENTIFIER
DECLARE @StyleColorID UNIQUEIDENTIFIER
DECLARE @ColorPaletteID UNIQUEIDENTIFIER
DECLARE @ColorName NVARCHAR(200)
DECLARE @ColorCode NVARCHAR(200)


SELECT @TOTAL_M = COUNT(*) FROM #mat
SET @ROW_M = 1 

WHILE @ROW_M <= @TOTAL_M
BEGIN

	SELECT @StyleMaterialID = StyleMaterialID, @MaterialID = MaterialID, @MainMaterial  = MainMaterial 
	FROM #mat WHERE ROW_ID = @ROW_M
	
	
	SELECT @TOTAL_C = COUNT(*) FROM #sc
	SET @ROW_C = 1 
	
	WHILE @ROW_C <= @TOTAL_C 
	BEGIN
	
		SELECT @StyleColorID = StyleColorID, @ColorPaletteID = ColorPaletteID, 
		@ColorName = ColorName, @ColorCode = ColorCode FROM #sc WHERE ROW_ID = @ROW_C
		
		SET @MaterialColorID = NULL 
		
		SELECT @MaterialColorID = MaterialColorID FROM pStyleColorwayItem 
		WHERE StyleMaterialID = @StyleMaterialID 
		AND StyleColorID = @StyleColorID
		AND StyleSet = @StyleSet  

		
				
		IF @MaterialColorID IS NULL 
		BEGIN 

			
			IF @MainMaterial =  1 
			BEGIN
				/**
				** Asign colorchips to the main material
				**/
				SELECT @MaterialColorID = a.MaterialColorID
				FROM pMaterialColor a
				INNER JOIN pColorPalette b ON a.ColorPaletteID = b.ColorPaletteID 
				INNER JOIN pMaterialColorSeasonYear c ON c.MaterialColorID = a.MaterialColorID
				WHERE a.MaterialID = @MaterialID
				AND b.ColorCode = @ColorCode
				--AND b.ColorName = @ColorName				-- Comment #01 
				AND c.SeasonYearID = @SeasonYearID
			END  
			ELSE
			BEGIN
				/**
				** No main material
				**/

				IF ( SELECT COUNT(*) FROM pMaterialColorSeasonYear WHERE MaterialID = @MaterialID AND SeasonYearID = @SeasonYearID ) = 1
				BEGIN
					/**
					** Material with only 1 Colorchip for that seasonYear 
					**/
					SELECT @MaterialColorID = MaterialColorID 
					FROM pMaterialColorSeasonYear 
					WHERE MaterialID = @MaterialID 
					AND SeasonYearID = @SeasonYearID
				END
				
			END 
							
			IF @MaterialColorID  IS NOT NULL
			BEGIN
			
				UPDATE pStyleColorwayItem  
				SET MaterialColorID = @MaterialColorID, MUser = @MUser, MDate =  @MDate
				WHERE StyleMaterialID = @StyleMaterialID 
				AND StyleColorID = @StyleColorID
				AND StyleSet = @StyleSet  
			END 
	
		END
		
		SET @ROW_C = @ROW_C + 1
	END
	



	SET @ROW_M= @ROW_M + 1 
END 


DROP TABLE #sc
DROP TABLE #mat 







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Style_MaterialPlacement_SELECT]'
GO

ALTER PROCEDURE [dbo].[rpx_Style_MaterialPlacement_SELECT]
	(@MaterialID AS varchar(50), @StyleID AS varchar(50), 	
	@StyleSet AS int, @StyleMaterialID AS varchar(50))
AS 

SELECT TOP 1 sm.Placement
FROM pStyleMaterials sm 
WHERE (sm.StyleMaterialID = @StyleMaterialID)
ORDER BY sm.MaterialNo
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleUser_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_StyleUser_SELECT]
(@StyleID uniqueidentifier,
@TradePartner int)
AS SELECT     dbo.Users.*
FROM         dbo.Users WITH (NOLOCK)
WHERE     (TeamID IN
                          (SELECT   TeamID
                            FROM    pStyleTeam WITH (NOLOCK)
                            WHERE      StyleID = @StyleID AND TradePartner =@Tradepartner)) 



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleCostingHeader_INSERT]'
GO
SET QUOTED_IDENTIFIER OFF
GO

/****** Object:  StoredProcedure spx_StyleCostingHeader_INSERT    Script Date: 03/08/2010 13:17:46 ******/

ALTER PROCEDURE [dbo].[spx_StyleCostingHeader_INSERT](
@StyleID uniqueidentifier,
@ModifiedBy varchar(200),
@ModifiedDate datetime ,
@StyleSeasonYearID UNIQUEIDENTIFIER 
)
AS 

-- /************************************************************
-- Alter By Daniel Pak on 03/07/10.
-- Add seasonality to style costing
-- *************************************************************/

DECLARE @Count INT 
IF @StyleSeasonYearID IS NULL 
	SELECT @Count = COUNT(*) FROM pStyleCostingHeader WHERE StyleID = @StyleID
ELSE 
	SELECT @Count = COUNT(*) FROM pStyleCostingHeader WHERE StyleID = @StyleID AND StyleSeasonYearID = @StyleSeasonYearID


/*INSERT the pStyleCostingHeader record the this Style.*/
IF @Count = 0
BEGIN
	INSERT INTO pStyleCostingHeader (StyleID, StyleCostingCustomField1, StyleCostingCustomField2, StyleCostingCustomField3, 
	StyleCostingCustomField4, CUser, MUser, CDate, MDate, StyleSeasonYearID) 
    VALUES  (@StyleID, 0, 0, 0, 0, @ModifiedBy, @ModifiedBy, @ModifiedDate, @ModifiedDate, @StyleSeasonYearID)
END

--DECLARE @Count INT 
--
--/***********************************************
--New statements added by Ryan Cabanas on 8/26/08.
--************************************************/
--
--IF @StyleSeasonYearID IS NULL 
--	SELECT @Count = COUNT(*) FROM pStyleCostingHeader WHERE StyleID = @StyleID
--ELSE 
--	SELECT @Count = COUNT(*) FROM pStyleCostingHeader WHERE StyleID = @StyleID AND StyleSeasonYearID = @StyleSeasonYearID
--
--
--/*INSERT the pStyleCostingHeader record the this Style.*/
--IF @Count = 0
--BEGIN
--	INSERT INTO pStyleCostingHeader (StyleID, StyleCostingCustomField1, StyleCostingCustomField2, StyleCostingCustomField3, 
--	StyleCostingCustomField4, CUser, MUser, CDate, MDate, StyleSeasonYearID) 
--    VALUES  (@StyleID, 0, 0, 0, 0, @ModifiedBy, @ModifiedBy, @ModifiedDate, @ModifiedDate, @StyleSeasonYearID)
--END
--
--/*Automatically add all costing types.*/
--BEGIN
--	/*Create temp table.*/
--	CREATE TABLE #temp(
--		StyleCostingTypeID int)
--
--	/*Get the Costing Types that have already been added for this Style.*/
--	IF @StyleSeasonYearID IS NULL 
--		INSERT INTO #temp(StyleCostingTypeID)
--		SELECT StyleCostingTypeID
--		FROM pStyleCosting
--		WHERE StyleID = @StyleID AND @StyleSeasonYearID IS NULL
--	ELSE 
--		INSERT INTO #temp(StyleCostingTypeID)
--		SELECT StyleCostingTypeID
--		FROM pStyleCosting
--		WHERE StyleID = @StyleID
--		AND StyleSeasonYearID = @StyleSeasonYearID
--
--
--
--	/*INSERT all of the Costing Types right up front because users won't do any work on these records, but they need them and we don't need to make them
--	add them manually.*/
--	INSERT INTO pStyleCosting(
--		StyleCostingID
--		,StyleID
--		,StyleCostingTypeID
--		,StyleCostingFreightTypeID
--		,StyleQuotaDutyID
--		,StyleCostingDate
--		,StyleCostingStatus
--		,CUser
--		,CDate
--		,MUser
--		,MDate
--		,Active
--		,StyleSeasonYearID )
--	SELECT
--		NewID() AS StyleCostingID
--		,@StyleID
--		,pStyleCostingType.StyleCostingTypeID
--		,1
--		,'00000000-0000-0000-0000-000000000000' AS StyleQuotaDutyID
--		,@ModifiedDate AS StyleCostingDate
--		,0
--		,@ModifiedBy AS CUser
--		,@ModifiedDate AS CDate
--		,@ModifiedBy AS MUser
--		,@ModifiedDate AS MDate
--		,1
--		,@StyleSeasonYearID
--	FROM	pStyleCostingType
--		LEFT OUTER JOIN #temp ON	pStyleCostingType.StyleCostingTypeID = #temp.StyleCostingTypeID
--	WHERE	#temp.StyleCostingTypeID IS NULL
--
--	/*Drop temp table.*/
--	DROP TABLE #temp
--END



--
--/************************************************************
--Original statements commented out by Ryan Cabanas on 8/26/08.
--*************************************************************/
--
--IF (SELECT COUNT(*) FROM pStyleCostingHeader WHERE StyleID = @StyleID) = 0
--BEGIN
--	INSERT INTO pStyleCostingHeader (StyleID, StyleCostingCustomField1, 
--		StyleCostingCustomField2, StyleCostingCustomField3, StyleCostingCustomField4, 
--		StyleCostingCustomField8, StyleCostingCustomField18, CUser, MUser, CDate, MDate) 
--                VALUES  (@StyleID, 0, 0, 0, 0, 0, 0, @ModifiedBy, @ModifiedBy, @ModifiedDate, @ModifiedDate)
--END

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Style_Sourcing_Template_SingleColorway_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.

#02 - Ryan Cabanas - September 23, 2009
	Replace the old color image string with the new color image string using function.
Deleted old code.
*/



ALTER     PROCEDURE [dbo].[rpx_Style_Sourcing_Template_SingleColorway_SELECT]
(
	@StyleSourcingID nvarchar(255)
	,@StyleColorID varchar(50)
)

AS

--Variables.
DECLARE @StyleID uniqueidentifier


--Temp tables.
CREATE TABLE #tempSourcingHeaderInfo
(
	TableRow int identity(1,1),
	SourcingName nvarchar(200),
	Active int,
	Trade_Partner nvarchar(200),
	Vendor nvarchar(200)
)

CREATE TABLE #tempAllSourcingInfo
(
	TableRow int identity(1,1),
	SourcingName nvarchar(200),
	Active int,
	Trade_Partner nvarchar(200),
	Vendor nvarchar(200),
	StyleID uniqueidentifier,
	StyleSet int,
	SetName nvarchar(50),
	Colorway_Name nvarchar(100),
	Material_Image_Path nvarchar(1000),
	Material nvarchar(255),
	Treatment_Size_Guage nvarchar(100),
	Supplier_Mill nvarchar(400),
	Color_Image_Path nvarchar(1000),
	Rating nvarchar(50),
	UOM nvarchar(50),
	Price money
)

--Get StyleID from the pStyleSourcing table.
SELECT	@StyleID = StyleID
FROM	pStyleSourcing
WHERE	StyleSourcingID = @StyleSourcingID


--Get header information for the sourcing template.
INSERT INTO #tempSourcingHeaderInfo(
	SourcingName,
	Active,
	Trade_Partner,
	Vendor)
SELECT	pStyleSourcing.SourcingName,
	pStyleSourcing.Active,
	uTradePartner.TradePartnerName AS Trade_Partner,
	uTradePartnerVendor.VendorName AS Vendor--,
--	pStyleSourcing.*
FROM	pStyleSourcing
	LEFT OUTER JOIN uTradePartner ON	pStyleSourcing.TradePartnerID = uTradePartner.TradePartnerID
	LEFT OUTER JOIN uTradePartnerVendor ON	pStyleSourcing.TradePartnerVendorID = uTradePartnerVendor.TradePartnerVendorID
WHERE	pStyleSourcing.StyleID = @StyleID

--Get individual sourcing material records.
INSERT INTO #tempAllSourcingInfo(
	StyleSet,
	Colorway_Name,
	Material_Image_Path,
	Material,
	Treatment_Size_Guage,
	Supplier_Mill,
	Color_Image_Path,
	Rating,
	UOM,
	Price)
SELECT	pStyleSourcingItem.StyleSet,
	pStyleColorway.MainColor AS Colorway_Name,
	dbo.fnx_GetStreamingImagePath(hImage.ImageID, hImage.[Version]) AS Material_Image_Path,	--Comment #01
	pStyleMaterials.MaterialNo + ' - ' + pStyleMaterials.MaterialName AS Material,
	pStyleMaterials.MaterialSize AS Treatment_Size_Guage,
	uTradePartner.TradePartnerName + ' - ' + uTradePartnerVendor.VendorName AS Supplier_Mill,
	dbo.fnx_GetStreamingColorImagePath(pMaterialColor.ColorFolderID, pMaterialColor.ColorPaletteID) AS Color_Image_Path,	--Comment #02
	pStyleSourcingItem.Qty AS Rating,
	pStyleSourcingItem.UOM,
	pStyleSourcingItem.MaterialPrice AS Price
FROM	pStyleSourcingItem
	INNER JOIN pStyleColorway ON	pStyleSourcingItem.StyleColorID = pStyleColorway.StyleColorID
	LEFT OUTER JOIN pStyleColorwayItem ON	(pStyleSourcingItem.StyleColorID = pStyleColorwayItem.StyleColorID
											AND pStyleSourcingItem.StyleMaterialID = pStyleColorwayItem.StyleMaterialID)
	LEFT OUTER JOIN pMaterialColor ON	pStyleColorwayItem.MaterialColorID = pMaterialColor.MaterialColorID
	INNER JOIN pStyleMaterials ON	pStyleSourcingItem.StyleMaterialID = pStyleMaterials.StyleMaterialID
	LEFT OUTER JOIN	uTradePartnerVendor ON	pStyleSourcingItem.TradePartnerVendorID = uTradePartnerVendor.TradePartnerVendorID
	LEFT OUTER JOIN uTradePartner ON	uTradePartnerVendor.TradePartnerID = uTradePartner.TradePartnerID
	LEFT OUTER JOIN hImage ON	(pStyleMaterials.MaterialImageID = hImage.ImageID
								AND pStyleMaterials.MaterialImageVersion = hImage.Version)
WHERE	pStyleSourcingItem.StyleSourcingID = @StyleSourcingID
	AND pStyleColorway.StyleColorID = @StyleColorID
ORDER BY	pStyleSourcingItem.StyleSet,
	pStyleColorway.Sort,
	pStyleColorway.MainColor,
	pStyleMaterials.MainMaterial DESC,
	pStyleMaterials.MaterialType,
	pStyleMaterials.MaterialSort,
	pStyleMaterials.MaterialNo,
	pStyleMaterials.MaterialName

--Add the sourcing template header info to the full temp table.
UPDATE	#tempAllSourcingInfo
SET	#tempAllSourcingInfo.SourcingName = #tempSourcingHeaderInfo.SourcingName,
	#tempAllSourcingInfo.Active = #tempSourcingHeaderInfo.Active,
	#tempAllSourcingInfo.Trade_Partner = #tempSourcingHeaderInfo.Trade_Partner,
	#tempAllSourcingInfo.Vendor = #tempSourcingHeaderInfo.Vendor
FROM	#tempSourcingHeaderInfo

--Add the StyleID to the full temp table to do joins.
UPDATE	#tempAllSourcingInfo
SET	#tempAllSourcingInfo.StyleID = @StyleID

--Add the set names from the pStyleHeader table.
UPDATE	#tempAllSourcingInfo
SET	#tempAllSourcingInfo.SetName =	CASE
										WHEN #tempAllSourcingInfo.StyleSet = 1 THEN	PC1
										WHEN #tempAllSourcingInfo.StyleSet = 2 THEN	PC2
										WHEN #tempAllSourcingInfo.StyleSet = 3 THEN	PC3
										WHEN #tempAllSourcingInfo.StyleSet = 4 THEN	PC4
									END
FROM	#tempAllSourcingInfo
	INNER JOIN pStyleHeader ON	#tempAllSourcingInfo.StyleID = pStyleHeader.StyleID

--Set the default set names if the set names were NULL.
UPDATE	#tempAllSourcingInfo
SET	SetName =	CASE
					WHEN StyleSet = 1 THEN	'1st Set'
					WHEN StyleSet = 2 THEN	'2nd Set'
					WHEN StyleSet = 3 THEN	'3rd Set'
					WHEN StyleSet = 4 THEN	'4th Set'
				END
FROM	#tempAllSourcingInfo
WHERE	(SetName IS NULL
		OR SetName = '')

--Select the information for the report.
SELECT	--SourcingName,
--	Active,
--	Trade_Partner,
--	Vendor,
--	StyleID,
	StyleSet,
	SetName,
	Colorway_Name,
	Material_Image_Path,
	Material,
	Treatment_Size_Guage,
	Supplier_Mill,
	Color_Image_Path,
	Rating,
	UOM,
	Price
FROM	#tempAllSourcingInfo

--Drop temp tables.
DROP TABLE #tempSourcingHeaderInfo
DROP TABLE #tempAllSourcingInfo





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[vwx_Material_AgentDefault_SELECT]'
GO
CREATE VIEW dbo.vwx_Material_AgentDefault_SELECT
AS
SELECT     dbo.pMaterialTradePartner.MaterialTradePartnerCustom1, dbo.pMaterial.MaterialID, dbo.pMaterial.TempID, dbo.pMaterial.TempNo, 
                      dbo.pMaterial.MaterialImageID, dbo.pMaterial.MaterialImageVersion, dbo.pMaterial.MaterialImageDetailID, dbo.pMaterial.MaterialImageDetailVersion, 
                      dbo.pMaterial.NoColorMatch, dbo.pMaterial.SupplierID, dbo.pMaterial.MaterialType, dbo.pMaterial.MaterialNo, dbo.pMaterial.MaterialName, 
                      dbo.pMaterial.A, dbo.pMaterial.B, dbo.pMaterial.C, dbo.pMaterial.D, dbo.pMaterial.G, dbo.pMaterial.H, dbo.pMaterial.I, dbo.pMaterial.J, 
                      dbo.pMaterial.K, dbo.pMaterial.L, dbo.pMaterial.M, dbo.pMaterial.N, dbo.pMaterial.O, dbo.pMaterial.P, dbo.pMaterial.Q, dbo.pMaterial.R, 
                      dbo.pMaterial.S, dbo.pMaterial.T, dbo.pMaterial.U, dbo.pMaterial.V, dbo.pMaterial.W, dbo.pMaterial.X, dbo.pMaterial.Y, dbo.pMaterial.Z, 
                      dbo.pMaterial.Source, dbo.pMaterial.Notes, dbo.pMaterial.VendorPrice, dbo.pMaterial.VolumePrice, dbo.pMaterial.VolumePriceMinimum, 
                      dbo.pMaterial.VendorProductionMin, dbo.pMaterial.VendorProductionLeadTime, dbo.pMaterial.MaterialPlacement, dbo.pMaterial.DetailYesNo, 
                      dbo.pMaterial.ImageType1, dbo.pMaterial.height, dbo.pMaterial.width, dbo.pMaterial.CDate, dbo.pMaterial.CUser, dbo.pMaterial.MDate, 
                      dbo.pMaterial.MUser, dbo.pMaterial.MChange, dbo.pMaterial.DChange, dbo.pMaterial.Action, dbo.pMaterial.Status, dbo.pMaterial.Active, 
                      dbo.pMaterialTradePartner.TradepartnerVendorId, dbo.pMaterial.MultiDimension, dbo.pMaterial.UOM, dbo.pMaterial.SAPCode, 
                      dbo.pMaterial.MaterialCode, dbo.pMaterial.MaterialColorRequired, dbo.pMaterial.FactorySourced
FROM         dbo.pMaterial LEFT OUTER JOIN
                      dbo.pMaterialTradePartner ON dbo.pMaterial.MaterialID = dbo.pMaterialTradePartner.MaterialId
GROUP BY dbo.pMaterialTradePartner.MaterialTradePartnerCustom1, dbo.pMaterial.MaterialID, dbo.pMaterial.TempID, dbo.pMaterial.TempNo, 
                      dbo.pMaterial.MaterialImageID, dbo.pMaterial.MaterialImageVersion, dbo.pMaterial.MaterialImageDetailID, dbo.pMaterial.MaterialImageDetailVersion, 
                      dbo.pMaterial.NoColorMatch, dbo.pMaterial.SupplierID, dbo.pMaterial.MaterialType, dbo.pMaterial.MaterialNo, dbo.pMaterial.MaterialName, 
                      dbo.pMaterial.A, dbo.pMaterial.B, dbo.pMaterial.C, dbo.pMaterial.D, dbo.pMaterial.G, dbo.pMaterial.H, dbo.pMaterial.I, dbo.pMaterial.J, 
                      dbo.pMaterial.K, dbo.pMaterial.L, dbo.pMaterial.M, dbo.pMaterial.N, dbo.pMaterial.O, dbo.pMaterial.P, dbo.pMaterial.Q, dbo.pMaterial.R, 
                      dbo.pMaterial.S, dbo.pMaterial.T, dbo.pMaterial.U, dbo.pMaterial.V, dbo.pMaterial.W, dbo.pMaterial.X, dbo.pMaterial.Y, dbo.pMaterial.Z, 
                      dbo.pMaterial.Source, dbo.pMaterial.Notes, dbo.pMaterial.VendorPrice, dbo.pMaterial.VolumePrice, dbo.pMaterial.VolumePriceMinimum, 
                      dbo.pMaterial.VendorProductionMin, dbo.pMaterial.VendorProductionLeadTime, dbo.pMaterial.MaterialPlacement, dbo.pMaterial.DetailYesNo, 
                      dbo.pMaterial.ImageType1, dbo.pMaterial.height, dbo.pMaterial.width, dbo.pMaterial.CDate, dbo.pMaterial.CUser, dbo.pMaterial.MDate, 
                      dbo.pMaterial.MUser, dbo.pMaterial.MChange, dbo.pMaterial.DChange, dbo.pMaterial.Action, dbo.pMaterial.Status, dbo.pMaterial.Active, 
                      dbo.pMaterialTradePartner.TradepartnerVendorId, dbo.pMaterial.MultiDimension, dbo.pMaterial.UOM, dbo.pMaterial.SAPCode, 
                      dbo.pMaterial.MaterialCode, dbo.pMaterial.MaterialColorRequired, dbo.pMaterial.FactorySourced
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_DesktopAccessShareFolderCheck_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_Group_DesktopAccessShareFolderCheck_INSERT] (
@GroupID uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

IF (SELECT COUNT(*) FROM sAccessGroupShareFolder WITH (NOLOCK) WHERE ShareTypeId = 1 AND GroupID = @GroupID   ) = 0
	BEGIN
		INSERT INTO sAccessGroupShareFolder
			(ShareTypeId, GroupID , CUser, CDate, MUser, MDate)
		VALUES (1, @GroupID, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate) 
	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[dpx_StyleTypeBySeasonYearCount_SELECT]'
GO


CREATE PROCEDURE [dbo].[dpx_StyleTypeBySeasonYearCount_SELECT]
AS 

SELECT  TOP (100) PERCENT dbo.pStyleHeader.StyleType, dbo.pStyleType.StyleTypeDescription, COUNT(*) AS StyleTypeCount
FROM  dbo.pStyleHeader INNER JOIN
  dbo.pStyleType ON dbo.pStyleHeader.StyleType = dbo.pStyleType.StyleTypeID
GROUP BY dbo.pStyleHeader.StyleType, dbo.pStyleType.StyleTypeDescription
ORDER BY dbo.pStyleType.StyleTypeDescription
--HAVING (@Season is null or pStyleHeader.CustomField2 = @Season)
--and (@Year is null or pStyleHeader.CustomField4 = @Year)


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanItemNonApparelAttributeAvail_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_LinePlanItemNonApparelAttributeAvail_SELECT](
@LinePlanItemID UNIQUEIDENTIFIER
)
AS



DECLARE @LinePlanRangeID UNIQUEIDENTIFIER
DECLARE @LinePlanStyleAttributeItemID UNIQUEIDENTIFIER

SELECT @LinePlanRangeID = LinePlanRangeID,
@LinePlanStyleAttributeItemID = LinePlanStyleAttributeItemID 
FROM pLinePlanItem WHERE LinePlanItemID = @LinePlanItemID 


BEGIN
	CREATE TABLE #LinePlanItemAvail (ID int NOT NULL IDENTITY (1, 1),LinePlanItemID uniqueidentifier)
END

BEGIN

	IF @LinePlanStyleAttributeItemID IS NULL OR @LinePlanStyleAttributeItemID = '00000000-0000-0000-0000-000000000000'
	BEGIN 
		INSERT INTO #LinePlanItemAvail (LinePlanItemID) 
		SELECT LinePlanItemID 
		FROM pLinePlanItem
		WHERE LinePlanRangeID = @LinePlanRangeID 
		AND LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003'
		AND StyleID = '00000000-0000-0000-0000-000000000000'
		AND (LinePlanStyleAttributeItemID IS NULL OR LinePlanStyleAttributeItemID  = '00000000-0000-0000-0000-000000000000')
	END 
	ELSE 
	BEGIN 
		
		INSERT INTO #LinePlanItemAvail (LinePlanItemID) 
		SELECT LinePlanItemID 
		FROM pLinePlanItem
		WHERE LinePlanRangeID = @LinePlanRangeID 
		AND LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003'
		AND StyleID = '00000000-0000-0000-0000-000000000000'
		AND LinePlanStyleAttributeItemID = @LinePlanStyleAttributeItemID
	END 

	

	--SELECT @LinePlanRangeID = pLinePlanItem.LinePlanRangeID, @LinePlanID = pLinePlanItem.LinePlanID, 
	--  @AttributeID = pLinePlanStyleAttributeItem.AttributeID, @AttributeName = pLinePlanStyleAttributeItem.AttributeName
	--FROM pLinePlanItem INNER JOIN
	--  pLinePlanStyleAttributeItem ON pLinePlanItem.LinePlanStyleAttributeItemID = pLinePlanStyleAttributeItem.LinePlanStyleAttributeItemID
	--WHERE (pLinePlanItem.LinePlanItemID = @LinePlanItemID)

	--INSERT INTO #LinePlanItemAvail (LinePlanItemID) 
	--SELECT pLinePlanItem.LinePlanItemID FROM pLinePlanItem INNER JOIN
	--  pLinePlanStyleAttributeItem ON pLinePlanItem.LinePlanStyleAttributeItemID = pLinePlanStyleAttributeItem.LinePlanStyleAttributeItemID
	--WHERE (pLinePlanItem.LinePlanID = @LinePlanID 
	--		AND pLinePlanItem.LinePlanRangeID = @LinePlanRangeID 
	--		AND pLinePlanStyleAttributeItem.AttributeID = @AttributeID)
	
END

BEGIN
	SELECT ID, LinePlanItemID FROM #LinePlanItemAvail
END

BEGIN
	DROP TABLE #LinePlanItemAvail
END

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[dpx_SampleRequestSubmit_Received_SELECT]'
GO



ALTER                  PROCEDURE [dbo].[dpx_SampleRequestSubmit_Received_SELECT]
(
	@Flag int
)
AS

/************************************************************/
/*@Flag:													*/
/* 1 = Submits received today.								*/
/* 2 = Submits received yesterday.							*/
/* 3 = Submits received this week.							*/
/* 4 = Submits received this week, broken down by day.		*/
/* 5 = Submits received this month. 						*/
/* 6 = Submits received this month, broken down by day. 	*/
/* 7 = Submits received this quarter. 						*/
/* 8 = Submits received this quarter, broken down by day.   */
/* 9 = Submits received this quarter, broken down by month.	*/
/* 10 = Submits received this year.							*/
/* 11 = Submits received this year, broken down by month.	*/
/************************************************************/



--Global Variables.
DECLARE @DateTime datetime
DECLARE @DateTimeBegin datetime
DECLARE @DateTimeEnd datetime

DECLARE @ShortStringDate varchar(10)
DECLARE @StringDateBegin varchar(25)
DECLARE @StringDateEnd varchar(25)

DECLARE @DayOfTheWeek int
DECLARE @SubtractDays int
DECLARE @AddDays int

DECLARE @Year int
DECLARE @Month int

--Create all of the Temp tables, even if they're not used because the Query will break otherwise.
CREATE TABLE #tempReceivedSamples
(
	TableRow int identity(1,1),
	[Count] int,
	RecDate varchar(10)
)

CREATE TABLE #tempBrokenDown
(
	TableRow int identity(1,1),
	[Count] int,
	RecDate varchar(10)
)

--Set the current date.
SET	@DateTime = GETDATE()

--Choose the right output depending on the flag chosen.
IF(@Flag = 1)	--Submits Received Today.
	BEGIN
		--Set current date variable to a short date format.
		SET @ShortStringDate = SUBSTRING(CONVERT(varchar(25), @DateTime, 120), 1, 10)
		
		--Set two variables to the beginning and end of the current date.
		SET @StringDateBegin = @ShortStringDate + ' 00:00:00.000'
		SET @StringDateEnd = @ShortStringDate + ' 23:59:59.998'
		
		--Get received samples for current date.
		SELECT
			uTradePartner.TradePartnerName,
			uTradePartnerVendor.VendorName,
			pStyleHeader.StyleNo,
			pStyleHeader.SizeClass,
			pStyleHeader.SizeRange,
			pSampleRequestSubmitStatus.Status,
			pSampleRequestSubmit.Submit,
			pSampleRequestSubmit.RecDate,
			pSampleRequestSubmit.RecBy
		FROM	pSampleRequestSubmit
			LEFT OUTER JOIN pSampleRequestSubmitStatus ON 	(pSampleRequestSubmit.Status = pSampleRequestSubmitStatus.StatusID)
			INNER JOIN pStyleHeader ON	(pSampleRequestSubmit.StyleID = pStyleHeader.StyleID)
			LEFT OUTER JOIN uTradePartner ON	(pSampleRequestSubmit.TradePartnerID = uTradePartner.TradePartnerID)
			LEFT OUTER JOIN uTradePartnerVendor ON	(pSampleRequestSubmit.TradePartnerVendorID = uTradePartnerVendor.TradePartnerVendorID)
		WHERE	(pSampleRequestSubmit.RecDate >= @StringDateBegin
				AND	pSampleRequestSubmit.RecDate <= @StringDateEnd)
		ORDER BY	uTradePartner.TradePartnerName,
			uTradePartnerVendor.VendorName,
			pStyleHeader.StyleNo,
			pStyleHeader.SizeClass,
			pStyleHeader.SizeRange
	END
ELSE IF(@Flag = 2)	--Submits received yesterday.
	BEGIN
		--Set the date to one day less than the current date.
		SET @DateTime = DATEADD(day, -1, @DateTime)
		
		--Set current date variable to a short date format.
		SET @ShortStringDate = SUBSTRING(CONVERT(varchar(25), @DateTime, 120), 1, 10)
		
		--Set two variables to the beginning and end of the current date.
		SET @StringDateBegin = @ShortStringDate + ' 00:00:00.000'
		SET @StringDateEnd = @ShortStringDate + ' 23:59:59.998'
		
		--Get received samples for yesterday.
		SELECT
			uTradePartner.TradePartnerName,
			uTradePartnerVendor.VendorName,
			pStyleHeader.StyleNo,
			pStyleHeader.SizeClass,
			pStyleHeader.SizeRange,
			pSampleRequestSubmitStatus.Status,
			pSampleRequestSubmit.Submit,
			pSampleRequestSubmit.RecDate,
			pSampleRequestSubmit.RecBy
		FROM	pSampleRequestSubmit
			LEFT OUTER JOIN pSampleRequestSubmitStatus ON 	(pSampleRequestSubmit.Status = pSampleRequestSubmitStatus.StatusID)
			INNER JOIN pStyleHeader ON	(pSampleRequestSubmit.StyleID = pStyleHeader.StyleID)
			LEFT OUTER JOIN uTradePartner ON	(pSampleRequestSubmit.TradePartnerID = uTradePartner.TradePartnerID)
			LEFT OUTER JOIN uTradePartnerVendor ON	(pSampleRequestSubmit.TradePartnerVendorID = uTradePartnerVendor.TradePartnerVendorID)
		WHERE	(pSampleRequestSubmit.RecDate >= @StringDateBegin
				AND	pSampleRequestSubmit.RecDate <= @StringDateEnd)
		ORDER BY	uTradePartner.TradePartnerName,
			uTradePartnerVendor.VendorName,
			pStyleHeader.StyleNo,
			pStyleHeader.SizeClass,
			pStyleHeader.SizeRange
	END
ELSE IF(@Flag = 3)	--Submits received this week.
	BEGIN
		--Set the first day of the week to Monday.
		SET DATEFIRST 1

		--Get the integer equivalent of the day of the week.
		SET @DayOfTheWeek = DATEPART(dw, @DateTime)
		
		--Find out where the current date is in comparison to the beginning and end of the week.
		SET @SubtractDays = 1 - @DayOfTheWeek
		SET @AddDays = 7 - @DayOfTheWeek
		
		--Set the dates for the beginning and end of the week.
		SET @DateTimeBegin = DATEADD(day, @SubtractDays, @DateTime)
		SET @DateTimeEnd = DATEADD(day, @AddDays, @DateTime)
		
		--Set beginning and end of week date variables to a short date format.
		SET @StringDateBegin = SUBSTRING(CONVERT(varchar(25), @DateTimeBegin, 120), 1, 10)
		SET @StringDateEnd = SUBSTRING(CONVERT(varchar(25), @DateTimeEnd, 120), 1, 10)
		
		--Set two variables to the beginning and end of the current week.
		SET @StringDateBegin = @StringDateBegin + ' 00:00:00.000'
		SET @StringDateEnd = @StringDateEnd + ' 23:59:59.998'
		
		--Get received samples for current week.
		SELECT DISTINCT 
			uTradePartner.TradePartnerName,
			uTradePartnerVendor.VendorName,
			pStyleHeader.StyleNo,
			pStyleHeader.SizeClass,
			pStyleHeader.SizeRange,
			pSampleRequestSubmitStatus.Status,
			pSampleRequestSubmit.Submit,
			pSampleRequestSubmit.RecDate,
			pSampleRequestSubmit.RecBy
		FROM	pSampleRequestSubmit
			LEFT OUTER JOIN pSampleRequestSubmitStatus ON 	(pSampleRequestSubmit.Status = pSampleRequestSubmitStatus.StatusID)
			INNER JOIN pStyleHeader ON	(pSampleRequestSubmit.StyleID = pStyleHeader.StyleID)
			LEFT OUTER JOIN uTradePartner ON	(pSampleRequestSubmit.TradePartnerID = uTradePartner.TradePartnerID)
			LEFT OUTER JOIN uTradePartnerVendor ON	(pSampleRequestSubmit.TradePartnerVendorID = uTradePartnerVendor.TradePartnerVendorID)
		WHERE	(pSampleRequestSubmit.RecDate >= @StringDateBegin
				AND	pSampleRequestSubmit.RecDate <= @StringDateEnd)
		ORDER BY	uTradePartner.TradePartnerName,
			uTradePartnerVendor.VendorName,
			pStyleHeader.StyleNo,
			pStyleHeader.SizeClass,
			pStyleHeader.SizeRange
	END
ELSE IF(@Flag = 4)	--Submits received this week, broken down by day.
	BEGIN
		--Set the first day of the week to Monday.
		SET DATEFIRST 1
		
		--Get the integer equivalent of the day of the week.
		SET @DayOfTheWeek = DATEPART(dw, @DateTime)
		
		--Find out where the current date is in comparison to the beginning and end of the week.
		SET @SubtractDays = 1 - @DayOfTheWeek
		SET @AddDays = 7 - @DayOfTheWeek
		
		--Set the dates for the beginning and end of the week.
		SET @DateTimeBegin = DATEADD(day, @SubtractDays, @DateTime)
		SET @DateTimeEnd = DATEADD(day, @AddDays, @DateTime)
		
		--Set beginning and end of week date variables to a short date format.
		SET @StringDateBegin = SUBSTRING(CONVERT(varchar(25), @DateTimeBegin, 120), 1, 10)
		SET @StringDateEnd = SUBSTRING(CONVERT(varchar(25), @DateTimeEnd, 120), 1, 10)
		
		--Set two variables to the beginning and end of the current week.
		SET @StringDateBegin = @StringDateBegin + ' 00:00:00.000'
		SET @StringDateEnd = @StringDateEnd + ' 23:59:59.998'
		
		--Set the datetime versions of the beginning and end of the date range to use for the loop.
		SET @DateTimeBegin = @StringDateBegin
		SET @DateTimeEnd = @StringDateEnd
		
		--Get received samples for the specified date range.
		INSERT INTO #tempReceivedSamples ([Count], RecDate)
		SELECT	COUNT(*), SUBSTRING(CONVERT(varchar(25), pSampleRequestSubmit.RecDate, 120), 1, 10) AS RecDate
		FROM	pSampleRequestSubmit
		WHERE	(pSampleRequestSubmit.RecDate >= @StringDateBegin
				AND	pSampleRequestSubmit.RecDate <= @StringDateEnd)
		GROUP BY	SUBSTRING(CONVERT(varchar(25), pSampleRequestSubmit.RecDate, 120), 1, 10)
		
		--Loop to populate the broken down temp table with dates only.
		WHILE(@DateTimeBegin <= @DateTimeEnd)
			BEGIN
				--Add each day of the specified date range one day at a time.
				INSERT INTO #tempBrokenDown (RecDate)
				VALUES (SUBSTRING(CONVERT(varchar(25), @DateTimeBegin, 120), 1, 10))
		
				--Move to the next day.
				SET @DateTimeBegin = DATEADD(day, 1, @DateTimeBegin)
			END
		
		--Update the broken down temp table with numbers.
		UPDATE	#tempBrokenDown
		SET	#tempBrokenDown.[Count] = #tempReceivedSamples.[Count]
		FROM	#tempReceivedSamples
			INNER JOIN #tempBrokenDown ON #tempReceivedSamples.RecDate = #tempBrokenDown.RecDate
		
		--Fill in the NULLS with zeros.
		UPDATE	#tempBrokenDown
		SET	[Count] = 0
		WHERE	[Count] IS NULL
		
		--Get the data from the broken down temp table.
		SELECT	[Count], RecDate
		FROM	#tempBrokenDown
	END
ELSE IF(@Flag = 5)	--Submits received this month.
	BEGIN
		--Get the integer equivalent of the month and the year.
		SET @Year = DATEPART(yyyy, @DateTime)
		SET @Month = DATEPART(mm, @DateTime)
		
		--Set the date for the beginning of the month.
		SET @DateTimeBegin = CAST(@Year AS varchar(4)) + '-' + CAST(@Month AS varchar(2)) + '-01'
		
		--Set the ending date to the beginning of the next month.
		SET @DateTimeEnd = DATEADD(month, 1, @DateTimeBegin)
		
		--Set the ending date to one day less than the beginning of the next month.
		SET @DateTimeEnd = DATEADD(day, -1, @DateTimeEnd)
		
		--Set beginning and end of month date variables to a short date format.
		SET @StringDateBegin = SUBSTRING(CONVERT(varchar(25), @DateTimeBegin, 120), 1, 10)
		SET @StringDateEnd = SUBSTRING(CONVERT(varchar(25), @DateTimeEnd, 120), 1, 10)
		
		--Set two variables to the beginning and end of the current month.
		SET @StringDateBegin = @StringDateBegin + ' 00:00:00.000'
		SET @StringDateEnd = @StringDateEnd + ' 23:59:59.998'
		
		--Get received samples for current month.
		SELECT
			uTradePartner.TradePartnerName,
			uTradePartnerVendor.VendorName,
			pStyleHeader.StyleNo,
			pStyleHeader.SizeClass,
			pStyleHeader.SizeRange,
			pSampleRequestSubmitStatus.Status,
			pSampleRequestSubmit.Submit,
			pSampleRequestSubmit.RecDate,
			pSampleRequestSubmit.RecBy
		FROM	pSampleRequestSubmit
			LEFT OUTER JOIN pSampleRequestSubmitStatus ON 	(pSampleRequestSubmit.Status = pSampleRequestSubmitStatus.StatusID)
			INNER JOIN pStyleHeader ON	(pSampleRequestSubmit.StyleID = pStyleHeader.StyleID)
			LEFT OUTER JOIN uTradePartner ON	(pSampleRequestSubmit.TradePartnerID = uTradePartner.TradePartnerID)
			LEFT OUTER JOIN uTradePartnerVendor ON	(pSampleRequestSubmit.TradePartnerVendorID = uTradePartnerVendor.TradePartnerVendorID)
		WHERE	(pSampleRequestSubmit.RecDate >= @StringDateBegin
				AND	pSampleRequestSubmit.RecDate <= @StringDateEnd)
		ORDER BY	uTradePartner.TradePartnerName,
			uTradePartnerVendor.VendorName,
			pStyleHeader.StyleNo,
			pStyleHeader.SizeClass,
			pStyleHeader.SizeRange
	END
ELSE IF(@Flag = 6)	--Submits received this month, broken down by day.
	BEGIN
		--Get the integer equivalent of the month and the year.
		SET @Year = DATEPART(yyyy, @DateTime)
		SET @Month = DATEPART(mm, @DateTime)
		
		--Set the date for the beginning of the month.
		SET @DateTimeBegin = CAST(@Year AS varchar(4)) + '-' + CAST(@Month AS varchar(2)) + '-01'
		
		--Set the ending date to the beginning of the next month.
		SET @DateTimeEnd = DATEADD(month, 1, @DateTimeBegin)
		
		--Set the ending date to one day less than the beginning of the next month.
		SET @DateTimeEnd = DATEADD(day, -1, @DateTimeEnd)
		
		--Set beginning and end of month date variables to a short date format.
		SET @StringDateBegin = SUBSTRING(CONVERT(varchar(25), @DateTimeBegin, 120), 1, 10)
		SET @StringDateEnd = SUBSTRING(CONVERT(varchar(25), @DateTimeEnd, 120), 1, 10)
		
		--Set two variables to the beginning and end of the current month.
		SET @StringDateBegin = @StringDateBegin + ' 00:00:00.000'
		SET @StringDateEnd = @StringDateEnd + ' 23:59:59.998'
		
		--Set the datetime versions of the beginning and end of the date range to use for the loop.
		SET @DateTimeBegin = @StringDateBegin
		SET @DateTimeEnd = @StringDateEnd
		
		--Get received samples for the specified date range.
		INSERT INTO #tempReceivedSamples ([Count], RecDate)
		SELECT	COUNT(*), SUBSTRING(CONVERT(varchar(25), pSampleRequestSubmit.RecDate, 120), 1, 10) AS RecDate
		FROM	pSampleRequestSubmit
		WHERE	(pSampleRequestSubmit.RecDate >= @StringDateBegin
				AND	pSampleRequestSubmit.RecDate <= @StringDateEnd)
		GROUP BY	SUBSTRING(CONVERT(varchar(25), pSampleRequestSubmit.RecDate, 120), 1, 10)
		
		--Loop to populate the broken down temp table with dates only.
		WHILE(@DateTimeBegin <= @DateTimeEnd)
			BEGIN
				--Add each day of the specified date range one day at a time.
				INSERT INTO #tempBrokenDown (RecDate)
				VALUES (SUBSTRING(CONVERT(varchar(25), @DateTimeBegin, 120), 1, 10))
		
				--Move to the next day.
				SET @DateTimeBegin = DATEADD(day, 1, @DateTimeBegin)
			END
		
		--Update the broken down temp table with numbers.
		UPDATE	#tempBrokenDown
		SET	#tempBrokenDown.[Count] = #tempReceivedSamples.[Count]
		FROM	#tempReceivedSamples
			INNER JOIN #tempBrokenDown ON #tempReceivedSamples.RecDate = #tempBrokenDown.RecDate
		
		--Fill in the NULLS with zeros.
		UPDATE	#tempBrokenDown
		SET	[Count] = 0
		WHERE	[Count] IS NULL
		
		--Get the data from the broken down temp table.
		SELECT	[Count], RecDate
		FROM	#tempBrokenDown
	END
ELSE IF(@Flag = 7)	--Submits received this quarter.
	BEGIN
		--Get the integer equivalent of the month and the year.
		SET @Year = DATEPART(yyyy, @DateTime)
		SET @Month = DATEPART(mm, @DateTime)
		
		--Set the beginning month for the Quarter depending on the current month.
		IF(@Month = 1 OR @Month = 2 OR @Month = 3)
			BEGIN
				SET @DateTimeBegin = CAST(@Year AS varchar(4)) + '-01-01'
			END
		ELSE IF(@Month = 4 OR @Month = 5 OR @Month = 6)
			BEGIN
				SET @DateTimeBegin = CAST(@Year AS varchar(4)) + '-04-01'
			END
		ELSE IF(@Month = 7 OR @Month = 8 OR @Month = 9)
			BEGIN
				SET @DateTimeBegin = CAST(@Year AS varchar(4)) + '-07-01'
			END
		ELSE IF(@Month = 10 OR @Month = 11 OR @Month = 12)
			BEGIN
				SET @DateTimeBegin = CAST(@Year AS varchar(4)) + '-10-01'
			END
		
		--Set the ending date to 3 months ahead.
		SET @DateTimeEnd = DATEADD(month, 3, @DateTimeBegin)
		
		--Set the ending date to one day less than the ending date of 3 months ahead.
		SET @DateTimeEnd = DATEADD(day, -1, @DateTimeEnd)
		
		--Set beginning and end of month date variables to a short date format.
		SET @StringDateBegin = SUBSTRING(CONVERT(varchar(25), @DateTimeBegin, 120), 1, 10)
		SET @StringDateEnd = SUBSTRING(CONVERT(varchar(25), @DateTimeEnd, 120), 1, 10)
		
		--Set two variables to the beginning and end of the current month.
		SET @StringDateBegin = @StringDateBegin + ' 00:00:00.000'
		SET @StringDateEnd = @StringDateEnd + ' 23:59:59.998'
		
		--Get received samples for current month.
		SELECT
			uTradePartner.TradePartnerName,
			uTradePartnerVendor.VendorName,
			pStyleHeader.StyleNo,
			pStyleHeader.SizeClass,
			pStyleHeader.SizeRange,
			pSampleRequestSubmitStatus.Status,
			pSampleRequestSubmit.Submit,
			pSampleRequestSubmit.RecDate,
			pSampleRequestSubmit.RecBy
		FROM	pSampleRequestSubmit
			LEFT OUTER JOIN pSampleRequestSubmitStatus ON 	(pSampleRequestSubmit.Status = pSampleRequestSubmitStatus.StatusID)
			INNER JOIN pStyleHeader ON	(pSampleRequestSubmit.StyleID = pStyleHeader.StyleID)
			LEFT OUTER JOIN uTradePartner ON	(pSampleRequestSubmit.TradePartnerID = uTradePartner.TradePartnerID)
			LEFT OUTER JOIN uTradePartnerVendor ON	(pSampleRequestSubmit.TradePartnerVendorID = uTradePartnerVendor.TradePartnerVendorID)
		WHERE	(pSampleRequestSubmit.RecDate >= @StringDateBegin
				AND	pSampleRequestSubmit.RecDate <= @StringDateEnd)
		ORDER BY	uTradePartner.TradePartnerName,
			uTradePartnerVendor.VendorName,
			pStyleHeader.StyleNo,
			pStyleHeader.SizeClass,
			pStyleHeader.SizeRange
	END
ELSE IF(@Flag = 8)	--Submits received this quarter, broken down by day.
	BEGIN
		--Get the integer equivalent of the month and the year.
		SET @Year = DATEPART(yyyy, @DateTime)
		SET @Month = DATEPART(mm, @DateTime)
		
		--Set the beginning month for the Quarter depending on the current month.
		IF(@Month = 1 OR @Month = 2 OR @Month = 3)
			BEGIN
				SET @DateTimeBegin = CAST(@Year AS varchar(4)) + '-01-01'
			END
		ELSE IF(@Month = 4 OR @Month = 5 OR @Month = 6)
			BEGIN
				SET @DateTimeBegin = CAST(@Year AS varchar(4)) + '-04-01'
			END
		ELSE IF(@Month = 7 OR @Month = 8 OR @Month = 9)
			BEGIN
				SET @DateTimeBegin = CAST(@Year AS varchar(4)) + '-07-01'
			END
		ELSE IF(@Month = 10 OR @Month = 11 OR @Month = 12)
			BEGIN
				SET @DateTimeBegin = CAST(@Year AS varchar(4)) + '-10-01'
			END
		
		--Set the ending date to 3 months ahead.
		SET @DateTimeEnd = DATEADD(month, 3, @DateTimeBegin)
		
		--Set the ending date to one day less than the ending date of 3 months ahead.
		SET @DateTimeEnd = DATEADD(day, -1, @DateTimeEnd)
		
		--Set beginning and end of month date variables to a short date format.
		SET @StringDateBegin = SUBSTRING(CONVERT(varchar(25), @DateTimeBegin, 120), 1, 10)
		SET @StringDateEnd = SUBSTRING(CONVERT(varchar(25), @DateTimeEnd, 120), 1, 10)
		
		--Set two variables to the beginning and end of the current month.
		SET @StringDateBegin = @StringDateBegin + ' 00:00:00.000'
		SET @StringDateEnd = @StringDateEnd + ' 23:59:59.998'
		
		--Set the datetime versions of the beginning and end of the date range to use for the loop.
		SET @DateTimeBegin = @StringDateBegin
		SET @DateTimeEnd = @StringDateEnd
		
		--Get received samples for specified date range.
		INSERT INTO #tempReceivedSamples ([Count], RecDate)
		SELECT	COUNT(*), SUBSTRING(CONVERT(varchar(25), pSampleRequestSubmit.RecDate, 120), 1, 10) AS RecDate
		FROM	pSampleRequestSubmit
		WHERE	(pSampleRequestSubmit.RecDate >= @StringDateBegin
				AND	pSampleRequestSubmit.RecDate <= @StringDateEnd)
		GROUP BY	SUBSTRING(CONVERT(varchar(25), pSampleRequestSubmit.RecDate, 120), 1, 10)
		
		--Loop to populate the broken down temp table with dates only.
		WHILE(@DateTimeBegin <= @DateTimeEnd)
			BEGIN
				--Add each day of the specified date range one day at a time.
				INSERT INTO #tempBrokenDown (RecDate)
				VALUES (SUBSTRING(CONVERT(varchar(25), @DateTimeBegin, 120), 1, 10))
		
				--Move to the next day.
				SET @DateTimeBegin = DATEADD(day, 1, @DateTimeBegin)
			END
		
		--Update the broken down temp table with numbers.
		UPDATE	#tempBrokenDown
		SET	#tempBrokenDown.[Count] = #tempReceivedSamples.[Count]
		FROM	#tempReceivedSamples
			INNER JOIN #tempBrokenDown ON #tempReceivedSamples.RecDate = #tempBrokenDown.RecDate
		
		--Fill in the NULLS with zeros.
		UPDATE	#tempBrokenDown
		SET	[Count] = 0
		WHERE	[Count] IS NULL
		
		--Get the data from the broken down temp table.
		SELECT	[Count], RecDate
		FROM	#tempBrokenDown
	END
ELSE IF(@Flag = 9)	--Submits received this quarter, broken down by month.
	BEGIN
		--Get the integer equivalent of the month and the year.
		SET @Year = DATEPART(yyyy, @DateTime)
		SET @Month = DATEPART(mm, @DateTime)
		
		--Set the beginning month for the Quarter depending on the current month.
		IF(@Month = 1 OR @Month = 2 OR @Month = 3)
			BEGIN
				SET @DateTimeBegin = CAST(@Year AS varchar(4)) + '-01-01'
			END
		ELSE IF(@Month = 4 OR @Month = 5 OR @Month = 6)
			BEGIN
				SET @DateTimeBegin = CAST(@Year AS varchar(4)) + '-04-01'
			END
		ELSE IF(@Month = 7 OR @Month = 8 OR @Month = 9)
			BEGIN
				SET @DateTimeBegin = CAST(@Year AS varchar(4)) + '-07-01'
			END
		ELSE IF(@Month = 10 OR @Month = 11 OR @Month = 12)
			BEGIN
				SET @DateTimeBegin = CAST(@Year AS varchar(4)) + '-10-01'
			END
		
		--Set the ending date to 3 months ahead.
		SET @DateTimeEnd = DATEADD(month, 3, @DateTimeBegin)
		
		--Set the ending date to one day less than the ending date of 3 months ahead.
		SET @DateTimeEnd = DATEADD(day, -1, @DateTimeEnd)
		
		--Set beginning and end of month date variables to a short date format.
		SET @StringDateBegin = SUBSTRING(CONVERT(varchar(25), @DateTimeBegin, 120), 1, 10)
		SET @StringDateEnd = SUBSTRING(CONVERT(varchar(25), @DateTimeEnd, 120), 1, 10)
		
		--Set two variables to the beginning and end of the current month.
		SET @StringDateBegin = @StringDateBegin + ' 00:00:00.000'
		SET @StringDateEnd = @StringDateEnd + ' 23:59:59.998'
		
		--Set the datetime versions of the beginning and end of the date range to use for the loop.
		SET @DateTimeBegin = @StringDateBegin
		SET @DateTimeEnd = @StringDateEnd
		
		--Get received samples for specified date range.
		INSERT INTO #tempReceivedSamples ([Count], RecDate)
		SELECT	COUNT(*), SUBSTRING(CONVERT(varchar(25), pSampleRequestSubmit.RecDate, 120), 1, 7) AS RecDate
		FROM	pSampleRequestSubmit
		WHERE	(pSampleRequestSubmit.RecDate >= @StringDateBegin
				AND	pSampleRequestSubmit.RecDate <= @StringDateEnd)
		GROUP BY	SUBSTRING(CONVERT(varchar(25), pSampleRequestSubmit.RecDate, 120), 1, 7)
		
		--Loop to populate the broken down temp table with dates only.
		WHILE(@DateTimeBegin <= @DateTimeEnd)
			BEGIN
				--Add each month of the specified date range one day at a time.
				INSERT INTO #tempBrokenDown (RecDate)
				VALUES (SUBSTRING(CONVERT(varchar(25), @DateTimeBegin, 120), 1, 7))
		
				--Move to the next month.
				SET @DateTimeBegin = DATEADD(month, 1, @DateTimeBegin)
			END
		
		--Update the broken down temp table with numbers.
		UPDATE	#tempBrokenDown
		SET	#tempBrokenDown.[Count] = #tempReceivedSamples.[Count]
		FROM	#tempReceivedSamples
			INNER JOIN #tempBrokenDown ON #tempReceivedSamples.RecDate = #tempBrokenDown.RecDate
		
		--Fill in the NULLS with zeros.
		UPDATE	#tempBrokenDown
		SET	[Count] = 0
		WHERE	[Count] IS NULL
		
		--Get the data from the broken down temp table.
		SELECT	[Count], RecDate
		FROM	#tempBrokenDown
	END
ELSE IF(@Flag = 10)	--Submits received this year.
	BEGIN
		--Get the integer equivalent of the year.
		SET @Year = DATEPART(yyyy, @DateTime)
		
		--Set the date for the beginning and end of the year.
		SET @DateTimeBegin = CAST(@Year AS varchar(4)) + '-01-01'
		SET @DateTimeEnd = CAST(@Year AS varchar(4)) + '-12-31'
		
		--Set beginning and end of month date variables to a short date format.
		SET @StringDateBegin = SUBSTRING(CONVERT(varchar(25), @DateTimeBegin, 120), 1, 10)
		SET @StringDateEnd = SUBSTRING(CONVERT(varchar(25), @DateTimeEnd, 120), 1, 10)
		
		--Set two variables to the beginning and end of the current month.
		SET @StringDateBegin = @StringDateBegin + ' 00:00:00.000'
		SET @StringDateEnd = @StringDateEnd + ' 23:59:59.998'
		
		--Get received samples for current month.
		SELECT
			uTradePartner.TradePartnerName,
			uTradePartnerVendor.VendorName,
			pStyleHeader.StyleNo,
			pStyleHeader.SizeClass,
			pStyleHeader.SizeRange,
			pSampleRequestSubmitStatus.Status,
			pSampleRequestSubmit.Submit,
			pSampleRequestSubmit.RecDate,
			pSampleRequestSubmit.RecBy
		FROM	pSampleRequestSubmit
			LEFT OUTER JOIN pSampleRequestSubmitStatus ON 	(pSampleRequestSubmit.Status = pSampleRequestSubmitStatus.StatusID)
			INNER JOIN pStyleHeader ON	(pSampleRequestSubmit.StyleID = pStyleHeader.StyleID)
			LEFT OUTER JOIN uTradePartner ON	(pSampleRequestSubmit.TradePartnerID = uTradePartner.TradePartnerID)
			LEFT OUTER JOIN uTradePartnerVendor ON	(pSampleRequestSubmit.TradePartnerVendorID = uTradePartnerVendor.TradePartnerVendorID)
		WHERE	(pSampleRequestSubmit.RecDate >= @StringDateBegin
				AND	pSampleRequestSubmit.RecDate <= @StringDateEnd)
		ORDER BY	uTradePartner.TradePartnerName,
			uTradePartnerVendor.VendorName,
			pStyleHeader.StyleNo,
			pStyleHeader.SizeClass,
			pStyleHeader.SizeRange
	END
ELSE IF(@Flag = 11)	--Submits received this year, broken down by month.
	BEGIN
		--Get the integer equivalent of the year.
		SET @Year = DATEPART(yyyy, @DateTime)
		
		--Set the date for the beginning and end of the year.
		SET @DateTimeBegin = CAST(@Year AS varchar(4)) + '-01-01'
		SET @DateTimeEnd = CAST(@Year AS varchar(4)) + '-12-31'
		
		--Set beginning and end of month date variables to a short date format.
		SET @StringDateBegin = SUBSTRING(CONVERT(varchar(25), @DateTimeBegin, 120), 1, 10)
		SET @StringDateEnd = SUBSTRING(CONVERT(varchar(25), @DateTimeEnd, 120), 1, 10)
		
		--Set two variables to the beginning and end of the current month.
		SET @StringDateBegin = @StringDateBegin + ' 00:00:00.000'
		SET @StringDateEnd = @StringDateEnd + ' 23:59:59.998'
		
		--Set the datetime versions of the beginning and end of the date range to use for the loop.
		SET @DateTimeBegin = @StringDateBegin
		SET @DateTimeEnd = @StringDateEnd
		
		--Get received samples for specified date range.
		INSERT INTO #tempReceivedSamples ([Count], RecDate)
		SELECT	COUNT(*), SUBSTRING(CONVERT(varchar(25), pSampleRequestSubmit.RecDate, 120), 1, 7) AS RecDate
		FROM	pSampleRequestSubmit
		WHERE	(pSampleRequestSubmit.RecDate >= @StringDateBegin
				AND	pSampleRequestSubmit.RecDate <= @StringDateEnd)
		GROUP BY	SUBSTRING(CONVERT(varchar(25), pSampleRequestSubmit.RecDate, 120), 1, 7)
		
		--Loop to populate the broken down temp table with dates only.
		WHILE(@DateTimeBegin <= @DateTimeEnd)
			BEGIN
				--Add each month of the specified date range one day at a time.
				INSERT INTO #tempBrokenDown (RecDate)
				VALUES (SUBSTRING(CONVERT(varchar(25), @DateTimeBegin, 120), 1, 7))
		
				--Move to the next month.
				SET @DateTimeBegin = DATEADD(month, 1, @DateTimeBegin)
			END
		
		--Update the broken down temp table with numbers.
		UPDATE	#tempBrokenDown
		SET	#tempBrokenDown.[Count] = #tempReceivedSamples.[Count]
		FROM	#tempReceivedSamples
			INNER JOIN #tempBrokenDown ON #tempReceivedSamples.RecDate = #tempBrokenDown.RecDate
		
		--Fill in the NULLS with zeros.
		UPDATE	#tempBrokenDown
		SET	[Count] = 0
		WHERE	[Count] IS NULL
		
		--Get the data from the broken down temp table.
		SELECT	[Count], RecDate
		FROM	#tempBrokenDown
	END

--Drop all Temp tables.
DROP TABLE #tempReceivedSamples
DROP TABLE #tempBrokenDown





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_Material_AgentSearch_SELECT]'
GO
ALTER VIEW [dbo].[vwx_Material_AgentSearch_SELECT]
AS
SELECT     dbo.pMaterialTradePartner.MaterialTradePartnerCustom1, dbo.pMaterial.MaterialID, dbo.pMaterial.TempID, dbo.pMaterial.TempNo, 
                      dbo.pMaterial.MaterialImageID, dbo.pMaterial.MaterialImageVersion, dbo.pMaterial.MaterialImageDetailID, dbo.pMaterial.MaterialImageDetailVersion, 
                      dbo.pMaterial.NoColorMatch, dbo.pMaterial.SupplierID, dbo.pMaterial.MaterialType, dbo.pMaterial.MaterialNo, dbo.pMaterial.MaterialName, 
                      dbo.pMaterial.A, dbo.pMaterial.B, dbo.pMaterial.C, dbo.pMaterial.D, dbo.pMaterial.G, dbo.pMaterial.H, dbo.pMaterial.I, dbo.pMaterial.J, 
                      dbo.pMaterial.K, dbo.pMaterial.L, dbo.pMaterial.M, dbo.pMaterial.N, dbo.pMaterial.O, dbo.pMaterial.P, dbo.pMaterial.Q, dbo.pMaterial.R, 
                      dbo.pMaterial.S, dbo.pMaterial.T, dbo.pMaterial.U, dbo.pMaterial.V, dbo.pMaterial.W, dbo.pMaterial.X, dbo.pMaterial.Y, dbo.pMaterial.Z, 
                      dbo.pMaterial.Source, dbo.pMaterial.Notes, dbo.pMaterial.VendorPrice, dbo.pMaterial.VolumePrice, dbo.pMaterial.VolumePriceMinimum, 
                      dbo.pMaterial.VendorProductionMin, dbo.pMaterial.VendorProductionLeadTime, dbo.pMaterial.MaterialPlacement, dbo.pMaterial.DetailYesNo, 
                      dbo.pMaterial.ImageType1, dbo.pMaterial.height, dbo.pMaterial.width, dbo.pMaterial.CDate, dbo.pMaterial.CUser, dbo.pMaterial.MDate, 
                      dbo.pMaterial.MUser, dbo.pMaterial.MChange, dbo.pMaterial.DChange, dbo.pMaterial.Action, dbo.pMaterial.Status, dbo.pMaterial.Active, 
                      dbo.pMaterialTradePartner.TradepartnerVendorId, dbo.pMaterial.MultiDimension, dbo.pMaterial.UOM, dbo.pMaterial.SAPCode, 
                      dbo.pMaterial.MaterialCode, dbo.pMaterial.MaterialColorRequired, dbo.pMaterial.FactorySourced
FROM         dbo.pMaterial LEFT OUTER JOIN
                      dbo.pMaterialTradePartner ON dbo.pMaterial.MaterialID = dbo.pMaterialTradePartner.MaterialId
Group BY dbo.pMaterialTradePartner.MaterialTradePartnerCustom1, dbo.pMaterial.MaterialID, dbo.pMaterial.TempID, dbo.pMaterial.TempNo, 
                      dbo.pMaterial.MaterialImageID, dbo.pMaterial.MaterialImageVersion, dbo.pMaterial.MaterialImageDetailID, dbo.pMaterial.MaterialImageDetailVersion, 
                      dbo.pMaterial.NoColorMatch, dbo.pMaterial.SupplierID, dbo.pMaterial.MaterialType, dbo.pMaterial.MaterialNo, dbo.pMaterial.MaterialName, 
                      dbo.pMaterial.A, dbo.pMaterial.B, dbo.pMaterial.C, dbo.pMaterial.D, dbo.pMaterial.G, dbo.pMaterial.H, dbo.pMaterial.I, dbo.pMaterial.J, 
                      dbo.pMaterial.K, dbo.pMaterial.L, dbo.pMaterial.M, dbo.pMaterial.N, dbo.pMaterial.O, dbo.pMaterial.P, dbo.pMaterial.Q, dbo.pMaterial.R, 
                      dbo.pMaterial.S, dbo.pMaterial.T, dbo.pMaterial.U, dbo.pMaterial.V, dbo.pMaterial.W, dbo.pMaterial.X, dbo.pMaterial.Y, dbo.pMaterial.Z, 
                      dbo.pMaterial.Source, dbo.pMaterial.Notes, dbo.pMaterial.VendorPrice, dbo.pMaterial.VolumePrice, dbo.pMaterial.VolumePriceMinimum, 
                      dbo.pMaterial.VendorProductionMin, dbo.pMaterial.VendorProductionLeadTime, dbo.pMaterial.MaterialPlacement, dbo.pMaterial.DetailYesNo, 
                      dbo.pMaterial.ImageType1, dbo.pMaterial.height, dbo.pMaterial.width, dbo.pMaterial.CDate, dbo.pMaterial.CUser, dbo.pMaterial.MDate, 
                      dbo.pMaterial.MUser, dbo.pMaterial.MChange, dbo.pMaterial.DChange, dbo.pMaterial.Action, dbo.pMaterial.Status, dbo.pMaterial.Active, 
                      dbo.pMaterialTradePartner.TradepartnerVendorId, dbo.pMaterial.MultiDimension, dbo.pMaterial.UOM, dbo.pMaterial.SAPCode, 
                      dbo.pMaterial.MaterialCode, dbo.pMaterial.MaterialColorRequired, dbo.pMaterial.FactorySourced


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_DesktopAccessStyleFolderCheck_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_Group_DesktopAccessStyleFolderCheck_INSERT] (
@GroupID uniqueidentifier, 
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

DECLARE @I as int
DECLARE @Row_Count int
DECLARE @StyleTypeID int 
DECLARE @DeskAccessId int
DECLARE @DeskTableName varchar(100)
DECLARE @DeskTableKey varchar(50)


	BEGIN
	CREATE TABLE #TempGroupAccess (
		Id int IDENTITY (1, 1) NOT NULL , 
		StyleTypeID int NOT NULL,
		GroupID uniqueidentifier 
	) 
	END

	BEGIN
	
	INSERT INTO #TempGroupAccess( StyleTypeID) SELECT StyleTypeID FROM pStyleType
	
	
	SET @Row_Count = (SELECT COUNT(*) FROM #TempGroupAccess)
	
	SET @I = 1

	WHILE @I <= @Row_Count 
		BEGIN

			SELECT @StyleTypeID = StyleTypeID FROM #TempGroupAccess WHERE ID = @I
			IF (SELECT COUNT(*) FROM sAccessGroupStyleFolder WITH (NOLOCK) WHERE StyleTypeId = @StyleTypeID  AND GroupID = @GroupID ) = 0
			BEGIN
				INSERT INTO sAccessGroupStyleFolder
					( StyleTypeId, GroupID, CUser, CDate, MUser, MDate)
				SELECT StyleTypeId, @GroupID, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate 
				FROM  #TempGroupAccess WHERE Id = @I
			END
				
			SET @I = @I + 1
		END

		SELECT * FROM #tempGroupAccess

	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_TradePartner_UPDATE]'
GO

ALTER PROCEDURE [dbo].[spx_TradePartner_UPDATE]
(@TradePartnerID uniqueidentifier)
AS 

DECLARE @TradePartnerType nvarchar(50)

	SELECT @TradePartnerType = TradePartnerType FROM uTradePartner WITH (NOLOCK) WHERE TradepartnerID = @TradePartnerID

	IF @TradePartnerType = '2'
		BEGIN
			DELETE uTradePartnerVendor WHERE TradePartnerVendorID = @TradePartnerID
			INSERT INTO dbo.uTradePartnerVendor
			(TradePartnerVendorID, TradePartnerID, VendorCode, VendorName, Address1, Address2, City, State, PostalCode, Country, PhoneNumber, FaxNumber, 
			MUser, MDate, Active)
			SELECT @TradePartnerId AS TradePartnerVendorID, TradePartnerID, TradePartnerCode, TradePartnerName, Address1, Address2, City, State, PostalCode, 
			Country, PhoneNumber, FaxNumber, MUser, MDate, Active
			FROM  uTradePartner WITH (NOLOCK) WHERE TradePartnerID = @TradePartnerID
		END
	ELSE
		BEGIN
			DELETE uTradePartnerVendor WHERE TradePartnerVendorID = @TradePartnerID
		END





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleColorwaySeasonYear_PIVOT]'
GO
ALTER PROCEDURE [dbo].[spx_StyleColorwaySeasonYear_PIVOT](@StyleId uniqueidentifier)
AS 



/*

select  a.StyleSeasonYearID, a.StyleColorwayID, a.StyleColorwaySeasonYearID,
	case when StyleColorDelivery1 = 1 then StyleColorStatus	else 900 end as StyleColorDelivery1,
	case when StyleColorDelivery2 = 1 then StyleColorStatus	else 900 end as StyleColorDelivery2,
	case when StyleColorDelivery3 = 1 then StyleColorStatus else 900 end as StyleColorDelivery3,
	case when StyleColorDelivery4 = 1 then StyleColorStatus	else 900 end as StyleColorDelivery4
INTO #StyleColorSeasonYear
from pStyleColorwaySeasonYear a
where a.StyleID = @StyleID


SELECT pStyleColorway.StyleColorID, #StyleColorSeasonYear.StyleColorwaySeasonYearID, pStyleSeasonYear.StyleSeasonYearID, pSeasonYear.SeasonYearID, 
	pStyleColorway.StyleColorNo, pStyleColorway.StyleColorName, pStyleColorway.PLMCode, pStyleColorway.SAPCode,  
	pSeasonYear.Season + ' ' + pSeasonYear.Year AS SeasonYear, 
	'<TABLE cellSpacing=''0'' cellPadding=''0'' width=''100%'' border=''0''><TR>
	<TD width=''16''><IMG src=''' + '' + CAST(ISNULL(pStyleColorwayStatus_1.StatusIconUrl,'../System/icons/icon_tranparent.gif') AS VARCHAR(40)) + ''' border=0 ALT=''' + CAST(ISNULL(pStyleColorwayStatus_1.Status,'900') AS VARCHAR(40)) + '''></TD>
	<TD width=''16''><IMG src=''' + '' + CAST(ISNULL(pStyleColorwayStatus_2.StatusIconUrl,'../System/icons/icon_tranparent.gif') AS VARCHAR(40)) + ''' border=0 ALT=''' + CAST(ISNULL(pStyleColorwayStatus_2.Status,'900') AS VARCHAR(40)) + '''></TD>
	<TD width=''16''><IMG src=''' + '' + CAST(ISNULL(pStyleColorwayStatus_3.StatusIconUrl,'../System/icons/icon_tranparent.gif') AS VARCHAR(40)) + ''' border=0 ALT=''' + CAST(ISNULL(pStyleColorwayStatus_3.Status,'900') AS VARCHAR(40)) + '''></TD>
	</TR></TABLE>' AS Color, 
	'<TABLE cellSpacing=''0'' cellPadding=''0'' width=''100%'' border=''0''><TR><TD width=''18''> 
	<IMG src=''' + '../System/Control/ColorStream.ashx?S=16&CFID=' + CAST(pColorPalette.ColorFolderID AS VARCHAR(40)) + 
	'&CPID=' + CAST(pColorPalette.ColorPaletteID AS VARCHAR(40)) + ''' border=0 ALT=''''></TD></TR></TABLE>' AS ColorUrl
INTO #tmpStyleColorSeasonYear
FROM pStyleColorwayStatus AS pStyleColorwayStatus_1 RIGHT OUTER JOIN
  pStyleColorwayStatus AS pStyleColorwayStatus_2 RIGHT OUTER JOIN
  pStyleSeasonYear INNER JOIN
  #StyleColorSeasonYear ON pStyleSeasonYear.StyleSeasonYearID = #StyleColorSeasonYear.StyleSeasonYearID INNER JOIN
  pSeasonYear ON pStyleSeasonYear.SeasonYearID = pSeasonYear.SeasonYearID LEFT OUTER JOIN
  pStyleColorwayStatus AS pStyleColorwayStatus_3 ON #StyleColorSeasonYear.StyleColorDelivery3 = pStyleColorwayStatus_3.StatusID ON 
  pStyleColorwayStatus_2.StatusID = #StyleColorSeasonYear.StyleColorDelivery2 RIGHT OUTER JOIN
  pStyleColorway ON #StyleColorSeasonYear.StyleColorwayID = pStyleColorway.StyleColorID LEFT OUTER JOIN
  pColorPalette ON pStyleColorway.ColorPaletteID = pColorPalette.ColorPaletteID ON 
  pStyleColorwayStatus_1.StatusID = #StyleColorSeasonYear.StyleColorDelivery1
WHERE pStyleColorway.StyleID = @StyleID
ORDER BY SeasonYear
*/



SELECT c.StyleColorID, a.StyleColorwaySeasonYearID, a.StyleSeasonYearID, f.SeasonYearID, 
	d.ColorCode as StyleColorNo, d.ColorName as StyleColorName , c.PLMCode, c.SAPCode,  
	f.Season + ' ' + f.Year AS SeasonYear, 

	'<TABLE cellSpacing=''0'' cellPadding=''0'' width=''100%'' border=''0''><TR>
	<TD width=''16''><IMG src=''' +  
		CASE WHEN a.StyleColorDelivery1 = 1 then 
			CAST(ISNULL(b.StatusIconUrl,'../System/icons/icon_tranparent.gif') AS VARCHAR(40)) + ''' border=0 ALT=''' + CAST(ISNULL(a.StyleColorStatus,'900') AS VARCHAR(40)) 
		ELSE
			'../System/icons/icon_tranparent.gif'' border=0 ALT=''900'''
		END
	+ '''></TD>


	<TD width=''16''><IMG src=''' +  
		CASE WHEN a.StyleColorDelivery2 = 1 then 
			CAST(ISNULL(b.StatusIconUrl,'../System/icons/icon_tranparent.gif') AS VARCHAR(40)) + ''' border=0 ALT=''' + CAST(ISNULL(a.StyleColorStatus,'900') AS VARCHAR(40)) 
		ELSE
			'../System/icons/icon_tranparent.gif'' border=0 ALT=''900'''
		END
	+ '''></TD>

	<TD width=''16''><IMG src=''' +  
		CASE WHEN a.StyleColorDelivery3 = 1 then 
			CAST(ISNULL(b.StatusIconUrl,'../System/icons/icon_tranparent.gif') AS VARCHAR(40)) + ''' border=0 ALT=''' + CAST(ISNULL(a.StyleColorStatus,'900') AS VARCHAR(40)) 
		ELSE
			'../System/icons/icon_tranparent.gif'' border=0 ALT=''900'''
		END
	+ '''></TD>

	</TR></TABLE>' AS Color, 
	'<TABLE cellSpacing=''0'' cellPadding=''0'' width=''100%'' border=''0''><TR><TD width=''18''> 
	<IMG src=''' + '../System/Control/ColorStream.ashx?S=16&CFID=' + CAST(d.ColorFolderID AS VARCHAR(40)) + 
	'&CPID=' + CAST(d.ColorPaletteID AS VARCHAR(40)) + ''' border=0 ALT=''''></TD></TR></TABLE>' AS ColorUrl

INTO #tmpStyleColorSeasonYear
FROM pStyleColorwaySeasonYear a
INNER JOIN pStyleColorwayStatus b ON a.StyleColorStatus = b.StatusID
INNER JOIN pStyleColorway c ON a.StyleColorwayID = c.StyleColorID
INNER JOIN pColorPalette d ON d.ColorPaletteID  = c.ColorPaletteID 
INNER JOIN pStyleSeasonYear e ON e.StyleSeasonYearID = a.StyleSeasonYearID
INNER JOIN pSeasonYear  f ON e.SeasonYearID = f.SeasonYearID 
WHERE c.StyleID = @StyleID
ORDER BY SeasonYear


-- select * from #tmpStyleColorSeasonYear

EXECUTE spx_Crosstab 
'SELECT SeasonYear, Color, StyleColorNo, StyleColorName FROM #tmpStyleColorSeasonYear',
NULL,
NULL,
'SeasonYear',
'Color',
'MAX'

DROP TABLE #tmpStyleColorSeasonYear
--DROP TABLE #StyleColorSeasonYear




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanItemSeasonYearAvailable_Logic_SELECT]'
GO


CREATE PROCEDURE [dbo].[spx_LinePlanItemSeasonYearAvailable_Logic_SELECT](
@StyleID  UNIQUEIDENTIFIER ,
@SeasonYearID UNIQUEIDENTIFIER
)
AS

DECLARE @LinePlanID UNIQUEIDENTIFIER
DECLARE @LinePlanItemID UNIQUEIDENTIFIER
DECLARE @LinePlanRangeTypeID UNIQUEIDENTIFIER
DECLARE @LinePlanRangeID UNIQUEIDENTIFIER

SELECT @LinePlanID = LinePlanID, @LinePlanItemID  = LinePlanItemID 
FROM pStyleSeasonYear 
WHERE StyleID = @StyleID AND SeasonYearID = @SeasonYearID


IF @LinePlanItemID IS NOT NULL
BEGIN 

	SELECT @LinePlanRangeID  = LinePlanRangeID , @LinePlanRangeTypeID = LinePlanRangeTypeID
	FROM pLinePlanItem WHERE LinePlanItemID = @LinePlanItemID

	IF ( SELECT COUNT(*) FROM pLinePlanItem 
		WHERE LinePlanID = @LinePlanID 
		AND LinePlanRangeID = @LinePlanRangeID
		AND LinePlanRangeTypeID = @LinePlanRangeTypeID
		AND StyleID = '00000000-0000-0000-0000-000000000000' ) = 0 
		SELECT @LinePlanItemID = NULL , @LinePlanID = NULL 

END 


SELECT @LinePlanItemID AS LinePlanItemID , @LinePlanID AS LinePlanID 




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSampleGrid_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_StyleSampleGrid_SELECT]
(
@TeamID nvarchar(50),
@StyleID nvarchar(50)
)
AS

DECLARE @UserID varchar(10), @sql varchar(8000), @delim varchar(1), @select varchar(8000), @enddate varchar(100), @duedate varchar(100), @pivot varchar(100), @table varchar(100)

SET NOCOUNT ON
SET ANSI_WARNINGS OFF

SET @UserID = (SELECT UserID FROM Users WITH (NOLOCK) WHERE (TeamID = @TeamID))

SELECT @select = 'SELECT dbo.pSampleRequestWorkflow.SampleRequestTradeID, dbo.pSampleRequestWorkflow.StyleColorID, dbo.pSampleRequestWorkflow.StyleID, dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.StyleNo AS [Style No], 
dbo.pStyleHeader.Description,
CASE 
WHEN pSampleRequestWorkflow.StyleSet = 1 THEN 
	CASE WHEN dbo.pStyleHeader.PC1 Is Not Null THEN dbo.pStyleHeader.PC1 ELSE ''1st Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 2 THEN 
	CASE WHEN dbo.pStyleHeader.PC2 Is Not Null THEN dbo.pStyleHeader.PC2 ELSE ''2nd Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 3 THEN 
	CASE WHEN dbo.pStyleHeader.PC3 Is Not Null THEN dbo.pStyleHeader.PC3 ELSE ''3rd Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 4 THEN 
	CASE WHEN dbo.pStyleHeader.PC4 Is Not Null THEN dbo.pStyleHeader.PC4 ELSE ''4th Set'' END 
END AS [Style Set], dbo.pStyleColorway.MainColor AS Color FROM dbo.pSampleRequestWorkflow WITH (NOLOCK) INNER JOIN 
dbo.pStyleHeader WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.StyleID = dbo.pStyleHeader.StyleID INNER JOIN 
dbo.pStyleColorway WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.StyleColorID = dbo.pStyleColorway.StyleColorID
GROUP BY dbo.pSampleRequestWorkflow.SampleRequestTradeID, dbo.pSampleRequestWorkflow.StyleID, dbo.pSampleRequestWorkflow.StyleColorID, 
dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.Description, 
dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.Pc1, dbo.pStyleHeader.Pc2, 
dbo.pStyleHeader.Pc3, dbo.pStyleHeader.Pc4, dbo.pSampleRequestWorkflow.TeamID, dbo.pStyleColorway.MainColor
HAVING dbo.pSampleRequestWorkflow.TeamID IN (SELECT TeamID FROM Users WITH (NOLOCK) WHERE UserID = ' + @UserID + ') 
AND (dbo.pSampleRequestWorkflow.StyleID = ''{' + @StyleID + '}''' + ') 
ORDER BY dbo.pStyleHeader.StyleNo, dbo.pSampleRequestWorkflow.StyleSet' 

--PRINT @SELECT

SELECT @enddate = 'MAX(dbo.pSampleRequestWorkflow.EndDate)'
SELECT @duedate = 'MAX(dbo.pSampleRequestWorkflow.DueDate)'
SELECT @pivot = 'pSampleRequestWorkflow.SampleWorkflowID'
SELECt @table = 'pSampleRequestWorkflow WITH (NOLOCK)'

--DROP TABLE ##SampleWorkflow

--EXEC ('SELECT pSampleRequestWorkflow.SampleWorkflowID AS pivot INTO ##SampleWorkflow FROM pSampleRequestWorkflow WITH (NOLOCK) WHERE 1=2')

EXEC ('SELECT ' + @pivot + ' AS tb_pivot INTO ##SampleWorkflow FROM ' + @table + ' WHERE 1=2')

EXEC ('INSERT INTO ##SampleWorkflow SELECT DISTINCT ' + @pivot + ' FROM ' + @table + ' WHERE TeamID = ''{' + @TeamID + '}''' + ' AND ' + @pivot + ' Is Not Null')

SELECT @sql='',  @duedate=stuff(@duedate, len(@duedate), 1, ' END)' )
SELECT @sql=@sql + '',  @enddate=stuff(@enddate, len(@enddate), 1, ' END)' )

SELECT @delim=CASE Sign( CharIndex('char', data_type) + CharIndex('date', data_type) ) 
WHEN 0 THEN '''' ELSE '''' END 
FROM tempdb.information_schema.columns 
WHERE table_name='##SampleWorkflow' AND column_name='tb_pivot'

SELECT @sql=@sql + '''D_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@duedate,charindex( '(', @duedate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
+ '''E_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@enddate,charindex( '(', @enddate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
FROM ##SampleWorkflow

--print @sql

SELECT @sql=left(@sql, len(@sql)-1)

--print @sql

SELECT @select=stuff(@select, charindex(' FROM ', @select)+1, 0, ', ' + @sql + ' ')

--print @select

DROP TABLE ##SampleWorkflow

EXEC (@select)


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleRequestMaterial_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_SampleRequestMaterial_SELECT] 
(@SampleRequestWorkflowID uniqueidentifier,
@SampleWorkflowID nvarchar(5),
@TeamID uniqueidentifier,
@StyleID uniqueidentifier,
@StyleSet nvarchar(5) = '1')
AS

DECLARE  @sql varchar(8000), @selectwhere varchar(8000), @delim varchar(1), @select varchar(8000), @duedate varchar(100), @recdate varchar(100), @revdate varchar(100), @status varchar(100), @pivot varchar(100), @table varchar(100)

DECLARE @subdate VARCHAR (100) 


SET NOCOUNT ON
SET ANSI_WARNINGS OFF


/*Begin: Script to automatically insert Materials into Material Sample Requests.*/
DECLARE @ComponentType varchar(4)


IF (@SampleWorkflowID = '25A') --License
	BEGIN

		INSERT INTO pSampleRequestMaterial
		      (SampleRequestTradeID, SampleRequestWorkflowID, Submit, StartDate, DueDate, EndDate, Status, SampleWorkflowID, StyleID, StyleColorID, StyleSet,
		       TradePartnerVendorID, StyleMaterialID, MainMaterial, Development, MiscColor, UOM, Qty, MaterialPrice, Ext, MaterialSize, MaterialID, 
		      MaterialPlacement, MaterialPlacementCode, MaterialPlacementDetail, MaterialImageID, MaterialImageVersion, NoColorMatch, SupplierID, 
		      ComponentTypeID, MaterialType, MaterialNo, MaterialName, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S, T, U, V, W, X, Y, Z, Source, Notes, Placement, VendorPrice, 
		      VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, DetailYesNo, ImageType, height, width, CDate, CUser, MDate, 
		      MUser, MChange, SChange, DChange, CChange, [Action], ColorPlacement, Artwork, License, Colorway)
		SELECT     pSampleRequestWorkflow.SampleRequestTradeID, pSampleRequestWorkflow.SampleRequestWorkflowID, pSampleRequestWorkflow.Submit, 
		      pSampleRequestWorkflow.StartDate, pSampleRequestWorkflow.DueDate, pSampleRequestWorkflow.EndDate, pSampleRequestWorkflow.Status, 
		      pSampleRequestWorkflow.SampleWorkflowID, pSampleRequestWorkflow.StyleID, pSampleRequestWorkflow.StyleColorID, 
		      pSampleRequestWorkflow.StyleSet, pSampleRequestWorkflow.TradePartnerVendorID, 
		      pStyleMaterials.StyleMaterialID, pStyleMaterials.MainMaterial, pStyleMaterials.Development, pStyleMaterials.MiscColor, pStyleMaterials.UOM, 
		      pStyleMaterials.Qty, pStyleMaterials.MaterialPrice, pStyleMaterials.Ext, pStyleMaterials.MaterialSize, pStyleMaterials.MaterialID, 
		      pStyleMaterials.MaterialPlacement, pStyleMaterials.MaterialPlacementCode, pStyleMaterials.MaterialPlacementDetail, 
		      pStyleMaterials.MaterialImageID, pStyleMaterials.MaterialImageVersion, pStyleMaterials.NoColorMatch, pStyleMaterials.SupplierID, 
		      pStyleMaterials.ComponentTypeID, pStyleMaterials.MaterialType, pStyleMaterials.MaterialNo, pStyleMaterials.MaterialName, pStyleMaterials.A, 
		      pStyleMaterials.B, pStyleMaterials.C, pStyleMaterials.D, pStyleMaterials.E, pStyleMaterials.F, pStyleMaterials.G, pStyleMaterials.H, pStyleMaterials.I, 
		      pStyleMaterials.J, pStyleMaterials.K, pStyleMaterials.L, pStyleMaterials.M, pStyleMaterials.N, pStyleMaterials.O, pStyleMaterials.P, 
		      pStyleMaterials.Q, pStyleMaterials.R, pStyleMaterials.S,  pStyleMaterials.T, pStyleMaterials.U, pStyleMaterials.V, pStyleMaterials.W, pStyleMaterials.X, pStyleMaterials.Y, pStyleMaterials.Z , 
	   	      pStyleMaterials.Source, pStyleMaterials.Notes, pStyleMaterials.Placement, 
		      pStyleMaterials.VendorPrice, pStyleMaterials.VolumePrice, pStyleMaterials.VolumePriceMinimum, pStyleMaterials.VendorProductionMin, 
		      pStyleMaterials.VendorProductionLeadTime, pStyleMaterials.DetailYesNo, pStyleMaterials.ImageType, pStyleMaterials.height, pStyleMaterials.width, 
		      pStyleMaterials.CDate, pStyleMaterials.CUser, pStyleMaterials.MDate, pStyleMaterials.MUser, pStyleMaterials.MChange, pStyleMaterials.SChange, 
		      pStyleMaterials.DChange, pStyleMaterials.CChange, pStyleMaterials.[Action], pStyleMaterials.ColorPlacement, pStyleMaterials.Artwork, 
		      pStyleMaterials.License, pStyleMaterials.Colorway
		FROM  pStyleMaterials WITH (NOLOCK) INNER JOIN pSampleRequestWorkflow WITH (NOLOCK) ON pStyleMaterials.StyleID = pSampleRequestWorkflow.StyleID AND 
		      pStyleMaterials.StyleSet = pSampleRequestWorkflow.StyleSet
		WHERE pStyleMaterials.StyleId = @StyleID AND pStyleMaterials.StyleSet = @StyleSet AND pStyleMaterials.MaterialTrack = 1 AND
			  pSampleRequestWorkflow.SampleRequestWorkflowID = @SampleRequestWorkflowID AND
			  (pStyleMaterials.StyleMaterialID NOT IN(SELECT StyleMaterialID FROM pSampleRequestMaterial WITH (NOLOCK) WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID)) AND
			  pStyleMaterials.License = 1

	END
ELSE IF (@SampleWorkflowID = '27A') --Artwork
	BEGIN


		INSERT INTO pSampleRequestMaterial
		      (SampleRequestTradeID, SampleRequestWorkflowID, Submit, StartDate, DueDate, EndDate, Status, SampleWorkflowID, StyleID, StyleColorID, StyleSet,
		       TradePartnerVendorID, StyleMaterialID, MainMaterial, Development, MiscColor, UOM, Qty, MaterialPrice, Ext, MaterialSize, MaterialID, 
		      MaterialPlacement, MaterialPlacementCode, MaterialPlacementDetail, MaterialImageID, MaterialImageVersion, NoColorMatch, SupplierID, 
		      ComponentTypeID, MaterialType, MaterialNo, MaterialName, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S, T, U, V, W, X, Y, Z , Source, Notes, Placement, VendorPrice, 
		      VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, DetailYesNo, ImageType, height, width, CDate, CUser, MDate, 
		      MUser, MChange, SChange, DChange, CChange, [Action], ColorPlacement, Artwork, License, Colorway)
		SELECT     pSampleRequestWorkflow.SampleRequestTradeID, pSampleRequestWorkflow.SampleRequestWorkflowID, pSampleRequestWorkflow.Submit, 
		      pSampleRequestWorkflow.StartDate, pSampleRequestWorkflow.DueDate, pSampleRequestWorkflow.EndDate, pSampleRequestWorkflow.Status, 
		      pSampleRequestWorkflow.SampleWorkflowID, pSampleRequestWorkflow.StyleID, pSampleRequestWorkflow.StyleColorID, 
		      pSampleRequestWorkflow.StyleSet, pSampleRequestWorkflow.TradePartnerVendorID, 
		      pStyleMaterials.StyleMaterialID, pStyleMaterials.MainMaterial, pStyleMaterials.Development, pStyleMaterials.MiscColor, pStyleMaterials.UOM, 
		      pStyleMaterials.Qty, pStyleMaterials.MaterialPrice, pStyleMaterials.Ext, pStyleMaterials.MaterialSize, pStyleMaterials.MaterialID, 
		      pStyleMaterials.MaterialPlacement, pStyleMaterials.MaterialPlacementCode, pStyleMaterials.MaterialPlacementDetail, 
		      pStyleMaterials.MaterialImageID, pStyleMaterials.MaterialImageVersion, pStyleMaterials.NoColorMatch, pStyleMaterials.SupplierID, 
		      pStyleMaterials.ComponentTypeID, pStyleMaterials.MaterialType, pStyleMaterials.MaterialNo, pStyleMaterials.MaterialName, pStyleMaterials.A, 
		      pStyleMaterials.B, pStyleMaterials.C, pStyleMaterials.D, pStyleMaterials.E, pStyleMaterials.F, pStyleMaterials.G, pStyleMaterials.H, pStyleMaterials.I, 
		      pStyleMaterials.J, pStyleMaterials.K, pStyleMaterials.L, pStyleMaterials.M, pStyleMaterials.N, pStyleMaterials.O, pStyleMaterials.P, 
		      pStyleMaterials.Q, pStyleMaterials.R, pStyleMaterials.S,  pStyleMaterials.T, pStyleMaterials.U, pStyleMaterials.V, pStyleMaterials.W, pStyleMaterials.X, pStyleMaterials.Y, pStyleMaterials.Z ,
   		     pStyleMaterials.Source, pStyleMaterials.Notes, pStyleMaterials.Placement, 
		      pStyleMaterials.VendorPrice, pStyleMaterials.VolumePrice, pStyleMaterials.VolumePriceMinimum, pStyleMaterials.VendorProductionMin, 
		      pStyleMaterials.VendorProductionLeadTime, pStyleMaterials.DetailYesNo, pStyleMaterials.ImageType, pStyleMaterials.height, pStyleMaterials.width, 
		      pStyleMaterials.CDate, pStyleMaterials.CUser, pStyleMaterials.MDate, pStyleMaterials.MUser, pStyleMaterials.MChange, pStyleMaterials.SChange, 
		      pStyleMaterials.DChange, pStyleMaterials.CChange, pStyleMaterials.[Action], pStyleMaterials.ColorPlacement, pStyleMaterials.Artwork, 
		      pStyleMaterials.License, pStyleMaterials.Colorway
		FROM  pStyleMaterials WITH (NOLOCK) INNER JOIN pSampleRequestWorkflow WITH (NOLOCK) ON pStyleMaterials.StyleID = pSampleRequestWorkflow.StyleID AND 
		      pStyleMaterials.StyleSet = pSampleRequestWorkflow.StyleSet
		WHERE pStyleMaterials.StyleId = @StyleID AND pStyleMaterials.StyleSet = @StyleSet AND pStyleMaterials.MaterialTrack = 1 AND
			  pSampleRequestWorkflow.SampleRequestWorkflowID = @SampleRequestWorkflowID AND
			  (pStyleMaterials.StyleMaterialID NOT IN(SELECT StyleMaterialID FROM pSampleRequestMaterial WITH (NOLOCK) WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID)) AND
			  pStyleMaterials.Artwork = 1


	END
--IF (@SampleWorkflowID = '14A' OR @SampleWorkflowID = '24A') --Trimming and Fabrication
ELSE
	BEGIN


		SELECT @ComponentType = GroupID FROM pSampleWorkflow WITH (NOLOCK) WHERE SampleWorkflowID = @SampleWorkflowID
		
		INSERT INTO pSampleRequestMaterial
		      (SampleRequestTradeID, SampleRequestWorkflowID, Submit, StartDate, DueDate, EndDate, Status, SampleWorkflowID, StyleID, StyleColorID, StyleSet,
		       TradePartnerVendorID, StyleMaterialID, MainMaterial, Development, MiscColor, UOM, Qty, MaterialPrice, Ext, MaterialSize, MaterialID, 
		      MaterialPlacement, MaterialPlacementCode, MaterialPlacementDetail, MaterialImageID, MaterialImageVersion, NoColorMatch, SupplierID, 
		      ComponentTypeID, MaterialType, MaterialNo, MaterialName, A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S,  T, U, V, W, X, Y, Z , Source, Notes, Placement, VendorPrice, 
		      VolumePrice, VolumePriceMinimum, VendorProductionMin, VendorProductionLeadTime, DetailYesNo, ImageType, height, width, CDate, CUser, MDate, 
		      MUser, MChange, SChange, DChange, CChange, [Action], ColorPlacement, Artwork, License, Colorway )
		SELECT     pSampleRequestWorkflow.SampleRequestTradeID, pSampleRequestWorkflow.SampleRequestWorkflowID, pSampleRequestWorkflow.Submit, 
		      pSampleRequestWorkflow.StartDate, pSampleRequestWorkflow.DueDate, pSampleRequestWorkflow.EndDate, pSampleRequestWorkflow.Status, 
		      pSampleRequestWorkflow.SampleWorkflowID, pSampleRequestWorkflow.StyleID, pSampleRequestWorkflow.StyleColorID, 
		      pSampleRequestWorkflow.StyleSet, pSampleRequestWorkflow.TradePartnerVendorID, 
		      pStyleMaterials.StyleMaterialID, pStyleMaterials.MainMaterial, pStyleMaterials.Development, pStyleMaterials.MiscColor, pStyleMaterials.UOM, 
		      pStyleMaterials.Qty, pStyleMaterials.MaterialPrice, pStyleMaterials.Ext, pStyleMaterials.MaterialSize, pStyleMaterials.MaterialID, 
		      pStyleMaterials.MaterialPlacement, pStyleMaterials.MaterialPlacementCode, pStyleMaterials.MaterialPlacementDetail, 
		      pStyleMaterials.MaterialImageID, pStyleMaterials.MaterialImageVersion, pStyleMaterials.NoColorMatch, pStyleMaterials.SupplierID, 
		      pStyleMaterials.ComponentTypeID, pStyleMaterials.MaterialType, pStyleMaterials.MaterialNo, pStyleMaterials.MaterialName, pStyleMaterials.A, 
		      pStyleMaterials.B, pStyleMaterials.C, pStyleMaterials.D, pStyleMaterials.E, pStyleMaterials.F, pStyleMaterials.G, pStyleMaterials.H, pStyleMaterials.I, 
		      pStyleMaterials.J, pStyleMaterials.K, pStyleMaterials.L, pStyleMaterials.M, pStyleMaterials.N, pStyleMaterials.O, pStyleMaterials.P, 
		      pStyleMaterials.Q, pStyleMaterials.R, pStyleMaterials.S, pStyleMaterials.T, pStyleMaterials.U, pStyleMaterials.V, pStyleMaterials.W, pStyleMaterials.X, pStyleMaterials.Y, pStyleMaterials.Z ,
			pStyleMaterials.Source, pStyleMaterials.Notes, pStyleMaterials.Placement, 
		      pStyleMaterials.VendorPrice, pStyleMaterials.VolumePrice, pStyleMaterials.VolumePriceMinimum, pStyleMaterials.VendorProductionMin, 
		      pStyleMaterials.VendorProductionLeadTime, pStyleMaterials.DetailYesNo, pStyleMaterials.ImageType, pStyleMaterials.height, pStyleMaterials.width, 
		      pStyleMaterials.CDate, pStyleMaterials.CUser, pStyleMaterials.MDate, pStyleMaterials.MUser, pStyleMaterials.MChange, pStyleMaterials.SChange, 
		      pStyleMaterials.DChange, pStyleMaterials.CChange, pStyleMaterials.[Action], pStyleMaterials.ColorPlacement, pStyleMaterials.Artwork, 
		      pStyleMaterials.License, pStyleMaterials.Colorway
		FROM  pStyleMaterials WITH (NOLOCK) INNER JOIN pSampleRequestWorkflow WITH (NOLOCK) ON pStyleMaterials.StyleID = pSampleRequestWorkflow.StyleID AND 
		      pStyleMaterials.StyleSet = pSampleRequestWorkflow.StyleSet
		WHERE pStyleMaterials.StyleId = @StyleID AND pStyleMaterials.StyleSet = @StyleSet AND pStyleMaterials.MaterialTrack = 1 AND
			  (pStyleMaterials.MaterialType IN (SELECT ComponentTypeID FROM pComponentType WITH (NOLOCK) WHERE ComponentType = @ComponentType)) AND
			  (pSampleRequestWorkflow.SampleRequestWorkflowID = @SampleRequestWorkflowID) AND 
			  (pStyleMaterials.StyleMaterialID NOT IN(SELECT StyleMaterialID FROM pSampleRequestMaterial WITH (NOLOCK) WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID))




		declare  @StyleSourcingID  uniqueidentifier 
		DECLARE  @SampleRequestTradeID  uniqueidentifier 


		SELECT @SampleRequestTradeID  =  SampleRequestTradeID  FROM  pSampleRequestMaterial WITH (NOLOCK)  WHERE  SampleRequestWorkflowID = @SampleRequestWorkflowID
		SELECT @StyleSourcingID  =  StyleSourcingID    FROM pSampleRequestTrade WITH (NOLOCK) where SampleRequestTradeID = @SampleRequestTradeID

	

		
		DECLARE @Row  int 
		DECLARE @Count  int 		
		DECLARE @SampleRequestMaterialID  UNIQUEIDENTIFIER 
		DECLARE @StyleMaterialID UNIQUEIDENTIFIER 
		DECLARE @StyleColorID UNIQUEIDENTIFIER 
		
		
		DECLARE @UOM NVARCHAR (50) 
		DECLARE @QTY  NVARCHAR (50) 
		DECLARE @Price money 
		DECLARE  @TradePartnerVendorID UNIQUEIDENTIFIER 
	
	
		if object_id('tempdb..#pSampleRequestMaterialTemp') is not null 
			drop table #pSampleRequestMaterialTemp

		
		CREATE TABLE #pSampleRequestMaterialTemp  (
			RowID  int IDENTITY (1,1) ,
			SampleRequestMaterialID uniqueidentifier, 
			StyleMaterialID  uniqueidentifier ,
			StyleColorID UNIQUEIDENTIFIER  
		)
		
		INSERT INTO   #pSampleRequestMaterialTemp ( SampleRequestMaterialID , StyleMaterialID  , StyleColorID  ) 
		SELECT SampleRequestMaterialID ,  StyleMaterialID  , StyleColorID  FROM  pSampleRequestMaterial WITH (NOLOCK)  
		WHERE SampleRequestTradeID = @SampleRequestTradeID


		
		SET @Row = 1
		SELECT @Count = count(*)  FROM #pSampleRequestMaterialTemp   

		
		IF @Count is null  SET @Count = 0 
		
		--print 'count ='  +  Cast ( @Count  as varchar(50) )
		
		WHILE  @Row <=  @Count 
		BEGIN 
			SET @SampleRequestMaterialID  =  NULL 
			SET @StyleMaterialID  =  NULL 
			SET @UOM = NULL 	
			SET @Qty = NULL 
			SET @Price  = NULL 
	
			SELECT @SampleRequestMaterialID  =  SampleRequestMaterialID  ,  @StyleMaterialID   =  StyleMaterialID  , @StyleColorID = StyleColorID  FROM #pSampleRequestMaterialTemp  WHERE  RowID = @Row 
			
			SELECT @TradePartnerVendorID = TradePartnerVendorID 
			--@UOM = UOM , @Qty = Qty ,  @Price = MaterialPrice , 
			FROM pStyleSourcingItem WITH (NOLOCK) WHERE  StyleSourcingID = @StyleSourcingID AND  StyleMaterialID = @StyleMaterialID AND StyleColorID = @StyleColorID 
	
			UPDATE pSampleRequestMaterial  SET  
			-- StyleSourcingID = @StyleSourcingID ,  SourcingUOM = @UOM , SourcingQty =  @Qty , SourcingPrice = @Price , 
			SourcingTradePartnerVendorID = @TradePartnerVendorID
			WHERE  SampleRequestMaterialID = @SampleRequestMaterialID  AND  StyleMaterialID   =  @StyleMaterialID 
	
			SET @Row   =  @Row  + 1 
		END 

		DROP TABLE #pSampleRequestMaterialTemp		

	END




/*End: Script to automatically insert Materials into Material Sample Requests.*/


--DROP TABLE ##SampleSpec
/*
SELECT @select = ' SELECT MainMaterial, StyleID, StyleSet, MaterialNo, MaterialName, MaterialSize FROM pSampleRequestMaterial WITH (NOLOCK)
GROUP BY MainMaterial, SampleRequestWorkflowID, SampleWorkflowID, TradePartnerVendorID, StyleID, StyleSet, StyleMaterialID, MaterialNo, MaterialName, MaterialSize '

SELECT @recdate = 'MAX(recdate)'
SELECT @duedate = 'MAX(DueDate)'
SELECT @revdate = 'MAX(EndDate)'


SELECT @pivot = 'Submit'
SELECt @table = 'pSampleRequestMaterial'

SELECT Submit AS pivot INTO ##SampleSpec FROM pSampleRequestMaterial WITH (NOLOCK) WHERE 1=2
INSERT INTO ##SampleSpec SELECT DISTINCT Submit FROM pSampleRequestMaterial WITH (NOLOCK) WHERE Submit Is Not Null AND StyleSet = @StyleSet AND StyleID = @StyleID AND SampleRequestWorkflowID = @SampleRequestWorkflowID AND SampleWorkflowID = @SampleWorkflowID


SELECT @sql='',  @recdate=stuff(@recdate, len(@recdate), 1, ' END)' )
SELECT @sql=@sql + '',  @duedate=stuff(@duedate, len(@duedate), 1, ' END)' )
SELECT @sql=@sql + ''  ,  @revdate= 'MAX (   END)' 

SELECT @delim=CASE Sign( CharIndex('char', data_type) + CharIndex('date', data_type) ) 
WHEN 0 THEN '''' ELSE '''' END 
FROM tempdb.information_schema.columns 
WHERE table_name='##SampleSpec' AND column_name='pivot'


SELECT @sql=@sql 
+ '''Due ' + convert(varchar(100), pivot) + ''' = ' + 
stuff(@duedate,charindex( '(', @duedate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), pivot) + @delim + ' THEN ' ) + ', ' 
+ '''Rec ' + convert(varchar(100), pivot) + ''' = ' + 
stuff(@recdate,charindex( '(', @recdate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), pivot) + @delim + ' THEN ' ) + ', '
+ '''Apr ' + convert(varchar(100), pivot) + ''' = ' + 
stuff(@revdate,charindex( '(', @revdate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), pivot) + @delim + ' THEN  Case Status  when 2 then EndDate  when 3 then EndDate else  NULL  END   '        ) + ', ' 
FROM ##SampleSpec


if  ( @sql is not null  AND len (@sql ) > 0 )
begin 
	SELECT @sql = left(@sql, len(@sql)-1)
	SELECT @select = stuff(@select, charindex(' FROM ', @select)+1, 0, ', ' + @sql + ' ')
end 



SELECT @selectwhere = ' HAVING  (StyleSet =' + '''' + convert(varchar(5),@StyleSet) + ''')  
AND (StyleID =' + '''' + convert(varchar(50),@StyleID) + ''') 
AND (SampleRequestWorkflowID =' + '''' + convert(varchar(50),@SampleRequestWorkflowID) + ''') 
AND (SampleWorkflowID =' + '''' + convert(varchar(50),@SampleWorkflowID) + ''') 
ORDER BY MainMaterial DESC, MaterialNo, MaterialName '


DROP TABLE ##SampleSpec

print @select + @selectwhere

EXEC (@select + @selectwhere)

*/




SELECT @select = ' SELECT MainMaterial, StyleID, StyleSet, MaterialNo, MaterialName, MaterialSize FROM pSampleRequestMaterial WITH (NOLOCK)
GROUP BY MainMaterial, SampleRequestWorkflowID, SampleWorkflowID, TradePartnerVendorID, StyleID, StyleSet, StyleMaterialID, MaterialNo, MaterialName, MaterialSize '

SELECT @subdate = 'MAX(EndDate)'

SELECT @revdate = 'MAX(EndDate)'



SELECT @pivot = 'Submit'
SELECt @table = 'pSampleRequestMaterial '

SELECT Submit AS tb_pivot INTO ##SampleSpec FROM pSampleRequestMaterial WITH (NOLOCK) WHERE 1=2
INSERT INTO ##SampleSpec SELECT DISTINCT Submit FROM pSampleRequestMaterial WITH (NOLOCK) WHERE Submit Is Not Null AND StyleSet = @StyleSet AND StyleID = @StyleID AND SampleRequestWorkflowID = @SampleRequestWorkflowID AND SampleWorkflowID = @SampleWorkflowID


SELECT @sql=''
SELECT @sql=@sql + '',  @subdate = 'MAX (   END)' 
SELECT @sql=@sql + ''  ,  @revdate = 'MAX (   END)' 


SELECT @delim=CASE Sign( CharIndex('char', data_type) + CharIndex('date', data_type) ) 
WHEN 0 THEN '''' ELSE '''' END 
FROM tempdb.information_schema.columns 
WHERE table_name='##SampleSpec' AND column_name='tb_pivot'


SELECT @sql=@sql 
+ '''Sub ' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@subdate,charindex( '(', @subdate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN  CASE Status  WHEN 1 THEN EndDate ELSE NULL  END   '        ) + ', ' 

+ '''Apr ' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@revdate,charindex( '(', @revdate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN  Case Status  when 2 then EndDate  when 3 then EndDate else  NULL  END   '        ) + ', ' 
FROM ##SampleSpec


if  ( @sql is not null  AND len (@sql ) > 0 )
begin 
	SELECT @sql = left(@sql, len(@sql)-1)
	SELECT @select = stuff(@select, charindex(' FROM ', @select)+1, 0, ', ' + @sql + ' ')
end 



SELECT @selectwhere = ' HAVING  (StyleSet =' + '''' + convert(varchar(5),@StyleSet) + ''')  
AND (StyleID =' + '''' + convert(varchar(50),@StyleID) + ''') 
AND (SampleRequestWorkflowID =' + '''' + convert(varchar(50),@SampleRequestWorkflowID) + ''') 
AND (SampleWorkflowID =' + '''' + convert(varchar(50),@SampleWorkflowID) + ''') 
ORDER BY MainMaterial DESC, MaterialNo, MaterialName '


DROP TABLE ##SampleSpec

print @select + @selectwhere

EXEC (@select + @selectwhere)




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_LinePlanItemList_SELECT]'
GO
EXEC sp_refreshview N'[dbo].[vwx_LinePlanItemList_SELECT]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanBreadCrumbStyleAttribute_SELECT]'
GO
CREATE PROCEDURE  [dbo].[spx_LinePlanBreadCrumbStyleAttribute_SELECT] (
@LinePlanId UNIQUEIDENTIFIER, 
@LinePlanIndex VARCHAR (1) , 
@LinePlanAttributeItemId1 UNIQUEIDENTIFIER, 
@LinePlanAttributeItemId2 UNIQUEIDENTIFIER, 
@LinePlanAttributeItemId3 UNIQUEIDENTIFIER, 
@LinePlanAttributeItemId4 UNIQUEIDENTIFIER,
@LinePlanStyleAttributeID UNIQUEIDENTIFIER
)
AS 

IF @LinePlanIndex = '1' 
BEGIN

	SELECT '00000000-0000-0000-0000-000000000001' AS LinePlanAttributeItemID, '' AS LinePlanAttributeText
	UNION 
	(SELECT  pLinePlanAttributeItem_1.LinePlanAttributeItemID , 
		pLinePlanAttributeItem_1.LinePlanAttributeText 
	FROM dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_3 RIGHT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_1 RIGHT OUTER JOIN
	  dbo.pLinePlanRange ON pLinePlanAttributeItem_1.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID1 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_2 ON dbo.pLinePlanRange.LinePlanAttributeItemID2 = pLinePlanAttributeItem_2.LinePlanAttributeItemID ON 
	  pLinePlanAttributeItem_3.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID3 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_4 ON dbo.pLinePlanRange.LinePlanAttributeItemID4 = pLinePlanAttributeItem_4.LinePlanAttributeItemID
	WHERE pLinePlanAttributeItem_1.LinePlanID = @LinePlanId
	AND pLinePlanRange.LinePlanFinancialID = '10000000-0000-0000-0000-000000000001' 
	AND pLinePlanRange.LinePlanRangeID NOT IN (
		SELECT LinePlanRangeID FROM pLinePlanStyleAttributeItem WHERE LinePlanStyleAttributeID = @LinePlanStyleAttributeID
	) 
	GROUP BY pLinePlanAttributeItem_1.LinePlanAttributeItemID  , pLinePlanAttributeItem_1.LinePlanAttributeText 
	)
	ORDER BY LinePlanAttributeText

END
ELSE IF @LinePlanIndex = '2'
BEGIN

	SELECT '00000000-0000-0000-0000-000000000002' AS LinePlanAttributeItemID, '' AS LinePlanAttributeText
	UNION 
	(SELECT  pLinePlanAttributeItem_2.LinePlanAttributeItemID ,
		pLinePlanAttributeItem_2.LinePlanAttributeText 
	FROM dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_3 RIGHT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_1 RIGHT OUTER JOIN
	  dbo.pLinePlanRange ON pLinePlanAttributeItem_1.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID1 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_2 ON dbo.pLinePlanRange.LinePlanAttributeItemID2 = pLinePlanAttributeItem_2.LinePlanAttributeItemID ON 
	  pLinePlanAttributeItem_3.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID3 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_4 ON dbo.pLinePlanRange.LinePlanAttributeItemID4 = pLinePlanAttributeItem_4.LinePlanAttributeItemID
	WHERE pLinePlanAttributeItem_1.LinePlanID = @LinePlanId
	AND pLinePlanRange.LinePlanFinancialID = '10000000-0000-0000-0000-000000000001' 
	AND pLinePlanRange.LinePlanRangeID NOT IN (
		SELECT LinePlanRangeID FROM pLinePlanStyleAttributeItem WHERE LinePlanStyleAttributeID = @LinePlanStyleAttributeID
	) 
	AND pLinePlanAttributeItem_1.LinePlanAttributeItemID  = @LinePlanAttributeItemId1
	GROUP BY pLinePlanAttributeItem_2.LinePlanAttributeItemID  , pLinePlanAttributeItem_2.LinePlanAttributeText 
	)
	ORDER BY LinePlanAttributeText

END 
ELSE IF @LinePlanIndex = '3'
BEGIN

	SELECT '00000000-0000-0000-0000-000000000003' AS LinePlanAttributeItemID, '' AS LinePlanAttributeText
	UNION 
	(SELECT  pLinePlanAttributeItem_3.LinePlanAttributeItemID ,
		pLinePlanAttributeItem_3.LinePlanAttributeText 
	FROM dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_3 RIGHT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_1 RIGHT OUTER JOIN
	  dbo.pLinePlanRange ON pLinePlanAttributeItem_1.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID1 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_2 ON dbo.pLinePlanRange.LinePlanAttributeItemID2 = pLinePlanAttributeItem_2.LinePlanAttributeItemID ON 
	  pLinePlanAttributeItem_3.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID3 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_4 ON dbo.pLinePlanRange.LinePlanAttributeItemID4 = pLinePlanAttributeItem_4.LinePlanAttributeItemID
	WHERE pLinePlanAttributeItem_1.LinePlanID = @LinePlanId
	AND pLinePlanRange.LinePlanFinancialID = '10000000-0000-0000-0000-000000000001' 
	AND pLinePlanRange.LinePlanRangeID NOT IN (
		SELECT LinePlanRangeID FROM pLinePlanStyleAttributeItem WHERE LinePlanStyleAttributeID = @LinePlanStyleAttributeID
	) 
	AND pLinePlanAttributeItem_1.LinePlanAttributeItemID  = @LinePlanAttributeItemId1
	AND pLinePlanAttributeItem_2.LinePlanAttributeItemID  = @LinePlanAttributeItemId2
	GROUP BY pLinePlanAttributeItem_3.LinePlanAttributeItemID  , pLinePlanAttributeItem_3.LinePlanAttributeText 
	)
	ORDER BY LinePlanAttributeText

END 
ELSE IF @LinePlanIndex = '4'
BEGIN

	SELECT '00000000-0000-0000-0000-000000000004' AS LinePlanAttributeItemID, '' AS LinePlanAttributeText
	UNION 
	(SELECT  pLinePlanAttributeItem_4.LinePlanAttributeItemID ,
		pLinePlanAttributeItem_4.LinePlanAttributeText 
	FROM dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_3 RIGHT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_1 RIGHT OUTER JOIN
	  dbo.pLinePlanRange ON pLinePlanAttributeItem_1.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID1 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_2 ON dbo.pLinePlanRange.LinePlanAttributeItemID2 = pLinePlanAttributeItem_2.LinePlanAttributeItemID ON 
	  pLinePlanAttributeItem_3.LinePlanAttributeItemID = dbo.pLinePlanRange.LinePlanAttributeItemID3 LEFT OUTER JOIN
	  dbo.pLinePlanAttributeItem AS pLinePlanAttributeItem_4 ON dbo.pLinePlanRange.LinePlanAttributeItemID4 = pLinePlanAttributeItem_4.LinePlanAttributeItemID
	WHERE pLinePlanAttributeItem_1.LinePlanID = @LinePlanId
	AND pLinePlanRange.LinePlanFinancialID = '10000000-0000-0000-0000-000000000001' 
	AND pLinePlanRange.LinePlanRangeID NOT IN (
		SELECT LinePlanRangeID FROM pLinePlanStyleAttributeItem WHERE LinePlanStyleAttributeID = @LinePlanStyleAttributeID
	) 
	AND pLinePlanAttributeItem_1.LinePlanAttributeItemID  = @LinePlanAttributeItemId1
	AND pLinePlanAttributeItem_2.LinePlanAttributeItemID  = @LinePlanAttributeItemId2
	AND pLinePlanAttributeItem_3.LinePlanAttributeItemID  = @LinePlanAttributeItemId3
	GROUP BY pLinePlanAttributeItem_4.LinePlanAttributeItemID  , pLinePlanAttributeItem_4.LinePlanAttributeText 
	)
	ORDER BY LinePlanAttributeText

END 





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rReportSrmFolder]'
GO
CREATE TABLE [dbo].[rReportSrmFolder]
(
[ReportSrmFolderID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_ReportSrmFolder_ReportSrmFolderID] DEFAULT (newid()),
[ReportSrmFolderName] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ReportSrmFolderSort] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ReportSrmFolderActive] [int] NULL CONSTRAINT [DF_rReportSrmFolder_ReportSrmFolderActive] DEFAULT ((1))
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_ReportSrmFolder] on [dbo].[rReportSrmFolder]'
GO
ALTER TABLE [dbo].[rReportSrmFolder] ADD CONSTRAINT [PK_ReportSrmFolder] PRIMARY KEY CLUSTERED  ([ReportSrmFolderID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rReportSrmFolderItem]'
GO
CREATE TABLE [dbo].[rReportSrmFolderItem]
(
[ReportSrmFolderItemID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_ReportSrmFolderItem_ReportSrmFolderItemID] DEFAULT (newid()),
[ReportSrmFolderID] [uniqueidentifier] NULL,
[ReportSrmFolderItemName] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ReportSrmFolderItemUrl] [varchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ReportSrmFolderItemIcon] [varchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ReportSrmFolderItemSort] [varchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ReportSrmFolderItemActive] [int] NULL CONSTRAINT [DF_rReportSrmFolderItem_ReportSrmFolderItemActive] DEFAULT ((1))
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_ReportSrmFolderItem] on [dbo].[rReportSrmFolderItem]'
GO
ALTER TABLE [dbo].[rReportSrmFolderItem] ADD CONSTRAINT [PK_ReportSrmFolderItem] PRIMARY KEY CLUSTERED  ([ReportSrmFolderItemID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[xCustom2]'
GO
ALTER TABLE [dbo].[xCustom2] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_xCustom2_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_xCustom2] on [dbo].[xCustom2]'
GO
ALTER TABLE [dbo].[xCustom2] ADD CONSTRAINT [PK_xCustom2] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[xCustom3]'
GO
ALTER TABLE [dbo].[xCustom3] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_xCustom3_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_xCustom3] on [dbo].[xCustom3]'
GO
ALTER TABLE [dbo].[xCustom3] ADD CONSTRAINT [PK_xCustom3] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rReportMaterialRequestSubmitFolder]'
GO
CREATE TABLE [dbo].[rReportMaterialRequestSubmitFolder]
(
[ReportMaterialRequestSubmitFolderID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_rReportMaterialRequestSubmitFolder_ReportMaterialRequestSubmitFolderID] DEFAULT (newid()),
[ReportMaterialRequestSubmitName] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ReportMaterialRequestSubmitFormName] [varchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ReportMaterialRequestSubmitGroup] [varchar] (1) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
[ReportMaterialRequestSubmitFinal] [int] NOT NULL,
[CDate] [datetime] NULL,
[CUser] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[MDate] [datetime] NULL,
[MUser] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ReportMaterialRequestSubmitSort] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Active] [int] NULL,
[srmOn] [int] NULL CONSTRAINT [DF_rReportMaterialRequestSubmitFolder_srmOn] DEFAULT ((0))
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_rReportMaterialRequestSubmitFolder] on [dbo].[rReportMaterialRequestSubmitFolder]'
GO
ALTER TABLE [dbo].[rReportMaterialRequestSubmitFolder] ADD CONSTRAINT [PK_rReportMaterialRequestSubmitFolder] PRIMARY KEY CLUSTERED  ([ReportMaterialRequestSubmitFolderID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[sSystemCulture]'
GO
CREATE TABLE [dbo].[sSystemCulture]
(
[CultureIndentifierID] [varchar] (6) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
[CultureName] [varchar] (6) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CultureCountry] [varchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[CultureLanguage] [varchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Active] [int] NOT NULL CONSTRAINT [DF_sSystemCulture_Active] DEFAULT ((1)),
[Unicode] [int] NULL CONSTRAINT [DF_sSystemCulture_Unicode] DEFAULT ((0))
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_sSystemCulture] on [dbo].[sSystemCulture]'
GO
ALTER TABLE [dbo].[sSystemCulture] ADD CONSTRAINT [PK_sSystemCulture] PRIMARY KEY CLUSTERED  ([CultureIndentifierID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[pLinePlanTemplate]'
GO
UPDATE [dbo].[pLinePlanTemplate] SET [Active]=((1)) WHERE [Active] IS NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanTemplate] ALTER COLUMN [Active] [int] NOT NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[iCustom91]'
GO
ALTER TABLE [dbo].[iCustom91] ADD
[CustomID] [uniqueidentifier] NOT NULL CONSTRAINT [DF_iCustom91_CustomID] DEFAULT (newid())
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_iCustom91] on [dbo].[iCustom91]'
GO
ALTER TABLE [dbo].[iCustom91] ADD CONSTRAINT [PK_iCustom91] PRIMARY KEY CLUSTERED  ([CustomID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rDashFolder]'
GO
CREATE TABLE [dbo].[rDashFolder]
(
[DashFolderID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_DashFolder_DashFolderID] DEFAULT (newid()),
[DashFolderName] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[DashFolderSort] [nvarchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[DashFolderActive] [int] NULL CONSTRAINT [DF_rDashFolder_DashFolderActive] DEFAULT ((1))
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_DashFolder] on [dbo].[rDashFolder]'
GO
ALTER TABLE [dbo].[rDashFolder] ADD CONSTRAINT [PK_DashFolder] PRIMARY KEY CLUSTERED  ([DashFolderID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rDashFolderItem]'
GO
CREATE TABLE [dbo].[rDashFolderItem]
(
[DashFolderItemID] [uniqueidentifier] NOT NULL ROWGUIDCOL CONSTRAINT [DF_DashFolderItem_DashFolderItemID] DEFAULT (newid()),
[DashFolderID] [uniqueidentifier] NULL,
[DashFolderItemName] [nvarchar] (100) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[DashFolderItemUrl] [varchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[DashFolderItemIcon] [varchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[DashFolderItemSort] [varchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[DashFolderItemActive] [int] NULL CONSTRAINT [DF_rDashFolderItem_DashFolderItemActive] DEFAULT ((1))
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_DashFolderItem] on [dbo].[rDashFolderItem]'
GO
ALTER TABLE [dbo].[rDashFolderItem] ADD CONSTRAINT [PK_DashFolderItem] PRIMARY KEY CLUSTERED  ([DashFolderItemID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_DesktopFolderAccess_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_Group_DesktopFolderAccess_SELECT] ( 
@DeskGroupAccessId uniqueidentifier
)

AS SELECT a.DeskFolderName,  a.DeskFolderId, 
                    b.DeskGroupAccessId , b.DeskAccessId,  b.GroupID
FROM         dbo.cDesktopFolder a WITH (NOLOCK) INNER JOIN  dbo.cDeskGroupFolderAccess  b WITH (NOLOCK) ON a.DeskFolderId = b.DeskFolderId
WHERE  b.DeskGroupAccessId = @DeskGroupAccessId



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanItemStyleColor_INSERT]'
GO




ALTER PROCEDURE [dbo].[spx_LinePlanItemStyleColor_INSERT](
@ColorPaletteID UNIQUEIDENTIFIER , 
@StyleID UNIQUEIDENTIFIER,
@StyleColorDel1 INT,
@StyleColorDel2 INT,
@StyleColorDel3 INT,
@StyleColorDel4 INT,
@CUser VARCHAR(200), 
@CDate DATETIME,
@Units INT,
@SeasonYearID UNIQUEIDENTIFIER, 
@StyleSeasonYearID UNIQUEIDENTIFIER,
@ColorType NVARCHAR (5) 
)
AS

DECLARE @StyleColorStatus INT 

SELECT * FROM pStyleColorwayStatus

SET @StyleColorDel4 = 0
IF @StyleColorDel1 =  1 
	SELECT @StyleColorDel2 = 1, @StyleColorDel3 = 1
ELSE IF @StyleColorDel2 = 1
	SET @StyleColorDel3 = 1

IF @StyleColorDel1 = 0  AND @StyleColorDel2 = 0  AND @StyleColorDel3 = 0
	SET @StyleColorDel4 = 1
 

IF @StyleColorDel1 = 1 OR @StyleColorDel2 = 1 OR @StyleColorDel3 = 1 OR @StyleColorDel4 = 1
	SET @StyleColorStatus = 100
ELSE 
	SET @StyleColorStatus = 900


DECLARE @StyleColorwayID  UNIQUEIDENTIFIER 
SET @StyleColorwayID  = NEWID()



INSERT INTO pStyleColorway (StyleColorID, StyleID, StyleSet, StyleColorStandardID, 
	StyleColorNo, StyleColorName, MainColor, Sort, Version, CUser, CDate, MUser, MDate, 
	CopyStyleColorID, ColorPaletteID )
SELECT @StyleColorwayID , @StyleID, 1, NULL, pColorPalette.ColorCode, pColorPalette.ColorName, 
	pColorPalette.ColorName, pColorPalette.Sort, '1', @CUser, @CDate, @CUser, @CDate, 
	NULL, pColorPalette.ColorPaletteID
FROM pColorPalette WITH (NOLOCK)
WHERE pColorPalette.ColorPaletteID = @ColorPaletteID


INSERT INTO pStyleColorwaySeasonYear (StyleColorwaySeasonYearID, StyleSeasonYearID , StyleColorwayID , StyleID,
StyleColorDelivery1,StyleColorDelivery2, StyleColorDelivery3,StyleColorDelivery4, StyleColorStatus, Units , ColorType , SampleStatus ) 
VALUES( NEWID() , @StyleSeasonYearID , @StyleColorwayID , @StyleID,
@StyleColorDel1, @StyleColorDel2, @StyleColorDel3, @StyleColorDel4 ,@StyleColorStatus, @Units , @ColorType, @StyleColorStatus) 


















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Image_COPY]'
GO
/*
Comments:

#01 - Artemio Gomez- October 16, 2009
	Store the Current ServerStorageID 

*/


ALTER  PROCEDURE [dbo].[spx_Image_COPY]
(@NewImageHistoryID varchar(50),
@NewImageID varchar(50),
@ImageID varchar(50),
@ImageVersion varchar(5),
@CreatedBy nvarchar(200),
@CreatedDate datetime)

AS 

DECLARE @SystemServerStorageID UNIQUEIDENTIFIER 

SELECT TOP 1 @SystemServerStorageID  = SystemServerStorageID  from sSystemServerStorageSetting WHERE CurrentServerStorage = 1 --Comment #01
IF @SystemServerStorageID IS NULL
	SET @SystemServerStorageID = '00000000-0000-0000-0000-000000000000'


BEGIN

	INSERT INTO dbo.hImage (ImageHistoryID, ImageID, WorkflowID, ImageTypeID, ImageFileType, ImageCode, ImageDescription, ImageKeywords, ImageLocation, 
	ImageDateLastAccessed, ImageDateLastModified, ImageFile, ImageSize, ImageType, ImageMainFolder, ImageSubFolder, ImageUserFolder, 
	ImageSubFolder1, ImageSubFolder2, ImageSubFolder3, ImageSubFolder4, ImageSubFolder5, ImageSubFolder6, ImageSubFolder7, ImageSubFolder8, 
	ImageSubFolder9, ImageSubFolder10, ImageSubFolder11, ImageSubFolder12, ImageSubFolder13, ImageSubFolder14, ImageSubFolder15, 
	ImageSubFolder16, ImageSubFolder17, ImageSubFolder18, ImageSubFolder19, CUser, CDate, MUser, MDate, Version, Classic, LockID, LockUser, 
	LockUserName, ImageNo, ImageSubFolder20, ImageSubFolder21, ImageSubFolder22, ImageSubFolder23, ImageSubFolder24, ImageSubFolder25, SystemServerStorageID)
	SELECT     @NewImageHistoryID AS ImageHistoryID, @NewImageID AS ImageID, WorkflowID, ImageTypeID, ImageFileType, ImageCode, ImageDescription, 
	ImageKeywords, ImageLocation, ImageDateLastAccessed, ImageDateLastModified, ImageFile, ImageSize, ImageType, ImageMainFolder, 
	ImageSubFolder, ImageUserFolder, ImageSubFolder1, ImageSubFolder2, ImageSubFolder3, ImageSubFolder4, ImageSubFolder5, ImageSubFolder6, 
	ImageSubFolder7, ImageSubFolder8, ImageSubFolder9, ImageSubFolder10, ImageSubFolder11, ImageSubFolder12, ImageSubFolder13, 
	ImageSubFolder14, ImageSubFolder15, ImageSubFolder16, ImageSubFolder17, ImageSubFolder18, ImageSubFolder19, @CreatedBy AS CUser, 
	@CreatedDate AS CDate, @CreatedBy AS MUser, @CreatedDate AS MDate, 1 AS Version, Classic, 0 AS LockID, 0 AS LockUser, 
	'UNKNOWN' AS LockUserName, ImageNo, ImageSubFolder20, ImageSubFolder21, ImageSubFolder22, ImageSubFolder23, ImageSubFolder24, 
	ImageSubFolder25 , @SystemServerStorageID
	FROM dbo.hImage WITH (NOLOCK)
	WHERE (ImageID = @ImageID) AND (Version = @ImageVersion)
	
END

BEGIN

--SET IDENTITY_INSERT pImage ON

	INSERT INTO dbo.pImage
	      (ImageID, WorkflowID, ImageTypeID, ImageFileType, ImageCode, ImageDescription, ImageKeywords, ImageLocation, ImageDateLastAccessed, 
	      ImageDateLastModified, ImageFile, ImageSize, ImageType, ImageMainFolder, ImageSubFolder, ImageUserFolder, ImageSubFolder1, 
	      ImageSubFolder2, ImageSubFolder3, ImageSubFolder4, ImageSubFolder5, ImageSubFolder6, ImageSubFolder7, ImageSubFolder8, ImageSubFolder9, 
	      ImageSubFolder10, ImageSubFolder11, ImageSubFolder12, ImageSubFolder13, ImageSubFolder14, ImageSubFolder15, ImageSubFolder16, 
	      ImageSubFolder17, ImageSubFolder18, ImageSubFolder19, CUser, CDate, MUser, MDate, Version, ImageNo, TempID, TempNo, ImageSubFolder20, 
	      ImageSubFolder21, ImageSubFolder22, ImageSubFolder23, ImageSubFolder24, ImageSubFolder25, ImageCopyID, ImageCopyVersion, 
	      ImageCopyUser, ImageCopyDate, SystemServerStorageID)
	SELECT @NewImageID AS ImageID, WorkflowID, ImageTypeID, ImageFileType, ImageCode, ImageDescription, ImageKeywords, ImageLocation, 
	      ImageDateLastAccessed, ImageDateLastModified, ImageFile, ImageSize, ImageType, ImageMainFolder, ImageSubFolder, ImageUserFolder, 
	      ImageSubFolder1, ImageSubFolder2, ImageSubFolder3, ImageSubFolder4, ImageSubFolder5, ImageSubFolder6, ImageSubFolder7, ImageSubFolder8, 
	      ImageSubFolder9, ImageSubFolder10, ImageSubFolder11, ImageSubFolder12, ImageSubFolder13, ImageSubFolder14, ImageSubFolder15, 
	      ImageSubFolder16, ImageSubFolder17, ImageSubFolder18, ImageSubFolder19, @CreatedBy AS CUser, @CreatedDate AS CDate, 
	      @CreatedBy AS MUser, @CreatedDate AS MDate, 1 AS Version, ImageNo, TempID, TempNo, ImageSubFolder20, ImageSubFolder21, 
	      ImageSubFolder22, ImageSubFolder23, ImageSubFolder24, ImageSubFolder25, @ImageID AS ImageCopyID, @ImageVersion AS ImageCopyVersion, 
	      @CreatedBY AS ImageCopyUser, @CreatedDate AS ImageCopyDate , @SystemServerStorageID
	FROM   pImage WITH (NOLOCK)
	WHERE (ImageID = @ImageID)
	
--SET IDENTITY_INSERT pImage OFF	
	
END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Style_ImageSummary_SELECT]'
GO


/*
Comments:

#01 - Ryan Cabanas - September 23, 2009
	Replace the old image string with the new image string using function.
Deleted old code.
*/



ALTER   PROCEDURE [dbo].[rpx_Style_ImageSummary_SELECT] 
	@StyleID AS varchar(255), 
	@StyleSet As int
AS


CREATE TABLE #tempImageDesign
(
	ImageRow int identity(0,1),
	ImageName nvarchar(255),
	ImagePath nvarchar(255),
	ImageType varchar(50)
)
 
CREATE TABLE #tempImageDetail
(
	ImageRow int identity(0,1),
	ImageName nvarchar(255),
	ImagePath nvarchar(255),
	ImageType varchar(50)
)

CREATE TABLE #tempImageDevelopment
(
	ImageRow int identity(0,1),
	ImageName nvarchar(255),
	ImagePath nvarchar(255),
	ImageType varchar(50)
)
 
CREATE TABLE #tempImageMaterial
(
	ImageRow int identity(0,1),
	ImageName nvarchar(255),
	ImagePath nvarchar(255),
	ImageType varchar(50)
)
 
CREATE TABLE #tempImageArtwork
(
	ImageRow int identity(0,1),
	ImageName nvarchar(255),
	ImagePath nvarchar(255),
	ImageType varchar(50)
)
 
CREATE TABLE #tempImageLicense
(
	ImageRow int identity(0,1),
	ImageName nvarchar(255),
	ImagePath nvarchar(255),
	ImageType varchar(50)
)

CREATE TABLE #tempImage
(
	ImageRow int,
	ImageType varchar(50),
	ImageName0 nvarchar(255),
	ImagePath0 nvarchar(255),
	ImageName1 nvarchar(255),
	ImagePath1 nvarchar(255),
	ImageName2 nvarchar(255),
	ImagePath2 nvarchar(255),
	ImageName3 nvarchar(255),
	ImagePath3 nvarchar(255)
)

DECLARE @I as int
DECLARE @Row_Count int
DECLARE @ImageRow int
DECLARE @ImageMod int
DECLARE @ImageName varchar(255)
DECLARE @ImagePath varchar(255)
DECLARE @ImageTypeCode varchar(200)
DECLARE @ImageTypeName varchar(200)


-- BEGIN Design Sketch
BEGIN
	SET @ImageTypeCode = 'Design'
	SET @ImageTypeName = 'Design Sketch'
	INSERT INTO #tempImageDesign (ImageName, ImagePath, ImageType)
	SELECT @ImageTypeName AS ImageName, 
		(dbo.fnx_GetStreamingImagePath(hi.ImageID, hi.[Version])) AS ImagePath,	--Comment #01
		@ImageTypeCode AS ImageType 	
	FROM pStyleHeader AS sm INNER JOIN
	  hImage AS hi ON sm.DesignSketchID = hi.ImageID AND sm.DesignSketchVersion = hi.Version
	WHERE (sm.StyleID = @StyleID)

	INSERT INTO #tempImage (ImageRow, ImageName0, ImagePath0, ImageType)
	SELECT 0 AS ImageRow, ImageName, ImagePath, @ImageTypeCode AS ImageType FROM #tempImageDesign
END
-- END Design Sketch

-- BEGIN Detail Sketch
BEGIN
	SET @ImageTypeCode = 'Detail'
	SET @ImageTypeName = 'Detail Sketch'
	INSERT INTO #tempImageDetail (ImageName, ImagePath, ImageType)
	SELECT @ImageTypeName AS ImageName, 
		(dbo.fnx_GetStreamingImagePath(hi.ImageID, hi.[Version])) AS ImagePath,	--Comment #01
		@ImageTypeCode AS ImageType 	
	FROM   pStyleImageItem AS sm INNER JOIN
	  hImage AS hi ON sm.ImageID = hi.ImageID AND sm.ImageVersion = hi.Version
	WHERE ((sm.StyleSet =  @StyleSet) AND (sm.StyleID = @StyleID) AND (sm.ImageVersion <> 0))
	ORDER BY sm.Sort

	BEGIN
		SET @I = 0
		SET @Row_Count = (SELECT COUNT(*) FROM #tempImageDetail)

		WHILE @I < @Row_Count 
		
			BEGIN
				SET @ImageName = ''
				SET @ImagePath = ''
				
				SELECT @ImageRow = ImageRow % 4, @ImageName = ImageName, @ImagePath = ImagePath FROM #tempImageDetail WHERE ImageRow = @I
				
				IF @ImageRow = 0
					BEGIN
						SET @ImageMod = @I
						INSERT INTO #tempImage (ImageRow, ImageName0, ImagePath0, ImageType)
						SELECT @I, ImageName, ImagePath, @ImageTypeCode AS ImageType FROM #tempImageDetail WHERE ImageRow = @I
					END
				ELSE IF @ImageRow = 1
					BEGIN
						UPDATE #tempImage SET ImageName1 = @ImageName, ImagePath1 = @ImagePath WHERE ImageRow = @ImageMod AND ImageType = @ImageTypeCode
					END
				ELSE IF @ImageRow = 2
					BEGIN
						UPDATE #tempImage SET ImageName2 = @ImageName, ImagePath2 = @ImagePath WHERE ImageRow = @ImageMod AND ImageType = @ImageTypeCode
					END
				ELSE IF @ImageRow = 3
					BEGIN
						UPDATE #tempImage SET ImageName3 = @ImageName, ImagePath3 = @ImagePath WHERE ImageRow = @ImageMod AND ImageType = @ImageTypeCode
					END
				SET @I = @I + 1
			END
		
	END
END

-- END Detail Sketch

-- BEGIN Development Sketch
BEGIN
	SET @ImageTypeCode = 'Development'
	SET @ImageTypeName = 'Development Spec Image'
	INSERT INTO #tempImageDevelopment (ImageName, ImagePath, ImageType)
	SELECT @ImageTypeName AS ImageName, 
		(dbo.fnx_GetStreamingImagePath(hi.ImageID, hi.[Version])) AS ImagePath,	--Comment #01
		@ImageTypeCode AS ImageType 	
	FROM pStyleImage AS sm INNER JOIN
	  hImage AS hi ON sm.SpecSketchID1 = hi.ImageID AND sm.SpecSketchVersion1 = hi.Version
	WHERE (sm.StyleID = @StyleID)

	INSERT INTO #tempImage (ImageRow, ImageName0, ImagePath0, ImageType)
	SELECT 0 AS ImageRow, ImageName, ImagePath, @ImageTypeCode AS ImageType FROM #tempImageDevelopment
END

-- BEGIN Material Sketch
BEGIN
	SET @ImageTypeCode = 'Material'
	SET @ImageTypeName = 'Material Sketch'
	INSERT INTO #tempImageMaterial (ImageName, ImagePath, ImageType)
	SELECT ('(' + sm.MaterialNo + ') ' + sm.MaterialName) AS ImageName, 
		(dbo.fnx_GetStreamingImagePath(hi.ImageID, hi.[Version])) AS ImagePath,	--Comment #01
		@ImageTypeCode AS ImageType 	
	FROM pStyleMaterials AS sm INNER JOIN
	hImage AS hi ON sm.MaterialImageID = hi.ImageID AND sm.MaterialImageVersion = hi.Version
	WHERE ((sm.StyleSet =  @StyleSet) 
		AND (sm.StyleID = @StyleID))
	ORDER BY sm.MainMaterial DESC, sm.MaterialType, sm.MaterialSort, sm.MaterialNo

	BEGIN
		SET @I = 0
		SET @Row_Count = (SELECT COUNT(*) FROM #tempImageMaterial)

		WHILE @I < @Row_Count 
		
			BEGIN
				SET @ImageName = ''
				SET @ImagePath = ''
				
				SELECT @ImageRow = ImageRow % 4, @ImageName = ImageName, @ImagePath = ImagePath FROM #tempImageMaterial WHERE ImageRow = @I
				
				IF @ImageRow = 0
					BEGIN
						SET @ImageMod = @I
						INSERT INTO #tempImage (ImageRow, ImageName0, ImagePath0, ImageType)
						SELECT @I, ImageName, ImagePath, @ImageTypeCode AS ImageType FROM #tempImageMaterial WHERE ImageRow = @I
					END
				ELSE IF @ImageRow = 1
					BEGIN
						UPDATE #tempImage SET ImageName1 = @ImageName, ImagePath1 = @ImagePath WHERE ImageRow = @ImageMod AND ImageType = @ImageTypeCode
					END
				ELSE IF @ImageRow = 2
					BEGIN
						UPDATE #tempImage SET ImageName2 = @ImageName, ImagePath2 = @ImagePath WHERE ImageRow = @ImageMod AND ImageType = @ImageTypeCode
					END
				ELSE IF @ImageRow = 3
					BEGIN
						UPDATE #tempImage SET ImageName3 = @ImageName, ImagePath3 = @ImagePath WHERE ImageRow = @ImageMod AND ImageType = @ImageTypeCode
					END
				SET @I = @I + 1
			END
		
	END
END

-- END Detail Sketch	

-- BEGIN License Images
BEGIN
	SET @ImageTypeCode = 'License'
	SET @ImageTypeName = 'License Images'

	INSERT INTO #tempImageLicense (ImageName, ImagePath, ImageType)
	SELECT ('(' + sm.MaterialNo + ') ' + sm.MaterialName) AS ImageName, 
		(dbo.fnx_GetStreamingImagePath(hi.ImageID, hi.[Version])) AS ImagePath,	--Comment #01
		@ImageTypeCode AS ImageType 	
	FROM pStyleMaterials AS sm INNER JOIN
	hImage AS hi ON sm.MaterialImageID = hi.ImageID AND sm.MaterialImageVersion = hi.Version
	WHERE ((sm.StyleSet =  @StyleSet) 
		AND (sm.StyleID = @StyleID))
		AND (sm.License = 1)
	ORDER BY sm.MainMaterial DESC, sm.MaterialType, sm.MaterialSort, sm.MaterialNo

	BEGIN
		SET @I = 0
		SET @Row_Count = (SELECT COUNT(*) FROM #tempImageLicense)

		WHILE @I < @Row_Count 
		
			BEGIN
				SET @ImageName = ''
				SET @ImagePath = ''
				
				SELECT @ImageRow = ImageRow % 4, @ImageName = ImageName, @ImagePath = ImagePath FROM #tempImageLicense WHERE ImageRow = @I
				
				IF @ImageRow = 0
					BEGIN
						SET @ImageMod = @I
						INSERT INTO #tempImage (ImageRow, ImageName0, ImagePath0, ImageType)
						SELECT @I, ImageName, ImagePath, @ImageTypeCode AS ImageType FROM #tempImageLicense WHERE ImageRow = @I
					END
				ELSE IF @ImageRow = 1
					BEGIN
						UPDATE #tempImage SET ImageName1 = @ImageName, ImagePath1 = @ImagePath WHERE ImageRow = @ImageMod AND ImageType = @ImageTypeCode
					END
				ELSE IF @ImageRow = 2
					BEGIN
						UPDATE #tempImage SET ImageName2 = @ImageName, ImagePath2 = @ImagePath WHERE ImageRow = @ImageMod AND ImageType = @ImageTypeCode
					END
				ELSE IF @ImageRow = 3
					BEGIN
						UPDATE #tempImage SET ImageName3 = @ImageName, ImagePath3 = @ImagePath WHERE ImageRow = @ImageMod AND ImageType = @ImageTypeCode
					END
				SET @I = @I + 1
			END
		
	END
END


-- BEGIN Artwork Sketch
BEGIN

	SET @ImageTypeCode = 'Artwork'
	SET @ImageTypeName = 'Artwork Images'

	INSERT INTO #tempImageArtwork (ImageName, ImagePath, ImageType)
	SELECT ('(' + sm.MaterialNo + ') ' + sm.MaterialName) AS ImageName, 
		(dbo.fnx_GetStreamingImagePath(hi.ImageID, hi.[Version])) AS ImagePath,	--Comment #01
		@ImageTypeCode AS ImageType 	
	FROM pStyleMaterials AS sm INNER JOIN
	hImage AS hi ON sm.MaterialImageID = hi.ImageID AND sm.MaterialImageVersion = hi.Version
	WHERE ((sm.StyleSet =  @StyleSet) 
		AND (sm.StyleID = @StyleID))
		AND (sm.Artwork = 1)
	ORDER BY sm.MainMaterial DESC, sm.MaterialType, sm.MaterialSort, sm.MaterialNo

	BEGIN
		SET @I = 0
		SET @Row_Count = (SELECT COUNT(*) FROM #tempImageArtwork)

		WHILE @I < @Row_Count 
		
			BEGIN
				SET @ImageName = ''
				SET @ImagePath = ''
				
				SELECT @ImageRow = ImageRow % 4, @ImageName = ImageName, @ImagePath = ImagePath FROM #tempImageArtwork WHERE ImageRow = @I
				
				IF @ImageRow = 0
					BEGIN
						SET @ImageMod = @I
						INSERT INTO #tempImage (ImageRow, ImageName0, ImagePath0, ImageType)
						SELECT @I, ImageName, ImagePath, @ImageTypeCode AS ImageType FROM #tempImageArtwork WHERE ImageRow = @I
					END
				ELSE IF @ImageRow = 1
					BEGIN
						UPDATE #tempImage SET ImageName1 = @ImageName, ImagePath1 = @ImagePath WHERE ImageRow = @ImageMod AND ImageType = @ImageTypeCode
					END
				ELSE IF @ImageRow = 2
					BEGIN
						UPDATE #tempImage SET ImageName2 = @ImageName, ImagePath2 = @ImagePath WHERE ImageRow = @ImageMod AND ImageType = @ImageTypeCode
					END
				ELSE IF @ImageRow = 3
					BEGIN
						UPDATE #tempImage SET ImageName3 = @ImageName, ImagePath3 = @ImagePath WHERE ImageRow = @ImageMod AND ImageType = @ImageTypeCode
					END
				SET @I = @I + 1
			END
		
	END
END
	
BEGIN
	SELECT * FROM #tempImage
END

BEGIN
	DROP TABLE #tempImage
	DROP TABLE #tempImageDesign
	DROP TABLE #tempImageDetail
	DROP TABLE #tempImageDevelopment
	DROP TABLE #tempImageMaterial
	DROP TABLE #tempImageArtwork
	DROP TABLE #tempImageLicense	
END




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_MaterialColorSeasonYear_SEL]'
GO
ALTER VIEW dbo.vwx_MaterialColorSeasonYear_SEL
AS
SELECT     TOP (100) PERCENT a.MaterialColorID, a.MaterialID, a.MaterialColorImageID, a.MaterialColorImageVersion, a.ColorFolderID, a.ColorPaletteID, 
                      a.ColorID, a.ColorCode, a.ColorNo, a.ColorName, a.ColorSource, a.VendorColorNo, a.VendorColorName, a.MaterialColorNote, a.ColorHex, a.Hex, a.R, 
                      a.G, a.B, a.C, a.M, a.Y, a.K, a.H, a.S, a.L, a.LAB_L, a.LAB_A, a.LAB_B, a.ColorHexCode, a.CDate, a.CUser, a.MDate, a.MUser, a.MaterialColorVersion, 
                      a.ColorVersion, a.Action, a.Sort, a.VendorColorCode, a.CopyMaterialColorID, b.SeasonYearID, b.MaterialColorSeasonYearID, 
                      '<img src=''../System/Control/ColorStream.ashx?S=25&CFID=' + CAST(ISNULL(c.ColorFolderID, '00000000-0000-0000-0000-000000000000') 
                      AS NVARCHAR(50)) + '&CPID=' + CAST(ISNULL(c.ColorPaletteID, '00000000-0000-0000-0000-000000000000') AS NVARCHAR(50)) 
                      + '''  />' AS ColorImagePath
FROM         dbo.pMaterialColor AS a INNER JOIN
                      dbo.pMaterialColorSeasonYear AS b ON a.MaterialColorID = b.MaterialColorID AND a.MaterialID = b.MaterialID LEFT OUTER JOIN
                      dbo.pColorPalette AS c ON c.ColorPaletteID = a.ColorPaletteID
ORDER BY a.Sort, a.ColorCode, a.ColorName
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_SampleRequestQAItemPomLibrary_INSERT]'
GO

CREATE PROCEDURE [dbo].[spx_SampleRequestQAItemPomLibrary_INSERT]
(
@SampleRequestQAWorksheetID uniqueidentifier, 
@POMLibraryID uniqueidentifier,
@SampleRequestTradeID varchar(50),
@SampleRequestWorkflowID varchar(50),
@SampleWorkflowID varchar(50),
@TradePartnerVendorID varchar(50),
@StyleColorID nvarchar(50),
@StyleID nvarchar(50),
@StyleSet nvarchar(50),
@Submit varchar(2),
@CreatedDate datetime,
@CreatedBy nvarchar(200))

AS 

BEGIN

	INSERT INTO pSampleRequestQAWorksheet
	  (SampleRequestQAWorksheetID,POM, PointMeasur, TOL, TOLN, 
	  SampleRequestTradeID, SampleRequestWorkflowID, SampleWorkflowID, TradePartnerVendorID, 
	  StyleColorID, StyleID, StyleSet, Submit, 
	  POMLibraryID, CDate, CUser, MDate, MUser)
	SELECT  @SampleRequestQAWorksheetID, POM, PointMeasur, 0 AS TOL, 0 AS TOLN, 
	  @SampleRequestTradeID AS SampleRequestTradeID, 
	  @SampleRequestWorkflowID AS SampleRequestWorkflowID, @SampleWorkflowID AS SampleWorkflowID, 
	  @TradePartnerVendorID AS TradePartnerVendorID, @StyleColorID AS StyleColorID, 
	  @StyleID AS StyleID, @StyleSet AS StyleSet, @Submit AS Submit, 
	  POMLibraryID, @CreatedDate AS CDate, @CreatedBy AS CUser, @CreatedDate AS MDate, @CreatedBy AS MUser
	FROM   pPOMLibrary WITH (NOLOCK)
	WHERE     (POMLibraryID = @POMLibraryID)

END


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_MaterialRequestSubmitSchedule_SEL]'
GO
ALTER VIEW dbo.vwx_MaterialRequestSubmitSchedule_SEL
AS
SELECT     TOP (100) PERCENT dbo.pMaterialTradePartner.MaterialTradePartnerId, dbo.pMaterialTradePartner.SeasonYearID, 
                      dbo.pMaterialTradePartner.MaterialRequestWorkflowTempID, dbo.pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID, 
                      '<IMG src=''' + '../System/Icons/' + dbo.pMaterialRequestSubmitStatus.StatusIcon + '''>' AS StatusUrl, 
                      dbo.pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID, dbo.pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowTempItemID, 
                      dbo.pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID, dbo.pMaterialRequestSubmitWorkflow.MaterialID, 
                      dbo.pMaterialRequestSubmitWorkflow.MaterialColorID, dbo.pMaterialRequestSubmitWorkflow.TradePartnerID, 
                      dbo.pMaterialRequestSubmitWorkflow.TradePartnerVendorID, dbo.pMaterialRequestSubmitWorkflow.Submit, dbo.pMaterialRequestSubmitWorkflow.SubmitDays, 
                      dbo.pMaterialRequestSubmitWorkflow.ResubmitDays, ISNULL(dbo.pMaterialRequestSubmitWorkflow.AssignedTo, 0) AS AssignedTo, 
                      dbo.pMaterialRequestSubmitWorkflow.StartDate, dbo.pMaterialRequestSubmitWorkflow.DueDate, dbo.pMaterialRequestSubmitWorkflow.EndDate, 
                      dbo.pMaterialRequestSubmitWorkflow.CUser, dbo.pMaterialRequestSubmitWorkflow.CDate, dbo.pMaterialRequestSubmitWorkflow.MUser, 
                      dbo.pMaterialRequestSubmitWorkflow.MDate, dbo.pMaterialRequestSubmitWorkflow.TUser, dbo.pMaterialRequestSubmitWorkflow.TDate, 
                      dbo.pMaterialRequestSubmitWorkflow.FinalDate, dbo.pMaterialRequestWorkflow.MaterialRequestWorkflow, dbo.pMaterialRequestSubmitStatus.StatusID, 
                      dbo.pMaterialRequestSubmitStatus.Status, dbo.pMaterialRequestWorkflow.MaterialRequestWorkflowSort, dbo.pMaterialRequestSubmitWorkflow.Active, 
                      dbo.pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowGroupID, dbo.pMaterialRequestWorkflowTemplateItem.MaterialRequestWorkflowSort AS Sort, 
                      dbo.pMaterialRequestSubmitWorkflow.MaterialRequestSubmitAllColors
FROM         dbo.pMaterialRequestWorkflowTemplateItem INNER JOIN
                      dbo.pMaterialRequestWorkflowTemplate ON 
                      dbo.pMaterialRequestWorkflowTemplateItem.MaterialRequestWorkflowTempID = dbo.pMaterialRequestWorkflowTemplate.MaterialRequestWorkflowTempID RIGHT OUTER
                       JOIN
                      dbo.pMaterialTradePartner INNER JOIN
                      dbo.pMaterialRequestSubmitStatus INNER JOIN
                      dbo.pMaterialRequestSubmitWorkflow ON dbo.pMaterialRequestSubmitStatus.StatusID = dbo.pMaterialRequestSubmitWorkflow.Status INNER JOIN
                      dbo.pMaterialRequestWorkflow ON 
                      dbo.pMaterialRequestWorkflow.MaterialRequestWorkflowID = dbo.pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID ON 
                      dbo.pMaterialTradePartner.MaterialTradePartnerId = dbo.pMaterialRequestSubmitWorkflow.MaterialTradePartnerID ON 
                      dbo.pMaterialRequestWorkflowTemplateItem.MaterialRequestWorkflowTempItemID = dbo.pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowTempItemID





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleHeaderLink_INSERT]'
GO


ALTER   PROCEDURE [dbo].[spx_StyleHeaderLink_INSERT]
(
@StyleID uniqueidentifier,
@NewStyleID uniqueidentifier,
@SizeClass nvarchar(50),
@SizeRange nvarchar(50),
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

SET NOCOUNT ON

DECLARE @StyleMasterID uniqueidentifier
DECLARE @NewStyleMasterID uniqueidentifier

SET @NewStyleMasterID = newid()

BEGIN
		
	SELECT @StyleMasterID = StyleMasterID FROM pStyleHeader WHERE StyleID = @StyleID
		
		IF @StyleMasterID IS NULL
		BEGIN			
			UPDATE pStyleHeader SET StyleMasterID = @NewStyleMasterID WHERE StyleID = @StyleID
		END	
			
END

BEGIN
	INSERT INTO pStyleHeader
		(StyleWorkflowID, StyleID, StyleCategory, StyleMasterID, StyleType, WorkflowType, StyleNo, TempID, TempNo, CustomerNo, DevelopmentID, DevelopmentNo, SpecNo, 
		Description, SizeClass, SizeRange, StyleSet, DueDate, RecDate, Designer, StyleStatus, StyleLocation, WashType, Pitch, MaterialID, MaterialImageID, 
		MaterialImageVersion, MaterialNo, MaterialName, POMTempID1, POMTempVersion1, POMTempID2, POMTempVersion2, POMTempID3, 
		POMTempVersion3, POMTempID4, POMTempVersion4, POMTempSizeClass1, POMTempSizeClass2, POMTempSizeClass3, POMTempSizeClass4, 
		StyleMaterialID, DesignSketchID, TechSketchID, ConceptSketchID, ColorSketchID, DesignSketchVersion, TechSketchVersion, ConceptSketchVersion, 
		ColorSketchVersion, DetailSketchID1, DetailSketchID2, DetailSketchID3, DetailSketchID4, DetailSketchVersion1, DetailSketchVersion2, 
		DetailSketchVersion3, DetailSketchVersion4, SpecSketchID1, SpecSketchID2, SpecSketchID3, SpecSketchID4, SpecSketchVersion1, 
		SpecSketchVersion2, SpecSketchVersion3, SpecSketchVersion4, CustomField1, CustomField2, CustomField3, CustomField4, CustomField5, 
		CustomField6, CustomField7, CustomField8, CustomField9, CustomField10, CustomField11, CustomField12, CustomField13, CustomField14, 
		CustomField15, Pc1, Pc2, Pc3, Pc4, CUser, CDate, MUser, MDate, Active, Change, Action, Customer, Buyer, SampleMaker, PatternMaker, 
		ProductionManager, TechnicalDesigner, StyleDetail, StyleDetail1, StyleAttribute, StyleDetail2,
		CustomField16, CustomField17, CustomField18, CustomField19, CustomField20, CustomField21, CustomField22,  CustomField23, CustomField24,  CustomField25, 
		CustomField26, CustomField27, CustomField28,  CustomField29,  CustomField30 
		 )
	SELECT  StyleWorkflowID, @NewStyleID AS NewStyleId, StyleCategory, StyleMasterID, StyleType, WorkflowType, StyleNo, TempID, TempNo, CustomerNo, DevelopmentID, 
		DevelopmentNo, SpecNo, Description, @SizeClass, @SizeRange, StyleSet, DueDate, RecDate, Designer, StyleStatus, StyleLocation, WashType, 
		Pitch, MaterialID, MaterialImageID, MaterialImageVersion, MaterialNo, MaterialName, POMTempID1, POMTempVersion1, POMTempID2, 
		POMTempVersion2, POMTempID3, POMTempVersion3, POMTempID4, POMTempVersion4, POMTempSizeClass1, POMTempSizeClass2, 
		POMTempSizeClass3, POMTempSizeClass4, StyleMaterialID, DesignSketchID, TechSketchID, ConceptSketchID, ColorSketchID, DesignSketchVersion, 
		TechSketchVersion, ConceptSketchVersion, ColorSketchVersion, DetailSketchID1, DetailSketchID2, DetailSketchID3, DetailSketchID4, 
		DetailSketchVersion1, DetailSketchVersion2, DetailSketchVersion3, DetailSketchVersion4, SpecSketchID1, SpecSketchID2, SpecSketchID3, 
		SpecSketchID4, SpecSketchVersion1, SpecSketchVersion2, SpecSketchVersion3, SpecSketchVersion4, CustomField1, CustomField2, CustomField3, 
		CustomField4, CustomField5, CustomField6, CustomField7, CustomField8, CustomField9, CustomField10, CustomField11, CustomField12, 
		CustomField13, CustomField14, CustomField15, Pc1, Pc2, Pc3, Pc4, @CreatedBy AS CUser, @CreatedDate AS CDate, @CreatedBy AS MUser, 
		@CreatedDate AS MDate, 1, Change, Action, Customer, Buyer, SampleMaker, PatternMaker, ProductionManager, TechnicalDesigner, StyleDetail, 
		StyleDetail1, StyleAttribute, StyleDetail2,
		CustomField16, CustomField17, CustomField18, CustomField19, CustomField20, CustomField21, CustomField22,  CustomField23, CustomField24,  CustomField25, 
		CustomField26, CustomField27, CustomField28,  CustomField29,  CustomField30 
	FROM  pStyleHeader
	WHERE StyleID = @StyleID
END

BEGIN
	
	INSERT INTO pStyleAttribute
         (StyleAttributeTableId, StyleId, StyleAttributeText, StyleAttributeValue, CUser, CDate, MUser, MDate)
	SELECT StyleAttributeTableId, @NewStyleId, StyleAttributeText, StyleAttributeValue, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate
	FROM pStyleAttribute
	WHERE StyleID = @StyleID
	
END


BEGIN
		
	SELECT @StyleMasterID = StyleMasterID FROM pStyleImage WHERE StyleID = @StyleID
		
		IF @StyleMasterID IS NULL
		BEGIN
			UPDATE pStyleImage SET StyleMasterID = @NewStyleMasterID WHERE StyleID = @StyleID
		END	
			
END

BEGIN

	INSERT INTO pStyleImage
	(StyleID, StyleMasterID, StyleType, MaterialID, MaterialImageID, DesignSketchID, TechSketchID, SalesSketchID, ColorSketchID, MaterialImageVersion, 
	DesignSketchVersion, TechSketchVersion, SalesSketchVersion, ColorSketchVersion, SpecSketchID1, SpecSketchID2, SpecSketchID3, SpecSketchID4, 
	SpecSketchVersion1, SpecSketchVersion2, SpecSketchVersion3, SpecSketchVersion4, DetailSketchNo, DetailSketchData, DetailSketchID1, 
	DetailSketchID2, DetailSketchID3, DetailSketchID4, DetailSketchID11, DetailSketchID12, DetailSketchID21, DetailSketchID22, DetailSketchID31, 
	DetailSketchID32, DetailSketchID41, DetailSketchID42, DetailSketchVersion1, DetailSketchVersion2, DetailSketchVersion3, DetailSketchVersion4, 
	DetailSketchVersion11, DetailSketchVersion12, DetailSketchVersion21, DetailSketchVersion22, DetailSketchVersion31, DetailSketchVersion32, 
	DetailSketchVersion41, DetailSketchVersion42)
	SELECT @NewStyleID, StyleMasterID, StyleType, MaterialID, MaterialImageID, DesignSketchID, TechSketchID, SalesSketchID, ColorSketchID, MaterialImageVersion, 
	DesignSketchVersion, TechSketchVersion, SalesSketchVersion, ColorSketchVersion, SpecSketchID1, SpecSketchID2, SpecSketchID3, SpecSketchID4, 
	SpecSketchVersion1, SpecSketchVersion2, SpecSketchVersion3, SpecSketchVersion4, DetailSketchNo, DetailSketchData, DetailSketchID1, 
	DetailSketchID2, DetailSketchID3, DetailSketchID4, DetailSketchID11, DetailSketchID12, DetailSketchID21, DetailSketchID22, DetailSketchID31, 
	DetailSketchID32, DetailSketchID41, DetailSketchID42, DetailSketchVersion1, DetailSketchVersion2, DetailSketchVersion3, DetailSketchVersion4, 
	DetailSketchVersion11, DetailSketchVersion12, DetailSketchVersion21, DetailSketchVersion22, DetailSketchVersion31, DetailSketchVersion32, 
	DetailSketchVersion41, DetailSketchVersion42
	FROM dbo.pStyleImage
	WHERE StyleID = @StyleID
	
END

BEGIN
CREATE TABLE [dbo].[#tempStyleWorkflow] (
	[RecID] int IDENTITY(1,1)  NOT NULL,
	[StyleWorkflowID]  uniqueidentifier ROWGUIDCOL  NOT NULL ,
	[StyleWorkflowMasterID] [uniqueidentifier],
	[StyleID] [uniqueidentifier],
	[StyleSet] [int],
	[WorkflowID] [uniqueidentifier],
	[WorkflowType] [int],
	[WorkflowOrder] [int],
	[WorkDate] [datetime],
	[WorkStart] [datetime],
	[WorkDue] [datetime],
	[WorkAssignedTo] [int],
	[WorkComplete] [nvarchar] (50),
	[WorkStatus] [int],
	[WorkStatusDate] [datetime],
	[WorkStatusBy] [nvarchar] (50),
	[WorkVersion] [int],
	[WorkComments] [nvarchar] (4000),
	[WorkSort] [nvarchar] (2),
	[CUser] [nvarchar] (100),
	[CDate] [datetime],
	[MUser] [nvarchar] (100),
	[MDate] [datetime]
)
END

/*Get the ID for the "In Progress" status so that the newly added size class has all it's Style Workflow pages
set to "In Progress" as the default.*/
DECLARE @DefaultWorkStatus int

SELECT @DefaultWorkStatus = WorkflowStatusID
FROM pWorkflowStatus
WHERE WorkflowStatus = 'In Progress' AND Active = 1

BEGIN
	INSERT INTO dbo.#tempStyleWorkflow
	(StyleWorkflowID, StyleID, StyleSet, WorkflowID, WorkflowType, WorkflowOrder, WorkDate, WorkStart, WorkDue, WorkAssignedTo, WorkComplete, 
	WorkStatus, WorkStatusDate, WorkStatusBy, WorkVersion, WorkComments, WorkSort, CUser, CDate, MUser, MDate)
	SELECT StyleWorkflowID, @NewStyleID AS StyleID, StyleSet, WorkflowID, WorkflowType, WorkflowOrder, WorkDate, WorkStart, WorkDue, WorkAssignedTo, WorkComplete, 
	@DefaultWorkStatus AS WorkStatus, WorkStatusDate, WorkStatusBy, WorkVersion, WorkComments, WorkSort, @CreatedBy AS CUser, @CreatedDate AS CDate, @CreatedBy AS MUser, @CreatedDate AS MDate
	FROM  dbo.pStyleWorkflow
	WHERE StyleID = @StyleID
END

BEGIN

DECLARE @Row_Count int
DECLARE @Row_Loop int
DECLARE @NewStyleWorkflowMasterID uniqueidentifier
DECLARE @StyleWorkflowMasterID uniqueidentifier
DECLARE @StyleWorkflowID uniqueidentifier


	SET @Row_Loop = 1
	SET @Row_Count = (SELECT COUNT(*) FROM dbo.#tempStyleWorkflow)
	
	WHILE @Row_Loop <= @Row_Count 
	
		BEGIN
		
		SELECT @StyleWorkflowMasterID = StyleWorkflowMasterID, @StyleWorkflowID = StyleWorkflowID FROM #tempStyleWorkflow WHERE RecID = @Row_Loop
			
			IF @StyleWorkflowMasterID IS NULL
			BEGIN
				SET @NewStyleWorkflowMasterID = newid()
				UPDATE pStyleWorkflow SET StyleWorkflowMasterID = @NewStyleWorkflowMasterID WHERE StyleWorkflowID = @StyleWorkflowID
			END	
		
		SET @Row_Loop = @Row_Loop + 1
			
		END
END

BEGIN

	INSERT INTO dbo.pStyleWorkflow
	(WorkDay, StyleWorkflowID, StyleID, StyleSet, WorkflowID, WorkflowType, WorkflowOrder, WorkDate, WorkStart, WorkDue, WorkAssignedTo, WorkComplete, 
	WorkStatus, WorkStatusDate, WorkStatusBy, WorkVersion, WorkComments, WorkSort, CUser, CDate, MUser, MDate)
	SELECT  WorkDay, newid() AS StyleWorkflowID, @NewStyleID AS StyleID, StyleSet, WorkflowID, WorkflowType, WorkflowOrder, WorkDate, WorkStart, WorkDue, WorkAssignedTo, WorkComplete, 
	@DefaultWorkStatus AS WorkStatus, WorkStatusDate, WorkStatusBy, WorkVersion, WorkComments, WorkSort, @CreatedBy AS CUser, @CreatedDate AS CDate, @CreatedBy AS MUser, @CreatedDate AS MDate
	FROM  dbo.pStyleWorkflow
	WHERE StyleID = @StyleID
END

BEGIN

	INSERT INTO dbo.pStyleDevelopmentItem
	(StyleDevelopmentItemID, StyleDevelopmentID, StyleID, SizeRange, Variation, CUser, CDate, MUser, MDate, StyleDevelopmentName)
	SELECT newid() AS StyleDevelopmentItemID, StyleDevelopmentID, @NewStyleID, @SizeRange, Variation, @CreatedBy AS CUser, @CreatedDate AS CDate, @CreatedBy AS MUser, @CreatedDate AS MDate, StyleDevelopmentName
	FROM pStyleDevelopmentItem
	WHERE StyleID = @StyleID

END

BEGIN


INSERT INTO pStyleDetail
    (StyleID, Sort, StyleSet, FeatureDetail, Measurement, StitchType, Comments, CUser, CDate, MUser, MDate)
SELECT @NewStyleID AS StyleID, Sort, StyleSet, FeatureDetail, Measurement, StitchType, Comments, @CreatedBy AS CUser, @CreatedDate AS CDate, @CreatedBy AS MUser, @CreatedDate AS MDate
FROM  pStyleDetail
WHERE (StyleID = @StyleID)


END


BEGIN

IF (SELECT COUNT(*) FROM pStyleWorkflowSchedule WHERE StyleID = @NewStyleId) = 0
	BEGIN
		INSERT INTO pStyleWorkflowSchedule
		(StyleId, WorkflowTemplateID, StyleDueDate, CDate, CUser)
		SELECT StyleID, StyleWorkflowID AS WorkflowTemplateID, DueDate AS StyleDueDate, @CreatedDate AS CDate, CUser
		FROM pStyleHeader
		WHERE StyleID = @NewStyleID
	END

END



--SELECT * FROM dbo.pStyleHeader WHERE (StyleID = @StyleID)
--SELECT * FROM #tempCopyStyleHeader


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanMaterialItemNonApparelTemp_INSERT]'
GO


CREATE PROCEDURE [dbo].[spx_LinePlanMaterialItemNonApparelTemp_INSERT] (
	@LinePlanRangeID UNIQUEIDENTIFIER, 
	@LinePlanID UNIQUEIDENTIFIER, 
	@LinePlanColorGroupID UNIQUEIDENTIFIER,
	@MaterialID UNIQUEIDENTIFIER 
)
AS


BEGIN
	DELETE pLinePlanMaterialItemTemp WHERE LinePlanColorGroupID =  @LinePlanColorGroupID
END

BEGIN
	INSERT INTO pLinePlanMaterialItemTemp (LinePlanMaterialItemID, LinePlanId, LinePlanRangeID, MaterialID, LinePlanColorGroupID)
	SELECT LinePlanMaterialItemID, LinePlanId, LinePlanRangeID, MaterialID, @LinePlanColorGroupID FROM pLinePlanMaterialItem
	WHERE LinePlanRangeID = @LinePlanRangeID AND LinePlanID = @LinePlanID AND MaterialID = @MaterialID 		
END




















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleUPCLogic_INSERT]'
GO

ALTER PROCEDURE [dbo].[spx_StyleUPCLogic_INSERT]
(@StyleDevelopmentID uniqueidentifier,
@StyleID uniqueidentifier,
@StyleColorID uniqueidentifier,
@CreatedBy nvarchar(200),
@CreatedDate datetime)
AS 

DECLARE @UPCID uniqueidentifier
DECLARE @UPCCode varchar(20)

SELECT @UPCID = UPCID, @UPCCode = UPCCode FROM pUniversalProductCode WITH (NOLOCK) WHERE Active = 1 ORDER BY UPCCode ASC

DECLARE @ColorCode varchar(50)
DECLARE @ColorName varchar(200)

SELECT @ColorCode = StyleColorNo, @ColorName = StyleColorName FROM pStyleColorway WITH (NOLOCK) WHERE StyleColorID = @StyleColorID

BEGIN
	INSERT INTO pStyleUPC
		(StyleDevelopmentID, StyleID, StyleColorID, UPCID, UPCCode, UPCCustomField1, UPCCustomField2, CUser, CDate, MUser, MDate)
	VALUES  (@StyleDevelopmentID, @StyleID, @StyleColorID, @UPCID, @UPCCode, @ColorCode, @ColorName, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate)
END

BEGIN
	UPDATE pUniversalProductCode SET Active = 0 WHERE UPCCode = @UPCCode
END




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_MaterialSeasonYear_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_MaterialSeasonYear_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_Style_Quote_Default_SELECT]'
GO
EXEC sp_refreshview N'[dbo].[vwx_Style_Quote_Default_SELECT]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rpx_StyleColorGroups_PIVOT]'
GO
SET QUOTED_IDENTIFIER OFF
GO




CREATE PROCEDURE [dbo].[rpx_StyleColorGroups_PIVOT] (
@StyleID NVARCHAR(50),
@StyleSet int,
@SeasonYearID NVARCHAR(50)= NULL
)

AS


BEGIN 

CREATE TABLE #tmpStyleColorwayGroups (
Rec_ID INT IDENTITY (1,1) ,
StyleColorID UNIQUEIDENTIFIER , 
StyleID UNIQUEIDENTIFIER ,
StyleSet INT,
StyleColorNo NVARCHAR(50) , 
StyleColorName NVARCHAR(200) ,
MainColor NVARCHAR(100),
SAPCode NVARCHAR(50) , 
PLMCode NVARCHAR(200)
)

IF @SeasonYearID IS NOT NULL AND LEN(@SeasonYearID) > 0
BEGIN 

	DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER 

	SELECT @StyleSeasonYearID  = StyleSeasonYearID 
	FROM pStyleSeasonYear
	WHERE SeasonYearID = @SeasonYearID AND StyleID = @StyleID 

	INSERT INTO #tmpStyleColorwayGroups (StyleColorID , StyleID, StyleSet, StyleColorNo, StyleColorName, MainColor, SAPCode , PLMCode)
	SELECT b.StyleColorID , b.StyleID, b.StyleSet, b.StyleColorNo, c.ColorName, c.ColorName, b.SAPCode, b.PLMCode 
	FROM pStyleColorwaySeasonYear a INNER JOIN pStyleColorway b ON a.StyleColorwayID = b.StyleColorID
	INNER JOIN pColorPalette c ON c.ColorPaletteID = b.ColorPaletteID 
	WHERE  a.StyleID = @StyleID
	AND a.StyleSeasonYearID = @StyleSeasonYearID
	AND b.StyleSet = @StyleSet 
	ORDER BY b.Sort, b.MainColor
END
ELSE 
BEGIN

	INSERT INTO #tmpStyleColorwayGroups (StyleColorID , StyleID, StyleSet, StyleColorNo, StyleColorName, MainColor, SAPCode , PLMCode)
	SELECT StyleColorID , a.StyleID, a.StyleSet, StyleColorNo, b.ColorName AS StyleColorName, b.ColorName AS MainColor, SAPCode, PLMCode 
	FROM pStyleColorway a 
	INNER JOIN pColorPalette b ON a.ColorPaletteID = b.ColorPaletteID 
	WHERE StyleID = @StyleID 
	--AND StyleSet = @StyleSet
	ORDER BY a.Sort, a.MainColor

END

CREATE TABLE #StyleColorValues (
Rec_ID INT IDENTITY (0,1) ,
StyleColorGroupID UNIQUEIDENTIFIER , 
StyleID UNIQUEIDENTIFIER ,
StyleSet INT,
ColorGroupID UNIQUEIDENTIFIER ,
ColorGroupName NVARCHAR(200) ,
StyleColorID  UNIQUEIDENTIFIER ,
StyleColorName NVARCHAR(200) ,
Quantity DECIMAL 
)

IF @SeasonYearID IS NOT NULL AND LEN(@SeasonYearID) > 0
BEGIN
    INSERT INTO #StyleColorValues (StyleColorGroupID, StyleID, StyleSet, ColorGroupID, 
	ColorGroupName, StyleColorID, StyleColorName, Quantity)
	SELECT     b.StyleColorGroupID, b.StyleID, b.StyleSet, b.ColorGroupID, 
	b.ColorGroupName, a.StyleColorID, a.StyleColorName, c.Quantity	
	FROM         #tmpStyleColorwayGroups AS a LEFT OUTER JOIN
						  pStyleColorGroup AS b ON a.StyleID = b.StyleID LEFT OUTER JOIN
						  pStyleColorGroupItem AS c ON c.StyleColorGroupID = b.StyleColorGroupID AND a.StyleColorID = c.StyleColorID
	WHERE     (a.StyleID = @StyleID) AND (a.StyleSet = @StyleSet) AND b.StyleID=@StyleID AND b.StyleSet = @StyleSet AND b.SeasonYearID = @SeasonYearID AND c.SeasonYearID = @SeasonYearID
	ORDER BY b.Sort, b.ColorGroupName
END
ELSE
BEGIN
    INSERT INTO #StyleColorValues (StyleColorGroupID, StyleID, StyleSet, ColorGroupID, 
	ColorGroupName, StyleColorID, StyleColorName, Quantity)
	SELECT     b.StyleColorGroupID, b.StyleID, b.StyleSet, b.ColorGroupID, 
	b.ColorGroupName, a.StyleColorID, a.StyleColorName, c.Quantity	
	FROM         #tmpStyleColorwayGroups  AS a LEFT OUTER JOIN
						  pStyleColorGroup AS b ON a.StyleID = b.StyleID LEFT OUTER JOIN
						  pStyleColorGroupItem AS c ON c.StyleColorGroupID = b.StyleColorGroupID AND a.StyleColorID = c.StyleColorID
	WHERE     (a.StyleID = @StyleID) AND (a.StyleSet = @StyleSet) AND b.StyleID=@StyleID AND b.StyleSet = @StyleSet 
	ORDER BY b.Sort, b.ColorGroupName
END

DECLARE @IntegerCount int

Select @IntegerCount = Count(distinct(StyleColorName)) from #StyleColorValues


SELECT

	Rec_ID % @IntegerCount AS [Column],

    Rec_ID / @IntegerCount AS [Row],

	ColorGroupName,
StyleColorName, Quantity

FROM #StyleColorValues



DROP TABLE #StyleColorValues
DROP TABLE #tmpStyleColorwayGroups

END 

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_SampleRequestQALoad_INSERT]'
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[spx_SampleRequestQALoad_INSERT]
(
@SampleRequestWorkflowID uniqueidentifier,
@SampleRequestTradeID uniqueidentifier,
@SampleWorkflowID varchar(40),
@TradePartnerVendorID uniqueidentifier,
@StyleID uniqueidentifier,
@StyleSet varchar(2),
@StyleColorID uniqueidentifier,
@Submit varchar(2),        
@CreatedBy nvarchar(200),
@CreatedDate datetime
)

AS 
                     
INSERT INTO pSampleRequestQAWorksheet(
	SampleRequestTradeID, SampleRequestWorkflowID, SampleWorkflowID, TradePartnerVendorID, 
	SpecID, StyleID, StyleSet, StyleColorID, POMTempItemID, POMLibraryID, ModelSpecID, ModelID, POMTempID, Submit,
	Critical, POM, PointMeasur, TOL, TOLN, Ask000, Ask001, Ask002, Ask003, Ask004, Ask005, 
	Ask006, Ask007, Ask008, Ask009, Ask010, Ask011, Ask012, Ask013, Ask014, Ask015, Ask016, Ask017, Ask018, Ask019, Sort,
	CDate, MDate, CUser, MUser)
SELECT @SampleRequestTradeID, @SampleRequestWorkflowID, @SampleWorkflowID, @TradePartnerVendorID,       
	SpecID, StyleID, StyleSet, @StyleColorID, POMTempItemID, POMLibraryID, ModelSpecID, ModelID, POMTempID, @Submit,
	Critical, POM, PointMeasur, TOL, TOLN, Size0, Size1, Size2, Size3,  Size4, Size5, 
	Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13, Size14, Size15, Size16, Size17, Size18, Size19, Sort,
	@CreatedDate, @CreatedDate, @CreatedBy, @CreatedBy
FROM  pStyleSpec WHERE StyleID = @StyleID AND StyleSet = @StyleSet 
	AND (SpecID NOT IN (SELECT SpecID FROM pSampleRequestQAWorksheet 
							WHERE SampleRequestTradeID = @SampleRequestTradeID  
							AND SampleRequestWorkflowID = @SampleRequestWorkflowID 
							AND SampleWorkflowID = @SampleWorkflowID 
							AND TradePartnerVendorID = @TradePartnerVendorID 
							AND StyleID = @StyleID 
							AND StyleColorID = @StyleColorID
							AND StyleSet = @StyleSet))

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanBusinessItemRollup_INSERT]'
GO


ALTER PROCEDURE [dbo].[spx_LinePlanBusinessItemRollup_INSERT] (
@LinePlanId varchar(40),
@LinePlanAttributeItemId1 varchar(40) = '',
@LinePlanAttributeItemId2 varchar(40) = '',
@LinePlanAttributeItemId3 varchar(40) = '',
@LinePlanAttributeItemId4 varchar(40) = '',
@Cmd varchar(10) = '',
@StyleSeasonYearID UNIQUEIDENTIFIER
)
AS 

if @LinePlanAttributeItemId4 = '' 
	SET @LinePlanAttributeItemId4 = NULL

DECLARE @NoOfStyleText VARCHAR(200)
DECLARE @NoOfColorText VARCHAR(200)
DECLARE @NoOfBodyText VARCHAR(200)
DECLARE @NoOfFabricText VARCHAR(200)
DECLARE @NoOfOptionsText VARCHAR(200)
DECLARE @MarkupFactorText VARCHAR(200)
DECLARE @SalesUnitText VARCHAR(200)
DECLARE @ProjectedWhsText VARCHAR(200)
DECLARE @InitialGrossMarginRtlText VARCHAR(200)


DECLARE @LY1_NoOfStyle INTEGER
DECLARE @LY1_NoOfFabric INTEGER
DECLARE @LY1_NoOfBody INTEGER 
DECLARE @LY1_NoOfColor INTEGER
DECLARE @LY1_NoOfOptions INTEGER
DECLARE @LY1_MarkupFactor DECIMAL(18, 3)
DECLARE @LY1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @LY1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @LY1_SalesUnit DECIMAL(18, 3)
DECLARE @LY1_ProjectedWhs DECIMAL(18, 3)
DECLARE @LY1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY1_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @LY2_NoOfStyle INTEGER
DECLARE @LY2_NoOfFabric INTEGER
DECLARE @LY2_NoOfBody INTEGER 
DECLARE @LY2_NoOfColor INTEGER
DECLARE @LY2_NoOfOptions INTEGER
DECLARE @LY2_MarkupFactor DECIMAL(18, 3)
DECLARE @LY2_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @LY2_AvgTargetFOB DECIMAL(18, 3)
DECLARE @LY2_SalesUnit DECIMAL(18, 3)
DECLARE @LY2_ProjectedWhs DECIMAL(18, 3)
DECLARE @LY2_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY2_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY2_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY2_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @LY3_NoOfStyle INTEGER
DECLARE @LY3_NoOfFabric INTEGER
DECLARE @LY3_NoOfBody INTEGER 
DECLARE @LY3_NoOfColor INTEGER
DECLARE @LY3_NoOfOptions INTEGER
DECLARE @LY3_MarkupFactor DECIMAL(18, 3)
DECLARE @LY3_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @LY3_AvgTargetFOB DECIMAL(18, 3)
DECLARE @LY3_SalesUnit DECIMAL(18, 3)
DECLARE @LY3_ProjectedWhs DECIMAL(18, 3)
DECLARE @LY3_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY3_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY3_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY3_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @LY4_NoOfStyle INTEGER
DECLARE @LY4_NoOfFabric INTEGER
DECLARE @LY4_NoOfBody INTEGER 
DECLARE @LY4_NoOfColor INTEGER
DECLARE @LY4_NoOfOptions INTEGER
DECLARE @LY4_MarkupFactor DECIMAL(18, 3)
DECLARE @LY4_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @LY4_AvgTargetFOB DECIMAL(18, 3)
DECLARE @LY4_SalesUnit DECIMAL(18, 3)
DECLARE @LY4_ProjectedWhs DECIMAL(18, 3)
DECLARE @LY4_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY4_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY4_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY4_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @PL1_NoOfStyle INTEGER
DECLARE @PL1_NoOfFabric INTEGER
DECLARE @PL1_NoOfBody INTEGER 
DECLARE @PL1_NoOfColor INTEGER
DECLARE @PL1_NoOfOptions INTEGER
DECLARE @PL1_MarkupFactor DECIMAL(18, 3)
DECLARE @PL1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @PL1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @PL1_SalesUnit DECIMAL(18, 3)
DECLARE @PL1_ProjectedWhs DECIMAL(18, 3)
DECLARE @PL1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL1_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @PL2_NoOfStyle INTEGER
DECLARE @PL2_NoOfFabric INTEGER
DECLARE @PL2_NoOfBody INTEGER 
DECLARE @PL2_NoOfColor INTEGER
DECLARE @PL2_NoOfOptions INTEGER
DECLARE @PL2_MarkupFactor DECIMAL(18, 3)
DECLARE @PL2_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @PL2_AvgTargetFOB DECIMAL(18, 3)
DECLARE @PL2_SalesUnit DECIMAL(18, 3)
DECLARE @PL2_ProjectedWhs DECIMAL(18, 3)
DECLARE @PL2_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL2_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL2_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL2_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @PL3_NoOfStyle INTEGER
DECLARE @PL3_NoOfFabric INTEGER
DECLARE @PL3_NoOfBody INTEGER 
DECLARE @PL3_NoOfColor INTEGER
DECLARE @PL3_NoOfOptions INTEGER
DECLARE @PL3_MarkupFactor DECIMAL(18, 3)
DECLARE @PL3_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @PL3_AvgTargetFOB DECIMAL(18, 3)
DECLARE @PL3_SalesUnit DECIMAL(18, 3)
DECLARE @PL3_ProjectedWhs DECIMAL(18, 3)
DECLARE @PL3_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL3_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL3_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL3_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @PL4_NoOfStyle INTEGER
DECLARE @PL4_NoOfFabric INTEGER
DECLARE @PL4_NoOfBody INTEGER 
DECLARE @PL4_NoOfColor INTEGER
DECLARE @PL4_NoOfOptions INTEGER
DECLARE @PL4_MarkupFactor DECIMAL(18, 3)
DECLARE @PL4_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @PL4_AvgTargetFOB DECIMAL(18, 3)
DECLARE @PL4_SalesUnit DECIMAL(18, 3)
DECLARE @PL4_ProjectedWhs DECIMAL(18, 3)
DECLARE @PL4_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL4_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL4_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL4_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @Cu1_NoOfStyle INTEGER
DECLARE @Cu1_NoOfFabric INTEGER
DECLARE @Cu1_NoOfBody INTEGER 
DECLARE @Cu1_NoOfColor INTEGER
DECLARE @Cu1_NoOfOptions INTEGER
DECLARE @Cu1_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Cu1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Cu1_SalesUnit DECIMAL(18, 3)
DECLARE @Cu1_ProjectedWhs DECIMAL(18, 3)
DECLARE @Cu1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu1_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @Cu2_NoOfStyle INTEGER
DECLARE @Cu2_NoOfFabric INTEGER
DECLARE @Cu2_NoOfBody INTEGER 
DECLARE @Cu2_NoOfColor INTEGER
DECLARE @Cu2_NoOfOptions INTEGER
DECLARE @Cu2_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu2_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Cu2_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Cu2_SalesUnit DECIMAL(18, 3)
DECLARE @Cu2_ProjectedWhs DECIMAL(18, 3)
DECLARE @Cu2_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu2_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu2_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu2_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @Cu3_NoOfStyle INTEGER
DECLARE @Cu3_NoOfFabric INTEGER
DECLARE @Cu3_NoOfBody INTEGER 
DECLARE @Cu3_NoOfColor INTEGER
DECLARE @Cu3_NoOfOptions INTEGER
DECLARE @Cu3_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu3_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Cu3_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Cu3_SalesUnit DECIMAL(18, 3)
DECLARE @Cu3_ProjectedWhs DECIMAL(18, 3)
DECLARE @Cu3_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu3_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu3_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu3_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @Cu4_NoOfStyle INTEGER
DECLARE @Cu4_NoOfFabric INTEGER
DECLARE @Cu4_NoOfBody INTEGER 
DECLARE @Cu4_NoOfColor INTEGER
DECLARE @Cu4_NoOfOptions INTEGER
DECLARE @Cu4_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu4_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Cu4_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Cu4_SalesUnit DECIMAL(18, 3)
DECLARE @Cu4_ProjectedWhs DECIMAL(18, 3)
DECLARE @Cu4_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu4_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu4_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu4_WeightGrossMarginRtl DECIMAL(18, 3)


DECLARE @Wp1_NoOfStyle INT
DECLARE @Wp1_NoOfFabric INT
DECLARE @Wp1_NoOfBody INT
DECLARE @Wp1_NoOfColor INT
DECLARE @Wp1_NoOfOptions INT
DECLARE @Wp1_MarkupFactor DECIMAL(18, 3)
DECLARE @Wp1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Wp1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Wp1_SalesUnit DECIMAL(18, 3)
DECLARE @Wp1_ProjectedWhs DECIMAL(18, 3)
DECLARE @Wp1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Wp1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp1_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @Wp2_NoOfStyle INT
DECLARE @Wp2_NoOfFabric INT
DECLARE @Wp2_NoOfBody INT
DECLARE @Wp2_NoOfColor INT
DECLARE @Wp2_NoOfOptions INT
DECLARE @Wp2_MarkupFactor DECIMAL(18, 3)
DECLARE @Wp2_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Wp2_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Wp2_SalesUnit DECIMAL(18, 3)
DECLARE @Wp2_ProjectedWhs DECIMAL(18, 3)
DECLARE @Wp2_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Wp2_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp2_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp2_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @Wp3_NoOfStyle INT
DECLARE @Wp3_NoOfFabric INT
DECLARE @Wp3_NoOfBody INT
DECLARE @Wp3_NoOfColor INT
DECLARE @Wp3_NoOfOptions INT
DECLARE @Wp3_MarkupFactor DECIMAL(18, 3)
DECLARE @Wp3_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Wp3_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Wp3_SalesUnit DECIMAL(18, 3)
DECLARE @Wp3_ProjectedWhs DECIMAL(18, 3)
DECLARE @Wp3_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Wp3_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp3_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp3_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @Wp4_NoOfStyle INT
DECLARE @Wp4_NoOfFabric INT
DECLARE @Wp4_NoOfBody INT
DECLARE @Wp4_NoOfColor INT
DECLARE @Wp4_NoOfOptions INT
DECLARE @Wp4_MarkupFactor DECIMAL(18, 3)
DECLARE @Wp4_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Wp4_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Wp4_SalesUnit DECIMAL(18, 3)
DECLARE @Wp4_ProjectedWhs DECIMAL(18, 3)
DECLARE @Wp4_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Wp4_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp4_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Wp4_WeightGrossMarginRtl DECIMAL(18, 3)

DECLARE @LinePlanBusinessID UNIQUEIDENTIFIER

----- SEASON YEAR 
DECLARE @Season NVARCHAR(100)
DECLARE @Year NVARCHAR(5)

SELECT @Season = Season, @Year =  Year 
FROM pLinePlan WHERE LinePlanID = @LinePlanID


---- Create Temp table
CREATE TABLE #tmpLinePlanBusiness(
	ROW_ID INT IDENTITY (1,1), 
	[LinePlanID] [uniqueidentifier] NULL,
	[LinePlanBusinessID] [uniqueidentifier] NULL,
	[LinePlanFinancialID] [uniqueidentifier] NULL,
	[LinePlanFinancialText] [nvarchar](100) NULL,
	[LinePlanAttributeItemID1] [uniqueidentifier] NULL,
	[LinePlanAttributeItemID2] [uniqueidentifier] NULL,
	[LinePlanAttributeItemID3] [uniqueidentifier] NULL,
	[LinePlanAttributeItemID4] [uniqueidentifier] NULL,
	[LinePlanBusLYCh1] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusLYCh2] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusLYCh3] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusLYCh4] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusLYCh5] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusPnCh1] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusPnCh2] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusPnCh3] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusPnCh4] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusPnCh5] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusCuCh1] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusCuCh2] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusCuCh3] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusCuCh4] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusCuCh5] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanFinancialSort] [varchar](5) NULL ,
	[LinePlanBusWpCh1] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusWpCh2] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusWpCh3] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusWpCh4] [decimal](18, 3) NULL DEFAULT ((0)),
	[LinePlanBusWpCh5] [decimal](18, 3) NULL DEFAULT ((0))
)


--=============================================================================================================================
-- <!-- 1 -->
--- # of Style

SELECT  @LinePlanBusinessID = LinePlanBusinessID, @NoOfStyleText = LinePlanFinancialText,
@LY1_NoOfStyle = SUM(LinePlanBusLYCh1), @LY2_NoOfStyle = SUM(LinePlanBusLYCh2),	@LY3_NoOfStyle = SUM(LinePlanBusLYCh3), @LY4_NoOfStyle = SUM(LinePlanBusLYCh4), 
@PL1_NoOfStyle = SUM(LinePlanBusPnCh1), @PL2_NoOfStyle = SUM(LinePlanBusPnCh2), @PL3_NoOfStyle = SUM(LinePlanBusPnCh3), @PL4_NoOfStyle = SUM(LinePlanBusPnCh4), 
@Cu1_NoOfStyle = SUM(LinePlanBusCuCh1), @Cu2_NoOfStyle = SUM(LinePlanBusCuCh2), @Cu3_NoOfStyle = SUM(LinePlanBusCuCh3), @Cu4_NoOfStyle = SUM(LinePlanBusCuCh4),
@Wp1_NoOfStyle = SUM(LinePlanBusWpCh1), @Wp2_NoOfStyle = SUM(LinePlanBusWpCh2), @Wp3_NoOfStyle = SUM(LinePlanBusWpCh3), @Wp4_NoOfStyle = SUM(LinePlanBusWpCh4)
FROM pLinePlanBusinessItem
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'
AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
AND	LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanBusinessID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3


INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanBusinessID,LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusLYCh2,LinePlanBusLYCh3,	LinePlanBusLYCh4,
LinePlanBusPnCh1,LinePlanBusPnCh2,LinePlanBusPnCh3,LinePlanBusPnCh4,
LinePlanBusCuCh1,LinePlanBusCuCh2,LinePlanBusCuCh3,LinePlanBusCuCh4,
LinePlanAttributeItemID1,LinePlanAttributeItemID2,LinePlanAttributeItemID3,LinePlanAttributeItemID4,
LinePlanFinancialSort,
LinePlanBusWpCh1, LinePlanBusWpCh2, LinePlanBusWpCh3, LinePlanBusWpCh4
)
VALUES ( @LinePlanID, @LinePlanBusinessID,'10000000-0000-0000-0000-000000000004', @NoOfStyleText, 
@LY1_NoOfStyle, @LY2_NoOfStyle, @LY3_NoOfStyle, @LY4_NoOfStyle, 
@PL1_NoOfStyle, @PL2_NoOfStyle, @PL3_NoOfStyle, @PL4_NoOfStyle, 
@Cu1_NoOfStyle, @Cu2_NoOfStyle, @Cu3_NoOfStyle, @Cu4_NoOfStyle, 
@LinePlanAttributeItemID1, @LinePlanAttributeItemID2,@LinePlanAttributeItemID3,	@LinePlanAttributeItemID4,
'0001',
@Wp1_NoOfStyle, @Wp2_NoOfStyle, @Wp3_NoOfStyle, @Wp4_NoOfStyle
)


--====================================================================================================================================
-- <!-- 2 -->
---- # of Colors

SELECT @LinePlanBusinessID = LinePlanBusinessID, @NoOfColorText = LinePlanFinancialText, 
@LY1_NoOfColor = SUM(LinePlanBusLYCh1), @LY2_NoOfColor = SUM(LinePlanBusLYCh2),	@LY3_NoOfColor = SUM(LinePlanBusLYCh3), @LY4_NoOfColor = SUM(LinePlanBusLYCh4), 
@PL1_NoOfColor = SUM(LinePlanBusPnCh1), @PL2_NoOfColor = SUM(LinePlanBusPnCh2), @PL3_NoOfColor = SUM(LinePlanBusPnCh3), @PL4_NoOfColor = SUM(LinePlanBusPnCh4), 
@Cu1_NoOfColor = SUM(LinePlanBusCuCh1), @Cu2_NoOfColor = SUM(LinePlanBusCuCh2), @Cu3_NoOfColor = SUM(LinePlanBusCuCh3), @Cu4_NoOfColor = SUM(LinePlanBusCuCh4) 
FROM pLinePlanBusinessItem
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000002' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanBusinessID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3


--  Calculate No. of Colors 
if @Cu1_NoOfStyle = 0 
	SET @Cu1_NoOfColor = 0 
else 
	SELECT @Cu1_NoOfColor  = COUNT( DISTINCT  e.ColorPaletteID  )
	FROM pLinePlanBusinessItem a 
	INNER JOIN pStyleSourcing b ON a.StyleID = b.StyleID 
	INNER JOIN pStyleQuoteItem c On a.StyleID = c.StyleID AND c.StyleSourcingID = b.StyleSourcingID 
	INNER JOIN pStyleColorway d ON d.StyleColorId = c.StyleColorID
	INNER JOIN pStyleColorwaySeasonYear f ON f.StyleColorwayID = d.StyleColorID
	INNER JOIN pStyleSeasonYear g ON g.StyleSeasonYearID = f.StyleSeasonYearID
	INNER JOIN pColorPalette e ON e.ColorPaletteID =  d.ColorPaletteID
	WHERE a.LinePlanFinancialID = '10000000-0000-0000-0000-000000000002' 
	AND a.LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
	AND a.LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
	AND	a.LinePlanAttributeItemID3 = @LinePlanAttributeItemID3
	AND a.LinePlanId = @LinePlanId AND c.StyleQuoteItemStatusId = 3 
	AND g.MostLikelyVendor = 1 
	AND ( f.StyleColorStatus = 200 or f.StyleColorStatus = 300 )


--====================================================================================
-- Work in progress Colors

DECLARE @LinePlanRangeID UNIQUEIDENTIFIER 

SELECT @LinePlanRangeID = LinePlanRangeID
FROM pLinePlanRange
WHERE LinePlanAttributeItemId1 = @LinePlanAttributeItemID1
AND LinePlanAttributeItemId2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemId3 = @LinePlanAttributeItemID3
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'



SELECT @Wp1_NoOfColor = COUNT ( DISTINCT d.ColorPaletteID)
FROM pLinePlanItem  a
INNER JOIN pStyleSeasonYear b ON ( a.LinePlanItemID  = b.LinePlanItemID   
AND a.StyleID = b.StyleID )
INNER JOIN pStyleColorwaySeasonYear c ON c.StyleSeasonYearID  = b.StyleSeasonYearID
INNER JOIN pStyleColorway d ON d.StyleColorID = c.StyleColorwayID 
WHERE a.LinePlanRangeID = @LinePlanRangeID
AND b.LinePlanID = @LinePlanId
AND d.ColorPaletteID NOT IN  (
	-- colors used 
	SELECT DISTINCT d.ColorPaletteID 
	FROM pLinePlanItem a
	INNER JOIN pStyleSeasonYear b ON  (b.StyleID = a.StyleID  
	AND b.LinePlanItemID  = a.LinePlanItemID )
	INNER JOIN pStyleColorwaySeasonYear c ON c.StyleSeasonYearID = b.StyleSeasonYearID 
	INNER JOIN pStyleColorway d ON d.StyleColorID  = c.StyleColorwayID 
	INNER JOIN pStyleSourcing e ON e.StyleSeasonYearID = b.StyleSeasonYearID 
	INNER JOIN pStyleQuoteItem f ON ( f.StyleSourcingID = e.StyleSourcingID AND d.StyleColorID  =  f.StyleColorID )
	WHERE a.LinePlanRangeID = @LinePlanRangeID
	AND a.StyleID <> '00000000-0000-0000-0000-000000000000'
	AND b.TradePartnerVendorID IS NOT NULL
	AND b.LinePlanID = @LinePlanId
)


INSERT INTO #tmpLinePlanBusiness( LinePlanID,  LinePlanBusinessID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusLYCh2,LinePlanBusLYCh3,LinePlanBusLYCh4,
LinePlanBusPnCh1,LinePlanBusPnCh2,LinePlanBusPnCh3,LinePlanBusPnCh4,
LinePlanBusCuCh1,LinePlanBusCuCh2,LinePlanBusCuCh3,LinePlanBusCuCh4,
LinePlanAttributeItemID1,LinePlanAttributeItemID2,LinePlanAttributeItemID3,	LinePlanAttributeItemID4,
LinePlanFinancialSort,
LinePlanBusWpCh1, LinePlanBusWpCh2, LinePlanBusWpCh3, LinePlanBusWpCh4 )
VALUES ( @LinePlanID, @LinePlanBusinessID,'10000000-0000-0000-0000-000000000002', @NoOfColorText, 
@LY1_NoOfColor, @LY2_NoOfColor, @LY3_NoOfColor, @LY4_NoOfColor, 
@PL1_NoOfColor, @PL2_NoOfColor, @PL3_NoOfColor, @PL4_NoOfColor, 
@Cu1_NoOfColor, @Cu2_NoOfColor, @Cu3_NoOfColor, @Cu4_NoOfColor, 
@LinePlanAttributeItemID1,	@LinePlanAttributeItemID2,@LinePlanAttributeItemID3,@LinePlanAttributeItemID4,
'0004', 
@Wp1_NoOfColor, @Wp2_NoOfColor, @Wp3_NoOfColor, @Wp4_NoOfColor )


--====================================================================================================================================
-- <!-- 3 -->
--- # of Fabrics

SELECT @LinePlanBusinessID = LinePlanBusinessID, @NoOfFabricText = LinePlanFinancialText, 
@LY1_NoOfFabric = SUM(LinePlanBusLYCh1), @LY2_NoOfFabric = SUM(LinePlanBusLYCh2), @LY3_NoOfFabric = SUM(LinePlanBusLYCh3), @LY4_NoOfFabric = SUM(LinePlanBusLYCh4), 
@PL1_NoOfFabric = SUM(LinePlanBusPnCh1), @PL2_NoOfFabric = SUM(LinePlanBusPnCh2), @PL3_NoOfFabric = SUM(LinePlanBusPnCh3), @PL4_NoOfFabric = SUM(LinePlanBusPnCh4), 
@Cu1_NoOfFabric = SUM(LinePlanBusCuCh1), @Cu2_NoOfFabric = SUM(LinePlanBusCuCh2), @Cu3_NoOfFabric = SUM(LinePlanBusCuCh3), @Cu4_NoOfFabric = SUM(LinePlanBusCuCh4) 
FROM pLinePlanBusinessItem
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000001' AND 	LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanBusinessID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3


----------------------
-- Calculate No. of fabrics based on the main materials 

SELECT @Cu1_NoOfFabric = COUNT( DISTINCT e.MaterialID) 
FROM pLinePlanBusinessItem a 
INNER JOIN pStyleSourcing b ON a.StyleID = b.StyleID 
INNER JOIN pStyleQuoteItem c On a.StyleID = c.StyleID AND c.StyleSourcingID = b.StyleSourcingID 
INNER JOIN pStyleColorwaySeasonYear f ON f.StyleColorwayID = c.StyleColorID
INNER JOIN pStyleSeasonYear g ON g.StyleSeasonYearID = f.StyleSeasonYearID
INNER JOIN pStyleMaterials e ON e.StyleID =  a.StyleID 
WHERE a.LinePlanFinancialID = '10000000-0000-0000-0000-000000000002' 
AND a.LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND a.LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND	a.LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 
AND a.LinePlanId = @LinePlanId AND c.StyleQuoteItemStatusId = 3
AND g.MostLikelyVendor = 1 AND 
(f.StyleColorStatus = 200 or f.StyleColorStatus = 300)   AND e.MainMaterial = 1 
	

--=============================================
-- Work in progress - main materials


SELECT  @Wp1_NoOfFabric = COUNT( DISTINCT c.MaterialID ) 
FROM pLinePlanItem  a
INNER JOIN pStyleSeasonYear b ON ( a.LinePlanItemID  = b.LinePlanItemID   
AND a.StyleID = b.StyleID )
INNER JOIN pStyleMaterials c ON c.StyleID = b.StyleID
WHERE a.LinePlanRangeID = @LinePlanRangeID
AND c.MainMaterial = 1
AND b.LinePlanID = @LinePlanId
AND c.MaterialID  NOT IN ( 
	-- approved 
	select h.MaterialID 
	from pLinePlanRange a
	INNER JOIN pLinePlanItem b ON a.LinePlanRangeID = b.LinePlanRangeID 
	INNER JOIN pStyleSeasonYear c ON  (c.StyleID = b.StyleID AND c.LinePlanItemID = b.LinePlanItemID ) 
	INNER JOIN pStyleColorwaySeasonYear d ON  d.StyleSeasonYearID = c.StyleSeasonYearID 
	INNER JOIN pStyleColorway e ON  e.StyleColorID = d.StyleColorwayID 
	INNER JOIN pStyleSourcing f ON f.StyleSeasonYearID =  c.StyleSeasonYearID
	INNER JOIN pStyleQuoteItem g ON  (g.StyleColorID = e.StyleColorID  AND g.StyleSourcingID = f.StyleSourcingID ) 
	INNER JOIN pStyleMaterials h ON h.StyleID = c.StyleID 
	WHERE a.LinePlanAttributeItemId1 = @LinePlanAttributeItemId1  
	AND a.LinePlanAttributeItemId2 = @LinePlanAttributeItemId2
	AND a.LinePlanAttributeItemId3 = @LinePlanAttributeItemId3
	AND a.LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'
	AND c.LinePlanID = @LinePlanID
	AND b.StyleID <> '00000000-0000-0000-0000-000000000000'
	AND g.StyleQuoteItemStatusID = 3
	AND h.MainMaterial = 1 
	AND (d.StyleColorStatus = 200 or d.StyleColorStatus = 300)
)



INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanBusinessID,LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusLYCh2,LinePlanBusLYCh3,LinePlanBusLYCh4,
LinePlanBusPnCh1,LinePlanBusPnCh2,LinePlanBusPnCh3,LinePlanBusPnCh4,
LinePlanBusCuCh1,LinePlanBusCuCh2,LinePlanBusCuCh3,LinePlanBusCuCh4,
LinePlanAttributeItemID1,LinePlanAttributeItemID2,LinePlanAttributeItemID3,	LinePlanAttributeItemID4,
LinePlanFinancialSort,
LinePlanBusWpCh1, LinePlanBusWpCh2, LinePlanBusWpCh3, LinePlanBusWpCh4
)
VALUES ( @LinePlanID, @LinePlanBusinessID, '10000000-0000-0000-0000-000000000001', @NoOfFabricText, 
@LY1_NoOfFabric, @LY2_NoOfFabric, @LY3_NoOfFabric, @LY4_NoOfFabric, 
@PL1_NoOfFabric, @PL2_NoOfFabric, @PL3_NoOfFabric, @PL4_NoOfFabric, 
@Cu1_NoOfFabric, @Cu2_NoOfFabric, @Cu3_NoOfFabric, @Cu4_NoOfFabric, 
@LinePlanAttributeItemID1, @LinePlanAttributeItemID2,@LinePlanAttributeItemID3, @LinePlanAttributeItemID4, 
'0002',
@Wp1_NoOfFabric, @Wp2_NoOfFabric, @Wp3_NoOfFabric, @Wp4_NoOfFabric
)


--====================================================================================================================================
-- <!-- 4 -->
--- # of Body
SELECT @LinePlanBusinessID = LinePlanBusinessID, @NoOfBodyText = LinePlanFinancialText,
@LY1_NoOfBody = SUM(LinePlanBusLYCh1), @LY2_NoOfBody = SUM(LinePlanBusLYCh2),@LY3_NoOfBody = SUM(LinePlanBusLYCh3),  @LY4_NoOfBody = SUM(LinePlanBusLYCh4), 
@PL1_NoOfBody = SUM(LinePlanBusPnCh1), @PL2_NoOfBody = SUM(LinePlanBusPnCh2), @PL3_NoOfBody = SUM(LinePlanBusPnCh3), @PL4_NoOfBody = SUM(LinePlanBusPnCh4), 
@Cu1_NoOfBody = SUM(LinePlanBusCuCh1), @Cu2_NoOfBody = SUM(LinePlanBusCuCh2), @Cu3_NoOfBody = SUM(LinePlanBusCuCh3), @Cu4_NoOfBody = SUM(LinePlanBusCuCh4) 
FROM pLinePlanBusinessItem
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000003' AND 	LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanBusinessID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3

DECLARE @NoBody INT 

SELECT  @NoBody = COUNT( DISTINCT e.BodyID )
FROM  pStyleQuoteItem b
INNER JOIN pStyleSourcing c ON b.StyleID = c.StyleID AND b.StyleSourcingID = c.StyleSourcingID
INNER JOIN pStyleColorwaySeasonYear f ON f.StyleColorwayID = b.StyleColorID
INNER JOIN pStyleSeasonYear g ON g.StyleSeasonYearID = f.StyleSeasonYearID
INNER JOIN pStyleHeader e ON b.StyleID =  e.StyleID 
where b.StyleID IN  (
	SELECT StyleID FROM pLinePlanBusinessItem a
	WHERE a.LinePlanFinancialID = '10000000-0000-0000-0000-000000000002' AND a.LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
	AND a.LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND	a.LinePlanAttributeItemID3 = @LinePlanAttributeItemID3
	AND a.LinePlanId = @LinePlanId 
)
AND b.StyleQuoteItemStatusId = 3
AND (f.StyleColorStatus = 200 or f.StyleColorStatus = 300)
AND g.MostLikelyVendor = 1 
AND e.BodyID IS NOT NULL 
AND e.BodyID <>  '00000000-0000-0000-0000-000000000000'

--- =================================================================================================
-- Work in progress  - No of Bodies


SELECT  @Wp1_NoOfBody  = COUNT( DISTINCT c.BodyID )
FROM pLinePlanItem  a
INNER JOIN pStyleSeasonYear b ON ( a.LinePlanItemID  = b.LinePlanItemID   
AND a.StyleID = b.StyleID )
INNER JOIN pStyleHeader c ON c.StyleID = b.StyleID 
WHERE a.LinePlanRangeID = @LinePlanRangeID
AND b.LinePlanID = @LinePlanId
AND c.BodyID IS NOT NULL
AND c.BodyID NOT IN ( 
	-- approved 
	select h.BodyID
	from pLinePlanRange a
	INNER JOIN pLinePlanItem b ON a.LinePlanRangeID = b.LinePlanRangeID 
	INNER JOIN pStyleSeasonYear c ON  (c.StyleID = b.StyleID AND c.LinePlanItemID = b.LinePlanItemID ) 
	INNER JOIN pStyleColorwaySeasonYear d ON  d.StyleSeasonYearID = c.StyleSeasonYearID 
	INNER JOIN pStyleColorway e ON  e.StyleColorID = d.StyleColorwayID 
	INNER JOIN pStyleSourcing f ON f.StyleSeasonYearID =  c.StyleSeasonYearID
	INNER JOIN pStyleQuoteItem g ON  (g.StyleColorID = e.StyleColorID  AND g.StyleSourcingID = f.StyleSourcingID ) 
	INNER JOIN pStyleHeader h ON h.StyleID = c.StyleID
	WHERE a.LinePlanAttributeItemId1 = @LinePlanAttributeItemId1  
	AND a.LinePlanAttributeItemId2 = @LinePlanAttributeItemId2
	AND a.LinePlanAttributeItemId3 = @LinePlanAttributeItemId3
	AND a.LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'
	AND c.LinePlanID = @LinePlanID
	AND b.StyleID <> '00000000-0000-0000-0000-000000000000'
	AND g.StyleQuoteItemStatusID = 3
	AND (d.StyleColorStatus = 200 or d.StyleColorStatus = 300)
	AND h.BodyID IS NOT NULL
)



INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanBusinessID,LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusLYCh2,LinePlanBusLYCh3,LinePlanBusLYCh4,
LinePlanBusPnCh1,LinePlanBusPnCh2,LinePlanBusPnCh3,LinePlanBusPnCh4,
LinePlanBusCuCh1,LinePlanBusCuCh2,LinePlanBusCuCh3,LinePlanBusCuCh4,
LinePlanAttributeItemID1,LinePlanAttributeItemID2,LinePlanAttributeItemID3,	LinePlanAttributeItemID4,
LinePlanFinancialSort,
LinePlanBusWpCh1, LinePlanBusWpCh2, LinePlanBusWpCh3, LinePlanBusWpCh4 )
VALUES ( @LinePlanID, @LinePlanBusinessID,'10000000-0000-0000-0000-000000000003', @NoOfBodyText, 
@LY1_NoOfBody, @LY2_NoOfBody, @LY3_NoOfBody, @LY4_NoOfBody, 
@PL1_NoOfBody, @PL2_NoOfBody, @PL3_NoOfBody, @PL4_NoOfBody, 
--@Cu1_NoOfBody, 
@NoBody, 
@Cu2_NoOfBody, @Cu3_NoOfBody, @Cu4_NoOfBody, 
@LinePlanAttributeItemID1, @LinePlanAttributeItemID2,@LinePlanAttributeItemID3,@LinePlanAttributeItemID4,
'0003',
@Wp1_NoOfBody, @Wp2_NoOfBody, @Wp3_NoOfBody, @Wp4_NoOfBody
)



--=============================================================================================================================
-- <!-- 5 -->
---- # of Options

SELECT @LinePlanBusinessID = LinePlanBusinessID, @NoOfOptionsText = LinePlanFinancialText,
@LY1_NoOfOptions = SUM(ISNULL(LinePlanBusLYCh1,0)), @LY2_NoOfOptions= SUM(ISNULL(LinePlanBusLYCh2,0)),	
@LY3_NoOfOptions= SUM(ISNULL(LinePlanBusLYCh3,0)),  @LY4_NoOfOptions= SUM(ISNULL(LinePlanBusLYCh4,0)), 
@PL1_NoOfOptions = SUM(ISNULL(LinePlanBusPnCh1,0)), @PL2_NoOfOptions = SUM(ISNULL(LinePlanBusPnCh2,0)), 
@PL3_NoOfOptions = SUM(ISNULL(LinePlanBusPnCh3,0)), @PL4_NoOfOptions = SUM(ISNULL(LinePlanBusPnCh4,0)), 
@Cu1_NoOfOptions = SUM(ISNULL(LinePlanBusCuCh1,0)), @Cu2_NoOfOptions = SUM(ISNULL(LinePlanBusCuCh2,0)), 	
@Cu3_NoOfOptions = SUM(ISNULL(LinePlanBusCuCh3,0)), @Cu4_NoOfOptions = SUM(ISNULL(LinePlanBusCuCh4,0)) 
FROM pLinePlanBusinessItem
WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000005' AND 	LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  
AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanBusinessID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, 
LinePlanAttributeItemID2, LinePlanAttributeItemID3


INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusLYCh2,LinePlanBusLYCh3,	LinePlanBusLYCh4,
LinePlanBusPnCh1,LinePlanBusPnCh2,LinePlanBusPnCh3, LinePlanBusPnCh4,
LinePlanBusCuCh1,LinePlanBusCuCh2,LinePlanBusCuCh3,LinePlanBusCuCh4,
LinePlanAttributeItemID1,LinePlanAttributeItemID2,LinePlanAttributeItemID3,	LinePlanAttributeItemID4,
LinePlanFinancialSort,
LinePlanBusWpCh1, LinePlanBusWpCh2, LinePlanBusWpCh3, LinePlanBusWpCh4
)
VALUES ( @LinePlanID, '10000000-0000-0000-0000-000000000005', 'No of Options', 
@LY1_NoOfOptions, @LY1_NoOfOptions, @LY1_NoOfOptions, @LY1_NoOfOptions,
@PL1_NoOfOptions, @PL1_NoOfOptions, @PL1_NoOfOptions, @PL1_NoOfOptions,
@Cu1_NoOfOptions, @Cu1_NoOfOptions, @Cu1_NoOfOptions, @Cu1_NoOfOptions,
@LinePlanAttributeItemID1,	@LinePlanAttributeItemID2,	@LinePlanAttributeItemID3,	@LinePlanAttributeItemID4,
'0005', 
0, 0, 0, 0 )


--====================================================================================================================================
-- <!-- 6 --> 
--- Markup Factor

SELECT @LinePlanBusinessID = LinePlanBusinessID, @MarkupFactorText = LinePlanFinancialText,
@LY1_MarkupFactor = AVG(LinePlanBusLYCh1), @LY2_MarkupFactor = AVG(LinePlanBusLYCh2),@LY3_MarkupFactor = AVG(LinePlanBusLYCh3), @LY4_MarkupFactor = AVG(LinePlanBusLYCh4), 
@PL1_MarkupFactor = AVG(LinePlanBusPnCh1), @PL2_MarkupFactor = AVG(LinePlanBusPnCh2), @PL3_MarkupFactor = AVG(LinePlanBusPnCh3), @PL4_MarkupFactor = AVG(LinePlanBusPnCh4), 
@Cu1_MarkupFactor = AVG(LinePlanBusCuCh1), @Cu2_MarkupFactor = AVG(LinePlanBusCuCh2), @Cu3_MarkupFactor = AVG(LinePlanBusCuCh3), @Cu4_MarkupFactor = AVG(LinePlanBusCuCh4) 
FROM pLinePlanBusinessItem
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000005' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanBusinessID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3

IF @Cu1_NoOfStyle = 0 
BEGIN
	SET @Cu1_MarkupFactor = 0 
	SET @Cu2_MarkupFactor = 0
	SET @Cu3_MarkupFactor = 0
	SET @Cu4_MarkupFactor = 0
END 

INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanBusinessID,LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusLYCh2,LinePlanBusLYCh3,LinePlanBusLYCh4,
LinePlanBusPnCh1,LinePlanBusPnCh2,LinePlanBusPnCh3,LinePlanBusPnCh4,
LinePlanBusCuCh1,LinePlanBusCuCh2,LinePlanBusCuCh3,LinePlanBusCuCh4,
LinePlanAttributeItemID1,LinePlanAttributeItemID2,LinePlanAttributeItemID3,LinePlanAttributeItemID4,
LinePlanFinancialSort,
LinePlanBusWpCh1, LinePlanBusWpCh2, LinePlanBusWpCh3, LinePlanBusWpCh4 )
VALUES ( @LinePlanID, @LinePlanBusinessID,'00000000-0000-0000-0000-000000000005', @MarkupFactorText, 
@LY1_MarkupFactor, @LY2_MarkupFactor, @LY3_MarkupFactor, @LY4_MarkupFactor, 
@PL1_MarkupFactor, @PL2_MarkupFactor, @PL3_MarkupFactor, @PL4_MarkupFactor, 
@Cu1_MarkupFactor, @Cu2_MarkupFactor, @Cu3_MarkupFactor, @Cu4_MarkupFactor, 
@LinePlanAttributeItemID1,@LinePlanAttributeItemID2,@LinePlanAttributeItemID3,@LinePlanAttributeItemID4,
'0006' ,
0, 0, 0, 0 )




--====================================================================================================================================
-- <!-- 13 --> 
--- Target Avg Whs Price 
-- Average of wholesale price by style on Costing button in line plan.  Approved styles only See Style tab

SELECT @LinePlanBusinessID = LinePlanBusinessID, 
@LY1_TargetAvgWhsPrice = AVG( CASE WHEN LinePlanBusLYCh1=0 THEN NULL ELSE LinePlanBusLYCh1 END), 
@LY2_TargetAvgWhsPrice = AVG( CASE WHEN LinePlanBusLYCh2=0 THEN NULL ELSE LinePlanBusLYCh2 END), 
@LY3_TargetAvgWhsPrice = AVG( CASE WHEN LinePlanBusLYCh3=0 THEN NULL ELSE LinePlanBusLYCh3 END), 
@LY4_TargetAvgWhsPrice = AVG( CASE WHEN LinePlanBusLYCh4=0 THEN NULL ELSE LinePlanBusLYCh4 END), 

@PL1_TargetAvgWhsPrice = AVG( CASE WHEN LinePlanBusPnCh1=0 THEN NULL ELSE LinePlanBusPnCh1 END), 
@PL2_TargetAvgWhsPrice = AVG( CASE WHEN LinePlanBusPnCh2=0 THEN NULL ELSE LinePlanBusPnCh2 END), 
@PL3_TargetAvgWhsPrice = AVG( CASE WHEN LinePlanBusPnCh3=0 THEN NULL ELSE LinePlanBusPnCh3 END), 
@PL4_TargetAvgWhsPrice = AVG( CASE WHEN LinePlanBusPnCh4=0 THEN NULL ELSE LinePlanBusPnCh4 END), 

@Cu1_TargetAvgWhsPrice = AVG( CASE WHEN LinePlanBusCuCh1=0 THEN NULL ELSE LinePlanBusCuCh1 END), 
@Cu2_TargetAvgWhsPrice = AVG( CASE WHEN LinePlanBusCuCh2=0 THEN NULL ELSE LinePlanBusCuCh2 END), 
@Cu3_TargetAvgWhsPrice = AVG( CASE WHEN LinePlanBusCuCh3=0 THEN NULL ELSE LinePlanBusCuCh3 END), 
@Cu4_TargetAvgWhsPrice = AVG( CASE WHEN LinePlanBusCuCh4=0 THEN NULL ELSE LinePlanBusCuCh4 END)
FROM pLinePlanBusinessItem
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000009' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanBusinessID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3


INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusLYCh2,LinePlanBusLYCh3,LinePlanBusLYCh4,
LinePlanBusPnCh1,LinePlanBusPnCh2,LinePlanBusPnCh3,LinePlanBusPnCh4,
LinePlanBusCuCh1,LinePlanBusCuCh2,LinePlanBusCuCh3,LinePlanBusCuCh4,
LinePlanAttributeItemID1,LinePlanAttributeItemID2,LinePlanAttributeItemID3,LinePlanAttributeItemID4,
LinePlanFinancialSort ,
LinePlanBusWpCh1, LinePlanBusWpCh2, LinePlanBusWpCh3, LinePlanBusWpCh4)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000009', 'Target Avg Whs Price ', 
@LY1_TargetAvgWhsPrice, @LY2_TargetAvgWhsPrice, @LY3_TargetAvgWhsPrice, @LY4_TargetAvgWhsPrice, 
@PL1_TargetAvgWhsPrice, @PL2_TargetAvgWhsPrice, @PL3_TargetAvgWhsPrice, @PL4_TargetAvgWhsPrice, 
@Cu1_TargetAvgWhsPrice, @Cu2_TargetAvgWhsPrice, @Cu3_TargetAvgWhsPrice, @Cu4_TargetAvgWhsPrice, 
@LinePlanAttributeItemID1,@LinePlanAttributeItemID2,@LinePlanAttributeItemID3,@LinePlanAttributeItemID4,
'0013',
0, 0, 0, 0 )


--====================================================================================================================================
-- <!-- 14 --> 
-- Initial Gross Margin WHS %

SELECT @LinePlanBusinessID = LinePlanBusinessID, 
@LY1_InitialGrossMarginWhs = AVG( CASE WHEN  LinePlanBusLYCh1=0 THEN NULL ELSE LinePlanBusLYCh1 END ), 
@LY2_InitialGrossMarginWhs = AVG( CASE WHEN  LinePlanBusLYCh2=0 THEN NULL ELSE LinePlanBusLYCh2 END ), 
@LY3_InitialGrossMarginWhs = AVG( CASE WHEN  LinePlanBusLYCh3=0 THEN NULL ELSE LinePlanBusLYCh3 END ), 
@LY4_InitialGrossMarginWhs = AVG( CASE WHEN  LinePlanBusLYCh4=0 THEN NULL ELSE LinePlanBusLYCh4 END ), 

@PL1_InitialGrossMarginWhs = AVG( CASE WHEN  LinePlanBusPnCh1=0 THEN NULL ELSE LinePlanBusPnCh1 END ), 
@PL2_InitialGrossMarginWhs = AVG( CASE WHEN  LinePlanBusPnCh2=0 THEN NULL ELSE LinePlanBusPnCh2 END ), 
@PL3_InitialGrossMarginWhs = AVG( CASE WHEN  LinePlanBusPnCh3=0 THEN NULL ELSE LinePlanBusPnCh3 END ), 
@PL4_InitialGrossMarginWhs = AVG( CASE WHEN  LinePlanBusPnCh4=0 THEN NULL ELSE LinePlanBusPnCh4 END ), 

@Cu1_InitialGrossMarginWhs = AVG( CASE WHEN  LinePlanBusCuCh1=0 THEN NULL ELSE LinePlanBusCuCh1 END ), 
@Cu2_InitialGrossMarginWhs = AVG( CASE WHEN  LinePlanBusCuCh2=0 THEN NULL ELSE LinePlanBusCuCh2 END ), 
@Cu3_InitialGrossMarginWhs = AVG( CASE WHEN  LinePlanBusCuCh3=0 THEN NULL ELSE LinePlanBusCuCh3 END ), 
@Cu4_InitialGrossMarginWhs = AVG( CASE WHEN  LinePlanBusCuCh4=0 THEN NULL ELSE LinePlanBusCuCh4 END )
 
FROM pLinePlanBusinessItem
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000013' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanBusinessID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3


INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusLYCh2,LinePlanBusLYCh3,LinePlanBusLYCh4,
LinePlanBusPnCh1,LinePlanBusPnCh2,LinePlanBusPnCh3,LinePlanBusPnCh4,
LinePlanBusCuCh1,LinePlanBusCuCh2,LinePlanBusCuCh3,LinePlanBusCuCh4,
LinePlanAttributeItemID1,LinePlanAttributeItemID2,LinePlanAttributeItemID3,LinePlanAttributeItemID4,
LinePlanFinancialSort ,
LinePlanBusWpCh1, LinePlanBusWpCh2, LinePlanBusWpCh3, LinePlanBusWpCh4)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000013', 'Initial Gross Margin Wholesale %', 
@LY1_InitialGrossMarginWhs, @LY2_InitialGrossMarginWhs, @LY3_InitialGrossMarginWhs, @LY4_InitialGrossMarginWhs, 
@PL1_InitialGrossMarginWhs, @PL2_InitialGrossMarginWhs, @PL3_InitialGrossMarginWhs, @PL4_InitialGrossMarginWhs, 
@Cu1_InitialGrossMarginWhs, @Cu2_InitialGrossMarginWhs, @Cu3_InitialGrossMarginWhs, @Cu4_InitialGrossMarginWhs, 
@LinePlanAttributeItemID1,@LinePlanAttributeItemID2,@LinePlanAttributeItemID3,@LinePlanAttributeItemID4,
'0018',
0, 0, 0, 0 )


--====================================================================================================================================
-- <!-- 14 --> 
---Average Target FOB
-- Target AVG Whs Price - (Target AVG Whs Price * Initial Gross Margin WHS)

--set @LY1_AvgTargetFOB = @LY1_TargetAvgWhsPrice - ( @LY1_AvgTargetFOB * 


SELECT @LinePlanBusinessID = LinePlanBusinessID, @MarkupFactorText = LinePlanFinancialText,
@LY1_AvgTargetFOB = AVG( CASE WHEN LinePlanBusLYCh1 = 0 THEN NULL ELSE LinePlanBusLYCh1 END ), 
@LY2_AvgTargetFOB = AVG( CASE WHEN LinePlanBusLYCh2 = 0 THEN NULL ELSE LinePlanBusLYCh2 END ), 
@LY3_AvgTargetFOB = AVG( CASE WHEN LinePlanBusLYCh3 = 0 THEN NULL ELSE LinePlanBusLYCh3 END ), 
@LY4_AvgTargetFOB = AVG( CASE WHEN LinePlanBusLYCh4 = 0 THEN NULL ELSE LinePlanBusLYCh4 END ), 

@PL1_AvgTargetFOB = AVG( CASE WHEN LinePlanBusPnCh1 = 0 THEN NULL ELSE LinePlanBusPnCh1 END ), 
@PL2_AvgTargetFOB = AVG( CASE WHEN LinePlanBusPnCh2 = 0 THEN NULL ELSE LinePlanBusPnCh2 END ), 
@PL3_AvgTargetFOB = AVG( CASE WHEN LinePlanBusPnCh3 = 0 THEN NULL ELSE LinePlanBusPnCh3 END ), 
@PL4_AvgTargetFOB = AVG( CASE WHEN LinePlanBusPnCh4 = 0 THEN NULL ELSE LinePlanBusPnCh4 END ), 

@Cu1_AvgTargetFOB = AVG( CASE WHEN LinePlanBusCuCh1 = 0 THEN NULL ELSE LinePlanBusCuCh1 END ), 
@Cu2_AvgTargetFOB = AVG( CASE WHEN LinePlanBusCuCh2 = 0 THEN NULL ELSE LinePlanBusCuCh2 END ), 
@Cu3_AvgTargetFOB = AVG( CASE WHEN LinePlanBusCuCh3 = 0 THEN NULL ELSE LinePlanBusCuCh3 END ), 
@Cu4_AvgTargetFOB = AVG( CASE WHEN LinePlanBusCuCh4 = 0 THEN NULL ELSE LinePlanBusCuCh4 END )

FROM pLinePlanBusinessItem
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000006' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
AND LinePlanBusCuCh1 > 0 
GROUP BY LinePlanID, LinePlanBusinessID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3



INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusLYCh2,LinePlanBusLYCh3,LinePlanBusLYCh4,
LinePlanBusPnCh1,LinePlanBusPnCh2,LinePlanBusPnCh3,LinePlanBusPnCh4,
LinePlanBusCuCh1,LinePlanBusCuCh2,LinePlanBusCuCh3,	LinePlanBusCuCh4,
LinePlanAttributeItemID1,LinePlanAttributeItemID2,LinePlanAttributeItemID3,	LinePlanAttributeItemID4,
LinePlanFinancialSort ,
LinePlanBusWpCh1, LinePlanBusWpCh2, LinePlanBusWpCh3, LinePlanBusWpCh4)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000006', 'Average Target FOB', 
ISNULL(@LY1_AvgTargetFOB,0), ISNULL(@LY2_AvgTargetFOB,0), ISNULL(@LY3_AvgTargetFOB,0), ISNULL(@LY4_AvgTargetFOB,0), 
ISNULL(@PL1_AvgTargetFOB,0), ISNULL(@PL2_AvgTargetFOB,0), ISNULL(@PL3_AvgTargetFOB,0), ISNULL(@PL4_AvgTargetFOB,0), 
ISNULL(@Cu1_AvgTargetFOB,0), ISNULL(@Cu2_AvgTargetFOB,0), ISNULL(@Cu3_AvgTargetFOB,0), ISNULL(@Cu4_AvgTargetFOB,0), 
@LinePlanAttributeItemID1,@LinePlanAttributeItemID2,@LinePlanAttributeItemID3,@LinePlanAttributeItemID4,
'0014',
0, 0, 0, 0 )

--====================================================================================================================================
-- <!-- 15 --> 
---Sales Unit
SELECT @LinePlanBusinessID = LinePlanBusinessID, @SalesUnitText = LinePlanFinancialText,
@LY1_SalesUnit = SUM(LinePlanBusLYCh1), @LY2_SalesUnit = SUM(LinePlanBusLYCh2),@LY3_SalesUnit = SUM(LinePlanBusLYCh3), @LY4_SalesUnit = SUM(LinePlanBusLYCh4), 
@PL1_SalesUnit = SUM(LinePlanBusPnCh1), @PL2_SalesUnit = SUM(LinePlanBusPnCh2), @PL3_SalesUnit = SUM(LinePlanBusPnCh3), @PL4_SalesUnit = SUM(LinePlanBusPnCh4), 
@Cu1_SalesUnit = SUM(LinePlanBusCuCh1), @Cu2_SalesUnit = SUM(LinePlanBusCuCh2), @Cu3_SalesUnit = SUM(LinePlanBusCuCh3), @Cu4_SalesUnit = SUM(LinePlanBusCuCh4) 
FROM pLinePlanBusinessItem
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000008' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND
LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanBusinessID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3

INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanBusinessID,LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusLYCh2,LinePlanBusLYCh3,LinePlanBusLYCh4,
LinePlanBusPnCh1,LinePlanBusPnCh2,LinePlanBusPnCh3,LinePlanBusPnCh4,
LinePlanBusCuCh1,LinePlanBusCuCh2,LinePlanBusCuCh3,LinePlanBusCuCh4,
LinePlanAttributeItemID1,LinePlanAttributeItemID2,LinePlanAttributeItemID3,LinePlanAttributeItemID4,
LinePlanFinancialSort ,
LinePlanBusWpCh1, LinePlanBusWpCh2, LinePlanBusWpCh3, LinePlanBusWpCh4)
VALUES ( @LinePlanID, @LinePlanBusinessID, '00000000-0000-0000-0000-000000000008', @SalesUnitText, 
@LY1_SalesUnit, @LY2_SalesUnit, @LY3_SalesUnit, @LY4_SalesUnit, 
@PL1_SalesUnit, @PL2_SalesUnit, @PL3_SalesUnit, @PL4_SalesUnit, 
@Cu1_SalesUnit, @Cu2_SalesUnit, @Cu3_SalesUnit, @Cu4_SalesUnit, 
@LinePlanAttributeItemID1,@LinePlanAttributeItemID2, @LinePlanAttributeItemID3,	@LinePlanAttributeItemID4,
'0015',
0, 0, 0, 0 )

--====================================================================================================================================
-- <!-- 16 --> 
---Projected Wholesale
SET @LY1_ProjectedWhs = @LY1_SalesUnit * @LY1_TargetAvgWhsPrice
SET @LY2_ProjectedWhs = @LY2_SalesUnit * @LY2_TargetAvgWhsPrice
SET @LY3_ProjectedWhs = @LY3_SalesUnit * @LY3_TargetAvgWhsPrice 
SET @LY4_ProjectedWhs = @LY4_SalesUnit * @LY4_TargetAvgWhsPrice 

SET @PL1_ProjectedWhs = @PL1_SalesUnit * @PL1_TargetAvgWhsPrice 
SET @PL2_ProjectedWhs = @PL2_SalesUnit * @PL2_TargetAvgWhsPrice 
SET @PL3_ProjectedWhs = @PL3_SalesUnit * @PL3_TargetAvgWhsPrice 
SET @PL4_ProjectedWhs = @PL4_SalesUnit * @PL4_TargetAvgWhsPrice 

SET @Cu1_ProjectedWhs = @Cu1_SalesUnit * @Cu1_TargetAvgWhsPrice 
SET @Cu2_ProjectedWhs = @Cu2_SalesUnit * @Cu2_TargetAvgWhsPrice 
SET @Cu3_ProjectedWhs = @Cu3_SalesUnit * @Cu3_TargetAvgWhsPrice 
SET @Cu4_ProjectedWhs = @Cu4_SalesUnit * @Cu4_TargetAvgWhsPrice


INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanBusinessID,LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusLYCh2,LinePlanBusLYCh3,LinePlanBusLYCh4,
LinePlanBusPnCh1,LinePlanBusPnCh2,LinePlanBusPnCh3,LinePlanBusPnCh4,
LinePlanBusCuCh1,LinePlanBusCuCh2,LinePlanBusCuCh3,LinePlanBusCuCh4,
LinePlanAttributeItemID1,LinePlanAttributeItemID2,LinePlanAttributeItemID3,	LinePlanAttributeItemID4,
LinePlanFinancialSort ,
LinePlanBusWpCh1, LinePlanBusWpCh2, LinePlanBusWpCh3, LinePlanBusWpCh4)
VALUES ( @LinePlanID, @LinePlanBusinessID,'00000000-0000-0000-0000-000000000007', @ProjectedWhsText, 
@LY1_ProjectedWhs, 	@LY2_ProjectedWhs, 	@LY3_ProjectedWhs, 	@LY4_ProjectedWhs, 
@PL1_ProjectedWhs, @PL2_ProjectedWhs, @PL3_ProjectedWhs, @PL4_ProjectedWhs, 
@Cu1_ProjectedWhs, @Cu2_ProjectedWhs, @Cu3_ProjectedWhs, @Cu4_ProjectedWhs, 
@LinePlanAttributeItemID1,@LinePlanAttributeItemID2,@LinePlanAttributeItemID3,@LinePlanAttributeItemID4,
'0016' ,
0, 0, 0, 0 )



--====================================================================================================================================
---



-- StyleCostingCustomField2 Target first cost 
-- StyleCostingCustomField1 Target Retail GBP
-- StyleCostingCustomField3 Flow Through Margin (Margin mark up)
-- StyleCostingCustomField5 Wholesale Margin
-- StyleCostingCustomField6 Target Wholesale Price


SELECT a.StyleID, 
ISNULL(e.StyleCostingCustomField2,0) AS target_first_cost,
ISNULL(e.StyleCostingCustomField1,0) AS target_retail_gbp, 
ISNULL(e.StyleCostingCustomField3,0) AS flow_through_margin,
ISNULL(e.StyleCostingCustomField5,0) AS wholesale_margin, 
ISNULL(e.StyleCostingCustomField6,0) AS target_wholesale_price,
ISNULL(e.UnitsPlan,0) AS units,
(ISNULL(e.StyleCostingCustomField2,0) * ISNULL(e.UnitsPlan,0)) AS extended_1st_cost ,  --Target First Cost X Units
(ISNULL(e.StyleCostingCustomField1,0) * ISNULL(e.UnitsPlan,0)) AS extended_retail_gbp, --Target Retail GBP X Units
(ISNULL(e.StyleCostingCustomField6,0) * ISNULL(e.UnitsPlan,0)) AS extended_wholesale, -- Target wholesale price X Units
ISNULL(e.UnitsActual,0) AS units_act,
(ISNULL(e.StyleCostingCustomField2,0) * ISNULL(e.UnitsActual,0)) AS extended_1st_cost_act ,  --Target First Cost X Units
(ISNULL(e.StyleCostingCustomField1,0) * ISNULL(e.UnitsActual,0)) AS extended_retail_gbp_act, --Target Retail GBP X Units
(ISNULL(e.StyleCostingCustomField6,0) * ISNULL(e.UnitsActual,0)) AS extended_wholesale_act -- Target wholesale price X Units
INTO #tmpBase
FROM pLinePlanItem a 
INNER JOIN pLinePlanRange b  ON a.LinePlanRangeID = b.LinePlanRangeID
INNER JOIN pStyleHeader c ON a.StyleID = c.StyleID 
INNER JOIN pStyleSeasonYear d ON d.StyleID = a.StyleID AND d.LinePlanItemID = a.LinePlanItemID
INNER JOIN pStyleCostingHeader e ON e.StyleID = a.StyleID  AND e.StyleSeasonYearID = d.StyleSeasonYearID

WHERE a.StyleID <>  '00000000-0000-0000-0000-000000000000'
AND b.LinePlanAttributeItemId1 = @LinePlanAttributeItemId1 -- '762f6ecf-ce02-41fb-818f-4d29acd04036'
AND b.LinePlanAttributeItemId2 = @LinePlanAttributeItemId2  -- '40e7bf13-30a6-4bda-9c5a-b47166e03e78'
AND b.LinePlanAttributeItemId3 = @LinePlanAttributeItemId3  -- '40e7bf13-30a6-4bda-9c5a-b47166e03e78'


-- Weighted gross margin Retail % / Wholesale %

DECLARE @LY_WGM_RETAIL		DECIMAL (18,3)
DECLARE @LY_WGM_WHOLESALES	DECIMAL (18,3)

DECLARE @PN_WGM_RETAIL		DECIMAL (18,3)
DECLARE @PN_WGM_WHOLESALES	DECIMAL (18,3)

DECLARE @CU_WGM_RETAIL		DECIMAL (18,3)
DECLARE @CU_WGM_WHOLESALES	DECIMAL (18,3)

----------------------------------------------------
DECLARE @SUM_extended_1st_cost DECIMAL (18,3)
DECLARE @SUM_extended_retail_gbp DECIMAL (18,3)
DECLARE @SUM_extended_wholesale DECIMAL (18,3)

DECLARE @SUM_extended_1st_cost_act DECIMAL (18,3)
DECLARE @SUM_extended_retail_gbp_act DECIMAL (18,3)
DECLARE @SUM_extended_wholesale_act DECIMAL (18,3)

SELECT @SUM_extended_1st_cost = ISNULL(SUM (extended_1st_cost),0) FROM #tmpBase
SELECT @SUM_extended_retail_gbp = ISNULL(SUM (extended_retail_gbp),0) FROM #tmpBase
SELECT @SUM_extended_wholesale = ISNULL(SUM (extended_wholesale),0) FROM #tmpBase

SELECT @SUM_extended_1st_cost_act = ISNULL(SUM (extended_1st_cost_act),0) FROM #tmpBase
SELECT @SUM_extended_retail_gbp_act = ISNULL(SUM (extended_retail_gbp_act),0) FROM #tmpBase
SELECT @SUM_extended_wholesale_act = ISNULL(SUM (extended_wholesale_act),0) FROM #tmpBase


--LAST YEAR
SET @LY_WGM_RETAIL = 0
SET @LY_WGM_WHOLESALES = 0

-- PLANNING 
SET @PN_WGM_RETAIL = CASE WHEN @SUM_extended_retail_gbp = 0 THEN 0 ELSE (@SUM_extended_retail_gbp + @SUM_extended_1st_cost)/ @SUM_extended_retail_gbp END
SET @PN_WGM_WHOLESALES = CASE WHEN @SUM_extended_wholesale = 0 THEN 0 ELSE (@SUM_extended_wholesale + @SUM_extended_1st_cost)/ @SUM_extended_wholesale END 

-- actual 
SET @CU_WGM_RETAIL = CASE WHEN @SUM_extended_retail_gbp_act = 0 THEN 0 ELSE (@SUM_extended_retail_gbp_act + @SUM_extended_1st_cost_act)/ @SUM_extended_retail_gbp_act END 
SET @CU_WGM_WHOLESALES = CASE WHEN @SUM_extended_wholesale_act = 0 THEN 0 ELSE (@SUM_extended_wholesale_act + @SUM_extended_1st_cost_act)/ @SUM_extended_wholesale_act END 


DROP TABLE #tmpBase 


INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,LinePlanBusCuCh1,LinePlanAttributeItemID1,	LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000011',  'Weight Gross Margin WHS', 
ISNULL(@LY_WGM_WHOLESALES,0) , ISNULL(@PN_WGM_WHOLESALES,0),  ISNULL(@CU_WGM_WHOLESALES,0),
@LinePlanAttributeItemID1,'0020' , 0 )


INSERT INTO #tmpLinePlanBusiness(LinePlanID, LinePlanFinancialID, LinePlanFinancialText,LinePlanBusLYCh1,
LinePlanBusPnCh1,LinePlanBusCuCh1,	LinePlanAttributeItemID1,LinePlanFinancialSort , LinePlanBusWpCh1)
VALUES ( @LinePlanID, '00000000-0000-0000-0000-000000000012',   'Weight Gross Margin Retail', 
ISNULL(@LY_WGM_RETAIL,0) ,  ISNULL(@PN_WGM_RETAIL,0),  ISNULL(@CU_WGM_RETAIL,0),
@LinePlanAttributeItemID1,'0019' , 0)




--====================================================================================================================================
-- <!-- 6 --> 
--- Retail Flow Through Margin %   = INITIAL GROSS MARGIN RETAIL % ---
--  (Weighted average retail price - Average Target FOB) / Weighted average retail price

SELECT @LinePlanBusinessID = LinePlanBusinessID, 
@LY1_InitialGrossMarginRtl = AVG( CASE WHEN  LinePlanBusLYCh1=0 THEN NULL ELSE LinePlanBusLYCh1 END ), 
@LY2_InitialGrossMarginRtl = AVG( CASE WHEN  LinePlanBusLYCh2=0 THEN NULL ELSE LinePlanBusLYCh2 END ), 
@LY3_InitialGrossMarginRtl = AVG( CASE WHEN  LinePlanBusLYCh3=0 THEN NULL ELSE LinePlanBusLYCh3 END ), 
@LY4_InitialGrossMarginRtl = AVG( CASE WHEN  LinePlanBusLYCh4=0 THEN NULL ELSE LinePlanBusLYCh4 END ), 
@PL1_InitialGrossMarginRtl = AVG( CASE WHEN  LinePlanBusPnCh1=0 THEN NULL ELSE LinePlanBusPnCh1 END ), 
@PL2_InitialGrossMarginRtl = AVG( CASE WHEN  LinePlanBusPnCh2=0 THEN NULL ELSE LinePlanBusPnCh2 END ), 
@PL3_InitialGrossMarginRtl = AVG( CASE WHEN  LinePlanBusPnCh3=0 THEN NULL ELSE LinePlanBusPnCh3 END ), 
@PL4_InitialGrossMarginRtl = AVG( CASE WHEN  LinePlanBusPnCh4=0 THEN NULL ELSE LinePlanBusPnCh4 END ), 
@Cu1_InitialGrossMarginRtl = AVG( CASE WHEN  LinePlanBusCuCh1=0 THEN NULL ELSE LinePlanBusCuCh1 END ), 
@Cu2_InitialGrossMarginRtl = AVG( CASE WHEN  LinePlanBusCuCh2=0 THEN NULL ELSE LinePlanBusCuCh2 END ), 
@Cu3_InitialGrossMarginRtl = AVG( CASE WHEN  LinePlanBusCuCh3=0 THEN NULL ELSE LinePlanBusCuCh3 END ), 
@Cu4_InitialGrossMarginRtl = AVG( CASE WHEN  LinePlanBusCuCh4=0 THEN NULL ELSE LinePlanBusCuCh4 END )
FROM pLinePlanBusinessItem
WHERE LinePlanFinancialID = '00000000-0000-0000-0000-000000000010' AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
AND	LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3  AND LinePlanId = @LinePlanId
GROUP BY LinePlanID, LinePlanBusinessID, LinePlanFinancialID, LinePlanFinancialText, LinePlanAttributeItemID1, LinePlanAttributeItemID2, LinePlanAttributeItemID3



INSERT INTO #tmpLinePlanBusiness( LinePlanID, LinePlanBusinessID,LinePlanFinancialID, LinePlanFinancialText,
LinePlanBusLYCh1,LinePlanBusLYCh2,LinePlanBusLYCh3,LinePlanBusLYCh4,
LinePlanBusPnCh1,LinePlanBusPnCh2,LinePlanBusPnCh3,LinePlanBusPnCh4,
LinePlanBusCuCh1,LinePlanBusCuCh2,LinePlanBusCuCh3,LinePlanBusCuCh4,
LinePlanAttributeItemID1,LinePlanAttributeItemID2,LinePlanAttributeItemID3,LinePlanAttributeItemID4,
LinePlanFinancialSort,
LinePlanBusWpCh1, LinePlanBusWpCh2, LinePlanBusWpCh3, LinePlanBusWpCh4
)
VALUES ( @LinePlanID, @LinePlanBusinessID,'00000000-0000-0000-0000-000000000010', 'Retail Flow Through Margin%', 
ISNULL(@LY1_InitialGrossMarginRtl,0), ISNULL(@LY2_InitialGrossMarginRtl,0), 
ISNULL(@LY3_InitialGrossMarginRtl,0), ISNULL(@LY4_InitialGrossMarginRtl,0), 
ISNULL(@PL1_InitialGrossMarginRtl,0), ISNULL(@PL2_InitialGrossMarginRtl,0), 
ISNULL(@PL3_InitialGrossMarginRtl,0), ISNULL(@PL4_InitialGrossMarginRtl,0), 
ISNULL(@Cu1_InitialGrossMarginRtl,0), ISNULL(@Cu2_InitialGrossMarginRtl,0), 
ISNULL(@Cu3_InitialGrossMarginRtl,0), ISNULL(@Cu4_InitialGrossMarginRtl,0), 
@LinePlanAttributeItemID1, @LinePlanAttributeItemID2, 
@LinePlanAttributeItemID3, @LinePlanAttributeItemID4,
'0017',
0, 0, 0, 0 )



--====================================================================================================================================
DECLARE @TOTAL INT
DECLARE @ROW_ID INT 
DECLARE @LinePlanBusCuCh1 DECIMAL(18,3)
DECLARE @LinePlanBusWpCh1 DECIMAL(18,3)
DECLARE @LinePlanFinancialID UNIQUEIDENTIFIER
SET @ROW_ID = 1
SELECT @TOTAL  = COUNT(*) FROM #tmpLinePlanBusiness 


WHILE @ROW_ID <= @TOTAL 
BEGIN

	SELECT @LinePlanBusCuCh1 = LinePlanBusCuCh1, 
	@LinePlanFinancialID = LinePlanFinancialID,
	@LinePlanBusWpCh1 = LinePlanBusWpCh1
	FROM #tmpLinePlanBusiness WHERE ROW_ID = @ROW_ID 

	UPDATE pLinePlanBusiness 
	SET  LinePlanBusCuCh1 = @LinePlanBusCuCh1, LinePlanBusWpCh1 = @LinePlanBusWpCh1 
	WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
	AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
	AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 
	AND LinePlanId = @LinePlanId
	AND LinePlanFinancialID = @LinePlanFinancialID


	SET @ROW_ID = @ROW_ID + 1 

END 


DROP TABLE #tmpLinePlanBusiness


--=============================================================================================================================
-- Add logic to Allocate TradePartners

IF @Cu1_NoOfStyle > 0  AND @Cmd <> 'DELETE'
BEGIN
	
	DECLARE @TPVID UNIQUEIDENTIFIER
	DECLARE @CDATE DATETIME 


	SET @CDATE = GETDATE()

	CREATE TABLE  #tmpTPV (
		ROW_ID INT IDENTITY (1,1),
		TradePartnerVendorID UNIQUEIDENTIFIER
	)

	INSERT INTO #tmpTPV ( TradePartnerVendorID  ) 
	SELECT  DISTINCT b.TradePartnerVendorID 
	FROM pStyleSourcing b 
	WHERE b.StyleID IN ( 
		SELECT StyleID from pLinePlanBusinessItem 
		WHERE LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'
		AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 
		AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
		AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3
	)


	SET @ROW_ID = 1 
	SELECT @TOTAL  =  COUNT(*) FROM #tmpTPV

	WHILE @ROW_ID <=  @TOTAL
	BEGIN

		SELECT @TPVID = TradePartnerVendorID FROM #tmpTPV  WHERE ROW_ID = @ROW_ID

		EXEC spx_LinePlanTradePartner_INSERT 
		@linePlanId=@linePlanId, @TradePartnerVendorID = @TPVID,
		@CreatedBy='', @CreatedDate=@CDATE

		exec spx_LinePlanTradePartnerItem_INSERT 
		@linePlanId = @linePlanId ,
		@LinePlanRangeId= @LinePlanRangeID ,
		@TradePartnerVendorID = @TPVID,
		@CUser='', @CDate = @CDATE

		SET @ROW_ID = @ROW_ID + 1 

	END 

	DROP TABLE #tmpTPV

END 



















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[rpx_Style_TempGradedRules_SELECT]'
GO




ALTER        PROCEDURE [dbo].[rpx_Style_TempGradedRules_SELECT]  
	@StyleID varchar(255), 
	@StyleSet int 
AS
 
SELECT sz.Sel0 AS Sample0,
	sz.Sel1 AS Sample1,
	sz.Sel2 AS Sample2,
	sz.Sel3 AS Sample3,
	sz.Sel4 AS Sample4,
	sz.Sel5 AS Sample5,
	sz.Sel6 AS Sample6,
	sz.Sel7 AS Sample7,
	sz.Sel8 AS Sample8,
	sz.Sel9 AS Sample9,
	sz.Sel10 AS Sample10,
	sz.Sel11 AS Sample11,
	sz.Sel12 AS Sample12,
	sz.Sel13 AS Sample13,
	sz.Sel14 AS Sample14,
	sz.Sel15 AS Sample15,
	sz.Sel16 AS Sample16,
	sz.Sel17 AS Sample17,
	sz.Sel18 AS Sample18,
	sz.Sel19 AS Sample19,
	sz.Size0 AS Range0,
	sz.Size1 AS Range1,
	sz.Size2 AS Range2,
	sz.Size3 AS Range3,
	sz.Size4 AS Range4,
	sz.Size5 AS Range5,
	sz.Size6 AS Range6,
	sz.Size7 AS Range7,
	sz.Size8 AS Range8,
	sz.Size9 AS Range9,
      	sz.Size10 AS Range10,
	sz.Size11 AS Range11,
	sz.Size12 AS Range12,
	sz.Size13 AS Range13,
	sz.Size14 AS Range14,
	sz.Size15 AS Range15,
	sz.Size16 AS Range16,
	sz.Size17 AS Range17,
	sz.Size18 AS Range18,
	sz.Size19 AS Range19,
	CAST(ps.Size0 AS Decimal(8,3)) AS Size0,
	CAST(ps.Size1 AS Decimal(8,3)) AS Size1,
	CAST(ps.Size2 AS Decimal(8,3)) AS Size2,
	CAST(ps.Size3 AS Decimal(8,3)) AS Size3,
	CAST(ps.Size4 AS Decimal(8,3)) AS Size4,
	CAST(ps.Size5 AS Decimal(8,3)) AS Size5,
	CAST(ps.Size6 AS Decimal(8,3)) AS Size6,
	CAST(ps.Size7 AS Decimal(8,3)) AS Size7,
	CAST(ps.Size8 AS Decimal(8,3)) AS Size8,
	CAST(ps.Size9 AS Decimal(8,3)) AS Size9,
	CAST(ps.Size10 AS Decimal(8,3)) AS Size10,
	CAST(ps.Size11 AS Decimal(8,3)) AS Size11,
	CAST(ps.Size12 AS Decimal(8,3)) AS Size12,
	CAST(ps.Size13 AS Decimal(8,3)) AS Size13,
	CAST(ps.Size14 AS Decimal(8,3)) AS Size14,
	CAST(ps.Size15 AS Decimal(8,3)) AS Size15,
	CAST(ps.Size16 AS Decimal(8,3)) AS Size16,
	CAST(ps.Size17 AS Decimal(8,3)) AS Size17,
	CAST(ps.Size18 AS Decimal(8,3)) AS Size18,
	CAST(ps.Size19 AS Decimal(8,3)) AS Size19,
	CAST(ps.Grade0 AS Decimal(8,3)) AS Grade0, 
	CAST(ps.Grade1 AS Decimal(8,3)) AS Grade1, 
	CAST(ps.Grade2 AS Decimal(8,3)) AS Grade2,  
	CAST(ps.Grade3 AS Decimal(8,3)) AS Grade3, 
	CAST(ps.Grade4 AS Decimal(8,3)) AS Grade4, 
	CAST(ps.Grade5 AS Decimal(8,3)) AS Grade5, 
	CAST(ps.Grade6 AS Decimal(8,3)) AS Grade6, 
	CAST(ps.Grade7 AS Decimal(8,3)) AS Grade7, 
	CAST(ps.Grade8 AS Decimal(8,3)) AS Grade8, 
	CAST(ps.Grade9 AS Decimal(8,3)) AS Grade9, 
	CAST(ps.Grade10 AS Decimal(8,3)) AS Grade10, 
	CAST(ps.Grade11 AS Decimal(8,3)) AS Grade11, 
	CAST(ps.Grade12 AS Decimal(8,3)) AS Grade12, 
	CAST(ps.Grade13 AS Decimal(8,3)) AS Grade13, 
	CAST(ps.Grade14 AS Decimal(8,3)) AS Grade14, 
	CAST(ps.Grade15 AS Decimal(8,3)) AS Grade15, 
	CAST(ps.Grade16 AS Decimal(8,3)) AS Grade16, 
	CAST(ps.Grade17 AS Decimal(8,3)) AS Grade17, 
	CAST(ps.Grade18 AS Decimal(8,3)) AS Grade18, 
	CAST(ps.Grade19 AS Decimal(8,3)) AS Grade19, 
	CAST(ps.Proto0 AS Decimal(8,3)) AS Proto0, 
	CAST(ps.Proto1 AS Decimal(8,3)) AS Proto1, 
	CAST(ps.Proto2 AS Decimal(8,3)) AS Proto2,  
	CAST(ps.Proto3 AS Decimal(8,3)) AS Proto3, 
	CAST(ps.Proto4 AS Decimal(8,3)) AS Proto4, 
	CAST(ps.Proto5 AS Decimal(8,3)) AS Proto5, 
	CAST(ps.Proto6 AS Decimal(8,3)) AS Proto6, 
	CAST(ps.Proto7 AS Decimal(8,3)) AS Proto7, 
	CAST(ps.Proto8 AS Decimal(8,3)) AS Proto8, 
	CAST(ps.Proto9 AS Decimal(8,3)) AS Proto9, 
	CAST(ps.Proto10 AS Decimal(8,3)) AS Proto10, 
	CAST(ps.Proto11 AS Decimal(8,3)) AS Proto11, 
	CAST(ps.Proto12 AS Decimal(8,3)) AS Proto12, 
	CAST(ps.Proto13 AS Decimal(8,3)) AS Proto13, 
	CAST(ps.Proto14 AS Decimal(8,3)) AS Proto14, 
	CAST(ps.Proto15 AS Decimal(8,3)) AS Proto15, 
	CAST(ps.Proto16 AS Decimal(8,3)) AS Proto16, 
	CAST(ps.Proto17 AS Decimal(8,3)) AS Proto17, 
	CAST(ps.Proto18 AS Decimal(8,3)) AS Proto18, 
	CAST(ps.Proto19 AS Decimal(8,3)) AS Proto19, 	
	ps.POM, ps.PointMeasur, 
	CAST(ps.TOL AS Decimal(8,3)) AS TOL, 
	CAST(ps.TOLN AS Decimal(8,3)) AS TOLN, 
	WashType = 
		CASE 
			WHEN UPPER(ph.WashType) IS NULL THEN 'TOL'
			WHEN UPPER(ph.WashType) = '' THEN 'TOL'
			WHEN UPPER(ph.WashType) = 'WASH' THEN 'TOL'
			ELSE 'TOLN'
		END 
FROM	pStyleSpecTemp ps LEFT OUTER JOIN pStyleSpecSizeTemp sz ON
		ps.StyleID = sz.StyleID LEFT OUTER JOIN pStyleHeader ph ON
		ps.StyleID = ph.StyleID
WHERE	ps.StyleID = @StyleID AND ps.StyleSet = @StyleSet AND ps.Spec <> 0
ORDER BY ps.Sort, ps.POM, ps.PointMeasur



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleHeaderLocking_Logic_SELECT]'
GO
CREATE PROCEDURE dbo.spx_StyleHeaderLocking_Logic_SELECT (
@TeamID	UNIQUEIDENTIFIER,
@StyleID UNIQUEIDENTIFIER 
)
AS

DECLARE @UnlockHeader INT 
DECLARE @StyleLocked INT 

SELECT @UnlockHeader = UnlockHeader FROM Users WHERE TeamID = @TeamID 
SELECT @StyleLocked = HeaderLocked  FROM pStyleHeader WHERE StyleID = @StyleID

IF @StyleLocked > 0 AND @UnlockHeader = 1 
	SELECT 1 
ELSE 
	SELECT 0









GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_SampleRequestQASize_SELECT]'
GO

CREATE PROCEDURE [dbo].[spx_SampleRequestQASize_SELECT]
(
	@SampleRequestWorkflowID uniqueidentifier,
	@SampleRequestTradeID uniqueidentifier,
	@StyleID uniqueidentifier,
	@StyleSet nvarchar(5)
)
AS 

IF (SELECT COUNT(*) FROM pSampleRequestQASize WITH (NOLOCK)
	WHERE (SampleRequestTradeID = @SampleRequestTradeID) 
		AND (SampleRequestWorkflowID = @SampleRequestWorkflowID) 
		AND (StyleID = @StyleID) 
		AND (StyleSet = @StyleSet)) = 0

BEGIN
	

	DECLARE @SampleWorkflowID varchar(10)
	DECLARE @StyleColorID uniqueidentifier
	
	SELECT @SampleWorkflowID = SampleWorkflowID, @StyleColorID = StyleColorID 
	FROM pSampleRequestWorkflow WITH (NOLOCK) WHERE SampleRequestWorkflowID = @SampleRequestWorkflowID
	
	INSERT INTO pSampleRequestQASize (StyleID, SizeRange, StyleSet, 
		Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13, Size14, Size15, Size16, Size17, Size18, Size19, 
		Sel0, Sel1, Sel2, Sel3, Sel4, Sel5, Sel6, Sel7, Sel8, Sel9, Sel10, Sel11, Sel12, Sel13, Sel14, Sel15, Sel16, Sel17, Sel18, Sel19, 
		Col0, Col1, Col2, Col3, Col4, Col5, Col6, Col7, Col8, Col9, Col10, Col11, Col12, Col13, Col14, Col15, Col16, Col17, Col18, Col19, 
		MUser, MDate, SampleRequestQASizeID, SampleRequestWorkflowID, SampleWorkflowID, WorkflowID, StyleColorID, SampleRequestTradeID)
		SELECT StyleID, SizeRange, @StyleSet, 
		Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13, Size14, Size15, Size16, Size17, Size18, Size19, 
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
		'SYSTEM', GETDATE(), NEWID(), @SampleRequestWorkflowID, @SampleWorkflowID, '{40000000-0000-0000-0000-000000000005}', @StyleColorID, @SampleRequestTradeID
	FROM pStyleSpecSize WITH (NOLOCK)
	WHERE (StyleID = @StyleID)

	SELECT StyleID, Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13, Size14, Size15, Size16, Size17, Size18, Size19, 
		Sel0, Sel1, Sel2, Sel3, Sel4, Sel5, Sel6, Sel7, Sel8, Sel9, Sel10, Sel11, Sel12, Sel13, Sel14, Sel15, Sel16, Sel17, Sel18, Sel19
	FROM  pSampleRequestQASize WITH (NOLOCK)
	WHERE (SampleRequestTradeID = @SampleRequestTradeID) AND 
		(SampleRequestWorkflowID = @SampleRequestWorkflowID) AND 
		(StyleID = @StyleID) AND (StyleSet = @StyleSet)

	END
	
ELSE	

	BEGIN
		SELECT StyleID, Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13, Size14, Size15, Size16, Size17, Size18, Size19, 
			Sel0, Sel1, Sel2, Sel3, Sel4, Sel5, Sel6, Sel7, Sel8, Sel9, Sel10, Sel11, Sel12, Sel13, Sel14, Sel15, Sel16, Sel17, Sel18, Sel19
		FROM  pSampleRequestQASize WITH (NOLOCK)
		WHERE (SampleRequestTradeID = @SampleRequestTradeID) AND 
			(SampleRequestWorkflowID = @SampleRequestWorkflowID) AND 
			(StyleID = @StyleID) AND (StyleSet = @StyleSet)
	END	



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[vwx_MaterialSize_SEL]'
GO
ALTER VIEW dbo.vwx_MaterialSize_SEL
AS
SELECT     '00000000-0000-0000-0000-000000000000' AS MaterialSizeID, '*NA' AS MaterialSize, '00000000-0000-0000-0000-000000000000' AS MaterialID, NULL 
                      AS Sort
UNION
SELECT     TOP (100) PERCENT CAST(MaterialSizeID AS VARCHAR(40)) AS MaterialSizeID, CAST(MaterialSize AS VARCHAR(200)) AS MaterialSize, 
                      CAST(MaterialID AS VARCHAR(200)) AS MaterialID, Sort
FROM         dbo.pMaterialSize
ORDER BY Sort, MaterialSizeID
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleHeaderLogic_UPDATE]'
GO



-- Stored Procedure

ALTER PROCEDURE [dbo].[spx_StyleHeaderLogic_UPDATE]
(@StyleID uniqueidentifier)
AS 

CREATE TABLE #tmpStyleHeader ( 
    [StyleID]             	uniqueidentifier NULL,
    [StyleMasterID]       	uniqueidentifier NULL,
    [StyleType]           	int NOT NULL DEFAULT (1),
    [WorkflowType]        	uniqueidentifier NULL,
    [RefNo]               	int IDENTITY(100,1) NOT NULL,
    [StyleNo]             	nvarchar(20) NULL,
    [TempID]              	nvarchar(20) NULL,
    [TempNo]              	nvarchar(20) NULL,
    [CustomerNo]          	nvarchar(50) NULL,
    [DevelopmentID]       	uniqueidentifier NULL,
    [DevelopmentNo]       	nvarchar(20) NULL,
    [ConceptID]           	uniqueidentifier NULL,
    [ConceptNo]           	nvarchar(50) NULL,
    [SpecNo]              	nvarchar(50) NULL,
    [Description]         	nvarchar(100) NULL,
    [StyleCategory]       	uniqueidentifier NULL,
    [SizeClass]           	nvarchar(50) NULL,
    [SizeRange]           	nvarchar(50) NULL,
    [StyleSet]            	int NULL,
    [DueDate]             	datetime NULL,
    [RecDate]             	datetime NULL,
    [Customer]            	nvarchar(200) NULL,
    [Buyer]               	nvarchar(200) NULL,
    [Designer]            	nvarchar(100) NULL,
    [SampleMaker]         	nvarchar(100) NULL,
    [PatternMaker]        	nvarchar(100) NULL,
    [ProductionManager]   	nvarchar(100) NULL,
    [TechnicalDesigner]   	nvarchar(100) NULL,
    [StyleStatus]         	nvarchar(50) NULL,
    [StyleLocation]       	nvarchar(50) NULL,
    [WashType]            	nvarchar(50) NULL,
    [Pitch]               	int NULL,
    [MaterialID]          	uniqueidentifier NULL,
    [MaterialImageID]     	uniqueidentifier NULL,
    [MaterialImageVersion]	int NULL DEFAULT (0),
    [MaterialNo]          	nvarchar(50) NULL,
    [MaterialName]        	nvarchar(200) NULL,
    [POMTempID1]          	uniqueidentifier NULL,
    [POMTempVersion1]     	int NULL,
    [POMTempSizeClass1]   	nvarchar(50) NULL,
    [POMTempID2]          	uniqueidentifier NULL,
    [POMTempVersion2]     	int NULL,
    [POMTempSizeClass2]   	nvarchar(50) NULL,
    [POMTempID3]          	uniqueidentifier NULL,
    [POMTempVersion3]     	int NULL,
    [POMTempSizeClass3]   	nvarchar(50) NULL,
    [POMTempID4]          	uniqueidentifier NULL,
    [POMTempVersion4]     	int NULL,
    [POMTempSizeClass4]   	nvarchar(50) NULL,
    [StyleMaterialID]     	uniqueidentifier NULL,
    [DesignSketchID]      	uniqueidentifier NULL,
    [TechSketchID]        	uniqueidentifier NULL,
    [ConceptSketchID]     	uniqueidentifier NULL,
    [ColorSketchID]       	uniqueidentifier NULL,
    [DesignSketchVersion] 	int NULL,
    [TechSketchVersion]   	int NULL,
    [ConceptSketchVersion]	int NULL,
    [ColorSketchVersion]  	int NULL,
    [DetailSketchID1]     	uniqueidentifier NULL,
    [DetailSketchID2]     	uniqueidentifier NULL,
    [DetailSketchID3]     	uniqueidentifier NULL,
    [DetailSketchID4]     	uniqueidentifier NULL,
    [DetailSketchVersion1]	int NULL,
    [DetailSketchVersion2]	int NULL,
    [DetailSketchVersion3]	int NULL,
    [DetailSketchVersion4]	int NULL,
    [SpecSketchID1]       	uniqueidentifier NULL,
    [SpecSketchID2]       	uniqueidentifier NULL,
    [SpecSketchID3]       	uniqueidentifier NULL,
    [SpecSketchID4]       	uniqueidentifier NULL,
    [SpecSketchVersion1]  	int NULL,
    [SpecSketchVersion2]  	int NULL,
    [SpecSketchVersion3]  	int NULL,
    [SpecSketchVersion4]  	int NULL,
    [Markup]              	numeric(18,0) NULL,
    [TargetPrice]         	money NULL,
    [SellingPrice]        	money NULL,
    [CustomField1]        	nvarchar(200) NULL,
    [CustomField2]        	nvarchar(200) NULL,
    [CustomField3]        	nvarchar(200) NULL,
    [CustomField4]        	nvarchar(200) NULL,
    [CustomField5]        	nvarchar(200) NULL,
    [CustomField6]        	nvarchar(200) NULL,
    [CustomField7]    		nvarchar(200) NULL,
	[CustomField8]        	nvarchar(200) NULL,
    [CustomField9]        	nvarchar(200) NULL,
    [CustomField10]       	nvarchar(200) NULL,
    [CustomField11]       	nvarchar(200) NULL,
    [CustomField12]       	nvarchar(200) NULL,
    [CustomField13]       	nvarchar(200) NULL,
    [CustomField14]       	nvarchar(200) NULL,
    [CustomField15]       	nvarchar(200) NULL,
    [Pc1]                 	nvarchar(50) NULL,
    [Pc2]                 	nvarchar(50) NULL,
    [Pc3]                 	nvarchar(50) NULL,
    [Pc4]                 	nvarchar(50) NULL,
    [CUser]               	nvarchar(50) NULL,
    [CDate]               	datetime NULL,
    [MUser]               	nvarchar(200) NULL,
    [MDate]               	datetime NULL,
    [Active]              	int NULL,
    [Change]              	int NULL,
    [Action]              	nvarchar(200) NULL,
    [NoColorCombo]        	int NOT NULL DEFAULT (0),
    [StyleDetail]         	ntext NULL,
    [CustomField16]       	nvarchar(200) NULL,
    [CustomField17]       	nvarchar(200) NULL,
    [CustomField18]       	nvarchar(200) NULL,
    [CustomField19]       	nvarchar(200) NULL,
    [CustomField20]       	nvarchar(200) NULL,
    [CustomField21]       	nvarchar(200) NULL,
    [CustomField22]       	nvarchar(200) NULL,
    [CustomField23]       	nvarchar(200) NULL,
    [CustomField24]       	nvarchar(200) NULL,
    [CustomField25]       	nvarchar(200) NULL,
    [CustomField26]       	nvarchar(200) NULL,
    [CustomField27]       	nvarchar(200) NULL,
    [CustomField28]       	nvarchar(200) NULL,
    [CustomField29]       	nvarchar(200) NULL,
    [CustomField30]       	nvarchar(200) NULL

)

INSERT INTO #tmpStyleHeader
    (StyleID, StyleMasterID, StyleType, WorkflowType, StyleNo, TempID, TempNo, CustomerNo, DevelopmentID, DevelopmentNo, ConceptID, 
    ConceptNo, SpecNo, Description, StyleCategory, SizeClass, SizeRange, StyleSet, DueDate, RecDate, Customer, Buyer, Designer, SampleMaker, 
    PatternMaker, ProductionManager, TechnicalDesigner, StyleStatus, StyleLocation, WashType, Pitch, MaterialID, MaterialImageID, 
    MaterialImageVersion, MaterialNo, MaterialName, POMTempID1, POMTempVersion1, POMTempSizeClass1, POMTempID2, POMTempVersion2, 
    POMTempSizeClass2, POMTempID3, POMTempVersion3, POMTempSizeClass3, POMTempID4, POMTempVersion4, POMTempSizeClass4, 
    StyleMaterialID, DesignSketchID, TechSketchID, ConceptSketchID, ColorSketchID, DesignSketchVersion, TechSketchVersion, ConceptSketchVersion, 
    ColorSketchVersion, DetailSketchID1, DetailSketchID2, DetailSketchID3, DetailSketchID4, DetailSketchVersion1, DetailSketchVersion2, 
    DetailSketchVersion3, DetailSketchVersion4, SpecSketchID1, SpecSketchID2, SpecSketchID3, SpecSketchID4, SpecSketchVersion1, 
    SpecSketchVersion2, SpecSketchVersion3, SpecSketchVersion4, Markup, TargetPrice, SellingPrice, CustomField1, CustomField2, CustomField3, 
    CustomField4, CustomField5, CustomField6, CustomField7, CustomField8, CustomField9, CustomField10, CustomField11, CustomField12, 
    CustomField13, CustomField14, CustomField15, Pc1, Pc2, Pc3, Pc4, CUser, CDate, MUser, MDate, Active, Change, Action, NoColorCombo, 
    StyleDetail,CustomField16, CustomField17, CustomField18, CustomField19, CustomField20, CustomField21, CustomField22,  CustomField23, CustomField24,  CustomField25, 
	CustomField26, CustomField27, CustomField28, CustomField29, CustomField30 
	)
SELECT     StyleID, StyleMasterID, StyleType, WorkflowType, StyleNo, TempID, TempNo, CustomerNo, DevelopmentID, DevelopmentNo, ConceptID, 
    ConceptNo, SpecNo, Description, StyleCategory, SizeClass, SizeRange, StyleSet, DueDate, RecDate, Customer, Buyer, Designer, SampleMaker, 
    PatternMaker, ProductionManager, TechnicalDesigner, StyleStatus, StyleLocation, WashType, Pitch, MaterialID, MaterialImageID, 
    MaterialImageVersion, MaterialNo, MaterialName, POMTempID1, POMTempVersion1, POMTempSizeClass1, POMTempID2, POMTempVersion2, 
    POMTempSizeClass2, POMTempID3, POMTempVersion3, POMTempSizeClass3, POMTempID4, POMTempVersion4, POMTempSizeClass4, 
    StyleMaterialID, DesignSketchID, TechSketchID, ConceptSketchID, ColorSketchID, DesignSketchVersion, TechSketchVersion, ConceptSketchVersion, 
    ColorSketchVersion, DetailSketchID1, DetailSketchID2, DetailSketchID3, DetailSketchID4, DetailSketchVersion1, DetailSketchVersion2, 
    DetailSketchVersion3, DetailSketchVersion4, SpecSketchID1, SpecSketchID2, SpecSketchID3, SpecSketchID4, SpecSketchVersion1, 
    SpecSketchVersion2, SpecSketchVersion3, SpecSketchVersion4, Markup, TargetPrice, SellingPrice, CustomField1, CustomField2, CustomField3, 
    CustomField4, CustomField5, CustomField6, CustomField7, CustomField8, CustomField9, CustomField10, CustomField11, CustomField12, 
    CustomField13, CustomField14, CustomField15, Pc1, Pc2, Pc3, Pc4, CUser, CDate, MUser, MDate, Active, Change, Action, NoColorCombo, 
    StyleDetail,CustomField16, CustomField17, CustomField18, CustomField19, CustomField20, CustomField21, CustomField22,  CustomField23, CustomField24,  CustomField25, 
	CustomField26, CustomField27, CustomField28,  CustomField29,  CustomField30 
FROM dbo.pStyleHeader
WHERE (StyleID = @StyleID)

DECLARE
    @StyleMasterID       	uniqueidentifier,
    @StyleType           	int,
    @WorkflowType        	uniqueidentifier,
    @CustomerNo          	nvarchar(50),
    @DevelopmentID       	uniqueidentifier,
    @DevelopmentNo       	nvarchar(50),
    @SpecNo              	nvarchar(50),
    @Description         	nvarchar(200),
    @StyleCategory       	uniqueidentifier,
    @StyleSet            	int,
    @DueDate             	datetime,
    @RecDate             	datetime,
    @Customer            	nvarchar,
    @Buyer               	nvarchar(200),
    @Designer            	nvarchar(200),
    @SampleMaker         	nvarchar(200),
    @PatternMaker        	nvarchar(200),
    @ProductionManager   	nvarchar(200),
    @TechnicalDesigner   	nvarchar(200),
    @StyleStatus         	nvarchar(200),
    @StyleLocation       	nvarchar(200),
    @WashType            	nvarchar(200),
    @Pitch               	int,
    @MaterialID          	uniqueidentifier,
    @MaterialImageID     	uniqueidentifier,
    @MaterialImageVersion	int,
    @MaterialNo          	nvarchar(200),
    @MaterialName        	nvarchar(200),
    @StyleMaterialID     	uniqueidentifier,
    @DesignSketchID      	uniqueidentifier,
    @TechSketchID        	uniqueidentifier,
    @ConceptSketchID     	uniqueidentifier,
    @ColorSketchID       	uniqueidentifier,
    @DesignSketchVersion 	int,
    @TechSketchVersion   	int,
    @ConceptSketchVersion	int,
    @ColorSketchVersion  	int,
    @DetailSketchID1     	uniqueidentifier,
    @DetailSketchID2     	uniqueidentifier,
    @DetailSketchID3     	uniqueidentifier,
    @DetailSketchID4     	uniqueidentifier,
    @DetailSketchVersion1	int,
    @DetailSketchVersion2	int,
    @DetailSketchVersion3	int,
    @DetailSketchVersion4	int,
    @SpecSketchID1       	uniqueidentifier,
    @SpecSketchID2       	uniqueidentifier,
    @SpecSketchID3       	uniqueidentifier,
    @SpecSketchID4       	uniqueidentifier,
    @SpecSketchVersion1  	int,
    @SpecSketchVersion2  	int,
    @SpecSketchVersion3  	int,
    @SpecSketchVersion4  	int,
   @Markup              	numeric,
    @TargetPrice         	money,
    @SellingPrice        	money,
    @CustomField1        	nvarchar(200),
    @CustomField2        	nvarchar(200),
    @CustomField3        	nvarchar(200),
    @CustomField4        	nvarchar(200),
    @CustomField5        	nvarchar(200),
    @CustomField6        	nvarchar(200),
    @CustomField7    	nvarchar(200),
    @CustomField8        	nvarchar(200),
    @CustomField9        	nvarchar(200),
    @CustomField10       	nvarchar(200),
    @CustomField11       	nvarchar(200),
    @CustomField12       	nvarchar(200),

    @CustomField13       	nvarchar(200),
    @CustomField14       	nvarchar(200),
    @CustomField15       	nvarchar(200),
    @Pc1                 	nvarchar(200),
    @Pc2                 	nvarchar(200),
    @Pc3                 	nvarchar(200),
    @Pc4                 	nvarchar(200),
    @MUser               	nvarchar(200),
    @MDate               	datetime,
    @Change              	int
    --@StyleDetail         	ntext

DECLARE	@CustomField16	nvarchar(200),
		@CustomField17       	nvarchar(200),
		@CustomField18       	nvarchar(200),
		@CustomField19       	nvarchar(200),
		@CustomField20       	nvarchar(200),
		@CustomField21       	nvarchar(200),
		@CustomField22       	nvarchar(200),
		@CustomField23       	nvarchar(200),
		@CustomField24       	nvarchar(200),
		@CustomField25       	nvarchar(200),
		@CustomField26       	nvarchar(200),
		@CustomField27       	nvarchar(200),
		@CustomField28       	nvarchar(200),
		@CustomField29       	nvarchar(200),
		@CustomField30       	nvarchar(200)


SELECT     
    @StyleMasterID			= StyleMasterID,
    @StyleType				= StyleType,
    @WorkflowType			= WorkflowType,
    @CustomerNo				= CustomerNo,
    @DevelopmentID			= DevelopmentID,
    @DevelopmentNo			= DevelopmentNo,
    @SpecNo					= SpecNo,
    @Description         	= Description,
    @StyleCategory       	= StyleCategory,
    @StyleSet            	= StyleSet,
    @DueDate             	= DueDate,
    @RecDate             	= RecDate,
    @Customer            	= Customer,
    @Buyer               	= Buyer,
    @Designer            	= Designer,
    @SampleMaker         	= SampleMaker,
    @PatternMaker        	= PatternMaker,
    @ProductionManager   	= ProductionManager,
    @TechnicalDesigner   	= TechnicalDesigner,
    @StyleStatus         	= StyleStatus,
    @StyleLocation       	= StyleLocation,
    @WashType            	= WashType,
    @Pitch               	= Pitch,
    @MaterialID          	= MaterialID,
    @MaterialImageID     	= MaterialImageID,
    @MaterialImageVersion	= MaterialImageVersion,
    @MaterialNo          	= MaterialNo,
    @MaterialName        	= MaterialName,
    @StyleMaterialID     	= StyleMaterialID,
    @DesignSketchID      	= DesignSketchID,
    @TechSketchID        	= TechSketchID,
    @ConceptSketchID     	= ConceptSketchID,
    @ColorSketchID       	= ColorSketchID,
    @DesignSketchVersion 	= DesignSketchVersion,
    @TechSketchVersion   	= TechSketchVersion,
    @ConceptSketchVersion	= ConceptSketchVersion,
    @ColorSketchVersion  	= ColorSketchVersion,
    @DetailSketchID1     	= DetailSketchID1,
    @DetailSketchID2     	= DetailSketchID2,
    @DetailSketchID3     	= DetailSketchID3,
    @DetailSketchID4     	= DetailSketchID4,
    @DetailSketchVersion1	= DetailSketchVersion1,
    @DetailSketchVersion2	= DetailSketchVersion2,
    @DetailSketchVersion3	= DetailSketchVersion3,
    @DetailSketchVersion4	= DetailSketchVersion4,
    @SpecSketchID1       	= SpecSketchID1,
    @SpecSketchID2       	= SpecSketchID2,
    @SpecSketchID3       	= SpecSketchID3,
    @SpecSketchID4       	= SpecSketchID4,
    @SpecSketchVersion1  	= SpecSketchVersion1,
    @SpecSketchVersion2  	= SpecSketchVersion2,
    @SpecSketchVersion3  	= SpecSketchVersion3,
    @SpecSketchVersion4  	= SpecSketchVersion4,
    @Markup              	= Markup,
    @TargetPrice         	= TargetPrice,
    @SellingPrice        	= SellingPrice,
    @CustomField1        	= CustomField1,
    @CustomField2        	= CustomField2,
    @CustomField3        	= CustomField3,
    @CustomField4        	= CustomField4,
    @CustomField5        	= CustomField5,
    @CustomField6        	= CustomField6,
    @CustomField7    		= CustomField7,
    @CustomField8        	= CustomField8,
    @CustomField9        	= CustomField9,
    @CustomField10       	= CustomField10,
    @CustomField11       	= CustomField11,
    @CustomField12       	= CustomField12,
    @CustomField13       	= CustomField13,
    @CustomField14       	= CustomField14,
    @CustomField15       	= CustomField15,
    @CustomField16       	= CustomField16,
    @CustomField17       	= CustomField17,
    @CustomField18       	= CustomField18,
    @CustomField19       	= CustomField19,
    @CustomField20       	= CustomField20,
    @CustomField21       	= CustomField21,
    @CustomField22       	= CustomField22,
    @CustomField23       	= CustomField23,
    @CustomField24       	= CustomField24,
    @CustomField25       	= CustomField25,
    @CustomField26       	= CustomField26,
    @CustomField27       	= CustomField27,
    @CustomField28       	= CustomField28,
    @CustomField29       	= CustomField29,
    @CustomField30       	= CustomField30,
    @Pc1      			= Pc1,
    @Pc2               		= Pc2,
    @Pc3                 	= Pc3,
    @Pc4                 	= Pc4,
    @MUser               	= MUser,
    @MDate               	= MDate,
    @Change              	= Change

FROM  #tmpStyleHeader


CREATE TABLE #tempStyleDevelopmentItem ( 
	[RecID]						int IDENTITY(1,1)  NOT NULL,
	[StyleDevelopmentID]    	uniqueidentifier NULL,
	[StyleID]               	uniqueidentifier NULL,
	[SizeRange]             	nvarchar(50) NULL,
	[Variation]             	int NULL,
	[CUser]                 	nvarchar(200) NULL,
	[CDate]                 	datetime NULL,
	[MUser]                 	nvarchar(200) NULL,
	[MDate]                 	datetime NULL,
)

DECLARE @RowStyleLoop 			int
DECLARE @RowStyleCount 			int
DECLARE @tmpStyleID				uniqueidentifier
DECLARE @tmpStyleVariation		int

DECLARE @StyleDevelopmentId uniqueidentifier
SELECT @tmpStyleVariation = Variation, @StyleDevelopmentId = StyleDevelopmentId FROM pStyleDevelopmentItem WHERE StyleId = @StyleId


DECLARE @StyleTypeVarSet varchar(50)
SET @StyleTypeVarSet = (SELECT StyleType FROM pStyleType WHERE StyleTypeID IN (SELECT StyleType FROM pStyleHeader WHERE StyleID = @StyleID))


IF @StyleTypeVarSet = 'S'
BEGIN
	INSERT INTO #tempStyleDevelopmentItem (StyleDevelopmentID, StyleID, SizeRange, Variation)
	SELECT StyleDevelopmentID, StyleID, SizeRange, Variation FROM pStyleDevelopmentItem 
	WHERE StyleDevelopmentID = @StyleDevelopmentId 
	SELECT 'HOME' AS StyleType
END
ELSE
BEGIN
	INSERT INTO #tempStyleDevelopmentItem (StyleDevelopmentID, StyleID, SizeRange, Variation)
	SELECT StyleDevelopmentID, StyleID, SizeRange, Variation FROM pStyleDevelopmentItem 
	WHERE StyleDevelopmentID = @StyleDevelopmentId AND Variation = @tmpStyleVariation
	SELECT 'APPAREL' AS StyleType
END

--SELECT * FROM #tempStyleDevelopmentItem

SET @RowStyleLoop = 1
SET @RowStyleCount = (SELECT COUNT(*) FROM #tempStyleDevelopmentItem)

WHILE @RowStyleLoop <= @RowStyleCount 

	BEGIN

		SELECT @tmpStyleID = StyleID FROM #tempStyleDevelopmentItem WHERE RecID = @RowStyleLoop

			BEGIN	

				IF @StyleTypeVarSet = 'S'
				BEGIN
				UPDATE pStyleHeader
				SET StyleType = @StyleType, WorkflowType = @WorkflowType, DevelopmentID = @DevelopmentID, 
					DevelopmentNo = @DevelopmentNo, SpecNo = @SpecNo, Description = @Description, StyleCategory = @StyleCategory, StyleSet = @StyleSet, 
					Customer = @Customer, Buyer = @Buyer, Designer = @Designer, SampleMaker = @SampleMaker, 
					PatternMaker = @PatternMaker, ProductionManager = @ProductionManager, TechnicalDesigner = @TechnicalDesigner, 
					StyleLocation = @StyleLocation, WashType = @WashType, Pitch = @Pitch, MaterialID = @MaterialID, MaterialImageID = @MaterialImageID, 
					MaterialImageVersion = @MaterialImageVersion, MaterialNo = @MaterialNo, MaterialName = @MaterialName, StyleMaterialID = @StyleMaterialID, 
					--DesignSketchID = @DesignSketchID, 
					TechSketchID = @TechSketchID, ConceptSketchID = @ConceptSketchID, ColorSketchID = @ColorSketchID, 
					--DesignSketchVersion = DesignSketchVersion, 
					TechSketchVersion = @TechSketchVersion, ConceptSketchVersion = @ConceptSketchVersion, 
					ColorSketchVersion = @ColorSketchVersion, DetailSketchID1 = @DetailSketchID1, DetailSketchID2 = @DetailSketchID2, 
					DetailSketchID3 = @DetailSketchID3, DetailSketchID4 = @DetailSketchID4, DetailSketchVersion1 = @DetailSketchVersion1, 
					DetailSketchVersion2 = @DetailSketchVersion2, DetailSketchVersion3 = @DetailSketchVersion3, DetailSketchVersion4 = @DetailSketchVersion4, 
					SpecSketchID1 = @SpecSketchID1, SpecSketchID2 = @SpecSketchID2, SpecSketchID3 = @SpecSketchID3, SpecSketchID4 = @SpecSketchID4, 
					SpecSketchVersion1 = @SpecSketchVersion1, SpecSketchVersion2 = @SpecSketchVersion2, SpecSketchVersion3 = @SpecSketchVersion3, 
					SpecSketchVersion4 = @SpecSketchVersion4, Markup = @Markup, TargetPrice = @TargetPrice, SellingPrice = @SellingPrice, 
					CustomField1 = @CustomField1, CustomField2 = @CustomField2, CustomField3 = @CustomField3, CustomField4 = @CustomField4, 
					CustomField5 = @CustomField5, CustomField6 = @CustomField6, CustomField7 = @CustomField7, CustomField8 = @CustomField8, 
					CustomField9 = @CustomField9, CustomField10 = @CustomField10, CustomField11 = @CustomField11, CustomField12 = @CustomField12, 
					CustomField13 = @CustomField13, CustomField14 = @CustomField14, CustomField15 = @CustomField15, MUser = @Muser, 
					MDate = @MDate,
					CustomField16 = @CustomField16, CustomField17 = @CustomField17 , CustomField18 = @CustomField18, CustomField19 = @CustomField19,
					CustomField20 = @CustomField20, CustomField21 = @CustomField21, CustomField22 = @CustomField22, CustomField23 = @CustomField23,
					CustomField24 = @CustomField24, CustomField25 = @CustomField25, CustomField26 = @CustomField26, CustomField27 = @CustomField27,
					CustomField28 = @CustomField28, CustomField29 = @CustomField29, CustomField30 = @CustomField30
				WHERE StyleID = @tmpStyleID
				END
				ELSE
				BEGIN
				UPDATE pStyleHeader
				SET StyleMasterID = @StyleMasterID,	StyleType = @StyleType,	WorkflowType = @WorkflowType, DevelopmentID = @DevelopmentID, 
					DevelopmentNo = @DevelopmentNo, SpecNo = @SpecNo, Description = @Description, StyleCategory = @StyleCategory, StyleSet = @StyleSet, 
					Customer = @Customer, Buyer = @Buyer, Designer = @Designer, SampleMaker = @SampleMaker, 
					PatternMaker = @PatternMaker, ProductionManager = @ProductionManager, TechnicalDesigner = @TechnicalDesigner, 
					StyleLocation = @StyleLocation, WashType = @WashType, Pitch = @Pitch, MaterialID = @MaterialID, MaterialImageID = @MaterialImageID, 
					MaterialImageVersion = @MaterialImageVersion, MaterialNo = @MaterialNo, MaterialName = @MaterialName, StyleMaterialID = @StyleMaterialID, 
					DesignSketchID = @DesignSketchID, TechSketchID = @TechSketchID, ConceptSketchID = @ConceptSketchID, ColorSketchID = @ColorSketchID, 
					DesignSketchVersion = DesignSketchVersion, TechSketchVersion = @TechSketchVersion, ConceptSketchVersion = @ConceptSketchVersion, 
					ColorSketchVersion = @ColorSketchVersion, DetailSketchID1 = @DetailSketchID1, DetailSketchID2 = @DetailSketchID2, 
					DetailSketchID3 = @DetailSketchID3, DetailSketchID4 = @DetailSketchID4, DetailSketchVersion1 = @DetailSketchVersion1, 
					DetailSketchVersion2 = @DetailSketchVersion2, DetailSketchVersion3 = @DetailSketchVersion3, DetailSketchVersion4 = @DetailSketchVersion4, 
					SpecSketchID1 = @SpecSketchID1, SpecSketchID2 = @SpecSketchID2, SpecSketchID3 = @SpecSketchID3, SpecSketchID4 = @SpecSketchID4, 
					SpecSketchVersion1 = @SpecSketchVersion1, SpecSketchVersion2 = @SpecSketchVersion2, SpecSketchVersion3 = @SpecSketchVersion3, 
					SpecSketchVersion4 = @SpecSketchVersion4, Markup = @Markup, TargetPrice = @TargetPrice, SellingPrice = @SellingPrice, 
					CustomField1 = @CustomField1, CustomField2 = @CustomField2, CustomField3 = @CustomField3, CustomField4 = @CustomField4, 
					CustomField5 = @CustomField5, CustomField6 = @CustomField6, CustomField7 = @CustomField7, CustomField8 = @CustomField8, 
					CustomField9 = @CustomField9, CustomField10 = @CustomField10, CustomField11 = @CustomField11, CustomField12 = @CustomField12, 
					CustomField13 = @CustomField13, CustomField14 = @CustomField14, CustomField15 = @CustomField15, MUser = @Muser, 
					MDate = @MDate,
					CustomField16 = @CustomField16, CustomField17 = @CustomField17 , CustomField18 = @CustomField18, CustomField19 = @CustomField19,
					CustomField20 = @CustomField20, CustomField21 = @CustomField21, CustomField22 = @CustomField22, CustomField23 = @CustomField23,
					CustomField24 = @CustomField24, CustomField25 = @CustomField25, CustomField26 = @CustomField26, CustomField27 = @CustomField27,
					CustomField28 = @CustomField28, CustomField29 = @CustomField29, CustomField30 = @CustomField30
				WHERE StyleID = @tmpStyleID
				END
			END	

--			IF (SELECT COUNT(*) FROM pStyleSeasonYear WHERE StyleID = @StyleID AND StyleSeason = @CustomField5 
--				AND  StyleYear = @CustomField6 ) = 0
--			BEGIN
--				INSERT INTO pStyleSeasonYear
--					(StyleID, StyleSeason, StyleYear, CUser, CDate, MUser, MDate) 
--				SELECT StyleID, CustomField5, CustomField6, CUser, CDate, MUser, MDate FROM pStyleHeader 
--				WHERE StyleID = @tmpStyleID
--			END
--			ELSE
--			BEGIN
--
--				UPDATE pStyleSeasonYear SET 
--					StyleSeason = @CustomField5, StyleYear = @CustomField6, MUser = @MUser, MDate = @MDate
--				WHERE StyleID = @tmpStyleID
--			END

		SET @RowStyleLoop = @RowStyleLoop + 1

	END


/*
--It will auto create sourcing folder 
DECLARE @TradePartnerID uniqueidentifier
DECLARE @TradePartnerVendorID uniqueidentifier

SELECT @TradePartnerID = TradePartnerID, @TradePartnerVendorID = TradePartnerVendorID FROM pStyleHeader WHERE StyleID = @StyleID

IF (SELECT COUNT(*) FROM pStyleSourcing 
WHERE StyleID = @StyleID AND TradePartnerID = @TradePartnerID AND 
TradePartnerVendorID = @TradePartnerVendorID) = 0
	BEGIN


		IF NOT @TradePartnerVendorID IS NULL

		BEGIN
			UPDATE pStyleSourcing SET MostLikelyVendor = 0 WHERE StyleID = @StyleID

			DECLARE @StyleSourcingID UNIQUEIDENTIFIER
			SET @StyleSourcingID = newid()

			INSERT INTO pStyleSourcing (StyleSourcingID, StyleID, SourcingName, CDate, CUser, MDate, MUser
					   ,Active, TradePartnerID, TradePartnerVendorID, MostLikelyVendor)
			SELECT @StyleSourcingID, StyleID, StyleNo, MDate, MUser, MDate, MUser
					   ,1, TradePartnerID, TradePartnerVendorID, 1
			FROM pStyleHeader
			WHERE StyleID = @StyleID

			INSERT INTO pStyleSourcingItem 
					   ([StyleSourcingItemID]
					   ,[StyleSourcingID]
					   ,[StyleMaterialID]
					   ,[TradePartnerVendorID]
					   ,[UOM]
					   ,[Qty]
					   ,[MaterialPrice]
					   ,[Sort]
					   ,[StyleColorID]
					   ,[StyleSet]
					   ,[BOM])
			SELECT      newid()
						,@StyleSourcingID
						,pStyleMaterials.StyleMaterialID
						,'00000000-0000-0000-0000-000000000000'
						,pStyleMaterials.UOM
						,pStyleMaterials.Qty
						,pStyleMaterials.MaterialPrice 
						,pStyleMaterials.MaterialSort
						,pStyleColorway.StyleColorID
						,pStyleColorway.StyleSet
						,1
			FROM pStyleMaterials INNER JOIN
				pStyleColorway ON pStyleMaterials.StyleID = pStyleColorway.StyleID AND 
				pStyleMaterials.StyleSet = pStyleColorway.StyleSet
			WHERE pStyleMaterials.StyleID = @StyleID AND 
				(CAST(pStyleColorway.StyleColorID AS VARCHAR(40)) + CAST(pStyleMaterials.StyleMaterialID AS VARCHAR(40)) NOT IN (
				SELECT CAST(StyleColorID AS VARCHAR(40)) + CAST(StyleMaterialID AS VARCHAR(40)) FROM pStyleSourcingItem WHERE StyleSourcingID = @StyleSourcingID))

		END

	END

*/







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleColorway_INSERT]'
GO
ALTER  PROCEDURE [dbo].[spx_StyleColorway_INSERT]  (
@StyleID UNIQUEIDENTIFIER ,
@StyleSet INT ,
@MainColor NVARCHAR (100) , 
@CUser  NVARCHAR (200) , 
@CDate DATETIME , 
@AllSizeClasses INT ,
@SeasonYearID UNIQUEIDENTIFIER  = NULL 
)
AS 

DECLARE @StyleNo NVARCHAR(20)
DECLARE @StyleColorID UNIQUEIDENTIFIER

SET @StyleColorID =  NEWID()

INSERT INTO pStyleColorway ( StyleColorID, StyleID, StyleSet, MainColor, CUser, CDate, MUser, MDate) 
VALUES ( @StyleColorID ,  @StyleID, @StyleSet, @MainColor, @CUser, @CDate, @CUser, @CDate ) 

EXEC dbo.spx_StyleColorwayItem_FIX  @StyleId = @StyleID ,@StyleSet = @StyleSet

SELECT @StyleNo = StyleNo FROM pStyleHeader WHERE StyleID =@StyleID

IF @SeasonYearID IS NULL
BEGIN
	SELECT TOP 1 @SeasonYearID = SeasonYearID FROM pStyleSeasonYear WHERE StyleID = @StyleID
END 


IF @SeasonYearID  IS NOT NULL 
BEGIN
	DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER 
	SELECT @StyleSeasonYearID = StyleSeasonYearID 
	FROM pStyleSeasonYear 
	WHERE StyleID = @StyleID AND SeasonYearID =  @SeasonYearID 

	IF @StyleSeasonYearID IS NULL
	BEGIN
		SET @StyleSeasonYearID = NEWID() 
		INSERT INTO pStyleSeasonYear ( StyleSeasonYearID , StyleID , StyleSeason, StyleYear, CUser, CDate, MUser, MDate,
		SeasonYearID, StyleNo, CurrentSeason )
		SELECT @StyleSeasonYearID, @StyleID , a.Season, a.Year, @CUser, @CDate, @CUser, @CDate,
		a.SeasonYearID, @StyleNo, 0
		FROM  pSeasonYear a
		WHERE a.SeasonYearID = @SeasonYearID
	END 

	INSERT INTO  pStyleColorwaySeasonYear ( StyleColorwaySeasonYearID , StyleSeasonYearID , StyleColorwayID , StyleID ,  
	StyleColorDelivery1, StyleColorDelivery2, StyleColorDelivery3, StyleColorDelivery4, StyleColorStatus, Units )
	VALUES ( NEWID(), @StyleSeasonYearID , @StyleColorID , @StyleID ,  
	0, 0, 0, 0, 900, 0  ) 
END 



IF   @AllSizeClasses  =   1  
BEGIN 

	DECLARE @DevelopmentID UNIQUEIDENTIFIER 
	DECLARE @Variation   INT 
	DECLARE @StyleID2  UNIQUEIDENTIFIER 
	DECLARE @Row INT
	DECLARE @Row_current INT 
	DECLARE @StyleNo2 NVARCHAR(20)
	DECLARE @StyleColorID2 UNIQUEIDENTIFIER 


	CREATE TABLE #TmpStyle (	
		Rec_ID INT IDENTITY  (1,1 )  ,
		StyleID UNIQUEIDENTIFIER  ,
		StyleNo NVARCHAR(20)
	)


	SELECT @DevelopmentID  = a.DevelopmentID ,  @Variation  =  b.Variation  
	FROM pStyleHeader a WITH (NOLOCK) , pStyleDevelopmentItem b WITH (NOLOCK) 
	WHERE a.StyleID = @StyleID 
	AND a.DevelopmentID = b.StyleDevelopmentID
	AND a.StyleID = b.StyleID 

	INSERT INTO  #TmpStyle   ( StyleID , StyleNo  )
	SELECT  b.StyleID, b.StyleNo
	FROM pStyleDevelopmentItem a WITH (NOLOCK) 
	INNER JOIN pStyleHeader b ON a.StyleID = b.StyleID
	WHERE a.StyleDevelopmentID = @DevelopmentID AND a.Variation = @Variation 
	AND a.StyleID <>  @StyleID 


	SELECT @Row  = COUNT(*) FROM #TmpStyle 
	SET @Row_current  =  1

	WHILE  @Row_current  <= @Row  
	BEGIN 
		SELECT @StyleID2 = StyleID, @StyleNo2 =  StyleNo FROM  #TmpStyle WHERE Rec_ID = @Row_current 

		SET @StyleColorID2 = NEWID()

		INSERT INTO pStyleColorway ( StyleColorID, StyleID, StyleSet, MainColor, CUser, CDate, MUser, MDate) 
		VALUES (  @StyleColorID2,  @StyleID2 , @StyleSet, @MainColor, @CUser, @CDate, @CUser, @CDate ) 

		EXEC dbo.spx_StyleColorwayItem_FIX  @StyleId = @StyleID2 ,@StyleSet = 1	


		---**********************************************************************************************************
		-- ADD Colorway -Season year
		IF @SeasonYearID  IS NOT NULL 
		BEGIN
			DECLARE @StyleSeasonYearID2 UNIQUEIDENTIFIER 
			SELECT @StyleSeasonYearID2 = StyleSeasonYearID 
			FROM pStyleSeasonYear 
			WHERE StyleID = @StyleID2 AND SeasonYearID =  @SeasonYearID 

			IF @StyleSeasonYearID2 IS NULL
			BEGIN
				SET @StyleSeasonYearID2 = NEWID() 

				INSERT INTO pStyleSeasonYear ( StyleSeasonYearID , StyleID , StyleSeason, StyleYear, CUser, CDate, MUser, MDate,
				SeasonYearID, StyleNo, CurrentSeason )
				SELECT @StyleSeasonYearID2, @StyleID2 , a.Season, a.Year, @CUser, @CDate, @CUser, @CDate,
				a.SeasonYearID, @StyleNo2, 0
				FROM  pSeasonYear a
				WHERE a.SeasonYearID = @SeasonYearID
			END 

			INSERT INTO  pStyleColorwaySeasonYear ( StyleColorwaySeasonYearID , StyleSeasonYearID , StyleColorwayID , StyleID ,  
			StyleColorDelivery1, StyleColorDelivery2, StyleColorDelivery3, StyleColorDelivery4, StyleColorStatus, Units )
			VALUES ( NEWID(), @StyleSeasonYearID2 , @StyleColorID2 , @StyleID2 ,  
			0, 0, 0, 0, 900, 0  ) 
		END 
		---**********************************************************************************************************



		SET @Row_current = @Row_current  + 1 
	END 

	DROP TABLE #TmpStyle


END 







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_ImageCatalogItem_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_ImageCatalogItem_SELECT]( 
@ImageCatalogID uniqueidentifier, 
@TeamID UNIQUEIDENTIFIER =  NULL 
)

AS 

IF @TeamID   IS NULL 
BEGIN 

	SELECT     pImageCatalogItem.ImageCatalogItemID, pImageCatalogItem.ImageCatalogID, pImageCatalogItem.ImageID, 
	                      pImageCatalogItem.ImageVersion, pImage.ImageNo, pImage.ImageDescription, pImageCatalogItem.CUser, 
	                      pImageCatalogItem.CDate, pImageCatalogItem.MUser, pImageCatalogItem.MDate, pImage.ImageFile, 
	                      pImageCatalogItem.ImageSort
	FROM         pImageCatalogItem WITH (NOLOCK) INNER JOIN
	                      pImage WITH (NOLOCK) ON pImageCatalogItem.ImageID = pImage.ImageID
	WHERE     (pImageCatalogItem.ImageCatalogID = @ImageCatalogID)
	ORDER BY pImageCatalogItem.ImageSort, pImage.ImageNo

END 
ELSE 
BEGIN 

	SELECT     pImageCatalogItem.ImageCatalogItemID, pImageCatalogItem.ImageCatalogID, pImageCatalogItem.ImageID, 
	                      pImageCatalogItem.ImageVersion, pImage.ImageNo, pImage.ImageDescription, pImageCatalogItem.CUser, 
	                      pImageCatalogItem.CDate, pImageCatalogItem.MUser, pImageCatalogItem.MDate, pImage.ImageFile, 
	                      pImageCatalogItem.ImageSort
	FROM         pImageCatalogItem WITH (NOLOCK) INNER JOIN
	                      pImage WITH (NOLOCK) ON pImageCatalogItem.ImageID = pImage.ImageID
	WHERE     (pImageCatalogItem.ImageCatalogID = @ImageCatalogID)
	AND pImage.ImageSubFolder1  IN  ( 
		SELECT DISTINCT b.ImageType 
		FROM sAccessImageFolder a WITH (NOLOCK) INNER JOIN  pImageType b WITH (NOLOCK)  ON a.ImageTypeID = b.ImageTypeID
		WHERE TeamID = @TeamID
		AND ( AccessRoleId =3 OR AccessView = 1 )
	
	) 
	ORDER BY pImageCatalogItem.ImageSort, pImage.ImageNo

END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleHeaderCopy_INSERT]'
GO
ALTER PROCEDURE [dbo].[spx_StyleHeaderCopy_INSERT]
(
@StyleID uniqueidentifier,
@NewStyleID uniqueidentifier,
@DesignSketchID uniqueidentifier,
@DesignSketchVersion varchar(5),
@StyleVariation varchar(5),
@CreatedBy nvarchar(200),
@CreatedDate datetime
)
AS

SET NOCOUNT ON

DECLARE @StyleMasterID uniqueidentifier
DECLARE @NewStyleMasterID uniqueidentifier

SET @NewStyleMasterID = newid()

/*
BEGIN

	SELECT @StyleMasterID = StyleMasterID FROM pStyleHeader WITH (NOLOCK) WHERE StyleID = @StyleID

		IF @StyleMasterID IS NULL
		BEGIN			
			UPDATE pStyleHeader SET StyleMasterID = @NewStyleMasterID WHERE StyleID = @StyleID
		END	

END
*/

SET @StyleMasterID = @NewStyleMasterID

BEGIN
	INSERT INTO pStyleHeader
		(StyleID, StyleMasterID, StyleType, WorkflowType, StyleNo, TempID, TempNo, CustomerNo, ConceptID, ConceptNo, SpecNo, Description, SizeRange, SizeClass, 
		StyleSet, DueDate, RecDate, Designer, StyleStatus, StyleLocation, WashType, Pitch, MaterialID, MaterialImageID, MaterialImageVersion, MaterialNo, 
		MaterialName, POMTempID1, POMTempVersion1, POMTempID2, POMTempVersion2, POMTempID3, POMTempVersion3, POMTempID4, 
		POMTempVersion4, POMTempSizeClass1, POMTempSizeClass2, POMTempSizeClass3, POMTempSizeClass4, StyleMaterialID, DesignSketchID, 
		TechSketchID, ConceptSketchID, ColorSketchID, DesignSketchVersion, TechSketchVersion, ConceptSketchVersion, ColorSketchVersion, 
		DetailSketchID1, DetailSketchID2, DetailSketchID3, DetailSketchID4, DetailSketchVersion1, DetailSketchVersion2, DetailSketchVersion3, 
		DetailSketchVersion4, SpecSketchID1, SpecSketchID2, SpecSketchID3, SpecSketchID4, SpecSketchVersion1, SpecSketchVersion2, 
		SpecSketchVersion3, SpecSketchVersion4, CustomField1, CustomField2, CustomField3, CustomField4, CustomField5, CustomField6, CustomField7, 
		CustomField8, CustomField9, CustomField10, CustomField11, CustomField12, CustomField13, CustomField14, CustomField15, 
--		Size0, Size1, Size2,  Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, 
--		Sel0, Sel1, Sel2, Sel3, Sel4, Sel5, Sel6, Sel7, Sel8, Sel9, Sel10, Sel11, 
		Pc1, Pc2, Pc3, 
		Pc4, CUser, CDate, MUser, MDate, Active, Change, Action, SampleMaker, PatternMaker, ProductionManager, TechnicalDesigner, StyleDetail, StyleDetail1, 
		StyleDetail2, StyleAttribute,
		CustomField16, CustomField17, CustomField18, CustomField19, CustomField20, CustomField21, CustomField22,  CustomField23, CustomField24,  CustomField25, 
		CustomField26, CustomField27, CustomField28,  CustomField29,  CustomField30 , StyleCopyID
		)
	SELECT     @NewStyleID, @StyleMasterID, StyleType, WorkflowType, StyleNo, TempID, TempNo, CustomerNo, ConceptID, ConceptNo, 
		SpecNo, Description, SizeRange, SizeClass, StyleSet, DueDate, RecDate, Designer, StyleStatus, StyleLocation, WashType, Pitch, MaterialID, MaterialImageID, 
		MaterialImageVersion, MaterialNo, MaterialName, POMTempID1, POMTempVersion1, POMTempID2, POMTempVersion2, POMTempID3, 
		POMTempVersion3, POMTempID4, POMTempVersion4, POMTempSizeClass1, POMTempSizeClass2, POMTempSizeClass3, POMTempSizeClass4, 
		StyleMaterialID, @DesignSketchID, TechSketchID, ConceptSketchID, ColorSketchID, @DesignSketchVersion AS Expr4, TechSketchVersion, 
		ConceptSketchVersion, ColorSketchVersion, DetailSketchID1, DetailSketchID2, DetailSketchID3, DetailSketchID4, DetailSketchVersion1, 
		DetailSketchVersion2, DetailSketchVersion3, DetailSketchVersion4, SpecSketchID1, SpecSketchID2, SpecSketchID3, SpecSketchID4, 
		SpecSketchVersion1, SpecSketchVersion2, SpecSketchVersion3, SpecSketchVersion4, CustomField1, CustomField2, CustomField3, CustomField4, 
		CustomField5, CustomField6, CustomField7, CustomField8, CustomField9, CustomField10, CustomField11, CustomField12, CustomField13, 
		CustomField14, CustomField15, 
--		Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, 
--		Sel0, Sel1, Sel2, Sel3, Sel4, Sel5, Sel6, Sel7, Sel8, Sel9, Sel10, Sel11, 
		Pc1, Pc2, Pc3, Pc4, @CreatedBy AS CUser, @CreatedDate AS CDate, @CreatedBy AS MUser, 
		@CreatedDate AS MDate, Active, 1 , Action, SampleMaker, PatternMaker, ProductionManager, TechnicalDesigner, StyleDetail, StyleDetail1,
		StyleDetail2, StyleAttribute,
		CustomField16, CustomField17, CustomField18, CustomField19, CustomField20, CustomField21, CustomField22,  CustomField23, CustomField24,  CustomField25, 
		CustomField26, CustomField27, CustomField28,  CustomField29,  CustomField30 , @StyleID  AS StyleCopyID 
	FROM  pStyleHeader WITH (NOLOCK)
	WHERE StyleID = @StyleID
END

BEGIN

	INSERT INTO pStyleAttribute
         (StyleAttributeTableId, StyleId, StyleAttributeText, StyleAttributeValue, CUser, CDate, MUser, MDate)
	SELECT StyleAttributeTableId, @NewStyleId, StyleAttributeText, StyleAttributeValue, @CreatedBy, @CreatedDate, @CreatedBy, @CreatedDate
	FROM pStyleAttribute WITH (NOLOCK)
	WHERE StyleID = @StyleID

END

BEGIN
	UPDATE pStyleImage SET StyleMasterID = @NewStyleMasterID WHERE StyleID = @StyleID
END

BEGIN

	INSERT INTO pStyleImage
	(StyleID, StyleMasterID, StyleType, MaterialID, MaterialImageID, DesignSketchID, TechSketchID, SalesSketchID, ColorSketchID, MaterialImageVersion, 
	DesignSketchVersion, TechSketchVersion, SalesSketchVersion, ColorSketchVersion, SpecSketchID1, SpecSketchID2, SpecSketchID3, SpecSketchID4, 
	SpecSketchVersion1, SpecSketchVersion2, SpecSketchVersion3, SpecSketchVersion4, DetailSketchNo, DetailSketchData, DetailSketchID1, 
	DetailSketchID2, DetailSketchID3, DetailSketchID4, DetailSketchID11, DetailSketchID12, DetailSketchID21, DetailSketchID22, DetailSketchID31, 
	DetailSketchID32, DetailSketchID41, DetailSketchID42, DetailSketchVersion1, DetailSketchVersion2, DetailSketchVersion3, DetailSketchVersion4, 
	DetailSketchVersion11, DetailSketchVersion12, DetailSketchVersion21, DetailSketchVersion22, DetailSketchVersion31, DetailSketchVersion32, 
	DetailSketchVersion41, DetailSketchVersion42)
	SELECT @NewStyleID, @StyleMasterID, StyleType, MaterialID, MaterialImageID, DesignSketchID, TechSketchID, SalesSketchID, ColorSketchID, MaterialImageVersion, 
	DesignSketchVersion, TechSketchVersion, SalesSketchVersion, ColorSketchVersion, SpecSketchID1, SpecSketchID2, SpecSketchID3, SpecSketchID4, 
	SpecSketchVersion1, SpecSketchVersion2, SpecSketchVersion3, SpecSketchVersion4, DetailSketchNo, DetailSketchData, DetailSketchID1, 
	DetailSketchID2, DetailSketchID3, DetailSketchID4, DetailSketchID11, DetailSketchID12, DetailSketchID21, DetailSketchID22, DetailSketchID31, 
	DetailSketchID32, DetailSketchID41, DetailSketchID42, DetailSketchVersion1, DetailSketchVersion2, DetailSketchVersion3, DetailSketchVersion4, 
	DetailSketchVersion11, DetailSketchVersion12, DetailSketchVersion21, DetailSketchVersion22, DetailSketchVersion31, DetailSketchVersion32, 
	DetailSketchVersion41, DetailSketchVersion42
	FROM pStyleImage WITH (NOLOCK)
	WHERE StyleID = @StyleID

END

BEGIN
CREATE TABLE #tempStyleWorkflow (
	[RecID] int IDENTITY(1,1)  NOT NULL,
	[StyleWorkflowID]  uniqueidentifier ROWGUIDCOL  NOT NULL ,
	[StyleWorkflowMasterID] [uniqueidentifier],
	[StyleID] [uniqueidentifier],
	[StyleSet] [int],
	[WorkflowID] [uniqueidentifier],
	[WorkflowType] [int],
	[WorkflowOrder] [int],
	[WorkDate] [datetime],
	[WorkStart] [datetime],
	[WorkDue] [datetime],
	[WorkAssignedTo] [int],
	[WorkComplete] [nvarchar] (50),
	[WorkStatus] [int],
	[WorkStatusDate] [datetime],
	[WorkStatusBy] [nvarchar] (50),
	[WorkVersion] [int],
	[WorkComments] [nvarchar] (4000),
	[WorkSort] [nvarchar] (2),
	[CUser] [nvarchar] (100),
	[CDate] [datetime],
	[MUser] [nvarchar] (100),
	[MDate] [datetime]
)
END

BEGIN
	INSERT INTO #tempStyleWorkflow
	(StyleWorkflowID, StyleID, StyleSet, WorkflowID, WorkflowType, WorkflowOrder, WorkDate, WorkStart, WorkDue, WorkAssignedTo, WorkComplete, 
	WorkStatus, WorkStatusDate, WorkStatusBy, WorkVersion, WorkComments, WorkSort, CUser, CDate, MUser, MDate)
	SELECT StyleWorkflowID, @NewStyleID AS StyleID, StyleSet, WorkflowID, WorkflowType, WorkflowOrder, WorkDate, WorkStart, WorkDue, WorkAssignedTo, WorkComplete, 
	WorkStatus, WorkStatusDate, WorkStatusBy, WorkVersion, WorkComments, WorkSort, @CreatedBy AS CUser, @CreatedDate AS CDate, @CreatedBy AS MUser, @CreatedDate AS MDate
	FROM  pStyleWorkflow WITH (NOLOCK)
	WHERE StyleID = @StyleID
END

BEGIN

DECLARE @Row_Count int
DECLARE @Row_Loop int
DECLARE @NewStyleWorkflowMasterID uniqueidentifier
DECLARE @StyleWorkflowMasterID uniqueidentifier
DECLARE @StyleWorkflowID uniqueidentifier


	SET @Row_Loop = 1
	SET @Row_Count = (SELECT COUNT(*) FROM #tempStyleWorkflow)

	WHILE @Row_Loop <= @Row_Count 

		BEGIN

		SELECT @StyleWorkflowMasterID = StyleWorkflowMasterID, @StyleWorkflowID = StyleWorkflowID FROM #tempStyleWorkflow WHERE RecID = @Row_Loop

			IF @StyleWorkflowMasterID IS NULL
			BEGIN
				SET @NewStyleWorkflowMasterID = newid()
				UPDATE pStyleWorkflow SET StyleWorkflowMasterID = @NewStyleWorkflowMasterID WHERE StyleWorkflowID = @StyleWorkflowID
			END	

		SET @Row_Loop = @Row_Loop + 1

		END
END



BEGIN

	INSERT INTO pStyleWorkflow
	(StyleWorkflowID, StyleID, StyleSet, WorkflowID, WorkflowType, WorkflowOrder, WorkDate, WorkStart, WorkDue, WorkAssignedTo, WorkComplete, 
	WorkStatus, WorkStatusDate, WorkStatusBy, WorkVersion, WorkComments, WorkSort, CUser, CDate, MUser, MDate, WorkDay )
	SELECT  newid() AS StyleWorkflowID, @NewStyleID AS StyleID, StyleSet, WorkflowID, WorkflowType, WorkflowOrder, WorkDate, WorkStart, WorkDue, WorkAssignedTo, 0 AS WorkComplete, 
	6 AS WorkStatus, NULL AS WorkStatusDate, NULL  AS WorkStatusBy, 0 AS WorkVersion, WorkComments, WorkSort, @CreatedBy AS CUser, @CreatedDate AS CDate, @CreatedBy AS MUser, @CreatedDate AS MDate , WorkDay 
	FROM  pStyleWorkflow WITH (NOLOCK)
	WHERE StyleID = @StyleID
END



/*******************************************************************************************************************************************************************************************************************************************************************************************************************
-- INSERT LOG RECCORD 
*******************************************************************************************************************************************************************************************************************************************************************************************************************/
DECLARE @StyleNo NVARCHAR(20)
DECLARE @CustomField2 NVARCHAR(200)
DECLARE @CustomField4 NVARCHAR(200)
DECLARE @Description NVARCHAR (4000)

SELECT @StyleNo  = StyleNo   , @CustomField2  =  CustomField2   , @CustomField4 = CustomField4  
FROM pStyleHeader WITH (NOLOCK) WHERE StyleID = @StyleID 

SET  @Description  = 'Style copied from style with StyleNo: '  +  @StyleNo   +  '  ( ' +  @CustomField2   + ' /  '  + @CustomField4  + ' ) '



INSERT INTO pStyleChange (StyleChangeID ,  StyleStatus ,  WorkflowID , StyleID , StyleSet ,  StyleChangeNotifyTo , StyleChangeType, 
StyleChangeDescription ,  StyleChangeBy, StyleChangeDate,  TechPackID , ActiveID ,  Active  ) 
VALUES  ( NEWID() ,   0 , '70000000-0000-0000-0000-000000000001' , @NewStyleID , 0 ,  '' , 'Information', @Description ,
@CreatedBy,  @CreatedDate ,  NULL , '00000000-0000-0000-0000-000000000000'  , 1 )




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_ServiceQueue_INSERT]'
GO

CREATE  PROCEDURE [dbo].[spx_ServiceQueue_INSERT]
(
@ServiceQueueSql nvarchar(4000),
@ServiceQueuePriority int,
@ServiceQueueDate datetime
)
 
AS 

IF (SELECT COUNT(*) FROM sServiceQueue WHERE ServiceQueueSql = @ServiceQueueSql) = 0 AND 
	 (SELECT COUNT(*) FROM sServiceQueueRunning WHERE ServiceQueueSql = @ServiceQueueSql) = 0

BEGIN
	INSERT INTO sServiceQueue
           (
			ServiceQueueSql
           ,ServiceQueuePriority
           ,ServiceQueueDate
			)
     VALUES
           (
			@ServiceQueueSql
           ,@ServiceQueuePriority
           ,@ServiceQueueDate
			)
END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanBusinessLogic_UPDATE]'
GO




ALTER  PROCEDURE [dbo].[spx_LinePlanBusinessLogic_UPDATE](
@LinePlanID VARCHAR(40),
@LinePlanAttributeItemID1 VARCHAR(40),
@LinePlanAttributeItemID2 VARCHAR(40),
@LinePlanAttributeItemID3 VARCHAR(40),
@LinePlanAttributeItemID4 VARCHAR(40),
@MUser NVARCHAR(200) = NULL ,
@MDate DATETIME = NULL
)
AS

DECLARE @pLinePlanID NVARCHAR(70)
DECLARE @pLinePlanAttributeItemID1 NVARCHAR(70)
DECLARE @pLinePlanAttributeItemID2 NVARCHAR(70)
DECLARE @pLinePlanAttributeItemID3 NVARCHAR(70)
DECLARE @pLinePlanAttributeItemID4 NVARCHAR(70)
DECLARE @pMUser NVARCHAR(250) 
DECLARE @pMDate NVARCHAR(100) 

IF @LinePlanID IS NULL 
	SET @pLinePlanID = ' @LinePlanID = NULL '
ELSE 
	SET @pLinePlanID = ' @LinePlanID = ''' + @LinePlanID + ''' '

IF @LinePlanAttributeItemID1 IS NULL
	SET @pLinePlanAttributeItemID1 = ' @LinePlanAttributeItemID1 = NULL '
ELSE 
	SET @pLinePlanAttributeItemID1 = ' @LinePlanAttributeItemID1 = ''' + @LinePlanAttributeItemID1 + ''' '

IF @LinePlanAttributeItemID2 IS NULL
	SET @pLinePlanAttributeItemID2 = ' @LinePlanAttributeItemID2 = NULL '
ELSE 
	SET @pLinePlanAttributeItemID2 = ' @LinePlanAttributeItemID2 = ''' + @LinePlanAttributeItemID2 + ''' '

IF @LinePlanAttributeItemID3 IS NULL
	SET @pLinePlanAttributeItemID3 = ' @LinePlanAttributeItemID3 = NULL '
ELSE 
	SET @pLinePlanAttributeItemID3 = ' @LinePlanAttributeItemID3 = ''' + @LinePlanAttributeItemID3 + ''' '

IF @LinePlanAttributeItemID4 IS NULL
	SET @pLinePlanAttributeItemID4 = ' @LinePlanAttributeItemID4 = NULL '
ELSE 
	SET @pLinePlanAttributeItemID4 = ' @LinePlanAttributeItemID4 = ''' + @LinePlanAttributeItemID4 + ''' '

IF @MUser IS NULL 
	SET @pMUser	= ' @MUSer = NULL '
ELSE 
	SET @pMUser	= ' @MUSer = ''' +  @MUser + ''' '

IF @MDate IS NULL
	SET @pMDate = ' @MDate = NULL '
ELSE 
	SET @pMDate = ' @MDate = ''' + CONVERT( NVARCHAR(40) , @MDate  , 20 )  + ''' '


DECLARE @ServiceDate DATETIME
SET @ServiceDate = getdate()

DECLARE @ServiceQueueSql1 nvarchar(4000)
SET @ServiceQueueSql1 = 'dbo.spx_LinePlanBusinessLogic_UPDATE_QUEUE ' + 
@pLinePlanID + ',' + 
@pLinePlanAttributeItemID1 + ',' + 
@pLinePlanAttributeItemID2 + ',' + 
@pLinePlanAttributeItemID3 + ',' + 
@pLinePlanAttributeItemID4 + ',' + 
@pMUser + ',' + 
@pMDate


exec spx_ServiceQueue_INSERT @ServiceQueueSql = @ServiceQueueSql1, @ServiceQueuePriority = 1, @ServiceQueueDate = @ServiceDate


/*


IF @MDate IS NULL
	SET @MDate = GETDATE()


--DECLARE @LinePlanID VARCHAR(40)
--DECLARE @LinePlanAttributeItemID1 VARCHAR(40)
--DECLARE @LinePlanAttributeItemID2 VARCHAR(40)
--DECLARE @LinePlanAttributeItemID3 VARCHAR(40)
--DECLARE @LinePlanAttributeItemID4 VARCHAR(40)
--
--SET @LinePlanId='b8c924a3-22e1-42e8-9877-4b1f62d6b3a5'
--SET @LinePlanAttributeItemID1='f23c6949-da1e-4330-b0e4-d4172344b4a7'
--SET @LinePlanAttributeItemID2='14173c43-9a05-4366-be0b-fb1a507e3f1d'
--SET @LinePlanAttributeItemID3='ff17d362-710e-4d4c-82cf-381827751899'
--SET @LinePlanAttributeItemID4=''

DECLARE @LY1_NoOfStyle INTEGER
DECLARE @LY1_NoOfFabric INTEGER
DECLARE @LY1_NoOfBody INTEGER 
DECLARE @LY1_NoOfColor INTEGER
DECLARE @LY1_NoOfOptions INTEGER
DECLARE @LY1_MarkupFactor DECIMAL(18, 3)
DECLARE @LY1_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @LY1_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @LY1_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @LY1_NoOfStyleLow DECIMAL(18, 3)
DECLARE @LY1_NoOfStyleMed DECIMAL(18, 3)
DECLARE @LY1_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @LY1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @LY1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @LY1_SalesUnit DECIMAL(18, 3)
DECLARE @LY1_ProjectedWhs DECIMAL(18, 3)
DECLARE @LY1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY1_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY1_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @LY2_NoOfStyle INTEGER
DECLARE @LY2_NoOfFabric INTEGER
DECLARE @LY2_NoOfBody INTEGER 
DECLARE @LY2_NoOfColor INTEGER
DECLARE @LY2_NoOfOptions INTEGER
DECLARE @LY2_MarkupFactor DECIMAL(18, 3)
DECLARE @LY2_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @LY2_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @LY2_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @LY2_NoOfStyleLow DECIMAL(18, 3)
DECLARE @LY2_NoOfStyleMed DECIMAL(18, 3)
DECLARE @LY2_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @LY2_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @LY2_AvgTargetFOB DECIMAL(18, 3)
DECLARE @LY2_SalesUnit DECIMAL(18, 3)
DECLARE @LY2_ProjectedWhs DECIMAL(18, 3)
DECLARE @LY2_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY2_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY2_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY2_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY2_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @LY3_NoOfStyle INTEGER
DECLARE @LY3_NoOfFabric INTEGER
DECLARE @LY3_NoOfBody INTEGER 
DECLARE @LY3_NoOfColor INTEGER
DECLARE @LY3_NoOfOptions INTEGER
DECLARE @LY3_MarkupFactor DECIMAL(18, 3)
DECLARE @LY3_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @LY3_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @LY3_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @LY3_NoOfStyleLow DECIMAL(18, 3)
DECLARE @LY3_NoOfStyleMed DECIMAL(18, 3)
DECLARE @LY3_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @LY3_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @LY3_AvgTargetFOB DECIMAL(18, 3)
DECLARE @LY3_SalesUnit DECIMAL(18, 3)
DECLARE @LY3_ProjectedWhs DECIMAL(18, 3)
DECLARE @LY3_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY3_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY3_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY3_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY3_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @LY4_NoOfStyle INTEGER
DECLARE @LY4_NoOfFabric INTEGER
DECLARE @LY4_NoOfBody INTEGER 
DECLARE @LY4_NoOfColor INTEGER
DECLARE @LY4_NoOfOptions INTEGER
DECLARE @LY4_MarkupFactor DECIMAL(18, 3)
DECLARE @LY4_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @LY4_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @LY4_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @LY4_NoOfStyleLow DECIMAL(18, 3)
DECLARE @LY4_NoOfStyleMed DECIMAL(18, 3)
DECLARE @LY4_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @LY4_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @LY4_AvgTargetFOB DECIMAL(18, 3)
DECLARE @LY4_SalesUnit DECIMAL(18, 3)
DECLARE @LY4_ProjectedWhs DECIMAL(18, 3)
DECLARE @LY4_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY4_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY4_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY4_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY4_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @PL1_NoOfStyle INTEGER
DECLARE @PL1_NoOfFabric INTEGER
DECLARE @PL1_NoOfBody INTEGER 
DECLARE @PL1_NoOfColor INTEGER
DECLARE @PL1_NoOfOptions INTEGER
DECLARE @PL1_MarkupFactor DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleLow DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleMed DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @PL1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @PL1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @PL1_SalesUnit DECIMAL(18, 3)
DECLARE @PL1_ProjectedWhs DECIMAL(18, 3)
DECLARE @PL1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL1_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL1_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @PL2_NoOfStyle INTEGER
DECLARE @PL2_NoOfFabric INTEGER
DECLARE @PL2_NoOfBody INTEGER 
DECLARE @PL2_NoOfColor INTEGER
DECLARE @PL2_NoOfOptions INTEGER
DECLARE @PL2_MarkupFactor DECIMAL(18, 3)
DECLARE @PL2_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @PL2_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @PL2_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @PL2_NoOfStyleLow DECIMAL(18, 3)
DECLARE @PL2_NoOfStyleMed DECIMAL(18, 3)
DECLARE @PL2_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @PL2_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @PL2_AvgTargetFOB DECIMAL(18, 3)
DECLARE @PL2_SalesUnit DECIMAL(18, 3)
DECLARE @PL2_ProjectedWhs DECIMAL(18, 3)
DECLARE @PL2_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL2_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL2_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL2_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL2_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @PL3_NoOfStyle INTEGER
DECLARE @PL3_NoOfFabric INTEGER
DECLARE @PL3_NoOfBody INTEGER 
DECLARE @PL3_NoOfColor INTEGER
DECLARE @PL3_NoOfOptions INTEGER
DECLARE @PL3_MarkupFactor DECIMAL(18, 3)
DECLARE @PL3_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @PL3_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @PL3_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @PL3_NoOfStyleLow DECIMAL(18, 3)
DECLARE @PL3_NoOfStyleMed DECIMAL(18, 3)
DECLARE @PL3_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @PL3_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @PL3_AvgTargetFOB DECIMAL(18, 3)
DECLARE @PL3_SalesUnit DECIMAL(18, 3)
DECLARE @PL3_ProjectedWhs DECIMAL(18, 3)
DECLARE @PL3_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL3_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL3_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL3_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL3_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @PL4_NoOfStyle INTEGER
DECLARE @PL4_NoOfFabric INTEGER
DECLARE @PL4_NoOfBody INTEGER 
DECLARE @PL4_NoOfColor INTEGER
DECLARE @PL4_NoOfOptions INTEGER
DECLARE @PL4_MarkupFactor DECIMAL(18, 3)
DECLARE @PL4_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @PL4_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @PL4_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @PL4_NoOfStyleLow DECIMAL(18, 3)
DECLARE @PL4_NoOfStyleMed DECIMAL(18, 3)
DECLARE @PL4_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @PL4_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @PL4_AvgTargetFOB DECIMAL(18, 3)
DECLARE @PL4_SalesUnit DECIMAL(18, 3)
DECLARE @PL4_ProjectedWhs DECIMAL(18, 3)
DECLARE @PL4_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL4_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL4_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL4_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL4_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @Cu1_NoOfStyle INTEGER
DECLARE @Cu1_NoOfFabric INTEGER
DECLARE @Cu1_NoOfBody INTEGER 
DECLARE @Cu1_NoOfColor INTEGER
DECLARE @Cu1_NoOfOptions INTEGER
DECLARE @Cu1_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @Cu1_NoOfStyleLow DECIMAL(18, 3)
DECLARE @Cu1_NoOfStyleMed DECIMAL(18, 3)
DECLARE @Cu1_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Cu1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Cu1_SalesUnit DECIMAL(18, 3)
DECLARE @Cu1_ProjectedWhs DECIMAL(18, 3)
DECLARE @Cu1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu1_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu1_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @Cu2_NoOfStyle INTEGER
DECLARE @Cu2_NoOfFabric INTEGER
DECLARE @Cu2_NoOfBody INTEGER 
DECLARE @Cu2_NoOfColor INTEGER
DECLARE @Cu2_NoOfOptions INTEGER
DECLARE @Cu2_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu2_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @Cu2_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @Cu2_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @Cu2_NoOfStyleLow DECIMAL(18, 3)
DECLARE @Cu2_NoOfStyleMed DECIMAL(18, 3)
DECLARE @Cu2_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @Cu2_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Cu2_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Cu2_SalesUnit DECIMAL(18, 3)
DECLARE @Cu2_ProjectedWhs DECIMAL(18, 3)
DECLARE @Cu2_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu2_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu2_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu2_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu2_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @Cu3_NoOfStyle INTEGER
DECLARE @Cu3_NoOfFabric INTEGER
DECLARE @Cu3_NoOfBody INTEGER 
DECLARE @Cu3_NoOfColor INTEGER
DECLARE @Cu3_NoOfOptions INTEGER
DECLARE @Cu3_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu3_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @Cu3_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @Cu3_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @Cu3_NoOfStyleLow DECIMAL(18, 3)
DECLARE @Cu3_NoOfStyleMed DECIMAL(18, 3)
DECLARE @Cu3_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @Cu3_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Cu3_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Cu3_SalesUnit DECIMAL(18, 3)
DECLARE @Cu3_ProjectedWhs DECIMAL(18, 3)
DECLARE @Cu3_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu3_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu3_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu3_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu3_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @Cu4_NoOfStyle INTEGER
DECLARE @Cu4_NoOfFabric INTEGER
DECLARE @Cu4_NoOfBody INTEGER 
DECLARE @Cu4_NoOfColor INTEGER
DECLARE @Cu4_NoOfOptions INTEGER
DECLARE @Cu4_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu4_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @Cu4_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @Cu4_TargetAvgRetailPriceHigh DECIMAL(18, 3)
DECLARE @Cu4_NoOfStyleLow DECIMAL(18, 3)
DECLARE @Cu4_NoOfStyleMed DECIMAL(18, 3)
DECLARE @Cu4_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @Cu4_TargetAvgWhsPrice DECIMAL(18, 3)
DECLARE @Cu4_AvgTargetFOB DECIMAL(18, 3)
DECLARE @Cu4_SalesUnit DECIMAL(18, 3)
DECLARE @Cu4_ProjectedWhs DECIMAL(18, 3)
DECLARE @Cu4_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu4_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu4_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu4_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu4_WeightedAverageRetailPrice DECIMAL(18, 3)

--10000000-0000-0000-0000-000000000005	NULL	decimal	0	fontRed	No of Options	NULL	Range	0005	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
--00000000-0000-0000-0000-000000000005	NULL	percent	0	fontRed	Mark up Factor	NULL	NULL	0015	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
--00000000-0000-0000-0000-000000000020	NULL	decimal	0	font	Target Avg Retail Price (Low)	NULL	NULL	0016	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
--00000000-0000-0000-0000-000000000021	NULL	decimal	0	font	Number of Styles (Low)	NULL	NULL	0017	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
--00000000-0000-0000-0000-000000000022	NULL	decimal	0	font	Target Avg Retail Price (Med)	NULL	NULL	0018	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
--00000000-0000-0000-0000-000000000023	NULL	decimal	0	font	Number of Styles (Med)	NULL	NULL	0019	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
--00000000-0000-0000-0000-000000000024	NULL	decimal	0	font	Target Avg Retail Price (High)	NULL	NULL	0020	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
--00000000-0000-0000-0000-000000000025	NULL	decimal	0	font	Number of Styles (High)	NULL	NULL	0021	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
--00000000-0000-0000-0000-000000000009	NULL	decimal	0	font	Target Avg Whs Price 	NULL	NULL	0022	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
--00000000-0000-0000-0000-000000000006	NULL	decimal	0	font	Average Target FOB 	NULL	NULL	0023	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
--00000000-0000-0000-0000-000000000008	NULL	decimal	0	font	Sales Units	NULL	NULL	0024	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
--00000000-0000-0000-0000-000000000007	NULL	decimal	0	font	Projected Wholesale 	NULL	NULL	0025	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
--00000000-0000-0000-0000-000000000010	NULL	percent	0	font	Initial Gross Margin Retail %	NULL	NULL	0026	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
--00000000-0000-0000-0000-000000000013	NULL	percent	0	font	Initial Gross Margin WHS %	NULL	NULL	0027	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
--00000000-0000-0000-0000-000000000011	NULL	percent	0	font	Weighted Gross Margin WHS %	NULL	NULL	0028	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
--00000000-0000-0000-0000-000000000012	NULL	percent	0	font	Weighted Gross Margin Retail %	NULL	NULL	0032	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
--NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL


SELECT TOP 1 
	@LY1_NoOfStyle = LinePlanBusLYCh1, 
	@LY2_NoOfStyle = LinePlanBusLYCh2,
	@LY3_NoOfStyle = LinePlanBusLYCh3, 
	@LY4_NoOfStyle = LinePlanBusLYCh4, 
	@PL1_NoOfStyle = LinePlanBusPnCh1, 
	@PL2_NoOfStyle = LinePlanBusPnCh2, 
	@PL3_NoOfStyle = LinePlanBusPnCh3, 
	@PL4_NoOfStyle = LinePlanBusPnCh4, 
	@Cu1_NoOfStyle = LinePlanBusCuCh1, 
	@Cu2_NoOfStyle = LinePlanBusCuCh2, 
	@Cu3_NoOfStyle = LinePlanBusCuCh3, 
	@Cu4_NoOfStyle = LinePlanBusCuCh4 
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID) 
	AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'

SELECT TOP 1 
	@LY1_NoOfFabric = LinePlanBusLYCh1, 
	@LY2_NoOfFabric = LinePlanBusLYCh2,
	@LY3_NoOfFabric = LinePlanBusLYCh3, 
	@LY4_NoOfFabric = LinePlanBusLYCh4, 
	@PL1_NoOfFabric = LinePlanBusPnCh1, 
	@PL2_NoOfFabric = LinePlanBusPnCh2, 
	@PL3_NoOfFabric = LinePlanBusPnCh3, 
	@PL4_NoOfFabric = LinePlanBusPnCh4, 
	@Cu1_NoOfFabric = LinePlanBusCuCh1, 
	@Cu2_NoOfFabric = LinePlanBusCuCh2, 
	@Cu3_NoOfFabric = LinePlanBusCuCh3, 
	@Cu4_NoOfFabric = LinePlanBusCuCh4 
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000001'

SELECT TOP 1 
	@LY1_NoOfBody = LinePlanBusLYCh1, 
	@LY2_NoOfBody = LinePlanBusLYCh2,
	@LY3_NoOfBody = LinePlanBusLYCh3, 
	@LY4_NoOfBody = LinePlanBusLYCh4, 
	@PL1_NoOfBody = LinePlanBusPnCh1, 
	@PL2_NoOfBody = LinePlanBusPnCh2, 
	@PL3_NoOfBody = LinePlanBusPnCh3, 
	@PL4_NoOfBody = LinePlanBusPnCh4, 
	@Cu1_NoOfBody = LinePlanBusCuCh1, 
	@Cu2_NoOfBody = LinePlanBusCuCh2, 
	@Cu3_NoOfBody = LinePlanBusCuCh3, 
	@Cu4_NoOfBody = LinePlanBusCuCh4 
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000003'

SELECT TOP 1 
	@LY1_NoOfColor = LinePlanBusLYCh1, 
	@LY2_NoOfColor = LinePlanBusLYCh2,
	@LY3_NoOfColor = LinePlanBusLYCh3, 
	@LY4_NoOfColor = LinePlanBusLYCh4, 
	@PL1_NoOfColor = LinePlanBusPnCh1, 
	@PL2_NoOfColor = LinePlanBusPnCh2, 
	@PL3_NoOfColor = LinePlanBusPnCh3, 
	@PL4_NoOfColor = LinePlanBusPnCh4, 
	@Cu1_NoOfColor = LinePlanBusCuCh1, 
	@Cu2_NoOfColor = LinePlanBusCuCh2, 
	@Cu3_NoOfColor = LinePlanBusCuCh3, 
	@Cu4_NoOfColor = LinePlanBusCuCh4 
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000002'

-- ============================================================================

SELECT TOP 1 
	@LY1_TargetAvgRetailPriceLow = LinePlanBusLYCh1, 
	@LY2_TargetAvgRetailPriceLow = LinePlanBusLYCh2,
	@LY3_TargetAvgRetailPriceLow = LinePlanBusLYCh3, 
	@LY4_TargetAvgRetailPriceLow = LinePlanBusLYCh4, 
	@PL1_TargetAvgRetailPriceLow = LinePlanBusPnCh1, 
	@PL2_TargetAvgRetailPriceLow = LinePlanBusPnCh2, 
	@PL3_TargetAvgRetailPriceLow = LinePlanBusPnCh3, 
	@PL4_TargetAvgRetailPriceLow = LinePlanBusPnCh4, 
	@Cu1_TargetAvgRetailPriceLow = LinePlanBusCuCh1, 
	@Cu2_TargetAvgRetailPriceLow = LinePlanBusCuCh2, 
	@Cu3_TargetAvgRetailPriceLow = LinePlanBusCuCh3, 
	@Cu4_TargetAvgRetailPriceLow = LinePlanBusCuCh4 
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000020'


SELECT TOP 1 
	@LY1_NoOfStyleLow = LinePlanBusLYCh1, 
	@LY2_NoOfStyleLow = LinePlanBusLYCh2,
	@LY3_NoOfStyleLow = LinePlanBusLYCh3, 
	@LY4_NoOfStyleLow = LinePlanBusLYCh4, 
	@PL1_NoOfStyleLow = LinePlanBusPnCh1, 
	@PL2_NoOfStyleLow = LinePlanBusPnCh2, 
	@PL3_NoOfStyleLow = LinePlanBusPnCh3, 
	@PL4_NoOfStyleLow = LinePlanBusPnCh4, 
	@Cu1_NoOfStyleLow = LinePlanBusCuCh1, 
	@Cu2_NoOfStyleLow = LinePlanBusCuCh2, 
	@Cu3_NoOfStyleLow = LinePlanBusCuCh3, 
	@Cu4_NoOfStyleLow = LinePlanBusCuCh4 
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000021'


-- Medium

SELECT TOP 1 
	@LY1_TargetAvgRetailPriceMed = LinePlanBusLYCh1, 
	@LY2_TargetAvgRetailPriceMed = LinePlanBusLYCh2,
	@LY3_TargetAvgRetailPriceMed = LinePlanBusLYCh3, 
	@LY4_TargetAvgRetailPriceMed = LinePlanBusLYCh4, 
	@PL1_TargetAvgRetailPriceMed = LinePlanBusPnCh1, 
	@PL2_TargetAvgRetailPriceMed = LinePlanBusPnCh2, 
	@PL3_TargetAvgRetailPriceMed = LinePlanBusPnCh3, 
	@PL4_TargetAvgRetailPriceMed = LinePlanBusPnCh4, 
	@Cu1_TargetAvgRetailPriceMed = LinePlanBusCuCh1, 
	@Cu2_TargetAvgRetailPriceMed = LinePlanBusCuCh2, 
	@Cu3_TargetAvgRetailPriceMed = LinePlanBusCuCh3, 
	@Cu4_TargetAvgRetailPriceMed = LinePlanBusCuCh4 
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000022'


SELECT TOP 1 
	@LY1_NoOfStyleMed = LinePlanBusLYCh1, 
	@LY2_NoOfStyleMed = LinePlanBusLYCh2,
	@LY3_NoOfStyleMed = LinePlanBusLYCh3, 
	@LY4_NoOfStyleMed = LinePlanBusLYCh4, 
	@PL1_NoOfStyleMed = LinePlanBusPnCh1, 
	@PL2_NoOfStyleMed = LinePlanBusPnCh2, 
	@PL3_NoOfStyleMed = LinePlanBusPnCh3, 
	@PL4_NoOfStyleMed = LinePlanBusPnCh4, 
	@Cu1_NoOfStyleMed = LinePlanBusCuCh1, 
	@Cu2_NoOfStyleMed = LinePlanBusCuCh2, 
	@Cu3_NoOfStyleMed = LinePlanBusCuCh3, 
	@Cu4_NoOfStyleMed = LinePlanBusCuCh4 
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000023'



-- High

SELECT TOP 1 
	@LY1_TargetAvgRetailPriceHigh = LinePlanBusLYCh1, 
	@LY2_TargetAvgRetailPriceHigh = LinePlanBusLYCh2,
	@LY3_TargetAvgRetailPriceHigh = LinePlanBusLYCh3, 
	@LY4_TargetAvgRetailPriceHigh = LinePlanBusLYCh4, 
	@PL1_TargetAvgRetailPriceHigh = LinePlanBusPnCh1, 
	@PL2_TargetAvgRetailPriceHigh = LinePlanBusPnCh2, 
	@PL3_TargetAvgRetailPriceHigh = LinePlanBusPnCh3, 
	@PL4_TargetAvgRetailPriceHigh = LinePlanBusPnCh4, 
	@Cu1_TargetAvgRetailPriceHigh = LinePlanBusCuCh1, 
	@Cu2_TargetAvgRetailPriceHigh = LinePlanBusCuCh2, 
	@Cu3_TargetAvgRetailPriceHigh = LinePlanBusCuCh3, 
	@Cu4_TargetAvgRetailPriceHigh = LinePlanBusCuCh4 
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000024'


SELECT TOP 1 
	@LY1_NoOfStyleHigh = LinePlanBusLYCh1, 
	@LY2_NoOfStyleHigh = LinePlanBusLYCh2,
	@LY3_NoOfStyleHigh = LinePlanBusLYCh3, 
	@LY4_NoOfStyleHigh = LinePlanBusLYCh4, 
	@PL1_NoOfStyleHigh = LinePlanBusPnCh1, 
	@PL2_NoOfStyleHigh = LinePlanBusPnCh2, 
	@PL3_NoOfStyleHigh = LinePlanBusPnCh3, 
	@PL4_NoOfStyleHigh = LinePlanBusPnCh4, 
	@Cu1_NoOfStyleHigh = LinePlanBusCuCh1, 
	@Cu2_NoOfStyleHigh = LinePlanBusCuCh2, 
	@Cu3_NoOfStyleHigh = LinePlanBusCuCh3, 
	@Cu4_NoOfStyleHigh = LinePlanBusCuCh4 
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000025'


SELECT TOP 1 
	@LY1_InitialGrossMarginWhs = LinePlanBusLYCh1, 
	@LY2_InitialGrossMarginWhs = LinePlanBusLYCh2,
	@LY3_InitialGrossMarginWhs = LinePlanBusLYCh3, 
	@LY4_InitialGrossMarginWhs = LinePlanBusLYCh4, 
	@PL1_InitialGrossMarginWhs = LinePlanBusPnCh1, 
	@PL2_InitialGrossMarginWhs = LinePlanBusPnCh2, 
	@PL3_InitialGrossMarginWhs = LinePlanBusPnCh3, 
	@PL4_InitialGrossMarginWhs = LinePlanBusPnCh4, 
	@Cu1_InitialGrossMarginWhs = LinePlanBusCuCh1, 
	@Cu2_InitialGrossMarginWhs = LinePlanBusCuCh2, 
	@Cu3_InitialGrossMarginWhs = LinePlanBusCuCh3, 
	@Cu4_InitialGrossMarginWhs = LinePlanBusCuCh4 
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000013'


-- ============================================================================

SELECT TOP 1 
	@LY1_MarkupFactor = LinePlanBusLYCh1, 
	@LY2_MarkupFactor = LinePlanBusLYCh2,
	@LY3_MarkupFactor = LinePlanBusLYCh3, 
	@LY4_MarkupFactor = LinePlanBusLYCh4, 
	@PL1_MarkupFactor = LinePlanBusPnCh1, 
	@PL2_MarkupFactor = LinePlanBusPnCh2, 
	@PL3_MarkupFactor = LinePlanBusPnCh3, 
	@PL4_MarkupFactor = LinePlanBusPnCh4, 
	@Cu1_MarkupFactor = LinePlanBusCuCh1, 
	@Cu2_MarkupFactor = LinePlanBusCuCh2, 
	@Cu3_MarkupFactor = LinePlanBusCuCh3, 
	@Cu4_MarkupFactor = LinePlanBusCuCh4 
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000005'

/*
SELECT TOP 1 
	@LY1_InitialGrossMarginRtl = LinePlanBusLYCh1, 
	@LY2_InitialGrossMarginRtl = LinePlanBusLYCh2,
	@LY3_InitialGrossMarginRtl = LinePlanBusLYCh3, 
	@LY4_InitialGrossMarginRtl = LinePlanBusLYCh4, 
	@PL1_InitialGrossMarginRtl = LinePlanBusPnCh1, 
	@PL2_InitialGrossMarginRtl = LinePlanBusPnCh2, 
	@PL3_InitialGrossMarginRtl = LinePlanBusPnCh3, 
	@PL4_InitialGrossMarginRtl = LinePlanBusPnCh4, 
	@Cu1_InitialGrossMarginRtl = LinePlanBusCuCh1, 
	@Cu2_InitialGrossMarginRtl = LinePlanBusCuCh2, 
	@Cu3_InitialGrossMarginRtl = LinePlanBusCuCh3, 
	@Cu4_InitialGrossMarginRtl = LinePlanBusCuCh4 
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000010'
*/

SELECT TOP 1 
	@LY1_SalesUnit = LinePlanBusLYCh1, 
	@LY2_SalesUnit = LinePlanBusLYCh2,
	@LY3_SalesUnit = LinePlanBusLYCh3, 
	@LY4_SalesUnit = LinePlanBusLYCh4, 
	@PL1_SalesUnit = LinePlanBusPnCh1, 
	@PL2_SalesUnit = LinePlanBusPnCh2, 
	@PL3_SalesUnit = LinePlanBusPnCh3, 
	@PL4_SalesUnit = LinePlanBusPnCh4, 
	@Cu1_SalesUnit = LinePlanBusCuCh1, 
	@Cu2_SalesUnit = LinePlanBusCuCh2, 
	@Cu3_SalesUnit = LinePlanBusCuCh3, 
	@Cu4_SalesUnit = LinePlanBusCuCh4 
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000008'


/*
--No of options is an INPUT value now

--Calculate number of options
UPDATE pLinePlanBusiness SET
	LinePlanBusLYCh1 = (@LY1_NoOfStyle * @LY1_NoOfFabric * @LY1_NoOfColor) , 
	LinePlanBusLYCh2 = (@LY2_NoOfStyle * @LY2_NoOfFabric * @LY2_NoOfColor) ,
	LinePlanBusLYCh3 = (@LY3_NoOfStyle * @LY3_NoOfFabric * @LY3_NoOfColor) , 
	LinePlanBusLYCh4 = (@LY4_NoOfStyle * @LY4_NoOfFabric * @LY4_NoOfColor) , 
	LinePlanBusPnCh1 = (@PL1_NoOfStyle * @PL1_NoOfFabric * @PL1_NoOfColor) , 
	LinePlanBusPnCh2 = (@PL2_NoOfStyle * @PL2_NoOfFabric * @PL2_NoOfColor) , 
	LinePlanBusPnCh3 = (@PL3_NoOfStyle * @PL3_NoOfFabric * @PL3_NoOfColor) , 
	LinePlanBusPnCh4 = (@PL4_NoOfStyle * @PL4_NoOfFabric * @PL4_NoOfColor) , 
	LinePlanBusCuCh1 = (@Cu1_NoOfStyle * @Cu1_NoOfFabric * @Cu1_NoOfColor) , 
	LinePlanBusCuCh2 = (@Cu2_NoOfStyle * @Cu2_NoOfFabric * @Cu2_NoOfColor) , 
	LinePlanBusCuCh3 = (@Cu3_NoOfStyle * @Cu3_NoOfFabric * @Cu3_NoOfColor) , 
	LinePlanBusCuCh4 = (@Cu4_NoOfStyle * @Cu4_NoOfFabric * @Cu4_NoOfColor) 	
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000005'
*/


UPDATE pLinePlanBusiness SET
	LinePlanBusCuCh1 = LinePlanBusPnCh1, 
	LinePlanBusCuCh2 = LinePlanBusPnCh2, 
	LinePlanBusCuCh3 = LinePlanBusPnCh3, 
	LinePlanBusCuCh4 = LinePlanBusPnCh4 	
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000005'

UPDATE pLinePlanBusiness SET
	LinePlanBusCuCh1 = LinePlanBusPnCh1, 
	LinePlanBusCuCh2 = LinePlanBusPnCh2, 
	LinePlanBusCuCh3 = LinePlanBusPnCh3, 
	LinePlanBusCuCh4 = LinePlanBusPnCh4 	
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000020'

UPDATE pLinePlanBusiness SET
	LinePlanBusCuCh1 = LinePlanBusPnCh1, 
	LinePlanBusCuCh2 = LinePlanBusPnCh2, 
	LinePlanBusCuCh3 = LinePlanBusPnCh3, 
	LinePlanBusCuCh4 = LinePlanBusPnCh4 	
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000022'

UPDATE pLinePlanBusiness SET
	LinePlanBusCuCh1 = LinePlanBusPnCh1, 
	LinePlanBusCuCh2 = LinePlanBusPnCh2, 
	LinePlanBusCuCh3 = LinePlanBusPnCh3, 
	LinePlanBusCuCh4 = LinePlanBusPnCh4 	
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000024'



--Calculate Target Avg Whs price
SET @LY1_TargetAvgWhsPrice = CASE WHEN @LY1_MarkupFactor = 0 THEN 0 ELSE @LY1_TargetAvgRetailPriceMed / @LY1_MarkupFactor END  
SET @LY2_TargetAvgWhsPrice = CASE WHEN @LY2_MarkupFactor = 0 THEN 0 ELSE @LY2_TargetAvgRetailPriceMed / @LY2_MarkupFactor END 
SET @LY3_TargetAvgWhsPrice = CASE WHEN @LY3_MarkupFactor = 0 THEN 0 ELSE @LY3_TargetAvgRetailPriceMed / @LY3_MarkupFactor END
SET @LY4_TargetAvgWhsPrice = CASE WHEN @LY4_MarkupFactor = 0 THEN 0 ELSE @LY4_TargetAvgRetailPriceMed / @LY4_MarkupFactor END 
SET @PL1_TargetAvgWhsPrice = CASE WHEN @PL1_MarkupFactor = 0 THEN 0 ELSE @PL1_TargetAvgRetailPriceMed / @PL1_MarkupFactor END
SET @PL2_TargetAvgWhsPrice = CASE WHEN @PL2_MarkupFactor = 0 THEN 0 ELSE @PL2_TargetAvgRetailPriceMed / @PL2_MarkupFactor END
SET @PL3_TargetAvgWhsPrice = CASE WHEN @PL3_MarkupFactor = 0 THEN 0 ELSE @PL3_TargetAvgRetailPriceMed / @PL3_MarkupFactor END
SET @PL4_TargetAvgWhsPrice = CASE WHEN @PL4_MarkupFactor = 0 THEN 0 ELSE @PL4_TargetAvgRetailPriceMed / @PL4_MarkupFactor END
SET @Cu1_TargetAvgWhsPrice = CASE WHEN @Cu1_SalesUnit = 0 THEN 0 ELSE @Cu1_TargetAvgRetailPriceMed / @Cu1_MarkupFactor END
SET @Cu2_TargetAvgWhsPrice = CASE WHEN @Cu2_SalesUnit = 0 THEN 0 ELSE @Cu2_TargetAvgRetailPriceMed / @Cu2_MarkupFactor END
SET @Cu3_TargetAvgWhsPrice = CASE WHEN @Cu3_SalesUnit = 0 THEN 0 ELSE @Cu3_TargetAvgRetailPriceMed / @Cu3_MarkupFactor END
SET @Cu4_TargetAvgWhsPrice = CASE WHEN @Cu4_SalesUnit = 0 THEN 0 ELSE @Cu4_TargetAvgRetailPriceMed / @Cu4_MarkupFactor END 

UPDATE pLinePlanBusiness SET
	LinePlanBusLYCh1 = @LY1_TargetAvgWhsPrice, 
	LinePlanBusLYCh2 = @LY2_TargetAvgWhsPrice,
	LinePlanBusLYCh3 = @LY3_TargetAvgWhsPrice, 
	LinePlanBusLYCh4 = @LY4_TargetAvgWhsPrice, 
	LinePlanBusPnCh1 = @PL1_TargetAvgWhsPrice, 
	LinePlanBusPnCh2 = @PL2_TargetAvgWhsPrice, 
	LinePlanBusPnCh3 = @PL3_TargetAvgWhsPrice, 
	LinePlanBusPnCh4 = @PL4_TargetAvgWhsPrice, 
	LinePlanBusCuCh1 = @Cu1_TargetAvgWhsPrice, 
	LinePlanBusCuCh2 = @Cu2_TargetAvgWhsPrice, 
	LinePlanBusCuCh3 = @Cu3_TargetAvgWhsPrice, 
	LinePlanBusCuCh4 = @Cu4_TargetAvgWhsPrice 	
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000009'

--Calculate Average Target FOB

SET @LY1_AvgTargetFOB = @LY1_TargetAvgWhsPrice - (@LY1_TargetAvgWhsPrice * @LY1_InitialGrossMarginWhs)
SET @LY2_AvgTargetFOB = @LY2_TargetAvgWhsPrice - (@LY2_TargetAvgWhsPrice * @LY2_InitialGrossMarginWhs)
SET @LY3_AvgTargetFOB = @LY3_TargetAvgWhsPrice - (@LY3_TargetAvgWhsPrice * @LY3_InitialGrossMarginWhs)
SET @LY4_AvgTargetFOB = @LY4_TargetAvgWhsPrice - (@LY4_TargetAvgWhsPrice * @LY4_InitialGrossMarginWhs)

SET @PL1_AvgTargetFOB = @PL1_TargetAvgWhsPrice - (@PL1_TargetAvgWhsPrice * @PL1_InitialGrossMarginWhs)
SET @PL2_AvgTargetFOB = @PL2_TargetAvgWhsPrice - (@PL2_TargetAvgWhsPrice * @PL2_InitialGrossMarginWhs)
SET @PL3_AvgTargetFOB = @PL3_TargetAvgWhsPrice - (@PL3_TargetAvgWhsPrice * @PL3_InitialGrossMarginWhs)
SET @PL4_AvgTargetFOB = @PL4_TargetAvgWhsPrice - (@PL4_TargetAvgWhsPrice * @PL4_InitialGrossMarginWhs)

SET @Cu1_AvgTargetFOB = @Cu1_TargetAvgWhsPrice - (@Cu1_TargetAvgWhsPrice * @Cu1_InitialGrossMarginWhs)
SET @Cu2_AvgTargetFOB = @Cu2_TargetAvgWhsPrice - (@Cu2_TargetAvgWhsPrice * @Cu2_InitialGrossMarginWhs)
SET @Cu3_AvgTargetFOB = @Cu3_TargetAvgWhsPrice - (@Cu3_TargetAvgWhsPrice * @Cu3_InitialGrossMarginWhs)
SET @Cu4_AvgTargetFOB = @Cu4_TargetAvgWhsPrice - (@Cu4_TargetAvgWhsPrice * @Cu4_InitialGrossMarginWhs)


UPDATE pLinePlanBusiness SET
LinePlanBusLYCh1 = @LY1_AvgTargetFOB, LinePlanBusLYCh2 = @LY2_AvgTargetFOB,
LinePlanBusLYCh3 = @LY3_AvgTargetFOB, LinePlanBusLYCh4 = @LY4_AvgTargetFOB, 
LinePlanBusPnCh1 = @PL1_AvgTargetFOB, LinePlanBusPnCh2 = @PL2_AvgTargetFOB, 
LinePlanBusPnCh3 = @PL3_AvgTargetFOB, LinePlanBusPnCh4 = @PL4_AvgTargetFOB, 
LinePlanBusCuCh1 = @Cu1_AvgTargetFOB, LinePlanBusCuCh2 = @Cu2_AvgTargetFOB, 
LinePlanBusCuCh3 = @Cu3_AvgTargetFOB, LinePlanBusCuCh4 = @Cu4_AvgTargetFOB 	
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000006'


--Calculate Projected Wholesale
SET @LY1_ProjectedWhs = (@LY1_SalesUnit * @LY1_TargetAvgWhsPrice)  
SET @LY2_ProjectedWhs = (@LY2_SalesUnit * @LY2_TargetAvgWhsPrice) 
SET @LY3_ProjectedWhs = (@LY3_SalesUnit * @LY3_TargetAvgWhsPrice) 
SET @LY4_ProjectedWhs = (@LY4_SalesUnit * @LY4_TargetAvgWhsPrice) 
SET @PL1_ProjectedWhs = (@PL1_SalesUnit * @PL1_TargetAvgWhsPrice) 
SET @PL2_ProjectedWhs = (@PL2_SalesUnit * @PL2_TargetAvgWhsPrice) 
SET @PL3_ProjectedWhs = (@PL3_SalesUnit * @PL3_TargetAvgWhsPrice) 
SET @PL4_ProjectedWhs = (@PL4_SalesUnit * @PL4_TargetAvgWhsPrice) 
SET @Cu1_ProjectedWhs = (@Cu1_SalesUnit * @Cu1_TargetAvgWhsPrice) 
SET @Cu2_ProjectedWhs = (@Cu2_SalesUnit * @Cu2_TargetAvgWhsPrice) 
SET @Cu3_ProjectedWhs = (@Cu3_SalesUnit * @Cu3_TargetAvgWhsPrice) 
SET @Cu4_ProjectedWhs = (@Cu4_SalesUnit * @Cu4_TargetAvgWhsPrice) 	

UPDATE pLinePlanBusiness SET
	LinePlanBusLYCh1 = @LY1_ProjectedWhs, 
	LinePlanBusLYCh2 = @LY2_ProjectedWhs,
	LinePlanBusLYCh3 = @LY3_ProjectedWhs, 
	LinePlanBusLYCh4 = @LY4_ProjectedWhs, 
	LinePlanBusPnCh1 = @PL1_ProjectedWhs, 
	LinePlanBusPnCh2 = @PL2_ProjectedWhs, 
	LinePlanBusPnCh3 = @PL3_ProjectedWhs, 
	LinePlanBusPnCh4 = @PL4_ProjectedWhs, 
	LinePlanBusCuCh1 = @Cu1_ProjectedWhs, 
	LinePlanBusCuCh2 = @Cu2_ProjectedWhs, 
	LinePlanBusCuCh3 = @Cu3_ProjectedWhs, 
	LinePlanBusCuCh4 = @Cu4_ProjectedWhs	
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000007'

--Calculate Initial Gross Margin Wholesale %
--UPDATE pLinePlanBusiness SET
--	LinePlanBusLYCh1 = CASE WHEN @LY1_TargetAvgWhsPrice = 0 THEN 0 ELSE (@LY1_TargetAvgWhsPrice - @LY1_AvgTargetFOB) / @LY1_TargetAvgWhsPrice END, 
--	LinePlanBusLYCh2 = CASE WHEN @LY2_TargetAvgWhsPrice = 0 THEN 0 ELSE (@LY2_TargetAvgWhsPrice - @LY2_AvgTargetFOB) / @LY2_TargetAvgWhsPrice END, 
--	LinePlanBusLYCh3 = CASE WHEN @LY3_TargetAvgWhsPrice = 0 THEN 0 ELSE (@LY3_TargetAvgWhsPrice - @LY3_AvgTargetFOB) / @LY3_TargetAvgWhsPrice END, 
--	LinePlanBusLYCh4 = CASE WHEN @LY4_TargetAvgWhsPrice = 0 THEN 0 ELSE (@LY4_TargetAvgWhsPrice - @LY4_AvgTargetFOB) / @LY4_TargetAvgWhsPrice END, 
--	LinePlanBusPnCh1 = CASE WHEN @PL1_TargetAvgWhsPrice = 0 THEN 0 ELSE (@PL1_TargetAvgWhsPrice - @PL1_AvgTargetFOB) / @PL1_TargetAvgWhsPrice END, 
--	LinePlanBusPnCh2 = CASE WHEN @PL2_TargetAvgWhsPrice = 0 THEN 0 ELSE (@PL2_TargetAvgWhsPrice - @PL2_AvgTargetFOB) / @PL2_TargetAvgWhsPrice END, 
--	LinePlanBusPnCh3 = CASE WHEN @PL3_TargetAvgWhsPrice = 0 THEN 0 ELSE (@PL3_TargetAvgWhsPrice - @PL3_AvgTargetFOB) / @PL3_TargetAvgWhsPrice END,  
--	LinePlanBusPnCh4 = CASE WHEN @PL4_TargetAvgWhsPrice = 0 THEN 0 ELSE (@PL4_TargetAvgWhsPrice - @PL4_AvgTargetFOB) / @PL4_TargetAvgWhsPrice END, 
--	LinePlanBusCuCh1 = CASE WHEN @Cu1_SalesUnit = 0 THEN 0 ELSE (@Cu1_TargetAvgWhsPrice - @Cu1_AvgTargetFOB) / @Cu1_TargetAvgWhsPrice END, 
--	LinePlanBusCuCh2 = CASE WHEN @Cu2_SalesUnit = 0 THEN 0 ELSE (@Cu2_TargetAvgWhsPrice - @Cu2_AvgTargetFOB) / @Cu2_TargetAvgWhsPrice END,  
--	LinePlanBusCuCh3 = CASE WHEN @Cu3_SalesUnit = 0 THEN 0 ELSE (@Cu3_TargetAvgWhsPrice - @Cu3_AvgTargetFOB) / @Cu3_TargetAvgWhsPrice END, 
--	LinePlanBusCuCh4 = CASE WHEN @Cu4_SalesUnit = 0 THEN 0 ELSE (@Cu4_TargetAvgWhsPrice - @Cu4_AvgTargetFOB) / @Cu4_TargetAvgWhsPrice END 
--WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
--	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
--	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
--	AND (LinePlanID = @LinePlanID)
--AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000013'


--Calculate Weighted Gross Margin Retail %
UPDATE pLinePlanBusiness SET
	LinePlanBusLYCh1 = CASE WHEN @LY1_TargetAvgRetailPriceMed = 0 THEN 0 ELSE ((@LY1_SalesUnit * @LY1_TargetAvgRetailPriceMed) - (@LY1_AvgTargetFOB * @LY1_SalesUnit)) / (@LY1_SalesUnit * @LY1_TargetAvgRetailPriceMed) END, 
	LinePlanBusLYCh2 = CASE WHEN @LY2_TargetAvgRetailPriceMed = 0 THEN 0 ELSE ((@LY2_SalesUnit * @LY2_TargetAvgRetailPriceMed) - (@LY2_AvgTargetFOB * @LY2_SalesUnit)) / (@LY2_SalesUnit * @LY2_TargetAvgRetailPriceMed) END, 
	LinePlanBusLYCh3 = CASE WHEN @LY3_TargetAvgRetailPriceMed = 0 THEN 0 ELSE ((@LY3_SalesUnit * @LY3_TargetAvgRetailPriceMed) - (@LY3_AvgTargetFOB * @LY3_SalesUnit)) / (@LY3_SalesUnit * @LY3_TargetAvgRetailPriceMed) END, 
	LinePlanBusLYCh4 = CASE WHEN @LY4_TargetAvgRetailPriceMed = 0 THEN 0 ELSE ((@LY4_SalesUnit * @LY4_TargetAvgRetailPriceMed) - (@LY4_AvgTargetFOB * @LY4_SalesUnit)) / (@LY4_SalesUnit * @LY4_TargetAvgRetailPriceMed) END, 
	LinePlanBusPnCh1 = CASE WHEN @PL1_TargetAvgRetailPriceMed = 0 THEN 0 ELSE ((@PL1_SalesUnit * @PL1_TargetAvgRetailPriceMed) - (@PL1_AvgTargetFOB * @PL1_SalesUnit)) / (@PL1_SalesUnit * @PL1_TargetAvgRetailPriceMed) END, 
	LinePlanBusPnCh2 = CASE WHEN @PL2_TargetAvgRetailPriceMed = 0 THEN 0 ELSE ((@PL2_SalesUnit * @PL2_TargetAvgRetailPriceMed) - (@PL2_AvgTargetFOB * @PL2_SalesUnit)) / (@PL2_SalesUnit * @PL2_TargetAvgRetailPriceMed) END, 
	LinePlanBusPnCh3 = CASE WHEN @PL3_TargetAvgRetailPriceMed = 0 THEN 0 ELSE ((@PL3_SalesUnit * @PL3_TargetAvgRetailPriceMed) - (@PL3_AvgTargetFOB * @PL3_SalesUnit)) / (@PL3_SalesUnit * @PL3_TargetAvgRetailPriceMed) END,  
	LinePlanBusPnCh4 = CASE WHEN @PL4_TargetAvgRetailPriceMed = 0 THEN 0 ELSE ((@PL4_SalesUnit * @PL4_TargetAvgRetailPriceMed) - (@PL4_AvgTargetFOB * @PL4_SalesUnit)) / (@PL4_SalesUnit * @PL4_TargetAvgRetailPriceMed) END, 
	LinePlanBusCuCh1 = CASE WHEN @Cu1_SalesUnit = 0 THEN 0 ELSE ((@Cu1_SalesUnit * @Cu1_TargetAvgRetailPriceMed) - (@Cu1_AvgTargetFOB * @Cu1_SalesUnit)) / (@Cu1_SalesUnit * @Cu1_TargetAvgRetailPriceMed) END, 
	LinePlanBusCuCh2 = CASE WHEN @Cu2_SalesUnit = 0 THEN 0 ELSE ((@Cu2_SalesUnit * @Cu2_TargetAvgRetailPriceMed) - (@Cu2_AvgTargetFOB * @Cu2_SalesUnit)) / (@Cu2_SalesUnit * @Cu2_TargetAvgRetailPriceMed) END,  
	LinePlanBusCuCh3 = CASE WHEN @Cu3_SalesUnit = 0 THEN 0 ELSE ((@Cu3_SalesUnit * @Cu3_TargetAvgRetailPriceMed) - (@Cu3_AvgTargetFOB * @Cu3_SalesUnit)) / (@Cu3_SalesUnit * @Cu3_TargetAvgRetailPriceMed) END, 
	LinePlanBusCuCh4 = CASE WHEN @Cu4_SalesUnit = 0 THEN 0 ELSE ((@Cu4_SalesUnit * @Cu4_TargetAvgRetailPriceMed) - (@Cu4_AvgTargetFOB * @Cu4_SalesUnit)) / (@Cu4_SalesUnit * @Cu4_TargetAvgRetailPriceMed) END 
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000012'


--Calculate Weighted Gross Margin Wholesale %
UPDATE pLinePlanBusiness SET
	LinePlanBusLYCh1 = CASE WHEN @LY1_ProjectedWhs = 0 THEN 0 ELSE ((@LY1_ProjectedWhs - (@LY1_SalesUnit * @LY1_AvgTargetFOB))) / @LY1_ProjectedWhs END, 
	LinePlanBusLYCh2 = CASE WHEN @LY2_ProjectedWhs = 0 THEN 0 ELSE ((@LY2_ProjectedWhs - (@LY2_SalesUnit * @LY2_AvgTargetFOB))) / @LY2_ProjectedWhs END, 
	LinePlanBusLYCh3 = CASE WHEN @LY3_ProjectedWhs = 0 THEN 0 ELSE ((@LY3_ProjectedWhs - (@LY3_SalesUnit * @LY3_AvgTargetFOB))) / @LY3_ProjectedWhs END, 
	LinePlanBusLYCh4 = CASE WHEN @LY4_ProjectedWhs = 0 THEN 0 ELSE ((@LY4_ProjectedWhs - (@LY4_SalesUnit * @LY4_AvgTargetFOB))) / @LY4_ProjectedWhs END, 
	LinePlanBusPnCh1 = CASE WHEN @PL1_ProjectedWhs = 0 THEN 0 ELSE ((@PL1_ProjectedWhs - (@PL1_SalesUnit * @PL1_AvgTargetFOB))) / @PL1_ProjectedWhs END, 
	LinePlanBusPnCh2 = CASE WHEN @PL2_ProjectedWhs = 0 THEN 0 ELSE ((@PL2_ProjectedWhs - (@PL2_SalesUnit * @PL2_AvgTargetFOB))) / @PL2_ProjectedWhs END, 
	LinePlanBusPnCh3 = CASE WHEN @PL3_ProjectedWhs = 0 THEN 0 ELSE ((@PL3_ProjectedWhs - (@PL3_SalesUnit * @PL3_AvgTargetFOB))) / @PL3_ProjectedWhs END,  
	LinePlanBusPnCh4 = CASE WHEN @PL4_ProjectedWhs = 0 THEN 0 ELSE ((@PL4_ProjectedWhs - (@PL4_SalesUnit * @PL4_AvgTargetFOB))) / @PL4_ProjectedWhs END, 
	LinePlanBusCuCh1 = CASE WHEN @Cu1_ProjectedWhs = 0 THEN 0 ELSE ((@Cu1_ProjectedWhs - (@Cu1_SalesUnit * @Cu1_AvgTargetFOB))) / @Cu1_ProjectedWhs END, 
	LinePlanBusCuCh2 = CASE WHEN @Cu2_ProjectedWhs = 0 THEN 0 ELSE ((@Cu2_ProjectedWhs - (@Cu2_SalesUnit * @Cu2_AvgTargetFOB))) / @Cu2_ProjectedWhs END,  
	LinePlanBusCuCh3 = CASE WHEN @Cu3_ProjectedWhs = 0 THEN 0 ELSE ((@Cu3_ProjectedWhs - (@Cu3_SalesUnit * @Cu3_AvgTargetFOB))) / @Cu3_ProjectedWhs END, 
	LinePlanBusCuCh4 = CASE WHEN @Cu4_ProjectedWhs = 0 THEN 0 ELSE ((@Cu4_ProjectedWhs - (@Cu4_SalesUnit * @Cu4_AvgTargetFOB))) / @Cu4_ProjectedWhs END 
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000011'






-- Calculate Weighted average retail price

SET @LY1_WeightedAverageRetailPrice = CASE WHEN @LY1_NoOfStyle = 0 THEN  0 ELSE ( ((@LY1_TargetAvgRetailPriceLow * @LY1_NoOfStyleLow) + (@LY1_TargetAvgRetailPriceMed * @LY1_NoOfStyleMed) + (@LY1_TargetAvgRetailPriceHigh * @LY1_NoOfStyleHigh)) / @LY1_NoOfStyle ) END
SET @LY2_WeightedAverageRetailPrice = CASE WHEN @LY2_NoOfStyle = 0 THEN  0 ELSE ( ((@LY2_TargetAvgRetailPriceLow * @LY2_NoOfStyleLow) + (@LY2_TargetAvgRetailPriceMed * @LY2_NoOfStyleMed) + (@LY2_TargetAvgRetailPriceHigh * @LY2_NoOfStyleHigh)) / @LY2_NoOfStyle ) END
SET @LY3_WeightedAverageRetailPrice = CASE WHEN @LY3_NoOfStyle = 0 THEN  0 ELSE ( ((@LY3_TargetAvgRetailPriceLow * @LY3_NoOfStyleLow) + (@LY3_TargetAvgRetailPriceMed * @LY3_NoOfStyleMed) + (@LY3_TargetAvgRetailPriceHigh * @LY3_NoOfStyleHigh)) / @LY3_NoOfStyle ) END
SET @LY4_WeightedAverageRetailPrice = CASE WHEN @LY4_NoOfStyle = 0 THEN  0 ELSE ( ((@LY4_TargetAvgRetailPriceLow * @LY4_NoOfStyleLow) + (@LY4_TargetAvgRetailPriceMed * @LY4_NoOfStyleMed) + (@LY4_TargetAvgRetailPriceHigh * @LY4_NoOfStyleHigh)) / @LY4_NoOfStyle ) END

SET @PL1_WeightedAverageRetailPrice = CASE WHEN @PL1_NoOfStyle = 0 THEN  0 ELSE ( ((@PL1_TargetAvgRetailPriceLow * @PL1_NoOfStyleLow) + (@PL1_TargetAvgRetailPriceMed * @PL1_NoOfStyleMed) + (@PL1_TargetAvgRetailPriceHigh * @PL1_NoOfStyleHigh)) / @PL1_NoOfStyle ) END
SET @PL2_WeightedAverageRetailPrice = CASE WHEN @PL2_NoOfStyle = 0 THEN  0 ELSE ( ((@PL2_TargetAvgRetailPriceLow * @PL2_NoOfStyleLow) + (@PL2_TargetAvgRetailPriceMed * @PL2_NoOfStyleMed) + (@PL2_TargetAvgRetailPriceHigh * @PL2_NoOfStyleHigh)) / @PL2_NoOfStyle ) END
SET @PL3_WeightedAverageRetailPrice = CASE WHEN @PL3_NoOfStyle = 0 THEN  0 ELSE ( ((@PL3_TargetAvgRetailPriceLow * @PL3_NoOfStyleLow) + (@PL3_TargetAvgRetailPriceMed * @PL3_NoOfStyleMed) + (@PL3_TargetAvgRetailPriceHigh * @PL3_NoOfStyleHigh)) / @PL3_NoOfStyle ) END
SET @PL4_WeightedAverageRetailPrice = CASE WHEN @PL4_NoOfStyle = 0 THEN  0 ELSE ( ((@PL4_TargetAvgRetailPriceLow * @PL4_NoOfStyleLow) + (@PL4_TargetAvgRetailPriceMed * @PL4_NoOfStyleMed) + (@PL4_TargetAvgRetailPriceHigh * @PL4_NoOfStyleHigh)) / @PL4_NoOfStyle ) END

SET @Cu1_WeightedAverageRetailPrice = CASE WHEN @Cu1_NoOfStyle = 0 THEN  0 ELSE ( ((@Cu1_TargetAvgRetailPriceLow * @Cu1_NoOfStyleLow) + (@Cu1_TargetAvgRetailPriceMed * @Cu1_NoOfStyleMed) + (@Cu1_TargetAvgRetailPriceHigh * @Cu1_NoOfStyleHigh)) / @Cu1_NoOfStyle ) END
SET @Cu2_WeightedAverageRetailPrice = CASE WHEN @Cu2_NoOfStyle = 0 THEN  0 ELSE ( ((@Cu2_TargetAvgRetailPriceLow * @Cu2_NoOfStyleLow) + (@Cu2_TargetAvgRetailPriceMed * @Cu2_NoOfStyleMed) + (@Cu2_TargetAvgRetailPriceHigh * @Cu2_NoOfStyleHigh)) / @Cu2_NoOfStyle ) END
SET @Cu3_WeightedAverageRetailPrice = CASE WHEN @Cu3_NoOfStyle = 0 THEN  0 ELSE ( ((@Cu3_TargetAvgRetailPriceLow * @Cu3_NoOfStyleLow) + (@Cu3_TargetAvgRetailPriceMed * @Cu3_NoOfStyleMed) + (@Cu3_TargetAvgRetailPriceHigh * @Cu3_NoOfStyleHigh)) / @Cu3_NoOfStyle ) END
SET @Cu4_WeightedAverageRetailPrice = CASE WHEN @Cu4_NoOfStyle = 0 THEN  0 ELSE ( ((@Cu4_TargetAvgRetailPriceLow * @Cu4_NoOfStyleLow) + (@Cu4_TargetAvgRetailPriceMed * @Cu4_NoOfStyleMed) + (@Cu4_TargetAvgRetailPriceHigh * @Cu4_NoOfStyleHigh)) / @Cu4_NoOfStyle ) END


UPDATE pLinePlanBusiness SET
	LinePlanBusLYCh1 = @LY1_WeightedAverageRetailPrice, 
	LinePlanBusLYCh2 = @LY2_WeightedAverageRetailPrice,
	LinePlanBusLYCh3 = @LY3_WeightedAverageRetailPrice, 
	LinePlanBusLYCh4 = @LY4_WeightedAverageRetailPrice, 

	LinePlanBusPnCh1 = @PL1_WeightedAverageRetailPrice, 
	LinePlanBusPnCh2 = @PL2_WeightedAverageRetailPrice, 
	LinePlanBusPnCh3 = @PL3_WeightedAverageRetailPrice, 
	LinePlanBusPnCh4 = @PL4_WeightedAverageRetailPrice, 

	LinePlanBusCuCh1 = @Cu1_WeightedAverageRetailPrice, 
	LinePlanBusCuCh2 = @Cu2_WeightedAverageRetailPrice, 
	LinePlanBusCuCh3 = @Cu3_WeightedAverageRetailPrice, 
	LinePlanBusCuCh4 = @Cu4_WeightedAverageRetailPrice	
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000026'


--========================================================================================================================
-- Retail Flow Through Margin %


SET @LY1_InitialGrossMarginRtl = CASE WHEN @LY1_WeightedAverageRetailPrice  = 0 THEN  0 ELSE (@LY1_WeightedAverageRetailPrice -  @LY1_AvgTargetFOB)/@LY1_WeightedAverageRetailPrice  END
SET @LY2_InitialGrossMarginRtl = CASE WHEN @LY2_WeightedAverageRetailPrice  = 0 THEN  0 ELSE (@LY1_WeightedAverageRetailPrice -  @LY1_AvgTargetFOB)/@LY1_WeightedAverageRetailPrice  END
SET @LY3_InitialGrossMarginRtl = CASE WHEN @LY3_WeightedAverageRetailPrice  = 0 THEN  0 ELSE (@LY1_WeightedAverageRetailPrice -  @LY1_AvgTargetFOB)/@LY1_WeightedAverageRetailPrice  END
SET @LY4_InitialGrossMarginRtl = CASE WHEN @LY4_WeightedAverageRetailPrice  = 0 THEN  0 ELSE (@LY1_WeightedAverageRetailPrice -  @LY1_AvgTargetFOB)/@LY1_WeightedAverageRetailPrice  END

SET @PL1_InitialGrossMarginRtl = CASE WHEN @PL1_WeightedAverageRetailPrice  = 0 THEN  0 ELSE (@PL1_WeightedAverageRetailPrice -  @PL1_AvgTargetFOB)/@PL1_WeightedAverageRetailPrice  END
SET @PL2_InitialGrossMarginRtl = CASE WHEN @PL2_WeightedAverageRetailPrice  = 0 THEN  0 ELSE (@PL2_WeightedAverageRetailPrice -  @PL2_AvgTargetFOB)/@PL2_WeightedAverageRetailPrice  END
SET @PL3_InitialGrossMarginRtl = CASE WHEN @PL3_WeightedAverageRetailPrice  = 0 THEN  0 ELSE (@PL3_WeightedAverageRetailPrice -  @PL3_AvgTargetFOB)/@PL3_WeightedAverageRetailPrice  END
SET @PL4_InitialGrossMarginRtl = CASE WHEN @PL4_WeightedAverageRetailPrice  = 0 THEN  0 ELSE (@PL4_WeightedAverageRetailPrice -  @PL4_AvgTargetFOB)/@PL4_WeightedAverageRetailPrice  END

SET @Cu1_InitialGrossMarginRtl = CASE WHEN @Cu1_WeightedAverageRetailPrice  = 0 THEN  0 ELSE (@Cu1_WeightedAverageRetailPrice -  @Cu1_AvgTargetFOB)/@Cu1_WeightedAverageRetailPrice  END
SET @Cu2_InitialGrossMarginRtl = CASE WHEN @Cu2_WeightedAverageRetailPrice  = 0 THEN  0 ELSE (@Cu1_WeightedAverageRetailPrice -  @Cu1_AvgTargetFOB)/@Cu1_WeightedAverageRetailPrice  END
SET @Cu3_InitialGrossMarginRtl = CASE WHEN @Cu3_WeightedAverageRetailPrice  = 0 THEN  0 ELSE (@Cu1_WeightedAverageRetailPrice -  @Cu1_AvgTargetFOB)/@Cu1_WeightedAverageRetailPrice  END
SET @Cu4_InitialGrossMarginRtl = CASE WHEN @Cu4_WeightedAverageRetailPrice  = 0 THEN  0 ELSE (@Cu1_WeightedAverageRetailPrice -  @Cu1_AvgTargetFOB)/@Cu1_WeightedAverageRetailPrice  END

UPDATE pLinePlanBusiness SET
	LinePlanBusLYCh1 = @LY1_InitialGrossMarginRtl, 
	LinePlanBusLYCh2 = @LY2_InitialGrossMarginRtl,
	LinePlanBusLYCh3 = @LY3_InitialGrossMarginRtl, 
	LinePlanBusLYCh4 = @LY4_InitialGrossMarginRtl, 

	LinePlanBusPnCh1 = @PL1_InitialGrossMarginRtl, 
	LinePlanBusPnCh2 = @PL2_InitialGrossMarginRtl, 
	LinePlanBusPnCh3 = @PL3_InitialGrossMarginRtl, 
	LinePlanBusPnCh4 = @PL4_InitialGrossMarginRtl, 

	LinePlanBusCuCh1 = @Cu1_InitialGrossMarginRtl, 
	LinePlanBusCuCh2 = @Cu2_InitialGrossMarginRtl, 
	LinePlanBusCuCh3 = @Cu3_InitialGrossMarginRtl, 
	LinePlanBusCuCh4 = @Cu4_InitialGrossMarginRtl	
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000010'
--========================================================================================================================



--IF @LinePlanAttributeItemID4 IS NULL 
--	BEGIN
--	SELECT LinePlanRangeID
--	FROM pLinePlanRange
--	WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
--		AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
--		AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
--		AND (LinePlanID = @LinePlanID)
--	END
--ELSE IF @LinePlanAttributeItemID3 IS NULL 
--	BEGIN
--	SELECT LinePlanRangeID
--	FROM pLinePlanRange
--	WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
--		AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
--		AND (LinePlanFinancialID = @LinePlanFinancialID)
--	END
--ELSE IF @LinePlanAttributeItemID2 IS NULL 
--	BEGIN
--	SELECT LinePlanRangeID
--	FROM pLinePlanRange
--	WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
--		AND (LinePlanFinancialID = @LinePlanFinancialID)
--	END
--ELSE  
--	BEGIN
--	SELECT LinePlanRangeID
--	FROM pLinePlanRange
--	WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
--		AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
--		AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
--		AND (LinePlanAttributeItemID4 = @LinePlanAttributeItemID4)
--		AND (LinePlanFinancialID = @LinePlanFinancialID)
--	END



DECLARE @TOTAL INT
DECLARE @ROW_ID INT 
DECLARE @StyleQuoteItemID UNIQUEIDENTIFIER 
DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER 
DECLARE @StyleID UNIQUEIDENTIFIER 

--========================================================================================================
-- UPDATE StyleCosting 

CREATE TABLE #tmpStyleSeasonYear  ( 
ROW_ID INT IDENTITY (1,1),
StyleSeasonYearID UNIQUEIDENTIFIER, 
StyleID UNIQUEIDENTIFIER
)

INSERT INTO  #tmpStyleSeasonYear ( StyleSeasonYearID, StyleID)
SELECT c.StyleSeasonYearID, b.StyleID
FROM pLinePlanRange a 
INNER JOIN pLinePlanItem b ON a.LinePlanRangeID = b.LinePlanRangeID 
INNER JOIN pStyleSeasonYear c ON (b.StyleID = c.StyleID AND b.LinePlanItemID = c.LinePlanItemID)
WHERE a.LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND a.LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND a.LinePlanAttributeItemID3 = @LinePlanAttributeItemID3
AND a.LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'
AND b.StyleID <>  '00000000-0000-0000-0000-000000000000'


SET @ROW_ID = 1 
SELECT @TOTAL  = COUNT(*) FROM #tmpStyleSeasonYear



WHILE  @ROW_ID <= @TOTAL
BEGIN

	SELECT @StyleSeasonYearID = StyleSeasonYearID, @StyleID = StyleID 
	FROM #tmpStyleSeasonYear WHERE ROW_ID = @ROW_ID

	EXEC dbo.spx_StyleCostingHeaderLogic_UPDATE 
	@StyleID = @StyleID,
	@ModifiedBy = @MUser,
	@ModifiedDate = @MDate, 
	@StyleSeasonYearID = @StyleSeasonYearID

	SET @ROW_ID = @ROW_ID + 1 
END 
DROP TABLE  #tmpStyleSeasonYear


--========================================================================================================
-- ADD LOGIC TO UPDATE STYLE_SOURCING_QUOTE_ITEMS 

CREATE TABLE #tmpQuoteItem  (
ROW_ID INT IDENTITY (1,1),
StyleQuoteItemID UNIQUEIDENTIFIER 
)

INSERT INTO #tmpQuoteItem (StyleQuoteItemID)
SELECT StyleQuoteItemID 
from pStyleQuoteItem 
WHERE StyleID IN ( SELECT distinct StyleID 
		FROM pLinePlanBusinessItem
		WHERE LinePlanID = @LinePlanID AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
		AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
		AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3
)


SET @ROW_ID = 1 
SELECT @TOTAL  = COUNT(*) FROM #tmpQuoteItem

WHILE  @ROW_ID <= @TOTAL
BEGIN
	SELECT @StyleQuoteItemID = StyleQuoteItemID FROM #tmpQuoteItem WHERE ROW_ID = @ROW_ID
	EXEC dbo.spx_StyleSourcingQuoteItemLogic_UPDATE @StyleQuoteItemID
	SET @ROW_ID = @ROW_ID + 1 
END 
DROP TABLE  #tmpQuoteItem


*/













GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialCoreItem_COPY]'
GO
CREATE PROCEDURE [dbo].[spx_MaterialCoreItem_COPY]
(
	 @MaterialCoreID UNIQUEIDENTIFIER
	,@MaterialCoreItemID UNIQUEIDENTIFIER
	,@MaterialCoreCopyID UNIQUEIDENTIFIER
	,@CreatedBy NVARCHAR(200)
	,@CreatedDate DATETIME
	,@MaterialCoreColorCopy int --Copy Color = 1
)

AS

--/************/
--/*Testing.	*/
--/************/
--
--DECLARE
--	 @MaterialCoreID UNIQUEIDENTIFIER
--	,@MaterialCoreItemID UNIQUEIDENTIFIER
--	,@MaterialCoreCopyID UNIQUEIDENTIFIER
--	,@CreatedBy NVARCHAR(200)
--	,@CreatedDate DATETIME
--	,@MaterialCoreColorCopy int --Copy Color = 1
----
--SELECT  
--@MaterialCoreID='7261e5a9-9b80-4761-98fe-8730a19cc4b6',
--@MaterialCoreItemID='9c658d25-a080-4e6e-9ab3-5668d770a4bf',
--@MaterialCoreCopyID='5a3acd8c-b66a-4bf9-80fa-0294628f270e',
--@MaterialCoreColorCopy=1,
--@CreatedBy=N'Daniel Pak',
--@CreatedDate='2010-02-17 23:48:16:000'
--
--
SELECT * FROM pMaterialCoreItem WHERE MaterialCoreItemID = @MaterialCoreItemID
--SELECT * FROM pMaterialCoreItem WHERE MaterialCoreID = @MaterialCoreID
--SELECT * FROM pMaterialCoreItem WHERE MaterialCoreID = @MaterialCoreCopyID

/********************/
/*Create variables.	*/
/********************/
DECLARE @MaterialCoreID_Copy UNIQUEIDENTIFIER

DECLARE @MaterialCoreItemID_Original UNIQUEIDENTIFIER
DECLARE @MaterialCoreItemID_Copy UNIQUEIDENTIFIER

DECLARE @MaterialCoreColorID_Original UNIQUEIDENTIFIER
DECLARE @MaterialCoreColorID_Copy UNIQUEIDENTIFIER

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************/
/*Create temp tables.	*/
/************************/
--Holds original Material Group Header record.
CREATE TABLE dbo.#temp_pMaterialCore_Original
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,MaterialCoreID uniqueidentifier
	,MaterialCoreName nvarchar(100)
	,MaterialCoreDescription nvarchar(4000)
	,CUser nvarchar(200)
	,CDate datetime
	,MUser nvarchar(200)
	,MDate datetime
	,Active nvarchar(5)
	,Sort nvarchar(5)
	)  ON [PRIMARY]

ALTER TABLE dbo.#temp_pMaterialCore_Original ADD CONSTRAINT
	PK_#temp_pMaterialCore_Original PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

--Holds copied Material Group Header record.
CREATE TABLE dbo.#temp_pMaterialCore_Copy
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,MaterialCoreID uniqueidentifier
	,MaterialCoreName nvarchar(100)
	,MaterialCoreDescription nvarchar(4000)
	,CUser nvarchar(200)
	,CDate datetime
	,MUser nvarchar(200)
	,MDate datetime
	,Active nvarchar(5)
	,Sort nvarchar(5)
	)  ON [PRIMARY]

ALTER TABLE dbo.#temp_pMaterialCore_Copy ADD CONSTRAINT
	PK_#temp_pMaterialCore_Copy PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

--Holds original Material Group Materials.
CREATE TABLE dbo.#temp_pMaterialCoreItem_Original
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,MaterialCoreItemID uniqueidentifier
	,MaterialCoreID uniqueidentifier
	,MaterialID uniqueidentifier
	,UOM nvarchar(50)
	,Qty nvarchar(18)
	,MaterialPrice money
	,Ext money
	,MaterialSize nvarchar(100)
	,Placement nvarchar(4000)
	,Artwork int
	,License int
	,Colorway int
	,CUser nvarchar(200)
	,CDate datetime
	,MUser nvarchar(200)
	,MDate datetime
	)  ON [PRIMARY]

ALTER TABLE dbo.#temp_pMaterialCoreItem_Original ADD CONSTRAINT
	PK_#temp_pMaterialCoreItem_Original PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

--Holds copied Material Group Materials.
CREATE TABLE dbo.#temp_pMaterialCoreItem_Copy
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,MaterialCoreItemID uniqueidentifier
	,MaterialCoreID uniqueidentifier
	,MaterialID uniqueidentifier
	,UOM nvarchar(50)
	,Qty nvarchar(18)
	,MaterialPrice money
	,Ext money
	,MaterialSize nvarchar(100)
	,Placement nvarchar(4000)
	,Artwork int
	,License int
	,Colorway int
	,CUser nvarchar(200)
	,CDate datetime
	,MUser nvarchar(200)
	,MDate datetime
	)  ON [PRIMARY]

ALTER TABLE dbo.#temp_pMaterialCoreItem_Copy ADD CONSTRAINT
	PK_#temp_pMaterialCoreItem_Copy PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

--Holds original Material Group Colors.
CREATE TABLE dbo.#temp_pMaterialCoreColor_Original
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,MaterialCoreColorID uniqueidentifier
	,MaterialCoreID uniqueidentifier
	,ColorPaletteID uniqueidentifier
	,ColorCode nvarchar(200)
	,ColorName nvarchar(200)
	,Active int
	,Sort varchar(5)
	,CDate datetime
	,CUser nvarchar(200)
	,MDate datetime
	,MUser nvarchar(200)
	)  ON [PRIMARY]

ALTER TABLE dbo.#temp_pMaterialCoreColor_Original ADD CONSTRAINT
	PK_#temp_pMaterialCoreColor_Original PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

--Holds copied Material Group Colors.
CREATE TABLE dbo.#temp_pMaterialCoreColor_Copy
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,MaterialCoreColorID uniqueidentifier
	,MaterialCoreID uniqueidentifier
	,ColorPaletteID uniqueidentifier
	,ColorCode nvarchar(200)
	,ColorName nvarchar(200)
	,Active int
	,Sort varchar(5)
	,CDate datetime
	,CUser nvarchar(200)
	,MDate datetime
	,MUser nvarchar(200)
	)  ON [PRIMARY]

ALTER TABLE dbo.#temp_pMaterialCoreColor_Copy ADD CONSTRAINT
	PK_#temp_pMaterialCoreColor_Copy PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

--Holds original Material Group Chip Colors.
CREATE TABLE dbo.#temp_pMaterialCoreColorItem_Original
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,MaterialCoreColorItemID uniqueidentifier
	,MaterialCoreColorItemMasterID uniqueidentifier
	,MaterialCoreColorID uniqueidentifier
	,MaterialCoreItemID uniqueidentifier
	,MaterialCoreID uniqueidentifier
	,MaterialID uniqueidentifier
	,MaterialColorID uniqueidentifier
	,CDate datetime
	,CUser nvarchar(100)
	,MDate datetime
	,MUser nvarchar(100)
	)  ON [PRIMARY]

ALTER TABLE dbo.#temp_pMaterialCoreColorItem_Original ADD CONSTRAINT
	PK_#temp_pMaterialCoreColorItem_Original PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

--Holds copied Material Group Chip Colors.
CREATE TABLE dbo.#temp_pMaterialCoreColorItem_Copy
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,MaterialCoreColorItemID uniqueidentifier
	,MaterialCoreColorItemMasterID uniqueidentifier
	,MaterialCoreColorID uniqueidentifier
	,MaterialCoreItemID uniqueidentifier
	,MaterialCoreID uniqueidentifier
	,MaterialID uniqueidentifier
	,MaterialColorID uniqueidentifier
	,CDate datetime
	,CUser nvarchar(100)
	,MDate datetime
	,MUser nvarchar(100)
	)  ON [PRIMARY]

ALTER TABLE dbo.#temp_pMaterialCoreColorItem_Copy ADD CONSTRAINT
	PK_#temp_pMaterialCoreColorItem_Copy PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/************************************************************************/
/*Get the original records and put them in the 'original' temp tables.	*/
/************************************************************************/
--Material Group Header Original.
INSERT INTO #temp_pMaterialCore_Original
	(MaterialCoreID, MaterialCoreName, MaterialCoreDescription, CUser, CDate, 
	MUser, MDate, Active, Sort)
SELECT
	MaterialCoreID, MaterialCoreName,MaterialCoreDescription, CUser, CDate,
	MUser, MDate, Active, Sort
FROM pMaterialCore
WHERE MaterialCoreID = @MaterialCoreCopyID

--Material Group Materials Original.
INSERT INTO #temp_pMaterialCoreItem_Original
	(MaterialCoreItemID, MaterialCoreID, MaterialID, UOM, Qty, MaterialPrice,
	Ext, MaterialSize, Placement, Artwork, License, Colorway, CUser, CDate,
	MUser, MDate)
SELECT
	MaterialCoreItemID, MaterialCoreID, MaterialID, UOM, Qty, MaterialPrice,
	Ext, MaterialSize, Placement, Artwork, License, Colorway, CUser, CDate,
	MUser, MDate
FROM pMaterialCoreItem
WHERE MaterialCoreItemID = @MaterialCoreItemID

--Material Group Colors Original.
INSERT INTO #temp_pMaterialCoreColor_Original
	(MaterialCoreColorID, MaterialCoreID, ColorPaletteID, ColorCode, ColorName,
	Active, Sort, CDate, CUser, MDate, MUser)
SELECT
	MaterialCoreColorID, MaterialCoreID, ColorPaletteID, ColorCode, ColorName,
	Active, Sort, CDate, CUser, MDate, MUser
FROM pMaterialCoreColor
WHERE MaterialCoreID = @MaterialCoreCopyID

--Material Group Color Chips Original.
INSERT INTO #temp_pMaterialCoreColorItem_Original
	(MaterialCoreColorItemID, MaterialCoreColorItemMasterID, MaterialCoreColorID,
	MaterialCoreItemID, MaterialCoreID, MaterialID, MaterialColorID, CDate, CUser,
	MDate, MUser)
SELECT
	MaterialCoreColorItemID, MaterialCoreColorItemMasterID, MaterialCoreColorID,
	MaterialCoreItemID, MaterialCoreID, MaterialID, MaterialColorID, CDate, CUser,
	MDate, MUser
FROM pMaterialCoreColorItem
WHERE MaterialCoreItemID = @MaterialCoreItemID


/********************************************************************/
/*Get the original records and put them in the 'copy' temp tables.	*/
/********************************************************************/
--Material Group Header Copy.
INSERT INTO #temp_pMaterialCore_Copy
	(MaterialCoreID, MaterialCoreName,MaterialCoreDescription, CUser, CDate,
	MUser, MDate, Active, Sort)
SELECT
	MaterialCoreID, MaterialCoreName,MaterialCoreDescription, CUser, CDate,
	MUser, MDate, Active, Sort
FROM #temp_pMaterialCore_Original

--Material Group Materials Copy.
INSERT INTO #temp_pMaterialCoreItem_Copy
	(MaterialCoreItemID, MaterialCoreID, MaterialID, UOM, Qty, MaterialPrice,
	Ext, MaterialSize, Placement, Artwork, License, Colorway, CUser, CDate,
	MUser, MDate)
SELECT
	MaterialCoreItemID, MaterialCoreID, MaterialID, UOM, Qty, MaterialPrice,
	Ext, MaterialSize, Placement, Artwork, License, Colorway, CUser, CDate,
	MUser, MDate
FROM #temp_pMaterialCoreItem_Original

--Material Group Colors Copy.
INSERT INTO #temp_pMaterialCoreColor_Copy
	(MaterialCoreColorID, MaterialCoreID, ColorPaletteID, ColorCode, ColorName,
	Active, Sort, CDate, CUser, MDate, MUser)
SELECT
	MaterialCoreColorID, MaterialCoreID, ColorPaletteID, ColorCode, ColorName,
	Active, Sort, CDate, CUser, MDate, MUser
FROM #temp_pMaterialCoreColor_Original

--Material Group Color Chips Copy.
INSERT INTO #temp_pMaterialCoreColorItem_Copy
	(MaterialCoreColorItemID, MaterialCoreColorItemMasterID, MaterialCoreColorID,
	MaterialCoreItemID, MaterialCoreID, MaterialID, MaterialColorID, CDate, CUser,
	MDate, MUser)
SELECT
	MaterialCoreColorItemID, MaterialCoreColorItemMasterID, MaterialCoreColorID,
	MaterialCoreItemID, MaterialCoreID, MaterialID, MaterialColorID, CDate, CUser,
	MDate, MUser
FROM #temp_pMaterialCoreColorItem_Original


/*************************************************************************************************/
/*HEADER:  Generate new ID and update 'copy' temp tables with it.  Do 'users' and 'dates' too.	*/
/*************************************************************************************************/
--Make new id.
SET @MaterialCoreID_Copy = @MaterialCoreID  --NEWID()

--Update header 'copy' temp table.
UPDATE #temp_pMaterialCore_Copy
SET MaterialCoreID = @MaterialCoreID_Copy
	,CUser = @CreatedBy
	,CDate = @CreatedDate
	,MUser = @CreatedBy
	,MDate = @CreatedDate
WHERE MaterialCoreID = @MaterialCoreCopyID

--Update material 'copy' temp table.
UPDATE #temp_pMaterialCoreItem_Copy
SET MaterialCoreID = @MaterialCoreID_Copy
	,CUser = @CreatedBy
	,CDate = @CreatedDate
	,MUser = @CreatedBy
	,MDate = @CreatedDate
WHERE MaterialCoreID = @MaterialCoreCopyID

--Update color 'copy' temp table.
UPDATE #temp_pMaterialCoreColor_Copy
SET MaterialCoreID = @MaterialCoreID_Copy
	,CUser = @CreatedBy
	,CDate = @CreatedDate
	,MUser = @CreatedBy
	,MDate = @CreatedDate
WHERE MaterialCoreID = @MaterialCoreCopyID

--Update color chip 'copy' temp table.
UPDATE #temp_pMaterialCoreColorItem_Copy
SET MaterialCoreID = @MaterialCoreID_Copy
	,CUser = @CreatedBy
	,CDate = @CreatedDate
	,MUser = @CreatedBy
	,MDate = @CreatedDate
WHERE MaterialCoreID = @MaterialCoreCopyID


/************************************************************************/
/*MATERIALS:  Generate new ID and update 'copy' temp tables with it.	*/
/************************************************************************/
--Get and set counters.
SELECT @TotalCount = COUNT(*) FROM #temp_pMaterialCoreItem_Original
SET @RowCounter = 1

--Loop to update 'copy' temp tables.
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		--Clear variable.
		SET @MaterialCoreItemID_Original = NULL

		--Make new id.
		SET @MaterialCoreItemID_Copy = NEWID()

		--Get an 'original' id.
		SELECT @MaterialCoreItemID_Original = MaterialCoreItemID
		FROM #temp_pMaterialCoreItem_Original
		WHERE TableRow = @RowCounter

		--Update material 'copy' temp table.
		UPDATE #temp_pMaterialCoreItem_Copy
		SET MaterialCoreItemID = @MaterialCoreItemID_Copy
		WHERE MaterialCoreItemID = @MaterialCoreItemID_Original

		--Update color chip 'copy' temp table.
		UPDATE #temp_pMaterialCoreColorItem_Copy
		SET MaterialCoreItemID = @MaterialCoreItemID_Copy
		WHERE MaterialCoreItemID = @MaterialCoreItemID_Original

		--Up counter.
		SET @RowCounter = @RowCounter + 1
	END


/********************************************************************/
/*COLORS:  Generate new ID and update 'copy' temp tables with it.	*/
/********************************************************************/
--Get and set counters.
SELECT @TotalCount = COUNT(*) FROM #temp_pMaterialCoreColor_Original
SET @RowCounter = 1

--Loop to update 'copy' temp tables.
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		--Clear variable.
		SET @MaterialCoreColorID_Original = NULL

		--Make new id.
		SET @MaterialCoreColorID_Copy = NEWID()

		--Get an 'original' id.
		SELECT @MaterialCoreColorID_Original = MaterialCoreColorID
		FROM #temp_pMaterialCoreColor_Original
		WHERE TableRow = @RowCounter

		--Update color 'copy' temp table.
		UPDATE #temp_pMaterialCoreColor_Copy
		SET MaterialCoreColorID = @MaterialCoreColorID_Copy
		WHERE MaterialCoreColorID = @MaterialCoreColorID_Original

		--Update color chip 'copy' temp table.
		UPDATE #temp_pMaterialCoreColorItem_Copy
		SET MaterialCoreColorID = @MaterialCoreColorID_Copy
		WHERE MaterialCoreColorID = @MaterialCoreColorID_Original

		--Up counter.
		SET @RowCounter = @RowCounter + 1
	END


/********************************************************/
/*COLOR CHIPS:  Generate new IDs for 'copy' temp table.	*/
/********************************************************/
--Update color chip 'copy' temp table.
UPDATE #temp_pMaterialCoreColorItem_Copy
SET MaterialCoreColorItemID = NEWID()


/************************************************/
/*Insert 'copy' records into the real tables.	*/
/************************************************/

--Material Group Header.
--INSERT INTO pMaterialCore
--	(MaterialCoreID, MaterialCoreName,MaterialCoreDescription, CUser, CDate,
--	MUser, MDate, Active, Sort)
--SELECT
--	MaterialCoreID, MaterialCoreName,MaterialCoreDescription, CUser, CDate,
--	MUser, MDate, Active, Sort
--FROM #temp_pMaterialCore_Copy

--Material Group Materials.
INSERT INTO pMaterialCoreItem
	(MaterialCoreItemID, MaterialCoreID, MaterialID, UOM, Qty, MaterialPrice,
	Ext, MaterialSize, Placement, Artwork, License, Colorway, CUser, CDate,
	MUser, MDate)
SELECT
	MaterialCoreItemID, MaterialCoreID, MaterialID, UOM, Qty, MaterialPrice,
	Ext, MaterialSize, Placement, Artwork, License, Colorway, CUser, CDate,
	MUser, MDate
FROM #temp_pMaterialCoreItem_Copy


IF @MaterialCoreColorCopy = 1 
BEGIN

	--Material Group Colors.
	INSERT INTO pMaterialCoreColor
		(MaterialCoreColorID, MaterialCoreID, ColorPaletteID, ColorCode, ColorName,
		Active, Sort, CDate, CUser, MDate, MUser)
	SELECT
		MaterialCoreColorID, MaterialCoreID, ColorPaletteID, ColorCode, ColorName,
		Active, Sort, CDate, CUser, MDate, MUser
	FROM #temp_pMaterialCoreColor_Copy

	--Material Group Color Chips.
	INSERT INTO pMaterialCoreColorItem
		(MaterialCoreColorItemID, MaterialCoreColorItemMasterID, MaterialCoreColorID,
		MaterialCoreItemID, MaterialCoreID, MaterialID, MaterialColorID, CDate, CUser,
		MDate, MUser)
	SELECT
		MaterialCoreColorItemID, MaterialCoreColorItemMasterID, MaterialCoreColorID,
		MaterialCoreItemID, MaterialCoreID, MaterialID, MaterialColorID, CDate, CUser,
		MDate, MUser
	FROM #temp_pMaterialCoreColorItem_Copy

END


--/************/
--/*Testing.	*/
--/************/
--SELECT * FROM #temp_pMaterialCore_Original
--SELECT * FROM #temp_pMaterialCore_Copy
--SELECT * FROM #temp_pMaterialCoreItem_Original
--SELECT * FROM #temp_pMaterialCoreItem_Copy
--SELECT * FROM #temp_pMaterialCoreColor_Original
--SELECT * FROM #temp_pMaterialCoreColor_Copy
--SELECT * FROM #temp_pMaterialCoreColorItem_Original
--SELECT * FROM #temp_pMaterialCoreColorItem_Copy


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_pMaterialCore_Original
DROP TABLE #temp_pMaterialCore_Copy
DROP TABLE #temp_pMaterialCoreItem_Original
DROP TABLE #temp_pMaterialCoreItem_Copy
DROP TABLE #temp_pMaterialCoreColor_Original
DROP TABLE #temp_pMaterialCoreColor_Copy
DROP TABLE #temp_pMaterialCoreColorItem_Original
DROP TABLE #temp_pMaterialCoreColorItem_Copy
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialRequestSubmit_DELETE]'
GO


/*
Comments:

#01 - Ryan Cabanas - August 27, 2009
	There's a new feature to the Material Sample Workflow area under a TradePartner
at the Material.  You are now able to have an "all colors" workflow bubble, but
there is still individual color records behind the scenes.  Need to make sure that
they are in sync when something changes.
*/


ALTER PROCEDURE [dbo].[spx_MaterialRequestSubmit_DELETE] (
	@MaterialTradePartnerColorID UNIQUEIDENTIFIER,
	@MaterialTradePartnerID UNIQUEIDENTIFIER,  
	@MaterialRequestSubmitWorkflowID UNIQUEIDENTIFIER,
	@MaterialSubmit VARCHAR(2)
)
AS


--/************/
--/*Testing.	*/
--/************/
--BEGIN
--	DECLARE @MaterialTradePartnerColorID UNIQUEIDENTIFIER
--	DECLARE @MaterialTradePartnerID UNIQUEIDENTIFIER
--	DECLARE @MaterialRequestSubmitWorkflowID UNIQUEIDENTIFIER
--	DECLARE @MaterialSubmit VARCHAR(2)
--
--	SET @MaterialTradePartnerColorID='955dfb6f-e1f9-4921-afdb-450d1e680f4c'
--	SET @MaterialTradePartnerID='119cddd8-289c-43d6-8661-eec88ce399ce'
--	SET @MaterialRequestSubmitWorkflowID = '6DF9A194-5889-4A0D-BF18-0DE9796F9DE2'
--	SET @MaterialSubmit='2'
--END


	DECLARE @MaterialRequestSubmitID UNIQUEIDENTIFIER
	DECLARE @MaterialRequestWorkflowID VARCHAR(5)	
	DECLARE @NewMaterialSubmit INT

	SELECT TOP 1 @MaterialRequestSubmitID = MaterialRequestSubmitID
	FROM pMaterialRequestSubmit  
	WHERE MaterialTradePartnerColorID = @MaterialTradePartnerColorID
		AND MaterialTradePartnerID = @MaterialTradePartnerID
		AND MaterialRequestSubmitWorkflowID = @MaterialRequestSubmitWorkflowID
		AND Submit = @MaterialSubmit
	
	BEGIN
		DELETE pMaterialRequestSubmitItem WHERE MaterialRequestSubmitID = @MaterialRequestSubmitID
	END
	
	BEGIN
		DELETE pMaterialRequestSubmit WHERE MaterialRequestSubmitID = @MaterialRequestSubmitID
	END

	BEGIN
	
		SET @NewMaterialSubmit = 1	
		IF @MaterialSubmit <> 1		
		BEGIN
			SET @NewMaterialSubmit = ISNULL(CAST(@MaterialSubmit AS INT), 2) - 1
		END

		UPDATE pMaterialRequestSubmitWorkflow SET 
			pMaterialRequestSubmitWorkflow.Submit = @NewMaterialSubmit, 
			pMaterialRequestSubmitWorkflow.Status = 0 
			--pMaterialRequestSubmitWorkflow.AssignedTo = @AssignedTo, 
--			pMaterialRequestSubmitWorkflow.StartDate = CONVERT(DATETIME, @StartDate, 112), 
--			pMaterialRequestSubmitWorkflow.DueDate = CONVERT(DATETIME, @DueDate, 112), 
--			pMaterialRequestSubmitWorkflow.EndDate = CONVERT(DATETIME, @EndDate, 112),
--			pMaterialRequestSubmitWorkflow.MDate = @MDate,
--			pMaterialRequestSubmitWorkflow.MUser = @MUser
		WHERE MaterialRequestSubmitWorkflowID = @MaterialRequestSubmitWorkflowID

	END




--Comment #01
/*Entirely new section to handle 'no color' workflows.  Update the other 'no colors' information for the workflow.*/
/********************************************************/
/*Find out if the workflow is a 'no color' workflow.	*/
/********************************************************/
BEGIN
	/*Declare variable.*/
	DECLARE @MaterialRequestWorkflowColor int

	/*Get the workflow id.*/
	SELECT @MaterialRequestWorkflowID = MaterialRequestWorkflowID
	FROM pMaterialRequestSubmitWorkflow
	WHERE MaterialRequestSubmitWorkflowID = @MaterialRequestSubmitWorkflowID

	/*Get flag.  If '0', then it's a 'no color' workflow.*/
	SELECT @MaterialRequestWorkflowColor = MaterialRequestWorkflowColor
	FROM pMaterialRequestWorkflow
	WHERE MaterialRequestWorkflowID = @MaterialRequestWorkflowID
END


IF @MaterialRequestWorkflowColor = 0
	BEGIN
		/*Declare variables.*/
		DECLARE @MaterialRequestSubmitID_Original uniqueidentifier
		DECLARE @MaterialRequestSubmitID_Other uniqueidentifier
		DECLARE @TotalCount int
		DECLARE @RowCounter int


		/*Create temp table.*/
		CREATE TABLE #temp_MaterialRequestSubmitIDs(
			TableRow int identity(1,1)
			,MaterialRequestSubmitID uniqueidentifier)

		/*Use my own variable names.*/
		SET @MaterialRequestSubmitID_Original = @MaterialRequestSubmitID

		/*Get IDs of the other 'no color' records.*/
		/*Watch for the crazy join because the original 'no color' workflow has already had it's submit number updated.*/
		INSERT INTO #temp_MaterialRequestSubmitIDs(MaterialRequestSubmitID)
		SELECT pMaterialRequestSubmit_OtherColors.MaterialRequestSubmitID
		FROM pMaterialRequestSubmitWorkflow
			INNER JOIN pMaterialRequestSubmit	ON	pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID = pMaterialRequestSubmit.MaterialRequestSubmitWorkflowID
													AND pMaterialRequestSubmitWorkflow.Submit = pMaterialRequestSubmit.Submit
			INNER JOIN pMaterialRequestSubmitWorkflow AS pMaterialRequestSubmitWorkflow_OtherColors	ON	pMaterialRequestSubmitWorkflow.MaterialTradePartnerID = pMaterialRequestSubmitWorkflow_OtherColors.MaterialTradePartnerID
																										AND pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID = pMaterialRequestSubmitWorkflow_OtherColors.MaterialRequestWorkflowID
																										AND pMaterialRequestSubmitWorkflow.Submit + 1 = pMaterialRequestSubmitWorkflow_OtherColors.Submit		--Crazy, but I have to increase the 'submit' number for the original 'no color' to do a match with the other 'no colors'.
			INNER JOIN pMaterialRequestSubmit AS pMaterialRequestSubmit_OtherColors	ON	pMaterialRequestSubmitWorkflow_OtherColors.MaterialRequestSubmitWorkflowID = pMaterialRequestSubmit_OtherColors.MaterialRequestSubmitWorkflowID
													AND pMaterialRequestSubmitWorkflow_OtherColors.Submit = pMaterialRequestSubmit_OtherColors.Submit
		WHERE pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID = @MaterialTradePartnerColorID
			AND pMaterialRequestSubmitWorkflow.MaterialTradePartnerID = @MaterialTradePartnerID
			AND pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID = @MaterialRequestWorkflowID
			AND pMaterialRequestSubmitWorkflow.Submit = @NewMaterialSubmit
			AND pMaterialRequestSubmit_OtherColors.MaterialRequestSubmitID <> @MaterialRequestSubmitID_Original


		/*Get and set counts.*/
		SELECT @TotalCount = COUNT(*) FROM #temp_MaterialRequestSubmitIDs
		SET @RowCounter = 1

		/*Loop to delete and update records for the other 'no colors'.*/
		WHILE(@RowCounter <= @TotalCount)

			BEGIN

				/*Get a 'MaterialRequestSubmitID'.*/
				SELECT @MaterialRequestSubmitID_Other = MaterialRequestSubmitID
				FROM #temp_MaterialRequestSubmitIDs
				WHERE TableRow = @RowCounter

				/********************************************************************/
				/*Use most of Daniel's code above to do the deletions and update.	*/
				/********************************************************************/

				/*Delete the grid records for the other 'no color'.*/
				BEGIN
					DELETE pMaterialRequestSubmitItem WHERE MaterialRequestSubmitID = @MaterialRequestSubmitID_Other
				END

				/*Delete the submit for the other 'no color' record.*/
				BEGIN
					DELETE pMaterialRequestSubmit WHERE MaterialRequestSubmitID = @MaterialRequestSubmitID_Other
				END

				/*Update the other 'no color' workflow record.*/
				BEGIN
					UPDATE pMaterialRequestSubmitWorkflow SET 
						pMaterialRequestSubmitWorkflow.Submit = @NewMaterialSubmit, 
						pMaterialRequestSubmitWorkflow.Status = 0 
						--pMaterialRequestSubmitWorkflow.AssignedTo = @AssignedTo, 
			--			pMaterialRequestSubmitWorkflow.StartDate = CONVERT(DATETIME, @StartDate, 112), 
			--			pMaterialRequestSubmitWorkflow.DueDate = CONVERT(DATETIME, @DueDate, 112), 
			--			pMaterialRequestSubmitWorkflow.EndDate = CONVERT(DATETIME, @EndDate, 112),
			--			pMaterialRequestSubmitWorkflow.MDate = @MDate,
			--			pMaterialRequestSubmitWorkflow.MUser = @MUser
					WHERE pMaterialRequestSubmitWorkflow.MaterialTradePartnerID = @MaterialTradePartnerID
						AND pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID = @MaterialRequestWorkflowID
						AND pMaterialRequestSubmitWorkflow.Submit = @MaterialSubmit
				END

				/*Up row counter.*/
				SET @RowCounter = @RowCounter + 1

			END

		/*Drop temp table.*/
		DROP TABLE #temp_MaterialRequestSubmitIDs
	END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanBusinessItem_QUEUE]'
GO

CREATE PROCEDURE [dbo].[spx_LinePlanBusinessItem_QUEUE] (
@StyleQuoteItemID uniqueidentifier,
@StyleID uniqueidentifier, 
@LinePlanID uniqueidentifier, 
@LinePlanRangeID uniqueidentifier, 
@LinePlanAttributeItemID1 uniqueidentifier, 
@LinePlanAttributeItemID2 uniqueidentifier, 
@LinePlanAttributeItemID3 uniqueidentifier, 
@LinePlanAttributeItemID4 uniqueidentifier, 
@StyleSeasonYearID UNIQUEIDENTIFIER,
@Cmd varchar(10)
)
AS 


DECLARE @pStyleQuoteItemID NVARCHAR (70)
DECLARE @pStyleID  NVARCHAR (70)
DECLARE @pLinePlanID  NVARCHAR (70)
DECLARE @pLinePlanRangeID  NVARCHAR (70)
DECLARE @pLinePlanAttributeItemID1  NVARCHAR (70)
DECLARE @pLinePlanAttributeItemID2  NVARCHAR (70)
DECLARE @pLinePlanAttributeItemID3  NVARCHAR (70)
DECLARE @pLinePlanAttributeItemID4  NVARCHAR (70)
DECLARE @pStyleSeasonYearID  NVARCHAR (70)
DECLARE @pCmd varchar(50)


IF @StyleQuoteItemID IS NULL
	SET @pStyleQuoteItemID = ' @StyleQuoteItemID = NULL '
ELSE
	SET @pStyleQuoteItemID = ' @StyleQuoteItemID = ''' +  CAST (@StyleQuoteItemID AS NVARCHAR(50)) + ''' '

IF @StyleID IS NULL
	SET @pStyleID = ' @StyleID = NULL '
ELSE
	SET @pStyleID = ' @StyleID = ''' +  CAST (@StyleID AS NVARCHAR(50)) + ''' '

IF @LinePlanID IS NULL
	SET @pLinePlanID = ' @LinePlanID = NULL '
ELSE
	SET @pLinePlanID = ' @LinePlanID = ''' +  CAST (@LinePlanID AS NVARCHAR(50)) + ''' '


IF @LinePlanRangeID IS NULL
	SET @pLinePlanRangeID = ' @LinePlanRangeID = NULL '
ELSE
	SET @pLinePlanRangeID = ' @LinePlanRangeID = ''' +  CAST (@LinePlanRangeID AS NVARCHAR(50)) + ''' '


IF @LinePlanAttributeItemID1 IS NULL
	SET @pLinePlanAttributeItemID1 = ' @LinePlanAttributeItemID1 = NULL '
ELSE
	SET @pLinePlanAttributeItemID1 = ' @LinePlanAttributeItemID1 = ''' +  CAST (@LinePlanAttributeItemID1 AS NVARCHAR(50)) + ''' '


IF @LinePlanAttributeItemID2 IS NULL
	SET @pLinePlanAttributeItemID2 = ' @LinePlanAttributeItemID2 = NULL '
ELSE
	SET @pLinePlanAttributeItemID2 = ' @LinePlanAttributeItemID2 = ''' +  CAST (@LinePlanAttributeItemID2 AS NVARCHAR(50)) + ''' '


IF @LinePlanAttributeItemID3 IS NULL
	SET @pLinePlanAttributeItemID3 = ' @LinePlanAttributeItemID3 = NULL '
ELSE
	SET @pLinePlanAttributeItemID3 = ' @LinePlanAttributeItemID3 = ''' +  CAST (@LinePlanAttributeItemID3 AS NVARCHAR(50)) + ''' '


IF @LinePlanAttributeItemID4 IS NULL
	SET @pLinePlanAttributeItemID4 = ' @LinePlanAttributeItemID4 = NULL '
ELSE
	SET @pLinePlanAttributeItemID4 = ' @LinePlanAttributeItemID4 = ''' +  CAST (@LinePlanAttributeItemID4 AS NVARCHAR(50)) + ''' '

IF @StyleSeasonYearID IS NULL
	SET @pStyleSeasonYearID = ' @StyleSeasonYearID = NULL '
ELSE
	SET @pStyleSeasonYearID = ' @StyleSeasonYearID = ''' +  CAST (@StyleSeasonYearID AS NVARCHAR(50)) + ''' '


IF @Cmd IS NULL
	SET @pCmd = ' @Cmd = NULL '
ELSE
	SET @pCmd = ' @Cmd = ''' +  @Cmd + ''' '



DECLARE @ServiceDate DATETIME
SET @ServiceDate = getdate()
DECLARE @ServiceQueueSql1 nvarchar(4000)

IF @StyleID IS NOT NULL
BEGIN 
	SET @ServiceQueueSql1 = 'dbo.spx_LinePlanBusinessItemLogic_UPDATE ' + 
	@pStyleQuoteItemID + ',' +  
	@pStyleID + ',' + 
	@pLinePlanID + ',' + 
	@pLinePlanRangeID + ',' + 
	@pLinePlanAttributeItemID1 + ',' + 
	@pLinePlanAttributeItemID2 + ',' + 
	@pLinePlanAttributeItemID3 + ',' + 
	@pLinePlanAttributeItemID4 + ',' + 
	@pStyleSeasonYearID 

	exec spx_ServiceQueue_INSERT @ServiceQueueSql = @ServiceQueueSql1, @ServiceQueuePriority = 1, @ServiceQueueDate = @ServiceDate
END

SET @ServiceQueueSql1 = 'dbo.spx_LinePlanBusinessItemRollup_INSERT ' + 
@pLinePlanId + ',' + 
@pLinePlanAttributeItemId1 + ',' + 
@pLinePlanAttributeItemId2 + ',' + 
@pLinePlanAttributeItemId3 + ',' + 
@pLinePlanAttributeItemId4 + ',' + 
@pCmd + ',' + 
@pStyleSeasonYearID

exec spx_ServiceQueue_INSERT @ServiceQueueSql = @ServiceQueueSql1, @ServiceQueuePriority = 1, @ServiceQueueDate = @ServiceDate




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_Control_ExchangeRateItem]'
GO
EXEC sp_refreshview N'[dbo].[vwx_Control_ExchangeRateItem]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleMaterial_Linked_DELETE]'
GO
CREATE PROCEDURE [dbo].[spx_StyleMaterial_Linked_DELETE]
(
	@StyleMaterialID uniqueidentifier
	,@StyleID uniqueidentifier
	,@StyleSet int
	,@MUser nvarchar(200)
	,@MDate datetime
)

AS 


/************************/
/*Declare variables.	*/
/************************/
DECLARE @StyleMaterialID_Param UNIQUEIDENTIFIER		--Keep a copy of the original parameter value.
DECLARE @StyleID_Param UNIQUEIDENTIFIER
DECLARE @StyleSet_Param INT
DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @MainMaterial INT

DECLARE @StyleMaterialLinkID UNIQUEIDENTIFIER			--To find the the same Material in the other Styles.

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleMaterialID_Param = @StyleMaterialID
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	,StyleMaterialID UNIQUEIDENTIFIER
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'MainMaterial' value (and 'StyleID') for checking later on.*/
SELECT @MainMaterial = MainMaterial
	,@StyleID = StyleID
	,@StyleSet = StyleSet
FROM pStyleMaterials
WHERE StyleMaterialID = @StyleMaterialID_Param


/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000' OR @MainMaterial = 1)	--Style is not Multi-Cloth linked, or this is a Main Material.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleMaterial_DELETE @StyleMaterialID_Param

	END
ELSE	--Style is Multi-Cloth linked and this is not a Main Material.
	BEGIN
		/*Clear variables.*/
		SET @StyleMaterialLinkID = NULL


		/*Get the 'StyleMaterialLinkID' value of the calling Style.*/
		SELECT @StyleMaterialLinkID = StyleMaterialLinkID
		FROM pStyleMaterials
		WHERE StyleMaterialID = @StyleMaterialID_Param


		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID


		/*Get and set the counts for the Multi-Cloth linked Styles.*/
		SELECT @TotalCount = COUNT(*) FROM #temp_Linked
		SET @RowCounter = 1


		/*Get the 'StyleMaterialID' of the Material for each of the Multi-Cloth linked Styles.*/
		WHILE(@RowCounter <= @TotalCount)
			BEGIN
				/*Clear variables.*/
				SET @StyleID = NULL
				SET @StyleSet = NULL
				SET @StyleMaterialID = NULL


				/*Get 'StyleID'.*/
				SELECT @StyleID = StyleID
					,@StyleSet = StyleSet
				FROM #temp_Linked
				WHERE TableRow = @RowCounter


				/*Get the 'StyleMaterialID'.*/
				SELECT @StyleMaterialID = StyleMaterialID
				FROM pStyleMaterials
				WHERE StyleID = @StyleID
					AND StyleSet = @StyleSet
					AND StyleMaterialLinkID = @StyleMaterialLinkID


				/*Update the temp table with the 'StyleMaterialID'.*/
				UPDATE #temp_Linked
				SET StyleMaterialID = @StyleMaterialID
				WHERE TableRow = @RowCounter


				/*Up row counter.*/
				SET @RowCounter = @RowCounter + 1
			END
	END


/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @StyleMaterialID = NULL


		/*Get the 'StyleID' for the delete.*/
		SELECT @StyleMaterialID = StyleMaterialID
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleMaterial_DELETE @StyleMaterialID


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanShowroom_Logic_CHECK_INSERT]'
GO

CREATE PROCEDURE [dbo].[spx_LinePlanShowroom_Logic_CHECK_INSERT](
@LinePlanRangeID UNIQUEIDENTIFIER,
@LinePlanID UNIQUEIDENTIFIER,
@CUser NVARCHAR(200) , 
@CDate DATETIME 
)
AS 


DECLARE @StyleID UNIQUEIDENTIFIER 
DECLARE @StyleColorID UNIQUEIDENTIFIER 
DECLARE @ShowroomID UNIQUEIDENTIFIER 
DECLARE @ROW_ID_ST INT 
DECLARE @ROW_ID_SR INT 
DECLARE @TOTAL_ST INT 
DECLARE @TOTAL_SR INT 

DECLARE @TradePartnerVendorID UNIQUEIDENTIFIER
DECLARE @Price MONEY
DECLARE @Rate MONEY

DECLARE @Season NVARCHAR(50)
DECLARE @Year NVARCHAR(50)


select  @Season = b.Season , @Year  = b.Year 
from pLinePlan b WHERE LinePlanID = @LinePlanID


create table #style (
ROW_ID INT IDENTITY (1,1),
StyleID UNIQUEIDENTIFIER,
StylecolorID UNIQUEIDENTIFIER
)




INSERT INTO #style ( StyleID, StylecolorID)
SELECT DISTINCT a.StyleID, c.StylecolorwayID 
FROM   dbo.pLinePlanItem AS a 
INNER JOIN dbo.pStyleSeasonYear AS b ON a.StyleID = b.StyleID AND a.LinePlanItemID = b.LinePlanItemID 
INNER JOIN dbo.pStyleColorwaySeasonYear AS c ON c.StyleSeasonYearID = b.StyleSeasonYearID 
WHERE a.StyleID <> '00000000-0000-0000-0000-000000000000'
AND c.SampleStatus = 200
AND a.LinePlanRangeID = @LinePlanRangeID 
AND a.StyleID  IN (
	select StyleID from pLinePlanShowroomStyleColor WHERE LinePlanRangeID = @LinePlanRangeID 
)
UNION
SELECT DISTINCT a.StyleID , a.StyleColorID 
FROM  pLinePlanShowroomStyleColor a WHERE a.LinePlanRangeID = @LinePlanRangeID

ORDER BY a.StyleID, c.StyleColorwayID



CREATE TABLE #sr  (
ROW_ID int IDENTITY (1,1),
ShowroomID UNIQUEIDENTIFIER
)

INSERT INTO #sr ( ShowroomID)
SELECT ShowroomID FROM dbo.pLinePlanShowroomItem WHERE LinePlanRangeID = @LinePlanRangeID


SET @ROW_ID_ST = 1
SELECT @TOTAL_ST  = COUNT(*) FROM  #style 

WHILE  @ROW_ID_ST <= @TOTAL_ST
BEGIN

	SELECT @StyleID = StyleID, @StyleColorID = StyleColorID
	FROM #style WHERE  ROW_ID = @ROW_ID_ST 


	SET @ROW_ID_SR = 1 
	SELECT @TOTAL_SR = COUNT(*) FROM #sr 

	WHILE  @ROW_ID_SR <= @TOTAL_SR 
	BEGIN
		SELECT @ShowroomID  = ShowroomID FROM #sr WHERE ROW_ID = @ROW_ID_SR

		DECLARE @NEWID UNIQUEIDENTIFIER 
		SET @NEWID = NEWID()


--		PRINT 'SELECT * FROM pLinePlanShowroomStyleColor WHERE LinePlanRangeID = ''' + CAST (@LinePlanRangeID AS NVARCHAR(50)) + ''' ' + 
--		' AND StyleColorID = ''' + CAST (@StyleColorID   AS NVARCHAR(50)) +  ''' ' + 
--		' AND ShowroomID  = ''' + CAST (@ShowroomID   AS NVARCHAR(50)) + ''' ' 


		IF ( SELECT COUNT(*) FROM pLinePlanShowroomStyleColor
		WHERE LinePlanRangeID = @LinePlanRangeID
		AND StyleColorID = @StyleColorID 
		AND ShowroomID  = @ShowroomID )  = 0
		BEGIN

			SET @TradePartnerVendorID = NULL 
			SET @Price = 0

			SELECT TOP 1 @Price = Price, @TradePartnerVendorID  = TradePartnerVendorID 
			FROM dbo.pLinePlanShowroomStyleColor  
			WHERE StyleID = @StyleID
			AND  LinePlanRangeID = @LinePlanRangeID
			AND StyleColorID = @StyleColorID


			INSERT INTO dbo.pLinePlanShowroomStyleColor ( LinePlanShowroomStyleColorID, LinePlanID , LinePlanRangeID , StyleID , 
			StyleColorID , ShowroomID , CUser, CDate, MUser, MDate, Price, Qty  , TradePartnerVendorID) 
			VALUES ( @NEWID , @LinePlanID , @LinePlanRangeID , @StyleID , 
			@StyleColorID , @ShowroomID , @CUser, @CDate, @CUser, @CDate, @Price, 0, @TradePartnerVendorID ) 
		END 
		ELSE
		BEGIN


			SET @Price = NULL
			SET @TradePartnerVendorID  = NULL 

			SELECT @Price  = Price, @TradePartnerVendorID = TradePartnerVendorID FROM pLinePlanShowroomStyleColor
			WHERE LinePlanRangeID = @LinePlanRangeID
			AND StyleColorID = @StyleColorID 
			AND ShowroomID  = @ShowroomID 



			IF ( @Price IS NULL OR @Price = 0 ) AND @TradePartnerVendorID IS NOT NULL 
			BEGIN
				-- Get rate for TradePartnerVendor 
				DECLARE @StyleCategoryID UNIQUEIDENTIFIER 
				SELECT @StyleCategoryID  = StyleCategory FROM pStyleHeader WHERE StyleID = @StyleID 

				IF @StyleCategoryID IS NOT NULL 
				BEGIN 

					SET @Price  = 0 
					SET @Rate  = 0 

					SELECT @Rate= d.Rate,@Price = b.Rate 
					FROM pTradePartnerVendorRate a
					INNER JOIN  pTradePartnerVendorRateItem  b ON a.TradePartnerVendorRateID = b.TradePartnerVendorRateID
					INNER JOIN pTradepartnerVendorRate c ON c.TradepartnerVendorRateID = b.TradepartnerVendorRateID 
					INNER JOIN sExchangeRateItem d ON d.ExchangeRateID = c.ExchangeRate  AND  d.CurrencyType = c.CurrencyType
					WHERE a.TradePartnerVendorID = @TradePartnerVendorID
					AND StyleCategoryID = @StyleCategoryID 
					AND a.Season = @Season 
					AND a.Year = @Year


					IF @Price IS NULL SET @Price = 0 
					IF @Rate IS NULL SET @Rate = 0 


					IF @Price > 0 
						UPDATE pLinePlanShowroomStyleColor SET Price = @Price / @Rate 
						WHERE LinePlanRangeID = @LinePlanRangeID
						AND StyleColorID = @StyleColorID
						AND ShowroomID = @ShowroomID 

				END 
			END 

		END 



		SET @ROW_ID_SR  = @ROW_ID_SR  + 1 

	END 
	SET @ROW_ID_ST  = @ROW_ID_ST  + 1 
END 

DROP TABLE #sr
DROP TABLE #style

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleMaterialSummary_DELETE]'
GO
CREATE  PROCEDURE [dbo].[spx_StyleMaterialSummary_DELETE] (
	@StyleMaterialID uniqueidentifier,
	@ModifiedBy nvarchar(200),
	@ModifiedDate datetime
)
AS 

DECLARE @StyleMaterialMasterID uniqueidentifier
DECLARE @StyleColorItemMasterId uniqueidentifier


SELECT @StyleMaterialMasterID = StyleMaterialMasterID FROM pStyleMaterials WITH (NOLOCK) WHERE (StyleMaterialID = @StyleMaterialID)

BEGIN
	SELECT @StyleColorItemMasterId = StyleColorItemMasterId FROM pStyleColorwayItem WITH (NOLOCK) WHERE (StyleMaterialID = @StyleMaterialID)
	--DELETE FROM pStyleColorwayItem WHERE (StyleColorItemMasterId = @StyleColorItemMasterId)
END

DECLARE
@MainMaterial int,
@StyleId uniqueidentifier,
@MaterialId uniqueidentifier,
@MaterialImageId uniqueidentifier,
@MaterialImageVersion int,
@MaterialNo nvarchar(50),
@MaterialName nvarchar(200),
@MaterialNull nvarchar(50)


SELECT @MainMaterial = MainMaterial, 
	@StyleId = StyleId,
	@MaterialId = MaterialId,
	@MaterialImageId = MaterialImageId,
	@MaterialImageVersion = MaterialImageVersion,
	@MaterialNo = MaterialNo,
	@MaterialName = MaterialName 
FROM pStyleMaterials WITH (NOLOCK) WHERE (StyleMaterialId = @StyleMaterialid)


IF @MainMaterial = 1
BEGIN
SET @MaterialNull = '{00000000-0000-0000-0000-000000000000}'

	DECLARE @StyleMasterId uniqueidentifier
	SELECT @StyleMasterId = StyleMasterId FROM pStyleHeader WITH (NOLOCK) WHERE StyleId = @StyleId
	
	UPDATE pStyleHeader
		SET  MaterialID = @MaterialNull, MaterialImageID = @MaterialNull, MaterialImageVersion = 0, MaterialNo = NULL, 
		MaterialName = NULL, StyleMaterialID = @MaterialNull
	WHERE  (StyleID = @StyleId)
	
	UPDATE pStyleHeader
		SET  MaterialID = @MaterialNull, MaterialImageID = @MaterialNull, MaterialImageVersion = 0, MaterialNo = NULL, 
		MaterialName = NULL, StyleMaterialID = @MaterialNull
	WHERE  (StyleMasterID = @StyleMasterId) 
	
END

/*******************************************/
/*Delete the Material from pStyleMaterials.*/
/*******************************************/
BEGIN
	--Declare variables to hold the Variation and DevelopmentID to delete material from only the active variation.
	DECLARE @Variation int
	DECLARE @StyleDevelopmentID uniqueidentifier
	
	--Get the Variation and DevelopmentID information.
	SELECT @Variation = Variation,
		@StyleDevelopmentID = StyleDevelopmentID
	FROM pStyleDevelopmentItem WITH (NOLOCK)
	WHERE StyleID = @StyleID
	
	--Delete the material(s) from the Size Class(es) in the variation.
	--Make sure to delete the material for the Size Class selected.
	DELETE FROM pStyleMaterials WHERE (StyleMaterialID = @StyleMaterialID)
	
	--Delete any other materials in this variation that were linked to this material.
	DELETE FROM pStyleMaterials	WHERE (StyleMaterialMasterID = @StyleMaterialMasterID
										AND MaterialLinked = 1
										AND StyleID IN (SELECT StyleID
														FROM pStyleDevelopmentItem WITH (NOLOCK)
														WHERE StyleDevelopmentID = @StyleDevelopmentID
																AND Variation = @Variation))
END





/*=================================================================================================================================================================================
-- DELET MATERIAL FROM STYLE SOURCING AND MATERIAL SAMPLE REQUEST
=================================================================================================================================================================================*/

DELETE FROM pSampleRequestMaterial WHERE StyleMaterialID = @StyleMaterialID 
DELETE FROM pStyleSourcingItem WHERE StyleMaterialID = @StyleMaterialID



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rpx_Showroom_Alloc_SELECT]'
GO
CREATE PROCEDURE [dbo].[rpx_Showroom_Alloc_SELECT]
(
	@LinePlanName nvarchar(200) = NULL,
	@season nvarchar (200) = NULL,
	@year nvarchar (5) = NULL,
	@attribute nvarchar (200) = null,
    @COLLECTION NVARCHAR(200) = NULL,
	@division nvarchar (200) = NULL,
	@brand nvarchar (200) = NULL,
	@prodcat nvarchar (200) = NULL,
	@VENDORNAME	NVARCHAR (200) = NULL
	
)
AS

--------/*Testing*/
--DECLARE @LinePlanname nvarchar(200)
--DECLARE @SEASON NVARCHAR(200)
--DECLARE @YEAR NVARCHAR(5)
--DECLARE @COLLECTION NVARCHAR(200)
--DECLARE @ATTRIBUTE NVARCHAR (200)
--DECLARE @division nvarchar (200)
--DECLARE @brand nvarchar (200)
--DECLARE @prodcat nvarchar (200)
--DECLARE @VENDORNAME NVARCHAR(200)
--SET 	@lineplanname = 'non-apparel 2010'
--SET		@SEASON='autumn winter'
--SET		@YEAR='2010'
--SET		@COLLECTION='autumn'
--SET		@ATTRIBUTE='MEGA CHECK'
--SET		@DIVISION='WOMENSWEAR'
--SET		@BRAND='W LONDON COLLECTION'
--SET		@PRODCAT='W LON rainwear'
--SET		@VENDORNAME='SABATINI EU'


/*Set default values for blank parameters.*/
IF(@LinePlanname IS NULL OR @LinePlanname = '')
	BEGIN
		SET @LinePlanname = '(ALL)'
	END

IF(@Season IS NULL OR @Season = '')
	BEGIN
		SET @Season = '(ALL)'
	END

IF(@Year IS NULL OR @Year = '')
	BEGIN
		SET @Year = '(ALL)'
	END

IF(@Collection IS NULL OR @Collection = '')
	BEGIN
		SET @Collection = '(ALL)'
	END

IF(@ATTRIBUTE IS NULL OR @ATTRIBUTE = '')
	BEGIN
		SET @ATTRIBUTE = '(ALL)'
	END

IF(@DIVISION IS NULL OR @DIVISION = '')
	BEGIN
		SET @DIVISION = '(ALL)'
	END

IF(@BRAND IS NULL OR @BRAND = '')
	BEGIN
		SET @BRAND = '(ALL)'
	END

IF(@PRODCAT IS NULL OR @PRODCAT = '')
	BEGIN
		SET @PRODCAT = '(ALL)'
	END

IF(@VENDORNAME IS NULL OR @VENDORNAME = '')
	BEGIN
		SET @VENDORNAME = '(ALL)'
	END

DECLARE @ImageFolder varchar(200)

/*Set the path for the image.*/
SET @ImageFolder = (SELECT TOP 1 SettingValue FROM rReportSetting WITH (NOLOCK) WHERE SettingType = 'ImagePath')

select 
a12.customkey+'  '+pcat.stylecategory as 'MAT GRP',
a12.purchase AS 'PURCH GRP',
psc.plmcode as 'PLMid',
case 
when A12.PRODUCTPREFIX='A' AND a12.CUSTOMSORT<>'SOFT'
THEN
a12.ProductPrefix+':'+a12.accabrev+' '+upper(pSH.Description)+' '+
CASE
WHEN PLAT1.ATTRIBUTENAME IS NOT NULL
THEN PLAT1.SAPCODE
ELSE CASE
WHEN PLAT2.ATTRIBUTENAME IS NOT NULL
THEN PLAT2.SAPCODE
ELSE ''
END 
END
/*upper(Xcustom55.SAPcode)*/+':'+pm.MaterialCode+':'+pSC.StyleColorNo 
ELSE
CASE
WHEN A12.PRODUCTPREFIX='A' AND a12.CUSTOMSORT='SOFT'
THEN a12.ProductPrefix+':'+a12.accabrev+' '+upper(pSH.Description)+':'+ pm.MaterialCode+':'+pSC.StyleColorNo
else
case when a12.productprefix='W'
then (A12.PRODUCTPREFIX+':'+REPLACE(UPPER(PSH.DESCRIPTION),' ','')+':'+PM.MATERIALCODE+':'+PSC.STYLECOLORNO) 
else (A12.PRODUCTPREFIX+':'+upper(PSH.DESCRIPTION)+':'+PM.MATERIALCODE+':'+PSC.STYLECOLORNO) 
end
end
end
AS 'DESCRIPTION',
--a12.productprefix+':'+REPLACE(UPPER(PSH.DESCRIPTION),' ','')+':'+pm.MaterialCode +':'+psc.stylecolorno as 'DESCRIPTION',
	CASE	--Comment #02
		WHEN pStyleSpecSize.Sel0 = 1	THEN pStyleSpecSize.Size0
		WHEN pStyleSpecSize.Sel1 = 1	THEN pStyleSpecSize.Size1
		WHEN pStyleSpecSize.Sel2 = 1	THEN pStyleSpecSize.Size2
		WHEN pStyleSpecSize.Sel3 = 1	THEN pStyleSpecSize.Size3
		WHEN pStyleSpecSize.Sel4 = 1	THEN pStyleSpecSize.Size4
		WHEN pStyleSpecSize.Sel5 = 1	THEN pStyleSpecSize.Size5
		WHEN pStyleSpecSize.Sel6 = 1	THEN pStyleSpecSize.Size6
		WHEN pStyleSpecSize.Sel7 = 1	THEN pStyleSpecSize.Size7
		WHEN pStyleSpecSize.Sel8 = 1	THEN pStyleSpecSize.Size8
		WHEN pStyleSpecSize.Sel9 = 1	THEN pStyleSpecSize.Size9
		WHEN pStyleSpecSize.Sel10 = 1	THEN pStyleSpecSize.Size10
		WHEN pStyleSpecSize.Sel11 = 1	THEN pStyleSpecSize.Size11
		WHEN pStyleSpecSize.Sel12 = 1	THEN pStyleSpecSize.Size12
		WHEN pStyleSpecSize.Sel13 = 1	THEN pStyleSpecSize.Size13
		WHEN pStyleSpecSize.Sel14 = 1	THEN pStyleSpecSize.Size14
		WHEN pStyleSpecSize.Sel15 = 1	THEN pStyleSpecSize.Size15
		WHEN pStyleSpecSize.Sel16 = 1	THEN pStyleSpecSize.Size16
		WHEN pStyleSpecSize.Sel17 = 1	THEN pStyleSpecSize.Size17
		WHEN pStyleSpecSize.Sel18 = 1	THEN pStyleSpecSize.Size18
		WHEN pStyleSpecSize.Sel19 = 1	THEN pStyleSpecSize.Size19
	END AS 'DEFAULT GRID VALUE',
psc.sapcode AS 'SAP NO',
psc.stylecolorno as 'NRF Colour',
psh.styleno as 'styleno',
tpv.vendorcode+'   '+vendorname as 'VENDOR',
ps.customkey AS 'SHOWROOM CODE',
upper(psc.stylecolorname) as 'colorname',
ps.custom AS 'SHOWROOM NAME',
plsc.qty AS 'QTY',
TPVRI.RATE AS 'PRICE',
plp.description as 'LINE PLAN NAME',
PLP.SEASON AS 'SEASON',
PLP.YEAR AS 'YEAR',
x64.custOm as 'COLLECTION',
PSH.CUSTOMFIELD2 AS 'DIVISION',
PSH.CUSTOMFIELD3 AS 'BRAND',
pcat.stylecategory as 'PRODUCT CATEGORY',
pm.a as 'MAIN MATERIAL DESC',
PM.MATERIALCODE AS 'FABRIC CODE',
tpv.currencytype as 'CCY',
psh.customfield10 as 'attribute',
PLAT1.*,PLAT2.*
,@IMAGEFOLDER+'/{'+CAST(hi.IMAGEID AS VARCHAR (255))+'}/VERSION/000/{'+
CAST(hi.IMAGEHISTORYID AS VARCHAR(255))+'}.jpG' AS 'filepath'
from plineplan plp 
left outer join plineplanitem plpi on plpi.lineplanid=plp.lineplanid
left outer join pstyleheader psh on psh.styleid=plpi.styleid
left outer join acustom12 a12 on a12.custom=psh.customfield4
left outer JOIN pStyleSpecSize ON	pSh.StyleID = pStyleSpecSize.StyleID
left outer join pstylecolorway psc on psc.styleid=psh.styleid
left outer join pstylecolorwayseasonyear pscsy on pscsy.styleid=psc.styleid and pscsy.stylecolorwayid=psc.stylecolorid
left outer join pstylecategory pcat on pcat.stylecategoryid=psh.stylecategory
left outer join plineplanshowroomstylecolor plsc on plsc.lineplanid=plp.lineplanid and plsc.stylecolorid=psc.stylecolorid
left outer join utradepartnervendor tpv on tpv.tradepartnervendorid=plsc.tradepartnervendorid 
LEFT OUTER JOIN PTRADEPARTNERVENDORRATE TPVR ON TPVR.TRADEPARTNERVENDORID=PLSC.TRADEPARTNERVENDORID AND TPVR.SEASON=PLP.SEASON AND TPVR.YEAR=PLP.YEAR
LEFT OUTER JOIN PTRADEPARTNERVENDORRATEITEM TPVRI ON TPVRI.TRADEPARTNERVENDORRATEID=TPVR.TRADEPARTNERVENDORRATEID AND PCAT.STYLECATEGORYID=TPVRI.STYLECATEGORYID
LEFT OUTER JOIN PLINEPLANSTYLEATTRIBUTETYPE1 PLAT1 ON PLAT1.ATTRIBUTENAME=PSH.CUSTOMFIELD10
LEFT OUTER JOIN PLINEPLANSTYLEATTRIBUTETYPE2 PLAT2 ON PLAT2.ATTRIBUTENAME=PSH.CUSTOMFIELD10
inner join pshowroom ps on ps.customid=plsc.showroomid
left outer join xcustom64 x64 on x64.customkey=pscsy.customfield1
LEFT OUTER JOIN PMATERIAL PM ON PM.MATERIALNO=PSH.MATERIALNO
	LEFT OUTER JOIN hImage hi ON psh.DesignSketchID = hi.ImageID
						AND psh.DesignSketchVersion = hi.Version
where 
(plp.DESCRIPTION=@LinePlanNAME OR @LinePlanname = '(ALL)')
	AND (PLP.SEASON=@SEASON OR @Season = '(ALL)')
	AND (PLP.[YEAR]=@YEAR OR @Year = '(ALL)')
	AND (X64.CUSTOM=@COLLECTION OR @COLLECTION='(all)')
	and (psh.customfield10=@ATTRIBUTE OR @ATTRIBUTE='(ALL)')
	AND (PSH.CUSTOMFIELD2=@DIVISION OR @DIVISION='(ALL)')
	AND (PSH.CUSTOMFIELD3=@BRAND OR @BRAND='(ALL)')
	AND (PCAT.STYLECATEGORY=@PRODCAT OR @PRODCAT='(ALL)')
	AND (TPV.VENDORNAME=@VENDORNAME OR @VENDORNAME='(ALL)')
and plsc.qty<>'0'

ORDER BY a12.productprefix+psh.description+psh.materialno+psc.stylecolorno+psc.stylecolorno


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Refreshing [dbo].[vwx_LinePlanTradePartnerItem_SEL]'
GO
EXEC sp_refreshview N'[dbo].[vwx_LinePlanTradePartnerItem_SEL]'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleMaterial_Replace_UPDATE]'
GO


CREATE PROCEDURE [dbo].[spx_StyleMaterial_Replace_UPDATE](
@StyleMaterialID UNIQUEIDENTIFIER,
@NewMaterialID UNIQUEIDENTIFIER,
@MUser NVARCHAR(200),
@MDate DATETIME 
)
AS

DECLARE @StyleID UNIQUEIDENTIFIER 
DECLARE @RATING NVARCHAR(18) 
DECLARE @MaterialSize NVARCHAR(200)
DECLARE @MaterialSizeID UNIQUEIDENTIFIER 
DECLARE @UOM NVARCHAR(50)
DECLARE @Colorway INT
DECLARE @Placement NVARCHAR(4000)
DECLARE @MaterialSort NVARCHAR(5)
DECLARE @StyleSet INT
DECLARE @MainMaterial INT 

/***
** Get current values
***/
SELECT @RATING = Qty, @MaterialSize = MaterialSize, 
@UOM  = UOM, @Colorway = Colorway, @Placement = Placement,
@MaterialSort =  MaterialSort, @StyleID = StyleID, @StyleSet = StyleSet, @MainMaterial  = MainMaterial 
FROM pStyleMaterials WHERE StyleMaterialID  = @StyleMaterialID




/***
** Check if the current Size is avaliable in the new Material 
***/
SELECT @MaterialSizeID  = MaterialSizeID 
FROM pMaterialSize 
WHERE MaterialID = @NewMaterialID
AND MaterialSize = @MaterialSize 

IF @MaterialSizeID IS NULL 
BEGIN
	SET @MaterialSizeID = '00000000-0000-0000-0000-000000000000'
	SET @MaterialSize = '*NA'
END 


/***
** Delete stylematerial to be replaced
***/
EXEC spx_StyleMaterial_DELETE @StyleMaterialID = @StyleMaterialID 


/***
** Insert new Material 
***/
DECLARE @NewStyleMaterialID UNIQUEIDENTIFIER
SET @NewStyleMaterialID = NEWID()

EXEC spx_StyleMaterialTemp_INSERT 
@MainMaterial =  @MainMaterial , @StyleID = @StyleID, 
@StyleMaterialID  = @NewStyleMaterialID, @StyleSet = @StyleSet, 
@MaterialID = @NewMaterialID, @CreatedBy = @MUser, @CreatedDate = @MDate,
@TradePartnerVendorID = NULL


UPDATE pStyleMaterialTemp  
SET Qty = @RATING, MaterialSize = @MaterialSize, MaterialSizeID = @MaterialSizeID,
UOM = @UOM, Colorway = @Colorway, Placement = @Placement,
MaterialSort = @MaterialSort
WHERE StyleMaterialID = @NewStyleMaterialID


EXEC spx_StyleMaterialPending_INSERT @StyleMaterialID = @NewStyleMaterialID,    
@StyleID = @StyleID, @StyleSet = @StyleSet, @CreatedDate = @MDate, @CreatedBy = @MUser




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleColorwayDeliveryStatus_INSERT]'
GO



ALTER  PROCEDURE [dbo].[spx_StyleColorwayDeliveryStatus_INSERT](
@StyleColorID UNIQUEIDENTIFIER , 
@StyleID UNIQUEIDENTIFIER,
@StyleColorDel1 INT,
@StyleColorDel2 INT,
@StyleColorDel3 INT,
@StyleColorDel4 INT,
@MUser VARCHAR(200), 
@MDate DATETIME, 
@StyleColorCollection NVARCHAR(200) ,
@Units INT,
@SeasonYearID UNIQUEIDENTIFIER ,
@ColorType NVARCHAR(5),
@SampleStatus INT,
@ProdStatus INT,
@outputMsg VARCHAR(8000) = null output 
)
AS

DECLARE @StyleColorName NVARCHAR(200)
DECLARE @Msg NVARCHAR(4000)
DECLARE @ColorDescription NVARCHAR(500)
DECLARE @StyleNo NVARCHAR(50)

SET @Msg = ''

SELECT @StyleColorName = StyleColorName FROM pStyleColorway WHERE StyleColorID = @StyleColorID 
IF @StyleColorName IS NULL 
	SET @StyleColorName = ''


set @ColorDescription = ''

SELECT @StyleNo = StyleNo  FROM pStyleHeader WHERE StyleID = @StyleID
IF @StyleNo IS NOT NULL 
	SET @ColorDescription = 'StyleNo: (' + @StyleNo  + ')' +  '<br/>'
SET @ColorDescription =  @ColorDescription + 'Colour Name: ' + @StyleColorName + '<br/>'




IF @SampleStatus = 200 OR  @ProdStatus = 200 OR @SampleStatus = 300 OR  @ProdStatus = 300 
BEGIN 

	IF LEN (@StyleColorCollection) = 0
		SET @Msg = @Msg + 'Collection not defined<br/> '

	IF LEN (@ColorType) = 0
		SET @Msg = @Msg + 'R/S/F not defined<br/> '

	-- CHECK FOR MAIN MATERIAL AND COMPOSITION 
	
	IF ( SELECT COUNT(*) FROM  pStyleMaterials a 
		WHERE a.StyleID = @StyleID
		AND a.MainMaterial = 1 ) = 0 
			SET @Msg = @Msg + 'Style Main Material not defined<br/>'
	ELSE
	BEGIN

		IF ( SELECT COUNT(*)
		FROM pStylematerials a
		INNER JOIN pMaterialContent b ON  a.MaterialID = b.MaterialID 
		WHERE a.StyleID = @StyleID
		AND a.MainMaterial = 1
		AND LEN (ISNULL ( b.MaterialContentName , '')) > 0  ) = 0
			SET @Msg = @Msg + 'Main Material Composition not defined<br/>'
			
	END 

	--  CHECK FOR StyleHeader fields 
	IF LEN(@Msg) = 0 
		EXEC dbo.spx_StyleStatus_Logic_UPDATE @StyleID=@StyleID,
		@StatusID=1,@MUser=@MUser, @MDate=@MDate, @OUT=0, @MSG=@Msg OUTPUT 


	-- CHECK FOR Sourcing / MostLikely Vendor 
	IF ( SELECT COUNT(*) FROM pStyleSourcing a 
		INNER JOIN pStyleSeasonYear b ON a.StyleSeasonYearID = b.StyleSeasonYearID 
		WHERE a.StyleID = @StyleID
		AND b.SeasonYearID = @SeasonYearID 
		AND b.TradePartnerVendorID IS NOT NULL
		) = 0 
		SET @Msg = @Msg + 'Most Likely Vendor not defined<br/>'
END 

IF LEN (@Msg) = 0
BEGIN 

	DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER 

	SET @StyleColorDel4 = 0
	
	IF @StyleColorDel1 = 1 
		SELECT @StyleColorDel2=1, @StyleColorDel3=1 
	ELSE IF @StyleColorDel2 = 1 
		SET @StyleColorDel3 = 1


	SELECT @StyleSeasonYearID = StyleSeasonYearID  
	FROM  pStyleSeasonYear
	WHERE SeasonYearID = @SeasonYearID 
	AND StyleID = @StyleID 

	UPDATE pStyleColorwaySeasonYear SET
		StyleColorDelivery1 = @StyleColorDel1, 
		StyleColorDelivery2 = @StyleColorDel2, 
		StyleColorDelivery3 = @StyleColorDel3,
		StyleColorDelivery4 = @StyleColorDel4,
		StyleColorStatus = @ProdStatus,
		CustomField1 = @StyleColorCollection,
		Units = @Units,
		ColorType = @ColorType,
		SampleStatus = @SampleStatus
	WHERE StyleID = @StyleID 
	AND StyleColorwayID = @StyleColorID 
	AND StyleSeasonYearID = @StyleSeasonYearID



END 


IF LEN (@Msg) > 0 
	SET @Msg = @ColorDescription + ' ' +  @Msg  

IF @outputMsg IS NULL 
	SELECT @Msg as [Message]
ELSE
	SET @outputMsg = @Msg









GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_BodyDevelopmentSpecVariation_INSERT]'
GO


CREATE    PROCEDURE [dbo].[spx_BodyDevelopmentSpecVariation_INSERT]  
(  
@BodyID uniqueidentifier,  
@NewBodyID nvarchar(50),  
@CreatedBy nvarchar(50),  
@CreatedDate nvarchar(50)  
)  
AS  
  
SET NOCOUNT ON  
  
  
DECLARE @POMTempItemID varchar(50)  
DECLARE @POMTempID varchar(50)  
DECLARE @Row_Count int  
DECLARE @Row_Loop int  
DECLARE @Size0 nvarchar (7), @SizeRange nvarchar(50), @SizeClass nvarchar(50),  
@Size1 nvarchar (7), @Size2 nvarchar (7), @Size3 nvarchar (7), @Size4 nvarchar (7),  
@Size5 nvarchar (7), @Size6 nvarchar (7), @Size7 nvarchar (7), @Size8 nvarchar (7),   
@Size9 nvarchar (7), @Size10 nvarchar (7), @Size11 nvarchar (7), @Size12 nvarchar (7),  
@Size13 nvarchar (7), @Size14 nvarchar (7), @Size15 nvarchar (7), @Size16 nvarchar (7),  
@Size17 nvarchar (7), @Size18 nvarchar (7), @Size19 nvarchar (7), @sort varchar(5)  
  
  
BEGIN  
CREATE TABLE #tempBodySpec1 (  
 RecID int IDENTITY(1,1)  NOT NULL,  
 SpecID  uniqueidentifier,  
 SpecMasterID uniqueidentifier,  
 BodyID uniqueidentifier,  
 POMTempItemID uniqueidentifier,  
 POMLibraryID uniqueidentifier,  
 POMTempID uniqueidentifier,  
 BodySet int,  
 Critical int,  
 POM nvarchar (10),  
 PointMeasur nvarchar (225),  
 TOL numeric(18, 4) NOT NULL ,  
 TOLN numeric(18, 4) NOT NULL ,  
 Spec decimal(18, 4) NOT NULL ,  
 Proto0 numeric(18, 4) NOT NULL ,  
 Proto1 numeric(18, 4) NOT NULL ,  
 Proto2 numeric(18, 4) NOT NULL ,  
 Proto3 numeric(18, 4) NOT NULL ,  
 Proto4 numeric(18, 4) NOT NULL ,  
 Proto5 numeric(18, 4) NOT NULL ,  
 Proto6 numeric(18, 4) NOT NULL ,  
 Proto7 numeric(18, 4) NOT NULL ,  
 Proto8 numeric(18, 4) NOT NULL ,  
 Proto9 numeric(18, 4) NOT NULL ,  
 Proto10 numeric(18, 0) NOT NULL ,  
 Proto11 numeric(18, 0) NOT NULL ,  
 Proto12 numeric(18, 4) NOT NULL ,  
 Proto13 numeric(18, 4) NOT NULL ,  
 Proto14 numeric(18, 4) NOT NULL ,  
 Proto15 numeric(18, 4) NOT NULL ,  
 Proto16 numeric(18, 4) NOT NULL ,  
 Proto17 numeric(18, 4) NOT NULL ,  
 Proto18 numeric(18, 4) NOT NULL ,  
 Proto19 numeric(18, 4) NOT NULL ,  
 Grade0 numeric(18, 4) NOT NULL ,  
 Grade1 numeric(18, 4) NOT NULL ,  
 Grade2 numeric(18, 4) NOT NULL ,  
 Grade3 numeric(18, 4) NOT NULL ,  
 Grade4 numeric(18, 4) NOT NULL ,  
 Grade5 numeric(18, 4) NOT NULL ,  
 Grade6 numeric(18, 4) NOT NULL ,  
 Grade7 numeric(18, 4) NOT NULL ,  
 Grade8 numeric(18, 4) NOT NULL ,  
 Grade9 numeric(18, 4) NOT NULL ,  
 Grade10 numeric(18, 4) NOT NULL ,  
 Grade11 numeric(18, 4) NOT NULL ,  
 Grade12 numeric(18, 4) NOT NULL ,  
 Grade13 numeric(18, 4) NOT NULL ,  
 Grade14 numeric(18, 4) NOT NULL ,  
 Grade15 numeric(18, 4) NOT NULL ,  
 Grade16 numeric(18, 4) NOT NULL ,  
 Grade17 numeric(18, 4) NOT NULL ,  
 Grade18 numeric(18, 4) NOT NULL ,  
 Grade19 numeric(18, 4) NOT NULL ,  
 Size0 numeric(18, 4) NOT NULL ,  
 Size1 numeric(18, 4) NOT NULL ,  
 Size2 numeric(18, 4) NOT NULL ,  
 Size3 numeric(18, 4) NOT NULL ,  
 Size4 numeric(18, 4) NOT NULL ,  
 Size5 numeric(18, 4) NOT NULL ,  
 Size6 numeric(18, 4) NOT NULL ,  
 Size7 numeric(18, 4) NOT NULL ,  
 Size8 numeric(18, 4) NOT NULL ,  
 Size9 numeric(18, 4) NOT NULL ,  
 Size10 numeric(18, 4) NOT NULL ,  
 Size11 numeric(18, 4) NOT NULL ,  
 Size12 numeric(18, 4) NOT NULL ,  
 Size13 numeric(18, 4) NOT NULL ,  
 Size14 numeric(18, 4) NOT NULL ,  
 Size15 numeric(18, 4) NOT NULL ,  
 Size16 numeric(18, 4) NOT NULL ,  
 Size17 numeric(18, 4) NOT NULL ,  
 Size18 numeric(18, 4) NOT NULL ,  
 Size19 numeric(18, 4) NOT NULL ,  
 CDate datetime,  
 CUser nvarchar (200),  
 MDate datetime,  
 MUser nvarchar (200),  
 Change int,  
 Sort nvarchar (5),  
 HowToMeasurText nvarchar (4000),  
 HowToMeasurImage nvarchar (100)    
)   
END  
  
BEGIN  
CREATE TABLE #tempBodySpec2 (  
 RecID int IDENTITY(1,1)  NOT NULL,  
 SpecID  uniqueidentifier,  
 SpecMasterID uniqueidentifier,  
 BodyID uniqueidentifier,  
 POMTempItemID uniqueidentifier,  
 POMLibraryID uniqueidentifier,  
 POMTempID uniqueidentifier,  
 BodySet int,  
 Critical int,  
 POM nvarchar (10),  
 PointMeasur nvarchar (225),  
 TOL numeric(18, 4) NOT NULL ,  
 TOLN numeric(18, 4) NOT NULL ,  
 Spec decimal(18, 4) NOT NULL ,  
 Proto0 numeric(18, 4) NOT NULL ,  
 Proto1 numeric(18, 4) NOT NULL ,  
 Proto2 numeric(18, 4) NOT NULL ,  
 Proto3 numeric(18, 4) NOT NULL ,  
 Proto4 numeric(18, 4) NOT NULL ,  
 Proto5 numeric(18, 4) NOT NULL ,  
 Proto6 numeric(18, 4) NOT NULL ,  
 Proto7 numeric(18, 4) NOT NULL ,  
 Proto8 numeric(18, 4) NOT NULL ,  
 Proto9 numeric(18, 4) NOT NULL ,  
 Proto10 numeric(18, 0) NOT NULL ,  
 Proto11 numeric(18, 0) NOT NULL ,  
 Proto12 numeric(18, 4) NOT NULL ,  
 Proto13 numeric(18, 4) NOT NULL ,  
 Proto14 numeric(18, 4) NOT NULL ,  
 Proto15 numeric(18, 4) NOT NULL ,  
 Proto16 numeric(18, 4) NOT NULL ,  
 Proto17 numeric(18, 4) NOT NULL ,  
 Proto18 numeric(18, 4) NOT NULL ,  
 Proto19 numeric(18, 4) NOT NULL ,  
 Grade0 numeric(18, 4) NOT NULL ,  
 Grade1 numeric(18, 4) NOT NULL ,  
 Grade2 numeric(18, 4) NOT NULL ,  
 Grade3 numeric(18, 4) NOT NULL ,  
 Grade4 numeric(18, 4) NOT NULL ,  
 Grade5 numeric(18, 4) NOT NULL ,  
 Grade6 numeric(18, 4) NOT NULL ,  
 Grade7 numeric(18, 4) NOT NULL ,  
 Grade8 numeric(18, 4) NOT NULL ,  
 Grade9 numeric(18, 4) NOT NULL ,  
 Grade10 numeric(18, 4) NOT NULL ,  
 Grade11 numeric(18, 4) NOT NULL ,  
 Grade12 numeric(18, 4) NOT NULL ,  
 Grade13 numeric(18, 4) NOT NULL ,  
 Grade14 numeric(18, 4) NOT NULL ,  
 Grade15 numeric(18, 4) NOT NULL ,  
 Grade16 numeric(18, 4) NOT NULL ,  
 Grade17 numeric(18, 4) NOT NULL ,  
 Grade18 numeric(18, 4) NOT NULL ,  
 Grade19 numeric(18, 4) NOT NULL ,  
 Size0 numeric(18, 4) NOT NULL ,  
 Size1 numeric(18, 4) NOT NULL ,  
 Size2 numeric(18, 4) NOT NULL ,  
 Size3 numeric(18, 4) NOT NULL ,  
 Size4 numeric(18, 4) NOT NULL ,  
 Size5 numeric(18, 4) NOT NULL ,  
 Size6 numeric(18, 4) NOT NULL ,  
 Size7 numeric(18, 4) NOT NULL ,  
 Size8 numeric(18, 4) NOT NULL ,  
 Size9 numeric(18, 4) NOT NULL ,  
 Size10 numeric(18, 4) NOT NULL ,  
 Size11 numeric(18, 4) NOT NULL ,  
 Size12 numeric(18, 4) NOT NULL ,  
 Size13 numeric(18, 4) NOT NULL ,  
 Size14 numeric(18, 4) NOT NULL ,  
 Size15 numeric(18, 4) NOT NULL ,  
 Size16 numeric(18, 4) NOT NULL ,  
 Size17 numeric(18, 4) NOT NULL ,  
 Size18 numeric(18, 4) NOT NULL ,  
 Size19 numeric(18, 4) NOT NULL ,  
 CDate datetime,  
 CUser nvarchar (200),  
 MDate datetime,  
 MUser nvarchar (200),  
 Change int,  
 Sort nvarchar (5),  
 HowToMeasurText nvarchar (4000),  
 HowToMeasurImage nvarchar (100)    
)   
END  
  
BEGIN  
CREATE TABLE #tempBodySpec3 (  
 RecID int IDENTITY(1,1)  NOT NULL,  
 SpecID  uniqueidentifier,  
 SpecMasterID uniqueidentifier,  
 BodyID uniqueidentifier,  
 POMTempItemID uniqueidentifier,  
 POMLibraryID uniqueidentifier,  
 POMTempID uniqueidentifier,  
 BodySet int,  
 Critical int,  
 POM nvarchar (10),  
 PointMeasur nvarchar (225),  
 TOL numeric(18, 4) NOT NULL ,  
 TOLN numeric(18, 4) NOT NULL ,  
 Spec decimal(18, 4) NOT NULL ,  
 Proto0 numeric(18, 4) NOT NULL ,  
 Proto1 numeric(18, 4) NOT NULL ,  
 Proto2 numeric(18, 4) NOT NULL ,  
 Proto3 numeric(18, 4) NOT NULL ,  
 Proto4 numeric(18, 4) NOT NULL ,  
 Proto5 numeric(18, 4) NOT NULL ,  
 Proto6 numeric(18, 4) NOT NULL ,  
 Proto7 numeric(18, 4) NOT NULL ,  
 Proto8 numeric(18, 4) NOT NULL ,  
 Proto9 numeric(18, 4) NOT NULL ,  
 Proto10 numeric(18, 0) NOT NULL ,  
 Proto11 numeric(18, 0) NOT NULL ,  
 Proto12 numeric(18, 4) NOT NULL ,  
 Proto13 numeric(18, 4) NOT NULL ,  
 Proto14 numeric(18, 4) NOT NULL ,  
 Proto15 numeric(18, 4) NOT NULL ,  
 Proto16 numeric(18, 4) NOT NULL ,  
 Proto17 numeric(18, 4) NOT NULL ,  
 Proto18 numeric(18, 4) NOT NULL ,  
 Proto19 numeric(18, 4) NOT NULL ,  
 Grade0 numeric(18, 4) NOT NULL ,  
 Grade1 numeric(18, 4) NOT NULL ,  
 Grade2 numeric(18, 4) NOT NULL ,  
 Grade3 numeric(18, 4) NOT NULL ,  
 Grade4 numeric(18, 4) NOT NULL ,  
 Grade5 numeric(18, 4) NOT NULL ,  
 Grade6 numeric(18, 4) NOT NULL ,  
 Grade7 numeric(18, 4) NOT NULL ,  
 Grade8 numeric(18, 4) NOT NULL ,  
 Grade9 numeric(18, 4) NOT NULL ,  
 Grade10 numeric(18, 4) NOT NULL ,  
 Grade11 numeric(18, 4) NOT NULL ,  
 Grade12 numeric(18, 4) NOT NULL ,  
 Grade13 numeric(18, 4) NOT NULL ,   Grade14 numeric(18, 4) NOT NULL ,  
 Grade15 numeric(18, 4) NOT NULL ,  
 Grade16 numeric(18, 4) NOT NULL ,  
 Grade17 numeric(18, 4) NOT NULL ,  
 Grade18 numeric(18, 4) NOT NULL ,  
 Grade19 numeric(18, 4) NOT NULL ,  
 Size0 numeric(18, 4) NOT NULL ,  
 Size1 numeric(18, 4) NOT NULL ,  
 Size2 numeric(18, 4) NOT NULL ,  
 Size3 numeric(18, 4) NOT NULL ,  
 Size4 numeric(18, 4) NOT NULL ,  
 Size5 numeric(18, 4) NOT NULL ,  
 Size6 numeric(18, 4) NOT NULL ,  
 Size7 numeric(18, 4) NOT NULL ,  
 Size8 numeric(18, 4) NOT NULL ,  
 Size9 numeric(18, 4) NOT NULL ,  
 Size10 numeric(18, 4) NOT NULL ,  
 Size11 numeric(18, 4) NOT NULL ,  
 Size12 numeric(18, 4) NOT NULL ,  
 Size13 numeric(18, 4) NOT NULL ,  
 Size14 numeric(18, 4) NOT NULL ,  
 Size15 numeric(18, 4) NOT NULL ,  
 Size16 numeric(18, 4) NOT NULL ,  
 Size17 numeric(18, 4) NOT NULL ,  
 Size18 numeric(18, 4) NOT NULL ,  
 Size19 numeric(18, 4) NOT NULL ,  
 CDate datetime,  
 CUser nvarchar (200),  
 MDate datetime,  
 MUser nvarchar (200),  
 Change int,  
 Sort nvarchar (5),  
 HowToMeasurText nvarchar (4000),  
 HowToMeasurImage nvarchar (100)    
)   
END  
  
BEGIN  
CREATE TABLE #tempBodySpec4 (  
 RecID int IDENTITY(1,1)  NOT NULL,  
 SpecID  uniqueidentifier,  
 SpecMasterID uniqueidentifier,  
 BodyID uniqueidentifier,  
 POMTempItemID uniqueidentifier,  
 POMLibraryID uniqueidentifier,  
 POMTempID uniqueidentifier,  
 BodySet int,  
 Critical int,  
 POM nvarchar (10),  
 PointMeasur nvarchar (225),  
 TOL numeric(18, 4) NOT NULL ,  
 TOLN numeric(18, 4) NOT NULL ,  
 Spec decimal(18, 4) NOT NULL ,  
 Proto0 numeric(18, 4) NOT NULL ,  
 Proto1 numeric(18, 4) NOT NULL ,  
 Proto2 numeric(18, 4) NOT NULL ,  
 Proto3 numeric(18, 4) NOT NULL ,  
 Proto4 numeric(18, 4) NOT NULL ,  
 Proto5 numeric(18, 4) NOT NULL ,  
 Proto6 numeric(18, 4) NOT NULL ,  
 Proto7 numeric(18, 4) NOT NULL ,  
 Proto8 numeric(18, 4) NOT NULL ,  
 Proto9 numeric(18, 4) NOT NULL ,  
 Proto10 numeric(18, 0) NOT NULL ,  
 Proto11 numeric(18, 0) NOT NULL ,  
 Proto12 numeric(18, 4) NOT NULL ,  
 Proto13 numeric(18, 4) NOT NULL ,  
 Proto14 numeric(18, 4) NOT NULL ,  
 Proto15 numeric(18, 4) NOT NULL ,  
 Proto16 numeric(18, 4) NOT NULL ,  
 Proto17 numeric(18, 4) NOT NULL ,  
 Proto18 numeric(18, 4) NOT NULL ,  
 Proto19 numeric(18, 4) NOT NULL ,  
 Grade0 numeric(18, 4) NOT NULL ,  
 Grade1 numeric(18, 4) NOT NULL ,  
 Grade2 numeric(18, 4) NOT NULL ,  
 Grade3 numeric(18, 4) NOT NULL ,  
 Grade4 numeric(18, 4) NOT NULL ,  
 Grade5 numeric(18, 4) NOT NULL ,  
 Grade6 numeric(18, 4) NOT NULL ,  
 Grade7 numeric(18, 4) NOT NULL ,  
 Grade8 numeric(18, 4) NOT NULL ,  
 Grade9 numeric(18, 4) NOT NULL ,  
 Grade10 numeric(18, 4) NOT NULL ,  
 Grade11 numeric(18, 4) NOT NULL ,  
 Grade12 numeric(18, 4) NOT NULL ,  
 Grade13 numeric(18, 4) NOT NULL ,  
 Grade14 numeric(18, 4) NOT NULL ,  
 Grade15 numeric(18, 4) NOT NULL ,  
 Grade16 numeric(18, 4) NOT NULL ,  
 Grade17 numeric(18, 4) NOT NULL ,  
 Grade18 numeric(18, 4) NOT NULL ,  
 Grade19 numeric(18, 4) NOT NULL ,  
 Size0 numeric(18, 4) NOT NULL ,  
 Size1 numeric(18, 4) NOT NULL ,  
 Size2 numeric(18, 4) NOT NULL ,  
 Size3 numeric(18, 4) NOT NULL ,  
 Size4 numeric(18, 4) NOT NULL ,  
 Size5 numeric(18, 4) NOT NULL ,  
 Size6 numeric(18, 4) NOT NULL ,  
 Size7 numeric(18, 4) NOT NULL ,  
 Size8 numeric(18, 4) NOT NULL ,  
 Size9 numeric(18, 4) NOT NULL ,  
 Size10 numeric(18, 4) NOT NULL ,  
 Size11 numeric(18, 4) NOT NULL ,  
 Size12 numeric(18, 4) NOT NULL ,  
 Size13 numeric(18, 4) NOT NULL ,  
 Size14 numeric(18, 4) NOT NULL ,  
 Size15 numeric(18, 4) NOT NULL ,  
 Size16 numeric(18, 4) NOT NULL ,  
 Size17 numeric(18, 4) NOT NULL ,  
 Size18 numeric(18, 4) NOT NULL ,  
 Size19 numeric(18, 4) NOT NULL ,  
 CDate datetime,  
 CUser nvarchar (200),  
 MDate datetime,  
 MUser nvarchar (200),  
 Change int,  
 Sort nvarchar (5),  
 HowToMeasurText nvarchar (4000),  
 HowToMeasurImage nvarchar (100)    
)   
END  
  
BEGIN  
 INSERT INTO #tempBodySpec1  
  (SpecID, BodyID, BodySet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur, TOL, TOLN, Grade0, Grade1,   
  Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14, Grade15, Grade16, Grade17,   
  Grade18, Grade19, Spec, Proto0, Proto1, Proto2, Proto3, Proto4, Proto5, Proto6, Proto7, Proto8, Proto9, Proto10, Proto11, Proto12, Proto13, Proto14,   
  Proto15, Proto16, Proto17, Proto18, Proto19, Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13,   
  Size14, Size15, Size16, Size17, Size18, Size19, CDate, CUser, MDate, MUser, Change, Sort)  
 SELECT  NEWID() AS SpecID, @NewBodyID AS BodyID, BodySet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur,   
  TOL, TOLN, Grade0, Grade1, Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14,   
  Grade15, Grade16, Grade17, Grade18, Grade19, Spec AS Spec, Spec AS P0, Spec AS P1, Spec AS P2, Spec AS P3, Spec AS P4, Spec AS P5, Spec AS P6,  
  Spec AS P7, Spec AS P8, Spec AS P9, Spec AS P10, Spec AS P11, Spec AS P12, Spec AS P13, Spec AS P14, Spec AS P15, Spec AS P16, Spec AS P17,   
  Spec AS P18, Spec AS P19, 0 AS S0, 0 AS S1, 0 AS S2, 0 AS S3, 0 AS S4, 0 AS S5, 0 AS S6, 0 AS S7, 0 AS S8, 0 AS S9, 0 AS S10, 0 AS S11, 0 AS S12,   
  0 AS S13, 0 AS S14, 0 AS S15, 0 AS S16, 0 AS S17, 0 AS S18, 0 AS S19, CDate, CUser, @CreatedDate AS MUser, @CreatedBy AS MDate, Change, Sort  
 FROM  pBodySpec WITH (NOLOCK)  
 WHERE (BodyID = @BodyID) AND (BodySet = 1)  
END  
  
BEGIN  
 INSERT INTO pBodySpec  
  (SpecID, BodyID, BodySet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur, TOL, TOLN, Grade0, Grade1,   
  Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14, Grade15, Grade16, Grade17,   
  Grade18, Grade19, Spec, Proto0, Proto1, Proto2, Proto3, Proto4, Proto5, Proto6, Proto7, Proto8, Proto9, Proto10, Proto11, Proto12, Proto13, Proto14,   
  Proto15, Proto16, Proto17, Proto18, Proto19, Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13,   
  Size14, Size15, Size16, Size17, Size18, Size19, CDate, CUser, MDate, MUser, Change, Sort)  
 SELECT  NEWID() AS SpecID, BodyID, BodySet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur,   
  TOL, TOLN, Grade0, Grade1, Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14,   
  Grade15, Grade16, Grade17, Grade18, Grade19, Spec AS Spec, Spec AS P0, Spec AS P1, Spec AS P2, Spec AS P3, Spec AS P4, Spec AS P5, Spec AS P6,  
  Spec AS P7, Spec AS P8, Spec AS P9, Spec AS P10, Spec AS P11, Spec AS P12, Spec AS P13, Spec AS P14, Spec AS P15, Spec AS P16, Spec AS P17,   
  Spec AS P18, Spec AS P19, 0 AS S0, 0 AS S1, 0 AS S2, 0 AS S3, 0 AS S4, 0 AS S5, 0 AS S6, 0 AS S7, 0 AS S8, 0 AS S9, 0 AS S10, 0 AS S11, 0 AS S12,   
  0 AS S13, 0 AS S14, 0 AS S15, 0 AS S16, 0 AS S17, 0 AS S18, 0 AS S19, CDate, CUser, @CreatedDate AS MUser, @CreatedBy AS MDate, Change, Sort  
 FROM  #tempBodySpec1  
 WHERE (BodyID = @NewBodyID) AND (BodySet = 1)  
END  
  
BEGIN  
 INSERT INTO #tempBodySpec2  
  (SpecID, BodyID, BodySet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur, TOL, TOLN, Grade0, Grade1,   
  Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14, Grade15, Grade16, Grade17,   
  Grade18, Grade19, Spec, Proto0, Proto1, Proto2, Proto3, Proto4, Proto5, Proto6, Proto7, Proto8, Proto9, Proto10, Proto11, Proto12, Proto13, Proto14,   
  Proto15, Proto16, Proto17, Proto18, Proto19, Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13,   
  Size14, Size15, Size16, Size17, Size18, Size19, CDate, CUser, MDate, MUser, Change, Sort)  
 SELECT  NEWID() AS SpecID, @NewBodyID AS BodyID, BodySet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur,   
  TOL, TOLN, Grade0, Grade1, Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14,   
  Grade15, Grade16, Grade17, Grade18, Grade19, Spec AS Spec, Spec AS P0, Spec AS P1, Spec AS P2, Spec AS P3, Spec AS P4, Spec AS P5, Spec AS P6,  
  Spec AS P7, Spec AS P8, Spec AS P9, Spec AS P10, Spec AS P11, Spec AS P12, Spec AS P13, Spec AS P14, Spec AS P15, Spec AS P16, Spec AS P17,   
  Spec AS P18, Spec AS P19, 0 AS S0, 0 AS S1, 0 AS S2, 0 AS S3, 0 AS S4, 0 AS S5, 0 AS S6, 0 AS S7, 0 AS S8, 0 AS S9, 0 AS S10, 0 AS S11, 0 AS S12,   
  0 AS S13, 0 AS S14, 0 AS S15, 0 AS S16, 0 AS S17, 0 AS S18, 0 AS S19, CDate, CUser, @CreatedDate AS MUser, @CreatedBy AS MDate, Change, Sort  
 FROM  pBodySpec WITH (NOLOCK)  
 WHERE (BodyID = @BodyID) AND (BodySet = 2)  
END  
  
BEGIN  
 INSERT INTO pBodySpec  
  (SpecID, BodyID, BodySet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur, TOL, TOLN, Grade0, Grade1,   
  Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14, Grade15, Grade16, Grade17,   
  Grade18, Grade19, Spec, Proto0, Proto1, Proto2, Proto3, Proto4, Proto5, Proto6, Proto7, Proto8, Proto9, Proto10, Proto11, Proto12, Proto13, Proto14,   
  Proto15, Proto16, Proto17, Proto18, Proto19, Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13,   
  Size14, Size15, Size16, Size17, Size18, Size19, CDate, CUser, MDate, MUser, Change, Sort)  
 SELECT  NEWID() AS SpecID, BodyID, BodySet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur,   
  TOL, TOLN, Grade0, Grade1, Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14,   
  Grade15, Grade16, Grade17, Grade18, Grade19, Spec AS Spec, Spec AS P0, Spec AS P1, Spec AS P2, Spec AS P3, Spec AS P4, Spec AS P5, Spec AS P6,  
  Spec AS P7, Spec AS P8, Spec AS P9, Spec AS P10, Spec AS P11, Spec AS P12, Spec AS P13, Spec AS P14, Spec AS P15, Spec AS P16, Spec AS P17,   
  Spec AS P18, Spec AS P19, 0 AS S0, 0 AS S1, 0 AS S2, 0 AS S3, 0 AS S4, 0 AS S5, 0 AS S6, 0 AS S7, 0 AS S8, 0 AS S9, 0 AS S10, 0 AS S11, 0 AS S12,   
  0 AS S13, 0 AS S14, 0 AS S15, 0 AS S16, 0 AS S17, 0 AS S18, 0 AS S19, CDate, CUser, @CreatedDate AS MUser, @CreatedBy AS MDate, Change, Sort  
 FROM  #tempBodySpec2  
 WHERE (BodyID = @NewBodyID) AND (BodySet = 2)  
END  
  
BEGIN  
 INSERT INTO #tempBodySpec3  
  (SpecID, BodyID, BodySet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur, TOL, TOLN, Grade0, Grade1,   
  Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14, Grade15, Grade16, Grade17,   
  Grade18, Grade19, Spec, Proto0, Proto1, Proto2, Proto3, Proto4, Proto5, Proto6, Proto7, Proto8, Proto9, Proto10, Proto11, Proto12, Proto13, Proto14,   
  Proto15, Proto16, Proto17, Proto18, Proto19, Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13,   
  Size14, Size15, Size16, Size17, Size18, Size19, CDate, CUser, MDate, MUser, Change, Sort)  
 SELECT  NEWID() AS SpecID, @NewBodyID AS BodyID, BodySet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur,   
  TOL, TOLN, Grade0, Grade1, Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14,   
  Grade15, Grade16, Grade17, Grade18, Grade19, Spec AS Spec, Spec AS P0, Spec AS P1, Spec AS P2, Spec AS P3, Spec AS P4, Spec AS P5, Spec AS P6,  
  Spec AS P7, Spec AS P8, Spec AS P9, Spec AS P10, Spec AS P11, Spec AS P12, Spec AS P13, Spec AS P14, Spec AS P15, Spec AS P16, Spec AS P17,   
  Spec AS P18, Spec AS P19, 0 AS S0, 0 AS S1, 0 AS S2, 0 AS S3, 0 AS S4, 0 AS S5, 0 AS S6, 0 AS S7, 0 AS S8, 0 AS S9, 0 AS S10, 0 AS S11, 0 AS S12,   
  0 AS S13, 0 AS S14, 0 AS S15, 0 AS S16, 0 AS S17, 0 AS S18, 0 AS S19, CDate, CUser, @CreatedDate AS MUser, @CreatedBy AS MDate, Change, Sort  
 FROM  pBodySpec WITH (NOLOCK)  
 WHERE (BodyID = @BodyID) AND (BodySet = 3)  
END  
  
BEGIN  
 INSERT INTO pBodySpec  
  (SpecID, BodyID, BodySet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur, TOL, TOLN, Grade0, Grade1,   
  Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14, Grade15, Grade16, Grade17,   
  Grade18, Grade19, Spec, Proto0, Proto1, Proto2, Proto3, Proto4, Proto5, Proto6, Proto7, Proto8, Proto9, Proto10, Proto11, Proto12, Proto13, Proto14,   
  Proto15, Proto16, Proto17, Proto18, Proto19, Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13,   
  Size14, Size15, Size16, Size17, Size18, Size19, CDate, CUser, MDate, MUser, Change, Sort)  
 SELECT  NEWID() AS SpecID, BodyID, BodySet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur,   
  TOL, TOLN, Grade0, Grade1, Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14,   
  Grade15, Grade16, Grade17, Grade18, Grade19, Spec AS Spec, Spec AS P0, Spec AS P1, Spec AS P2, Spec AS P3, Spec AS P4, Spec AS P5, Spec AS P6,  
  Spec AS P7, Spec AS P8, Spec AS P9, Spec AS P10, Spec AS P11, Spec AS P12, Spec AS P13, Spec AS P14, Spec AS P15, Spec AS P16, Spec AS P17,   
  Spec AS P18, Spec AS P19, 0 AS S0, 0 AS S1, 0 AS S2, 0 AS S3, 0 AS S4, 0 AS S5, 0 AS S6, 0 AS S7, 0 AS S8, 0 AS S9, 0 AS S10, 0 AS S11, 0 AS S12,   
  0 AS S13, 0 AS S14, 0 AS S15, 0 AS S16, 0 AS S17, 0 AS S18, 0 AS S19, CDate, CUser, @CreatedDate AS MUser, @CreatedBy AS MDate, Change, Sort  
 FROM  #tempBodySpec3  
 WHERE (BodyID = @NewBodyID) AND (BodySet = 3)  
END  
  
BEGIN  
 INSERT INTO #tempBodySpec4  
  (SpecID, BodyID, BodySet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur, TOL, TOLN, Grade0, Grade1,   
  Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14, Grade15, Grade16, Grade17,   
  Grade18, Grade19, Spec, Proto0, Proto1, Proto2, Proto3, Proto4, Proto5, Proto6, Proto7, Proto8, Proto9, Proto10, Proto11, Proto12, Proto13, Proto14,   
  Proto15, Proto16, Proto17, Proto18, Proto19, Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13,   
  Size14, Size15, Size16, Size17, Size18, Size19, CDate, CUser, MDate, MUser, Change, Sort)  
 SELECT  NEWID() AS SpecID, @NewBodyID AS BodyID, BodySet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur,   
  TOL, TOLN, Grade0, Grade1, Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14,   
  Grade15, Grade16, Grade17, Grade18, Grade19, Spec AS Spec, Spec AS P0, Spec AS P1, Spec AS P2, Spec AS P3, Spec AS P4, Spec AS P5, Spec AS P6,  
  Spec AS P7, Spec AS P8, Spec AS P9, Spec AS P10, Spec AS P11, Spec AS P12, Spec AS P13, Spec AS P14, Spec AS P15, Spec AS P16, Spec AS P17,   
  Spec AS P18, Spec AS P19, 0 AS S0, 0 AS S1, 0 AS S2, 0 AS S3, 0 AS S4, 0 AS S5, 0 AS S6, 0 AS S7, 0 AS S8, 0 AS S9, 0 AS S10, 0 AS S11, 0 AS S12,   
  0 AS S13, 0 AS S14, 0 AS S15, 0 AS S16, 0 AS S17, 0 AS S18, 0 AS S19, CDate, CUser, @CreatedDate AS MUser, @CreatedBy AS MDate, Change, Sort  
 FROM  pBodySpec WITH (NOLOCK)  
 WHERE (BodyID = @BodyID) AND (BodySet = 4)  
END  
  
  
BEGIN  
 INSERT INTO pBodySpec  
  (SpecID, BodyID, BodySet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur, TOL, TOLN, Grade0, Grade1,   
  Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14, Grade15, Grade16, Grade17,   
  Grade18, Grade19, Spec, Proto0, Proto1, Proto2, Proto3, Proto4, Proto5, Proto6, Proto7, Proto8, Proto9, Proto10, Proto11, Proto12, Proto13, Proto14,   
  Proto15, Proto16, Proto17, Proto18, Proto19, Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13,   
  Size14, Size15, Size16, Size17, Size18, Size19, CDate, CUser, MDate, MUser, Change, Sort)  
 SELECT  NEWID() AS SpecID, BodyID, BodySet, SpecMasterID, POMLibraryID, POMTempItemID, POMTempID, Critical, POM, PointMeasur,   
  TOL, TOLN, Grade0, Grade1, Grade2, Grade3, Grade4, Grade5, Grade6, Grade7, Grade8, Grade9, Grade10, Grade11, Grade12, Grade13, Grade14,   
  Grade15, Grade16, Grade17, Grade18, Grade19, Spec AS Spec, Spec AS P0, Spec AS P1, Spec AS P2, Spec AS P3, Spec AS P4, Spec AS P5, Spec AS P6,  
  Spec AS P7, Spec AS P8, Spec AS P9, Spec AS P10, Spec AS P11, Spec AS P12, Spec AS P13, Spec AS P14, Spec AS P15, Spec AS P16, Spec AS P17,   
  Spec AS P18, Spec AS P19, 0 AS S0, 0 AS S1, 0 AS S2, 0 AS S3, 0 AS S4, 0 AS S5, 0 AS S6, 0 AS S7, 0 AS S8, 0 AS S9, 0 AS S10, 0 AS S11, 0 AS S12,   
  0 AS S13, 0 AS S14, 0 AS S15, 0 AS S16, 0 AS S17, 0 AS S18, 0 AS S19, CDate, CUser, @CreatedDate AS MUser, @CreatedBy AS MDate, Change, Sort  
 FROM  #tempBodySpec4  
 WHERE (BodyID = @NewBodyID) AND (BodySet = 4)  
END  
  
/****************************************************************************************************/  
/*This was added because when you copied a Style, the pStyleSpecSize table was not being populated. */  
/*Calling this procedure here will populate this table so that reports can retrieve accurate data. */  
/*Added: 4/3/08                      */   
/****************************************************************************************************/  
EXEC spx_BodySpecSize_SELECT @NewBodyID  
  
  
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_BodyHeaderCopy_INSERT]'
GO


CREATE PROCEDURE [dbo].[spx_BodyHeaderCopy_INSERT]    
(    
@BodyID uniqueidentifier,    
@NewBodyID uniqueidentifier,    
@DesignSketchID uniqueidentifier,    
@DesignSketchVersion varchar(5),      
@CreatedBy nvarchar(200),    
@CreatedDate datetime    
)    
AS    
    
SET NOCOUNT ON    
    
BEGIN    
 INSERT INTO pBody    
  (BodyID,BodyTypeID,BodySet,BodyNo,Description,TempID,TempNo,StyleCategory,SizeClass,SizeRange,POMTempID,  
POMTempItemID,Season,Year,ImageID,ImageVersion,PC1,PC2,PC3,PC4,Active,CUser,CDate,MUser,MDate,POMTempID1,POMTempID2,POMTempID3,POMTempID4,WashType   
  )    
 SELECT     @NewBodyID,BodyTypeID,BodySet,BodyNo,Description,TempID,TempNo,StyleCategory,SizeClass,SizeRange,POMTempID,  
POMTempItemID,Season,Year,@DesignSketchID,@DesignSketchVersion,PC1,PC2,PC3,PC4,Active,CUser,CDate,MUser,MDate,POMTempID1,POMTempID2,POMTempID3,POMTempID4,WashType      
 FROM  pBody WITH (NOLOCK)    
 WHERE BodyID = @BodyID    
END      
  
BEGIN    
    
 INSERT INTO pBodyImage    
 (BodyID,SpecSketchID1,SpecSketchVersion1,SpecSketchID2,SpecSketchVersion2,SpecSketchID3,SpecSketchVersion3,SpecSketchID4,SpecSketchVersion4)    
 SELECT @NewBodyID,SpecSketchID1,SpecSketchVersion1,SpecSketchID2,SpecSketchVersion2,SpecSketchID3,SpecSketchVersion3,SpecSketchID4,SpecSketchVersion4   
 FROM pBodyImage WITH (NOLOCK)    
 WHERE BodyID = @BodyID    
    
END    
  
    
BEGIN    
    
DECLARE @BodyworkflowID uniqueidentifier
Set  @BodyworkflowID = newid()

 INSERT INTO pBodyWorkflow    
 (BodyworkflowID,BodyID,BodySet,WorkflowID,WorkDate,WorkStart,WorkDue,WorkAssignedTo,WorkStatus,WorkSort,CUser,CDate,MUser,MDate,WorkDay)    
 SELECT @BodyworkflowID, @NewBodyID As BodyID,BodySet,WorkflowID,WorkDate,WorkStart,WorkDue,WorkAssignedTo,WorkStatus,WorkSort,@CreatedBy AS CUser, @CreatedDate AS CDate, @CreatedBy AS MUser, @CreatedDate AS MDate ,WorkDay   
 FROM  pBodyWorkflow WITH (NOLOCK)    
 WHERE BodyID = @BodyID   

Update pBody 
Set BodyworkflowID = @BodyworkflowID Where BodyID=@NewBodyID
 
END    
    

    
    
/**************************************************************************************************************************************************************************************************************************************************************
  
*****************************************************    
-- INSERT LOG RECCORD     
***************************************************************************************************************************************************************************************************************************************************************
  
****************************************************/    
DECLARE @BodyNo NVARCHAR(20)    
DECLARE @Description NVARCHAR (4000)    
    
SELECT @BodyNo  = BodyNo      
FROM pBody WITH (NOLOCK) WHERE BodyID = @BodyID     
    
SET  @Description  = 'Body copied from body with BodyNo: '  +  @BodyNo      
    
    
    
INSERT INTO pBodyChange (BodyChangeID ,  BodyStatus ,  WorkflowID , BodyID , BodySet ,  BodyChangeNotifyTo , BodyChangeType,     
BodyChangeDescription ,  BodyChangeBy, BodyChangeDate,  ActiveID ,  Active  )     
VALUES  ( NEWID() ,   0 , '11111111-0000-0000-0000-000000000001' , @NewBodyID , 0 ,  '' , 'Information', @Description ,    
@CreatedBy,  @CreatedDate ,  '00000000-0000-0000-0000-000000000000'  , 1 )    
    
    
    
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanStyleColorwayDeliveryStatus_UPDATE_QUEUE]'
GO







CREATE PROCEDURE [dbo].[spx_LinePlanStyleColorwayDeliveryStatus_UPDATE_QUEUE](
@StyleColorwaySeasonYearID UNIQUEIDENTIFIER , 
@StyleColorDel1 INT,
@StyleColorDel2 INT,
@StyleColorDel3 INT,
@StyleColorDel4 INT,
@StyleColorStatus VARCHAR(5),
@MUser VARCHAR(200), 
@MDate DATETIME , 
@StyleColorCollection NVARCHAR(200),
@Units INT,
@ColorType NVARCHAR(5),
@SampleStatus VARCHAR(5)
)

AS




DECLARE	@StyleID UNIQUEIDENTIFIER 
DECLARE	@StyleSeasonYearID UNIQUEIDENTIFIER 
DECLARE	@LinePlanItemID UNIQUEIDENTIFIER 


SELECT @StyleID = a.StyleID , @LinePlanItemID = b.LinePlanItemID, @StyleSeasonYearID = b.StyleSeasonYearID
FROM pStyleColorwaySeasonYear a 
INNER JOIN pStyleSeasonYear b ON a.StyleSeasonYearID = b.StyleSeasonYearID 
WHERE StyleColorwaySeasonYearID = @StyleColorwaySeasonYearID


/*
UPDATE pStyleColorwaySeasonYear 
SET
	StyleColorDelivery1 = @StyleColorDel1, 
	StyleColorDelivery2 = @StyleColorDel2, 
	StyleColorDelivery3 = @StyleColorDel3,
	StyleColorDelivery4 = @StyleColorDel4,
	StyleColorStatus = @StyleColorStatus,
	CustomField1 = @StyleColorCollection,
	Units = @Units,
	ColorType = @ColorType ,
	SampleStatus = @SampleStatus
WHERE
	StyleColorwaySeasonYearID = @StyleColorwaySeasonYearID
*/

	-- APPLY LOGIC 

	DECLARE @LinePlanId varchar(40)
	DECLARE @LinePlanAttributeItemId1 varchar(40) 
	DECLARE @LinePlanAttributeItemId2 varchar(40) 
	DECLARE @LinePlanAttributeItemId3 varchar(40) 
	DECLARE @LinePlanAttributeItemId4 varchar(40) 
	DECLARE @LinePlanRangeID UNIQUEIDENTIFIER 

	SELECT @LinePlanRangeID = LinePlanRangeID 
	FROM pLinePlanItem  
	WHERE LinePlanItemID  = @LinePlanItemID
	
	SELECT  @LinePlanId = LinePlanID,
	@LinePlanAttributeItemId1 = LinePlanAttributeItemId1, 
	@LinePlanAttributeItemId2 = LinePlanAttributeItemId2,  
	@LinePlanAttributeItemId3  = LinePlanAttributeItemId3, 
	@LinePlanAttributeItemId4  = LinePlanAttributeItemId4 
	FROM pLinePlanRange 
	WHERE LinePlanRangeID = @LinePlanRangeID
	

	EXEC dbo.spx_LinePlanBusinessItemRollup_INSERT  
	@LinePlanId = @LinePlanId, 
	@LinePlanAttributeItemId1 = @LinePlanAttributeItemId1, 
	@LinePlanAttributeItemId2 = @LinePlanAttributeItemId2, 
	@LinePlanAttributeItemId3 = @LinePlanAttributeItemId3, 
	@LinePlanAttributeItemId4 = @LinePlanAttributeItemId4,
	@StyleSeasonYearID = @StyleSeasonYearID











GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_BodyNewCopySizeClass_INSERT]'
GO


CREATE PROCEDURE [dbo].[spx_BodyNewCopySizeClass_INSERT](  
@BodyID UNIQUEIDENTIFIER,   
@NewBodyID UNIQUEIDENTIFIER,   
@CreatedDate DATETIME,   
@CreatedBy NVARCHAR(200),   
@SqlBodyHeaderUpdate VARCHAR(4000)   
)  
AS  
  
  
  
BEGIN  
  
 DECLARE @SketchID UNIQUEIDENTIFIER  
 DECLARE @SketchVersion INT   
  
 SELECT @SketchID = ImageID, @SketchVersion = ImageVersion  
 FROM  pBody WHERE BodyID = @BodyID  
  
  
 EXEC dbo.spx_BodyHeaderCopy_INSERT @BodyID=@BodyID, @NewBodyID=@NewBodyID, @DesignSketchID=@SketchID,    
  @DesignSketchVersion=@SketchVersion, @CreatedBy=@CreatedBy,  @CreatedDate=@CreatedDate  
   
 EXEC(@SqlBodyHeaderUpdate)  
  
 EXEC spx_BodyDevelopmentSpecVariation_INSERT @BodyID=@BodyID, @NewBodyID=@NewBodyID , @CreatedBy=@CreatedBy,  @CreatedDate=@CreatedDate  
  
  
END  
  
  
  


  
  
  
  
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanStyleCarryColor_SELECT]'
GO




ALTER PROCEDURE [dbo].[spx_LinePlanStyleCarryColor_SELECT](
@LinePlanID UNIQUEIDENTIFIER,
@StyleID	UNIQUEIDENTIFIER, 
@LinePlanRangeID UNIQUEIDENTIFIER
)
AS


--DECLARE 
DECLARE @ColorLinePlanRangeID UNIQUEIDENTIFIER 
DECLARE @LinePlanAttributeItemID1 NVARCHAR(50) 
DECLARE @LinePlanAttributeItemID2 NVARCHAR(50)
DECLARE @LinePlanAttributeItemID3 NVARCHAR(50)
DECLARE @LinePlanAttributeItemID4 NVARCHAR(50)

SELECT @LinePlanAttributeItemID1 = LinePlanAttributeItemID1, @LinePlanAttributeItemID2 = LinePlanAttributeItemID2,
@LinePlanAttributeItemID3 = LinePlanAttributeItemID3, @LinePlanAttributeItemID4 = LinePlanAttributeItemID4
FROM pLinePlanRange WHERE LinePlanRangeID = @LinePlanRangeID -- '35a2d950-3218-4329-9c40-93e66c3e912d'

SELECT @ColorLinePlanRangeID = LinePlanRangeID FROM pLinePlanRange 
WHERE  LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000002'
--AND LinePlanAttributeItemID4 = @LinePlanAttributeItemID4


CREATE TABLE #tmpColor (
ROW_ID INT IDENTITY (1,1),
ColorPaletteID UNIQUEIDENTIFIER,
ColorType NVARCHAR(5),
ColorCode [nvarchar](200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
ColorName [nvarchar](200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)



INSERT INTO #tmpColor (ColorType , ColorCode, ColorName)
SELECT distinct 'R' AS ColorType, c.ColorCode, c.ColorName 
FROM pStyleColorwaySeasonYear a
INNER JOIN pStyleColorway b ON  a.StyleColorwayID  = b.StyleColorID
LEFT OUTER JOIN pColorPalette c ON c.ColorPaletteID  = b.ColorPaletteID 
WHERE a.StyleID = @StyleID



DECLARE @ROW_ID INT
DECLARE @TOTAL INT 
DECLARE @ColorCode NVARCHAR(200)
DECLARE @ColorName NVARCHAR(200)
DECLARE @ColorPaletteID UNIQUEIDENTIFIER 

SET @ROW_ID  = 1 
SELECT @TOTAL = COUNT(*) FROM  #tmpColor
WHILE @ROW_ID <= @TOTAL 
BEGIN
	
	SELECT @ColorCode = ColorCode, @ColorName = ColorName FROM #tmpColor WHERE ROW_ID = @ROW_ID
	SET @ColorPaletteID =  NULL 
	
	SELECT TOP 1 @ColorPaletteID = b.ColorPaletteID 
	FROM pStyleColorwaySeasonYear a
	INNER JOIN pStyleColorway b ON  a.StyleColorwayID  = b.StyleColorID
	LEFT OUTER JOIN pColorPalette c ON c.ColorPaletteID  = b.ColorPaletteID 
	WHERE a.StyleID = @StyleID
	AND ColorCode = @ColorCode
	AND ColorName = @ColorName 
	
	IF @ColorPaletteID IS NULL
		DELETE FROM #tmpColor WHERE ROW_ID = @ROW_ID
	ELSE 
		UPDATE #tmpColor set ColorPaletteID = @ColorPaletteID WHERE ROW_ID = @ROW_ID
	

	SET @ROW_ID = @ROW_ID + 1
END 



INSERT INTO #tmpColor (ColorPaletteID, ColorType )
SELECT a.ColorPaletteID, 'F' AS ColorType 
FROM pLinePlanColorItem a 
INNER JOIN pColorPalette b ON a.ColorPaletteID =  b.ColorPaletteID
WHERE  LinePlanRangeID = @ColorLinePlanRangeID 
AND ISNULL (b.ColorName,'') +  ISNULL (b.ColorCode,'')  NOT IN ( 
	SELECT ISNULL (ColorName,'') +  ISNULL (ColorCode,'') FROM #tmpColor  
)


SELECT  b.*, a.ColorType,
'<img src="../System/Control/ColorStream.ashx?S=20&CFID=' + CAST(b.ColorFolderID AS NVARCHAR(50)) 
+ '&CPID=' + CAST(b.ColorPaletteID AS NVARCHAR(50)) +  '" border="0" />'
 AS ColorUrl, 0 AS Units, 
0 AS StyleColorDelivery1,
0 AS StyleColorDelivery2,
0 AS StyleColorDelivery3,
0 AS StyleColorDelivery4

FROM #tmpColor a
INNER JOIN pColorPalette b ON a.ColorPaletteID = b.ColorPaletteID 
ORDER BY b.ColorName, b.ColorCode

DROP TABLE  #tmpColor














GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_BodyNewCopySizeClass_UPDATE]'
GO
  
  
CREATE PROCEDURE [dbo].[spx_BodyNewCopySizeClass_UPDATE] (    
@BodyID UNIQUEIDENTIFIER,     
@NewBodyID UNIQUEIDENTIFIER,     
@NewBodyDevelopmentID UNIQUEIDENTIFIER,     
@CreatedDate DATETIME,     
@CreatedBy NVARCHAR(200),    
@LinkImage INT,     
@CarryOver INT,     
    
@BodyTempID NVARCHAR(20),    
@BodyTempNo NVARCHAR(20),    
@BodyNo NVARCHAR(20),    
    
@DevelopmentTempID NVARCHAR(20),    
@DevelopmentTempNo NVARCHAR(20),    
@DevelopmentNo NVARCHAR(20) ,    
@DesignSketchID UNIQUEIDENTIFIER    
)    
AS    
BEGIN    
    
    
DECLARE @tmpBodyNo NVARCHAR(20),     
@tmpBodyTempID NVARCHAR(20),    
@tmpBodyTempNo NVARCHAR(20),     
@tmpNewBodyID UNIQUEIDENTIFIER     
    
    
SET @tmpBodyNo = @BodyNo    
SET @tmpBodyTempID =  @BodyTempID    
SET @tmpBodyTempNo = @BodyTempNo    
SET @tmpNewBodyID = @NewBodyID    
       
    
 DECLARE @BodyType AS NVARCHAR(5)    
 DECLARE @SizeRange AS NVARCHAR(100)    
     
 SELECT @BodyType = b.BodyType, @SizeRange = a.SizeRange    
 FROM  pBody a INNER JOIN pBodyType b ON a.BodyTypeID = b.BodyTypeID     
 WHERE a.BodyID = @BodyID     
    
    
 IF @BodyType = 'V'     
 BEGIN     
  EXEC dbo.spx_BodyDevelopmentCopy_INSERT  @BodyDevelopmentID = @NewBodyDevelopmentID ,     
   @BodyID = @NewBodyID,  @TempID = @DevelopmentTempID , @TempNo = @DevelopmentTempNo,    
   @BodyDevelopmentNo = @DevelopmentNo,     
   @SizeRange = @SizeRange ,  @CreatedBy = @CreatedBy , @CreatedDate = @CreatedDate    
    
    
  EXEC dbo.spx_BodyDevelopmentItemCopy_INSERT  @BodyDevelopmentID = @NewBodyDevelopmentID,     
   @BodyID = @NewBodyID ,      
   @TempID = @DevelopmentTempID , @TempNo = @DevelopmentTempNo,    
   @BodyDevelopmentNo = @DevelopmentNo,    
   @SizeRange = @SizeRange ,  @CreatedBy = @CreatedBy , @CreatedDate = @CreatedDate    
    
 END    
 ELSE    
 BEGIN    
    
  EXEC dbo.spx_BodyDevelopmentNew_INSERT @DevelopmentID = @NewBodyDevelopmentID ,     
   @BodyID = @NewBodyID,  @CUser = @CreatedBy , @CDate = @CreatedDate    
 END     
 
--krishan comment right now not updating this value--    
-------- IF @LinkImage = 0     
-------- BEGIN    
--------    
--------  UPDATE pBody SET ImageID = @DesignSketchID , ImageVersion = 1     
--------  WHERE BodyID = @NewBodyID    
-------- END     
-- ELSE    
-- BEGIN    
  -- LINK Body DESIGN DETAIL IMAGES    
    
--  DECLARE @BodySet INT     
--    
--  SELECT @BodySet  = BodySet     
--  FROM pBodyHeader     
--  WHERE BodyID = @NewBodyID    
--    
--  IF @BodySet IS NULL    
--   SET @BodySet = 1     
--    
--  INSERT INTO pBodyImageItem  ( BodyImageItemID, BodyImageItemMasterID, WorkflowID , BodyID , BodySet, ImageID,     
--  ImageVersion, CUser, CDate, MUser, MDate, BodyImageLinked, Sort )         
--  SELECT NEWID() as BodyImageItemID , NEWID() as BodyImageItemMasterID, WorkflowID , @NewBodyID AS BodyID , BodySet,     
--  ImageID, ImageVersion, @CreatedBy AS CUser, @CreatedDate AS CDate, @CreatedBy AS MUser, @CreatedDate AS MDate, BodyImageLinked, Sort     
--  FROM pBodyImageItem     
--  WHERE BodyID = @BodyID AND BodySet <= @BodySet    
--  AND WorkflowID = '40000000-0000-0000-0000-000000000006'     
    
-- END     
    
    
 --EXEC spx_BodyImageItemVariation_SELECT @BodyId = @NewBodyID    
 --EXEC spx_BodyImageItemMasterId_UPDATE @BodyId = @NewBodyID    
 --EXEC spx_BodyMaterialMasterId_UPDATE @BodyId = @NewBodyID    
 --EXEC spx_BodyHeaderLogic_UPDATE @BodyId = @NewBodyID    
    
 -- Update SAPcode     
-- IF @CarryOver = 0    
-- BEGIN    
--  UPDATE pBodyColorway SET SAPCode  =  NULL    
--  WHERE BodyID  = @NewBodyID    
--    
--  -- Added by AG 20090827    
--  UPDATE pBodyHeader SET     
--  BodyNo = @tmpBodyNo,    
--  TempId = @tmpBodyTempID,     
--  TempNo = @tmpBodyTempNo    
--  WHERE BodyID = @tmpNewBodyID    
-- END     
    
    
 -- Update PLMCode     
-- EXEC spx_BodyColorway_PLMCode_UPDATE @NewBodyID, 0    
    
    
    
END 
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanStyleColorwayDeliveryStatus_UPDATE]'
GO









ALTER  PROCEDURE [dbo].[spx_LinePlanStyleColorwayDeliveryStatus_UPDATE](
@StyleColorwaySeasonYearID UNIQUEIDENTIFIER , 
@StyleColorDel1 INT,
@StyleColorDel2 INT,
@StyleColorDel3 INT,
@StyleColorDel4 INT,
@StyleColorStatus VARCHAR(5),
@MUser VARCHAR(200), 
@MDate DATETIME , 
@StyleColorCollection NVARCHAR(200),
@Units INT,		
@ColorType NVARCHAR(5),
@SampleStatus VARCHAR(5)
)
AS


DECLARE @pStyleColorwaySeasonYearID  NVARCHAR(70)
DECLARE @pStyleColorDel1 NVARCHAR(50)
DECLARE @pStyleColorDel2 NVARCHAR(50)
DECLARE @pStyleColorDel3 NVARCHAR(50)
DECLARE @pStyleColorDel4 NVARCHAR(50)
DECLARE @pStyleColorStatus VARCHAR(50)
DECLARE @pMUser VARCHAR(250)
DECLARE @pMDate NVARCHAR(100) 
DECLARE @pStyleColorCollection NVARCHAR(250)
DECLARE @pUnits NVARCHAR(50)
DECLARE @pColorType VARCHAR(50)
DECLARE @pSampleStatus VARCHAR(50)

IF @StyleColorwaySeasonYearID IS NULL
	SET @pStyleColorwaySeasonYearID = ' @StyleColorwaySeasonYearID = NULL '
ELSE
	SET @pStyleColorwaySeasonYearID = ' @StyleColorwaySeasonYearID = ''' +  CAST (@StyleColorwaySeasonYearID AS NVARCHAR(50)) + ''' '


IF @StyleColorDel1 IS NULL
	SET @pStyleColorDel1 = ' @StyleColorDel1 = NULL '
ELSE
	SET @pStyleColorDel1 = ' @StyleColorDel1 = ' +  CAST (@StyleColorDel1 AS NVARCHAR(5)) 

IF @StyleColorDel2 IS NULL
	SET @pStyleColorDel2 = ' @StyleColorDel2 = NULL '
ELSE
	SET @pStyleColorDel2 = ' @StyleColorDel2 = ' +  CAST (@StyleColorDel2 AS NVARCHAR(5)) 

IF @StyleColorDel3 IS NULL
	SET @pStyleColorDel3 = ' @StyleColorDel3 = NULL '
ELSE
	SET @pStyleColorDel3 = ' @StyleColorDel3 = ' +  CAST (@StyleColorDel3 AS NVARCHAR(5)) 

IF @StyleColorDel4 IS NULL
	SET @pStyleColorDel4 = ' @StyleColorDel4 = NULL '
ELSE
	SET @pStyleColorDel4 = ' @StyleColorDel4 = ' +  CAST (@StyleColorDel4 AS NVARCHAR(5)) 

IF @StyleColorStatus IS NULL 
	SET @pStyleColorStatus = ' @StyleColorStatus = NULL '
ELSE
	SET @pStyleColorStatus = ' @StyleColorStatus = ' +  CAST (@StyleColorStatus AS NVARCHAR(5)) 


IF @MUser IS NULL
	SET @pMUser = ' @MUser = NULL '
ELSE
	SET @pMUser = ' @MUser = ''' +  @MUser  + ''' '

IF @MDate IS NULL
	SET @pMDate = ' @MDate = NULL '
ELSE
	SET @pMDate = ' @MDate = ''' +  CONVERT( NVARCHAR(40) , @MDate , 20 )  + ''' '

IF @StyleColorCollection IS NULL
	SET @pStyleColorCollection = ' @StyleColorCollection = NULL '
ELSE
	SET @pStyleColorCollection = ' @StyleColorCollection = ''' +  @StyleColorCollection  + ''' '

IF @Units IS NULL
	SET @pUnits = ' @Units = NULL '
ELSE
	SET @pUnits = ' @Units = ' +  CAST (@Units AS NVARCHAR(5)) 


IF @ColorType IS NULL 
	SET @pColorType = ' @ColorType = NULL '
ELSE
	SET @pColorType = ' @ColorType = ' +  CAST (@ColorType AS NVARCHAR(5)) 


IF @SampleStatus IS NULL 
	SET @pSampleStatus = ' @SampleStatus = NULL '
ELSE
	SET @pSampleStatus = ' @SampleStatus = ' +  CAST (@SampleStatus AS NVARCHAR(5)) 



DECLARE @ServiceDate DATETIME
SET @ServiceDate = getdate()

DECLARE @ServiceQueueSql1 nvarchar(4000)
SET @ServiceQueueSql1 = 'dbo.spx_LinePlanStyleColorwayDeliveryStatus_UPDATE_QUEUE ' + 
@pStyleColorwaySeasonYearID + ',' + 
@pStyleColorDel1  + ',' + 
@pStyleColorDel2  + ',' + 
@pStyleColorDel3  + ',' + 
@pStyleColorDel4  + ',' + 
@pStyleColorStatus  + ',' + 
@pMUser  + ',' + 
@pMDate  + ',' + 
@pStyleColorCollection  + ',' + 
@pUnits + ',' + 
@pColorType + ',' + 
@pSampleStatus 



UPDATE pStyleColorwaySeasonYear 
SET
	StyleColorDelivery1 = @StyleColorDel1, 
	StyleColorDelivery2 = @StyleColorDel2, 
	StyleColorDelivery3 = @StyleColorDel3,
	StyleColorDelivery4 = @StyleColorDel4,
	StyleColorStatus = @StyleColorStatus,
	CustomField1 = @StyleColorCollection,
	Units = @Units,
	ColorType = @ColorType ,
	SampleStatus = @SampleStatus
WHERE
	StyleColorwaySeasonYearID = @StyleColorwaySeasonYearID


exec spx_ServiceQueue_INSERT @ServiceQueueSql = @ServiceQueueSql1, @ServiceQueuePriority = 1, @ServiceQueueDate = @ServiceDate






/*

DECLARE	@StyleID UNIQUEIDENTIFIER 
DECLARE	@StyleSeasonYearID UNIQUEIDENTIFIER 
DECLARE	@LinePlanItemID UNIQUEIDENTIFIER 


SET @StyleColorStatus = 100 

IF @StyleColorDel1 = 200 OR @StyleColorDel2 = 200 OR @StyleColorDel3 = 200 OR @StyleColorDel4 = 200 
	SET @StyleColorStatus = 200


SELECT @StyleID = a.StyleID , @LinePlanItemID = b.LinePlanItemID, @StyleSeasonYearID = b.StyleSeasonYearID
FROM pStyleColorwaySeasonYear a 
INNER JOIN pStyleSeasonYear b ON a.StyleSeasonYearID = b.StyleSeasonYearID 
WHERE StyleColorwaySeasonYearID = @StyleColorwaySeasonYearID


UPDATE pStyleColorwaySeasonYear 
SET
	StyleColorDelivery1 = @StyleColorDel1, 
	StyleColorDelivery2 = @StyleColorDel2, 
	StyleColorDelivery3 = @StyleColorDel3,
	StyleColorDelivery4 = @StyleColorDel4,
	StyleColorStatus = @StyleColorStatus,
	CustomField1 = @StyleColorCollection,
	Units = @Units
WHERE
	StyleColorwaySeasonYearID = @StyleColorwaySeasonYearID


	-- APPLY LOGIC 

	DECLARE @LinePlanId varchar(40)
	DECLARE @LinePlanAttributeItemId1 varchar(40) 
	DECLARE @LinePlanAttributeItemId2 varchar(40) 
	DECLARE @LinePlanAttributeItemId3 varchar(40) 
	DECLARE @LinePlanAttributeItemId4 varchar(40) 
	DECLARE @LinePlanRangeID UNIQUEIDENTIFIER 

	SELECT @LinePlanRangeID = LinePlanRangeID 
	FROM pLinePlanItem  
	WHERE LinePlanItemID  = @LinePlanItemID
	
	SELECT  @LinePlanId = LinePlanID,
	@LinePlanAttributeItemId1 = LinePlanAttributeItemId1, 
	@LinePlanAttributeItemId2 = LinePlanAttributeItemId2,  
	@LinePlanAttributeItemId3  = LinePlanAttributeItemId3, 
	@LinePlanAttributeItemId4  = LinePlanAttributeItemId4 
	FROM pLinePlanRange 
	WHERE LinePlanRangeID = @LinePlanRangeID
	

	EXEC dbo.spx_LinePlanBusinessItemRollup_INSERT  
	@LinePlanId = @LinePlanId, 
	@LinePlanAttributeItemId1 = @LinePlanAttributeItemId1, 
	@LinePlanAttributeItemId2 = @LinePlanAttributeItemId2, 
	@LinePlanAttributeItemId3 = @LinePlanAttributeItemId3, 
	@LinePlanAttributeItemId4 = @LinePlanAttributeItemId4,
	@StyleSeasonYearID = @StyleSeasonYearID




*/








GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanStyleColorwayLogic_UPDATE]'
GO

CREATE PROCEDURE  [dbo].[spx_LinePlanStyleColorwayLogic_UPDATE] (
@StyleColorwaySeasonYearID UNIQUEIDENTIFIER , 
@Query NVARCHAR(4000) ,
@MUser NVARCHAR(200), 
@MDate DATETIME 
)
AS 


DECLARE @StyleColorId UNIQUEIDENTIFIER
DECLARE @StyleID  UNIQUEIDENTIFIER
DECLARE @StyleColorDel1 INT
DECLARE @StyleColorDel2 INT
DECLARE @StyleColorDel3 INT 
DECLARE @StyleColorDel4 INT 
DECLARE @StyleColorCollection  NVARCHAR(200)
DECLARE @Units INT 
DECLARE @SeasonYearID UNIQUEIDENTIFIER 
DECLARE @ColorType  NVARCHAR(5)
DECLARE @SampleStatus INT
DECLARE @ProdStatus INT 

DECLARE @Msg VARCHAR(8000) 
SET @Msg = 'OUTPUT'



BEGIN TRANSACTION 

PRINT @Query
EXEC (@Query)

SELECT @StyleColorId = a.StyleColorwayID, @StyleID = a.StyleID, 
@StyleColorDel1 = a.StyleColorDelivery1, @StyleColorDel2 = a.StyleColorDelivery2, 
@StyleColorDel3 = a.StyleColorDelivery3, @StyleColorDel4 = a.StyleColorDelivery4,
@StyleColorCollection = a.CustomField1, @Units = a.Units,  
@ColorType = a.ColorType, @SampleStatus  = a.SampleStatus, @ProdStatus = a.StyleColorStatus,
@SeasonYearID  = b.SeasonYearID 
FROM pStyleColorwaySeasonyear a 
INNER JOIN pStyleSeasonYear b ON a.StyleSeasonYearID = b.StyleSeasonYearID 
WHERE StyleColorwaySeasonYearID =  @StyleColorwaySeasonYearID 

	
EXEC spx_StyleColorwayDeliveryStatus_INSERT @StyleColorID = @StyleColorID,
@StyleID=@StyleID, @StyleColorDel1 = @StyleColorDel1, @StyleColorDel2 = @StyleColorDel2,
@StyleColorDel3 = @StyleColorDel3, @StyleColorDel4 = @StyleColorDel4, 
@MUser=@MUser, @MDate = @MDate ,@StyleColorCollection=@StyleColorCollection,
@Units = @Units, @SeasonYearID = @SeasonYearID,
@ColorType = @ColorType, @SampleStatus = @SampleStatus , @ProdStatus = @ProdStatus,
@outputMsg  = @Msg OUTPUT 


IF @Msg  =  ''
BEGIN 
	COMMIT TRANSACTION 		
	SELECT '' AS Msg
END
ELSE 
BEGIN
	ROLLBACK TRANSACTION
	SELECT @Msg AS Msg

END 




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialRequestSubmitWorkflowGrid_SELECT]'
GO


ALTER PROCEDURE [dbo].[spx_MaterialRequestSubmitWorkflowGrid_SELECT](@MaterialId uniqueidentifier)
AS 


SELECT uTradePartner.TradePartnerName, uTradePartnerVendor.VendorName, pMaterialTradePartnerColor.ColorName, 
	pMaterialTradePartnerColor.MaterialTradePartnerColorID, pMaterialTradePartner.MaterialTradePartnerId, pMaterial.MaterialID, 
	uTradePartner.TradePartnerID, uTradePartnerVendor.TradePartnerVendorID, pMaterial.MaterialNo, pMaterial.MaterialName, 
	pColorPalette.ColorCode, pMaterialTradePartnerColor.ColorNo, 
	pMaterialTradePartnerColor.VendorColorCode, pMaterialTradePartnerColor.VendorColorNo, pMaterialTradePartnerColor.VendorColorName, 
	pMaterialRequestWorkflow.MaterialRequestWorkflowID, 
	CAST(pMaterialRequestSubmitWorkflow.MaterialRequestSubmitWorkflowID AS VARCHAR(40)) AS MaterialRequestSubmitWorkflowID, 
	vwx_MaterialSize_SEL.MaterialSize
INTO #tmpMaterialRequestSubmitWorkflow
FROM vwx_MaterialSize_SEL 
INNER JOIN  pMaterialTradePartnerColor 
INNER JOIN  pMaterialTradePartner ON pMaterialTradePartnerColor.MaterialTradePartnerID = pMaterialTradePartner.MaterialTradePartnerId 
INNER JOIN  uTradePartnerVendor ON pMaterialTradePartner.TradepartnerVendorId = uTradePartnerVendor.TradePartnerVendorID 
INNER JOIN  uTradePartner ON pMaterialTradePartner.TradepartnerId = uTradePartner.TradePartnerID 
INNER JOIN  pMaterial ON pMaterialTradePartner.MaterialId = pMaterial.MaterialID ON   vwx_MaterialSize_SEL.MaterialSizeID = pMaterialTradePartnerColor.MaterialSizeID 
LEFT OUTER JOIN pMaterialColor ON pMaterialColor.MaterialColorID = pMaterialTradePartnerColor.MaterialColorID 
LEFT OUTER JOIN pColorPalette ON pColorPalette.ColorPaletteID = pMaterialColor.ColorPaletteID 
LEFT OUTER JOIN  pMaterialRequestWorkflow 
INNER JOIN pMaterialRequestSubmitWorkflow ON   pMaterialRequestWorkflow.MaterialRequestWorkflowID = pMaterialRequestSubmitWorkflow.MaterialRequestWorkflowID ON   pMaterialTradePartnerColor.MaterialTradePartnerColorID = pMaterialRequestSubmitWorkflow.MaterialTradePartnerColorID
WHERE pMaterialTradePartner.MaterialId = @MaterialId
ORDER BY uTradePartnerVendor.VendorName, pColorPalette.ColorCode


EXECUTE spx_Crosstab 
'SELECT * FROM #tmpMaterialRequestSubmitWorkflow',
NULL,
NULL,
'MaterialRequestWorkflowID',
'MaterialRequestSubmitWorkflowID',
'MAX'



DROP TABLE #tmpMaterialRequestSubmitWorkflow

--SELECT * FROM #tmpMaterialRequestSubmitWorkflow




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleRequestStyleSourcingItemTemp_SELECT]'
GO

/*
Comment #01 - Jan 20 2010 - Clayton Parker
Added DISTINCT to the select because it was repeating each color on the sample selection screen for as 
many materials that were in the sourcing for that color. 
*/

ALTER PROCEDURE [dbo].[spx_SampleRequestStyleSourcingItemTemp_SELECT]  (
@SampleRequestGroupID UNIQUEIDENTIFIER 
)
AS

/*

SELECT DISTINCT  a.StyleSourcingID , a.StyleColorID, b.SourcingName , c.TradePartnerCode , c.TradePartnerName,  
d.VendorCode, d.VendorName , e.MainColor ,  b.TradePartnerID  ,  b.TradePartnerVendorID  
FROM pStyleSourcingItem a WITH (NOLOCK) , 
pStyleSourcing b WITH (NOLOCK) , 
uTradePartner c WITH (NOLOCK), 
uTradePartnerVendor d WITH (NOLOCK), 
pStyleColorway e WITH (NOLOCK)
WHERE a.StyleColorID IN ( 
	SELECT DISTINCT StyleColorID  FROM pSampleRequestStyleColorwayTemp WITH (NOLOCK)
	WHERE SampleRequestGroupID =  @SampleRequestGroupID
)
AND a.StyleSourcingID =  b.StyleSourcingID 
AND b.TradePartnerID  =  c.TradePartnerID  
AND b.TradePartnerVendorID  =  d.TradePartnerVendorID  
AND a.StyleColorID = e.StyleColorID 
ORDER BY a.StyleSourcingID, a.StyleColorID

*/

DECLARE @SeasonYearID  UNIQUEIDENTIFIER 
DECLARE @StyleID UNIQUEIDENTIFIER 
select @SeasonYearID = SeasonYearID, @StyleID = StyleID from  pSampleRequestGroupTemp WHERE SampleRequestGroupID = @SampleRequestGroupID


SELECT DISTINCT c.StyleSourcingID , c.StyleColorID, a.SourcingName ,   --COMMENT #01
e.TradePartnerCode , e.TradePartnerName,  
f.VendorCode, f.VendorName , 
g.ColorName as  MainColor ,  
a.TradePartnerID  ,  a.TradePartnerVendorID  
FROM pStyleSourcingItem c 
INNER JOIN pStyleSourcing a ON a.StyleSourcingID = c.StyleSourcingID 
INNER JOIN pStyleSeasonYear b ON a.StyleSeasonYearID = b.StyleSeasonYearID 
INNER JOIN pStyleColorway d ON d.StyleColorID  = c.StyleColorID
INNER JOIN uTradePartner e ON e.TradePartnerID =  a.TradePartnerID 
INNER JOIN uTradePartnerVendor f ON f.TradePartnerVendorID =  a.TradePartnerVendorID 
INNER JOIN pColorPalette g ON g.ColorPaletteID =  d.ColorPaletteID 
WHERE b.StyleID = @StyleID 
AND b.SeasonYearID = @SeasonYearID
AND c.StyleColorID  IN ( 
	SELECT DISTINCT StyleColorID  FROM pSampleRequestStyleColorwayTemp WITH (NOLOCK)
	WHERE SampleRequestGroupID =  @SampleRequestGroupID
) 
ORDER BY c.StyleSourcingID, c.StyleColorID
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleColorwayFromColor_INSERT]'
GO
/*
'***********************************************************************
' Object name	   : spx_StyleColorwayFromColor_INSERT
' Author           : 
' Created          : 
'
' Last Modified By : Artemio Gomez
' Last Modified On : 12-11-2009
' Description      : Stored procedure used to insert a new colorway to a Style (No Lineplan style).
'
' Copyright        : (c) Yunique Solutions, Inc. All rights reserved.
' Comments		   :
		#01  -	Artemio Gomez - December 11, 2009
				Call a logic procedure after the insert has been done.
'***********************************************************************
*/


ALTER PROCEDURE [dbo].[spx_StyleColorwayFromColor_INSERT]  (
@StyleID UNIQUEIDENTIFIER ,
@StyleSet INT ,
@ColorPaletteID UNIQUEIDENTIFIER , 
@CUser  NVARCHAR (200) , 
@CDate DATETIME , 
@AllSizeClasses INT ,
@SeasonYearID UNIQUEIDENTIFIER  = NULL 
)
AS 

DECLARE @StyleColorID UNIQUEIDENTIFIER  
DECLARE @StyleColorNo varchar(200)
DECLARE @StyleColorName varchar(200)


SELECT @StyleColorNo = ColorCode, @StyleColorName = ColorName FROM pColorPalette WHERE ColorPaletteID = @ColorPaletteID

/**
** Check if a Colorway with the same color Name/Code exists already 
**/
SELECT TOP 1 @StyleColorID = a.StyleColorID
FROM pStyleColorway a
INNER JOIN pColorPalette b ON a.ColorPaletteID = b.ColorPaletteID 
WHERE StyleID = @StyleID 
AND b.ColorCode = @StyleColorNo
AND b.ColorName = @StyleColorName 


/**
** Define PLMCode
**/
DECLARE @PLMCode NVARCHAR (200) 
DECLARE @StyleNo NVARCHAR(20)
SELECT @PLMCode= StyleNo + @StyleColorNo, @StyleNo = StyleNo FROM pStyleHeader WHERE StyleID = @StyleID 


IF @StyleColorID IS NULL
BEGIN 
	SET @StyleColorID = NEWID()
	INSERT INTO pStyleColorway ( StyleColorID, StyleID, StyleSet, StylecolorStandardID , ColorPaletteID , StyleColorNo, StyleColorName,  MainColor,
				CUser, CDate, MUser, MDate , PLMCode) 
	VALUES ( @StyleColorID,  @StyleID, @StyleSet, NULL , @ColorPaletteID , @StyleColorNo, @StyleColorName,  @StyleColorName ,
				@CUser, @CDate, @CUser, @CDate , @PLMCode  ) 
			
END 


EXEC dbo.spx_StyleColorwayItem_FIX  @StyleId = @StyleID ,@StyleSet = 1


/**
** ALWAYS, need a SeasonYearID 
** This for intra/season styles
*/
IF @SeasonYearID  IS NULL
BEGIN
	SELECT TOP 1 @SeasonYearID = SeasonYearID  FROM pStyleSeasonYear
	WHERE StyleID = @StyleID 
END 



BEGIN
	DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER 
	DECLARE @LinePlanItemID  UNIQUEIDENTIFIER 
	DECLARE @ColorStatus INT 
	DECLARE @StyleColorwayDelivery INT 

	SELECT @StyleSeasonYearID = StyleSeasonYearID, @LinePlanItemID  = LinePlanItemID 
	FROM pStyleSeasonYear 
	WHERE StyleID = @StyleID AND SeasonYearID =  @SeasonYearID 

	IF @LinePlanItemID IS NULL 
	BEGIN
		SET @ColorStatus = 800
		SET @StyleColorwayDelivery = 1
	END 
	ELSE 
	BEGIN
		SET @ColorStatus = 100
		SET @StyleColorwayDelivery = 0
	END 

	IF @StyleSeasonYearID IS NULL
	BEGIN
		SET @StyleSeasonYearID = NEWID() 
		
		INSERT INTO pStyleSeasonYear ( StyleSeasonYearID , StyleID , StyleSeason, StyleYear, CUser, CDate, MUser, MDate, SeasonYearID, StyleNo, CurrentSeason )
		SELECT @StyleSeasonYearID, @StyleID , a.Season, a.Year, @CUser, @CDate, @CUser, @CDate,	a.SeasonYearID, @StyleNo, 0
		FROM  pSeasonYear a WHERE a.SeasonYearID = @SeasonYearID
	END 


	IF (SELECT COUNT(*) FROM pStyleColorwaySeasonYear WHERE StyleSeasonYearID = @StyleSeasonYearID AND StyleColorwayID =  @StyleColorID ) = 0
	BEGIN
	
		INSERT INTO  pStyleColorwaySeasonYear ( StyleColorwaySeasonYearID , StyleSeasonYearID , StyleColorwayID , StyleID ,  
		StyleColorDelivery1, StyleColorDelivery2, StyleColorDelivery3, StyleColorDelivery4, 
		StyleColorStatus, Units, SampleStatus, MUser, MDate )
		VALUES ( NEWID(), @StyleSeasonYearID , @StyleColorID , @StyleID ,  
		@StyleColorwayDelivery, @StyleColorwayDelivery,@StyleColorwayDelivery, @StyleColorwayDelivery, 
		@ColorStatus , 0 , @ColorStatus, @CUser, @CDate ) 
	
		/**	
		** --Comment #01
		** Add Logic INSERT 		
		**/
		EXEC spx_StyleColorway_Logic_INSERT @StyleSeasonYearID = @StyleSeasonYearID, @StyleColorID = @StyleColorID, 
		@CUser= @CUser, @CDate = @CDate

	END 
		
END 


/**
** Insert colorway to all size classes 
**/
IF   @AllSizeClasses  =   1  
BEGIN 

	DECLARE @DevelopmentID UNIQUEIDENTIFIER 
	DECLARE @Variation   INT 
	DECLARE @StyleID2  UNIQUEIDENTIFIER 
	DECLARE @Row INT
	DECLARE @Row_current INT 
	

	CREATE TABLE #TmpStyle (	
		Rec_ID INT IDENTITY  (1,1 )  ,
		StyleID UNIQUEIDENTIFIER  
	)


	SELECT @DevelopmentID  = a.DevelopmentID ,  @Variation  =  b.Variation  
	FROM pStyleHeader a , pStyleDevelopmentItem b 
	WHERE a.StyleID = @StyleID 
	AND a.DevelopmentID = b.StyleDevelopmentID
	AND a.StyleID = b.StyleID 

	INSERT INTO  #TmpStyle   ( StyleID   )
	SELECT  StyleID
	FROM pStyleDevelopmentItem 
	WHERE StyleDevelopmentID = @DevelopmentID AND Variation = @Variation 
	AND StyleID <>  @StyleID 

	SELECT @Row  = COUNT(*) FROM #TmpStyle 
	SET @Row_current  =  1


	DECLARE @StyleColorID2 UNIQUEIDENTIFIER
	DECLARE @StyleNo2 NVARCHAR(20)

	WHILE  @Row_current  <= @Row  
	BEGIN 
		SELECT @StyleID2 = StyleID FROM  #TmpStyle WHERE Rec_ID = @Row_current 
		SELECT @PLMCode= StyleNo + @StyleColorNo, @StyleNo2 = StyleNo FROM pStyleHeader WHERE StyleID = @StyleID2		

		SET @StyleColorID2 = NULL

		/**
		** Check if a Colorway with the same color Name/ Code exists already 
		**/
		SELECT TOP 1 @StyleColorID2 = a.StyleColorID
		FROM pStyleColorway a
		INNER JOIN pColorPalette b ON a.ColorPaletteID = b.ColorPaletteID 
		WHERE StyleID = @StyleID2 
		AND b.ColorCode = @StyleColorNo
		AND b.ColorName = @StyleColorName 

		IF @StyleColorID2 IS NULL 
		BEGIN 
			SET @StyleColorID2  = NEWID() 
			INSERT INTO pStyleColorway ( StyleColorID, StyleID, StyleSet, StylecolorStandardID , ColorPaletteID , StyleColorNo, StyleColorName,  MainColor,
						CUser, CDate, MUser, MDate , PLMCode ) 
			VALUES ( @StyleColorID2 ,  @StyleID2, @StyleSet, NULL , @ColorPaletteID , @StyleColorNo, @StyleColorName,  @StyleColorName ,
						@CUser, @CDate, @CUser, @CDate , @PLMCode ) 
						
		END 

		EXEC dbo.spx_StyleColorwayItem_FIX  @StyleId = @StyleID2 ,@StyleSet = 1

		/**
		** ADD Colorway - Season year
		**/
		IF @SeasonYearID  IS NOT NULL 
		BEGIN
			DECLARE @StyleSeasonYearID2 UNIQUEIDENTIFIER 
			SELECT @StyleSeasonYearID2 = StyleSeasonYearID 
			FROM pStyleSeasonYear 
			WHERE StyleID = @StyleID2 AND SeasonYearID =  @SeasonYearID 

			IF @StyleSeasonYearID2 IS NULL
			BEGIN
				SET @StyleSeasonYearID2 = NEWID() 

				INSERT INTO pStyleSeasonYear ( StyleSeasonYearID , StyleID , StyleSeason, StyleYear, CUser, CDate, MUser, MDate,
				SeasonYearID, StyleNo, CurrentSeason )
				SELECT @StyleSeasonYearID2, @StyleID2 , a.Season, a.Year, @CUser, @CDate, @CUser, @CDate,
				a.SeasonYearID, @StyleNo2, 0
				FROM  pSeasonYear a
				WHERE a.SeasonYearID = @SeasonYearID
			END 

			IF (SELECT COUNT(*) FROM pStyleColorwaySeasonYear WHERE StyleSeasonYearID = @StyleSeasonYearID2 AND StyleColorwayID =  @StyleColorID2 ) = 0
			BEGIN 
				INSERT INTO  pStyleColorwaySeasonYear ( StyleColorwaySeasonYearID , StyleSeasonYearID , StyleColorwayID , StyleID ,  
				StyleColorDelivery1, StyleColorDelivery2, StyleColorDelivery3, StyleColorDelivery4, StyleColorStatus, Units , SampleStatus)
				VALUES ( NEWID(), @StyleSeasonYearID2 , @StyleColorID2 , @StyleID2 ,  
				@StyleColorwayDelivery, @StyleColorwayDelivery, @StyleColorwayDelivery, @StyleColorwayDelivery, @ColorStatus, 0,  @ColorStatus) 
				
				/**	
				** --Comment #01
				** Add Logic INSERT 		
				**/	
				EXEC spx_StyleColorway_Logic_INSERT @StyleSeasonYearID = @StyleSeasonYearID2, @StyleColorID = @StyleColorID2, 
				@CUser= @CUser, @CDate = @CDate
				
			END 
				
		END 

		SET @Row_current = @Row_current  + 1 
	END 

	DROP TABLE #TmpStyle


END 










GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleSizeClassNew_Colorways_INSERT]'
GO

CREATE PROCEDURE [dbo].[spx_StyleSizeClassNew_Colorways_INSERT](
@StyleID UNIQUEIDENTIFIER, 
@StyleColorwaySeasonYearID UNIQUEIDENTIFIER,
@CUser NVARCHAR(200), 
@CDate DATETIME 
)
AS 

DECLARE @ColorPaletteID UNIQUEIDENTIFIER
DECLARE @SeasonYearID UNIQUEIDENTIFIER


SELECT @ColorPaletteID = b.ColorPaletteID , @SeasonYearID = d.SeasonYearID
FROM pStyleColorwaySeasonYear a
INNER JOIN pStyleColorway b ON a.StyleColorwayID  = b.StyleColorID 
INNER JOIN pColorPalette  c On c.ColorPaletteID =  b.ColorPaletteID 
INNER JOIN pStyleSeasonYear d ON d.StyleSeasonYearID = a.StyleSeasonYearID
WHERE a.StyleColorwaySeasonYearID = @StyleColorwaySeasonYearID 


EXEC spx_StyleColorwayFromColor_INSERT
@StyleID = @StyleID,
@StyleSet =  1, 
@ColorPaletteID  = @ColorPaletteID ,
@CUser  = @CUser , 
@CDate  = @CDate , 
@AllSizeClasses  = 0 ,
@SeasonYearID = @SeasonYearID 





GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_sSystemString_INSERT]'
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE PROCEDURE [dbo].[spx_sSystemString_INSERT] (
@DesignString nvarchar(4000),
@DesignFormXML varchar(500),
@IsUserString bit
)
AS 

DECLARE @DesignStringID UNIQUEIDENTIFIER

If @IsUserString = 1
	BEGIN
		IF (SELECT COUNT(*) FROM sUserStrings WHERE DesignString = @DesignString) = 0
		BEGIN
			INSERT INTO sUserStrings (DesignString) VALUES (@DesignString)
		END
		
		SELECT @DesignStringID = UserStringID FROM sUserStrings WHERE DesignString = @DesignString
		INSERT INTO sUserXMLStrings (XMLName, UserStringID) VALUES (@DesignFormXML, @DesignStringID)

	END
ELSE
	BEGIN
		IF (SELECT COUNT(*) FROM sSystemStrings WHERE DesignString = @DesignString) = 0
		BEGIN
			INSERT INTO sSystemStrings (DesignString) VALUES (@DesignString)
		END

		SELECT @DesignStringID = SystemStringID FROM sSystemStrings WHERE DesignString = @DesignString
		INSERT INTO sSystemPageStrings (FormName, SystemStringID) VALUES (@DesignFormXML, @DesignStringID)

	END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_ColorLibraryPANTONE_SELECT]'
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE  [dbo].[spx_ColorLibraryPANTONE_SELECT] (
	@ColorLibraryTypeID varchar(40),
	@SqlString varchar(4000),
	@Red as float,
	@Green as float,
	@Blue as float
)
AS

SET @ColorLibraryTypeID  = LOWER (@ColorLibraryTypeID) 

IF @Red = 0 AND @Green = 0 AND @Blue = 0
	BEGIN
		SELECT @SqlString
	END
ELSE
	BEGIN

	DECLARE @bRed as float, @bGreen as float, @bBlue as float
	DECLARE @RedLow float, @GreenLow float, @BlueLow float
	DECLARE @RedMax float, @GreenMax float, @BlueMax float
	DECLARE @RGBMAX as varchar(20)

	CREATE TABLE #tmpColorRGB 
	(
		[ColorName] [varchar](200) NULL,
		[ColorValue] int NULL
	)

	INSERT INTO #tmpColorRGB (ColorName, ColorValue) VALUES ('Red', @Red)
	INSERT INTO #tmpColorRGB (ColorName, ColorValue) VALUES ('Green', @Green)
	INSERT INTO #tmpColorRGB (ColorName, ColorValue) VALUES ('Blue', @Blue)

	SELECT @Red = @Red/255, @Green = @Green/255, @Blue = @Blue/255
	SELECT @bRed = 0.10, @bGreen = 0.10, @bBlue = 0.10

	IF @RGBMAX = 'Red' SET @bGreen = 0.05
	IF @RGBMAX = 'Green' SET @bGreen = 0.05
	IF @RGBMAX = 'Blue' SET @bGreen = 0.05

	SELECT @RedLow = CASE 
		WHEN (@Red - @bRed) > 0 THEN (@Red - @bRed) 
		ELSE 0 END, @RedMax = (@bRed + @Red)

	SELECT @GreenLow = CASE 
		WHEN (@Green - @bGreen) > 0 THEN (@Green - @bGreen) 
		ELSE 0 END, @GreenMax = (@bGreen + @Green)

	SELECT @BlueLow = CASE 
		WHEN (@Blue - @bBlue) > 0 THEN (@Blue - @bBlue) 
		ELSE 0 END, @BlueMax = (@bBlue + @Blue)

	SELECT @RedLow = @RedLow*255, @GreenLow = @GreenLow*255, @BlueLow = @BlueLow*255
	SELECT @RedMax = @RedMax*255, @GreenMax = @GreenMax*255, @BlueMax = @BlueMax*255

	IF @ColorLibraryTypeID = '00000000-0000-0000-0000-00000000000a' --TCX
		BEGIN

			IF (SELECT COUNT(*) FROM ColorLibraryTCX WHERE  sRGB_D65_2_R BETWEEN @RedLow AND @RedMax 
					AND sRGB_D65_2_G BETWEEN @GreenLow AND @GreenMax AND sRGB_D65_2_B BETWEEN @BlueLow AND @BlueMax) <> 0
				BEGIN
					SELECT @SqlString + ' AND sRGB_D65_2_R BETWEEN ' + CAST(@RedLow AS VARCHAR(20)) + ' AND ' + CAST(@RedMax AS VARCHAR(20)) + '
						AND sRGB_D65_2_G BETWEEN ' + CAST(@GreenLow AS VARCHAR(20)) + ' AND ' + CAST(@GreenMax AS VARCHAR(20)) + '
						AND sRGB_D65_2_B BETWEEN ' + CAST(@BlueLow AS VARCHAR(20)) + ' AND ' + CAST(@BlueMax AS VARCHAR(20)) + ' '
				END
			ELSE
				BEGIN

					SELECT @bRed = 0.15, @bGreen = 0.15, @bBlue = 0.15

					IF @RGBMAX = 'Red' SET @bGreen = 0.05
					IF @RGBMAX = 'Green' SET @bGreen = 0.05
					IF @RGBMAX = 'Blue' SET @bGreen = 0.05

					SELECT @RedLow = CASE 
						WHEN (@Red - @bRed) > 0 THEN (@Red - @bRed) 
						ELSE 0 END, @RedMax = (@bRed + @Red)

					SELECT @GreenLow = CASE 
						WHEN (@Green - @bGreen) > 0 THEN (@Green - @bGreen) 
						ELSE 0 END, @GreenMax = (@bGreen + @Green)

					SELECT @BlueLow = CASE 
						WHEN (@Blue - @bBlue) > 0 THEN (@Blue - @bBlue) 
						ELSE 0 END, @BlueMax = (@bBlue + @Blue)

					SELECT @RedLow = @RedLow*255, @GreenLow = @GreenLow*255, @BlueLow = @BlueLow*255
					SELECT @RedMax = @RedMax*255, @GreenMax = @GreenMax*255, @BlueMax = @BlueMax*255

			IF (SELECT COUNT(*) FROM ColorLibraryTCX WHERE  sRGB_D65_2_R BETWEEN @RedLow AND @RedMax 
					AND sRGB_D65_2_G BETWEEN @GreenLow AND @GreenMax AND sRGB_D65_2_B BETWEEN @BlueLow AND @BlueMax) <> 0
				BEGIN
					SELECT @SqlString + ' AND sRGB_D65_2_R BETWEEN ' + CAST(@RedLow AS VARCHAR(20)) + ' AND ' + CAST(@RedMax AS VARCHAR(20)) + '
						AND sRGB_D65_2_G BETWEEN ' + CAST(@GreenLow AS VARCHAR(20)) + ' AND ' + CAST(@GreenMax AS VARCHAR(20)) + '
						AND sRGB_D65_2_B BETWEEN ' + CAST(@BlueLow AS VARCHAR(20)) + ' AND ' + CAST(@BlueMax AS VARCHAR(20)) + ' '
				END
			ELSE

					SELECT @bRed = 0.20, @bGreen = 0.20, @bBlue = 0.20

					IF @RGBMAX = 'Red' SET @bGreen = 0.05
					IF @RGBMAX = 'Green' SET @bGreen = 0.05
					IF @RGBMAX = 'Blue' SET @bGreen = 0.05

					SELECT @RedLow = CASE 
						WHEN (@Red - @bRed) > 0 THEN (@Red - @bRed) 
						ELSE 0 END, @RedMax = (@bRed + @Red)

					SELECT @GreenLow = CASE 
						WHEN (@Green - @bGreen) > 0 THEN (@Green - @bGreen) 
						ELSE 0 END, @GreenMax = (@bGreen + @Green)

					SELECT @BlueLow = CASE 
						WHEN (@Blue - @bBlue) > 0 THEN (@Blue - @bBlue) 
						ELSE 0 END, @BlueMax = (@bBlue + @Blue)

					SELECT @RedLow = @RedLow*255, @GreenLow = @GreenLow*255, @BlueLow = @BlueLow*255
					SELECT @RedMax = @RedMax*255, @GreenMax = @GreenMax*255, @BlueMax = @BlueMax*255

				BEGIN
					SELECT @SqlString + ' AND sRGB_D65_2_R BETWEEN ' + CAST(@RedLow AS VARCHAR(20)) + ' AND ' + CAST(@RedMax AS VARCHAR(20)) + '
						AND sRGB_D65_2_G BETWEEN ' + CAST(@GreenLow AS VARCHAR(20)) + ' AND ' + CAST(@GreenMax AS VARCHAR(20)) + '
						AND sRGB_D65_2_B BETWEEN ' + CAST(@BlueLow AS VARCHAR(20)) + ' AND ' + CAST(@BlueMax AS VARCHAR(20)) + ' '
				END

			END
		END 
	ELSE IF @ColorLibraryTypeID = '00000000-0000-0000-0000-00000000000b' --TPX
		BEGIN

			IF (SELECT COUNT(*) FROM ColorLibraryTPX WHERE  sRGB_D65_2_R BETWEEN @RedLow AND @RedMax 
					AND sRGB_D65_2_G BETWEEN @GreenLow AND @GreenMax AND sRGB_D65_2_B BETWEEN @BlueLow AND @BlueMax) <> 0
				BEGIN
					SELECT @SqlString + ' AND sRGB_D65_2_R BETWEEN ' + CAST(@RedLow AS VARCHAR(20)) + ' AND ' + CAST(@RedMax AS VARCHAR(20)) + '
						AND sRGB_D65_2_G BETWEEN ' + CAST(@GreenLow AS VARCHAR(20)) + ' AND ' + CAST(@GreenMax AS VARCHAR(20)) + '
						AND sRGB_D65_2_B BETWEEN ' + CAST(@BlueLow AS VARCHAR(20)) + ' AND ' + CAST(@BlueMax AS VARCHAR(20)) + ' '
				END
			ELSE
				BEGIN

					SELECT @bRed = 0.15, @bGreen = 0.15, @bBlue = 0.15

					IF @RGBMAX = 'Red' SET @bGreen = 0.05
					IF @RGBMAX = 'Green' SET @bGreen = 0.05
					IF @RGBMAX = 'Blue' SET @bGreen = 0.05

					SELECT @RedLow = CASE 
						WHEN (@Red - @bRed) > 0 THEN (@Red - @bRed) 
						ELSE 0 END, @RedMax = (@bRed + @Red)

					SELECT @GreenLow = CASE 
						WHEN (@Green - @bGreen) > 0 THEN (@Green - @bGreen) 
						ELSE 0 END, @GreenMax = (@bGreen + @Green)

					SELECT @BlueLow = CASE 
						WHEN (@Blue - @bBlue) > 0 THEN (@Blue - @bBlue) 
						ELSE 0 END, @BlueMax = (@bBlue + @Blue)

					SELECT @RedLow = @RedLow*255, @GreenLow = @GreenLow*255, @BlueLow = @BlueLow*255
					SELECT @RedMax = @RedMax*255, @GreenMax = @GreenMax*255, @BlueMax = @BlueMax*255

			IF (SELECT COUNT(*) FROM ColorLibraryTPX WHERE  sRGB_D65_2_R BETWEEN @RedLow AND @RedMax 
					AND sRGB_D65_2_G BETWEEN @GreenLow AND @GreenMax AND sRGB_D65_2_B BETWEEN @BlueLow AND @BlueMax) <> 0
				BEGIN
					SELECT @SqlString + ' AND sRGB_D65_2_R BETWEEN ' + CAST(@RedLow AS VARCHAR(20)) + ' AND ' + CAST(@RedMax AS VARCHAR(20)) + '
						AND sRGB_D65_2_G BETWEEN ' + CAST(@GreenLow AS VARCHAR(20)) + ' AND ' + CAST(@GreenMax AS VARCHAR(20)) + '
						AND sRGB_D65_2_B BETWEEN ' + CAST(@BlueLow AS VARCHAR(20)) + ' AND ' + CAST(@BlueMax AS VARCHAR(20)) + ' '
				END
			ELSE

					SELECT @bRed = 0.20, @bGreen = 0.20, @bBlue = 0.20

					IF @RGBMAX = 'Red' SET @bGreen = 0.05
					IF @RGBMAX = 'Green' SET @bGreen = 0.05
					IF @RGBMAX = 'Blue' SET @bGreen = 0.05

					SELECT @RedLow = CASE 
						WHEN (@Red - @bRed) > 0 THEN (@Red - @bRed) 
						ELSE 0 END, @RedMax = (@bRed + @Red)

					SELECT @GreenLow = CASE 
						WHEN (@Green - @bGreen) > 0 THEN (@Green - @bGreen) 
						ELSE 0 END, @GreenMax = (@bGreen + @Green)

					SELECT @BlueLow = CASE 
						WHEN (@Blue - @bBlue) > 0 THEN (@Blue - @bBlue) 
						ELSE 0 END, @BlueMax = (@bBlue + @Blue)

					SELECT @RedLow = @RedLow*255, @GreenLow = @GreenLow*255, @BlueLow = @BlueLow*255
					SELECT @RedMax = @RedMax*255, @GreenMax = @GreenMax*255, @BlueMax = @BlueMax*255

				BEGIN
					SELECT @SqlString + ' AND sRGB_D65_2_R BETWEEN ' + CAST(@RedLow AS VARCHAR(20)) + ' AND ' + CAST(@RedMax AS VARCHAR(20)) + '
						AND sRGB_D65_2_G BETWEEN ' + CAST(@GreenLow AS VARCHAR(20)) + ' AND ' + CAST(@GreenMax AS VARCHAR(20)) + '
						AND sRGB_D65_2_B BETWEEN ' + CAST(@BlueLow AS VARCHAR(20)) + ' AND ' + CAST(@BlueMax AS VARCHAR(20)) + ' '
				END

			END
		END 
	ELSE IF @ColorLibraryTypeID = '00000000-0000-0000-0000-00000000000c' --PANTONE COATED
			OR @ColorLibraryTypeID = '00000000-0000-0000-0000-00000000000d' --PANTONE UNCOATED
		BEGIN

			DECLARE @Count INT 
			IF @ColorLibraryTypeID = '00000000-0000-0000-0000-00000000000c' 
				SELECT @Count = COUNT(*) FROM PantoneCoated WHERE  sRGB_D65_2_R BETWEEN @RedLow AND @RedMax 
				AND sRGB_D65_2_G BETWEEN @GreenLow AND @GreenMax AND sRGB_D65_2_B BETWEEN @BlueLow AND @BlueMax
			ELSE 
				SELECT @Count = COUNT(*) FROM PantoneUncoated WHERE  sRGB_D65_2_R BETWEEN @RedLow AND @RedMax 
				AND sRGB_D65_2_G BETWEEN @GreenLow AND @GreenMax AND sRGB_D65_2_B BETWEEN @BlueLow AND @BlueMax


			IF @Count <> 0
			BEGIN
				SELECT @SqlString + ' AND sRGB_D65_2_R BETWEEN ' + CAST(@RedLow AS VARCHAR(20)) + ' AND ' + CAST(@RedMax AS VARCHAR(20)) + '
				AND sRGB_D65_2_G BETWEEN ' + CAST(@GreenLow AS VARCHAR(20)) + ' AND ' + CAST(@GreenMax AS VARCHAR(20)) + '
				AND sRGB_D65_2_B BETWEEN ' + CAST(@BlueLow AS VARCHAR(20)) + ' AND ' + CAST(@BlueMax AS VARCHAR(20)) + ' '
			END
			ELSE
			BEGIN

				SELECT @bRed = 0.15, @bGreen = 0.15, @bBlue = 0.15

				IF @RGBMAX = 'Red' SET @bGreen = 0.05
				IF @RGBMAX = 'Green' SET @bGreen = 0.05
				IF @RGBMAX = 'Blue' SET @bGreen = 0.05

				SELECT @RedLow = CASE 
					WHEN (@Red - @bRed) > 0 THEN (@Red - @bRed) 
					ELSE 0 END, @RedMax = (@bRed + @Red)

				SELECT @GreenLow = CASE 
					WHEN (@Green - @bGreen) > 0 THEN (@Green - @bGreen) 
					ELSE 0 END, @GreenMax = (@bGreen + @Green)

				SELECT @BlueLow = CASE 
					WHEN (@Blue - @bBlue) > 0 THEN (@Blue - @bBlue) 
					ELSE 0 END, @BlueMax = (@bBlue + @Blue)

				SELECT @RedLow = @RedLow*255, @GreenLow = @GreenLow*255, @BlueLow = @BlueLow*255
				SELECT @RedMax = @RedMax*255, @GreenMax = @GreenMax*255, @BlueMax = @BlueMax*255

				IF @ColorLibraryTypeID = '00000000-0000-0000-0000-00000000000c' 
					SELECT @Count = COUNT(*) FROM PantoneCoated WHERE  sRGB_D65_2_R BETWEEN @RedLow AND @RedMax 
					AND sRGB_D65_2_G BETWEEN @GreenLow AND @GreenMax AND sRGB_D65_2_B BETWEEN @BlueLow AND @BlueMax
				ELSE 
					SELECT @Count = COUNT(*) FROM PantoneUncoated WHERE  sRGB_D65_2_R BETWEEN @RedLow AND @RedMax 
					AND sRGB_D65_2_G BETWEEN @GreenLow AND @GreenMax AND sRGB_D65_2_B BETWEEN @BlueLow AND @BlueMax


				IF @Count <> 0
				BEGIN
					SELECT @SqlString + ' AND sRGB_D65_2_R BETWEEN ' + CAST(@RedLow AS VARCHAR(20)) + ' AND ' + CAST(@RedMax AS VARCHAR(20)) + '
					AND sRGB_D65_2_G BETWEEN ' + CAST(@GreenLow AS VARCHAR(20)) + ' AND ' + CAST(@GreenMax AS VARCHAR(20)) + '
					AND sRGB_D65_2_B BETWEEN ' + CAST(@BlueLow AS VARCHAR(20)) + ' AND ' + CAST(@BlueMax AS VARCHAR(20)) + ' '
				END
				ELSE
					SELECT @bRed = 0.20, @bGreen = 0.20, @bBlue = 0.20

				IF @RGBMAX = 'Red' SET @bGreen = 0.05
				IF @RGBMAX = 'Green' SET @bGreen = 0.05
				IF @RGBMAX = 'Blue' SET @bGreen = 0.05

				SELECT @RedLow = CASE 
					WHEN (@Red - @bRed) > 0 THEN (@Red - @bRed) 
					ELSE 0 END, @RedMax = (@bRed + @Red)

				SELECT @GreenLow = CASE 
					WHEN (@Green - @bGreen) > 0 THEN (@Green - @bGreen) 
					ELSE 0 END, @GreenMax = (@bGreen + @Green)

				SELECT @BlueLow = CASE 
					WHEN (@Blue - @bBlue) > 0 THEN (@Blue - @bBlue) 
					ELSE 0 END, @BlueMax = (@bBlue + @Blue)

				SELECT @RedLow = @RedLow*255, @GreenLow = @GreenLow*255, @BlueLow = @BlueLow*255
				SELECT @RedMax = @RedMax*255, @GreenMax = @GreenMax*255, @BlueMax = @BlueMax*255

				BEGIN
					SELECT @SqlString + ' AND sRGB_D65_2_R BETWEEN ' + CAST(@RedLow AS VARCHAR(20)) + ' AND ' + CAST(@RedMax AS VARCHAR(20)) + '
					AND sRGB_D65_2_G BETWEEN ' + CAST(@GreenLow AS VARCHAR(20)) + ' AND ' + CAST(@GreenMax AS VARCHAR(20)) + '
					AND sRGB_D65_2_B BETWEEN ' + CAST(@BlueLow AS VARCHAR(20)) + ' AND ' + CAST(@BlueMax AS VARCHAR(20)) + ' '
				END

			END
		END  -- COATED / UNCOTED

END --  @Red = 0 AND @Green = 0 AND @Blue = 0






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_ColorLibraryPANTONEPending_INSERT]'
GO




ALTER PROCEDURE [dbo].[spx_ColorLibraryPANTONEPending_INSERT]  ( 
	@BookOrder int, 
	@PANTONEType varchar(50),
	@ColorPaletteID uniqueidentifier, 
	@ColorFolderID uniqueidentifier, 
	@ColorImage int,
	@CUser nVarchar (200), 
	@CDate datetime,
	@MUser nVarchar (200), 
	@MDate datetime  
) 
AS

DECLARE @SystemServerStorageID UNIQUEIDENTIFIER
DECLARE @ColorCode varchar(50)
DECLARE @ColorHEX varchar(7)

IF @PANTONEType = 'PANTONE TCX'
	BEGIN
		SELECT @ColorCode = PANTONEColor FROM ColorLibraryTCX WHERE BookOrder = @BookOrder AND PANTONEType = 'PANTONE TCX'

		IF (SELECT COUNT(*) FROM pColorPalette WITH (NOLOCK) WHERE ColorFolderID = @ColorFolderID  AND  ColorCode = @ColorCode)  = 0 
		BEGIN 
			IF (SELECT COUNT(*) FROM ColorLibraryPending WITH (NOLOCK) WHERE ColorFolderID = @ColorFolderID  AND  ColorCode = @ColorCode)  = 0 
			BEGIN
				SELECT @SystemServerStorageID = SystemServerStorageID FROM pColorFolder WHERE ColorFolderID = @ColorFolderID

				INSERT INTO ColorLibraryPending (ColorPaletteID, ColorFolderID, ColorCode, ColorName, ColorSource, ColorNotes, 
					HEX, R, G, B, H, S, L, LAB_L, LAB_A, LAB_B, CUser, CDate, MUser, MDate, [Action], ColorImage, SystemServerStorageID) 
				SELECT @ColorPaletteId, @ColorFolderId, PANTONEColor, PANTONEName, PANTONEType, '' AS ColorNotes, 
					sRGB_HTML, sRGB_D65_2_R, sRGB_D65_2_G, sRGB_D65_2_B, 0 AS H, 0 AS S, 0 AS L, 
					CIELab_D50_2_L, CIELab_D50_2_A, CIELab_D50_2_B, @CUser, @CDate, @MUser, @MDate, 1, @ColorImage, @SystemServerStorageID 
				FROM ColorLibraryTCX WHERE BookOrder = @BookOrder

			END
		END
	END
ELSE IF @PANTONEType = 'PANTONE TPX'
	BEGIN
		SELECT @ColorCode = PANTONEColor FROM ColorLibraryTPX WHERE BookOrder = @BookOrder AND PANTONEType = 'PANTONE TPX'

		IF (SELECT COUNT(*) FROM pColorPalette WITH (NOLOCK) WHERE ColorFolderID = @ColorFolderID  AND  ColorCode = @ColorCode)  = 0 
		BEGIN 
			IF (SELECT COUNT(*) FROM ColorLibraryPending WITH (NOLOCK) WHERE ColorFolderID = @ColorFolderID  AND  ColorCode = @ColorCode)  = 0 
			BEGIN		
				SELECT @SystemServerStorageID = SystemServerStorageID FROM pColorFolder WHERE ColorFolderID = @ColorFolderID

				INSERT INTO ColorLibraryPending (ColorPaletteID, ColorFolderID, ColorCode, ColorName, ColorSource, ColorNotes, 
					HEX, R, G, B, H, S, L, LAB_L, LAB_A, LAB_B, CUser, CDate, MUser, MDate, [Action], ColorImage, SystemServerStorageID) 
				SELECT @ColorPaletteId, @ColorFolderId, PANTONEColor, PANTONEName, PANTONEType, '' AS ColorNotes, 
					sRGB_HTML, sRGB_D65_2_R, sRGB_D65_2_G, sRGB_D65_2_B, 0 AS H, 0 AS S, 0 AS L, 
					CIELab_D50_2_L, CIELab_D50_2_A, CIELab_D50_2_B, @CUser, @CDate, @MUser, @MDate, 1, @ColorImage, @SystemServerStorageID 
				FROM ColorLibraryTPX WHERE BookOrder = @BookOrder

			END
		END
	END
ELSE IF @PANTONEType = 'PANTONE COATED'
	BEGIN

		SELECT @ColorCode = PANTONEColor FROM PantoneCoated WHERE BookOrder = @BookOrder AND PANTONEType = 'PANTONE COATED'

		IF (SELECT COUNT(*) FROM pColorPalette WITH (NOLOCK) WHERE ColorFolderID = @ColorFolderID  AND  ColorCode = @ColorCode)  = 0 
		BEGIN 
			IF (SELECT COUNT(*) FROM ColorLibraryPending WITH (NOLOCK) WHERE ColorFolderID = @ColorFolderID  AND  ColorCode = @ColorCode)  = 0 
			BEGIN		
				SELECT @SystemServerStorageID = SystemServerStorageID FROM pColorFolder WHERE ColorFolderID = @ColorFolderID

				INSERT INTO ColorLibraryPending (ColorPaletteID, ColorFolderID, ColorCode, ColorName, ColorSource, ColorNotes, 
					HEX, R, G, B, H, S, L, LAB_L, LAB_A, LAB_B, CUser, CDate, MUser, MDate, [Action], ColorImage, SystemServerStorageID) 
				SELECT @ColorPaletteId, @ColorFolderId, PANTONEColor, PANTONEName, PANTONEType, '' AS ColorNotes, 
					sRGB_HTML, sRGB_D65_2_R, sRGB_D65_2_G, sRGB_D65_2_B, 0 AS H, 0 AS S, 0 AS L, 
					CIELab_D50_2_L, CIELab_D50_2_A, CIELab_D50_2_B, @CUser, @CDate, @MUser, @MDate, 1, @ColorImage, @SystemServerStorageID 
				FROM PantoneCoated WHERE BookOrder = @BookOrder

			END
		END
	END
ELSE IF @PANTONEType = 'PANTONE UNCOATED'
	BEGIN

		SELECT @ColorCode = PANTONEColor FROM PantoneUncoated WHERE BookOrder = @BookOrder AND PANTONEType = 'PANTONE UNCOATED'

		IF (SELECT COUNT(*) FROM pColorPalette WITH (NOLOCK) WHERE ColorFolderID = @ColorFolderID  AND  ColorCode = @ColorCode)  = 0 
		BEGIN 
			IF (SELECT COUNT(*) FROM ColorLibraryPending WITH (NOLOCK) WHERE ColorFolderID = @ColorFolderID  AND  ColorCode = @ColorCode)  = 0 
			BEGIN		
				SELECT @SystemServerStorageID = SystemServerStorageID FROM pColorFolder WHERE ColorFolderID = @ColorFolderID

				INSERT INTO ColorLibraryPending (ColorPaletteID, ColorFolderID, ColorCode, ColorName, ColorSource, ColorNotes, 
					HEX, R, G, B, H, S, L, LAB_L, LAB_A, LAB_B, CUser, CDate, MUser, MDate, [Action], ColorImage, SystemServerStorageID) 
				SELECT @ColorPaletteId, @ColorFolderId, PANTONEColor, PANTONEName, PANTONEType, '' AS ColorNotes, 
					sRGB_HTML, sRGB_D65_2_R, sRGB_D65_2_G, sRGB_D65_2_B, 0 AS H, 0 AS S, 0 AS L, 
					CIELab_D50_2_L, CIELab_D50_2_A, CIELab_D50_2_B, @CUser, @CDate, @MUser, @MDate, 1, @ColorImage, @SystemServerStorageID 
				FROM PantoneUncoated WHERE BookOrder = @BookOrder

			END
		END
	END

ELSE
	BEGIN
		SELECT @ColorCode = PantoneNumber, @ColorHEX = [HEX] FROM ColorLibrary WHERE ID = @BookOrder --AND PantoneType = 'Burberry Default'
		
		IF @ColorHEX IS NULL 
		BEGIN
			SET @ColorImage = 1
		END
			
		IF (SELECT COUNT(*) FROM pColorPalette WITH (NOLOCK) WHERE ColorFolderID = @ColorFolderID  AND  ColorCode = @ColorCode)  = 0 
		BEGIN 
			IF (SELECT COUNT(*) FROM ColorLibraryPending WITH (NOLOCK) WHERE ColorFolderID = @ColorFolderID  AND  ColorCode = @ColorCode)  = 0 
			BEGIN		
				SELECT @SystemServerStorageID = SystemServerStorageID FROM pColorFolder WHERE ColorFolderID = @ColorFolderID

				INSERT INTO ColorLibraryPending (ColorPaletteID, ColorFolderID, ColorCode, ColorName, ColorSource, ColorNotes, 
					HEX, R, G, B, H, S, L, LAB_L, LAB_A, LAB_B, CUser, CDate, MUser, MDate, [Action], ColorImage, SystemServerStorageID) 
				SELECT ColorPaletteID, @ColorFolderID, PantoneNumber,  PantoneName, ColorSource, '', 
					HEX, R, G, B, H, S, L, LAB_L, LAB_A, LAB_B, @CUser, @CDate, @MUser, @MDate, 1, @ColorImage, @SystemServerStorageID
				FROM ColorLibrary WHERE ID = @BookOrder
			
			END
		END
	END







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSampleSize_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_StyleSampleSize_SELECT]
(@StyleID uniqueidentifier)
AS 


IF (SELECT COUNT(*) FROM dbo.pStyleSpecSize WITH (NOLOCK)	WHERE (StyleID = @StyleID)) = 0 
	
	
	BEGIN
	EXEC spx_StyleSpecSize_SELECT @StyleID 

	SELECT StyleID, Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13, Size14, Size15, Size16, Size17, Size18, Size19, 
		Sel0, Sel1, Sel2, Sel3, Sel4, Sel5, Sel6, Sel7, Sel8, Sel9, Sel10, Sel11, Sel12, Sel13, Sel14, Sel15, Sel16, Sel17, Sel18, Sel19, SampleApproved, SampleApprovedBy, SampleApprovedDate
	FROM  dbo.pStyleSpecSize WITH (NOLOCK)
	WHERE (StyleID = @StyleID)


	END
ELSE	

	BEGIN
		SELECT StyleID, Size0, Size1, Size2, Size3, Size4, Size5, Size6, Size7, Size8, Size9, Size10, Size11, Size12, Size13, Size14, Size15, Size16, Size17, Size18, Size19, 
			Sel0, Sel1, Sel2, Sel3, Sel4, Sel5, Sel6, Sel7, Sel8, Sel9, Sel10, Sel11, Sel12, Sel13, Sel14, Sel15, Sel16, Sel17, Sel18, Sel19, SampleApproved, SampleApprovedBy, SampleApprovedDate
		FROM  dbo.pStyleSpecSize WITH (NOLOCK)
		WHERE (StyleID = @StyleID)
	END	



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleLink_Set_SeasonYear_INSERT]'
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE PROCEDURE [dbo].[spx_StyleLink_Set_SeasonYear_INSERT](
	@StyleID UNIQUEIDENTIFIER,
	@NewStyleID UNIQUEIDENTIFIER,
	@SeasonYearID UNIQUEIDENTIFIER,
	@StyleSet INT ,
	@PomTempId NVARCHAR(50),
	@StyleSpecConversion NVARCHAR(10),
	@CUser NVARCHAR(200),
	@CDate DATETIME
)
AS


DECLARE @SizeRange NVARCHAR(100)
DECLARE @SizeClass NVARCHAR(100)
 
SELECT @SizeClass = SizeClass, @SizeRange = SizeRange FROM pPOMTemplate WHERE POMTempId = @POMTempId


IF @StyleSet = 1 
BEGIN 
	--***
	--** INSERT pStyleHeader, pStyleAttribute, pStyleImage, pStyleWorkflow, pStyleDevelopmentItem, pStyleDetail,
	--** pStyleWorkflowSchedule
	--***
	EXEC spx_StyleHeaderLink_INSERT @StyleID = @StyleID, @NewStyleID = @NewStyleID, 
	@SizeClass = @SizeClass, @SizeRange = @SizeRange, @CreatedBy = @CUser, @CreatedDate = @CDate

	--***
	--** Define Style / SeasonYear
	--***
	EXEC spx_StyleSeasonYear_INSERT @StyleID = @NewStyleID, @SeasonYearID = @SeasonYearID, 
	@CUser = @CUser, @CDate = @CDate

	--***
	--** INSERT pStyleMaterials, StyleColorway, StyleColorwaySeasonYear, StyleColorwayItem
	--***
	EXEC spx_StyleMaterialLink_SeasonYear_INSERT @StyleID = @StyleID, @NewStyleID = @NewStyleID, 
	@SeasonYearID = @SeasonYearID, @CUser = @CUser , @CDate = @CDate 	

	--***
	--** INSERT pStyleImageItem
	--***
	EXEC spx_StyleImageItemLink_INSERT  @StyleID = @StyleID, @NewStyleID = @NewStyleID, @CreatedBy = @CUser, @CreatedDate = @CDate 
	
	--***
	--** INSERT pStyleCare
	--***
	EXEC spx_StyleCareCopy_INSERT @StyleID  = @StyleID, @NewStyleID = @NewStyleID, @CreatedBy = @CUser, @CreatedDate = @CDate
	
	--***
	--** INSERT pStyleCostingHeader, pStyleCosting
	--***	
	EXEC spx_StyleCostingCopy_SeasonYear_INSERT @StyleID = @StyleID, @NewStyleID = @NewStyleID, @SeasonYearID = @SeasonYearID, 
	@CreatedBy = @CUser, @CreatedDate = @CDate

END 


--***
--** INSERT pStyleSpec
--***	
EXEC spx_StyleDevelopmentSpecLinkSet_INSERT @StyleID = @StyleID, @NewStyleID = @NewStyleID, @SizeClass = @SizeClass,
@SizeRange = @SizeRange, @CreatedBy = @CUser, @CreatedDate = @CDate, @StyleSet = @StyleSet

--***
--** INSERT pStyleSpecSize
--***	
EXEC spx_StyleSpecSize_SELECT @StyleID = @NewStyleID



IF LOWER(@StyleSpecConversion) = 'true'
BEGIN 
	EXEC spx_StyleSpecReconvert_UPDATE @StyleID = @NewStyleID, @StyleSet  = @StyleSet
	

/*
	--IF (SELECT TOP 1 SpecConversion FROM pSizeClass WHERE (Custom IN (SELECT SizeClass FROM  pStyleHeader WHERE Styleid = @StyleId))) = 1

	IF ( SELECT TOP 1 SpecConversion FROM pSizeClass WHERE Custom = @SizeClass ) = 1
	BEGIN
		
		UPDATE pStyleSpec SET Spec = 0 WHERE StyleId  = @NewStyleID AND StyleSet = @StyleSet 
				
		UPDATE pStyleSpec SET pStyleSpec.Spec = pStyleSpec_1.Spec 
		FROM pStyleSpec INNER JOIN
		pStyleSpec pStyleSpec_1 ON pStyleSpec.POM = pStyleSpec_1.POM AND pStyleSpec.StyleSet = pStyleSpec_1.StyleSet
		WHERE   pStyleSpec.StyleID = @NewStyleId
		AND pStyleSpec_1.StyleID = @StyleId 
		AND pStyleSpec_1.POMTempID IS NOT NULL
		AND pStyleSpec.StyleSet  = @StyleSet 


		UPDATE pStyleSpec SET 
		pStyleSpec.Spec = (ISNULL(pStyleSpec.Spec,0) + ISNULL(pPOMTemplateItem.Conv,0))
		FROM   pStyleSpec INNER JOIN  pPOMTemplateItem ON pStyleSpec.POM = pPOMTemplateItem.POM
		WHERE pStyleSpec.StyleID = @StyleId 
		AND pStyleSpec.StyleSet = @StyleSet 
		AND pPOMTemplateItem.POMTempID = @POMTempId

	END
*/	
END 



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcingItem_DELETE]'
GO
SET QUOTED_IDENTIFIER ON
GO







ALTER PROCEDURE [dbo].[spx_StyleSourcingItem_DELETE] (
@StyleSourcingID UNIQUEIDENTIFIER ,
@StyleColorID UNIQUEIDENTIFIER
)
AS 
BEGIN 

	DECLARE @StyleID UNIQUEIDENTIFIER 
	DECLARE @LinePlanID UNIQUEIDENTIFIER
	DECLARE @LinePlanItemID UNIQUEIDENTIFIER
	DECLARE @LinePlanRangeID UNIQUEIDENTIFIER
	DECLARE @LinePlanAttributeItemID1 UNIQUEIDENTIFIER
	DECLARE @LinePlanAttributeItemID2 UNIQUEIDENTIFIER
	DECLARE @LinePlanAttributeItemID3 UNIQUEIDENTIFIER
	DECLARE @LinePlanAttributeItemID4 UNIQUEIDENTIFIER

	
	SELECT @StyleID = StyleID  FROM pStyleSourcing WHERE StyleSourcingID = @StyleSourcingID

	DELETE FROM pStyleSourcingItem WHERE StyleSourcingID = @StyleSourcingID AND StyleColorID = @StyleColorID
	DELETE FROM pStyleQuoteItem WHERE  StyleSourcingID = @StyleSourcingID AND StyleColorID = @StyleColorID

	-- ROLL-UP  LINEPLAN 

	SELECT 
		@LinePlanID = pLinePlanItem.LinePlanID,
		@LinePlanItemID = pLinePlanItem.LinePlanItemID,
		@LinePlanRangeID = pLinePlanItem.LinePlanRangeID,
		@LinePlanAttributeItemID1 = pLinePlanRange.LinePlanAttributeItemID1, 
		@LinePlanAttributeItemID2 = pLinePlanRange.LinePlanAttributeItemID2, 
		@LinePlanAttributeItemID3 = pLinePlanRange.LinePlanAttributeItemID3, 
		@LinePlanAttributeItemID4 = pLinePlanRange.LinePlanAttributeItemID4
	FROM pLinePlanItem INNER JOIN
	  pLinePlanRange ON pLinePlanItem.LinePlanRangeID = pLinePlanRange.LinePlanRangeID
	WHERE pLinePlanItem.StyleID = @StyleID

	IF  @LinePlanID IS NOT NULL AND @LinePlanRangeID IS NOT NULL
	BEGIN

		DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER

		SELECT @StyleSeasonYearID = StyleSeasonYearID 
		FROM pStyleSeasonYear 
		WHERE LinePlanID = @LinePlanID 
		AND LinePlanItemID =  @LinePlanItemID
		AND StyleID = @StyleID 

/*
		exec spx_LinePlanBusinessItemLogic_UPDATE NULL, @StyleID, @LinePlanID, @LinePlanRangeID, 
		@LinePlanAttributeItemID1, @LinePlanAttributeItemID2, @LinePlanAttributeItemID3, @LinePlanAttributeItemID4, @StyleSeasonYearID

		exec spx_LinePlanBusinessItemRollup_INSERT 
		@LinePlanID = @LinePlanID, 
		@LinePlanAttributeItemID1 = @LinePlanAttributeItemID1, 
		@LinePlanAttributeItemID2 = @LinePlanAttributeItemID2, 
		@LinePlanAttributeItemID3 = @LinePlanAttributeItemID3, 
		@LinePlanAttributeItemID4 = @LinePlanAttributeItemID4, 
		@Cmd = 'DELETE', 
		@StyleSeasonYearID = @StyleSeasonYearID
*/

		EXEC spx_LinePlanBusinessItem_QUEUE 
		@StyleQuoteItemID = NULL,
		@StyleID = @StyleID,
		@LinePlanID = @LinePlanID, 
		@LinePlanRangeID = @LinePlanRangeID,
		@LinePlanAttributeItemID1 = @LinePlanAttributeItemID1, 
		@LinePlanAttributeItemID2 = @LinePlanAttributeItemID2,
		@LinePlanAttributeItemID3 = @LinePlanAttributeItemID3,
		@LinePlanAttributeItemID4 = @LinePlanAttributeItemID4,
		@StyleSeasonYearID = @StyleSeasonYearID,
		@Cmd  = 'DELETE'

	END 



END 











GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleColorwayItem_Linked_UPDATE]'
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE PROCEDURE [dbo].[spx_StyleColorwayItem_Linked_UPDATE]
(
	@MaterialColorID uniqueidentifier,
	@StyleMaterialID uniqueidentifier = NULL,
	@StyleColorItemID uniqueidentifier = NULL,	
	@StyleID uniqueidentifier = NULL,
	@StyleSet int = 1,
	@SeasonYearID uniqueidentifier = NULL,
	@AllColor int = 0,
	@MUser nvarchar(200),
	@MDate datetime, 
	@AllSize INT = 0 
) 
AS

/************************/
/*Declare variables.	*/
/************************/
DECLARE @StyleMaterialID_Param UNIQUEIDENTIFIER			--Keep a copy of the original parameter value.
DECLARE @StyleColorItemID_Param UNIQUEIDENTIFIER		--Keep a copy of the original parameter value.
DECLARE @StyleID_Param UNIQUEIDENTIFIER					--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT								--Keep a copy of the original parameter value.
DECLARE @StyleLinkID UNIQUEIDENTIFIER
DECLARE @MainMaterial INT
DECLARE @StyleMaterialLinkID UNIQUEIDENTIFIER			--To find the the same Material in the other Styles.
DECLARE @ColorPaletteID UNIQUEIDENTIFIER				--To find the the same Colorway in the other Styles.

DECLARE @TotalCount INT
DECLARE @RowCounter INT

--***
--** Get Main ColorPaletteID from pStyleColorway 
--***
SELECT @ColorPaletteID = a.ColorPaletteID 
FROM pStyleColorway a 
INNER JOIN pStyleColorwayItem b ON a.StyleColorID =  b.StyleColorID 
WHERE b.StyleColorItemID  = @StyleColorItemID

/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleMaterialID_Param = @StyleMaterialID
SET @StyleColorItemID_Param = @StyleColorItemID
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	,StyleMaterialID UNIQUEIDENTIFIER
	,StyleMaterialLinkID UNIQUEIDENTIFIER
	,StyleColorItemID UNIQUEIDENTIFIER
	)  ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'MainMaterial' value for checking later on.*/
SELECT @MainMaterial = MainMaterial
FROM pStyleMaterials
WHERE StyleMaterialID = @StyleMaterialID_Param


/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID

/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000' OR @MainMaterial = 1)	--Style is not Multi-Cloth linked, or this is a Main Material.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleColorwayItem_UPDATE
			@MaterialColorID
			,@StyleMaterialID_Param
			,@StyleColorItemID_Param
			,@StyleID_Param
			,@StyleSet_Param
			,@SeasonYearID
			,@AllColor
			,@MUser
			,@MDate
	END
ELSE	--Style is Multi-Cloth linked and this is not a Main Material.
	BEGIN
	
	
		/****************************************************************/
		/*Get the 'StyleMaterialID' information for the linked Styles.	*/
		/****************************************************************/
		/*Clear variables.*/
		SET @StyleMaterialLinkID = NULL


		/*Get the 'StyleMaterialLinkID' value of the calling Style.*/
		SELECT @StyleMaterialLinkID = StyleMaterialLinkID
		FROM pStyleMaterials
		WHERE StyleMaterialID = @StyleMaterialID_Param
		
		/*Get Main ColorPaletteID from pStyleColorway */
		/*
		SELECT @ColorPaletteID = ColorPaletteID FROM pStyleColorway WHERE StyleColorID IN 
				(SELECT StyleColorID FROM pStyleColorwayItem WHERE StyleColorItemID = @StyleColorItemID)
		*/
	
		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
				StyleID
				,StyleLinkID
				,StyleSet
				,StyleMaterialID 
				,StyleMaterialLinkID
				,StyleColorItemID)	
		SELECT	pStyleMaterials.StyleID
				,@StyleLinkID
				,@StyleSet
				,pStyleMaterials.StyleMaterialID 
				,@StyleMaterialLinkID 	   
				,pStyleColorwayItem.StyleColorItemID 
		FROM dbo.pStyleMaterials INNER JOIN
			  dbo.pStyleColorwayItem ON dbo.pStyleMaterials.StyleMaterialID = dbo.pStyleColorwayItem.StyleMaterialID INNER JOIN
			  dbo.pStyleColorway ON dbo.pStyleColorwayItem.StyleColorID = dbo.pStyleColorway.StyleColorID	
		WHERE pStyleMaterials.StyleMaterialLinkID = @StyleMaterialLinkID AND pStylecolorway.ColorPaletteID = @ColorPaletteID 
				AND pStyleMaterials.StyleID IN (SELECT StyleID FROM pStyleHeader WHERE StyleLinkID = @StyleLinkID)
			
	END


/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @StyleMaterialID = NULL
		SET @StyleColorItemID = NULL
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Get the 'StyleID' for the delete.*/
		SELECT @StyleMaterialID = StyleMaterialID
			,@StyleColorItemID = StyleColorItemID
			,@StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleColorwayItem_UPDATE
			@MaterialColorID
			,@StyleMaterialID
			,@StyleColorItemID
			,@StyleID
			,@StyleSet
			,@SeasonYearID
			,@AllColor
			,@MUser
			,@MDate


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked



IF @AllSize = 1 
BEGIN
	
	DECLARE @StyleMaterialMasterID UNIQUEIDENTIFIER
	DECLARE @StyleDevelopmentID UNIQUEIDENTIFIER
	
	SELECT @StyleMaterialMasterID = a.StyleMaterialMasterID , @StyleDevelopmentID  = b.DevelopmentID 
	FROM pStyleMaterials a 
	INNER JOIN pStyleHeader b ON a.StyleID = b.StyleID 
	WHERE a.StyleMaterialID = @StyleMaterialID
	
	--Select @StyleMaterialMasterID as StyleMaterialMasterID , @StyleDevelopmentID  as StyleDevelopmentID  
	
	IF @StyleMaterialMasterID IS NOT NULL AND @StyleDevelopmentID  IS NOT NULL 
	BEGIN 
	
		CREATE TABLE #tmp(
			ROWID  INT IDENTITY(1,1),
			StyleID UNIQUEIDENTIFIER, 
			StyleMaterialID UNIQUEIDENTIFIER, 
			StyleColorItemID UNIQUEIDENTIFIER
		)
		
		INSERT INTO #tmp ( StyleID, StyleMaterialID, StyleColorItemID )
		SELECT d.StyleID, f.StyleMaterialID, e.StyleColorItemID 
		FROM pStyleDevelopmentItem a
		INNER JOIN pStyleSeasonYear b ON a.StyleID = b.StyleID 
		INNER JOIN pStyleColorwaySeasonYear c On c.StyleSeasonYearID =  b.StyleSeasonYearID
		INNER JOIN pStyleColorway d ON d.StyleColorID = c.StyleColorwayID 
		INNER JOIN pStyleColorwayItem e On e.StyleColorID = d.StyleColorID
		INNER JOIN pStyleMaterials f ON f.StyleMaterialID =  e.StyleMaterialID 
		WHERE  a.StyleDevelopmentID = @StyleDevelopmentID 
		AND SeasonyearID = @SeasonyearID 
		AND ColorPaletteID = @ColorPaletteID
		AND f.MaterialLinked = 1
		AND f.StyleMaterialMasterID = @StyleMaterialMasterID
		AND f.StyleMaterialID <> @StyleMaterialID


		DECLARE @StyleID_SC UNIQUEIDENTIFIER 
		DECLARE @StyleMaterialID_SC UNIQUEIDENTIFIER 
		DECLARE @StyleColorItemID_SC UNIQUEIDENTIFIER 
		DECLARE @TOTAL INT
		DECLARE @ROWID INT
		
		SELECT @TOTAL  = COUNT(*) FROM #tmp 
		SET @ROWID = 1 	
		
		
		WHILE @ROWID <= @TOTAL 
		BEGIN
			SELECT @StyleID_SC = StyleID , @StyleMaterialID_SC = StyleMaterialID, @StyleColorItemID_SC = StyleColorItemID 
			FROM #tmp WHERE ROWID = @ROWID 
		
			exec spx_StyleColorwayItem_Linked_UPDATE 
			@MaterialColorID = @MaterialColorID,
			@StyleMaterialID = @StyleMaterialID_SC,
			@StyleColorItemID = @StyleColorItemID_SC,
			@StyleID = @StyleID_SC,
			@StyleSet = @StyleSet,
			@SeasonYearId = @SeasonYearId,
			@AllColor= @AllColor,
			@MUser = @MUser,
			@MDate = @MDate,
			@AllSize = 0 
		
			SET @ROWID = @ROWID  + 1 
		END 

		DROP TABLE #tmp

	END 

END 




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Quote_Message_INSERT]'
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[spx_Quote_Message_INSERT]
(@QuoteFolderMessageID nvarchar(50),
@QuoteTo nvarchar(50),
@QuoteSubject nvarchar(50),
@QuoteMessage nvarchar(50),
@QuoteFolderTeamID uniqueidentifier,
@QuoteFolderItemID uniqueidentifier,
@UserName nvarchar(50),
@UserDate nvarchar(50),
@QuoteMessageStatus nvarchar(50))
AS



IF (SELECT COUNT(*)  FROM   pQuoteFolderItemMessage WITH (NOLOCK) WHERE  QuoteFolderTeamID = @QuoteFolderTeamID AND QuoteFolderItemID = @QuoteFolderItemID) = 0

INSERT INTO dbo.pQuoteFolderItemMessage
                      (QuoteFolderMessageID, QuoteFolderTeamID, QuoteFolderID, QuoteFolderItemID, StyleID, TeamID, QuoteFolderItemStatus, QuoteTo, QuoteSubject, 
                      QuoteMessage, CUser, CDate, MUser, MDate, QuoteMessageStatus)
SELECT     @QuoteFolderMessageID AS QuoteFolderMessageID, QuoteFolderTeamID, QuoteFolderID, QuoteFolderItemID, StyleID, TeamID, 
                      QuoteFolderItemStatus, @QuoteTo AS QuoteTo, @QuoteSubject AS QuoteSubject, @QuoteMessage AS QuoteMessage, @UserName, @UserDate, 
                      @UserName, @UserDate, @QuoteMessageStatus
FROM         dbo.pQuoteFolderItemTeam WITH (NOLOCK)
WHERE     (QuoteFolderTeamID = @QuoteFolderTeamID)


ELSE

UPDATE    dbo.pQuoteFolderItemMessage
SET              QuoteFolderItemStatus ='', QuoteTo =@QuoteTo, QuoteSubject =@QuoteSubject, QuoteMessage =@QuoteMessage, QuoteMessageStatus =@QuoteMessageStatus, MUser =@UserName, MDate =@UserDate
  WHERE     (QuoteFolderTeamID = @QuoteFolderTeamID) AND (QuoteFolderItemID = @QuoteFolderItemID)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Quote_Message_Reply_SELECT]'
GO

ALTER PROCEDURE [dbo].[spx_Quote_Message_Reply_SELECT](@QuoteFolderID uniqueidentifier,
@TeamID uniqueidentifier)
AS SELECT     dbo.pQuoteFolderItem.QuoteFolderItemID, dbo.pQuoteFolderItemTeam.QuoteFolderID, dbo.pQuoteFolderItem.StyleID, 
                      dbo.pQuoteFolderItem.CustomField1, dbo.pQuoteFolderItem.CustomField2, dbo.pQuoteFolderItem.CustomField3, dbo.pQuoteFolderItem.CustomField4, 
                      dbo.pQuoteFolderItem.CustomField5, dbo.pQuoteFolderItem.CustomField6, dbo.pQuoteFolderItem.CustomField7, dbo.pQuoteFolderItem.CustomField8, 
                      dbo.pQuoteFolderItem.CustomField9, dbo.pQuoteFolderItem.CustomField10, dbo.pQuoteFolderItem.CustomField11, 
                      dbo.pQuoteFolderItem.CustomField12, dbo.pQuoteFolderItem.CustomField13, dbo.pQuoteFolderItem.CustomField14, 
                      dbo.pQuoteFolderItem.CustomField15, dbo.pQuoteFolderItem.CUser, dbo.pQuoteFolderItem.CDate, dbo.pQuoteFolderItem.MUser, 
                      dbo.pQuoteFolderItem.MDate, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.Description, dbo.pStyleHeader.DesignSketchID, 
                      dbo.pStyleHeader.DesignSketchVersion, dbo.pStyleHeader.StyleStatus, dbo.pQuoteFolderItem.PDFFile, dbo.pQuoteFolderItemTeam.TeamID, 
                      dbo.pQuoteFolderItemTeam.EstimatedCostType, dbo.pQuoteFolderItemTeam.EstimatedCost, dbo.pQuoteFolderItemTeam.EstimatedCostCur, 
                      dbo.pQuoteFolderItemTeam.VendorCostType, dbo.pQuoteFolderItemTeam.VendorCost, dbo.pQuoteFolderItemTeam.VendorCostCur, 
                      dbo.pQuoteFolderItemTeam.FinalCostType, dbo.pQuoteFolderItemTeam.FinalCost, dbo.pQuoteFolderItemTeam.FinalCostCur, 
                      dbo.pQuoteFolderItem.PDFDate, dbo.pQuoteFolderItem.PDFUser, dbo.pQuoteFolderItem.QuoteComments, 
                      dbo.pQuoteFolderItemTeam.QuoteFolderTeamID, dbo.pQuoteFolderItemTeam.QuoteFolderItemStatus
FROM         dbo.pQuoteFolderItem WITH (NOLOCK) INNER JOIN
                      dbo.pStyleHeader WITH (NOLOCK) ON dbo.pQuoteFolderItem.StyleID = dbo.pStyleHeader.StyleID INNER JOIN
                      dbo.pQuoteFolderItemTeam WITH (NOLOCK) ON dbo.pQuoteFolderItem.QuoteFolderItemID = dbo.pQuoteFolderItemTeam.QuoteFolderItemID
WHERE     (dbo.pQuoteFolderItemTeam.TeamID = @TeamID) AND (dbo.pQuoteFolderItemTeam.QuoteFolderID = @QuoteFolderID) AND 
                      (dbo.pQuoteFolderItem.PDFFile = 1) AND (dbo.pQuoteFolderItemTeam.QuoteFolderItemStatus = N'In Progress' OR
                      dbo.pQuoteFolderItemTeam.QuoteFolderItemStatus = N'')
ORDER BY dbo.pQuoteFolderItem.PDFFile DESC, dbo.pStyleHeader.StyleNo



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Material_DELETE]'
GO
ALTER PROCEDURE [dbo].[spx_Material_DELETE]
(@MaterialID uniqueidentifier,
@CreatedDate datetime,
@CreatedBy nvarchar(200))
AS 


	DELETE FROM pMaterialRequestSubmitComment WHERE MaterialID = @MaterialID
	DELETE FROM pMaterialRequestSubmitWorkflow WHERE MaterialID = @MaterialID

	DELETE FROM pMaterialRequestSubmitItem 
	WHERE MaterialRequestSubmitID IN 
	(SELECT MaterialRequestSubmitID FROM pMaterialRequestSubmit WHERE MaterialTradePartnerID IN 
	(SELECT MaterialTradePartnerId FROM pMaterialTradePartner WHERE MaterialID = @MaterialID))

	DELETE FROM pMaterialRequestSubmit WHERE MaterialTradePartnerID IN (SELECT MaterialTradePartnerID FROM pMaterialTradePartner WHERE MaterialID = @MaterialID)
	
	DELETE FROM pMaterialTradePartnerColor WHERE MaterialID = @MaterialID
	DELETE FROM pMaterialTradePartner WHERE MaterialID = @MaterialID

	DELETE FROM pMaterialContent WHERE MaterialID = @MaterialID
	DELETE FROM pMaterialTesting WHERE (MaterialID = @MaterialID)
	DELETE FROM pMaterialHistory WHERE (MaterialID = @MaterialID)
	DELETE FROM pMaterialColor WHERE (MaterialID = @MaterialID)
	DELETE FROM pMaterialSize WHERE (MaterialID = @MaterialID)
	DELETE FROM pMaterialDesign WHERE (MaterialID = @MaterialID)
	DELETE FROM pMaterialSeasonYear WHERE (MaterialID = @MaterialID)
	DELETE FROM pMaterialColorSeasonYear WHERE (MaterialID = @MaterialID)
	DELETE FROM pMaterial WHERE (MaterialID = @MaterialID)


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_AccessFolderUserPermissions_UPDATE]'
GO

ALTER PROCEDURE [dbo].[spx_Group_AccessFolderUserPermissions_UPDATE] (
@GroupID uniqueidentifier ,
@FullName as nvarchar (200) ,
@CDate  as DateTime,
@FolderName as nvarchar (100) 
)
AS

DECLARE @TeamID uniqueidentifier
DECLARE @DeskFolderID INT

SET NOCOUNT ON

-- GET USERS IN THE GROUP 

DECLARE cursor_users CURSOR FOR	
SELECT TeamID FROM uUserGroup WITH (NOLOCK) WHERE GroupID = @GroupID

OPEN cursor_users

FETCH NEXT FROM cursor_users INTO @TeamID


WHILE @@FETCH_STATUS = 0 
BEGIN

	--SELECT USUARIO = @TeamID

	
	IF @FolderName = 'STYLE'  
	BEGIN

		/********************************************************************************************************************************************************************/
		-- STYLE FOLDER
		DELETE FROM sAccessStyleFolder where TeamID = @TeamID

		INSERT INTO sAccessStyleFolder (StyleTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessRemove, AccessDelete , AccessPrint ,TeamId, CUser, CDate, MUser, MDate   )
		SELECT  StyleTypeId , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
		MAX ( AccessModify )  AS AccessModify  , MAX ( AccessRemove ) AS AccessRemove , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId ,
		@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
		FROM sAccessGroupStyleFolder WITH (NOLOCK)
		WHERE GroupID IN ( 
			SELECT  a.GroupID 
			FROM uUserGroup a WITH (NOLOCK), uGroup b WITH (NOLOCK), cDeskGroupFolderAccess c WITH (NOLOCK)
			WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
			AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 2 
		) 
		GROUP BY StyleTypeId  


		SET @DeskFolderID  =  2
		IF ( SELECT count(*) FROM sAccessStyleFolder WITH (NOLOCK) WHERE TeamId = @TeamID ) > 0  
		BEGIN 
			IF ( SELECT Count(*) FROM cDeskUserFolderAccess WITH (NOLOCK) WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
				UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
			ELSE 
				INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
				VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )
		END
		ELSE

			DELETE FROM  cDeskUserFolderAccess WHERE TeamID =@TeamID and DeskFolderId = @DeskFolderId 
	END 	
	

	ELSE IF @FolderName = 'LINEPLAN'  
	BEGIN

		/********************************************************************************************************************************************************************/
		-- LINEPLAN FOLDER
		DELETE FROM sAccessLinePlanFolder where TeamID = @TeamID

		INSERT INTO sAccessLinePlanFolder (LinePlanTemplateId, CustomID, AccessRoleId , AccessPlanView, AccessPlanNew, AccessPlanDelete ,  AccessHierView, AccessHierNew , AccessHierDelete ,TeamId, CUser, CDate, MUser, MDate   )
		SELECT  LinePlanTemplateId, CustomID, MAX(AccessRoleID ) AS  AccessRoleId  , MAX(AccessPlanView) AS  AccessPlanView,  MAX(AccessPlanNew) AS AccessPlanNew , 
		MAX(AccessPlanDelete) AS AccessPlanDelete, MAX(AccessHierView) AS AccessHierView , MAX(AccessHierNew) AS AccessHierNew, MAX (AccessHierDelete) AS AccessHierDelete, @TeamID AS TeamId ,
		@FullName AS CUser, @CDate AS CDate , @FullName as MUser , @CDate as MDate
		FROM sAccessGroupLinePlanFolder WITH (NOLOCK)
		WHERE GroupID IN ( 
			SELECT  a.GroupID 
			FROM uUserGroup a WITH (NOLOCK), uGroup b WITH (NOLOCK), cDeskGroupFolderAccess c WITH (NOLOCK)
			WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
			AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 2 
		) 
		GROUP BY LinePlanTemplateId, CustomID 


		SET @DeskFolderID  =  13
		IF ( SELECT count(*) FROM sAccessLinePlanFolder WITH (NOLOCK) WHERE TeamId = @TeamID ) > 0  
			BEGIN 
				IF ( SELECT Count(*) FROM cDeskUserFolderAccess WITH (NOLOCK) WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
					UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
				ELSE 
					INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
					VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )
			END
		ELSE
			DELETE FROM  cDeskUserFolderAccess WHERE TeamID =@TeamID and DeskFolderId = @DeskFolderId 
	END 		

	
	ELSE IF @FolderName = 'LINE'  
	BEGIN

		/********************************************************************************************************************************************************************/
		-- LINE FOLDER
		DELETE FROM sAccessLineFolder where TeamID = @TeamID
		
		INSERT INTO sAccessLineFolder (LineTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
		SELECT  1 as LineTypeId , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
		MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
		@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
		FROM sAccessGroupLineFolder WITH (NOLOCK)
		WHERE GroupID IN (
			SELECT  a.GroupID 
			FROM uUserGroup a WITH (NOLOCK), uGroup b WITH (NOLOCK), cDeskGroupFolderAccess c WITH (NOLOCK)
			WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
			AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 3
		) 
		GROUP BY LineTypeId

		IF ( SELECT count(*) FROM sAccessLineFolder WITH (NOLOCK) WHERE TeamId = @TeamID ) > 0  
		BEGIN 
			SET @DeskFolderID  =  3
			IF ( SELECT Count(*) FROM cDeskUserFolderAccess WITH (NOLOCK) WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
				UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
			ELSE 
				INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
				VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

		END 
		
	END 
	
	ELSE 	IF @FolderName = 'QUOTATION'  
	BEGIN

		/********************************************************************************************************************************************************************/
		-- QUOTATION FOLDER
		DELETE FROM sAccessQuotationFolder  where TeamID = @TeamID
		
		INSERT INTO sAccessQuotationFolder (StyleTypeID,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
		SELECT  StyleTypeID , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
		MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
		@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
		FROM sAccessGroupQuotationFolder WITH (NOLOCK)
		WHERE GroupID IN ( 
			SELECT  a.GroupID 
			FROM uUserGroup a WITH (NOLOCK), uGroup b WITH (NOLOCK), cDeskGroupFolderAccess c WITH (NOLOCK)
			WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
			AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 4 
		) 
		GROUP BY StyleTypeID

		IF ( SELECT count(*) FROM sAccessQuotationFolder WITH (NOLOCK) WHERE TeamId = @TeamID ) > 0  
		BEGIN 
			SET @DeskFolderID  =  4
			IF ( SELECT Count(*) FROM cDeskUserFolderAccess  WITH (NOLOCK) WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
				UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
			ELSE 
				INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
				VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

		END 
	
	END
	ELSE 	IF @FolderName = 'SAMPLE'  
	BEGIN


		/********************************************************************************************************************************************************************/
		-- SAMPLE FOLDER
		DELETE FROM sAccessSampleFolder  where TeamID = @TeamID
		
		INSERT INTO sAccessSampleFolder (SampleTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessRemove, AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
		SELECT  SampleTypeId  , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
		MAX ( AccessModify )  AS AccessModify  , MAX ( AccessRemove ) AS AccessRemove , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
		@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
		FROM sAccessGroupSampleFolder WITH (NOLOCK)
		WHERE GroupID IN ( 
			SELECT  a.GroupID 
			FROM uUserGroup a WITH (NOLOCK), uGroup b  WITH (NOLOCK), cDeskGroupFolderAccess c WITH (NOLOCK)
			WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
			AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 5 
		) 
		GROUP BY SampleTypeId

		IF ( SELECT count(*) FROM sAccessSampleFolder WITH (NOLOCK) WHERE TeamId = @TeamID ) > 0  
		BEGIN 
			SET @DeskFolderID  =  5
			IF ( SELECT Count(*) FROM cDeskUserFolderAccess  WITH (NOLOCK) WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
				UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
			ELSE 
				INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
				VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

		END 

	END 
	ELSE  IF @FolderName = 'IMAGE'  
	BEGIN

		/********************************************************************************************************************************************************************/
		-- IMAGE FOLDER
		DELETE FROM sAccessImageFolder  where TeamID = @TeamID
		
		INSERT INTO sAccessImageFolder (ImageTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
		SELECT  ImageTypeId , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
		MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
		@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
		FROM sAccessGroupImageFolder WITH (NOLOCK)
		WHERE GroupID IN ( 
			SELECT  a.GroupID 
			FROM uUserGroup a WITH (NOLOCK), uGroup b WITH (NOLOCK), cDeskGroupFolderAccess c WITH (NOLOCK)
			WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
			AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 6 
		) 
		GROUP BY ImageTypeId


		IF ( SELECT count(*) FROM sAccessImageFolder WITH (NOLOCK) WHERE TeamId = @TeamID ) > 0  
		BEGIN 
			SET @DeskFolderID  =  6
			IF ( SELECT Count(*) FROM cDeskUserFolderAccess WITH (NOLOCK) WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
				UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
			ELSE 
				INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
				VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

		END 
	
	END 
	ELSE 	IF @FolderName = 'COLOR'  
	BEGIN

		/********************************************************************************************************************************************************************/
		-- COLOR FOLDER
		DELETE FROM sAccessColorFolder WHERE TeamID = @TeamID
		
		INSERT INTO sAccessColorFolder (ColorTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
		SELECT  ColorTypeId  , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
		MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
		@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
		FROM sAccessGroupColorFolder WITH (NOLOCK)
		WHERE GroupID IN ( 
			SELECT  a.GroupID 
			FROM uUserGroup a WITH (NOLOCK), uGroup b WITH (NOLOCK), cDeskGroupFolderAccess c WITH (NOLOCK)
			WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
			AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 7 	
		) 
		GROUP BY ColorTypeId


		IF ( SELECT count(*) FROM sAccessColorFolder WITH (NOLOCK) WHERE TeamId = @TeamID ) > 0  
		BEGIN 
			SET @DeskFolderID  =  7
			IF ( SELECT Count(*) FROM cDeskUserFolderAccess WITH (NOLOCK) WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
				UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
			ELSE 
				INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
				VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

		END 

	END 
	ELSE IF @FolderName = 'MATERIAL'  
	BEGIN


		/********************************************************************************************************************************************************************/
		-- MATERIAL FOLDER
		DELETE FROM sAccessMaterialFolder WHERE TeamID = @TeamID
		
		INSERT INTO sAccessMaterialFolder (ComponentTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
		SELECT  ComponentTypeId  , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
		MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
		@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
		FROM sAccessGroupMaterialFolder WITH (NOLOCK)
		WHERE GroupID IN ( 
			SELECT  a.GroupID 
			FROM uUserGroup a WITH (NOLOCK), uGroup b WITH (NOLOCK), cDeskGroupFolderAccess c WITH (NOLOCK)
			WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
			AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 8 
		) 
		GROUP BY ComponentTypeId

		IF ( SELECT count(*) FROM sAccessMaterialFolder WITH (NOLOCK) WHERE TeamId = @TeamID ) > 0  
		BEGIN 
			SET @DeskFolderID  =  8
			IF ( SELECT Count(*) FROM cDeskUserFolderAccess WITH (NOLOCK) WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
				UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
			ELSE 
				INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
				VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

		END 

	END 
	ELSE IF @FolderName = 'COMPLIANCE'  
	BEGIN

		/********************************************************************************************************************************************************************/
		-- COMPLIANCE FOLDER
		DELETE FROM sAccessComplianceFolder WHERE TeamID = @TeamID
		
		INSERT INTO sAccessComplianceFolder (ComplianceTypeId ,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
		SELECT  ComplianceTypeId  , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
		MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
		@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
		FROM sAccessGroupComplianceFolder WITH (NOLOCK)
		WHERE GroupID IN ( 
			SELECT  a.GroupID 
			FROM uUserGroup a WITH (NOLOCK), uGroup b WITH (NOLOCK), cDeskGroupFolderAccess c WITH (NOLOCK)
			WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
			AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 9 
		) 
		GROUP BY ComplianceTypeId


		IF ( SELECT count(*) FROM sAccessComplianceFolder WITH (NOLOCK) WHERE TeamId = @TeamID ) > 0  
		BEGIN 
			SET @DeskFolderID  =  9
			IF ( SELECT Count(*) FROM cDeskUserFolderAccess WITH (NOLOCK) WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
				UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
			ELSE 
				INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
				VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

		END 

	END 
	ELSE 	IF @FolderName = 'CONTROL'  
	BEGIN

		/********************************************************************************************************************************************************************/
		-- CONTROL PANEL  FOLDER
		DELETE FROM sAccessControlPanel WHERE TeamID = @TeamID
		
		INSERT INTO sAccessControlPanel (ControlPanelId ,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
		SELECT  ControlPanelId  , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
		MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
		@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
		FROM sAccessGroupControlPanel WITH (NOLOCK)
		WHERE GroupID IN ( 
			SELECT  a.GroupID 
			FROM uUserGroup a WITH (NOLOCK), uGroup b WITH (NOLOCK), cDeskGroupFolderAccess c WITH (NOLOCK)
			WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
			AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 10 
		) 
		GROUP BY ControlPanelId

		IF ( SELECT count(*) FROM sAccessControlPanel WITH (NOLOCK) WHERE TeamId = @TeamID ) > 0  
		BEGIN 
			SET @DeskFolderID  =  10
			IF ( SELECT Count(*) FROM cDeskUserFolderAccess  WITH (NOLOCK) WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
				UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
			ELSE 
				INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
				VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

		END 


	END
	ELSE 	IF @FolderName = 'SHARE'  
	BEGIN

		/********************************************************************************************************************************************************************/
		-- SHARE FOLDER
		DELETE FROM sAccessShareFolder WHERE TeamID = @TeamID
		
		INSERT INTO sAccessShareFolder ( ShareTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
		SELECT  1 as ShareTypeId  , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
		MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
		@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
		FROM sAccessGroupShareFolder WITH (NOLOCK)
		WHERE GroupID IN ( 
			SELECT  a.GroupID 
			FROM uUserGroup a WITH (NOLOCK), uGroup b WITH (NOLOCK), cDeskGroupFolderAccess c WITH (NOLOCK)
			WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
			AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 11 
		) 
		GROUP BY ShareTypeId

		IF ( SELECT count(*) FROM sAccessShareFolder WITH (NOLOCK) WHERE TeamId = @TeamID ) > 0  
		BEGIN 
			SET @DeskFolderID  =  11
			IF ( SELECT Count(*) FROM cDeskUserFolderAccess  WITH (NOLOCK) WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
				UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
			ELSE 
				INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
				VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

		END 

	END
	ELSE 	IF @FolderName = 'COSTING'  
	BEGIN

		/********************************************************************************************************************************************************************/
		-- COSTING 
		DELETE FROM sAccessCosting where TeamID = @TeamID

		INSERT INTO sAccessCosting (StyleTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId, CUser, CDate, MUser, MDate   )
		SELECT  StyleTypeId , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
		MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId ,
		@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
		FROM sAccessGroupCosting WITH (NOLOCK)
		WHERE GroupID IN ( 
			SELECT  a.GroupID 
			FROM uUserGroup a WITH (NOLOCK), uGroup b WITH (NOLOCK), cDeskGroupFolderAccess c WITH (NOLOCK)
			WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
			AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 2 
		) 
		GROUP BY StyleTypeId  


		SET @DeskFolderID  =  12
		IF ( SELECT count(*) FROM sAccessCosting WITH (NOLOCK) WHERE TeamId = @TeamID ) > 0  
		BEGIN 

			IF ( SELECT Count(*) FROM cDeskUserFolderAccess  WITH (NOLOCK) WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
				UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
			ELSE 
				INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
				VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )
		END
		ELSE

			DELETE FROM  cDeskUserFolderAccess WHERE TeamID =@TeamID and DeskFolderId = @DeskFolderId 
	
	
	END 
    ELSE IF @FolderName = 'BODY'  
	BEGIN

		/********************************************************************************************************************************************************************/
		-- BODY FOLDER
		DELETE FROM sAccessBodyFolder where TeamID = @TeamID

		INSERT INTO sAccessBodyFolder (BodyTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessRemove, AccessDelete , AccessPrint ,TeamId, CUser, CDate, MUser, MDate   )
		SELECT  BodyTypeId , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
		MAX ( AccessModify )  AS AccessModify  , MAX ( AccessRemove ) AS AccessRemove , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId ,
		@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
		FROM sAccessGroupBodyFolder WITH (NOLOCK)
		WHERE GroupID IN ( 
			SELECT  a.GroupID 
			FROM uUserGroup a WITH (NOLOCK), uGroup b WITH (NOLOCK), cDeskGroupFolderAccess c WITH (NOLOCK)
			WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
			AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 2 
		) 
		GROUP BY BodyTypeId  


		SET @DeskFolderID  =  13
		IF ( SELECT count(*) FROM sAccessBodyFolder WITH (NOLOCK) WHERE TeamId = @TeamID ) > 0  
		BEGIN 
			IF ( SELECT Count(*) FROM cDeskUserFolderAccess WITH (NOLOCK) WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
				UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
			ELSE 
				INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
				VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )
		END
		ELSE

			DELETE FROM  cDeskUserFolderAccess WHERE TeamID =@TeamID and DeskFolderId = @DeskFolderId 
	END
	
			
	
	
	FETCH NEXT FROM cursor_users INTO @TeamID
END 


CLOSE cursor_users
DEALLOCATE cursor_users



/****************************************************************************************************************************************************************************************************************************************/
-- CHECK FOR USER WITHOUT A GROUP 
DECLARE cursor_users2 CURSOR FOR	
SELECT  TeamID from Users  WITH (NOLOCK) WHERE TeamID not in (  select  DISTINCT TeamID  from uUserGroup WITH (NOLOCK) ) 


OPEN cursor_users2
FETCH NEXT FROM cursor_users2 INTO @TeamID

WHILE @@FETCH_STATUS = 0 
BEGIN
	
	DELETE FROM sAccessStyleFolder where TeamID = @TeamID
	DELETE FROM sAccessLineFolder where TeamID = @TeamID
	DELETE FROM sAccessQuotationFolder  where TeamID = @TeamID
	DELETE FROM sAccessSampleFolder  where TeamID = @TeamID
	DELETE FROM sAccessImageFolder  where TeamID = @TeamID
	DELETE FROM sAccessColorFolder WHERE TeamID = @TeamID
	DELETE FROM sAccessMaterialFolder WHERE TeamID = @TeamID
	DELETE FROM sAccessComplianceFolder WHERE TeamID = @TeamID
	DELETE FROM sAccessControlPanel WHERE TeamID = @TeamID
	DELETE FROM sAccessShareFolder WHERE TeamID = @TeamID
	DELETE FROM sAccessCosting WHERE TeamID = @TeamID 


	FETCH NEXT FROM cursor_users2 INTO @TeamID

END 

CLOSE cursor_users2
DEALLOCATE cursor_users2


SET NOCOUNT OFF










GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_User_AccessLinePlanFolder_HierarchyPlanning_SELECT]'
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE PROCEDURE [dbo].[spx_User_AccessLinePlanFolder_HierarchyPlanning_SELECT] (
@LinePlanID UNIQUEIDENTIFIER ,
@TeamID UNIQUEIDENTIFIER ,
@LinePlanAttributeItemID UNIQUEIDENTIFIER  = NULL
)
AS 

DECLARE  @LinePlanTemplateID UNIQUEIDENTIFIER

SELECT @LinePlanTemplateID = LinePlanTemplateID  FROM pLinePlan 
WHERE LinePlanID = @LinePlanID 



SELECT ISNULL(MAX(AccessRoleID),0) AS AccessRoleID , ISNULL(MAX(AccessPlanView),0) AS AccessPlanView, 
ISNULL(MAX(AccessPlanNew),0) AS AccessPlanNew, ISNULL(MAX(AccessPlanDelete),0) AS AccessPlanDelete, 
ISNULL(MAX(AccessHierView),0) AS AccessHierView, ISNULL(MAX(AccessHierNew),0) AS AccessHierNew, 
ISNULL(MAX(AccessHierDelete),0) AS AccessHierDelete
FROM sAccessGroupLinePlanFolder
WHERE LinePlanTemplateID =  @LinePlanTemplateID  
AND GroupID  IN (
	SELECT GroupID FROM dbo.uUserGroup WHERE TeamID = @TeamID
) 


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcing_DELETE]'
GO


ALTER PROCEDURE [dbo].[spx_StyleSourcing_DELETE]  (
@StyleSourcingID uniqueidentifier 
)
AS


	DECLARE @StyleID UNIQUEIDENTIFIER 
	DECLARE @LinePlanID UNIQUEIDENTIFIER
	DECLARE @LinePlanItemID UNIQUEIDENTIFIER
	DECLARE @LinePlanRangeID UNIQUEIDENTIFIER
	DECLARE @LinePlanAttributeItemID1 UNIQUEIDENTIFIER
	DECLARE @LinePlanAttributeItemID2 UNIQUEIDENTIFIER
	DECLARE @LinePlanAttributeItemID3 UNIQUEIDENTIFIER
	DECLARE @LinePlanAttributeItemID4 UNIQUEIDENTIFIER
	DECLARE @TradePartnerVendorID UNIQUEIDENTIFIER
	DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER
	
	SELECT @StyleID = StyleID  FROM pStyleSourcing WHERE StyleSourcingID = @StyleSourcingID

	--***
	--** Update pStyleSeasonYear / MostLikelyVendor
	--***
	SELECT @TradePartnerVendorID = TradePartnerVendorID, @StyleSeasonYearID = StyleSeasonYearID
	FROM pStyleSourcing WHERE StyleSourcingID = @StyleSourcingID 
	
	DECLARE @MostLikelyVendor UNIQUEIDENTIFIER 
	
	SELECT  @MostLikelyVendor = TradePartnerVendorID  FROM pStyleSeasonYear WHERE StyleSeasonYearID = @StyleSeasonYearID 
	
	IF @MostLikelyVendor = @TradePartnerVendorID
	BEGIN
		UPDATE pStyleSeasonYear SET TradePartnerVendorID = NULL,  MostLikelyVendor = 0 
		WHERE StyleSeasonYearID = @StyleSeasonYearID 
	END 
	
	
	--***
	--** Delete records
	--***
	DELETE FROM pStyleSourcing WHERE  StyleSourcingId = @StyleSourcingID
	DELETE FROM pStyleSourcingItem  WHERE  StyleSourcingId = @StyleSourcingID
	DELETE FROM pStyleQuoteItem WHERE  StyleSourcingId = @StyleSourcingID
	
	--***
	--** Burburry logic
	--** if only 1 sourcing left, make it MostlikelyVendor
	--***
	IF ( SELECT COUNT(*) FROM pStyleSourcing WHERE StyleSeasonYearID = @StyleSeasonYearID ) = 1
	BEGIN
	
		SELECT TOP 1 @MostLikelyVendor = TradePartnerVendorID 
		FROM pStyleSourcing WHERE StyleSeasonYearID = @StyleSeasonYearID
		
		UPDATE pStyleSeasonyear 
		SET TradePartnerVendorID = @MostLikelyVendor, MostLikelyVendor = 1
		WHERE StyleSeasonYearID = @StyleSeasonYearID 
	
	END 


	-- ROLL-UP  LINEPLAN 
	SELECT 
		@LinePlanID = pLinePlanItem.LinePlanID,
		@LinePlanItemID = pLinePlanItem.LinePlanItemID,
		@LinePlanRangeID = pLinePlanItem.LinePlanRangeID,
		@LinePlanAttributeItemID1 = pLinePlanRange.LinePlanAttributeItemID1, 
		@LinePlanAttributeItemID2 = pLinePlanRange.LinePlanAttributeItemID2, 
		@LinePlanAttributeItemID3 = pLinePlanRange.LinePlanAttributeItemID3, 
		@LinePlanAttributeItemID4 = pLinePlanRange.LinePlanAttributeItemID4
	FROM pLinePlanItem INNER JOIN
	  pLinePlanRange ON pLinePlanItem.LinePlanRangeID = pLinePlanRange.LinePlanRangeID
	WHERE pLinePlanItem.StyleID = @StyleID

	IF  @LinePlanID IS NOT NULL AND @LinePlanRangeID IS NOT NULL
	BEGIN

		SET @StyleSeasonYearID  = NULL 
		
		SELECT @StyleSeasonYearID = StyleSeasonYearID 
		FROM pStyleSeasonYear 
		WHERE LinePlanID = @LinePlanID 
		AND LinePlanItemID =  @LinePlanItemID
		AND StyleID = @StyleID 

/*

		exec spx_LinePlanBusinessItemLogic_UPDATE NULL, @StyleID, @LinePlanID, @LinePlanRangeID, 
		@LinePlanAttributeItemID1, @LinePlanAttributeItemID2, @LinePlanAttributeItemID3, @LinePlanAttributeItemID4, @StyleSeasonYearID

		exec spx_LinePlanBusinessItemRollup_INSERT 
		@LinePlanID = @LinePlanID, 
		@LinePlanAttributeItemID1 = @LinePlanAttributeItemID1, 
		@LinePlanAttributeItemID2 = @LinePlanAttributeItemID2, 
		@LinePlanAttributeItemID3 = @LinePlanAttributeItemID3, 
		@LinePlanAttributeItemID4 = @LinePlanAttributeItemID4, 
		@Cmd = 'DELETE', 
		@StyleSeasonYearID = @StyleSeasonYearID
*/

		EXEC spx_LinePlanBusinessItem_QUEUE 
		@StyleQuoteItemID = NULL,
		@StyleID = @StyleID,
		@LinePlanID = @LinePlanID, 
		@LinePlanRangeID = @LinePlanRangeID,
		@LinePlanAttributeItemID1 = @LinePlanAttributeItemID1, 
		@LinePlanAttributeItemID2 = @LinePlanAttributeItemID2,
		@LinePlanAttributeItemID3 = @LinePlanAttributeItemID3,
		@LinePlanAttributeItemID4 = @LinePlanAttributeItemID4,
		@StyleSeasonYearID = @StyleSeasonYearID,
		@Cmd  = 'DELETE'


	END 

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcingQuoteItemCopyColors_UPDATE]'
GO
SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [dbo].[spx_StyleSourcingQuoteItemCopyColors_UPDATE] (
@StyleSourcingID UNIQUEIDENTIFIER ,
@StyleQuoteItemID UNIQUEIDENTIFIER
)
AS 


DECLARE @pStyleSourcingID NVARCHAR(70)
DECLARE @pStyleQuoteItemID NVARCHAR(70)

IF @StyleSourcingID IS NULL
	SET @pStyleSourcingID = ' @StyleSourcingID = NULL '
ELSE
	SET @pStyleSourcingID = ' @StyleSourcingID = ''' +  CAST (@StyleSourcingID AS NVARCHAR(50)) + ''' '

IF @StyleQuoteItemID IS NULL
	SET @pStyleQuoteItemID = ' @StyleQuoteItemID = NULL '
ELSE
	SET @pStyleQuoteItemID = ' @StyleQuoteItemID = ''' +  CAST (@StyleQuoteItemID AS NVARCHAR(50)) + ''' '



DECLARE @ServiceDate DATETIME
SET @ServiceDate = getdate()

DECLARE @ServiceQueueSql1 nvarchar(4000)
SET @ServiceQueueSql1 = 'dbo.spx_StyleSourcingQuoteItemCopyColors_UPDATE_QUEUE ' + 
@pStyleSourcingID + ',' + 
@pStyleQuoteItemID

exec spx_ServiceQueue_INSERT @ServiceQueueSql = @ServiceQueueSql1, @ServiceQueuePriority = 1, @ServiceQueueDate = @ServiceDate


/*

	BEGIN 

	DECLARE @DUMMY INT
	

	DECLARE @StyleQuoteItemCustomField4 NVARCHAR(200)
	DECLARE @StyleQuoteItemCustomField5 NVARCHAR(200)
	DECLARE @StyleQuoteItemCustomField6 NVARCHAR(200)
	DECLARE @StyleQuoteItemCustomField7 UNIQUEIDENTIFIER
	DECLARE @StyleQuoteItemCustomField8 MONEY 
	DECLARE @StyleQuoteItemCustomField24 NVARCHAR(200)

	SELECT  @StyleQuoteItemCustomField4 = StyleQuoteItemCustomField4, @StyleQuoteItemCustomField5 = StyleQuoteItemCustomField5, 
	@StyleQuoteItemCustomField6 = StyleQuoteItemCustomField6, @StyleQuoteItemCustomField7 = StyleQuoteItemCustomField7 , 
	@StyleQuoteItemCustomField8 = StyleQuoteItemCustomField8,
	@StyleQuoteItemCustomField24 = StyleQuoteItemCustomField24
	FROM pStyleQuoteItem 
	WHERE StyleQuoteItemID = @StyleQuoteItemID


	CREATE TABLE #StyleQuoteItem (
		ROW_ID INT IDENTITY (1,1),
		StyleQuoteItemID UNIQUEIDENTIFIER 
	)	


	INSERT INTO  #StyleQuoteItem  (StyleQuoteItemID)
	SELECT StyleQuoteItemID FROM pStyleQuoteItem WHERE StyleSourcingID = @StyleSourcingID 

	DECLARE @ROW INT
	DECLARE @TOTAL INT 
	DECLARE @StyleQuoteItemID2 UNIQUEIDENTIFIER 

	SET @ROW = 1 
	SELECT @TOTAL  = COUNT (*) FROM #StyleQuoteItem 
	

	WHILE @ROW <= @TOTAL 
	BEGIN 
		SELECT @StyleQuoteItemID2 = StyleQuoteItemID
		FROM  #StyleQuoteItem
		WHERE ROW_ID  = @ROW

		UPDATE pStyleQuoteItem SET 
		StyleQuoteItemCustomField4 = @StyleQuoteItemCustomField4, 
		StyleQuoteItemCustomField5 = @StyleQuoteItemCustomField5, 
		StyleQuoteItemCustomField6 = @StyleQuoteItemCustomField6, 
		StyleQuoteItemCustomField7 = @StyleQuoteItemCustomField7 , 
		StyleQuoteItemCustomField8 = @StyleQuoteItemCustomField8 ,
		StyleQuoteItemCustomField24 = @StyleQuoteItemCustomField24
		WHERE StyleQuoteItemID = @StyleQuoteItemID2

		
		EXEC dbo.spx_StyleSourcingQuoteItemLogic_UPDATE @StyleQuoteItemID2
		PRINT 'AA = '  + cast (@StyleQuoteItemID2 AS NVARCHAR(50))
	
		EXEC dbo.spx_StyleSourcingQuoteItemVersion_UPDATE  @StyleQuoteItemID2			
		SET @ROW = @ROW + 1

	END 



	Select 1 as dummy

END 

*/








GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcingQuoteItemVersion_UPDATE]'
GO
ALTER PROCEDURE [dbo].[spx_StyleSourcingQuoteItemVersion_UPDATE](
@StyleQuoteItemID UNIQUEIDENTIFIER 
)
AS

	DECLARE @Version INT 
	
	SELECT @Version = MAX(Version) FROM pStyleQuoteItemVersion 
	WHERE StyleQuoteItemID = @StyleQuoteItemID

	IF @Version IS NULL 
	BEGIN 
		SET @Version = 1	
		
		INSERT INTO pStyleQuoteItemVersion (Version , StyleQuoteItemID ,  StyleQuoteItemNo, StyleQuoteItemShare , 
		StyleQuoteItemStatusId,  StyleQuoteVariationId, StyleQuoteID , StyleQuotaDutyID ,  StyleDevelopmentID ,  StyleID ,  StyleQuoteTradePartnerID , 
		StyleCostingID, StyleCostingType, StyleCostingFreightTypeID , TradePartnerID ,   TradePartnerVendorID,  
		StyleQuoteItemDueDate,  StyleQuoteItemApprovedBy , StyleQuoteItemApprovedDate, 
		StyleQuoteItemCustomField1, StyleQuoteItemCustomField2, StyleQuoteItemCustomField3, StyleQuoteItemCustomField4, StyleQuoteItemCustomField5,
		StyleQuoteItemCustomField6, StyleQuoteItemCustomField7, StyleQuoteItemCustomField8, StyleQuoteItemCustomField9, StyleQuoteItemCustomField10,
		StyleQuoteItemCustomField11, StyleQuoteItemCustomField12, StyleQuoteItemCustomField13, StyleQuoteItemCustomField14, StyleQuoteItemCustomField15,
		StyleQuoteItemCustomField16, StyleQuoteItemCustomField17, StyleQuoteItemCustomField18, StyleQuoteItemCustomField19, StyleQuoteItemCustomField20,
		StyleQuoteItemCustomField21, StyleQuoteItemCustomField22, StyleQuoteItemCustomField23, StyleQuoteItemCustomField24, StyleQuoteItemCustomField25,
		StyleQuoteItemCustomField26, StyleQuoteItemCustomField27, StyleQuoteItemCustomField28, StyleQuoteItemCustomField29, StyleQuoteItemCustomField30,
		StyleQuoteItemNotes, 
		StyleCostingCustomField1, StyleCostingCustomField2, StyleCostingCustomField3, StyleCostingCustomField4, StyleCostingCustomField5, 
		StyleCostingCustomField6, StyleCostingCustomField7, StyleCostingCustomField8, StyleCostingCustomField9, StyleCostingCustomField10, 
		StyleCostingCustomField11, StyleCostingCustomField12, StyleCostingCustomField13, StyleCostingCustomField14, StyleCostingCustomField15, 
		StyleCostingCustomField16, StyleCostingCustomField17, StyleCostingCustomField18, StyleCostingCustomField19, StyleCostingCustomField20, 
		StyleCostingCustomField21, StyleCostingCustomField22, StyleCostingCustomField23, StyleCostingCustomField24, StyleCostingCustomField25, 
		StyleCostingCustomField26, StyleCostingCustomField27, StyleCostingCustomField28, StyleCostingCustomField29, StyleCostingCustomField30, 
		StyleCostingCustomField31, StyleCostingCustomField32, StyleCostingCustomField33, StyleCostingCustomField34, StyleCostingCustomField35, 
		CUser, CDate, MUser, MDate,  QuoteFolderSort, AgentView, StyleColorID, StyleSourcingID ) 
		SELECT 1, StyleQuoteItemID ,  StyleQuoteItemNo, StyleQuoteItemShare , 
		StyleQuoteItemStatusId,  StyleQuoteVariationId, StyleQuoteID , StyleQuotaDutyID ,  StyleDevelopmentID ,  StyleID ,  StyleQuoteTradePartnerID , 
		StyleCostingID, StyleCostingType, StyleCostingFreightTypeID , TradePartnerID ,   TradePartnerVendorID,  
		StyleQuoteItemDueDate,  StyleQuoteItemApprovedBy , StyleQuoteItemApprovedDate, 
		StyleQuoteItemCustomField1, StyleQuoteItemCustomField2, StyleQuoteItemCustomField3, StyleQuoteItemCustomField4, StyleQuoteItemCustomField5,
		StyleQuoteItemCustomField6, StyleQuoteItemCustomField7, StyleQuoteItemCustomField8, StyleQuoteItemCustomField9, StyleQuoteItemCustomField10,
		StyleQuoteItemCustomField11, StyleQuoteItemCustomField12, StyleQuoteItemCustomField13, StyleQuoteItemCustomField14, StyleQuoteItemCustomField15,
		StyleQuoteItemCustomField16, StyleQuoteItemCustomField17, StyleQuoteItemCustomField18, StyleQuoteItemCustomField19, StyleQuoteItemCustomField20,
		StyleQuoteItemCustomField21, StyleQuoteItemCustomField22, StyleQuoteItemCustomField23, StyleQuoteItemCustomField24, StyleQuoteItemCustomField25,
		StyleQuoteItemCustomField26, StyleQuoteItemCustomField27, StyleQuoteItemCustomField28, StyleQuoteItemCustomField29, StyleQuoteItemCustomField30,
		StyleQuoteItemNotes, 
		StyleCostingCustomField1, StyleCostingCustomField2, StyleCostingCustomField3, StyleCostingCustomField4, StyleCostingCustomField5, 
		StyleCostingCustomField6, StyleCostingCustomField7, StyleCostingCustomField8, StyleCostingCustomField9, StyleCostingCustomField10, 
		StyleCostingCustomField11, StyleCostingCustomField12, StyleCostingCustomField13, StyleCostingCustomField14, StyleCostingCustomField15, 
		StyleCostingCustomField16, StyleCostingCustomField17, StyleCostingCustomField18, StyleCostingCustomField19, StyleCostingCustomField20, 
		StyleCostingCustomField21, StyleCostingCustomField22, StyleCostingCustomField23, StyleCostingCustomField24, StyleCostingCustomField25, 
		StyleCostingCustomField26, StyleCostingCustomField27, StyleCostingCustomField28, StyleCostingCustomField29, StyleCostingCustomField30, 
		StyleCostingCustomField31, StyleCostingCustomField32, StyleCostingCustomField33, StyleCostingCustomField34, StyleCostingCustomField35, 
		CUser, CDate, MUser, MDate,  QuoteFolderSort, AgentView, StyleColorID, StyleSourcingID
		FROM pStyleQuoteItem WHERE  StyleQuoteItemID = @StyleQuoteItemID
	END 
	ELSE
	BEGIN 


		DECLARE @StyleQuoteItemNo int
		DECLARE @StyleQuoteItemShare int
		DECLARE @StyleQuoteItemStatusId int
		DECLARE @StyleQuoteVariationId uniqueidentifier
		DECLARE @StyleQuoteID uniqueidentifier
		DECLARE @StyleQuotaDutyID uniqueidentifier
		DECLARE @StyleDevelopmentID uniqueidentifier
		DECLARE @StyleID uniqueidentifier
		DECLARE @StyleQuoteTradePartnerID uniqueidentifier
		DECLARE @StyleCostingID uniqueidentifier
		DECLARE @StyleCostingType int
		DECLARE @StyleCostingFreightTypeID int
		DECLARE @TradePartnerID uniqueidentifier
		DECLARE @TradePartnerVendorID uniqueidentifier
		DECLARE @StyleQuoteItemDueDate datetime
		DECLARE @StyleQuoteItemApprovedBy nvarchar(200)
		DECLARE @StyleQuoteItemApprovedDate datetime
		DECLARE @StyleQuoteItemCustomField1 nvarchar(200)
		DECLARE @StyleQuoteItemCustomField2 nvarchar(200)
		DECLARE @StyleQuoteItemCustomField3 nvarchar(200)
		DECLARE @StyleQuoteItemCustomField4 nvarchar(200)
		DECLARE @StyleQuoteItemCustomField5 nvarchar(200)
		DECLARE @StyleQuoteItemCustomField6 nvarchar(200)
		DECLARE @StyleQuoteItemCustomField7 UNIQUEIDENTIFIER
		DECLARE @StyleQuoteItemCustomField8 MONEY
		DECLARE @StyleQuoteItemCustomField9 MONEY
		DECLARE @StyleQuoteItemCustomField10 MONEY
		DECLARE @StyleQuoteItemCustomField11 DECIMAL(18,4) 
		DECLARE @StyleQuoteItemCustomField12 DECIMAL(18,4) 
		DECLARE @StyleQuoteItemCustomField13 DECIMAL(18,4) 
		DECLARE @StyleQuoteItemCustomField14 MONEY
		DECLARE @StyleQuoteItemCustomField15 MONEY
		DECLARE @StyleQuoteItemCustomField16 DECIMAL(18,4) 
		DECLARE @StyleQuoteItemCustomField17 MONEY
		DECLARE @StyleQuoteItemCustomField18 MONEY
		DECLARE @StyleQuoteItemCustomField19 MONEY
		DECLARE @StyleQuoteItemCustomField20 MONEY
		DECLARE @StyleQuoteItemCustomField21 DECIMAL(18,3) 
		DECLARE @StyleQuoteItemCustomField22 DECIMAL(18,3)
		DECLARE @StyleQuoteItemCustomField23 DECIMAL(18,3)
		DECLARE @StyleQuoteItemCustomField24 nvarchar(200)
		DECLARE @StyleQuoteItemCustomField25 nvarchar(200)
		DECLARE @StyleQuoteItemCustomField26 nvarchar(200)
		DECLARE @StyleQuoteItemCustomField27 nvarchar(200)
		DECLARE @StyleQuoteItemCustomField28 nvarchar(200)
		DECLARE @StyleQuoteItemCustomField29 nvarchar(200)
		DECLARE @StyleQuoteItemCustomField30 nvarchar(200)
		DECLARE @StyleQuoteItemNotes nvarchar(4000)
		DECLARE @StyleCostingCustomField1 MONEY
		DECLARE @StyleCostingCustomField2 MONEY
		DECLARE @StyleCostingCustomField3 DECIMAL(18,4)
		DECLARE @StyleCostingCustomField4 INT
		DECLARE @StyleCostingCustomField5 int
		DECLARE @StyleCostingCustomField6 decimal(18, 3) 
		DECLARE @StyleCostingCustomField7 decimal(18, 3) 
		DECLARE @StyleCostingCustomField8 decimal(18, 3) 
		DECLARE @StyleCostingCustomField9 decimal(18, 3) 
		DECLARE @StyleCostingCustomField10 decimal(18, 3)
		DECLARE @StyleCostingCustomField11 decimal(18, 3)
		DECLARE @StyleCostingCustomField12 decimal(18, 3) 
		DECLARE @StyleCostingCustomField13 decimal(18, 3) 
		DECLARE @StyleCostingCustomField14 decimal(18, 3) 
		DECLARE @StyleCostingCustomField15 decimal(18, 3) 
		DECLARE @StyleCostingCustomField16 VARCHAR(50)
		DECLARE @StyleCostingCustomField17 DATETIME
		DECLARE @StyleCostingCustomField18 decimal(18, 3) 
		DECLARE @StyleCostingCustomField19 decimal(18, 3) 
		DECLARE @StyleCostingCustomField20 DECIMAL(18, 3)
		DECLARE @StyleCostingCustomField21 decimal(18, 3) 
		DECLARE @StyleCostingCustomField22 decimal(18, 3) 
		DECLARE @StyleCostingCustomField23 decimal(18, 3) 
		DECLARE @StyleCostingCustomField24 decimal(18, 3) 
		DECLARE @StyleCostingCustomField25 varchar(50) 
		DECLARE @StyleCostingCustomField26 varchar(50)
		DECLARE @StyleCostingCustomField27 varchar(50)
		DECLARE @StyleCostingCustomField28 varchar(50)
		DECLARE @StyleCostingCustomField29 varchar(50)
		DECLARE @StyleCostingCustomField30 varchar(50)
		DECLARE @StyleCostingCustomField31 varchar(50)
		DECLARE @StyleCostingCustomField32 varchar(50)
		DECLARE @StyleCostingCustomField33 varchar(50)
		DECLARE @StyleCostingCustomField34 varchar(50)
		DECLARE @StyleCostingCustomField35 varchar(50)
		DECLARE @CUser nvarchar(100) 
		DECLARE @CDate datetime
		DECLARE @MUser nvarchar(100) 
		DECLARE @MDate datetime 
		DECLARE @QuoteFolderSort nvarchar(5)
		DECLARE @AgentView int
		DECLARE @StyleColorID uniqueidentifier
		DECLARE @StyleSourcingID uniqueidentifier 



		SELECT @StyleQuoteItemNo = StyleQuoteItemNo, 
		@StyleQuoteItemShare  = StyleQuoteItemShare,
		@StyleQuoteItemStatusId = StyleQuoteItemStatusId ,
		@StyleQuoteVariationId  = StyleQuoteVariationId  ,
		@StyleQuoteID = StyleQuoteID ,
		@StyleQuotaDutyID = StyleQuotaDutyID ,
		@StyleDevelopmentID  = StyleDevelopmentID ,
		@StyleID = StyleID,
		@StyleQuoteTradePartnerID = StyleQuoteTradePartnerID ,
		@StyleCostingID = StyleCostingID ,
		@StyleCostingType = StyleCostingType,
		@StyleCostingFreightTypeID = StyleCostingFreightTypeID ,
		@TradePartnerID = TradePartnerID,
		@TradePartnerVendorID = TradePartnerVendorID,
		@StyleQuoteItemDueDate = StyleQuoteItemDueDate ,
		@StyleQuoteItemApprovedBy = StyleQuoteItemApprovedBy,
		@StyleQuoteItemApprovedDate = StyleQuoteItemApprovedDate ,
		@StyleQuoteItemCustomField1 = StyleQuoteItemCustomField1,
		@StyleQuoteItemCustomField2 = StyleQuoteItemCustomField2,
		@StyleQuoteItemCustomField3 = StyleQuoteItemCustomField3 ,
		@StyleQuoteItemCustomField4 = StyleQuoteItemCustomField4,
		@StyleQuoteItemCustomField5 = StyleQuoteItemCustomField5,
		@StyleQuoteItemCustomField6 = StyleQuoteItemCustomField6,
		@StyleQuoteItemCustomField7 = StyleQuoteItemCustomField7,
		@StyleQuoteItemCustomField8 = StyleQuoteItemCustomField8,
		@StyleQuoteItemCustomField9 = StyleQuoteItemCustomField9,
		@StyleQuoteItemCustomField10 = StyleQuoteItemCustomField10,
		@StyleQuoteItemCustomField11 = StyleQuoteItemCustomField11,
		@StyleQuoteItemCustomField12 = StyleQuoteItemCustomField12,
		@StyleQuoteItemCustomField13 = StyleQuoteItemCustomField13,
		@StyleQuoteItemCustomField14 = StyleQuoteItemCustomField14,
		@StyleQuoteItemCustomField15 = StyleQuoteItemCustomField15,
		@StyleQuoteItemCustomField16 = StyleQuoteItemCustomField16,
		@StyleQuoteItemCustomField17 = StyleQuoteItemCustomField17,
		@StyleQuoteItemCustomField18 = StyleQuoteItemCustomField18,
		@StyleQuoteItemCustomField19 = StyleQuoteItemCustomField19,
		@StyleQuoteItemCustomField20 = StyleQuoteItemCustomField20,
		@StyleQuoteItemCustomField21 = StyleQuoteItemCustomField21,
		@StyleQuoteItemCustomField22 = StyleQuoteItemCustomField22,
		@StyleQuoteItemCustomField23 = StyleQuoteItemCustomField23,
		@StyleQuoteItemCustomField24 = StyleQuoteItemCustomField24,
		@StyleQuoteItemCustomField25 = StyleQuoteItemCustomField25,
		@StyleQuoteItemCustomField26 = StyleQuoteItemCustomField26,
		@StyleQuoteItemCustomField27 = StyleQuoteItemCustomField27,
		@StyleQuoteItemCustomField28 = StyleQuoteItemCustomField28,
		@StyleQuoteItemCustomField29 = StyleQuoteItemCustomField29,
		@StyleQuoteItemCustomField30 = StyleQuoteItemCustomField30,
		@StyleQuoteItemNotes = StyleQuoteItemNotes,
		@StyleCostingCustomField1 = StyleCostingCustomField1,
		@StyleCostingCustomField2 = StyleCostingCustomField2,
		@StyleCostingCustomField3 = StyleCostingCustomField3,
		@StyleCostingCustomField4 = StyleCostingCustomField4,
		@StyleCostingCustomField5 = StyleCostingCustomField5,
		@StyleCostingCustomField6 = StyleCostingCustomField6,
		@StyleCostingCustomField7 = StyleCostingCustomField7,
		@StyleCostingCustomField8 = StyleCostingCustomField8,
		@StyleCostingCustomField9 = StyleCostingCustomField9,
		@StyleCostingCustomField10 = StyleCostingCustomField10,
		@StyleCostingCustomField11 = StyleCostingCustomField11,
		@StyleCostingCustomField12 = StyleCostingCustomField12,
		@StyleCostingCustomField13 = StyleCostingCustomField13,
		@StyleCostingCustomField14 = StyleCostingCustomField14,
		@StyleCostingCustomField15 = StyleCostingCustomField15,
		@StyleCostingCustomField16 = StyleCostingCustomField16,
		@StyleCostingCustomField17 = StyleCostingCustomField17,
		@StyleCostingCustomField18 = StyleCostingCustomField18,
		@StyleCostingCustomField19 = StyleCostingCustomField19,
		@StyleCostingCustomField20 = StyleCostingCustomField20,
		@StyleCostingCustomField21 = StyleCostingCustomField21,
		@StyleCostingCustomField22 = StyleCostingCustomField22,
		@StyleCostingCustomField23 = StyleCostingCustomField23,
		@StyleCostingCustomField24 = StyleCostingCustomField24,
		@StyleCostingCustomField25 = StyleCostingCustomField25,
		@StyleCostingCustomField26 = StyleCostingCustomField26,
		@StyleCostingCustomField27 = StyleCostingCustomField27,
		@StyleCostingCustomField28 = StyleCostingCustomField28,
		@StyleCostingCustomField29 = StyleCostingCustomField29,
		@StyleCostingCustomField30 = StyleCostingCustomField30,
		@StyleCostingCustomField31 = StyleCostingCustomField31,
		@StyleCostingCustomField32 = StyleCostingCustomField32,
		@StyleCostingCustomField33 = StyleCostingCustomField33,
		@StyleCostingCustomField34 = StyleCostingCustomField34,
		@StyleCostingCustomField35 = StyleCostingCustomField35,
		@CUser = CUser,
		@CDate = CDate ,
		@MUser = MUser,
		@MDate = MDate,
		@QuoteFolderSort = QuoteFolderSort ,
		@AgentView = AgentView ,
		@StyleColorID = StyleColorID ,
		@StyleSourcingID = StyleSourcingID
		FROM pStyleQuoteItem WHERE StyleQuoteItemID = @StyleQuoteItemID


		UPDATE pStyleQuoteItemVersion SET 
		StyleQuoteItemNo = @StyleQuoteItemNo , 
		StyleQuoteItemShare = @StyleQuoteItemShare,
		StyleQuoteItemStatusId = @StyleQuoteItemStatusId ,
		StyleQuoteVariationId  = @StyleQuoteVariationId  ,
		StyleQuoteID = @StyleQuoteID ,
		StyleQuotaDutyID = @StyleQuotaDutyID ,
		StyleDevelopmentID  = @StyleDevelopmentID ,
		StyleID = @StyleID,
		StyleQuoteTradePartnerID = @StyleQuoteTradePartnerID ,
		StyleCostingID = @StyleCostingID ,
		StyleCostingType = @StyleCostingType,
		StyleCostingFreightTypeID = @StyleCostingFreightTypeID ,
		TradePartnerID = @TradePartnerID,
		TradePartnerVendorID = @TradePartnerVendorID,
		StyleQuoteItemDueDate = @StyleQuoteItemDueDate ,
		StyleQuoteItemApprovedBy = @StyleQuoteItemApprovedBy,
		StyleQuoteItemApprovedDate = @StyleQuoteItemApprovedDate ,
		StyleQuoteItemCustomField1 = @StyleQuoteItemCustomField1,
		StyleQuoteItemCustomField2 = @StyleQuoteItemCustomField2,
		StyleQuoteItemCustomField3 = @StyleQuoteItemCustomField3 ,
		StyleQuoteItemCustomField4 = @StyleQuoteItemCustomField4,
		StyleQuoteItemCustomField5 = @StyleQuoteItemCustomField5,
		StyleQuoteItemCustomField6 = @StyleQuoteItemCustomField6,
		StyleQuoteItemCustomField7 = @StyleQuoteItemCustomField7,
		StyleQuoteItemCustomField8 = @StyleQuoteItemCustomField8,
		StyleQuoteItemCustomField9 = @StyleQuoteItemCustomField9,
		StyleQuoteItemCustomField10 = @StyleQuoteItemCustomField10,
		StyleQuoteItemCustomField11 = @StyleQuoteItemCustomField11,
		StyleQuoteItemCustomField12 = @StyleQuoteItemCustomField12,
		StyleQuoteItemCustomField13 = @StyleQuoteItemCustomField13,
		StyleQuoteItemCustomField14 = @StyleQuoteItemCustomField14,
		StyleQuoteItemCustomField15 = @StyleQuoteItemCustomField15,
		StyleQuoteItemCustomField16 = @StyleQuoteItemCustomField16,
		StyleQuoteItemCustomField17 = @StyleQuoteItemCustomField17,
		StyleQuoteItemCustomField18 = @StyleQuoteItemCustomField18,
		StyleQuoteItemCustomField19 = @StyleQuoteItemCustomField19,
		StyleQuoteItemCustomField20 = @StyleQuoteItemCustomField20,
		StyleQuoteItemCustomField21 = @StyleQuoteItemCustomField21,
		StyleQuoteItemCustomField22 = @StyleQuoteItemCustomField22,
		StyleQuoteItemCustomField23 = @StyleQuoteItemCustomField23,
		StyleQuoteItemCustomField24 = @StyleQuoteItemCustomField24,
		StyleQuoteItemCustomField25 = @StyleQuoteItemCustomField25,
		StyleQuoteItemCustomField26 = @StyleQuoteItemCustomField26,
		StyleQuoteItemCustomField27 = @StyleQuoteItemCustomField27,
		StyleQuoteItemCustomField28 = @StyleQuoteItemCustomField28,
		StyleQuoteItemCustomField29 = @StyleQuoteItemCustomField29,
		StyleQuoteItemCustomField30 = @StyleQuoteItemCustomField30,
		StyleQuoteItemNotes = @StyleQuoteItemNotes,
		StyleCostingCustomField1 = @StyleCostingCustomField1,
		StyleCostingCustomField2 = @StyleCostingCustomField2,
		StyleCostingCustomField3 = @StyleCostingCustomField3,
		StyleCostingCustomField4 = @StyleCostingCustomField4,
		StyleCostingCustomField5 = @StyleCostingCustomField5,
		StyleCostingCustomField6 = @StyleCostingCustomField6,
		StyleCostingCustomField7 = @StyleCostingCustomField7,
		StyleCostingCustomField8 = @StyleCostingCustomField8,
		StyleCostingCustomField9 = @StyleCostingCustomField9,
		StyleCostingCustomField10 = @StyleCostingCustomField10,
		StyleCostingCustomField11 = @StyleCostingCustomField11,
		StyleCostingCustomField12 = @StyleCostingCustomField12,
		StyleCostingCustomField13 = @StyleCostingCustomField13,
		StyleCostingCustomField14 = @StyleCostingCustomField14,
		StyleCostingCustomField15 = @StyleCostingCustomField15,
		StyleCostingCustomField16 = @StyleCostingCustomField16,
		StyleCostingCustomField17 = @StyleCostingCustomField17,
		StyleCostingCustomField18 = @StyleCostingCustomField18,
		StyleCostingCustomField19 = @StyleCostingCustomField19,
		StyleCostingCustomField20 = @StyleCostingCustomField20,
		StyleCostingCustomField21 = @StyleCostingCustomField21,
		StyleCostingCustomField22 = @StyleCostingCustomField22,
		StyleCostingCustomField23 = @StyleCostingCustomField23,
		StyleCostingCustomField24 = @StyleCostingCustomField24,
		StyleCostingCustomField25 = @StyleCostingCustomField25,
		StyleCostingCustomField26 = @StyleCostingCustomField26,
		StyleCostingCustomField27 = @StyleCostingCustomField27,
		StyleCostingCustomField28 = @StyleCostingCustomField28,
		StyleCostingCustomField29 = @StyleCostingCustomField29,
		StyleCostingCustomField30 = @StyleCostingCustomField30,
		StyleCostingCustomField31 = @StyleCostingCustomField31,
		StyleCostingCustomField32 = @StyleCostingCustomField32,
		StyleCostingCustomField33 = @StyleCostingCustomField33,
		StyleCostingCustomField34 = @StyleCostingCustomField34,
		StyleCostingCustomField35 = @StyleCostingCustomField35,
		CUser = @CUser,
		CDate = @CDate ,
		MUser = @MUser,
		MDate = @MDate,
		QuoteFolderSort = @QuoteFolderSort ,
		AgentView = @AgentView ,
		StyleColorID = @StyleColorID ,
		StyleSourcingID = @StyleSourcingID
		WHERE StyleQuoteItemID = @StyleQuoteItemID AND Version = @Version 

	END


	




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleSpecTemplateTemp_Linked_INSERT]'
GO
CREATE PROCEDURE [dbo].[spx_StyleSpecTemplateTemp_Linked_INSERT]
(
	@POMTempID nvarchar(50),
	@StyleID nvarchar(50),
	@StyleSet nvarchar(50),
	@ModifiedDate nvarchar(50),
	@ModifiedBy nvarchar(50)
)
AS 


/************************/
/*Declare variables.	*/
/************************/
DECLARE @POMTempID_Param UNIQUEIDENTIFIER		--Keep a copy of the original parameter value.
DECLARE @StyleID_Param UNIQUEIDENTIFIER			--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT						--Keep a copy of the original parameter value.


DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet
SET @POMTempID_Param = @POMTempID


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE dbo.#temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	,POMTempID UNIQUEIDENTIFIER
	)  ON [PRIMARY]


ALTER TABLE dbo.#temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]


/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleSpecTemplateTemp_INSERT
			@POMTempID_Param
			,@StyleID_Param
			,@StyleSet_Param
			,@ModifiedDate
			,@ModifiedBy
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet
			,POMTempID)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet_Param AS StyleSet
			,@POMTempID_Param AS POMTempID
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID
	END

/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @POMTempID = NULL
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Get the 'StyleID' for the insert.*/
		SELECT @POMTempID = POMTempID
			,@StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleSpecTemplateTemp_INSERT
			@POMTempID
			,@StyleID
			,@StyleSet
			,@ModifiedDate
			,@ModifiedBy


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_GetAllColorGroups_Remove_SELECT]'
GO
SET QUOTED_IDENTIFIER OFF
GO
/****** Object:  StoredProcedure [dbo].[spx_GetAllColorGroups_Remove_SELECT]    Script Date: 03/09/2010 10:12:58 ******/


CREATE PROCEDURE [dbo].[spx_GetAllColorGroups_Remove_SELECT] ( @StyleID UNIQUEIDENTIFIER, @StyleSet int, @SeasonYearID NVARCHAR(50)= NULL  ) AS  IF @SeasonYearID IS NOT NULL AND LEN(@SeasonYearID) > 0 Select * from pColorGroup AS CG where CG.ColorGroupID 
  
IN (Select ColorGroupID FROM pStyleColorGroup Where StyleID= @StyleID and StyleSet=@StyleSet and SeasonYearID=@SeasonYearID) order by Sort, ColorGroupName    
ELSE    
Select * from pColorGroup AS CG where CG.ColorGroupID IN (Select ColorGroupID FROM pStyleColorGroup Where StyleID= @StyleID and StyleSet=@StyleSet) order by Sort, ColorGroupName    
  
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleHeader_DELETE]'
GO
SET QUOTED_IDENTIFIER ON
GO




ALTER PROCEDURE [dbo].[spx_StyleHeader_DELETE]
(@StyleID uniqueidentifier)
AS 

DECLARE @StyleDevelopmentId as uniqueidentifier
SELECT @StyleDevelopmentId = DevelopmentId FROM pStyleHeader WHERE StyleID = @StyleID

DELETE FROM pStyleHeader			WHERE StyleID = @StyleID
DELETE FROM pStyleImage				WHERE StyleID = @StyleID
DELETE FROM pStyleImageItem			WHERE StyleID = @StyleID
DELETE FROM pStyleDocument			WHERE StyleID = @StyleID
DELETE FROM pStyleHistory			WHERE StyleID = @StyleID
DELETE FROM pStyleComment			WHERE StyleID = @StyleID 
DELETE FROM pStyleChange			WHERE StyleID = @StyleID
DELETE FROM pStyleCare				WHERE StyleID = @StyleID
DELETE FROM pStyleLicensee			WHERE StyleID = @StyleID
DELETE FROM pStyleColorway			WHERE StyleID = @StyleID
DELETE FROM pStyleColorwayItem		WHERE StyleID = @StyleID
DELETE FROM pStyleDetail			WHERE StyleID = @StyleID
DELETE FROM pStyleWorkflow			WHERE StyleID = @StyleID
DELETE FROM pStyleTeam				WHERE StyleID = @StyleID
DELETE FROM pStyleMaterials			WHERE StyleID = @StyleID
DELETE FROM pStyleMaterialTemp		WHERE StyleID = @StyleID
DELETE FROM pStyleSpec				WHERE StyleID = @StyleID
DELETE FROM pStyleSpecSize			WHERE StyleID = @StyleID
DELETE FROM pStyleDevelopmentItem	WHERE StyleID = @StyleID

DELETE FROM pStyleCostingHeader		WHERE StyleID = @StyleID
DELETE FROM pStyleCosting			WHERE StyleID = @StyleID

DELETE FROM pStyleQuoteItem			WHERE StyleID = @StyleID
DELETE FROM pStyleQuoteLog			WHERE StyleID = @StyleID
DELETE FROM pStyleQuoteVariation	WHERE StyleID = @StyleID

IF (SELECT COUNT(*) FROM pStyleDevelopmentItem WHERE StyleDevelopmentID = @StyleDevelopmentID) = 0 
BEGIN
	DELETE FROM pStyleDevelopment		WHERE StyleDevelopmentID = @StyleDevelopmentID
	DELETE FROM pStyleQuote				WHERE StyleDevelopmentID = @StyleDevelopmentID
	DELETE FROM pStyleQuoteVariation	WHERE StyleDevelopmentID = @StyleDevelopmentID
	DELETE FROM pStyleQuoteItem			WHERE StyleDevelopmentID = @StyleDevelopmentID
END



----==DELETE LINEPLAN Info
DECLARE @LinePlanAttributeItemID1 UNIQUEIDENTIFIER 
DECLARE @LinePlanAttributeItemID2 UNIQUEIDENTIFIER 
DECLARE @LinePlanAttributeItemID3 UNIQUEIDENTIFIER 
DECLARE @LinePlanAttributeItemID4 UNIQUEIDENTIFIER 
DECLARE @LinePlanID UNIQUEIDENTIFIER 
DECLARE @LinePlanRangeID UNIQUEIDENTIFIER 
DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER 

/*
SELECT @LinePlanID =  LinePlanID, @LinePlanAttributeItemID1 = LinePlanAttributeItemID1, @LinePlanAttributeItemID2 = LinePlanAttributeItemID2, 
@LinePlanAttributeItemID3 = LinePlanAttributeItemID3 , @LinePlanAttributeItemID4 = LinePlanAttributeItemID4 
FROM pLinePlanBusinessItem
WHERE StyleID = @StyleID 
AND LinePlanFinancialID  = '10000000-0000-0000-0000-000000000004'
*/

SELECT @StyleSeasonYearID = c.StyleSeasonYearID,
@LinePlanID =  a.LinePlanID, @LinePlanAttributeItemID1 = a.LinePlanAttributeItemID1, 
@LinePlanAttributeItemID2 = a.LinePlanAttributeItemID2, 
@LinePlanAttributeItemID3 = a.LinePlanAttributeItemID3 , 
@LinePlanAttributeItemID4 = a.LinePlanAttributeItemID4 ,
@LinePlanRangeID = b.LinePlanRangeID
FROM pLinePlanBusinessItem a
INNER JOIN pLinePlanRange b ON  a.LinePlanAttributeItemID1 = b.LinePlanAttributeItemID1
AND a.LinePlanAttributeItemID2 = b.LinePlanAttributeItemID2
AND a.LinePlanAttributeItemID3 = b.LinePlanAttributeItemID3
AND a.LinePlanFinancialID  = b.LinePlanFinancialID  
INNER JOIN pStyleSeasonYear c ON c.StyleID =  a.StyleID 
AND c.LinePlanID = a.LinePlanID 
where a.LinePlanFinancialID  = '10000000-0000-0000-0000-000000000004'
and a.StyleID = @StyleID


IF @LinePlanID IS NOT NULL 
BEGIN
	
	UPDATE pLinePlanItem Set StyleID  = '00000000-0000-0000-0000-000000000000' WHERE StyleID = @StyleID

	DELETE FROM  pLinePlanBusinessItem WHERE StyleID = @StyleID

/*
	EXEC dbo.spx_LinePlanBusinessItemRollup_INSERT @LinePlanId = @LinePlanId,
	@LinePlanAttributeItemId1 = @LinePlanAttributeItemId1, @LinePlanAttributeItemId2 = @LinePlanAttributeItemId2 ,
	@LinePlanAttributeItemId3 = @LinePlanAttributeItemId3 , @LinePlanAttributeItemId4 = @LinePlanAttributeItemId4
*/
		EXEC spx_LinePlanBusinessItem_QUEUE 
		@StyleQuoteItemID = NULL,
		@StyleID = NULL,
		@LinePlanID = @LinePlanID, 
		@LinePlanRangeID = @LinePlanRangeID,
		@LinePlanAttributeItemID1 = @LinePlanAttributeItemID1, 
		@LinePlanAttributeItemID2 = @LinePlanAttributeItemID2,
		@LinePlanAttributeItemID3 = @LinePlanAttributeItemID3,
		@LinePlanAttributeItemID4 = @LinePlanAttributeItemID4,
		@StyleSeasonYearID = @StyleSeasonYearID,
		@Cmd  = ''


END 


DELETE FROM pStyleSeasonYear WHERE StyleID = @StyleID
DELETE FROM pStyleColorwaySeasonYear WHERE StyleID = @StyleID









GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleQuoteItem_DELETE]'
GO



ALTER PROCEDURE [dbo].[spx_StyleQuoteItem_DELETE]
(@StyleQuoteItemID uniqueidentifier)
AS 

DECLARE @StyleColorID UNIQUEIDENTIFIER 
DECLARE @StyleID UNIQUEIDENTIFIER 
DECLARE @StyleSourcingID UNIQUEIDENTIFIER 
DECLARE @StyleQuoteItemStatusId INT 

SELECT @StyleColorID = StyleColorID, @StyleID = StyleID, @StyleSourcingID = StyleSourcingID, 
@StyleQuoteItemStatusId  = StyleQuoteItemStatusId 
FROM pStyleQuoteItem WHERE StyleQuoteItemID = @StyleQuoteItemID 


BEGIN
	DELETE FROM pStyleQuoteItem WHERE (StyleQuoteItemID = @StyleQuoteItemID)
END

BEGIN
	DELETE FROM pStyleQuoteItemActivity WHERE (StyleQuoteItemID = @StyleQuoteItemID)
END

BEGIN
	DELETE FROM pStyleQuoteItemFreightCost WHERE (StyleQuoteItemID = @StyleQuoteItemID)
END



IF @StyleColorID IS NOT NULL AND @StyleSourcingID IS NOT NULL AND @StyleQuoteItemStatusId = 3
BEGIN
	IF ( SELECT StyleColorStatus FROM pStyleColorway WHERE StyleColorID = @StyleColorID ) = 200
	BEGIN

		-- Do RollUp
		DECLARE @LinePlanAttributeItemID1 UNIQUEIDENTIFIER 
		DECLARE @LinePlanAttributeItemID2 UNIQUEIDENTIFIER 
		DECLARE @LinePlanAttributeItemID3 UNIQUEIDENTIFIER 
		DECLARE @LinePlanAttributeItemID4 UNIQUEIDENTIFIER 
		DECLARE @LinePlanID UNIQUEIDENTIFIER 


		SELECT @LinePlanID =  LinePlanID, @LinePlanAttributeItemID1 = LinePlanAttributeItemID1, @LinePlanAttributeItemID2 = LinePlanAttributeItemID2, 
		@LinePlanAttributeItemID3 = LinePlanAttributeItemID3 , @LinePlanAttributeItemID4 = LinePlanAttributeItemID4 
		FROM pLinePlanBusinessItem
		WHERE StyleID = @StyleID 
		AND LinePlanFinancialID  = '00000000-0000-0000-0000-000000000023'

		IF @LinePlanID IS NOT NULL 
		BEGIN

			DECLARE @LinePlanRangeID  UNIQUEIDENTIFIER 
			DECLARE @LinePlanItemID  UNIQUEIDENTIFIER 
			DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER

			select @LinePlanRangeID =  LinePlanRangeID  from pLinePlanRange
			where LinePlanfinancialID = '10000000-0000-0000-0000-000000000004'
			and LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
			and LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
			and LinePlanAttributeItemID3 = @LinePlanAttributeItemID3

			select @LinePlanItemID = LinePlanItemID from pLinePlanItem 
			WHERE LinePlanRangeID  = @LinePlanRangeID  
			AND StyleID  = @StyleID


			SELECT @StyleSeasonYearID = StyleSeasonYearID 
			FROM pStyleSeasonYear 
			WHERE LinePlanID = @LinePlanID 
			AND LinePlanItemID =  @LinePlanItemID
			AND StyleID = @StyleID 

/*

			EXEC spx_LinePlanBusinessItemRollup_INSERT 
			@LinePlanID = @LinePlanID, 
			@LinePlanAttributeItemID1 = @LinePlanAttributeItemID1, 
			@LinePlanAttributeItemID2 = @LinePlanAttributeItemID2, 
			@LinePlanAttributeItemID3 = @LinePlanAttributeItemID3, 
			@LinePlanAttributeItemID4 = @LinePlanAttributeItemID4 , 
			@StyleSeasonYearID = @StyleSeasonYearID
*/

			EXEC spx_LinePlanBusinessItem_QUEUE 
			@StyleQuoteItemID = NULL,
			@StyleID = NULL,
			@LinePlanID = @LinePlanID, 
			@LinePlanRangeID = NULL,
			@LinePlanAttributeItemID1 = @LinePlanAttributeItemID1, 
			@LinePlanAttributeItemID2 = @LinePlanAttributeItemID2,
			@LinePlanAttributeItemID3 = @LinePlanAttributeItemID3,
			@LinePlanAttributeItemID4 = @LinePlanAttributeItemID4,
			@StyleSeasonYearID = @StyleSeasonYearID,
			@Cmd  = ''

		END 
	END 
END 






GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialCore_DELETE]'
GO

CREATE PROCEDURE [dbo].[spx_MaterialCore_DELETE](@MaterialCoreID uniqueidentifier)
AS 

BEGIN

	BEGIN TRY --Start the Try Block..
		BEGIN TRANSACTION -- Start the transaction..
		
		
			--***
			--** Get Materials in group, remove them from Multi-Cloth Styles
			--***
			CREATE TABLE #style (
				ROWID INT IDENTITY (1,1),
				StyleID UNIQUEIDENTIFIER 
			)
			
			INSERT INTO #style ( StyleID )
			SELECT StyleID FROM pStyleHeader WHERE MaterialCoreID = @MaterialCoreID
			
			DECLARE @ROWID INT
			DECLARE @TOTAL INT
			DECLARE @StyleID UNIQUEIDENTIFIER 
			
			SELECT @TOTAL = COUNT(*) FROM #style
			SET @ROWID = 1 
			
			WHILE @ROWID <= @TOTAL 
			BEGIN
			
				SELECT @StyleID = StyleID FROM #style WHERE ROWID = @ROWID 
			
				CREATE TABLE #sm (
					ROWID INT IDENTITY (1,1),
					StyleMaterialID UNIQUEIDENTIFIER 
				)
				
				INSERT INTO #sm (StyleMaterialID) 
				SELECT a.StyleMaterialID 
				FROM pStyleMaterials a
				INNER JOIN pMaterialCoreItem b ON a.StyleMaterialLinkID = b.MaterialCoreItemID
				WHERE a.StyleID = @StyleID 
				AND a.MultiCloth  = 1 
				AND b.MaterialCoreID = @MaterialCoreID 
				
				
				DECLARE @StyleMaterialID UNIQUEIDENTIFIER 
				DECLARE @ROWID_SM INT
				DECLARE @TOTAL_SM INT
				
				SELECT @TOTAL_SM =  COUNT(*) FROM #sm
				SET @ROWID_SM = 1 
				
				WHILE  @ROWID_SM <= @TOTAL_SM 
				BEGIN
					SELECT @StyleMaterialID = StyleMaterialID FROM #sm WHERE ROWID = @ROWID_SM 
					EXEC spx_StyleMaterial_DELETE @StyleMaterialID = @StyleMaterialID
					SET @ROWID_SM = @ROWID_SM + 1 
				END 
				
				DROP TABLE #sm
					
				SET @ROWID = @ROWID + 1 
			END 
			
			
			--***
			--** Remove MaterialCore records 
			--***		
			DELETE FROM pMaterialCoreColorItem WHERE MaterialCoreID = @MaterialCoreID
			DELETE FROM pMaterialCoreItem WHERE MaterialCoreID = @MaterialCoreID
			DELETE FROM pMaterialCoreColor WHERE MaterialCoreID = @MaterialCoreID
			DELETE FROM pMaterialCore WHERE MaterialCoreID = @MaterialCoreID
		COMMIT TRAN -- Transaction Success!
	END TRY

	BEGIN CATCH
		IF @@TRANCOUNT > 0
		ROLLBACK TRAN --RollBack in case of Error
        DECLARE @ErrorMessage NVARCHAR(4000);
        DECLARE @ErrorSeverity INT;
        DECLARE @ErrorState INT;

        SELECT @ErrorMessage = ERROR_MESSAGE();
        SELECT @ErrorSeverity = ERROR_SEVERITY();
        SELECT @ErrorState = ERROR_STATE();

        RAISERROR (
				   @ErrorMessage, -- Message text.
                   @ErrorSeverity, -- Severity.
                   @ErrorState -- State.
                   );

	END CATCH

END


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_AccessLinePlanFolderTab_SELECT]'
GO


ALTER PROCEDURE [dbo].[spx_Group_AccessLinePlanFolderTab_SELECT] (
@LinePlanTemplateId uniqueidentifier,
@AccessLinePlanId uniqueidentifier
)
AS 

BEGIN
	INSERT INTO pLinePlanFolderTab (LinePlanTabID,LinePlanTemplateID)
	SELECT LinePlanTabID, @LinePlanTemplateID 
	FROM pLinePlanTab 
	WHERE Active = 1 
	AND LinePlanTabID NOT IN  (
		SELECT LinePlanTabID FROM pLinePlanFolderTab 
		WHERE LinePlanTemplateId = @LinePlanTemplateId
	) 
END


BEGIN
	INSERT INTO sAccessGroupLinePlanTab (AccessLinePlanID, LinePlanTemplateID, LinePlanFolderTabID)
	SELECT @AccessLinePlanID, @LinePlanTemplateID, LinePlanFolderTabID 
	FROM pLinePlanFolderTab 
	WHERE LinePlanFolderTabID NOT IN (
		SELECT LinePlanFolderTabID FROM sAccessGroupLinePlanTab
		WHERE LinePlanTemplateId = @LinePlanTemplateId AND AccessLinePlanId = @AccessLinePlanId
	)
	AND LinePlanTemplateId = @LinePlanTemplateId 

END

BEGIN
	SELECT dbo.pLinePlanFolderTab.LinePlanTemplateID, dbo.sAccessGroupLinePlanTab.LinePlanFolderTabID, dbo.pLinePlanTab.LinePlanTabID, 
      dbo.pLinePlanTab.LinePlanTabName, dbo.sAccessGroupLinePlanTab.AccessLinePlanId, dbo.sAccessGroupLinePlanTab.AccessRoleId, 
      dbo.sAccessGroupLinePlanTab.AccessView, dbo.sAccessGroupLinePlanTab.AccessCreate, dbo.sAccessGroupLinePlanTab.AccessModify, 
      dbo.sAccessGroupLinePlanTab.AccessDelete, dbo.sAccessGroupLinePlanTab.AccessPrint, dbo.sAccessGroupLinePlanTab.AccessRemove, 
      dbo.sAccessGroupLinePlanTab.CUser, dbo.sAccessGroupLinePlanTab.CDate, dbo.sAccessGroupLinePlanTab.MUser, 
      dbo.sAccessGroupLinePlanTab.MDate, dbo.sAccessGroupLinePlanTab.AccessLinePlanTabId
	FROM dbo.pLinePlanFolderTab INNER JOIN
      dbo.pLinePlanTab ON dbo.pLinePlanFolderTab.LinePlanTabID = dbo.pLinePlanTab.LinePlanTabID INNER JOIN
      dbo.sAccessGroupLinePlanTab ON dbo.pLinePlanFolderTab.LinePlanFolderTabID = dbo.sAccessGroupLinePlanTab.LinePlanFolderTabID
	WHERE sAccessGroupLinePlanTab.AccessLinePlanId = @AccessLinePlanId AND pLinePlanFolderTab.LinePlanTemplateID = @LinePlanTemplateId
	ORDER BY pLinePlanTab.LinePlanTabSort
END









GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_MaterialCoreItem_DELETE]'
GO


CREATE PROCEDURE [dbo].[spx_MaterialCoreItem_DELETE](@MaterialCoreItemID uniqueidentifier)
AS 

BEGIN

	BEGIN TRY --Start the Try Block..
		BEGIN TRANSACTION -- Start the transaction..
		
			--***
			--** Delete StyleMaterials 
			--***
			CREATE TABLE #sm (
				ROWID INT IDENTITY (1,1),
				StyleMaterialID UNIQUEIDENTIFIER 
			)
			
			INSERT INTO #sm (StyleMaterialID) 
			SELECT StyleMaterialID FROM pStyleMaterials WHERE StyleMaterialLinkID = @MaterialCoreItemID 
			
			DECLARE @StyleMaterialID UNIQUEIDENTIFIER 
			DECLARE @ROWID_SM INT
			DECLARE @TOTAL_SM INT
			
			SELECT @TOTAL_SM =  COUNT(*) FROM #sm
			SET @ROWID_SM = 1 
			
			WHILE  @ROWID_SM <= @TOTAL_SM 
			BEGIN
				SELECT @StyleMaterialID = StyleMaterialID FROM #sm WHERE ROWID = @ROWID_SM 
				EXEC spx_StyleMaterial_DELETE @StyleMaterialID = @StyleMaterialID
				SET @ROWID_SM = @ROWID_SM + 1 
			END 
			
			DROP TABLE #sm
			
			--***
			--** Delete MaterialCoreItem record 
			--***
			DELETE FROM pMaterialCoreColorItem WHERE MaterialCoreItemID = @MaterialCoreItemID
			DELETE FROM pMaterialCoreItem WHERE MaterialCoreItemID = @MaterialCoreItemID
		COMMIT TRAN -- Transaction Success!
	END TRY

	BEGIN CATCH
		IF @@TRANCOUNT > 0
		ROLLBACK TRAN --RollBack in case of Error
        DECLARE @ErrorMessage NVARCHAR(4000);
        DECLARE @ErrorSeverity INT;
        DECLARE @ErrorState INT;

        SELECT @ErrorMessage = ERROR_MESSAGE();
        SELECT @ErrorSeverity = ERROR_SEVERITY();
        SELECT @ErrorState = ERROR_STATE();

        RAISERROR (
				   @ErrorMessage, -- Message text.
                   @ErrorSeverity, -- Severity.
                   @ErrorState -- State.
                   );

	END CATCH

END


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlan_StyleNewCopySizeClass_INSERT]'
GO


ALTER PROCEDURE [dbo].[spx_LinePlan_StyleNewCopySizeClass_INSERT](
@LinePlanItemID UNIQUEIDENTIFIER, 
@StyleID UNIQUEIDENTIFIER, 
@NewStyleID UNIQUEIDENTIFIER, 
@CreatedDate DATETIME, 
@CreatedBy NVARCHAR(200) ,
@AddComments INT 
)
AS
BEGIN



	DECLARE @SketchID UNIQUEIDENTIFIER
	DECLARE @SketchVersion INT 
	SELECT @SketchID = DesignSketchID, @SketchVersion = DesignSketchVersion FROM  pStyleHeader WHERE StyleID = @StyleID


	EXEC dbo.spx_StyleHeaderCopy_INSERT @StyleID=@StyleID, @NewStyleID=@NewStyleID, @DesignSketchID=@SketchID,  
		@DesignSketchVersion=@SketchVersion, @StyleVariation=@SketchVersion, @CreatedBy=@CreatedBy,  @CreatedDate=@CreatedDate
	EXEC dbo.spx_StyleWorkflowScheaduleCopy_UPDATE @StyleID=@StyleID, @NewStyleID=@NewStyleID , @CreatedBy=@CreatedBy, @CreatedDate=@CreatedDate
	EXEC dbo.spx_StyleSizeClassRangeVariation_UPDATE @StyleID=@StyleID, @NewStyleID=@NewStyleID , @CreatedBy=@CreatedBy, @CreatedDate=@CreatedDate
	EXEC spx_StyleDetailGridCopy_INSERT @StyleID=@StyleID, @NewStyleID=@NewStyleID , @CreatedBy=@CreatedBy,  @CreatedDate=@CreatedDate
	EXEC spx_StyleDetailVariation_INSERT @StyleID=@StyleID, @NewStyleID=@NewStyleID , @CreatedBy=@CreatedBy,  @CreatedDate=@CreatedDate
	
	EXEC spx_LinePlan_StyleMaterialVariation_INSERT @LinePlanItemID=@LinePlanItemID, @StyleID=@StyleID, @NewStyleID=@NewStyleID , @CreatedBy=@CreatedBy,  @CreatedDate=@CreatedDate

	EXEC spx_StyleCareCopy_INSERT @StyleID=@StyleID, @NewStyleID=@NewStyleID , @CreatedBy=@CreatedBy,  @CreatedDate=@CreatedDate
	EXEC spx_StyleDevelopmentSpecVariation_INSERT @StyleID=@StyleID, @NewStyleID=@NewStyleID , @CreatedBy=@CreatedBy,  @CreatedDate=@CreatedDate


END











GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleColorway_LinePlanColor_INSERT]'
GO
/*
'***********************************************************************
' Object name	   : spx_StyleColorway_LinePlanColor_INSERT
' Author           : 
' Created          : 
'
' Last Modified By : Artemio Gomez
' Last Modified On : 12-11-2009
' Description      : Stored procedure used to insert a new colorway to a Style (Lineplan style).
'					 If the record doesn't exist in pStyleColorway, the procedure spx_StyleColorwayFromColor_INSERT is called
'					 This procedure insert records in pStyleColorwaySeasonYear ONLY
'
' Copyright        : (c) Yunique Solutions, Inc. All rights reserved.
' Comments		   :
		#01  -	Artemio Gomez - December 11, 2009
				Call a logic procedure after the insert has been done.
'***********************************************************************
*/

ALTER PROCEDURE [dbo].[spx_StyleColorway_LinePlanColor_INSERT] (
@ColorPaletteID UNIQUEIDENTIFIER, 
@StyleID UNIQUEIDENTIFIER,
@StyleSet INT,
@SeasonYearID UNIQUEIDENTIFIER,
@AllSizeClasses INT,
@CUser NVARCHAR(200), 
@CDate DATETIME 
)
AS


DECLARE @StyleColorID UNIQUEIDENTIFIER 
DECLARE @StyleSeasonYearID  UNIQUEIDENTIFIER
DECLARE @ColorCode NVARCHAR(200)
DECLARE @ColorName NVARCHAR(200)

SELECT @ColorCode = ColorCode, @ColorName = ColorName FROM pColorPalette WHERE ColorPaletteID =@ColorPaletteID

SELECT TOP 1 @StyleColorID = a.StyleColorID 
FROM pStyleColorway a
INNER JOIN pColorPalette b ON a.ColorPaletteID = b.ColorPaletteID 
WHERE StyleID = @StyleID  
AND b.ColorName = @ColorName 
AND b.ColorCode = @ColorCode


IF @StyleColorID IS NULL 
BEGIN

	-- INSERT NEW RECORD
	EXEC dbo.spx_StyleColorwayFromColor_INSERT @StyleID = @StyleID,	@StyleSet = @StyleSet,
	@ColorPaletteID = @ColorPaletteID,	@CUser = @CUser, @CDate = @CDate,
	@AllSizeClasses = @AllSizeClasses, @SeasonYearID = @SeasonYearID

	SELECT TOP 1 @StyleColorID = a.StyleColorID 
	FROM pStyleColorway a
	INNER JOIN pColorPalette b ON a.ColorPaletteID = b.ColorPaletteID 
	WHERE StyleID = @StyleID  
	AND b.ColorName = @ColorName 
	AND b.ColorCode = @ColorCode	

END

SELECT @StyleSeasonYearID = StyleSeasonYearID   
FROM pStyleSeasonYear
WHERE StyleId = @StyleID AND SeasonYearID = @SeasonYearID

IF ( SELECT COUNT(*) FROM pStyleColorwaySeasonYear WHERE StyleSeasonYearID = @StyleSeasonYearID AND StyleColorwayID = @StyleColorID) = 0 
BEGIN
	INSERT INTO pStyleColorwaySeasonYear ( StyleColorwaySeasonYearID, StyleSeasonYearID , StyleColorwayID , StyleID,   
		StyleColorDelivery1, StyleColorDelivery2, StyleColorDelivery3, StyleColorDelivery4, StyleColorStatus, SampleStatus, Units, ColorType )
	VALUES  ( NEWID(), @StyleSeasonYearID , @StyleColorID , @StyleID,   
		1, 1, 1, 1, 100, 100, 0, 'F')
		

	/**	
	** --Comment #01
	** Add Logic INSERT 		
	**/	
	EXEC spx_StyleColorway_Logic_INSERT @StyleSeasonYearID = @StyleSeasonYearID, @StyleColorID = @StyleColorID, 
	@CUser= @CUser, @CDate = @CDate		
END 



















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleColorway_LinePlanColor_Linked_INSERT]'
GO
SET QUOTED_IDENTIFIER OFF
GO
-- 
-- Comment #01 - Artemio Gomez - 3/18/2010
--	   Remove index in Temp Table
-- 

CREATE PROCEDURE [dbo].[spx_StyleColorway_LinePlanColor_Linked_INSERT]
(
	@ColorPaletteID UNIQUEIDENTIFIER, 
	@StyleID UNIQUEIDENTIFIER,
	@StyleSet INT,
	@SeasonYearID UNIQUEIDENTIFIER,
	@AllSizeClasses INT,
	@CUser NVARCHAR(200), 
	@CDate DATETIME 
)

AS


/************************/
/*Declare variables.	*/
/************************/
DECLARE @StyleID_Param UNIQUEIDENTIFIER			--Keep a copy of the original parameter value.
DECLARE @StyleSet_Param INT						--Keep a copy of the original parameter value.

DECLARE @StyleLinkID UNIQUEIDENTIFIER

DECLARE @TotalCount INT
DECLARE @RowCounter INT


/************************************************/
/*Save a copy of the original parameter values.	*/
/************************************************/
SET @StyleID_Param = @StyleID
SET @StyleSet_Param = @StyleSet


/************************/
/*Create temp table.	*/
/************************/
CREATE TABLE #temp_Linked
	(
	TableRow int NOT NULL IDENTITY (1, 1)
	,StyleID UNIQUEIDENTIFIER
	,StyleLinkID UNIQUEIDENTIFIER
	,StyleSet INT
	)  ON [PRIMARY]


-- Comment #01
/*
ALTER TABLE #temp_Linked ADD CONSTRAINT
	PK_#temp_Linked PRIMARY KEY CLUSTERED 
	(
	TableRow
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
*/

/****************************************************/
/*Check to see if the Style is Multi-Cloth linked.	*/
/****************************************************/
/*Get the 'StyleLinkID' of the calling Style.*/
SELECT @StyleLinkID = StyleLinkID
FROM pStyleHeader
WHERE StyleID = @StyleID_Param


/********************************************************************/
/*See if there are other Multi-Cloth linked Styles with this one.	*/
/********************************************************************/
IF(@StyleLinkID IS NULL OR @StyleLinkID = '00000000-0000-0000-0000-000000000000')	--Style is not Multi-Cloth linked.
	BEGIN
		/*Execute original procedure with original parameters.*/
		EXEC spx_StyleColorway_LinePlanColor_INSERT
			@ColorPaletteID
			,@StyleID_Param
			,@StyleSet_Param
			,@SeasonYearID
			,@AllSizeClasses
			,@CUser
			,@CDate
	END
ELSE	--Style is Multi-Cloth linked.
	BEGIN
		/*Get all the Styles that are Multi-Cloth linked to this 'StyleLinkID'.*/
		INSERT INTO #temp_Linked(
			StyleID
			,StyleLinkID
			,StyleSet)
		SELECT
			StyleID
			,StyleLinkID
			,@StyleSet_Param AS StyleSet
		FROM pStyleHeader
		WHERE StyleLinkID = @StyleLinkID
	END

/********************************************************************/
/*Loop through the records to update all Multi-Cloth linked Styles.	*/
/********************************************************************/
/*Get and set the counts for the Multi-Cloth linked Styles.*/
SELECT @TotalCount = COUNT(*) FROM #temp_Linked
SET @RowCounter = 1


/*Get the 'StyleID' for each of the Multi-Cloth linked Styles to add the Colorway to.*/
WHILE(@RowCounter <= @TotalCount)
	BEGIN
		/*Clear variables.*/
		SET @StyleID = NULL
		SET @StyleSet = NULL


		/*Get the 'StyleID' for the insert.*/
		SELECT @StyleID = StyleID
			,@StyleSet = StyleSet
		FROM #temp_Linked
		WHERE TableRow = @RowCounter


		/*Execute the original procedure for another Style.*/
		EXEC spx_StyleColorway_LinePlanColor_INSERT
			@ColorPaletteID
			,@StyleID
			,@StyleSet
			,@SeasonYearID
			,@AllSizeClasses
			,@CUser
			,@CDate


		/*Up row counter.*/
		SET @RowCounter = @RowCounter + 1
	END


/********************/
/*Drop temp tables.	*/
/********************/
DROP TABLE #temp_Linked
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleCostingHeaderLogic_UPDATE]'
GO
SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [dbo].[spx_StyleCostingHeaderLogic_UPDATE](
@StyleID uniqueidentifier,
@ModifiedBy varchar(200),
@ModifiedDate datetime,
@StyleSeasonYearID UNIQUEIDENTIFIER 
)
AS 


DECLARE @pStyleID NVARCHAR(70)
DECLARE @pModifiedBy NVARCHAR(250)
DECLARE @pModifiedDate NVARCHAR(100)
DECLARE @pStyleSeasonYearID NVARCHAR(70)

IF @StyleID IS NULL
	SET @pStyleID = ' @StyleID = NULL '
ELSE
	SET @pStyleID = ' @StyleID = ''' +  CAST (@StyleID AS NVARCHAR(50)) + ''' '

IF @StyleSeasonYearID IS NULL
	SET @pStyleSeasonYearID = ' @StyleSeasonYearID = NULL '
ELSE
	SET @pStyleSeasonYearID = ' @StyleSeasonYearID = ''' +  CAST (@StyleSeasonYearID  AS NVARCHAR(50)) + ''' '

IF @ModifiedBy IS NULL
	SET @pModifiedBy = ' @ModifiedBy = NULL '
ELSE
	SET @pModifiedBy= ' @ModifiedBy = ''' +  @ModifiedBy  + ''' '

IF @ModifiedDate IS NULL
	SET @pModifiedDate = ' @ModifiedDate = NULL '
ELSE
	SET @pModifiedDate= ' @ModifiedDate = ''' +  CONVERT( NVARCHAR(40) , @ModifiedDate  , 20 ) + ''' '


DECLARE @ServiceDate DATETIME
SET @ServiceDate = getdate()

DECLARE @ServiceQueueSql1 nvarchar(4000)
SET @ServiceQueueSql1 = 'dbo.spx_StyleCostingHeaderLogic_UPDATE_QUEUE ' + 
@pStyleID + ',' + 
@pModifiedBy + ',' + 
@pModifiedDate + ',' + 
@pStyleSeasonYearID


exec spx_ServiceQueue_INSERT @ServiceQueueSql = @ServiceQueueSql1, @ServiceQueuePriority = 1, @ServiceQueueDate = @ServiceDate





/*


DECLARE @LinePlanItemID UNIQUEIDENTIFIER 
DECLARE @LinePlanId VARCHAR(50)
DECLARE @LinePlanAttributeItemId1 VARCHAR(50)
DECLARE @LinePlanAttributeItemId2 VARCHAR(50)
DECLARE @LinePlanAttributeItemId3 VARCHAR(50)
DECLARE @LinePlanAttributeItemId4 VARCHAR(50)


IF @StyleSeasonYearID IS NULL 
BEGIN 
	SELECT TOP 1
		@LinePlanID = pLinePlanItem.LinePlanID,
		@LinePlanAttributeItemID1 = pLinePlanRange.LinePlanAttributeItemID1, 
		@LinePlanAttributeItemID2 = pLinePlanRange.LinePlanAttributeItemID2, 
		@LinePlanAttributeItemID3 = pLinePlanRange.LinePlanAttributeItemID3, 
		@LinePlanAttributeItemID4 = pLinePlanRange.LinePlanAttributeItemID4
	FROM pLinePlanItem INNER JOIN
	  pLinePlanRange ON pLinePlanItem.LinePlanRangeID = pLinePlanRange.LinePlanRangeID
	WHERE pLinePlanItem.StyleID = @StyleID
END
ELSE
BEGIN
	
	SELECT @LinePlanItemID = LinePlanItemID
	FROM pStyleSeasonYear
	WHERE StyleSeasonYearID = @StyleSeasonYearID
		
	SELECT TOP 1
		@LinePlanID = pLinePlanItem.LinePlanID,
		@LinePlanAttributeItemID1 = pLinePlanRange.LinePlanAttributeItemID1, 
		@LinePlanAttributeItemID2 = pLinePlanRange.LinePlanAttributeItemID2, 
		@LinePlanAttributeItemID3 = pLinePlanRange.LinePlanAttributeItemID3, 
		@LinePlanAttributeItemID4 = pLinePlanRange.LinePlanAttributeItemID4
	FROM pLinePlanItem INNER JOIN
	  pLinePlanRange ON pLinePlanItem.LinePlanRangeID = pLinePlanRange.LinePlanRangeID
	WHERE pLinePlanItem.LinePlanItemID = @LinePlanItemID

END 

DECLARE @PL1_NoOfStyle INTEGER
DECLARE @PL1_NoOfFabric INTEGER
DECLARE @PL1_NoOfBody INTEGER 
DECLARE @PL1_NoOfColor INTEGER
DECLARE @PL1_NoOfOptions INTEGER
DECLARE @PL1_MarkupFactor DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetalPriceHigh DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleLow DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleMed DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @PL1_TargetAvgWhsPrice DECIMAL(18, 3)
--DECLARE @PL1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @PL1_SalesUnit DECIMAL(18, 3)
DECLARE @PL1_ProjectedWhs DECIMAL(18, 3)
DECLARE @PL1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL1_WeightGrossMarginRtl DECIMAL(18, 3)

SELECT TOP 1 
	@PL1_InitialGrossMarginRtl = LinePlanBusPnCh1
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000010'

SELECT TOP 1 
	@PL1_TargetAvgRetailPriceMed = LinePlanBusPnCh1
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000022'


SELECT TOP 1  
	@PL1_MarkupFactor = LinePlanBusPnCh1 
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000005'


/*
--GET Average Target FOB 
SELECT TOP 1  
	@PL1_AvgTargetFOB = LinePlanBusPnCh1 
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000006'
*/


--SELECT @PL1_InitialGrossMarginRtl, @PL1_TargetAvgRetailPriceMed, @PL1_MarkupFactor

--Calculate Average Target FOB 
--SET @PL1_AvgTargetFOB = (@PL1_TargetAvgRetailPriceMed - (@PL1_TargetAvgRetailPriceMed * @PL1_InitialGrossMarginRtl)) 

--StyleCostingCustomField1 = Target Retail GBP = Manual Input
--StyleCostingCustomField2 = Target First Cost = Average Target FOB
--StyleCostingCustomField3 = Margin Markup = (StyleCostingCustomField1-StyleCostingCustomField2)/StyleCostingCustomField1
--StyleCostingCustomField4 = Units =Manual Input
--StyleCostingCustomField5 = Wholesale Margin = StyleCostingCustomField6-StyleCostingCustomField2/StyleCostingCustomField6
--StyleCostingCustomField6 = Target Wholesale Price = StyleCostingCustomField1/MarkupFactor

DECLARE @StyleCostingCustomField1 DECIMAL(18,3)
DECLARE @StyleCostingCustomField2 DECIMAL(18,3)
DECLARE @StyleCostingCustomField3 DECIMAL(18,3)
DECLARE @StyleCostingCustomField4 DECIMAL(18,3)
DECLARE @StyleCostingCustomField5 DECIMAL(18,3)
DECLARE @StyleCostingCustomField6 DECIMAL(18,3)


IF @StyleSeasonYearID IS NULL 
BEGIN 
	SELECT 
	@StyleCostingCustomField1 = StyleCostingCustomField1, --Targe Retail GBP
	@StyleCostingCustomField4 = StyleCostingCustomField4, --Sales Unit
	@StyleCostingCustomField3 = StyleCostingCustomField3 -- FTM
	FROM pStyleCostingHeader WHERE StyleID = @StyleID
END
ELSE 
BEGIN
	SELECT 
	@StyleCostingCustomField1 = StyleCostingCustomField1, --Targe Retail GBP
	@StyleCostingCustomField4 = StyleCostingCustomField4, --Sales Unit
	@StyleCostingCustomField3 = StyleCostingCustomField3 -- FTM  / Margin Markup
	FROM pStyleCostingHeader 
	WHERE StyleID = @StyleID AND StyleSeasonYearID = @StyleSeasonYearID
END 


--SET @StyleCostingCustomField1 = 0
--SET @StyleCostingCustomField2 = @PL1_AvgTargetFOB

-- =============================================================================================
-- TARGER 1ST COST  =  Targer rtl L - (Targer rtl L * FTM) 
SET @StyleCostingCustomField2 = @StyleCostingCustomField1 - ( @StyleCostingCustomField1 * @StyleCostingCustomField3)


---*** SET @StyleCostingCustomField3 = CASE WHEN @StyleCostingCustomField1 = 0 THEN 0 ELSE (@StyleCostingCustomField1-@StyleCostingCustomField2)/@StyleCostingCustomField1 END
--SET @StyleCostingCustomField4 = 0
SET @StyleCostingCustomField6 = CASE WHEN @PL1_MarkupFactor = 0 THEN 0 ELSE @StyleCostingCustomField1/@PL1_MarkupFactor END
SET @StyleCostingCustomField5 = CASE WHEN @StyleCostingCustomField6 = 0 THEN 0 ELSE (@StyleCostingCustomField6-@StyleCostingCustomField2)/@StyleCostingCustomField6 END

--select @StyleCostingCustomField1 , @PL1_MarkupFactor 

IF @StyleSeasonYearID IS NULL 
BEGIN
	UPDATE pStyleCostingHeader SET 
		StyleCostingCustomField2 = @StyleCostingCustomField2, -- Target FirstCost
		--StyleCostingCustomField3 = @StyleCostingCustomField3, -- Margin Mrkup
		StyleCostingCustomField5 = @StyleCostingCustomField5, -- WHS Margin
		StyleCostingCustomField6 = @StyleCostingCustomField6, -- Target WHS Price
		MUser = @ModifiedBy, 
		MDate = @ModifiedDate
	WHERE StyleId = @StyleId
END
ELSE 
BEGIN
	UPDATE pStyleCostingHeader SET 
		StyleCostingCustomField2 = @StyleCostingCustomField2, -- Target FirstCost
		--StyleCostingCustomField3 = @StyleCostingCustomField3, -- Margin Mrkup
		StyleCostingCustomField5 = @StyleCostingCustomField5, -- WHS Margin
		StyleCostingCustomField6 = @StyleCostingCustomField6, -- Target WHS Price
		MUser = @ModifiedBy, 
		MDate = @ModifiedDate
	WHERE StyleId = @StyleId AND StyleSeasonYearID = @StyleSeasonYearID
END 

-- ====================================================================================================================================
-- MODIFIED BY ARTEMIO
-- ADD LOGIC TO UPDATE STYLE_SOURCING_QUOTE_ITEMS 

CREATE TABLE #tmpQuoteItem  (
ROW_ID INT IDENTITY (1,1),
StyleQuoteItemID UNIQUEIDENTIFIER 
)

IF @StyleSeasonYearID IS NULL 
BEGIN
	INSERT INTO #tmpQuoteItem (StyleQuoteItemID)
	SELECT StyleQuoteItemID 
	FROM pStyleQuoteItem WHERE StyleID = @StyleID
END 
ELSE
BEGIN
	INSERT INTO #tmpQuoteItem (StyleQuoteItemID)
	SELECT a.StyleQuoteItemID 
	FROM pStyleQuoteItem a
	INNER JOIN pStyleSourcing b ON a.StyleSourcingID =  b.StyleSourcingID
	WHERE a.StyleID = @StyleID
	AND b.StyleSeasonYearID = @StyleSeasonYearID
END 

DECLARE @TOTAL INT
DECLARE @ROW_ID INT 
DECLARE @StyleQuoteItemID UNIQUEIDENTIFIER 

SET @ROW_ID = 1 
SELECT @TOTAL  = COUNT(*) FROM #tmpQuoteItem

WHILE  @ROW_ID <= @TOTAL
BEGIN

	SELECT @StyleQuoteItemID = StyleQuoteItemID FROM #tmpQuoteItem WHERE ROW_ID = @ROW_ID
	
	EXEC dbo.spx_StyleSourcingQuoteItemLogic_UPDATE @StyleQuoteItemID

	SET @ROW_ID = @ROW_ID + 1 
	
END 

DROP TABLE  #tmpQuoteItem











/***********************************************
New statements added by Ryan Cabanas on 8/26/08.
************************************************/

--SELECT 1


/************************************************************
Original statements commented out by Ryan Cabanas on 8/26/08.
*************************************************************/

--DECLARE @TargetRetail nvarchar(50),
--@SampleWeight nvarchar(50),
--@TargetMarginPerc nvarchar(50),
--@MiscCost nvarchar(50),
--@RoyalPerc nvarchar(50),
--@ShipDate nvarchar(50),
--@Units nvarchar(50)
--
--	SELECT 
--		@TargetRetail = StyleCostingCustomField1, 
--		@SampleWeight = StyleCostingCustomField2,
--		@TargetMarginPerc = StyleCostingCustomField3, 
--		@MiscCost = StyleCostingCustomField4, 
--		@RoyalPerc = StyleCostingCustomField8, 
--		@ShipDate = StyleCostingCustomField17, 
--		@Units = StyleCostingCustomField18 
--	FROM dbo.pStyleCostingHeader
--	WHERE StyleID = @StyleID
--	  
--
--	UPDATE  dbo.pStyleCosting
--	SET 
--	StyleCostingCustomField1 = @TargetRetail, 
--	StyleCostingCustomField2 = @SampleWeight, 
--	StyleCostingCustomField3 = @TargetMarginPerc, 
--	StyleCostingCustomField4 = @MiscCost, 
--	StyleCostingCustomField8 = @RoyalPerc, 
--	StyleCostingCustomField17 = @ShipDate, 
--	StyleCostingCustomField18 = @Units,
--	MUser = @ModifiedBy,
--	MDate = @ModifiedDate
--	WHERE (StyleID = @StyleID)




*/




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleSourcingQuoteItemLogic_UPDATE]'
GO







ALTER PROCEDURE [dbo].[spx_StyleSourcingQuoteItemLogic_UPDATE]
(
@StyleQuoteItemID uniqueidentifier
)
AS 



DECLARE @StyleID UNIQUEIDENTIFIER
DECLARE @StyleColorID UNIQUEIDENTIFIER
DECLARE @StyleColorStatus INT
DECLARE @StyleQuoteItemStatusId INT
DECLARE @LinePlanID UNIQUEIDENTIFIER
DECLARE @LinePlanItemID UNIQUEIDENTIFIER
DECLARE @LinePlanRangeID UNIQUEIDENTIFIER
DECLARE @LinePlanAttributeItemID1 UNIQUEIDENTIFIER
DECLARE @LinePlanAttributeItemID2 UNIQUEIDENTIFIER
DECLARE @LinePlanAttributeItemID3 UNIQUEIDENTIFIER
DECLARE @LinePlanAttributeItemID4 UNIQUEIDENTIFIER
DECLARE @StyleSourcingID UNIQUEIDENTIFIER
DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER

--DECLARE @MostLikelyVendor INT 


SELECT TOP 1 
	@StyleID = StyleID,
	@StyleColorID = StyleColorID,
	@StyleQuoteItemStatusId = StyleQuoteItemStatusId,
	@StyleSourcingID = StyleSourcingID
FROM pStyleQuoteItem
WHERE (StyleQuoteItemID = @StyleQuoteItemID) 

SELECT @LinePlanItemID = b.LinePlanItemID, @StyleSeasonYearID =  a.StyleSeasonYearID
FROM pStyleSourcing  a 
INNER JOIN pStyleSeasonYear b ON a.StyleSeasonYearID =  b.StyleSeasonYearID
WHERE a.StyleSourcingID = @StyleSourcingID

--===========================================================================================
-- CALCUTE Total of Units based on the Colors approved 

DECLARE @Units INT 

SELECT  @Units = SUM (a.Units ) 
FROM pStyleColorwaySeasonYear a 
WHERE a.StyleSeasonYearID = @StyleSeasonYearID
AND (a.StyleColorStatus = 200 or a.StyleColorStatus = 300)
AND StyleColorwayID IN  (
	SELECT b.StyleColorID 
	FROM pStyleSourcing a
	INNER JOIN pStyleQuoteItem b ON a.StyleSourcingID =  b.StyleSourcingID 
	WHERE a.StyleSeasonYearID = @StyleSeasonYearID
	AND b.StyleQuoteItemStatusID = 3
) 

IF @Units IS NULL 
	SET @Units = 0 

UPDATE pStyleCostingHeader SET  StyleCostingCustomField4 = 0 
WHERE StyleID = @StyleID 


--===========================================================================================

SELECT 
	@LinePlanID = pLinePlanItem.LinePlanID,
--	@LinePlanItemID = pLinePlanItem.LinePlanItemID,
	@LinePlanRangeID = pLinePlanItem.LinePlanRangeID,
	@LinePlanAttributeItemID1 = pLinePlanRange.LinePlanAttributeItemID1, 
	@LinePlanAttributeItemID2 = pLinePlanRange.LinePlanAttributeItemID2, 
	@LinePlanAttributeItemID3 = pLinePlanRange.LinePlanAttributeItemID3, 
	@LinePlanAttributeItemID4 = pLinePlanRange.LinePlanAttributeItemID4
FROM pLinePlanItem INNER JOIN
  pLinePlanRange ON pLinePlanItem.LinePlanRangeID = pLinePlanRange.LinePlanRangeID
WHERE pLinePlanItem.LinePlanItemID = @LinePlanItemID 



exec spx_StyleQuoteItemLogic_UPDATE @StyleQuoteItemID, @StyleID, @LinePlanID, 
@LinePlanRangeID, @LinePlanAttributeItemID1, @LinePlanAttributeItemID2, @LinePlanAttributeItemID3, @LinePlanAttributeItemID4


/*
select @MostLikelyVendor = b.MostLikelyVendor
from pStyleQuoteItem a INNER JOIN pStyleSourcing b ON a.StyleSourcingID = b.StyleSourcingID 
WHERE StyleQuoteItemID = @StyleQuoteItemID
*/

--Artemio Code
-- ADD the MostlikelyVendor as a condition to execute the logic update and roll-up
--IF @StyleQuoteItemStatusId = 3 AND @StyleColorStatus = 200 AND @MostLikelyVendor = 1
--BEGIN

IF @LinePlanAttributeItemID1 IS NOT NULL AND 
@LinePlanAttributeItemID2 IS NOT NULL AND 
@LinePlanAttributeItemID1 IS NOT NULL AND 
@LinePlanItemID IS NOT NULL 
BEGIN 
/*	
	exec spx_LinePlanBusinessItemLogic_UPDATE @StyleQuoteItemID, @StyleID, @LinePlanID, @LinePlanRangeID, 
	@LinePlanAttributeItemID1, @LinePlanAttributeItemID2, @LinePlanAttributeItemID3, @LinePlanAttributeItemID4, @StyleSeasonYearID
	
	exec spx_LinePlanBusinessItemRollup_INSERT 
	@LinePlanID = @LinePlanID, 
	@LinePlanAttributeItemID1 = @LinePlanAttributeItemID1, 
	@LinePlanAttributeItemID2 = @LinePlanAttributeItemID2, 
	@LinePlanAttributeItemID3 = @LinePlanAttributeItemID3, 
	@LinePlanAttributeItemID4 = @LinePlanAttributeItemID4, 
	@StyleSeasonYearID = @StyleSeasonYearID
*/

		EXEC spx_LinePlanBusinessItem_QUEUE 
		@StyleQuoteItemID = @StyleQuoteItemID,
		@StyleID = @StyleID,
		@LinePlanID = @LinePlanID, 
		@LinePlanRangeID = @LinePlanRangeID,
		@LinePlanAttributeItemID1 = @LinePlanAttributeItemID1, 
		@LinePlanAttributeItemID2 = @LinePlanAttributeItemID2,
		@LinePlanAttributeItemID3 = @LinePlanAttributeItemID3,
		@LinePlanAttributeItemID4 = @LinePlanAttributeItemID4,
		@StyleSeasonYearID = @StyleSeasonYearID,
		@Cmd  = ''

END 


--END


--Artemio Code
-- UPDATE StyleQuoteItemVersion 
EXEC dbo.spx_StyleSourcingQuoteItemVersion_UPDATE  @StyleQuoteItemID = @StyleQuoteItemID
	






















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleCostingHeaderLogic_UPDATE_QUEUE]'
GO


/*
Comments:

#01 - Ryan Cabanas - October 8, 2009
	Burberry wants the calculations for 'Target First Cost' to change.
Commented out old calculation.  New calculation had to be moved down 
lower because the fields used need to be themselves calculated first.

#02 - Ryan Cabanas - October 8, 2009
	Burberry wants to add a calculation for the 'Flow Through Margin'
field.  Previously, this was simply a user-entered field.  This field
needs to be locked down now.  Commented out areas where the user-
entered value was being SELECTED.  Also needed to uncomment out the
update of the 'Flow Through Margin' back to 'pStyleCostingHeader'.

#03 - Ryan Cabanas - October 12, 2009
	Burberry wants to manually enter the 'Wholesale Margin' field now.
Commented out the equation that was there.  Need to add it to the
SELECT, as well.

#04 - Ryan Cabanas - October 28, 2009
	Modify the procedure for the new costing grid at the Line Plan area.
"@StyleCostingCustomField1" was pulling from user entered data, but need
to change that because it will now be pulled from the custom table that will
be filling the costing grid via the "Price Band" dropdown selection.  Feature #1229.
*/



CREATE PROCEDURE [dbo].[spx_StyleCostingHeaderLogic_UPDATE_QUEUE](
@StyleID uniqueidentifier,
@ModifiedBy varchar(200),
@ModifiedDate datetime,
@StyleSeasonYearID UNIQUEIDENTIFIER 
)
AS 



DECLARE @LinePlanItemID UNIQUEIDENTIFIER 
DECLARE @LinePlanId VARCHAR(50)
DECLARE @LinePlanAttributeItemId1 VARCHAR(50)
DECLARE @LinePlanAttributeItemId2 VARCHAR(50)
DECLARE @LinePlanAttributeItemId3 VARCHAR(50)
DECLARE @LinePlanAttributeItemId4 VARCHAR(50)

DECLARE @Brand NVARCHAR(50)			--Comment #04	--pLinePlanRange.LinePlanAttributeText2
DECLARE @Category NVARCHAR(255)		--Comment #04	--pLinePlanRange.LinePlanAttributeText3





IF @StyleSeasonYearID IS NULL 
BEGIN 
	SELECT TOP 1
		@LinePlanID = pLinePlanItem.LinePlanID,
		@LinePlanAttributeItemID1 = pLinePlanRange.LinePlanAttributeItemID1, 
		@LinePlanAttributeItemID2 = pLinePlanRange.LinePlanAttributeItemID2, 
		@LinePlanAttributeItemID3 = pLinePlanRange.LinePlanAttributeItemID3, 
		@LinePlanAttributeItemID4 = pLinePlanRange.LinePlanAttributeItemID4

		,@Brand = pLinePlanRange.LinePlanAttributeText2			--Comment #04
		,@Category = pLinePlanRange.LinePlanAttributeText3		--Comment #04
	FROM pLinePlanItem INNER JOIN
	  pLinePlanRange ON pLinePlanItem.LinePlanRangeID = pLinePlanRange.LinePlanRangeID
	WHERE pLinePlanItem.StyleID = @StyleID
END
ELSE
BEGIN
	
	SELECT @LinePlanItemID = LinePlanItemID
	FROM pStyleSeasonYear
	WHERE StyleSeasonYearID = @StyleSeasonYearID
		
	SELECT TOP 1
		@LinePlanID = pLinePlanItem.LinePlanID,
		@LinePlanAttributeItemID1 = pLinePlanRange.LinePlanAttributeItemID1, 
		@LinePlanAttributeItemID2 = pLinePlanRange.LinePlanAttributeItemID2, 
		@LinePlanAttributeItemID3 = pLinePlanRange.LinePlanAttributeItemID3, 
		@LinePlanAttributeItemID4 = pLinePlanRange.LinePlanAttributeItemID4

		,@Brand = pLinePlanRange.LinePlanAttributeText2			--Comment #04
		,@Category = pLinePlanRange.LinePlanAttributeText3		--Comment #04
	FROM pLinePlanItem INNER JOIN
	  pLinePlanRange ON pLinePlanItem.LinePlanRangeID = pLinePlanRange.LinePlanRangeID
	WHERE pLinePlanItem.LinePlanItemID = @LinePlanItemID

END 

DECLARE @PL1_NoOfStyle INTEGER
DECLARE @PL1_NoOfFabric INTEGER
DECLARE @PL1_NoOfBody INTEGER 
DECLARE @PL1_NoOfColor INTEGER
DECLARE @PL1_NoOfOptions INTEGER
DECLARE @PL1_MarkupFactor DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetailPriceLow DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetailPriceMed DECIMAL(18, 3)
DECLARE @PL1_TargetAvgRetalPriceHigh DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleLow DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleMed DECIMAL(18, 3)
DECLARE @PL1_NoOfStyleHigh DECIMAL(18, 3)
DECLARE @PL1_TargetAvgWhsPrice DECIMAL(18, 3)
--DECLARE @PL1_AvgTargetFOB DECIMAL(18, 3)
DECLARE @PL1_SalesUnit DECIMAL(18, 3)
DECLARE @PL1_ProjectedWhs DECIMAL(18, 3)
DECLARE @PL1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL1_WeightGrossMarginRtl DECIMAL(18, 3)

SELECT TOP 1 
	@PL1_InitialGrossMarginRtl = LinePlanBusPnCh1
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000010'

SELECT TOP 1 
	@PL1_TargetAvgRetailPriceMed = LinePlanBusPnCh1
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000022'


SELECT TOP 1  
	@PL1_MarkupFactor = LinePlanBusPnCh1 
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000005'


/*
--GET Average Target FOB 
SELECT TOP 1  
	@PL1_AvgTargetFOB = LinePlanBusPnCh1 
FROM pLinePlanBusiness
WHERE (LinePlanAttributeItemID1 = @LinePlanAttributeItemID1) 
	AND (LinePlanAttributeItemID2 = @LinePlanAttributeItemID2) 
	AND (LinePlanAttributeItemID3 = @LinePlanAttributeItemID3)
	AND (LinePlanID = @LinePlanID)
	AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000006'
*/


--SELECT @PL1_InitialGrossMarginRtl, @PL1_TargetAvgRetailPriceMed, @PL1_MarkupFactor

--Calculate Average Target FOB 
--SET @PL1_AvgTargetFOB = (@PL1_TargetAvgRetailPriceMed - (@PL1_TargetAvgRetailPriceMed * @PL1_InitialGrossMarginRtl)) 

--StyleCostingCustomField1 = Target Retail GBP = Manual Input
--StyleCostingCustomField2 = Target First Cost = Average Target FOB
--StyleCostingCustomField3 = Margin Markup = (StyleCostingCustomField1-StyleCostingCustomField2)/StyleCostingCustomField1
--StyleCostingCustomField4 = Units =Manual Input
--StyleCostingCustomField5 = Wholesale Margin = StyleCostingCustomField6-StyleCostingCustomField2/StyleCostingCustomField6
--StyleCostingCustomField6 = Target Wholesale Price = StyleCostingCustomField1/MarkupFactor

DECLARE @StyleCostingCustomField1 DECIMAL(18,3)
DECLARE @StyleCostingCustomField2 DECIMAL(18,3)
DECLARE @StyleCostingCustomField3 DECIMAL(18,3)
DECLARE @StyleCostingCustomField4 DECIMAL(18,3)
DECLARE @StyleCostingCustomField5 DECIMAL(18,3)
DECLARE @StyleCostingCustomField6 DECIMAL(18,3)

DECLARE @PriceBand NVARCHAR(20)						--Comment #04	--pStyleCostingHeader.StyleCostingCustomField35
DECLARE @StyleCostingCustomField7 DECIMAL(18,3)		--Comment #04	--"Target Retail USD"
DECLARE @StyleCostingCustomField8 DECIMAL(18,3)		--Comment #04	--"Target Retail HKD"
DECLARE @StyleCostingCustomField9 DECIMAL(18,3)		--Comment #04	--"Target Retail EUR"
DECLARE @SeasonYearID UNIQUEIDENTIFIER				--Comment #04

--Comment #04
/*Get the custom table values to update the 'pStyleCostingHeader' record with.*/
BEGIN
	/*Get "Price Band" value.*/
	IF @StyleSeasonYearID IS NULL 
		BEGIN
			SELECT TOP 1 @PriceBand = StyleCostingCustomField35
			FROM pStyleCostingHeader
			WHERE StyleID = @StyleID
		END
	ELSE
		BEGIN
			SELECT TOP 1 @PriceBand = StyleCostingCustomField35
			FROM pStyleCostingHeader
			WHERE StyleID = @StyleID
				AND StyleSeasonYearID = @StyleSeasonYearID
		END

	/*Get the 'SeasonYearID'.*/
	SELECT @SeasonYearID = SeasonYearID
	FROM pStyleSeasonYear
	WHERE StyleSeasonYearID = @StyleSeasonYearID

	/*Get the corresponding prices from the custom table based on the "Price Band".*/
	SELECT
		@StyleCostingCustomField1 = GBPS10
		,@StyleCostingCustomField7 = US
		,@StyleCostingCustomField8 = HKD
		,@StyleCostingCustomField9 = EUR
	FROM iCustom20
	WHERE Brand = @Brand
		AND Category = @Category
		AND SeasonYearID = @SeasonYearID
		AND Custom = @PriceBand
END



IF @StyleSeasonYearID IS NULL 
BEGIN 
	SELECT 
	--@StyleCostingCustomField1 = StyleCostingCustomField1, --Targe Retail GBP		--Comment #04
	@StyleCostingCustomField4 = StyleCostingCustomField4 --Sales Unit
	--,@StyleCostingCustomField3 = StyleCostingCustomField3 -- FTM					--Comment #02
	,@StyleCostingCustomField5 = StyleCostingCustomField5	--Wholesale Margin		--Comment #03
	FROM pStyleCostingHeader WHERE StyleID = @StyleID
END
ELSE 
BEGIN
	SELECT 
	--@StyleCostingCustomField1 = StyleCostingCustomField1, --Targe Retail GBP			--Comment #04
	@StyleCostingCustomField4 = StyleCostingCustomField4 --Sales Unit
	--,@StyleCostingCustomField3 = StyleCostingCustomField3 -- FTM  / Margin Markup		--Comment #02
	,@StyleCostingCustomField5 = StyleCostingCustomField5	--Wholesale Margin			--Comment #03
	FROM pStyleCostingHeader 
	WHERE StyleID = @StyleID AND StyleSeasonYearID = @StyleSeasonYearID
END 


--SET @StyleCostingCustomField1 = 0
--SET @StyleCostingCustomField2 = @PL1_AvgTargetFOB

-- =============================================================================================
--Comment #01 (commented out old calculation - new calculation had to be moved lower down)
---- TARGER 1ST COST  =  Targer rtl L - (Targer rtl L * FTM) 
--SET @StyleCostingCustomField2 = @StyleCostingCustomField1 - ( @StyleCostingCustomField1 * @StyleCostingCustomField3)



---*** SET @StyleCostingCustomField3 = CASE WHEN @StyleCostingCustomField1 = 0 THEN 0 ELSE (@StyleCostingCustomField1-@StyleCostingCustomField2)/@StyleCostingCustomField1 END
--SET @StyleCostingCustomField4 = 0
SET @StyleCostingCustomField6 = CASE WHEN @PL1_MarkupFactor = 0 THEN 0 ELSE @StyleCostingCustomField1/@PL1_MarkupFactor END

--Comment #03
--SET @StyleCostingCustomField5 = CASE WHEN @StyleCostingCustomField6 = 0 THEN 0 ELSE (@StyleCostingCustomField6-@StyleCostingCustomField2)/@StyleCostingCustomField6 END



--Comment #01
-- TARGER 1ST COST  =  Target Wholesale Price - (Target Wholesale Price * Wholesale Margin) 
SET @StyleCostingCustomField2 = @StyleCostingCustomField6 - (@StyleCostingCustomField6 * @StyleCostingCustomField5)



--Comment #02
-- FLOW THROUGH MARGIN = (Target Retail GBP - Target First Cost) / Target Retail GBP
SET @StyleCostingCustomField3 = (@StyleCostingCustomField1 - @StyleCostingCustomField2) / @StyleCostingCustomField1




--select @StyleCostingCustomField1 , @PL1_MarkupFactor 

IF @StyleSeasonYearID IS NULL 
BEGIN
	UPDATE pStyleCostingHeader SET 
		StyleCostingCustomField2 = @StyleCostingCustomField2, -- Target FirstCost
		StyleCostingCustomField3 = @StyleCostingCustomField3, -- Flow Through Margin			--Comment #02
		--StyleCostingCustomField5 = @StyleCostingCustomField5, -- WHS Margin					--Comment #03
		StyleCostingCustomField6 = @StyleCostingCustomField6, -- Target WHS Price
		MUser = @ModifiedBy, 
		MDate = @ModifiedDate

		,StyleCostingCustomField1 = @StyleCostingCustomField1		--Comment #04	--"Target Retail GBP"
		,StyleCostingCustomField7 = @StyleCostingCustomField7		--Comment #04	--"Target Retail USD"
		,StyleCostingCustomField8 = @StyleCostingCustomField8		--Comment #04	--"Target Retail HKD"
		,StyleCostingCustomField9 = @StyleCostingCustomField9		--Comment #04	--"Target Retail EUR"
	WHERE StyleId = @StyleId
END
ELSE 
BEGIN
	UPDATE pStyleCostingHeader SET 
		StyleCostingCustomField2 = @StyleCostingCustomField2, -- Target FirstCost
		StyleCostingCustomField3 = @StyleCostingCustomField3, -- Flow Through Margin			--Comment #02
		--StyleCostingCustomField5 = @StyleCostingCustomField5, -- WHS Margin					--Comment #03
		StyleCostingCustomField6 = @StyleCostingCustomField6, -- Target WHS Price
		MUser = @ModifiedBy, 
		MDate = @ModifiedDate

		,StyleCostingCustomField1 = @StyleCostingCustomField1		--Comment #04	--"Target Retail GBP"
		,StyleCostingCustomField7 = @StyleCostingCustomField7		--Comment #04	--"Target Retail USD"
		,StyleCostingCustomField8 = @StyleCostingCustomField8		--Comment #04	--"Target Retail HKD"
		,StyleCostingCustomField9 = @StyleCostingCustomField9		--Comment #04	--"Target Retail EUR"
	WHERE StyleId = @StyleId AND StyleSeasonYearID = @StyleSeasonYearID
END 

-- ====================================================================================================================================
-- MODIFIED BY ARTEMIO
-- ADD LOGIC TO UPDATE STYLE_SOURCING_QUOTE_ITEMS 

CREATE TABLE #tmpQuoteItem  (
ROW_ID INT IDENTITY (1,1),
StyleQuoteItemID UNIQUEIDENTIFIER 
)

IF @StyleSeasonYearID IS NULL 
BEGIN
	INSERT INTO #tmpQuoteItem (StyleQuoteItemID)
	SELECT StyleQuoteItemID 
	FROM pStyleQuoteItem WHERE StyleID = @StyleID
END 
ELSE
BEGIN
	INSERT INTO #tmpQuoteItem (StyleQuoteItemID)
	SELECT a.StyleQuoteItemID 
	FROM pStyleQuoteItem a
	INNER JOIN pStyleSourcing b ON a.StyleSourcingID =  b.StyleSourcingID
	WHERE a.StyleID = @StyleID
	AND b.StyleSeasonYearID = @StyleSeasonYearID
END 

DECLARE @TOTAL INT
DECLARE @ROW_ID INT 
DECLARE @StyleQuoteItemID UNIQUEIDENTIFIER 

SET @ROW_ID = 1 
SELECT @TOTAL  = COUNT(*) FROM #tmpQuoteItem

WHILE  @ROW_ID <= @TOTAL
BEGIN

	SELECT @StyleQuoteItemID = StyleQuoteItemID FROM #tmpQuoteItem WHERE ROW_ID = @ROW_ID
	
	EXEC dbo.spx_StyleSourcingQuoteItemLogic_UPDATE @StyleQuoteItemID

	SET @ROW_ID = @ROW_ID + 1 
	
END 

DROP TABLE  #tmpQuoteItem











/***********************************************
New statements added by Ryan Cabanas on 8/26/08.
************************************************/

--SELECT 1


/************************************************************
Original statements commented out by Ryan Cabanas on 8/26/08.
*************************************************************/

--DECLARE @TargetRetail nvarchar(50),
--@SampleWeight nvarchar(50),
--@TargetMarginPerc nvarchar(50),
--@MiscCost nvarchar(50),
--@RoyalPerc nvarchar(50),
--@ShipDate nvarchar(50),
--@Units nvarchar(50)
--
--	SELECT 
--		@TargetRetail = StyleCostingCustomField1, 
--		@SampleWeight = StyleCostingCustomField2,
--		@TargetMarginPerc = StyleCostingCustomField3, 
--		@MiscCost = StyleCostingCustomField4, 
--		@RoyalPerc = StyleCostingCustomField8, 
--		@ShipDate = StyleCostingCustomField17, 
--		@Units = StyleCostingCustomField18 
--	FROM dbo.pStyleCostingHeader
--	WHERE StyleID = @StyleID
--	  
--
--	UPDATE  dbo.pStyleCosting
--	SET 
--	StyleCostingCustomField1 = @TargetRetail, 
--	StyleCostingCustomField2 = @SampleWeight, 
--	StyleCostingCustomField3 = @TargetMarginPerc, 
--	StyleCostingCustomField4 = @MiscCost, 
--	StyleCostingCustomField8 = @RoyalPerc, 
--	StyleCostingCustomField17 = @ShipDate, 
--	StyleCostingCustomField18 = @Units,
--	MUser = @ModifiedBy,
--	MDate = @ModifiedDate
--	WHERE (StyleID = @StyleID)








GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanStyleDelivery_Logic_UPDATE]'
GO







ALTER PROCEDURE [dbo].[spx_LinePlanStyleDelivery_Logic_UPDATE] (
@StyleID UNIQUEIDENTIFIER, 
@LinePlanID UNIQUEIDENTIFIER, 
@LinePlanItemID UNIQUEIDENTIFIER 
)
AS 


DECLARE @LineplanRangeID UNIQUEIDENTIFIER
DECLARE @LinePlanAttributeItemID1 UNIQUEIDENTIFIER
DECLARE @LinePlanAttributeItemID2 UNIQUEIDENTIFIER 
DECLARE @LinePlanAttributeItemID3 UNIQUEIDENTIFIER 
DECLARE @LinePlanAttributeItemID4 UNIQUEIDENTIFIER
DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER

SELECT @LineplanRangeID = LineplanRangeID FROM pLinePlanItem WHERE LinePlanItemID = @LinePlanItemID

SELECT @LinePlanAttributeItemID1 = LinePlanAttributeItemID1, @LinePlanAttributeItemID2 = LinePlanAttributeItemID2,
@LinePlanAttributeItemID3 = LinePlanAttributeItemID3 , @LinePlanAttributeItemID4 = LinePlanAttributeItemID4
FROM pLinePlanRange 
WHERE LinePlanRangeID = @LinePlanRangeID
AND LinePlanFinancialId = '10000000-0000-0000-0000-000000000004'
AND LinePlanID  = @LinePlanID

SELECT @StyleSeasonYearID = StyleSeasonYearID 
FROM pStyleSeasonYear 
WHERE LinePlanID = @LinePlanID 
AND LinePlanItemID =  @LinePlanItemID
AND StyleID = @StyleID 



SELECT @LinePlanAttributeItemID1, @LinePlanAttributeItemID2 , @LinePlanAttributeItemID3 , @StyleSeasonYearID 


/*******************************************************************************************/
IF @LinePlanAttributeItemID1 IS NOT NULL 
AND @LinePlanAttributeItemID2 IS NOT NULL 
AND @LinePlanAttributeItemID3 IS NOT NULL 
AND @StyleSeasonYearID IS NOT NULL
BEGIN 
/*	
	exec spx_LinePlanBusinessItemLogic_UPDATE 
	@StyleQuoteItemID =  NULL ,
	@StyleID = @StyleID, 
	@LinePlanID = @LinePlanID , 
	@LinePlanRangeID = @LinePlanRangeID, 
	@LinePlanAttributeItemID1 = @LinePlanAttributeItemID1, 
	@LinePlanAttributeItemID2 = @LinePlanAttributeItemID2, 
	@LinePlanAttributeItemID3 = @LinePlanAttributeItemID3, 
	@LinePlanAttributeItemID4 = @LinePlanAttributeItemID4, 
	@StyleSeasonYearID = @StyleSeasonYearID
	
	exec spx_LinePlanBusinessItemRollup_INSERT 
	@LinePlanID = @LinePlanID, 
	@LinePlanAttributeItemID1 = @LinePlanAttributeItemID1, 
	@LinePlanAttributeItemID2 = @LinePlanAttributeItemID2, 
	@LinePlanAttributeItemID3 = @LinePlanAttributeItemID3, 
	@LinePlanAttributeItemID4 = @LinePlanAttributeItemID4, 
	@StyleSeasonYearID = @StyleSeasonYearID
*/
/*
PRINT  'EXEC spx_LinePlanBusinessItem_QUEUE @StyleQuoteItemID = NULL,@StyleID = ''' +  CAST(@StyleID AS NVARCHAR(50)) + ''', ' + 
		'@LinePlanID = ''' + CAST(@LinePlanID AS NVARCHAR(50)) + ''' ,  ' +
		'@LinePlanRangeID = ''' + CAST(@LinePlanRangeID AS NVARCHAR(50))  + ''' ,  ' +
		'@LinePlanAttributeItemID1 = ''' + CAST(@LinePlanAttributeItemID1 AS NVARCHAR(50)) + ''' ,  ' +
		'@LinePlanAttributeItemID2 = ''' + CAST(@LinePlanAttributeItemID2 AS NVARCHAR(50)) + ''' ,  ' +
		'@LinePlanAttributeItemID3 = ''' + CAST(@LinePlanAttributeItemID3 AS NVARCHAR(50)) + ''' ,  ' +
--		'@LinePlanAttributeItemID4 = ''' + CAST(@LinePlanAttributeItemID4 AS NVARCHAR(50)) + ''' ,  ' +
		'@StyleSeasonYearID = ''' + CAST(@StyleSeasonYearID  AS NVARCHAR(50))+ ''' ,  ' +
		'@Cmd  = '''' '
*/

		EXEC spx_LinePlanBusinessItem_QUEUE 
		@StyleQuoteItemID = NULL,
		@StyleID = @StyleID,
		@LinePlanID = @LinePlanID, 
		@LinePlanRangeID = @LinePlanRangeID,
		@LinePlanAttributeItemID1 = @LinePlanAttributeItemID1, 
		@LinePlanAttributeItemID2 = @LinePlanAttributeItemID2,
		@LinePlanAttributeItemID3 = @LinePlanAttributeItemID3,
		@LinePlanAttributeItemID4 = @LinePlanAttributeItemID4,
		@StyleSeasonYearID = @StyleSeasonYearID,
		@Cmd  = ''

END 








GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlan_MoveToHierarchy_Logic_UPDATE]'
GO

CREATE PROCEDURE [dbo].[spx_LinePlan_MoveToHierarchy_Logic_UPDATE](
@StyleID UNIQUEIDENTIFIER, 
@LinePlanRangeID UNIQUEIDENTIFIER, 
@MUser NVARCHAR(200), 
@MDate DATETIME 
)
AS

DECLARE @LinePlanID  UNIQUEIDENTIFIER 
DECLARE @LinePlanItemID UNIQUEIDENTIFIER  
DECLARE @OldLinePlanItemID UNIQUEIDENTIFIER   
DECLARE @OldLinePlanID UNIQUEIDENTIFIER   
DECLARE @LinePlanTemplateID UNIQUEIDENTIFIER   

DECLARE @OldLinePlanAttributeItemId1 NVARCHAR(50)
DECLARE @OldLinePlanAttributeItemId2 NVARCHAR(50)
DECLARE @OldLinePlanAttributeItemId3 NVARCHAR(50)


IF ( SELECT COUNT(*) FROM pStyleSeasonYear WHERE StyleID = @StyleID )= 1 
BEGIN 
	
	/***
	** Get the old LineplanItem 
	***/
	SELECT @OldLinePlanID= a.LinePlanID, @OldLinePlanItemID  = a.LinePlanItemID, 
	@OldLinePlanAttributeItemId1 = c.LinePlanAttributeItemId1, @OldLinePlanAttributeItemId2 = c.LinePlanAttributeItemId2, 
	@OldLinePlanAttributeItemId3 = c.LinePlanAttributeItemId3
	FROM pStyleSeasonYear a
	INNER JOIN pLinePlanItem b ON a.LinePlanItemID =  b.LinePlanItemID 
	INNER JOIN pLinePlanRange c ON b.LinePlanRangeID = c.LinePlanRangeID 
	WHERE a.StyleID = @StyleID 
		

	IF @OldLinePlanItemID  IS NOT NULL
	BEGIN
	
		/***
		** Get new lineplan item / category 
		***/
		SELECT TOP 1 @LinePlanItemID = a.LinePlanItemID, @LinePlanID = a.LinePlanID,
		@LinePlanTemplateID = LinePlanTemplateID
		FROM pLinePlanItem a
		INNER JOIN pLinePlan b ON a.LinePlanID = b.LinePlanID 
		WHERE a.LinePlanRangeID = @LinePlanRangeID
		AND a.StyleID = '00000000-0000-0000-0000-000000000000'
		AND a.LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003' 
		
		
		
		IF @LinePlanItemID  IS NOT NULL
		BEGIN

			
			/***
			** Update old lineplanitem 
			***/
			UPDATE pLinePlanItem Set StyleID = '00000000-0000-0000-0000-000000000000',
			MUser = @MUser, MDate =  @MDate 
			WHERE LinePlanItemID = @OldLinePlanItemID
			
			
			DELETE FROM pLineplanBusinessItem WHERE StyleID = @StyleID
			DELETE FROM pLinePlanShowroomStyle WHERE StyleID = @StyleID
			DELETE FROM pLinePlanShowroomStyleColor WHERE StyleID = @StyleID
			
			EXEC spx_LinePlanBusinessItemRollup_INSERT @LinePlanId = @OldLinePlanId,
			@LinePlanAttributeItemId1 = @OldLinePlanAttributeItemId1,
			@LinePlanAttributeItemId2 = @OldLinePlanAttributeItemId2,
			@LinePlanAttributeItemId3 = @OldLinePlanAttributeItemId3,
			@LinePlanAttributeItemId4 = '',
			@Cmd = '',
			@StyleSeasonYearID  = NULL 
				

			--***
			--** Update New lineplanitem 
			--***
			UPDATE pLinePlanItem Set StyleID = @StyleID,
			MUser = @MUser, MDate =  @MDate 
			WHERE LinePlanItemID = @LinePlanItemID
		

			--***
			--** Update StyleSeasonYear
			--***
			UPDATE pStyleSeasonYear SET 
			LinePlanItemID = @LinePlanItemID, LinePlanID = @LinePlanID,
			MUser = @MUser, MDate =  @MDate 
			WHERE StyleID = @StyleID
										
			
			--***
			--** Update StyleHeader 
			--***
			IF @LinePlanTemplateID  = '70000000-0000-0000-0000-000000000001'
			BEGIN 
			
				DECLARE @CustomField2 NVARCHAR(200)
				DECLARE @StyleType INT
				DECLARE @StyleCategory UNIQUEIDENTIFIER 
				
				SELECT 
				@CustomField2  = a.LinePlanAttributeText1, 
				@StyleType = b.LinePlanAttributeValue,
				@StyleCategory= c.LinePlanAttributeValue
				FROM pLinePlanRange a
				INNER JOIN pLinePlanAttributeItem b ON a.LinePlanAttributeItemID2 = b.LinePlanAttributeItemID
				INNER JOIN pLinePlanAttributeItem c ON a.LinePlanAttributeItemID3 = c.LinePlanAttributeItemID
				WHERE LinePlanRangeID = @LinePlanRangeID
				
				
--				--***
--				--** Get the Brand
--				--***
--				DECLARE @Brand NVARCHAR(200) 
--				
--				SELECT @Brand = c.Custom
--				FROM pStyleType b 
--				INNER JOIN aCustom3 c ON c.CustomKey = b.BrandID 
--				WHERE b.StyleTypeID = @StyleType
--				
--				
--				IF @Brand IS NULL
--					SET @Brand  = ''
--				
--				UPDATE pStyleHeader SET 
--				CustomField2 = @CustomField2, StyleType = @StyleType, StyleCategory = @StyleCategory,
--				MUser = @MUser, MDate =  @MDate,
--				CustomField3 = @Brand, CustomField4 = ''
--				WHERE StyleID = @StyleID 
		
					
			END 

					
			/***
			** Insert financial Info 
			***/
			EXEC spx_LinePlanBusinessItemNew_INSERT @StyleID = @StyleID, @LinePlanItemID = @LinePlanItemID
			EXEC spx_LinePlanStyleDelivery_Logic_UPDATE @StyleID = @StyleID, @LinePlanID = @LinePlanID, @LinePlanItemID = @LinePlanItemID
			

		END 
		
	END 

END 
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleNewCopySizeClass_INSERT]'
GO
SET QUOTED_IDENTIFIER OFF
GO
/*

Comments:



#01 - Ryan Cabanas - August 12, 2009

	When PI copies a Style, the 'pStyleCostingHeader' and 'pStyleCosting' records are copied

too.  They wanted this.  The problem is that the procedure below 'spx_StyleCostingCopy_INSERT'

does not include the 'StyleSeasonYearID' when it adds the records.  And because this procedure

runs before a new 'pStyleSeasonYear.StyleSeasonYearID' is even created for this new Style, here

at this procedure we're going to have to create that 'pStyleSeasonYear.StyleSeasonYearID' and

then do an UPDATE here to the 'pStyleCostingHeader' and 'pStyleCosting' records that have been

created (without a 'StyleSeasonYearID') by the 'spx_StyleCostingCopy_INSERT' procedure below.

	Because the 'pStyleHeader' Season and Year fields are customized for each client, this will

need to be customized for each client, as well.

	Also, I think that this method will only work for clients that are not using true seasonality.

This only works if they are using one StyleID per Season/Year.

*/





ALTER PROCEDURE [dbo].[spx_StyleNewCopySizeClass_INSERT](

@StyleID UNIQUEIDENTIFIER, 

@NewStyleID UNIQUEIDENTIFIER, 

@CreatedDate DATETIME, 

@CreatedBy NVARCHAR(200),

@AddComments INT,

@SqlStyleHeaderUpdate VARCHAR(4000), 

@LinePlanItemID NVARCHAR(50) 

)

AS









BEGIN



	DECLARE @SketchID UNIQUEIDENTIFIER

	DECLARE @SketchVersion INT 



	SELECT @SketchID = DesignSketchID, @SketchVersion = DesignSketchVersion

	FROM  pStyleHeader WHERE StyleID = @StyleID





	EXEC dbo.spx_StyleHeaderCopy_INSERT @StyleID=@StyleID, @NewStyleID=@NewStyleID, @DesignSketchID=@SketchID,  

		@DesignSketchVersion=@SketchVersion, @StyleVariation=@SketchVersion, @CreatedBy=@CreatedBy,  @CreatedDate=@CreatedDate

	

	EXEC(@SqlStyleHeaderUpdate)



	EXEC dbo.spx_StyleWorkflowScheaduleCopy_UPDATE @StyleID=@StyleID, @NewStyleID=@NewStyleID , @CreatedBy=@CreatedBy, @CreatedDate=@CreatedDate

	EXEC dbo.spx_StyleSizeClassRangeVariation_UPDATE @StyleID=@StyleID, @NewStyleID=@NewStyleID , @CreatedBy=@CreatedBy, @CreatedDate=@CreatedDate

	EXEC spx_StyleDetailGridCopy_INSERT @StyleID=@StyleID, @NewStyleID=@NewStyleID , @CreatedBy=@CreatedBy,  @CreatedDate=@CreatedDate

	EXEC spx_StyleDetailVariation_INSERT @StyleID=@StyleID, @NewStyleID=@NewStyleID , @CreatedBy=@CreatedBy,  @CreatedDate=@CreatedDate

	EXEC spx_StyleMaterialVariation_INSERT @StyleID=@StyleID, @NewStyleID=@NewStyleID , @CreatedBy=@CreatedBy,  @CreatedDate=@CreatedDate, @ColorsSelected = 1

	EXEC spx_StyleCareCopy_INSERT @StyleID=@StyleID, @NewStyleID=@NewStyleID , @CreatedBy=@CreatedBy,  @CreatedDate=@CreatedDate

	EXEC spx_StyleCostingCopy_INSERT @StyleID=@StyleID, @NewStyleID=@NewStyleID , @CreatedBy=@CreatedBy,  @CreatedDate=@CreatedDate

	EXEC spx_StyleQuoteCopy_INSERT @StyleID=@StyleID, @NewStyleID=@NewStyleID , @CreatedBy=@CreatedBy,  @CreatedDate=@CreatedDate

	EXEC spx_StyleDevelopmentSpecVariation_INSERT @StyleID=@StyleID, @NewStyleID=@NewStyleID , @CreatedBy=@CreatedBy,  @CreatedDate=@CreatedDate





END







--Comment #01

BEGIN

	/*Declare variables.*/

	DECLARE @Season nvarchar(200)

	DECLARE @Year nvarchar(200)

	DECLARE @StyleSeasonYearID uniqueidentifier



	/*Get header information.*/

	SELECT

		@Season = CustomField5

		,@Year = CustomField6

	FROM pStyleHeader

	WHERE StyleID = @NewStyleID



	/*Get 'StyleSeasonYearID'.*/

	SELECT TOP 1 @StyleSeasonYearID = StyleSeasonYearID

	FROM pStyleSeasonYear

	WHERE StyleID = @NewStyleID

		AND StyleSeason = @Season

		AND StyleYear = @Year

	

	/****************************************************************/

	/*Update 'pStyleCostingHeader' records if there and necessary.	*/

	/****************************************************************/

	BEGIN

		IF(SELECT COUNT(*) FROM pStyleCostingHeader WITH (NOLOCK) WHERE StyleID = @NewStyleID AND (StyleSeasonYearID IS NULL OR StyleSeasonYearID <> @StyleSeasonYearID)) = 1

			BEGIN

				UPDATE pStyleCostingHeader

				SET StyleSeasonYearID = @StyleSeasonYearID

				WHERE StyleID = @NewStyleID

			END

	END



	/************************************************************/

	/*Update 'pStyleCosting' records if there and necessary.	*/

	/************************************************************/

	BEGIN

		/*Declare variables.*/

		DECLARE @TotalCount int

		DECLARE @RowCounter int

		DECLARE @StyleCostingID uniqueidentifier



		/*Create temp table.*/

		CREATE TABLE #tempStyleCosting(

			TableRow int identity(1,1)

			,StyleCostingID uniqueidentifier)



		/*Get 'pStyleCosting' records.*/

		INSERT INTO #tempStyleCosting(StyleCostingID)

		SELECT StyleCostingID

		FROM pStyleCosting

		WHERE StyleID = @NewStyleID

			AND	(StyleSeasonYearID IS NULL

				OR StyleSeasonYearID <> @StyleSeasonYearID)



		/*Get/set counts.*/

		SELECT @TotalCount = COUNT(*) FROM #tempStyleCosting

		SET @RowCounter = 1



		/*Loop.*/

		WHILE(@RowCounter <= @TotalCount)

			BEGIN

				/*Clear variable.*/

				SET @StyleCostingID = NULL



				/*Get values.*/

				SELECT @StyleCostingID = StyleCostingID

				FROM #tempStyleCosting

				WHERE TableRow = @RowCounter



				/*Update 'pStyleCosting' record.*/

				UPDATE pStyleCosting

				SET StyleSeasonYearID = @StyleSeasonYearID

				WHERE StyleCostingID = @StyleCostingID



				/*Up counter.*/

				SET @RowCounter = @RowCounter + 1

			END



		/*Drop temp table.*/

		DROP TABLE #tempStyleCosting

	END

END

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleNewCopySizeClass_UPDATE]'
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[spx_StyleNewCopySizeClass_UPDATE] (
@StyleID UNIQUEIDENTIFIER, 
@NewStyleID UNIQUEIDENTIFIER, 
@NewStyleDevelopmentID UNIQUEIDENTIFIER, 
@CreatedDate DATETIME, 
@CreatedBy NVARCHAR(200),
@LinkImage INT, 
@CarryOver INT, 

@StyleTempID NVARCHAR(20),
@StyleTempNo NVARCHAR(20),
@StyleNo NVARCHAR(20),

@DevelopmentTempID NVARCHAR(20),
@DevelopmentTempNo NVARCHAR(20),
@DevelopmentNo NVARCHAR(20) ,
@DesignSketchID UNIQUEIDENTIFIER
)
AS
BEGIN


DECLARE @tmpStyleNo NVARCHAR(20), 
@tmpStyleTempID NVARCHAR(20),
@tmpStyleTempNo NVARCHAR(20), 
@tmpNewStyleID UNIQUEIDENTIFIER 


SET @tmpStyleNo = @StyleNo
SET	@tmpStyleTempID =  @StyleTempID
SET @tmpStyleTempNo = @StyleTempNo
SET @tmpNewStyleID = @NewStyleID
 		

	DECLARE @StyleType AS NVARCHAR(5)
	DECLARE @SizeRange AS NVARCHAR(100)
	
	SELECT @StyleType = b.StyleType, @SizeRange = a.SizeRange
	FROM  pStyleHeader a INNER JOIN pStyleType b ON a.StyleType = b.StyleTypeID 
	WHERE a.StyleID = @StyleID 


	IF @StyleType = 'V' 
	BEGIN 
		EXEC dbo.spx_StyleDevelopmentCopy_INSERT  @StyleDevelopmentID = @NewStyleDevelopmentID , 
			@StyleID = @NewStyleID,  @TempID = @DevelopmentTempID , @TempNo = @DevelopmentTempNo,
			@StyleDevelopmentNo = @DevelopmentNo, 
			@SizeRange = @SizeRange ,  @CreatedBy = @CreatedBy , @CreatedDate = @CreatedDate


		EXEC dbo.spx_StyleDevelopmentItemCopy_INSERT  @StyleDevelopmentID = @NewStyleDevelopmentID, 
			@StyleID = @NewStyleID ,  
			@TempID = @DevelopmentTempID , @TempNo = @DevelopmentTempNo,
			@StyleDevelopmentNo = @DevelopmentNo,
			@SizeRange = @SizeRange ,  @CreatedBy = @CreatedBy , @CreatedDate = @CreatedDate

	END
	ELSE
	BEGIN

		EXEC dbo.spx_StyleDevelopmentNew_INSERT @StyleDevelopmentID = @NewStyleDevelopmentID , 
			@StyleID = @NewStyleID, @TempID = @DevelopmentTempID , @TempNo = @DevelopmentTempNo, 
			@StyleDevelopmentNo = @DevelopmentNo, 
			@SizeRange = @SizeRange ,  @CreatedBy = @CreatedBy , @CreatedDate = @CreatedDate
	END 


/*

	EXEC dbo.spx_StyleDevelopmentNew_INSERT @StyleDevelopmentID = @NewStyleDevelopmentID , 
			@StyleID = @NewStyleID, @TempID = @DevelopmentTempID , @TempNo = @DevelopmentTempNo, 
			@StyleDevelopmentNo = @DevelopmentNo, 
			@SizeRange = @SizeRange ,  @CreatedBy = @CreatedBy , @CreatedDate = @CreatedDate
*/



/*
-- Removed from store procedure to execute
-- It will run at end of the page runtime right after all the records
-- have been created.  
-- DP 7/14/2009 

	IF @CarryOver  = 0 
	BEGIN			
		EXEC dbo.spx_StyleHeaderNoLogic_UPDATE  @StyleNo = @StyleNo , @TempId = @StyleTempID, @TempNo  = @StyleTempNo, @StyleId = @NewStyleID
	END
	ELSE	
	BEGIN

			DECLARE @oStyleNo NVARCHAR(20)
			DECLARE @oTempId NVARCHAR(20)
			DECLARE @oTempNo NVARCHAR(20)
			
			SELECT @oStyleNo = StyleNo, @oTempId = TempId, @oTempNo = TempNo
			FROM pStyleHeader	
			WHERE StyleID = @StyleID

			UPDATE pStyleHeader SET StyleNo = @oStyleNo,  TempId = @oTempId,  TempNo = @oTempNo
			WHERE StyleID = @NewStyleID

	END 
*/
	
	IF @LinkImage = 0 
	BEGIN

		UPDATE pStyleHeader SET DesignSketchID = @DesignSketchID , DesignSketchVersion = 1 
		WHERE StyleID = @NewStyleID
	END 
	ELSE
	BEGIN
		-- LINK STYLE DESIGN DETAIL IMAGES

		DECLARE @StyleSet INT 

		SELECT @StyleSet  = StyleSet 
		FROM pStyleHeader 
		WHERE StyleID = @NewStyleID

		IF @StyleSet IS NULL
			SET @StyleSet = 1 

		INSERT INTO pStyleImageItem  ( StyleImageItemID, StyleImageItemMasterID, WorkflowID , StyleID , StyleSet, ImageID, 
		ImageVersion, CUser, CDate, MUser, MDate, StyleImageLinked, Sort )   		
		SELECT NEWID() as StyleImageItemID , NEWID() as StyleImageItemMasterID, WorkflowID , @NewStyleID AS StyleID , StyleSet, 
		ImageID, ImageVersion, @CreatedBy AS CUser, @CreatedDate AS CDate, @CreatedBy AS MUser, @CreatedDate AS MDate, StyleImageLinked, Sort 
		FROM pStyleImageItem 
		WHERE StyleID = @StyleID AND StyleSet <= @StyleSet
		AND WorkflowID = '40000000-0000-0000-0000-000000000006' 

	END 


	--EXEC spx_StyleImageItemVariation_SELECT @StyleId = @NewStyleID
	--EXEC spx_StyleImageItemMasterId_UPDATE @StyleId = @NewStyleID
	--EXEC spx_StyleMaterialMasterId_UPDATE @StyleId = @NewStyleID
	--EXEC spx_StyleHeaderLogic_UPDATE @StyleId = @NewStyleID

	-- Update SAPcode 
	IF @CarryOver = 0
	BEGIN
		UPDATE pStyleColorway SET SAPCode  =  NULL
		WHERE StyleID  = @NewStyleID

		-- Added by AG 20090827
		UPDATE pStyleHeader SET 
		StyleNo = @tmpStyleNo,
		TempId = @tmpStyleTempID, 
		TempNo = @tmpStyleTempNo
		WHERE StyleID = @tmpNewStyleID
	END 


	-- Update PLMCode 
	EXEC spx_StyleColorway_PLMCode_UPDATE @NewStyleID, 0



END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleSizeClassNew_LinePlan_INSERT]'
GO

CREATE PROCEDURE [dbo].[spx_StyleSizeClassNew_LinePlan_INSERT](
@StyleID UNIQUEIDENTIFIER, 
@StyleCopyFromID  UNIQUEIDENTIFIER, 
@SeasonYearID UNIQUEIDENTIFIER,
@CUser NVARCHAR(200), 
@CDate DATETIME 
)
AS 

DECLARE @NewLinePlanItemID UNIQUEIDENTIFIER 
DECLARE @LinePlanID UNIQUEIDENTIFIER 
DECLARE @LinePlanItemID UNIQUEIDENTIFIER 
DECLARE @LinePlanRangeTypeID UNIQUEIDENTIFIER 
DECLARE @LinePlanRangeID UNIQUEIDENTIFIER 


SELECT @LinePlanID  = a.LinePlanID, @LinePlanItemID  = a.LinePlanItemID, 
@LinePlanRangeTypeID = b.LinePlanRangeTypeID, @LinePlanRangeID  = b.LinePlanRangeID 
FROM pStyleSeasonYear a
INNER JOIN pLinePlanItem b ON a.LinePlanItemID = b.LinePlanItemID 
WHERE a.StyleID =  @StyleCopyFromID 
AND a.SeasonYearID = @SeasonYearID 

IF @LinePlanItemID IS NOT NULL
BEGIN

	/***
	** insert style into lineplan 
	***/
	SELECT TOP 1  @NewLinePlanItemID =  LinePlanItemID 
	FROM pLinePlanItem 
	WHERE LinePlanRangeID = @LinePlanRangeID
	AND LinePlanRangeTypeID = @LinePlanRangeTypeID
	AND StyleID =  '00000000-0000-0000-0000-000000000000'
	
	--SELECT @NewLinePlanItemID as NewLinePlanItemID 
	
	IF  @NewLinePlanItemID  IS NOT NULL
	BEGIN
	
			--/***
			--** No items available, create a new record 
			--***/
			--SET @NewLinePlanItemID  = NEWID()
			--INSERT INTO pLinePlanItem ( LinePlanItemID , LinePlanRangeID , LinePlanRangeTypeID, LinePlanID, StyleID , CUser, CDate, MUser, MDate )
			--VALUES  (@NewLinePlanItemID, @LinePlanRangeID, @LinePlanRangeTypeID, @LinePlanID, @StyleID , @CUser, @CDate, @CUser, @CDate) 

		UPDATE pLinePlanItem Set StyleID = @StyleID WHERE LinePlanItemID =  @NewLinePlanItemID 
	
		
		/***
		** Check StyleSeasonYear
		***/
		DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER 
		SELECT @StyleSeasonYearID = StyleSeasonYearID 
		FROM pStyleSeasonYear 
		WHERE StyleID = @StyleID AND SeasonYearID = @SeasonYearID
		
		DECLARE @Season NVARCHAR(200)
		DECLARE @Year NVARCHAR(200)
		SELECT @Season = Season , @Year =  Year FROM  pSeasonYear WHERE SeasonYearID = @SeasonYearID 
		 
		IF @StyleSeasonYearID IS NULL 
		BEGIN
			SET @StyleSeasonYearID =  NEWID()
			INSERT INTO pStyleSeasonYear  ( StyleSeasonyearID , StyleID , StyleSeason, StyleYear, CUser, CDate, MUser, MDate, 
			SeasonYearID, LinePlanID, LinePlanItemID )
			VALUES (@StyleSeasonYearID, @StyleID , @Season, @Year,  @CUser, @CDate, @CUser, @CDate, 
			@SeasonYearID, @LinePlanID, @NewLinePlanItemID )
		END 
		ELSE 
		BEGIN
			UPDATE pStyleSeasonyear SET StyleSeason = @Season, StyleYear = @Year, MUser =@CUser, MDate = @CDate,
			LinePlanID = @LinePlanID, LinePlanItemID = @NewLinePlanItemID 
			WHERE StyleSeasonYearID = @StyleSeasonYearID 
		END 
	
	

		/***
		** Insert financial Info 
		***/
		EXEC spx_LinePlanBusinessItemNew_INSERT @StyleID = @StyleID, @LinePlanItemID = @NewLinePlanItemID
		EXEC spx_LinePlanStyleDelivery_Logic_UPDATE @StyleID = @StyleID, @LinePlanID = @LinePlanID, @LinePlanItemID = @NewLinePlanItemID
		
	END --@NewLinePlanItemID IS NOT NULL
	
END  --@LinePlanItemID







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Group_AccessUserPermissions_UPDATE]'
GO
SET QUOTED_IDENTIFIER OFF
GO


ALTER PROCEDURE [dbo].[spx_Group_AccessUserPermissions_UPDATE] (
@GroupID uniqueidentifier ,
@FullName as nvarchar (200) ,
@CDate  as DateTime
)
AS

DECLARE @TeamID uniqueidentifier
DECLARE @DeskFolderID INT

SET NOCOUNT ON

-- GET USERS IN THE GROUP 

DECLARE cursor_users CURSOR FOR	
SELECT TeamID FROM uUserGroup  WHERE GroupID = @GroupID



OPEN cursor_users

FETCH NEXT FROM cursor_users INTO @TeamID

WHILE @@FETCH_STATUS = 0 
BEGIN
	--SELECT USUARIO = @TeamID


	/********************************************************************************************************************************************************************/
	-- STYLE FOLDER
	DELETE FROM sAccessStyleFolder where TeamID = @TeamID

	INSERT INTO sAccessStyleFolder (StyleTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessRemove, AccessDelete , AccessPrint ,TeamId, CUser, CDate, MUser, MDate   )
	SELECT  StyleTypeId , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessRemove ) AS AccessRemove, MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId ,
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupStyleFolder 
	WHERE GroupID IN ( 
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 2 
	) 
	GROUP BY StyleTypeId  


	SET @DeskFolderID  =  2
	IF ( SELECT count(*) FROM sAccessStyleFolder WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )
	END
	ELSE

		DELETE FROM  cDeskUserFolderAccess WHERE TeamID =@TeamID and DeskFolderId = @DeskFolderId 
		
	


	/********************************************************************************************************************************************************************/
	-- LINE FOLDER
	DELETE FROM sAccessLineFolder where TeamID = @TeamID
	
	INSERT INTO sAccessLineFolder (LineTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
	SELECT  1 as LineTypeId , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupLineFolder 
	WHERE GroupID IN (
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 3
	) 
	GROUP BY LineTypeId

	IF ( SELECT count(*) FROM sAccessLineFolder WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		SET @DeskFolderID  =  3
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

	END 


	/********************************************************************************************************************************************************************/
	-- QUOTATION FOLDER
	DELETE FROM sAccessQuotationFolder  where TeamID = @TeamID
	
	INSERT INTO sAccessQuotationFolder (StyleTypeID,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
	SELECT  StyleTypeID , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupQuotationFolder 
	WHERE GroupID IN ( 
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 4 
	) 
	GROUP BY StyleTypeID

	IF ( SELECT count(*) FROM sAccessQuotationFolder  WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		SET @DeskFolderID  =  4
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

	END 


	/********************************************************************************************************************************************************************/
	-- SAMPLE FOLDER
	DELETE FROM sAccessSampleFolder  where TeamID = @TeamID
	
	INSERT INTO sAccessSampleFolder (SampleTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify , AccessRemove,  AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
	SELECT  SampleTypeId  , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessRemove ) AS AccessRemove , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupSampleFolder 
	WHERE GroupID IN ( 
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 5 
	) 
	GROUP BY SampleTypeId

	IF ( SELECT count(*) FROM sAccessSampleFolder WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		SET @DeskFolderID  =  5
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

	END 


	/********************************************************************************************************************************************************************/
	-- IMAGE FOLDER
	DELETE FROM sAccessImageFolder  where TeamID = @TeamID
	
	INSERT INTO sAccessImageFolder (ImageTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
	SELECT  ImageTypeId , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupImageFolder 
	WHERE GroupID IN ( 
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 6 
	) 
	GROUP BY ImageTypeId


	IF ( SELECT count(*) FROM sAccessImageFolder  WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		SET @DeskFolderID  =  6
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

	END 

	/********************************************************************************************************************************************************************/
	-- COLOR FOLDER
	DELETE FROM sAccessColorFolder WHERE TeamID = @TeamID
	
	INSERT INTO sAccessColorFolder (ColorTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
	SELECT  ColorTypeId  , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupColorFolder 
	WHERE GroupID IN ( 
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 7 	
	) 
	GROUP BY ColorTypeId


	IF ( SELECT count(*) FROM sAccessColorFolder  WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		SET @DeskFolderID  =  7
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

	END 

	/********************************************************************************************************************************************************************/
	-- MATERIAL FOLDER
	DELETE FROM sAccessMaterialFolder WHERE TeamID = @TeamID
	
	INSERT INTO sAccessMaterialFolder (ComponentTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
	SELECT  ComponentTypeId  , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupMaterialFolder 
	WHERE GroupID IN ( 
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 8 
	) 
	GROUP BY ComponentTypeId

	IF ( SELECT count(*) FROM sAccessMaterialFolder  WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		SET @DeskFolderID  =  8
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

	END 


	/********************************************************************************************************************************************************************/
	-- COMPLIANCE FOLDER
	DELETE FROM sAccessComplianceFolder WHERE TeamID = @TeamID
	
	INSERT INTO sAccessComplianceFolder (ComplianceTypeId ,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
	SELECT  ComplianceTypeId  , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupComplianceFolder 
	WHERE GroupID IN ( 
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 9 
	) 
	GROUP BY ComplianceTypeId


	IF ( SELECT count(*) FROM sAccessComplianceFolder  WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		SET @DeskFolderID  =  9
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

	END 

	/********************************************************************************************************************************************************************/
	-- CONTROL PANEL  FOLDER
	DELETE FROM sAccessControlPanel WHERE TeamID = @TeamID
	
	INSERT INTO sAccessControlPanel (ControlPanelId ,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
	SELECT  ControlPanelId  , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupControlPanel
	WHERE GroupID IN ( 
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 10 
	) 
	GROUP BY ControlPanelId

	IF ( SELECT count(*) FROM sAccessControlPanel  WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		SET @DeskFolderID  =  10
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

	END 






	/********************************************************************************************************************************************************************/
	-- SHARE FOLDER
	DELETE FROM sAccessShareFolder WHERE TeamID = @TeamID
	
	INSERT INTO sAccessShareFolder ( ShareTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId , CUser, CDate, MUser, MDate   )
	SELECT  1 as ShareTypeId  , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId  ,  
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupShareFolder 
	WHERE GroupID IN ( 
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 11 
	) 
	GROUP BY ShareTypeId

	IF ( SELECT count(*) FROM sAccessShareFolder  WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		SET @DeskFolderID  =  11
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )

	END 




	/********************************************************************************************************************************************************************/
	-- COSTING 
	DELETE FROM sAccessCosting where TeamID = @TeamID

	INSERT INTO sAccessCosting (StyleTypeId,  AccessRoleId , AccessView, AccessCreate, AccessModify ,   AccessDelete , AccessPrint ,TeamId, CUser, CDate, MUser, MDate   )
	SELECT  StyleTypeId , MAX ( AccessRoleID ) AS  AccessRoleId  , MAX ( AccessView ) AS  AccessView ,  MAX ( AccessCreate )  AS AccessCreate , 
	MAX ( AccessModify )  AS AccessModify  , MAX ( AccessDelete ) AS AccessDelete , MAX ( AccessPrint )  AS AccessPrint  , @TeamID as TeamId ,
	@FullName as CUser, @CDate as CDate , @FullName as MUser , @CDate as MDate
	FROM sAccessGroupCosting 
	WHERE GroupID IN ( 
		SELECT  a.GroupID 
		FROM uUserGroup a, uGroup b , cDeskGroupFolderAccess c
		WHERE a.GroupID = b.GroupID  AND b.Active =1 AND a.TeamID = @TeamID 
		AND c.GroupID = b.GroupID  AND DeskAccessId = 1  AND c.DeskFolderID = 2 
	) 
	GROUP BY StyleTypeId  


	SET @DeskFolderID  =  12
	IF ( SELECT count(*) FROM sAccessCosting  WHERE TeamId = @TeamID ) > 0  
	BEGIN 
		IF ( SELECT Count(*) FROM cDeskUserFolderAccess   WHERE TeamID = @TeamID AND DeskFolderID = @DeskFolderID ) > 0 
			UPDATE cDeskUserFolderAccess  SET DeskAccessId= 1,  MUser = @FullName, MDate = @CDate WHERE  TeamID = @TeamID  AND DeskFolderID = @DeskFolderID  
		ELSE 
			INSERT INTO cDeskUserFolderAccess   ( DeskUserAccessID , DeskFolderId, DeskAccessID , TeamID , CUser, CDate, MUser, MDate )
			VALUES ( NEWID() , @DeskFolderID,  1,  @TeamID ,  @FullName, @CDate, @FullName, @CDate )
	END
	ELSE

		DELETE FROM  cDeskUserFolderAccess WHERE TeamID =@TeamID and DeskFolderId = @DeskFolderId 
		
	


	
	FETCH NEXT FROM cursor_users INTO @TeamID
END 


CLOSE cursor_users
DEALLOCATE cursor_users


--***
--** Update LinePlan Permissions
--***
EXEC spx_Group_AccessFolderUserPermissions_UPDATE @GroupID = @GroupID, @FullName = @FullName,
@CDate  = @CDate, @FolderName = 'LINEPLAN'



/****************************************************************************************************************************************************************************************************************************************/
-- CHECK FOR USER WITHOUT A GROUP 
DECLARE cursor_users2 CURSOR FOR	
SELECT  TeamID from Users  WHERE TeamID not in (  select  DISTINCT TeamID  from uUserGroup ) 


OPEN cursor_users2
FETCH NEXT FROM cursor_users2 INTO @TeamID

WHILE @@FETCH_STATUS = 0 
BEGIN
	
	DELETE FROM sAccessStyleFolder where TeamID = @TeamID
	DELETE FROM sAccessLineFolder where TeamID = @TeamID
	DELETE FROM sAccessQuotationFolder  where TeamID = @TeamID
	DELETE FROM sAccessSampleFolder  where TeamID = @TeamID
	DELETE FROM sAccessImageFolder  where TeamID = @TeamID
	DELETE FROM sAccessColorFolder WHERE TeamID = @TeamID
	DELETE FROM sAccessMaterialFolder WHERE TeamID = @TeamID
	DELETE FROM sAccessComplianceFolder WHERE TeamID = @TeamID
	DELETE FROM sAccessControlPanel WHERE TeamID = @TeamID
	DELETE FROM sAccessShareFolder WHERE TeamID = @TeamID
	DELETE FROM sAccessCosting WHERE TeamID = @TeamID 
	DELETE FROM sAccessLinePlanFolder WHERE TeamID = @TeamID 

	FETCH NEXT FROM cursor_users2 INTO @TeamID

END 

CLOSE cursor_users2
DEALLOCATE cursor_users2


SET NOCOUNT OFF

GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleSourcingQuoteItemCopyColors_UPDATE_QUEUE]'
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[spx_StyleSourcingQuoteItemCopyColors_UPDATE_QUEUE]
(
@StyleSourcingID UNIQUEIDENTIFIER ,
@StyleQuoteItemID UNIQUEIDENTIFIER
)
AS 
BEGIN 

	DECLARE @DUMMY INT
	

	DECLARE @StyleQuoteItemCustomField4 NVARCHAR(200)
	DECLARE @StyleQuoteItemCustomField5 NVARCHAR(200)
	DECLARE @StyleQuoteItemCustomField6 NVARCHAR(200)
	DECLARE @StyleQuoteItemCustomField7 UNIQUEIDENTIFIER
	DECLARE @StyleQuoteItemCustomField8 MONEY 
	DECLARE @StyleQuoteItemCustomField24 NVARCHAR(200)
	DECLARE @StyleQuoteItemStatusID INT 

	SELECT  @StyleQuoteItemCustomField4 = StyleQuoteItemCustomField4, @StyleQuoteItemCustomField5 = StyleQuoteItemCustomField5, 
	@StyleQuoteItemCustomField6 = StyleQuoteItemCustomField6, @StyleQuoteItemCustomField7 = StyleQuoteItemCustomField7 , 
	@StyleQuoteItemCustomField8 = StyleQuoteItemCustomField8,
	@StyleQuoteItemCustomField24 = StyleQuoteItemCustomField24,
	@StyleQuoteItemStatusID = StyleQuoteItemStatusID
	FROM pStyleQuoteItem 
	WHERE StyleQuoteItemID = @StyleQuoteItemID


	--select *from pStyleQuoteItem


	CREATE TABLE #StyleQuoteItem (
		ROW_ID INT IDENTITY (1,1),
		StyleQuoteItemID UNIQUEIDENTIFIER 
	)	


	INSERT INTO  #StyleQuoteItem  (StyleQuoteItemID)
	SELECT StyleQuoteItemID FROM pStyleQuoteItem WHERE StyleSourcingID = @StyleSourcingID 

	DECLARE @ROW INT
	DECLARE @TOTAL INT 
	DECLARE @StyleQuoteItemID2 UNIQUEIDENTIFIER 

	SET @ROW = 1 
	SELECT @TOTAL  = COUNT (*) FROM #StyleQuoteItem 
	

	WHILE @ROW <= @TOTAL 
	BEGIN 
		SELECT @StyleQuoteItemID2 = StyleQuoteItemID
		FROM  #StyleQuoteItem
		WHERE ROW_ID  = @ROW

		UPDATE pStyleQuoteItem SET 
		StyleQuoteItemCustomField4 = @StyleQuoteItemCustomField4, 
		StyleQuoteItemCustomField5 = @StyleQuoteItemCustomField5, 
		StyleQuoteItemCustomField6 = @StyleQuoteItemCustomField6, 
		StyleQuoteItemCustomField7 = @StyleQuoteItemCustomField7 , 
		StyleQuoteItemCustomField8 = @StyleQuoteItemCustomField8 ,
		StyleQuoteItemCustomField24 = @StyleQuoteItemCustomField24,
		StyleQuoteItemStatusID = @StyleQuoteItemStatusID
		WHERE StyleQuoteItemID = @StyleQuoteItemID2

	
	
		EXEC dbo.spx_StyleSourcingQuoteItemLogic_UPDATE @StyleQuoteItemID2
		--PRINT 'AA = '  + cast (@StyleQuoteItemID2 AS NVARCHAR(50))
	
		EXEC dbo.spx_StyleSourcingQuoteItemVersion_UPDATE  @StyleQuoteItemID2			
		SET @ROW = @ROW + 1

	END 



	Select 1 as dummy

END 









GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlan_AddStyle_Logic_INSERT]'
GO

CREATE PROCEDURE dbo.spx_LinePlan_AddStyle_Logic_INSERT(
@StyleID  UNIQUEIDENTIFIER ,
@LinePlanID UNIQUEIDENTIFIER,
@CUser NVARCHAR(200),
@CDate DATETIME 
)
AS


--/***
--** Load LinePlanRange, season, year
--***/

DECLARE @LinePlanItemID UNIQUEIDENTIFIER
DECLARE @SeasonYearID UNIQUEIDENTIFIER
DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER
DECLARE @Season NVARCHAR(200)
DECLARE @Year NVARCHAR(200)


DECLARE @StyleType INT
DECLARE @CustomField5 NVARCHAR(200)
DECLARE @CustomField4 NVARCHAR(200)
DECLARE @CustomField6 NVARCHAR(200)
DECLARE @StyleCategory NVARCHAR(50)


SELECT  TOP 1 @SeasonYearID = b.SeasonYearID , @Season = b.Season, @Year= b.Year 
FROM pLinePlan a
INNER JOIN pSeasonYear b ON a.Season = b.Season AND a.Year =  b.Year 
WHERE LinePlanID = @LinePlanID


SELECT @StyleType = a.StyleType, @CustomField5 = a.CustomField5, @CustomField4 = a.CustomField4,
@CustomField6 = a.CustomField6, @StyleCategory  = b.StyleCategory 
FROM pStyleHeader a
LEFT OUTER JOIN pStyleCategory b ON a.StyleCategory  =  b.StyleCategoryID
WHERE StyleID = @StyleID 


SELECT @StyleType,@CustomField5, @CustomField4, @CustomField6, @StyleCategory 

SELECT TOP 1 @LinePlanItemID = LinePlanItemID
FROM pLinePlanRange a
INNER JOIN pLinePlanItem b ON b.LinePlanRangeID = a.LinePlanRangeID 
WHERE a.LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'
AND a.LinePlanAttributeText1 = @CustomField5
AND a.LinePlanAttributeText2 = @CustomField4
AND a.LinePlanAttributeText3 = @CustomField6
AND a.LinePlanAttributeText4 = @StyleCategory 
AND b.LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003'
AND b.StyleID = '00000000-0000-0000-0000-000000000000' 
AND b.LinePlanID = @LinePlanID 

IF @LinePlanItemID IS NOT NULL 
BEGIN

	UPDATE pLinePlanItem Set StyleID = @StyleID WHERE LinePlanItemID =  @LinePlanItemID 
	
	SELECT @StyleSeasonYearID = StyleSeasonYearID FROM pStyleSeasonYear 
	WHERE StyleID = @StyleID AND SeasonYearID = @SeasonYearID 
	
	IF @StyleSeasonYearID IS NULL 
	BEGIN
		SET @StyleSeasonYearID  = NEWID()
		
		INSERT INTO pStyleSeasonYear (StyleSeasonyearID, StyleID, StyleSeason, StyleYear, 
		CUser,CDate,MUser, MDate, SeasonYearID , LinePlanID, LinePlanItemID )
		VALUES (@StyleSeasonyearID, @StyleID, @Season, @Year, 
		@CUser,@CDate, @CUser, @CDate, @SeasonYearID , @LinePlanID, @LinePlanItemID )
		
	END 
	ELSE 
		UPDATE pStyleSeasonYear 
		SET LinePlanItemID = @LinePlanItemID, LinePlanID = @LinePlanID,
		StyleSeason = @Season, StyleYear = @Year, MUser =@CUser, MDate = @CDate
		WHERE StyleSeasonYearID = @StyleSeasonYearID 
	

	/***
	** Insert financial Info 
	***/
	EXEC spx_LinePlanBusinessItemNew_INSERT @StyleID = @StyleID, @LinePlanItemID = @LinePlanItemID
	EXEC spx_LinePlanStyleDelivery_Logic_UPDATE @StyleID = @StyleID, @LinePlanID = @LinePlanID, @LinePlanItemID = @LinePlanItemID
	
		
END 








GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlan_MoveToLinePlan_Logic_UPDATE]'
GO

CREATE PROCEDURE [dbo].[spx_LinePlan_MoveToLinePlan_Logic_UPDATE](
@StyleID UNIQUEIDENTIFIER, 
@LinePlanID UNIQUEIDENTIFIER, 
@SeasonYearID UNIQUEIDENTIFIER, 
@MUser NVARCHAR(200), 
@MDate DATETIME 
)
AS


DECLARE @LinePlanItemID UNIQUEIDENTIFIER 
DECLARE @LinePlanRangeID UNIQUEIDENTIFIER 
DECLARE @LinePlanTemplateID UNIQUEIDENTIFIER 
DECLARE @OldLinePlanItemID  UNIQUEIDENTIFIER 
DECLARE @OldLinePlanID  UNIQUEIDENTIFIER 
DECLARE @LinePlanAttributeText1 NVARCHAR(200)
DECLARE @LinePlanAttributeText2 NVARCHAR(200)
DECLARE @LinePlanAttributeText3 NVARCHAR(200)

DECLARE @OldLinePlanAttributeItemId1 NVARCHAR(50)
DECLARE @OldLinePlanAttributeItemId2 NVARCHAR(50)
DECLARE @OldLinePlanAttributeItemId3 NVARCHAR(50)


SELECT @OldLinePlanItemID = a.LinePlanItemID, @OldLinePlanID = a.LinePlanID ,
@LinePlanAttributeText1 = c.LinePlanAttributeText1, @LinePlanAttributeText2  = c.LinePlanAttributeText2,
@LinePlanAttributeText3 = c.LinePlanAttributeText3,
@OldLinePlanAttributeItemId1 = c.LinePlanAttributeItemId1, @OldLinePlanAttributeItemId2 = c.LinePlanAttributeItemId2, 
@OldLinePlanAttributeItemId3 = c.LinePlanAttributeItemId3
FROM pStyleSeasonYear a
INNER JOIN pLinePlanItem b ON a.LinePlanItemID = b.LinePlanItemID 
INNER JOIN pLinePlanRange c ON b.LinePlanRangeID =  c.LinePlanRangeID 
WHERE a.StyleID = @StyleID 
AND a.SeasonYearID = @SeasonYearID 


IF @OldLinePlanItemID IS NOT NULL 
BEGIN

	SELECT TOP 1 @LinePlanItemID = a.LinePlanItemID , @LinePlanTemplateID = c.LinePlanTemplateID, 
	@LinePlanRangeID = a.LinePlanRangeID
	FROM pLinePlanItem a
	INNER JOIN pLinePlanRange b ON a.LinePlanRangeID = b.LinePlanRangeID
	INNER JOIN pLinePlan c ON  c.LinePlanID = a.LinePlanID 
	WHERE a.LinePlanID = @LinePlanID 
	AND a.LinePlanRangeTypeID = '00000000-0000-0000-0000-000000000003'
	AND a.StyleID = '00000000-0000-0000-0000-000000000000'
	AND b.LinePlanAttributeText1 = @LinePlanAttributeText1
	AND b.LinePlanAttributeText2 = @LinePlanAttributeText2
	AND b.LinePlanAttributeText3 = @LinePlanAttributeText3
	

	IF @LinePlanItemID IS NOT NULL
	BEGIN
		
			/***
			** Update old lineplanitem 
			***/
			UPDATE pLinePlanItem Set StyleID = '00000000-0000-0000-0000-000000000000',
			MUser = @MUser, MDate =  @MDate 
			WHERE LinePlanItemID = @OldLinePlanItemID
						
			DELETE FROM pLineplanBusinessItem WHERE StyleID = @StyleID
			DELETE FROM pLinePlanShowroomStyle WHERE StyleID = @StyleID
			DELETE FROM pLinePlanShowroomStyleColor WHERE StyleID = @StyleID
			
			EXEC spx_LinePlanBusinessItemRollup_INSERT @LinePlanId = @OldLinePlanId,
			@LinePlanAttributeItemId1 = @OldLinePlanAttributeItemId1,
			@LinePlanAttributeItemId2 = @OldLinePlanAttributeItemId2,
			@LinePlanAttributeItemId3 = @OldLinePlanAttributeItemId3,
			@LinePlanAttributeItemId4 = '',
			@Cmd = '',
			@StyleSeasonYearID  = NULL 
				
			/***
			** Update New lineplanitem 
			***/
			UPDATE pLinePlanItem Set StyleID = @StyleID,
			MUser = @MUser, MDate =  @MDate 
			WHERE LinePlanItemID = @LinePlanItemID
			
			
			/***
			** Update StyleSeasonYear
			***/
			DECLARE @NewSeasonYearID UNIQUEIDENTIFIER
			DECLARE @Season NVARCHAR(200)
			DECLARE @Year NVARCHAR(200)
			
			SELECT @NewSeasonYearID = c.SeasonYearID, @Season = c.Season, @Year = c.Year 
			FROM pLinePlanItem a
			INNER JOIN pLinePlan b ON a.LinePlanID =  b.LinePlanID 
			INNER JOIN pSeasonYear c ON b.Season = c.Season AND b.Year = c.Year
			WHERE a.LinePlanItemID = @LinePlanItemID 

			
			UPDATE pStyleSeasonYear SET 
			StyleSeason = @Season, StyleYear = @Year,  
			SeasonYearID = @NewSeasonYearID,
			LinePlanItemID = @LinePlanItemID, LinePlanID = @LinePlanID,
			MUser = @MUser, MDate =  @MDate
			WHERE StyleID = @StyleID AND SeasonYearID = @SeasonYearID
			
			
			/***
			** Update StyleHeader 
			***/		
			--IF @LinePlanTemplateID  = '70000000-0000-0000-0000-000000000001'
			--BEGIN 
			
			--	DECLARE @CustomField2 NVARCHAR(200)
			--	DECLARE @StyleType INT
			--	DECLARE @StyleCategory UNIQUEIDENTIFIER 
				
			--	SELECT 
			--	@CustomField2  = a.LinePlanAttributeText1, 
			--	@StyleType = b.LinePlanAttributeValue,
			--	@StyleCategory= c.LinePlanAttributeValue
			--	FROM pLinePlanRange a
			--	INNER JOIN pLinePlanAttributeItem b ON a.LinePlanAttributeItemID2 = b.LinePlanAttributeItemID
			--	INNER JOIN pLinePlanAttributeItem c ON a.LinePlanAttributeItemID3 = c.LinePlanAttributeItemID
			--	WHERE LinePlanRangeID = @LinePlanRangeID
				
			--	UPDATE pStyleHeader SET 
			--	CustomField2 = @CustomField2, StyleType = @StyleType, StyleCategory = @StyleCategory,
			--	MUser = @MUser, MDate =  @MDate 
			--	WHERE StyleID = @StyleID 
						
			--END 
			
					
			/***
			** Insert financial Info 
			***/
			EXEC spx_LinePlanBusinessItemNew_INSERT @StyleID = @StyleID, @LinePlanItemID = @LinePlanItemID
			EXEC spx_LinePlanStyleDelivery_Logic_UPDATE @StyleID = @StyleID, @LinePlanID = @LinePlanID, @LinePlanItemID = @LinePlanItemID

		
	
	END 


END 







GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_LinePlanBusinessLogic_UPDATE_QUEUE]'
GO

CREATE PROCEDURE [dbo].[spx_LinePlanBusinessLogic_UPDATE_QUEUE](
@LinePlanID VARCHAR(40),
@LinePlanAttributeItemID1 VARCHAR(40),
@LinePlanAttributeItemID2 VARCHAR(40),
@LinePlanAttributeItemID3 VARCHAR(40),
@LinePlanAttributeItemID4 VARCHAR(40),
@MUser NVARCHAR(200) = NULL ,
@MDate DATETIME = NULL
)
AS

IF @MDate IS NULL
	SET @MDate = GETDATE()

DECLARE @LY1_NoOfStyle INTEGER
DECLARE @LY1_NoOfFabric INTEGER
DECLARE @LY1_NoOfBody INTEGER 
DECLARE @LY1_NoOfColor INTEGER
DECLARE @LY1_NoOfOptions INTEGER
DECLARE @LY1_MarkupFactor DECIMAL(18, 3)
DECLARE @LY1_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @LY1_AvgTargetFOB DECIMAL(18, 5)
DECLARE @LY1_SalesUnit DECIMAL(18, 3)
DECLARE @LY1_ProjectedWhs DECIMAL(18, 5)
DECLARE @LY1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY1_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY1_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @LY2_NoOfStyle INTEGER
DECLARE @LY2_NoOfFabric INTEGER
DECLARE @LY2_NoOfBody INTEGER 
DECLARE @LY2_NoOfColor INTEGER
DECLARE @LY2_NoOfOptions INTEGER
DECLARE @LY2_MarkupFactor DECIMAL(18, 3)
DECLARE @LY2_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @LY2_AvgTargetFOB DECIMAL(18, 5)
DECLARE @LY2_SalesUnit DECIMAL(18, 3)
DECLARE @LY2_ProjectedWhs DECIMAL(18, 5)
DECLARE @LY2_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY2_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY2_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY2_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY2_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @LY3_NoOfStyle INTEGER
DECLARE @LY3_NoOfFabric INTEGER
DECLARE @LY3_NoOfBody INTEGER 
DECLARE @LY3_NoOfColor INTEGER
DECLARE @LY3_NoOfOptions INTEGER
DECLARE @LY3_MarkupFactor DECIMAL(18, 3)
DECLARE @LY3_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @LY3_AvgTargetFOB DECIMAL(18, 5)
DECLARE @LY3_SalesUnit DECIMAL(18, 3)
DECLARE @LY3_ProjectedWhs DECIMAL(18, 5)
DECLARE @LY3_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY3_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY3_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY3_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY3_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @LY4_NoOfStyle INTEGER
DECLARE @LY4_NoOfFabric INTEGER
DECLARE @LY4_NoOfBody INTEGER 
DECLARE @LY4_NoOfColor INTEGER
DECLARE @LY4_NoOfOptions INTEGER
DECLARE @LY4_MarkupFactor DECIMAL(18, 3)
DECLARE @LY4_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @LY4_AvgTargetFOB DECIMAL(18, 5)
DECLARE @LY4_SalesUnit DECIMAL(18, 3)
DECLARE @LY4_ProjectedWhs DECIMAL(18, 5)
DECLARE @LY4_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY4_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY4_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @LY4_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @LY4_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @PL1_NoOfStyle INTEGER
DECLARE @PL1_NoOfFabric INTEGER
DECLARE @PL1_NoOfBody INTEGER 
DECLARE @PL1_NoOfColor INTEGER
DECLARE @PL1_NoOfOptions INTEGER
DECLARE @PL1_MarkupFactor DECIMAL(18, 3)
DECLARE @PL1_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @PL1_AvgTargetFOB DECIMAL(18, 5)
DECLARE @PL1_SalesUnit DECIMAL(18, 3)
DECLARE @PL1_ProjectedWhs DECIMAL(18, 5)
DECLARE @PL1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL1_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL1_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @PL2_NoOfStyle INTEGER
DECLARE @PL2_NoOfFabric INTEGER
DECLARE @PL2_NoOfBody INTEGER 
DECLARE @PL2_NoOfColor INTEGER
DECLARE @PL2_NoOfOptions INTEGER
DECLARE @PL2_MarkupFactor DECIMAL(18, 3)
DECLARE @PL2_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @PL2_AvgTargetFOB DECIMAL(18, 5)
DECLARE @PL2_SalesUnit DECIMAL(18, 3)
DECLARE @PL2_ProjectedWhs DECIMAL(18, 5)
DECLARE @PL2_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL2_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL2_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL2_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL2_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @PL3_NoOfStyle INTEGER
DECLARE @PL3_NoOfFabric INTEGER
DECLARE @PL3_NoOfBody INTEGER 
DECLARE @PL3_NoOfColor INTEGER
DECLARE @PL3_NoOfOptions INTEGER
DECLARE @PL3_MarkupFactor DECIMAL(18, 3)
DECLARE @PL3_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @PL3_AvgTargetFOB DECIMAL(18, 5)
DECLARE @PL3_SalesUnit DECIMAL(18, 3)
DECLARE @PL3_ProjectedWhs DECIMAL(18, 5)
DECLARE @PL3_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL3_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL3_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL3_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL3_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @PL4_NoOfStyle INTEGER
DECLARE @PL4_NoOfFabric INTEGER
DECLARE @PL4_NoOfBody INTEGER 
DECLARE @PL4_NoOfColor INTEGER
DECLARE @PL4_NoOfOptions INTEGER
DECLARE @PL4_MarkupFactor DECIMAL(18, 3)
DECLARE @PL4_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @PL4_AvgTargetFOB DECIMAL(18, 5)
DECLARE @PL4_SalesUnit DECIMAL(18, 3)
DECLARE @PL4_ProjectedWhs DECIMAL(18, 5)
DECLARE @PL4_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL4_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL4_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @PL4_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @PL4_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @Cu1_NoOfStyle INTEGER
DECLARE @Cu1_NoOfFabric INTEGER
DECLARE @Cu1_NoOfBody INTEGER 
DECLARE @Cu1_NoOfColor INTEGER
DECLARE @Cu1_NoOfOptions INTEGER
DECLARE @Cu1_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu1_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @Cu1_AvgTargetFOB DECIMAL(18, 5)
DECLARE @Cu1_SalesUnit DECIMAL(18, 3)
DECLARE @Cu1_ProjectedWhs DECIMAL(18, 5)
DECLARE @Cu1_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu1_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu1_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu1_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu1_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @Cu2_NoOfStyle INTEGER
DECLARE @Cu2_NoOfFabric INTEGER
DECLARE @Cu2_NoOfBody INTEGER 
DECLARE @Cu2_NoOfColor INTEGER
DECLARE @Cu2_NoOfOptions INTEGER
DECLARE @Cu2_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu2_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @Cu2_AvgTargetFOB DECIMAL(18, 5)
DECLARE @Cu2_SalesUnit DECIMAL(18, 3)
DECLARE @Cu2_ProjectedWhs DECIMAL(18, 5)
DECLARE @Cu2_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu2_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu2_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu2_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu2_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @Cu3_NoOfStyle INTEGER
DECLARE @Cu3_NoOfFabric INTEGER
DECLARE @Cu3_NoOfBody INTEGER 
DECLARE @Cu3_NoOfColor INTEGER
DECLARE @Cu3_NoOfOptions INTEGER
DECLARE @Cu3_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu3_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @Cu3_AvgTargetFOB DECIMAL(18, 5)
DECLARE @Cu3_SalesUnit DECIMAL(18, 3)
DECLARE @Cu3_ProjectedWhs DECIMAL(18, 5)
DECLARE @Cu3_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu3_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu3_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu3_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu3_WeightedAverageRetailPrice DECIMAL(18, 3)

DECLARE @Cu4_NoOfStyle INTEGER
DECLARE @Cu4_NoOfFabric INTEGER
DECLARE @Cu4_NoOfBody INTEGER 
DECLARE @Cu4_NoOfColor INTEGER
DECLARE @Cu4_NoOfOptions INTEGER
DECLARE @Cu4_MarkupFactor DECIMAL(18, 3)
DECLARE @Cu4_TargetAvgWhsPrice DECIMAL(18, 5)
DECLARE @Cu4_AvgTargetFOB DECIMAL(18, 5)
DECLARE @Cu4_SalesUnit DECIMAL(18, 3)
DECLARE @Cu4_ProjectedWhs DECIMAL(18, 5)
DECLARE @Cu4_InitialGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu4_InitialGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu4_WeightGrossMarginWhs DECIMAL(18, 3)
DECLARE @Cu4_WeightGrossMarginRtl DECIMAL(18, 3)
DECLARE @Cu4_WeightedAverageRetailPrice DECIMAL(18, 3)


/*
--***
--** Number of Styles
--***
SELECT TOP 1 
@LY1_NoOfStyle = LinePlanBusLYCh1, @LY2_NoOfStyle = LinePlanBusLYCh2, @LY3_NoOfStyle = LinePlanBusLYCh3, @LY4_NoOfStyle = LinePlanBusLYCh4, 
@PL1_NoOfStyle = LinePlanBusPnCh1, @PL2_NoOfStyle = LinePlanBusPnCh2, @PL3_NoOfStyle = LinePlanBusPnCh3, @PL4_NoOfStyle = LinePlanBusPnCh4, 
@Cu1_NoOfStyle = LinePlanBusCuCh1, @Cu2_NoOfStyle = LinePlanBusCuCh2, @Cu3_NoOfStyle = LinePlanBusCuCh3, @Cu4_NoOfStyle = LinePlanBusCuCh4 
FROM pLinePlanBusiness
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'
*/

/*
--***
--** Number of Fabrics
--***
SELECT TOP 1 
@LY1_NoOfFabric = LinePlanBusLYCh1, @LY2_NoOfFabric = LinePlanBusLYCh2, @LY3_NoOfFabric = LinePlanBusLYCh3, @LY4_NoOfFabric = LinePlanBusLYCh4, 
@PL1_NoOfFabric = LinePlanBusPnCh1, @PL2_NoOfFabric = LinePlanBusPnCh2, @PL3_NoOfFabric = LinePlanBusPnCh3, @PL4_NoOfFabric = LinePlanBusPnCh4, 
@Cu1_NoOfFabric = LinePlanBusCuCh1, @Cu2_NoOfFabric = LinePlanBusCuCh2, @Cu3_NoOfFabric = LinePlanBusCuCh3, @Cu4_NoOfFabric = LinePlanBusCuCh4 
FROM pLinePlanBusiness
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 	AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 	AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000001'
*/

/*
--***
--** Number of Silhouettes
--***
SELECT TOP 1 
@LY1_NoOfBody = LinePlanBusLYCh1, @LY2_NoOfBody = LinePlanBusLYCh2,	@LY3_NoOfBody = LinePlanBusLYCh3, @LY4_NoOfBody = LinePlanBusLYCh4, 
@PL1_NoOfBody = LinePlanBusPnCh1, @PL2_NoOfBody = LinePlanBusPnCh2, @PL3_NoOfBody = LinePlanBusPnCh3, @PL4_NoOfBody = LinePlanBusPnCh4, 
@Cu1_NoOfBody = LinePlanBusCuCh1, @Cu2_NoOfBody = LinePlanBusCuCh2, @Cu3_NoOfBody = LinePlanBusCuCh3, @Cu4_NoOfBody = LinePlanBusCuCh4 
FROM pLinePlanBusiness
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000003'
*/

/*
--***
--** Number of Colors
--***
SELECT TOP 1 
@LY1_NoOfColor = LinePlanBusLYCh1, @LY2_NoOfColor = LinePlanBusLYCh2, @LY3_NoOfColor = LinePlanBusLYCh3, @LY4_NoOfColor = LinePlanBusLYCh4, 
@PL1_NoOfColor = LinePlanBusPnCh1, @PL2_NoOfColor = LinePlanBusPnCh2, @PL3_NoOfColor = LinePlanBusPnCh3, @PL4_NoOfColor = LinePlanBusPnCh4, 
@Cu1_NoOfColor = LinePlanBusCuCh1, @Cu2_NoOfColor = LinePlanBusCuCh2, @Cu3_NoOfColor = LinePlanBusCuCh3, @Cu4_NoOfColor = LinePlanBusCuCh4 
FROM pLinePlanBusiness
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 	AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '10000000-0000-0000-0000-000000000002'
*/


--***
--** Initial Gross Margin WHS %
--***
SELECT TOP 1 
@LY1_InitialGrossMarginWhs = ISNULL(LinePlanBusLYCh1,0), @LY2_InitialGrossMarginWhs = ISNULL(LinePlanBusLYCh2,0), @LY3_InitialGrossMarginWhs = ISNULL(LinePlanBusLYCh3,0), @LY4_InitialGrossMarginWhs = ISNULL(LinePlanBusLYCh4,0), 
@PL1_InitialGrossMarginWhs = ISNULL(LinePlanBusPnCh1,0), @PL2_InitialGrossMarginWhs = ISNULL(LinePlanBusPnCh2,0), @PL3_InitialGrossMarginWhs = ISNULL(LinePlanBusPnCh3,0), @PL4_InitialGrossMarginWhs = ISNULL(LinePlanBusPnCh4,0), 
@Cu1_InitialGrossMarginWhs = ISNULL(LinePlanBusCuCh1,0), @Cu2_InitialGrossMarginWhs = ISNULL(LinePlanBusCuCh2,0), @Cu3_InitialGrossMarginWhs = ISNULL(LinePlanBusCuCh3,0), @Cu4_InitialGrossMarginWhs = ISNULL(LinePlanBusCuCh4,0) 
FROM pLinePlanBusiness
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000013'


/*
--***
--** Mark up Factor
--***
SELECT TOP 1 
@LY1_MarkupFactor = LinePlanBusLYCh1, @LY2_MarkupFactor = LinePlanBusLYCh2, @LY3_MarkupFactor = LinePlanBusLYCh3, @LY4_MarkupFactor = LinePlanBusLYCh4, 
@PL1_MarkupFactor = LinePlanBusPnCh1, @PL2_MarkupFactor = LinePlanBusPnCh2, @PL3_MarkupFactor = LinePlanBusPnCh3, @PL4_MarkupFactor = LinePlanBusPnCh4, 
@Cu1_MarkupFactor = LinePlanBusCuCh1, @Cu2_MarkupFactor = LinePlanBusCuCh2, @Cu3_MarkupFactor = LinePlanBusCuCh3, @Cu4_MarkupFactor = LinePlanBusCuCh4 
FROM pLinePlanBusiness
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000005'
*/


--***
--** Retail Flow Through Margin%
--***
SELECT TOP 1 
@LY1_InitialGrossMarginRtl = ISNULL(LinePlanBusLYCh1,0), @LY2_InitialGrossMarginRtl = ISNULL(LinePlanBusLYCh2,0), @LY3_InitialGrossMarginRtl = ISNULL(LinePlanBusLYCh3,0), @LY4_InitialGrossMarginRtl = ISNULL(LinePlanBusLYCh4,0), 
@PL1_InitialGrossMarginRtl = ISNULL(LinePlanBusPnCh1,0), @PL2_InitialGrossMarginRtl = ISNULL(LinePlanBusPnCh2,0), @PL3_InitialGrossMarginRtl = ISNULL(LinePlanBusPnCh3,0), @PL4_InitialGrossMarginRtl = ISNULL(LinePlanBusPnCh4,0), 
@Cu1_InitialGrossMarginRtl = ISNULL(LinePlanBusCuCh1,0), @Cu2_InitialGrossMarginRtl = ISNULL(LinePlanBusCuCh2,0), @Cu3_InitialGrossMarginRtl = ISNULL(LinePlanBusCuCh3,0), @Cu4_InitialGrossMarginRtl = ISNULL(LinePlanBusCuCh4,0) 
FROM pLinePlanBusiness
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000010'

--***
--** Sales units
--***
SELECT TOP 1 
@LY1_SalesUnit = ISNULL(LinePlanBusLYCh1,0), @LY2_SalesUnit = ISNULL(LinePlanBusLYCh2,0), @LY3_SalesUnit = ISNULL(LinePlanBusLYCh3,0), @LY4_SalesUnit = ISNULL(LinePlanBusLYCh4,0), 
@PL1_SalesUnit = ISNULL(LinePlanBusPnCh1,0), @PL2_SalesUnit = ISNULL(LinePlanBusPnCh2,0), @PL3_SalesUnit = ISNULL(LinePlanBusPnCh3,0), @PL4_SalesUnit = ISNULL(LinePlanBusPnCh4,0), 
@Cu1_SalesUnit = ISNULL(LinePlanBusCuCh1,0), @Cu2_SalesUnit = ISNULL(LinePlanBusCuCh2,0), @Cu3_SalesUnit = ISNULL(LinePlanBusCuCh3,0), @Cu4_SalesUnit = ISNULL(LinePlanBusCuCh4,0) 
FROM pLinePlanBusiness
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000008'


--***
--** Target Average Whs Price
--***   
SELECT TOP 1 
@LY1_TargetAvgWhsPrice = ISNULL(LinePlanBusLYCh1,0), @LY2_TargetAvgWhsPrice = ISNULL(LinePlanBusLYCh2,0), @LY3_TargetAvgWhsPrice = ISNULL(LinePlanBusLYCh3,0), @LY4_TargetAvgWhsPrice = ISNULL(LinePlanBusLYCh4,0), 
@PL1_TargetAvgWhsPrice = ISNULL(LinePlanBusPnCh1,0), @PL2_TargetAvgWhsPrice = ISNULL(LinePlanBusPnCh2,0), @PL3_TargetAvgWhsPrice = ISNULL(LinePlanBusPnCh3,0), @PL4_TargetAvgWhsPrice = ISNULL(LinePlanBusPnCh4,0), 
@Cu1_TargetAvgWhsPrice = ISNULL(LinePlanBusCuCh1,0), @Cu2_TargetAvgWhsPrice = ISNULL(LinePlanBusCuCh2,0), @Cu3_TargetAvgWhsPrice = ISNULL(LinePlanBusCuCh3,0), @Cu4_TargetAvgWhsPrice = ISNULL(LinePlanBusCuCh4,0) 
FROM pLinePlanBusiness
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000009'


--***
--** Average Target FOB
--***   
SET @LY1_AvgTargetFOB = @LY1_TargetAvgWhsPrice - (@LY1_TargetAvgWhsPrice * @LY1_InitialGrossMarginWhs)
SET @LY2_AvgTargetFOB = @LY2_TargetAvgWhsPrice - (@LY2_TargetAvgWhsPrice * @LY2_InitialGrossMarginWhs)
SET @LY3_AvgTargetFOB = @LY3_TargetAvgWhsPrice - (@LY3_TargetAvgWhsPrice * @LY3_InitialGrossMarginWhs)
SET @LY4_AvgTargetFOB = @LY4_TargetAvgWhsPrice - (@LY4_TargetAvgWhsPrice * @LY4_InitialGrossMarginWhs)

SET @PL1_AvgTargetFOB = @PL1_TargetAvgWhsPrice - (@PL1_TargetAvgWhsPrice * @PL1_InitialGrossMarginWhs)
SET @PL2_AvgTargetFOB = @PL2_TargetAvgWhsPrice - (@PL2_TargetAvgWhsPrice * @PL2_InitialGrossMarginWhs)
SET @PL3_AvgTargetFOB = @PL3_TargetAvgWhsPrice - (@PL3_TargetAvgWhsPrice * @PL3_InitialGrossMarginWhs)
SET @PL4_AvgTargetFOB = @PL4_TargetAvgWhsPrice - (@PL4_TargetAvgWhsPrice * @PL4_InitialGrossMarginWhs)

SET @Cu1_AvgTargetFOB = @Cu1_TargetAvgWhsPrice - (@Cu1_TargetAvgWhsPrice * @Cu1_InitialGrossMarginWhs)
SET @Cu2_AvgTargetFOB = @Cu2_TargetAvgWhsPrice - (@Cu2_TargetAvgWhsPrice * @Cu2_InitialGrossMarginWhs)
SET @Cu3_AvgTargetFOB = @Cu3_TargetAvgWhsPrice - (@Cu3_TargetAvgWhsPrice * @Cu3_InitialGrossMarginWhs)
SET @Cu4_AvgTargetFOB = @Cu4_TargetAvgWhsPrice - (@Cu4_TargetAvgWhsPrice * @Cu4_InitialGrossMarginWhs)


UPDATE pLinePlanBusiness SET
LinePlanBusLYCh1 = @LY1_AvgTargetFOB, LinePlanBusLYCh2 = @LY2_AvgTargetFOB,
LinePlanBusLYCh3 = @LY3_AvgTargetFOB, LinePlanBusLYCh4 = @LY4_AvgTargetFOB, 
LinePlanBusPnCh1 = @PL1_AvgTargetFOB, LinePlanBusPnCh2 = @PL2_AvgTargetFOB, 
LinePlanBusPnCh3 = @PL3_AvgTargetFOB, LinePlanBusPnCh4 = @PL4_AvgTargetFOB, 
LinePlanBusCuCh1 = @Cu1_AvgTargetFOB, LinePlanBusCuCh2 = @Cu2_AvgTargetFOB, 
LinePlanBusCuCh3 = @Cu3_AvgTargetFOB, LinePlanBusCuCh4 = @Cu4_AvgTargetFOB 	
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000006'


--***
--** Projected Wholesale 
--***   
SET @LY1_ProjectedWhs = (@LY1_SalesUnit * @LY1_TargetAvgWhsPrice)  
SET @LY2_ProjectedWhs = (@LY2_SalesUnit * @LY2_TargetAvgWhsPrice) 
SET @LY3_ProjectedWhs = (@LY3_SalesUnit * @LY3_TargetAvgWhsPrice) 
SET @LY4_ProjectedWhs = (@LY4_SalesUnit * @LY4_TargetAvgWhsPrice) 
SET @PL1_ProjectedWhs = (@PL1_SalesUnit * @PL1_TargetAvgWhsPrice) 
SET @PL2_ProjectedWhs = (@PL2_SalesUnit * @PL2_TargetAvgWhsPrice) 
SET @PL3_ProjectedWhs = (@PL3_SalesUnit * @PL3_TargetAvgWhsPrice) 
SET @PL4_ProjectedWhs = (@PL4_SalesUnit * @PL4_TargetAvgWhsPrice) 
SET @Cu1_ProjectedWhs = (@Cu1_SalesUnit * @Cu1_TargetAvgWhsPrice) 
SET @Cu2_ProjectedWhs = (@Cu2_SalesUnit * @Cu2_TargetAvgWhsPrice) 
SET @Cu3_ProjectedWhs = (@Cu3_SalesUnit * @Cu3_TargetAvgWhsPrice) 
SET @Cu4_ProjectedWhs = (@Cu4_SalesUnit * @Cu4_TargetAvgWhsPrice) 	

UPDATE pLinePlanBusiness SET
LinePlanBusLYCh1 = @LY1_ProjectedWhs, LinePlanBusLYCh2 = @LY2_ProjectedWhs,
LinePlanBusLYCh3 = @LY3_ProjectedWhs, LinePlanBusLYCh4 = @LY4_ProjectedWhs, 
LinePlanBusPnCh1 = @PL1_ProjectedWhs, LinePlanBusPnCh2 = @PL2_ProjectedWhs, 
LinePlanBusPnCh3 = @PL3_ProjectedWhs, LinePlanBusPnCh4 = @PL4_ProjectedWhs, 
LinePlanBusCuCh1 = @Cu1_ProjectedWhs, LinePlanBusCuCh2 = @Cu2_ProjectedWhs, 
LinePlanBusCuCh3 = @Cu3_ProjectedWhs, LinePlanBusCuCh4 = @Cu4_ProjectedWhs	
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000007'


--***
--** Weighted gross margin - Retail %
--***   
UPDATE pLinePlanBusiness SET
LinePlanBusLYCh1 = @LY1_InitialGrossMarginRtl, LinePlanBusLYCh2 = @LY2_InitialGrossMarginRtl, LinePlanBusLYCh3 = @LY3_InitialGrossMarginRtl, LinePlanBusLYCh4 = @LY4_InitialGrossMarginRtl,
LinePlanBusPnCh1 = @PL1_InitialGrossMarginRtl, LinePlanBusPnCh2 = @PL2_InitialGrossMarginRtl, LinePlanBusPnCh3 = @PL3_InitialGrossMarginRtl, LinePlanBusPnCh4 = @PL4_InitialGrossMarginRtl,
LinePlanBusCuCh1 = @Cu1_InitialGrossMarginRtl, LinePlanBusCuCh2 = @Cu2_InitialGrossMarginRtl, LinePlanBusCuCh3 = @Cu3_InitialGrossMarginRtl, LinePlanBusCuCh4 = @Cu4_InitialGrossMarginRtl
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000012'


--***
--** Weighted gross margin - Wholesale %
--***   
UPDATE pLinePlanBusiness SET
LinePlanBusLYCh1 = @LY1_InitialGrossMarginWhs, LinePlanBusLYCh2 = @LY2_InitialGrossMarginWhs, LinePlanBusLYCh3 = @LY3_InitialGrossMarginWhs, LinePlanBusLYCh4 = @LY4_InitialGrossMarginWhs,
LinePlanBusPnCh1 = @PL1_InitialGrossMarginWhs, LinePlanBusPnCh2 = @PL2_InitialGrossMarginWhs, LinePlanBusPnCh3 = @PL3_InitialGrossMarginWhs, LinePlanBusPnCh4 = @PL4_InitialGrossMarginWhs,
LinePlanBusCuCh1 = @Cu1_InitialGrossMarginWhs, LinePlanBusCuCh2 = @Cu2_InitialGrossMarginWhs, LinePlanBusCuCh3 = @Cu3_InitialGrossMarginWhs, LinePlanBusCuCh4 = @Cu4_InitialGrossMarginWhs
WHERE LinePlanAttributeItemID1 = @LinePlanAttributeItemID1 AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3 AND LinePlanID = @LinePlanID
AND LinePlanFinancialID = '00000000-0000-0000-0000-000000000011'




DECLARE @TOTAL INT
DECLARE @ROW_ID INT 
DECLARE @StyleQuoteItemID UNIQUEIDENTIFIER 
DECLARE @StyleSeasonYearID UNIQUEIDENTIFIER 
DECLARE @StyleID UNIQUEIDENTIFIER 

--========================================================================================================
-- UPDATE StyleCosting 

CREATE TABLE #tmpStyleSeasonYear  ( 
ROW_ID INT IDENTITY (1,1),
StyleSeasonYearID UNIQUEIDENTIFIER, 
StyleID UNIQUEIDENTIFIER
)

INSERT INTO  #tmpStyleSeasonYear ( StyleSeasonYearID, StyleID)
SELECT c.StyleSeasonYearID, b.StyleID
FROM pLinePlanRange a 
INNER JOIN pLinePlanItem b ON a.LinePlanRangeID = b.LinePlanRangeID 
INNER JOIN pStyleSeasonYear c ON (b.StyleID = c.StyleID AND b.LinePlanItemID = c.LinePlanItemID)
WHERE a.LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
AND a.LinePlanAttributeItemID2 = @LinePlanAttributeItemID2
AND a.LinePlanAttributeItemID3 = @LinePlanAttributeItemID3
AND a.LinePlanFinancialID = '10000000-0000-0000-0000-000000000004'
AND b.StyleID <>  '00000000-0000-0000-0000-000000000000'


SET @ROW_ID = 1 
SELECT @TOTAL  = COUNT(*) FROM #tmpStyleSeasonYear



WHILE  @ROW_ID <= @TOTAL
BEGIN

	SELECT @StyleSeasonYearID = StyleSeasonYearID, @StyleID = StyleID 
	FROM #tmpStyleSeasonYear WHERE ROW_ID = @ROW_ID

	EXEC dbo.spx_StyleCostingHeaderLogic_UPDATE 
	@StyleID = @StyleID,
	@ModifiedBy = @MUser,
	@ModifiedDate = @MDate, 
	@StyleSeasonYearID = @StyleSeasonYearID

	SET @ROW_ID = @ROW_ID + 1 
END 
DROP TABLE  #tmpStyleSeasonYear


--========================================================================================================
-- ADD LOGIC TO UPDATE STYLE_SOURCING_QUOTE_ITEMS 

CREATE TABLE #tmpQuoteItem  (
ROW_ID INT IDENTITY (1,1),
StyleQuoteItemID UNIQUEIDENTIFIER 
)

INSERT INTO #tmpQuoteItem (StyleQuoteItemID)
SELECT StyleQuoteItemID 
from pStyleQuoteItem 
WHERE StyleID IN ( SELECT distinct StyleID 
		FROM pLinePlanBusinessItem
		WHERE LinePlanID = @LinePlanID AND LinePlanAttributeItemID1 = @LinePlanAttributeItemID1
		AND LinePlanAttributeItemID2 = @LinePlanAttributeItemID2 
		AND LinePlanAttributeItemID3 = @LinePlanAttributeItemID3
)

SET @ROW_ID = 1 
SELECT @TOTAL  = COUNT(*) FROM #tmpQuoteItem

WHILE  @ROW_ID <= @TOTAL
BEGIN
	SELECT @StyleQuoteItemID = StyleQuoteItemID FROM #tmpQuoteItem WHERE ROW_ID = @ROW_ID
	EXEC dbo.spx_StyleSourcingQuoteItemLogic_UPDATE @StyleQuoteItemID
	SET @ROW_ID = @ROW_ID + 1 
END 
DROP TABLE  #tmpQuoteItem








GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[fnx_ToleranceFlag]'
GO
/*
Comments:

General - Ryan Cabanas - November 16, 2009
	Functions accepts an 'Asked', 'Spec', and 'Tolerance' value.  If the difference
between 'Asked' and 'Spec' is greater than 'Tolerance', return '1'.  Otherwise,
return '0'.
*/

CREATE FUNCTION [dbo].[fnx_ToleranceFlag]
(
	@Ask FLOAT
	,@Spec FLOAT
	,@Tolerance FLOAT
)

RETURNS INT

AS

BEGIN
	/*Declare variables.*/
	DECLARE @ToleranceFlag INT
	DECLARE @Difference FLOAT

	/*Calculate absolute difference between 'Asked' and 'Spec'.*/
	SET @Difference = ABS(@Ask - @Spec)

	/*Determine flag.*/
	IF(@Difference > @Tolerance)
		BEGIN
			SET @ToleranceFlag = 1
		END
	ELSE
		BEGIN
			SET @ToleranceFlag = 0
		END

	/*Return the flag.*/
	RETURN @ToleranceFlag
END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[fnx_RoundToDecimalFifty]'
GO
/*
Comments:

General - Ryan Cabanas - January 18, 2010
	Function to round to "$.50".
*/



CREATE FUNCTION [dbo].[fnx_RoundToDecimalFifty](
	@Number decimal(18,3)
)

RETURNS decimal(18,3)

AS


--/*Testing.*/
--BEGIN
--	DECLARE @Number decimal(18,3)
--	SET @Number = 128.744
--END

BEGIN
	/*Declare variables.*/
	DECLARE @StringNumber nvarchar(50)
	DECLARE @NewStringNumber nvarchar(50)
	DECLARE @DecimalLocation int
	DECLARE @StringInteger nvarchar(20)
	DECLARE @NewStringInteger nvarchar(20)
	DECLARE @StringFraction nvarchar(10)
	DECLARE @NewStringFraction nvarchar(10)

	DECLARE @DecimalPlaces int
	DECLARE @StringRoundingFractionalDigit nvarchar(1)


	/*Set decimal places to round to and work with.*/
	SET @DecimalPlaces = 2


	/************************************************************/
	/*Logic to extract portions of the number as string values.	*/
	/************************************************************/
	BEGIN
		/*Convert the decimal number to a string.*/
		SET @StringNumber = CAST(@Number AS nvarchar(50))

		/*Find the decimal point.*/
		SET @DecimalLocation = CHARINDEX('.', @StringNumber, 1)

		/*Find the integer portion of the whole number.*/
		SET @StringInteger = SUBSTRING(@StringNumber, 1, @DecimalLocation - 1)

		/*Find the decimal portion of the whole number.*/
		SET @StringFraction = SUBSTRING(@StringNumber, @DecimalLocation + 1, @DecimalPlaces)

		/*Find one decimal beyond the desired decimal places for one more digit of accuracy.*/
		SET @StringRoundingFractionalDigit = SUBSTRING(@StringNumber, @DecimalLocation + 1 + @DecimalPlaces, @DecimalLocation + 1 + @DecimalPlaces)

		/*Check one additional digit beyond the fractional portion to re-adjust the fractional portion for accuracy, if necessary.*/
		IF(@StringRoundingFractionalDigit >= '5' AND @StringRoundingFractionalDigit <= '9')
			BEGIN
				SET @StringFraction = @StringFraction + 1
			END

	END


	/********************/
	/*Rounding logic.	*/
	/********************/
	BEGIN
		/*Determine the decimal portion.  "$.00" or "$.50".*/
		IF(@StringFraction >= '01' AND @StringFraction <= '50')
			BEGIN
				SET @NewStringFraction = '50'
			END
		ELSE
			BEGIN
				SET @NewStringFraction = '00'
			END

		/*Determine if the integer needs to be rounded up.*/
		IF(@StringFraction >= '51' AND @StringFraction <= '99')
			BEGIN
				SET @NewStringInteger  = @StringInteger + 1
			END
		ELSE
			BEGIN
				SET @NewStringInteger = @StringInteger
			END

		/*Build new number.*/
		SET @NewStringNumber = @NewStringInteger + '.' + @NewStringFraction
	END


	/*Return the rounded number.*/
	RETURN CAST(@NewStringNumber AS decimal(18,3))
END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[fnx_SpecTol]'
GO
CREATE    FUNCTION [dbo].[fnx_SpecTol] (@ask float, @spec float, @tol as float, @toln as float, @notol as integer, @washType as varchar(50)) 	 
RETURNS varchar(20)
AS
BEGIN

	
RETURN 1

END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[pStyleActivityType]'
GO
CREATE TABLE [dbo].[pStyleActivityType]
(
[StyleActivityTypeId] [varchar] (2) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
[StyleActivityTypeName] [nvarchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleActivityTypeMsg] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[StyleActivityTypeNote] [nvarchar] (500) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pStyleActivityType] on [dbo].[pStyleActivityType]'
GO
ALTER TABLE [dbo].[pStyleActivityType] ADD CONSTRAINT [PK_pStyleActivityType] PRIMARY KEY CLUSTERED  ([StyleActivityTypeId])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rReportMaterialRequestSubmitItem]'
GO
CREATE TABLE [dbo].[rReportMaterialRequestSubmitItem]
(
[ReportMaterialRequestSubmitPageID] [uniqueidentifier] NOT NULL ROWGUIDCOL,
[ReportMaterialRequestSubmitFolderID] [uniqueidentifier] NULL,
[ReportPageTypeID] [uniqueidentifier] NULL,
[ReportTemplateName] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ReportPageName] [nvarchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ReportPageDescription] [nvarchar] (4000) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ReportServerType] [varchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ReportFormName] [varchar] (250) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ReportPageURL] [varchar] (250) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ReportPKIField] [varchar] (200) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ReportPageActive] [int] NULL,
[ReportPageFormat] [varchar] (5) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[ReportPageApproved] [int] NOT NULL,
[ReportPageSort] [varchar] (4) COLLATE SQL_Latin1_General_CP1_CI_AS NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_rReportMaterialRequestSubmitItem] on [dbo].[rReportMaterialRequestSubmitItem]'
GO
ALTER TABLE [dbo].[rReportMaterialRequestSubmitItem] ADD CONSTRAINT [PK_rReportMaterialRequestSubmitItem] PRIMARY KEY CLUSTERED  ([ReportMaterialRequestSubmitPageID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[sOverrideSPX]'
GO
CREATE TABLE [dbo].[sOverrideSPX]
(
[OriginalSPX] [nvarchar] (256) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
[FormName] [nvarchar] (256) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
[Override] [nvarchar] (256) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[sOverrideVWX]'
GO
CREATE TABLE [dbo].[sOverrideVWX]
(
[OriginalVWX] [nvarchar] (256) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
[FormName] [nvarchar] (256) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
[Override] [nvarchar] (256) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[sVersion]'
GO
CREATE TABLE [dbo].[sVersion]
(
[AppName] [nvarchar] (32) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[Version] [nvarchar] (32) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[LastScriptRun] [nvarchar] (32) COLLATE SQL_Latin1_General_CP1_CI_AS NULL,
[TimeStamp] [datetime] NULL
)
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Material_LabdipSubmit_SELECT]'
GO
/*
Comments:

#01 - Ryan Cabanas - July 6, 2009
	The following fields no longer exist in the 'pMaterialTradePartnerLabDipSubmit' table,
so they have been removed from the SELECT.
	+ MaterialTradePartnerLabDipItemID
	+ MaterialTradePartnerLabDipID
	+ MaterialColorID
	+ MaterialID
	+ TradePartnerVendorID
	+ TradePartnerID
	+ Submit
	+ Status
*/


ALTER  PROCEDURE [dbo].[spx_Material_LabdipSubmit_SELECT]
(
@MaterialTradePartnerLabDipSubmitID uniqueidentifier
)
AS 

SELECT MaterialTradePartnerLabDipSubmitID, MaterialTradePartnerColorId, 
	AssignedTo, StartDate, RecDate, RecBy, RecCarrier, RecTrackNo, 
	RecWeight, VendorWeight, VendorDate, VendorName, SubmitDays, ResubmitDays, DueDate, RevDate, RevBy, EndDate, EndBy, CUser, CDate, MUser, 
	MDate, AgentView
FROM pMaterialTradePartnerLabDipSubmit
WHERE MaterialTradePartnerLabDipSubmitID  = @MaterialTradePartnerLabDipSubmitID    




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_Material_AgentVendorTestingSubmit_UPDATE]'
GO





ALTER PROCEDURE [dbo].[spx_Material_AgentVendorTestingSubmit_UPDATE] (
	@MaterialTradePartnerTestingSubmitID UNIQUEIDENTIFIER 
)
AS 

DECLARE @MaterialTradePartnerVendorID UNIQUEIDENTIFIER 
DECLARE @Submit INT 
DECLARE @TestingTypeID  INT 
DECLARE @Status INT
DECLARE @CUser NVARCHAR (200) 
DECLARE @CDate DATETIME 


SELECT @MaterialTradePartnerVendorID = MaterialTradePartnerVendorID, @Submit = Submit,
@TestingTypeID = TestingTypeID  , @Status = Status, 
@CUser = CUser, @CDate = CDate 
FROM  pMaterialTradePartnerTestingSubmit
WHERE MaterialTradePartnerTestingSubmitID = @MaterialTradePartnerTestingSubmitID 



UPDATE pMaterialTradePartnerTestingSubmitItem SET
MaterialTradePartnerVendorID = @MaterialTradePartnerVendorID,
Submit = @Submit,
TestingTypeID = @TestingTypeID ,
Status = @Status, 
CUser = @CUser, 
CDate = @CDate 
WHERE Submit = @Submit
AND MaterialTradePartnerTestingSubmitID = @MaterialTradePartnerTestingSubmitID


-- RESUBMIT
IF  @Status = 1 
BEGIN

	INSERT INTO  pMaterialTradePartnerTestingSubmitItem 
	( MaterialTradePartnerTestingSubmitItemID , MaterialTradePartnerTestingSubmitID, 
	MaterialTradePartnerVendorID, Submit, TestingTypeID, Status, CDate, CUser, MDate, MUser)
	VALUES (NEWID(), @MaterialTradePartnerTestingSubmitID, 
	@MaterialTradePartnerVendorID, @Submit + 1 , @TestingTypeID, 0, @CDate, @CUser, @CDate, @CUser) 


	UPDATE pMaterialTradePartnerTestingSubmit  
	SET Submit = @Submit + 1 ,
	Status = 0 
	WHERE MaterialTradePartnerTestingSubmitID = @MaterialTradePartnerTestingSubmitID


END 





















GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleCostingContainerLogic_UPDATE]'
GO


ALTER PROCEDURE [dbo].[spx_StyleCostingContainerLogic_UPDATE] (
@StyleCostingID uniqueidentifier,
@StyleSeasonYearID UNIQUEIDENTIFIER 
)
AS 

/***********************************************
New statements added by Ryan Cabanas on 8/26/08.
************************************************/

DECLARE @DUMMY INT 
--SELECT 1


/************************************************************
Original statements commented out by Ryan Cabanas on 8/26/08.
*************************************************************/

--DECLARE @StyleQuoteDutyId uniqueidentifier
--DECLARE @TradePartnerID uniqueidentifier
--DECLARE @TradePartnerVendorID uniqueidentifier
--DECLARE @GarmentWgt decimal(19,3) 
--DECLARE @AvgFirstCost decimal(19,3) 
--DECLARE @RetailCost decimal(19,3) 
--DECLARE @MiscCost  decimal(19,3) 
--DECLARE @RoyaltyPerc decimal(19,3) 
--DECLARE @RoyaltyCode int
--DECLARE @VariancePerc decimal(19,3) 
--DECLARE @DutyPerc decimal(19,3) 
--DECLARE @Surcharge decimal(19,3) 
--DECLARE @BrokerHarborFee decimal(19,3) 
--DECLARE @CountryCode varchar(50) 
--DECLARE @StyleCostingType int
--DECLARE @TradePartnerState varchar(2)
--DECLARE @FreightCost decimal(18,3) --StyleCostingCustomField7
--DECLARE @CartonDimension varchar(3)--StyleCostingCustomField20 
--DECLARE @CartonHeight decimal(19,3) --StyleCostingCustomField21
--DECLARE @CartonLeght decimal(19,3)  --StyleCostingCustomField22
--DECLARE @CartonWidth decimal(19,3)  --StyleCostingCustomField23
--DECLARE @UnitPerCarton decimal(19,3) --StyleCostingCustomField24
--DECLARE @VolCubicFeet decimal(19,3) --StyleCostingCustomField25
--DECLARE @ContainerSize varchar(10)  --StyleCostingCustomField26
--DECLARE @FrtType int --StyleCostingCustomField5
--
--DECLARE @NumberOfUnit decimal(19,3)
--DECLARE @HomeCost varchar(10)
--
--
--DECLARE @PrefImportVariance decimal(19,3)
--DECLARE @PrefDomesticVariance decimal(19,3)
--DECLARE @PrefIndirectVariance decimal(19,3)
--DECLARE @PrefContainerSizeInCft20 decimal(19,3)
--DECLARE @PrefContainerSizeInCft40 decimal(19,3)
--DECLARE @PrefContainerSizeInCftLCL decimal(19,3)
--DECLARE @PrefContainerRateInCft20 decimal(19,3)
--DECLARE @PrefContainerRateInCft40 decimal(19,3)
--DECLARE @PrefContainerRateInCftLCL decimal(19,3)
--DECLARE @PrefAirRatePerLb decimal(19,3)
--
--SELECT	@PrefImportVariance = ImportVariance, 
--		@PrefDomesticVariance = DomesticVariance, 
--		@PrefIndirectVariance = IndirectVariance, 
--		@PrefContainerRateInCftLCL = ContainerRatePrefLCLCft,
--		@PrefContainerRateInCft20 = ContainerRatePref20Cft,
--		@PrefContainerRateInCft40 = ContainerRatePref40Cft,
--		@PrefContainerSizeInCft20 = ContainerSizePref20Cft,
--		@PrefContainerSizeInCft40 = ContainerSizePref40Cft,
--		@PrefContainerSizeInCftLCL = 0,
--		@PrefAirRatePerLb = AirCharge
--FROM pStyleCostingPreference
--
--
--SELECT 
--	@StyleQuoteDutyId = ISNULL(StyleQuotaDutyId,'{00000000-0000-0000-0000-000000000000}'),
--	@FrtType = StyleCostingCustomField5,
--	@MiscCost = ISNULL(StyleCostingCustomField4,0),
--	@RoyaltyPerc = ISNULL(StyleCostingCustomField8,0),
--	@VariancePerc = ISNULL(StyleCostingCustomField10,0),
--	@DutyPerc = ISNULL(StyleCostingCustomField11,0),
--	@Surcharge = ISNULL(StyleCostingCustomField12,0),
--	@GarmentWgt = ISNULL(StyleCostingCustomField2,0),
--	@FreightCost = ISNULL(StyleCostingCustomField7,0),
--	@BrokerHarborFee = ISNULL(StyleCostingCustomField13,0), 
--	@NumberOfUnit = ISNULL(StyleCostingCustomField18,0),
--	@CartonDimension = StyleCostingCustomField20, 
--	@CartonHeight = ISNULL(StyleCostingCustomField21,0),
--	@CartonLeght = ISNULL(StyleCostingCustomField22,0), 
--	@CartonWidth = ISNULL(StyleCostingCustomField23,0),
--	@UnitPerCarton = ISNULL(StyleCostingCustomField24,0),
--	@VolCubicFeet = ISNULL(StyleCostingCustomField25,0),
--	@ContainerSize = ISNULL(StyleCostingCustomField26,0)
--FROM  dbo.pStyleCosting
--WHERE  (StyleCostingID = @StyleCostingID)
--
--
--IF @FrtType = 2
--BEGIN
--	DECLARE @FirstCostByVolume decimal(19,3) 
--
--	SELECT 
--	@DutyPerc = DutyPerc, 
--	@Surcharge = DutySurcharge
--	FROM pStyleCostingDuty 
--	WHERE DutyId = @StyleQuoteDutyId
--
--		
--		DECLARE @AirCostperUnit decimal(19,3)
--		
--		DECLARE @AirCartonDimension decimal(19,3)
--		SET @AirCartonDimension = (@CartonHeight * @CartonLeght * @CartonWidth)	
--		
--		DECLARE @CartonVolumeInLbs decimal(19,3)
--		SET @CartonVolumeInLbs = @AirCartonDimension / 166
--		
--		DECLARE @AirFreightCostPerCarton decimal(19,3)
--		SET @AirFreightCostPerCarton = (@CartonVolumeInLbs) *  (@PrefAirRatePerLb * 16) 
--
--		--SET @AirCostperUnit = (@PrefAirRatePerLb * 16) * (@AirCartonDimension) / (@UnitPerCarton * 166)
--
--		SELECT @PrefAirRatePerLb AS AirRate, @AirCartonDimension AS AirCartonDimension, @AirFreightCostPerCarton AS AirFreightCostPerCarton, @AirCostperUnit AS  AirCostperUnit1 
--
--		
--		DECLARE @BoatCostperUnit decimal(19,3)
--		DECLARE @CartonVolumeInCft decimal(19,3)	
--		
--		DECLARE @BoatCartonDimension decimal(19,3)
--		SET @BoatCartonDimension = (@CartonHeight * @CartonLeght * @CartonWidth)
--		
--		
--		DECLARE @BoatCostPerCarton decimal(19,3)
--
--		DECLARE @ContainerPerc decimal(19,5)
--		DECLARE @CartonInContainer decimal(19,5)
--		DECLARE @CartonVolumeCountryCftRate decimal(19,4)
--		DECLARE @PrefContainerSizeInCft decimal(19,4)
--		
--		BEGIN
--		IF @ContainerSize = '0' SET @CartonVolumeCountryCftRate = @PrefContainerRateInCftLCL 
--		IF @ContainerSize = '40' SET @CartonVolumeCountryCftRate = @PrefContainerRateInCft40 
--		IF @ContainerSize = '20' SET @CartonVolumeCountryCftRate = @PrefContainerRateInCft20
--		END
--		
--		BEGIN
--		IF @ContainerSize = '0' SET @PrefContainerSizeInCft = @PrefContainerSizeInCftLCL
--		IF @ContainerSize = '40' SET @PrefContainerSizeInCft = @PrefContainerSizeInCft40
--		IF @ContainerSize = '20' SET @PrefContainerSizeInCft = @PrefContainerSizeInCft20
--		END
--		
--		SELECT @ContainerSize AS ContainerSize
--		SELECT @CartonDimension AS Dimension
--		
--		IF @CartonDimension = 'IN'
--		BEGIN
--			
--			SET @CartonVolumeInCft = (@BoatCartonDimension / 1728)
--			SET @BoatCostperUnit = @BoatCostPerCarton / @UnitPerCarton
--			
--			SET @BoatCostPerCarton = @FreightCost * @UnitPerCarton --@CartonVolumeInCft * @CartonVolumeCountryCftRate 
--			SET @BoatCostPerUnit = @CartonVolumeInCft * @CartonVolumeCountryCftRate --@CostPercarton / @UnitPerCarton
--			
--			IF @PrefContainerSizeInCft <> 0 SET @ContainerPerc = (@CartonVolumeInCft * @NumberOfUnit * (1/@UnitPerCarton)) / @PrefContainerSizeInCft
--			
--			SELECT @NumberOfUnit AS NumberofUnit, @ContainerPerc AS CartonPerc, @UnitPerCarton AS UnitPerCarton, @PrefContainerSizeInCft AS PrefContainerSizeInCft, @CartonVolumeInCft AS CartonVolumeInCft, @BoatCostPerCarton AS CostPercarton, @BoatCostPerUnit AS BoatCostPerUnit 
--		END	
--
--		
--		IF @CartonDimension = 'CM'
--		BEGIN
--			
--			SET @CartonVolumeInCft = (@BoatCartonDimension / 16.38) / 1728
--			SET @BoatCostperUnit = @BoatCostPerCarton / @UnitPerCarton
--			
--			SET @BoatCostPerCarton = @FreightCost * @UnitPerCarton --@CartonVolumeInCft * @CartonVolumeCountryCftRate 
--			SET @BoatCostPerUnit = @CartonVolumeInCft * @CartonVolumeCountryCftRate --@CostPercarton / @UnitPerCarton
--			
--			IF @PrefContainerSizeInCft <> 0 SET @ContainerPerc = (@CartonVolumeInCft * @NumberOfUnit * (1/@UnitPerCarton)) / @PrefContainerSizeInCft
--			
--			SELECT @NumberOfUnit AS NumberofUnit, @ContainerPerc AS CartonPerc, @UnitPerCarton AS UnitPerCarton, @CartonVolumeCountryCftRate AS PrefContainerRateInCft, @PrefContainerSizeInCft AS PrefContainerSizeInCft, @CartonVolumeInCft AS CartonVolumeInCft, @BoatCostPerCarton AS CostPercarton, @BoatCostPerUnit AS BoatCostPerUnit 
--		END	
--
--		
--		BEGIN
--			UPDATE pStyleCosting SET 
--				StyleCostingCustomField7 = @BoatCostPerUnit / @UnitPerCarton,
--				StyleCostingCustomField25 = @CartonVolumeInCft,	
--				StyleCostingCustomField27 = @ContainerPerc,		
--				StyleCostingCustomField28 = @BoatCostPerCarton,		
--				StyleCostingCustomField29 = @BoatCostperUnit,		
--				StyleCostingCustomField30 = @AirFreightCostPerCarton						
--			WHERE StyleCostingID = @StyleCostingID
--		END
--END	


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleRequestGridAgentStyleShared_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_SampleRequestGridAgentStyleShared_SELECT] 
(
@StyleID varchar(50),
@TradePartnerAgentID varchar(50),
@TradePartnerVendorID varchar(50)
)
AS

if object_id('tempdb..##tmpSampleStyleWorkflow') is not null 
BEGIN
	DROP TABLE ##tmpSampleStyleWorkflow
END

DECLARE @UserID varchar(10), @sql varchar(8000), @delim varchar(1), @select varchar(8000), @enddate varchar(100), @duedate varchar(100), @pivot varchar(100), @table varchar(100)

SET NOCOUNT ON
SET ANSI_WARNINGS OFF

SELECT @select = 'SELECT pSampleRequestWorkflow.SampleRequestTradeID,uTradePartner.TradePartnerName, uTradePartnerVendor.VendorName,
pStyleHeader.StyleNo, pStyleHeader.Description, pStyleHeader.SizeClass AS [SizeClass],  
CASE 
WHEN pSampleRequestWorkflow.StyleSet = 1 THEN 
	CASE WHEN pStyleHeader.PC1 Is Not Null THEN pStyleHeader.PC1 ELSE ''1st Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 2 THEN 
	CASE WHEN pStyleHeader.PC2 Is Not Null THEN pStyleHeader.PC2 ELSE ''2nd Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 3 THEN 
	CASE WHEN pStyleHeader.PC3 Is Not Null THEN pStyleHeader.PC3 ELSE ''3rd Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 4 THEN 
	CASE WHEN pStyleHeader.PC4 Is Not Null THEN pStyleHeader.PC4 ELSE ''4th Set'' END 
END AS [Style Set], ISNULL(pStyleColorway.MainColor,''NA'') AS Color,  pSampleRequestWorkflow.StyleSet , dbo.pStyleHeader.DueDate AS [Tech Pack] FROM  dbo.pSampleRequestWorkflow WITH (NOLOCK) INNER JOIN
    dbo.pStyleHeader WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.StyleID = dbo.pStyleHeader.StyleID INNER JOIN
    dbo.uTradePartner WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.TradePartnerID = dbo.uTradePartner.TradePartnerID INNER JOIN
    dbo.uTradePartnerVendor WITH (NOLOCK) ON 
    dbo.pSampleRequestWorkflow.TradePartnerVendorID = dbo.uTradePartnerVendor.TradePartnerVendorID LEFT OUTER JOIN
    dbo.pStyleColorway WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.StyleColorID = dbo.pStyleColorway.StyleColorID
GROUP BY dbo.pSampleRequestWorkflow.SampleRequestTradeID, dbo.pSampleRequestWorkflow.StyleID, dbo.pSampleRequestWorkflow.StyleColorID, 
    dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.SizeRange, dbo.pStyleHeader.Description, 
    dbo.pStyleHeader.Pc1, dbo.pStyleHeader.Pc2, dbo.pStyleHeader.Pc3, dbo.pStyleHeader.Pc4, pStyleHeader.SizeClass,
    dbo.pSampleRequestWorkflow.TradePartnerID, dbo.pSampleRequestWorkflow.TradePartnerVendorID, dbo.pStyleColorway.MainColor, 
    dbo.uTradePartner.TradePartnerName, dbo.uTradePartnerVendor.VendorName,  dbo.pStyleHeader.StyleID, dbo.pStyleHeader.DueDate
HAVING   dbo.pStyleHeader.StyleID = ''' + @StyleID + '''' 


IF @TradePartnerVendorID IS NOT NULL SELECT @select = @select + ' AND pSampleRequestWorkflow.TradePartnerVendorID = ''' + @TradePartnerVendorID + ''''  
IF @TradePartnerAgentID IS NOT NULL SELECT @select = @select + ' AND pSampleRequestWorkflow.TradePartnerID = ''' + @TradePartnerAgentID + ''''  
--IF @StyleDescription IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.Description LIKE ''%' + @StyleDescription + '%''' 
--IF @Season IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.' + @CustomFieldSeason + ' = ''' + @Season + '''' 
--IF @Year IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.' + @CustomFieldYear + ' = ''' + @Year + '''' 

SELECT @select = @select + ' ORDER BY uTradePartnerVendor.VendorName, pStyleHeader.StyleNo, pSampleRequestWorkflow.StyleSet, pStyleColorway.MainColor '

SELECT @enddate = 'MAX(pSampleRequestWorkflow.EndDate)'
SELECT @duedate = 'MAX(pSampleRequestWorkflow.DueDate)'
SELECT @pivot = 'pSampleRequestWorkflow.SampleWorkflowID'
SELECt @table = 'pSampleRequestWorkflow WITH (NOLOCK)'

EXEC ('SELECT ' + @pivot + ' AS tb_pivot INTO ##tmpSampleStyleWorkflow FROM ' + @table + ' WHERE 1=2')
EXEC ('INSERT INTO ##tmpSampleStyleWorkflow SELECT DISTINCT ' + @pivot + ' FROM ' + @table + ' WHERE ' + @pivot + ' Is Not Null AND  StyleID = ''' + @StyleID + '''') 

SELECT @sql='',  @duedate=stuff(@duedate, len(@duedate), 1, ' END)' )
SELECT @sql=@sql + '',  @enddate=stuff(@enddate, len(@enddate), 1, ' END)' )

SELECT @delim=CASE Sign( CharIndex('char', data_type) + CharIndex('date', data_type) ) 
WHEN 0 THEN '''' ELSE '''' END 
FROM tempdb.information_schema.columns 
WHERE table_name='##tmpSampleStyleWorkflow' AND column_name='tb_pivot'

SELECT @sql=@sql + '''D_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@duedate,charindex( '(', @duedate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
+ '''E_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@enddate,charindex( '(', @enddate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
FROM ##tmpSampleStyleWorkflow

SELECT @sql=left(@sql, len(@sql)-1)

SELECT @select=stuff(@select, charindex(' FROM ', @select)+1, 0, ', ' + @sql + ' ')

DROP TABLE ##tmpSampleStyleWorkflow

PRINT @select


EXEC (@select)




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleRequestGrid_Style_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_SampleRequestGrid_Style_SELECT] 
(
@DevelopmentID varchar(50),
@StyleID varchar(50),
@TradePartnerAgentID varchar(50),
@TradePartnerVendorID varchar(50)
)
AS

if object_id('tempdb..##tmpSampleStyleWorkflow') is not null 
BEGIN
	DROP TABLE ##tmpSampleStyleWorkflow
END

DECLARE @UserID varchar(10), @sql varchar(8000), @delim varchar(1), @select varchar(8000), @enddate varchar(100), @duedate varchar(100), @pivot varchar(100), @table varchar(100)

SET NOCOUNT ON
SET ANSI_WARNINGS OFF

SELECT @select = 'SELECT a.SampleRequestTradeID,uTradePartner.TradePartnerName, uTradePartnerVendor.VendorName,
pStyleHeader.StyleNo, pStyleHeader.Description, pStyleHeader.SizeClass AS [SizeClass], 
CASE 
WHEN a.StyleSet = 1 THEN 
	CASE WHEN pStyleHeader.PC1 Is Not Null THEN pStyleHeader.PC1 ELSE ''1st Set'' END
WHEN a.StyleSet = 2 THEN 
	CASE WHEN pStyleHeader.PC2 Is Not Null THEN pStyleHeader.PC2 ELSE ''2nd Set'' END
WHEN a.StyleSet = 3 THEN 
	CASE WHEN pStyleHeader.PC3 Is Not Null THEN pStyleHeader.PC3 ELSE ''3rd Set'' END
WHEN a.StyleSet = 4 THEN 
	CASE WHEN pStyleHeader.PC4 Is Not Null THEN pStyleHeader.PC4 ELSE ''4th Set'' END 
END AS [StyleSet], ISNULL(pStyleColorway.MainColor,''NA'') AS Color, pStyleHeader.DueDate AS [Tech Pack]  FROM  pSampleRequestWorkflow a WITH (NOLOCK) INNER JOIN
    pStyleHeader WITH (NOLOCK) ON a.StyleID = pStyleHeader.StyleID INNER JOIN
    uTradePartner WITH (NOLOCK) ON a.TradePartnerID = uTradePartner.TradePartnerID INNER JOIN
    uTradePartnerVendor WITH (NOLOCK) ON 
    a.TradePartnerVendorID = uTradePartnerVendor.TradePartnerVendorID LEFT OUTER JOIN
    pStyleColorway WITH (NOLOCK) ON a.StyleColorID = pStyleColorway.StyleColorID  INNER JOIN

   pSampleRequestTrade ON pSampleRequestTrade.SampleRequestTradeID = a.SampleRequestTradeID

GROUP BY a.SampleRequestTradeID, a.StyleID, a.StyleColorID, 
    a.StyleSet, pStyleHeader.StyleNo, pStyleHeader.SizeRange, pStyleHeader.Description, 
    pStyleHeader.Pc1, pStyleHeader.Pc2, pStyleHeader.Pc3, pStyleHeader.Pc4, pStyleHeader.SizeClass,
    a.TradePartnerID, a.TradePartnerVendorID, pStyleColorway.MainColor, 
    uTradePartner.TradePartnerName, uTradePartnerVendor.VendorName,  pStyleHeader.DevelopmentID, pStyleHeader.DueDate ,  pStyleHeader.StyleID ,  pSampleRequestTrade.TechPackID
HAVING   pStyleHeader.DevelopmentID = ''' + @DevelopmentID + '''' 


IF @TradePartnerVendorID IS NOT NULL SELECT @select = @select + ' AND a.TradePartnerVendorID = ''' + @TradePartnerVendorID + ''''  
IF @TradePartnerAgentID IS NOT NULL SELECT @select = @select + ' AND a.TradePartnerID = ''' + @TradePartnerAgentID + ''''  
IF @StyleID IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.StyleID = ''' + @StyleID + '''' 
--IF @StyleDescription IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.Description LIKE ''%' + @StyleDescription + '%''' 
--IF @Season IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.' + @CustomFieldSeason + ' = ''' + @Season + '''' 
--IF @Year IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.' + @CustomFieldYear + ' = ''' + @Year + '''' 

SELECT @select = @select + ' ORDER BY uTradePartnerVendor.VendorName, pStyleHeader.StyleNo, a.StyleSet, pStyleColorway.MainColor '

SELECT @enddate = 'MAX(a.EndDate)'
SELECT @duedate = 'MAX(a.DueDate)'
SELECT @pivot = 'a.SampleWorkflowID'
SELECt @table = 'pSampleRequestWorkflow WITH (NOLOCK)'

/*
EXEC ('SELECT ' + @pivot + ' AS pivot INTO ##tmpSampleStyleWorkflow FROM ' + @table + ' WHERE 1=2')
EXEC ('INSERT INTO ##tmpSampleStyleWorkflow SELECT DISTINCT ' + @pivot + ' FROM ' + @table + ' WHERE ' + @pivot + ' Is Not Null AND  StyleID IN (SELECT StyleID FROM pStyleHeader WHERE DevelopmentID = ''' + @DevelopmentID + ''')') 
*/

EXEC ('SELECT ' + @pivot + ' AS tb_pivot, ''0000'' AS SampleWorkflowSort  INTO ##tmpSampleStyleWorkflow FROM pSampleRequestWorkflow  a WITH (NOLOCK) WHERE 1=2')
EXEC ('INSERT INTO ##tmpSampleStyleWorkflow SELECT DISTINCT ' + @pivot + ' ,  c.SampleWorkflowSort  FROM  pSampleRequestWorkflow a WITH (NOLOCK) , pSampleWorkflow c WITH (NOLOCK)  WHERE ' + 
@pivot + ' Is Not Null AND  StyleID IN (SELECT StyleID FROM pStyleHeader WITH (NOLOCK) WHERE DevelopmentID = ''' + @DevelopmentID + ''')   AND  a.SampleWorkflowID = c.SampleWorkflowID ORDER BY  c.SampleWorkflowSort '      ) 



SELECT @sql='',  @duedate=stuff(@duedate, len(@duedate), 1, ' END)' )
SELECT @sql=@sql + '',  @enddate=stuff(@enddate, len(@enddate), 1, ' END)' )

SELECT @delim=CASE Sign( CharIndex('char', data_type) + CharIndex('date', data_type) ) 
WHEN 0 THEN '''' ELSE '''' END 
FROM tempdb.information_schema.columns 
WHERE table_name='##tmpSampleStyleWorkflow' AND column_name='tb_pivot'

SELECT @sql=@sql + '''D_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@duedate,charindex( '(', @duedate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
+ '''E_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@enddate,charindex( '(', @enddate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
FROM ##tmpSampleStyleWorkflow

SELECT @sql=left(@sql, len(@sql)-1)

SELECT @select=stuff(@select, charindex(' FROM ', @select)+1, 0, ', ' + @sql + '  , pSampleRequestTrade.TechPackID ' )  
-- ,  pSampleRequestTrade.TechPackID , pSampleRequestWorkflow.StyleID

DROP TABLE ##tmpSampleStyleWorkflow

PRINT @select


EXEC (@select)


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleWorkflowItem_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_SampleWorkflowItem_SELECT] 

AS

DECLARE @sql varchar(8000), @delim varchar(1), @select varchar(8000), @enddate varchar(100), @duedate varchar(100), @pivot varchar(100), @table varchar(100)
SET NOCOUNT ON
SET ANSI_WARNINGS OFF

SELECT @select = 'SELECT StyleID FROM pSampleRequestWorkflow GROUP BY StyleID'
SELECT @enddate = 'MAX(EndDate)'
SELECT @duedate = 'MAX(DueDate)'
SELECT @pivot = 'SampleWorkflowID'
SELECt @table = 'pSampleRequestWorkflow WITH (NOLOCK)'

EXEC ('SELECT ' + @pivot + ' AS tb_pivot INTO ##SampleWorkflow FROM ' + @table + ' WHERE 1=2')
EXEC ('INSERT INTO ##SampleWorkflow SELECT DISTINCT ' + @pivot + ' FROM ' + @table + ' WHERE ' 
+ @pivot + ' Is Not Null')

--SELECT * FROM ##SampleWorkflow


SELECT @sql='',  @duedate=stuff(@duedate, len(@duedate), 1, ' END)' )
SELECT @sql=@sql + '',  @enddate=stuff(@enddate, len(@enddate), 1, ' END)' )

SELECT @delim=CASE Sign( CharIndex('char', data_type) + CharIndex('date', data_type) ) 
WHEN 0 THEN '''' ELSE '''' END 
FROM tempdb.information_schema.columns 
WHERE table_name='##SampleWorkflow' AND column_name='tb_pivot'

SELECT @sql=@sql + '''D_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@duedate,charindex( '(', @duedate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
+ '''E_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@enddate,charindex( '(', @enddate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
FROM ##SampleWorkflow

SELECT @sql=left(@sql, len(@sql)-1)
SELECT @select=stuff(@select, charindex(' FROM ', @select)+1, 0, ', ' + @sql + ' ')


DROP TABLE ##SampleWorkflow


EXEC (@select)
--SELECT @sql
--SELECT (@select)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleRequestWorkflowItem_SELECT]'
GO
ALTER PROCEDURE  [dbo].[spx_SampleRequestWorkflowItem_SELECT] 
(
--@QuoteFolderID uniqueidentifier = '00000000-0000-0000-0000-000000000000',
--@QuoteFolderItemID uniqueidentifier = '00000000-0000-0000-0000-000000000000',
@StyleID uniqueidentifier = '00000000-0000-0000-0000-000000000000'
)
AS

DECLARE @sql varchar(8000), @delim varchar(1), @select varchar(8000), @row varchar(100), @pivot varchar(100), @table varchar(100)
SET NOCOUNT ON
SET ANSI_WARNINGS OFF

SELECT @select = 'SELECT Workflow FROM pSampleRequestWorkflowItem WITH (NOLOCK) GROUP BY Workflow'
SELECT @row = 'MAX(StyleSet)'

SELECT @pivot = 'SampleWorkflowID'
SELECt @table = 'pSampleRequestWorkflowItem'

EXEC ('SELECT SampleWorkflowID As tb_pivot INTO ##SampleWorkflowItem FROM pSampleRequestWorkflowItem WITH (NOLOCK) WHERE 1=2')
EXEC ('INSERT INTO ##SampleWorkflowItem SELECT DISTINCT SampleWorkflowID FROM pSampleRequestWorkflowItem WITH (NOLOCK) WHERE  SampleWorkflowID Is Not Null ')

--EXEC ('SELECT ' + @pivot + ' AS tb_pivot INTO ##SampleWorkflowItem FROM ' + @table + ' WHERE 1=2')
--EXEC ('INSERT INTO ##SampleWorkflowItem SELECT DISTINCT ' + @pivot + ' FROM ' + @table + ' WHERE ' 
--+ @pivot + ' Is Not Null ')

--SELECT DISTINCT SampleWorkflowID FROM pSampleRequestWorkflowItem WITH (NOLOCK) WHERE  SampleWorkflowID = '1A'

--SELECT * FROM  ##SampleWorkflowItem

SELECT @sql='',  @row=stuff(@row, len(@row), 1, ' END)' )
--SELECT @sql=@sql + '',  @enddate=stuff(@enddate, len(@enddate), 1, ' END)' )

SELECT @delim=CASE Sign( CharIndex('char', data_type) + CharIndex('date', data_type) ) 
WHEN 0 THEN '''' ELSE '''' END 
FROM tempdb.information_schema.columns 
WHERE table_name='##SampleWorkflowItem' AND column_name='tb_pivot'


SELECT @sql=@sql + '''' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@row,charindex( '(', @row )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' FROM ##SampleWorkflowItem


SELECT @sql=left(@sql, len(@sql)-1)
SELECT @select=stuff(@select, charindex(' FROM ', @select)+1, 0, ', ' + @sql + ' ')


DROP TABLE ##SampleWorkflowItem


EXEC (@select)
--SELECT @sql
--SELECT (@select)


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleRequestGrid_All_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_SampleRequestGrid_All_SELECT] 
(
@CustomFieldSeason varchar(100),
@CustomFieldYear varchar(100),
@StyleNo nvarchar(200),
@StyleDescription nvarchar(200),
@Season nvarchar(100),
@Year nvarchar(100),
@TradePartnerAgentID varchar(50),
@TradePartnerVendorID varchar(50)
)
AS

DECLARE @UserID varchar(10), @sql varchar(8000), @delim varchar(1), @select varchar(8000), @enddate varchar(100), @duedate varchar(100), @pivot varchar(100), @table varchar(100)

SET NOCOUNT ON
SET ANSI_WARNINGS OFF

SELECT @select = 'SELECT pSampleRequestWorkflow.SampleRequestTradeID, 
pSampleRequestWorkflow.StyleColorID, pSampleRequestWorkflow.StyleID, 
pSampleRequestWorkflow.StyleSet, pStyleHeader.StyleNo AS [Style No], 
pStyleHeader.SizeRange AS [Size], pStyleHeader.Description, 
CASE 
WHEN pSampleRequestWorkflow.StyleSet = 1 THEN 
	CASE WHEN pStyleHeader.PC1 Is Not Null THEN pStyleHeader.PC1 ELSE ''1st Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 2 THEN 
	CASE WHEN pStyleHeader.PC2 Is Not Null THEN pStyleHeader.PC2 ELSE ''2nd Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 3 THEN 
	CASE WHEN pStyleHeader.PC3 Is Not Null THEN pStyleHeader.PC3 ELSE ''3rd Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 4 THEN 
	CASE WHEN pStyleHeader.PC4 Is Not Null THEN pStyleHeader.PC4 ELSE ''4th Set'' END 
END AS [Style Set], pStyleColorway.MainColor AS Color FROM pSampleRequestWorkflow WITH (NOLOCK) INNER JOIN 
pStyleHeader WITH (NOLOCK) ON pSampleRequestWorkflow.StyleID = pStyleHeader.StyleID INNER JOIN 
pStyleColorway WITH (NOLOCK) ON pSampleRequestWorkflow.StyleColorID = pStyleColorway.StyleColorID
GROUP BY pSampleRequestWorkflow.SampleRequestTradeID, pSampleRequestWorkflow.StyleID, pSampleRequestWorkflow.StyleColorID, 
pSampleRequestWorkflow.StyleSet, pStyleHeader.StyleNo, pStyleHeader.SizeRange, pStyleHeader.Description, 
pSampleRequestWorkflow.StyleSet, pStyleHeader.Pc1, pStyleHeader.Pc2, pStyleHeader.Pc3, pStyleHeader.Pc4, 
pSampleRequestWorkflow.TradePartnerID, pSampleRequestWorkflow.TradePartnerVendorID, pStyleColorway.MainColor, 
pStyleHeader.' + @CustomFieldSeason + ', pStyleHeader.' + @CustomFieldYear + '
HAVING pSampleRequestWorkflow.TradePartnerVendorID IS NOT NULL '

IF @TradePartnerVendorID IS NOT NULL SELECT @select = @select + ' AND pSampleRequestWorkflow.TradePartnerVendorID = ''' + @TradePartnerVendorID + ''''  
IF @TradePartnerAgentID IS NOT NULL SELECT @select = @select + ' AND pSampleRequestWorkflow.TradePartnerID = ''' + @TradePartnerAgentID + ''''  
IF @StyleNo IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.StyleNo LIKE ''%' + @StyleNo + '%''' 
IF @StyleDescription IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.Description LIKE ''%' + @StyleDescription + '%''' 
IF @Season IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.' + @CustomFieldSeason + ' = ''' + @Season + '''' 
IF @Year IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.' + @CustomFieldYear + ' = ''' + @Year + '''' 

SELECT @select = @select + ' ORDER BY pStyleHeader.StyleNo, pSampleRequestWorkflow.StyleSet '

SELECT @enddate = 'MAX(pSampleRequestWorkflow.EndDate)'
SELECT @duedate = 'MAX(pSampleRequestWorkflow.DueDate)'
SELECT @pivot = 'pSampleRequestWorkflow.SampleWorkflowID'
SELECt @table = 'pSampleRequestWorkflow WITH (NOLOCK)'

EXEC ('SELECT ' + @pivot + ' AS tb_pivot INTO ##tmpSampleWorkflow FROM ' + @table + ' WHERE 1=2')
EXEC ('INSERT INTO ##tmpSampleWorkflow SELECT DISTINCT ' + @pivot + ' FROM ' + @table + ' WHERE ' + @pivot + ' Is Not Null')

SELECT @sql='',  @duedate=stuff(@duedate, len(@duedate), 1, ' END)' )
SELECT @sql=@sql + '',  @enddate=stuff(@enddate, len(@enddate), 1, ' END)' )

SELECT @delim=CASE Sign( CharIndex('char', data_type) + CharIndex('date', data_type) ) 
WHEN 0 THEN '''' ELSE '''' END 
FROM tempdb.information_schema.columns 
WHERE table_name='##tmpSampleWorkflow' AND column_name='tb_pivot'

SELECT @sql=@sql + '''D_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@duedate,charindex( '(', @duedate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
+ '''E_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@enddate,charindex( '(', @enddate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
FROM ##tmpSampleWorkflow

SELECT @sql=left(@sql, len(@sql)-1)

SELECT @select=stuff(@select, charindex(' FROM ', @select)+1, 0, ', ' + @sql + ' ')

DROP TABLE ##tmpSampleWorkflow

EXEC (@select)


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleRequestGrid_StyleTeam_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_SampleRequestGrid_StyleTeam_SELECT] 
(
@DevelopmentID varchar(50),
@StyleID varchar(50),
@UserID varchar(5),
@TradePartnerAgentID varchar(50),
@TradePartnerVendorID varchar(50)
)
AS

DECLARE @sql varchar(8000), @delim varchar(1), @select varchar(8000), @enddate varchar(100), @duedate varchar(100), @pivot varchar(100), @table varchar(100)

SET NOCOUNT ON
SET ANSI_WARNINGS OFF

SELECT @select = 'SELECT pSampleRequestWorkflow.SampleRequestTradeID,uTradePartner.TradePartnerName, uTradePartnerVendor.VendorName, 	
pStyleHeader.StyleNo, pStyleHeader.Description,  pStyleHeader.SizeClass AS [SizeClass] ,
CASE 
WHEN pSampleRequestWorkflow.StyleSet = 1 THEN 
	CASE WHEN pStyleHeader.PC1 Is Not Null THEN pStyleHeader.PC1 ELSE ''1st Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 2 THEN 
	CASE WHEN pStyleHeader.PC2 Is Not Null THEN pStyleHeader.PC2 ELSE ''2nd Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 3 THEN 
	CASE WHEN pStyleHeader.PC3 Is Not Null THEN pStyleHeader.PC3 ELSE ''3rd Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 4 THEN 
	CASE WHEN pStyleHeader.PC4 Is Not Null THEN pStyleHeader.PC4 ELSE ''4th Set'' END 
END AS [StyleSet],  ISNULL(pStyleColorway.MainColor,''NA'') AS Color , pStyleHeader.DueDate  AS [Tech Pack]  FROM  pSampleRequestWorkflow WITH (NOLOCK) INNER JOIN
pStyleHeader WITH (NOLOCK) ON pSampleRequestWorkflow.StyleID = pStyleHeader.StyleID INNER JOIN
pStyleColorway WITH (NOLOCK) ON pSampleRequestWorkflow.StyleColorID = pStyleColorway.StyleColorID INNER JOIN
uTradePartner WITH (NOLOCK) ON pSampleRequestWorkflow.TradePartnerID = uTradePartner.TradePartnerID INNER JOIN
uTradePartnerVendor WITH (NOLOCK) ON pSampleRequestWorkflow.TradePartnerVendorID = uTradePartnerVendor.TradePartnerVendorID   

  GROUP BY dbo.pSampleRequestWorkflow.SampleRequestTradeID, dbo.pSampleRequestWorkflow.StyleID, dbo.pSampleRequestWorkflow.StyleColorID, 
    dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.SizeRange, dbo.pStyleHeader.Description, 
    dbo.pStyleHeader.Pc1, dbo.pStyleHeader.Pc2, dbo.pStyleHeader.Pc3, dbo.pStyleHeader.Pc4, pStyleHeader.SizeClass,
    dbo.pSampleRequestWorkflow.TradePartnerID, dbo.pSampleRequestWorkflow.TradePartnerVendorID, dbo.pStyleColorway.MainColor, 
    dbo.uTradePartner.TradePartnerName, dbo.uTradePartnerVendor.VendorName,  dbo.pStyleHeader.DevelopmentID, dbo.pStyleHeader.DueDate , 
    dbo.pSampleRequestWorkflow.AssignedTo ,  pStyleHeader.StyleID 
HAVING   pStyleHeader.DevelopmentID = ''' + @DevelopmentID + ''' AND pSampleRequestWorkflow.AssignedTo = ''' + @UserId + ''' ' 




IF @TradePartnerVendorID IS NOT NULL SELECT @select = @select + ' AND pSampleRequestWorkflow.TradePartnerVendorID = ''' + @TradePartnerVendorID + ''''  
IF @TradePartnerAgentID IS NOT NULL SELECT @select = @select + ' AND pSampleRequestWorkflow.TradePartnerID = ''' + @TradePartnerAgentID + ''''  
IF @StyleID IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.StyleID = ''' + @StyleID + '''' 
--IF @StyleDescription IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.Description LIKE ''%' + @StyleDescription + '%''' 
--IF @Season IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.' + @CustomFieldSeason + ' = ''' + @Season + '''' 
--IF @Year IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.' + @CustomFieldYear + ' = ''' + @Year + '''' 

SELECT @select = @select + ' ORDER BY pStyleHeader.StyleNo, pSampleRequestWorkflow.StyleSet, uTradePartner.TradePartnerName, uTradePartnerVendor.VendorName '

SELECT @enddate = 'MAX(pSampleRequestWorkflow.EndDate)'
SELECT @duedate = 'MAX(pSampleRequestWorkflow.DueDate)'
SELECT @pivot = 'pSampleRequestWorkflow.SampleWorkflowID'
SELECt @table = 'pSampleRequestWorkflow WITH (NOLOCK)'


/*
EXEC ('SELECT ' + @pivot + ' AS tb_pivot INTO ##tmpSampleWorkflow FROM ' + @table + ' WHERE 1=2')
EXEC ('INSERT INTO ##tmpSampleWorkflow SELECT DISTINCT ' + @pivot + ' FROM ' + @table + ' WHERE ' + @pivot + ' Is Not Null')
*/



EXEC ('SELECT ' + @pivot + ' AS tb_pivot, ''0000'' AS SampleWorkflowSort  INTO ##tmpSampleWorkflow  FROM ' + @table + ' WHERE 1=2')

EXEC ('INSERT INTO ##tmpSampleWorkflow SELECT DISTINCT ' + @pivot + ' ,  pSampleWorkflow.SampleWorkflowSort  FROM ' + @table + ' , pSampleWorkflow   WHERE ' + 
@pivot + ' Is Not Null AND  StyleID IN (SELECT StyleID FROM pStyleHeader WITH (NOLOCK) WHERE DevelopmentID = ''' + @DevelopmentID + ''')   AND  pSampleRequestWorkflow.SampleWorkflowID = pSampleWorkflow.SampleWorkflowID AND AssignedTo  =  ' + @UserID + '  ORDER BY  pSampleWorkflow.SampleWorkflowSort '      ) 





SELECT @sql='',  @duedate=stuff(@duedate, len(@duedate), 1, ' END)' )
SELECT @sql=@sql + '',  @enddate=stuff(@enddate, len(@enddate), 1, ' END)' )

SELECT @delim=CASE Sign( CharIndex('char', data_type) + CharIndex('date', data_type) ) 
WHEN 0 THEN '''' ELSE '''' END 
FROM tempdb.information_schema.columns 
WHERE table_name='##tmpSampleWorkflow' AND column_name='tb_pivot'

SELECT @sql=@sql + '''D_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@duedate,charindex( '(', @duedate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
+ '''E_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@enddate,charindex( '(', @enddate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
FROM ##tmpSampleWorkflow

SELECT @sql=left(@sql, len(@sql)-1)

SELECT @select=stuff(@select, charindex(' FROM ', @select)+1, 0, ', ' + @sql + ' ')

DROP TABLE ##tmpSampleWorkflow

PRINT  @select 

EXEC (@select)


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleRequestGridVendor_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_SampleRequestGridVendor_SELECT] 
(
@TradePartnerVendorID nvarchar(50),
@StyleNo nvarchar(200),
@StyleDescription nvarchar(200)
)
AS

DECLARE @UserID varchar(10), @sql varchar(8000), @delim varchar(1), @select varchar(8000), @enddate varchar(100), @duedate varchar(100), @pivot varchar(100), @table varchar(100)

SET NOCOUNT ON
SET ANSI_WARNINGS OFF

SELECT @select = 'SELECT dbo.pSampleRequestWorkflow.SampleRequestTradeID, 
dbo.pSampleRequestWorkflow.StyleColorID, dbo.pSampleRequestWorkflow.StyleID, 
dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.StyleNo AS [Style No], 
dbo.pStyleHeader.SizeRange AS [Size], dbo.pStyleHeader.Description, 
CASE 
WHEN pSampleRequestWorkflow.StyleSet = 1 THEN 
	CASE WHEN dbo.pStyleHeader.PC1 Is Not Null THEN dbo.pStyleHeader.PC1 ELSE ''1st Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 2 THEN 
	CASE WHEN dbo.pStyleHeader.PC2 Is Not Null THEN dbo.pStyleHeader.PC2 ELSE ''2nd Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 3 THEN 
	CASE WHEN dbo.pStyleHeader.PC3 Is Not Null THEN dbo.pStyleHeader.PC3 ELSE ''3rd Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 4 THEN 
	CASE WHEN dbo.pStyleHeader.PC4 Is Not Null THEN dbo.pStyleHeader.PC4 ELSE ''4th Set'' END 
END AS [Style Set], dbo.pStyleColorway.MainColor AS Color FROM dbo.pSampleRequestWorkflow WITH (NOLOCK) INNER JOIN 
dbo.pStyleHeader WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.StyleID = dbo.pStyleHeader.StyleID LEFT OUTER JOIN 
dbo.pStyleColorway WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.StyleColorID = dbo.pStyleColorway.StyleColorID INNER JOIN
	dbo.pSampleRequestTrade WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.SampleRequestTradeID = dbo.pSampleRequestTrade.SampleRequestTradeID
GROUP BY dbo.pSampleRequestWorkflow.SampleRequestTradeID, dbo.pSampleRequestWorkflow.StyleID, dbo.pSampleRequestWorkflow.StyleColorID, 
dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.SizeRange, dbo.pStyleHeader.Description, 
dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.Pc1, dbo.pStyleHeader.Pc2, dbo.pStyleHeader.Pc3, dbo.pStyleHeader.Pc4, 
dbo.pSampleRequestWorkflow.TradePartnerVendorID, dbo.pStyleColorway.MainColor, dbo.pSampleRequestTrade.SampleRequestShare
HAVING dbo.pSampleRequestWorkflow.TradePartnerVendorID = ''' + @TradePartnerVendorID + ''' '

IF @StyleNo IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.StyleNo LIKE ''%' + @StyleNo + '%''' 
IF @StyleDescription IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.Description LIKE ''%' + @StyleDescription + '%''' 

SELECT @select = @select + ' ORDER BY dbo.pStyleHeader.StyleNo, dbo.pSampleRequestWorkflow.StyleSet '

SELECT @enddate = 'MAX(dbo.pSampleRequestWorkflow.EndDate)'
SELECT @duedate = 'MAX(dbo.pSampleRequestWorkflow.DueDate)'
SELECT @pivot = 'pSampleRequestWorkflow.SampleWorkflowID'
SELECt @table = 'pSampleRequestWorkflow WITH (NOLOCK)'

EXEC ('SELECT ' + @pivot + ' AS tb_pivot INTO ##tmpSampleWorkflow FROM ' + @table + ' WHERE 1=2')
EXEC ('INSERT INTO ##tmpSampleWorkflow SELECT DISTINCT ' + @pivot + ' FROM ' + @table + ' WHERE TradePartnerVendorID = ''{' + @TradePartnerVendorID + '}''' + ' AND ' + @pivot + ' Is Not Null')

SELECT @sql='',  @duedate=stuff(@duedate, len(@duedate), 1, ' END)' )
SELECT @sql=@sql + '',  @enddate=stuff(@enddate, len(@enddate), 1, ' END)' )

SELECT @delim=CASE Sign( CharIndex('char', data_type) + CharIndex('date', data_type) ) 
WHEN 0 THEN '''' ELSE '''' END 
FROM tempdb.information_schema.columns 
WHERE table_name='##tmpSampleWorkflow' AND column_name='tb_pivot'

SELECT @sql=@sql + '''D_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@duedate,charindex( '(', @duedate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
+ '''E_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@enddate,charindex( '(', @enddate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
FROM ##tmpSampleWorkflow

SELECT @sql=left(@sql, len(@sql)-1)

SELECT @select=stuff(@select, charindex(' FROM ', @select)+1, 0, ', ' + @sql + ' ')

DROP TABLE ##tmpSampleWorkflow

EXEC (@select)


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleRequestGridVendorShared_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_SampleRequestGridVendorShared_SELECT] 
(
@TradePartnerVendorID nvarchar(50),
@StyleNo nvarchar(200),
@StyleDescription nvarchar(200)
)
AS

DECLARE @UserID varchar(10), @sql varchar(8000), @delim varchar(1), @select varchar(8000), @enddate varchar(100), @duedate varchar(100), @pivot varchar(100), @table varchar(100)

SET NOCOUNT ON
SET ANSI_WARNINGS OFF

SELECT @select = 'SELECT dbo.pSampleRequestWorkflow.SampleRequestTradeID, 
dbo.pSampleRequestWorkflow.StyleColorID, dbo.pSampleRequestWorkflow.StyleID, 
dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.StyleNo AS [Style No], 
dbo.pStyleHeader.SizeRange AS [Size], dbo.pStyleHeader.Description, 
CASE 
WHEN pSampleRequestWorkflow.StyleSet = 1 THEN 
	CASE WHEN dbo.pStyleHeader.PC1 Is Not Null THEN dbo.pStyleHeader.PC1 ELSE ''1st Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 2 THEN 
	CASE WHEN dbo.pStyleHeader.PC2 Is Not Null THEN dbo.pStyleHeader.PC2 ELSE ''2nd Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 3 THEN 
	CASE WHEN dbo.pStyleHeader.PC3 Is Not Null THEN dbo.pStyleHeader.PC3 ELSE ''3rd Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 4 THEN 
	CASE WHEN dbo.pStyleHeader.PC4 Is Not Null THEN dbo.pStyleHeader.PC4 ELSE ''4th Set'' END 
END AS [Style Set], dbo.pStyleColorway.MainColor AS Color FROM dbo.pSampleRequestWorkflow WITH (NOLOCK) INNER JOIN 
dbo.pStyleHeader WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.StyleID = dbo.pStyleHeader.StyleID LEFT OUTER JOIN 
dbo.pStyleColorway WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.StyleColorID = dbo.pStyleColorway.StyleColorID INNER JOIN
	dbo.pSampleRequestTrade WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.SampleRequestTradeID = dbo.pSampleRequestTrade.SampleRequestTradeID
GROUP BY dbo.pSampleRequestWorkflow.SampleRequestTradeID, dbo.pSampleRequestWorkflow.StyleID, dbo.pSampleRequestWorkflow.StyleColorID, 
dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.SizeRange, dbo.pStyleHeader.Description, 
dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.Pc1, dbo.pStyleHeader.Pc2, dbo.pStyleHeader.Pc3, dbo.pStyleHeader.Pc4, 
dbo.pSampleRequestWorkflow.TradePartnerVendorID, dbo.pStyleColorway.MainColor, dbo.pSampleRequestTrade.SampleRequestShare
HAVING dbo.pSampleRequestWorkflow.TradePartnerVendorID = ''' + @TradePartnerVendorID + ''' AND (dbo.pSampleRequestTrade.SampleRequestShare = 1)'

IF @StyleNo IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.StyleNo LIKE ''%' + @StyleNo + '%''' 
IF @StyleDescription IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.Description LIKE ''%' + @StyleDescription + '%''' 

SELECT @select = @select + ' ORDER BY dbo.pStyleHeader.StyleNo, dbo.pSampleRequestWorkflow.StyleSet '

SELECT @enddate = 'MAX(dbo.pSampleRequestWorkflow.EndDate)'
SELECT @duedate = 'MAX(dbo.pSampleRequestWorkflow.DueDate)'
SELECT @pivot = 'pSampleRequestWorkflow.SampleWorkflowID'
SELECt @table = 'pSampleRequestWorkflow WITH (NOLOCK)'

EXEC ('SELECT ' + @pivot + ' AS tb_pivot INTO ##tmpSampleWorkflow FROM ' + @table + ' WHERE 1=2')
EXEC ('INSERT INTO ##tmpSampleWorkflow SELECT DISTINCT ' + @pivot + ' FROM ' + @table + ' WHERE TradePartnerVendorID = ''{' + @TradePartnerVendorID + '}''' + ' AND ' + @pivot + ' Is Not Null')

SELECT @sql='',  @duedate=stuff(@duedate, len(@duedate), 1, ' END)' )
SELECT @sql=@sql + '',  @enddate=stuff(@enddate, len(@enddate), 1, ' END)' )

SELECT @delim=CASE Sign( CharIndex('char', data_type) + CharIndex('date', data_type) ) 
WHEN 0 THEN '''' ELSE '''' END 
FROM tempdb.information_schema.columns 
WHERE table_name='##tmpSampleWorkflow' AND column_name='tb_pivot'

SELECT @sql=@sql + '''D_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@duedate,charindex( '(', @duedate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
+ '''E_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@enddate,charindex( '(', @enddate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
FROM ##tmpSampleWorkflow

SELECT @sql=left(@sql, len(@sql)-1)

SELECT @select=stuff(@select, charindex(' FROM ', @select)+1, 0, ', ' + @sql + ' ')

DROP TABLE ##tmpSampleWorkflow

EXEC (@select)


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleRequestGridAgentShared_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_SampleRequestGridAgentShared_SELECT] 
(
@TradePartnerID nvarchar(50),
@StyleNo nvarchar(200) = NULL,
@StyleDescription nvarchar(200) = NULL,
@sqlSelect varchar(8000) = NULL
)
AS


DECLARE @UserID varchar(10), @sql varchar(8000), @delim varchar(1), @select varchar(8000), @enddate varchar(100), @duedate varchar(100), @pivot varchar(100), @table varchar(100)

SET NOCOUNT ON
SET ANSI_WARNINGS OFF

SELECT @select = 'SELECT TOP 100 
	a.SampleRequestTradeID, 
	a.StyleColorID, a.StyleID, 
	a.StyleSet, pStyleHeader.StyleNo AS [Style No], 
	pStyleHeader.SizeRange AS [Size Range], pStyleHeader.Description, 
CASE 
WHEN a.StyleSet = 1 THEN 
	CASE WHEN pStyleHeader.PC1 Is Not Null THEN pStyleHeader.PC1 ELSE ''1st Set'' END
WHEN a.StyleSet = 2 THEN 
	CASE WHEN pStyleHeader.PC2 Is Not Null THEN pStyleHeader.PC2 ELSE ''2nd Set'' END
WHEN a.StyleSet = 3 THEN 
	CASE WHEN pStyleHeader.PC3 Is Not Null THEN pStyleHeader.PC3 ELSE ''3rd Set'' END
WHEN a.StyleSet = 4 THEN 
	CASE WHEN pStyleHeader.PC4 Is Not Null THEN pStyleHeader.PC4 ELSE ''4th Set'' END 
END AS [Style Set], pStyleColorway.MainColor AS Color,  uTradePartner.TradePartnerName as [Agent], 
uTradePartnerVendor.VendorName as [Vendor], pStyleHeader.SizeClass  FROM pSampleRequestWorkflow a WITH (NOLOCK) INNER JOIN
	pStyleHeader WITH (NOLOCK) ON a.StyleID = pStyleHeader.StyleID 

	INNER JOIN  uTradePartner WITH (NOLOCK) ON a.TradePartnerID =  uTradePartner.TradePartnerID INNER JOIN
	uTradePartnerVendor WITH (NOLOCK) ON  a.TradePartnerVendorID =  uTradePartnerVendor.TradePartnerVendorID

	LEFT OUTER JOIN pStyleColorway WITH (NOLOCK) ON a.StyleColorID = pStyleColorway.StyleColorID INNER JOIN
	pSampleRequestTrade WITH (NOLOCK) ON a.SampleRequestTradeID = pSampleRequestTrade.SampleRequestTradeID
GROUP BY a.SampleRequestTradeID, a.StyleID, a.StyleColorID, 
   a.StyleSet, pStyleHeader.StyleNo, pStyleHeader.SizeRange, pStyleHeader.Description, 
   a.StyleSet, pStyleHeader.Pc1, pStyleHeader.Pc2, pStyleHeader.Pc3, pStyleHeader.Pc4, 
   a.TradePartnerID, pStyleColorway.MainColor, pSampleRequestTrade.SampleRequestShare, 	
    uTradePartner.TradePartnerName, uTradePartnerVendor.VendorName, pStyleHeader.SizeClass	


HAVING a.TradePartnerID = ''' + @TradePartnerID + ''' AND (pSampleRequestTrade.SampleRequestShare = 1) AND
	a.SampleRequestTradeID IN (' + @sqlSelect + ')'

--IF @StyleNo IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.StyleNo LIKE ''%' + @StyleNo + '%''' 
--IF @StyleDescription IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.Description LIKE ''%' + @StyleDescription + '%''' 

SELECT @select = @select + ' ORDER BY pStyleHeader.StyleNo, a.StyleSet '

SELECT @enddate = 'MAX(a.EndDate)'
SELECT @duedate = 'MAX(a.DueDate)'
SELECT @pivot = 'a.SampleWorkflowID'
SELECt @table = 'pSampleRequestWorkflow a WITH (NOLOCK)'

--PRINT ('SELECT ' + @pivot + ' AS pivot INTO ##tmpSampleWorkflow FROM ' + @table + ' WHERE 1=2')
EXEC ('SELECT ' + @pivot + ' AS tb_pivot INTO ##tmpSampleWorkflow FROM ' + @table + ' WHERE 1=2 AND SampleRequestTradeID IN (' + @sqlSelect + ')')

--PRINT ('INSERT INTO ##tmpSampleWorkflow SELECT DISTINCT ' + @pivot + ' FROM ' + @table + ' WHERE TradePartnerID = ''{' + @TradePartnerID + '}''' + ' AND ' + @pivot + ' Is Not Null')
EXEC ('INSERT INTO ##tmpSampleWorkflow SELECT DISTINCT ' + @pivot + ' FROM ' + @table + ' WHERE SampleRequestTradeID IN (' + @sqlSelect + ')' + ' AND ' + @pivot + ' Is Not Null')

SELECT @sql='',  @duedate=stuff(@duedate, len(@duedate), 1, ' END)' )
SELECT @sql=@sql + '',  @enddate=stuff(@enddate, len(@enddate), 1, ' END)' )

SELECT @delim=CASE Sign( CharIndex('char', data_type) + CharIndex('date', data_type) ) 
	WHEN 0 THEN '''' ELSE '''' END 
	FROM tempdb.information_schema.columns 
WHERE table_name='##tmpSampleWorkflow' AND column_name='tb_pivot'

SELECT @sql=@sql + '''D_' + convert(varchar(100), tb_pivot) + ''' = ' + 
	stuff(@duedate,charindex( '(', @duedate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
	+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
	+ '''E_' + convert(varchar(100), tb_pivot) + ''' = ' + 
	stuff(@enddate,charindex( '(', @enddate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
	+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
FROM ##tmpSampleWorkflow

IF @sql is not null AND LEN(@SQL) > 0
begin 
	SELECT @sql=left(@sql, len(@sql)-1)
	SELECT @select=stuff(@select, charindex(' FROM ', @select)+1, 0, ', ' + @sql + ' ')
end 

DROP TABLE ##tmpSampleWorkflow

PRINT (@select)
EXEC (@select)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleCostingLogic_UPDATE]'
GO


ALTER PROCEDURE [dbo].[spx_StyleCostingLogic_UPDATE](
@StyleCostingId UNIQUEIDENTIFIER ,
@StyleSeasonYearID UNIQUEIDENTIFIER 
)
AS 

/***********************************************
New statements added by Ryan Cabanas on 8/26/08.
************************************************/

DECLARE @DUMMY INT 
--SELECT 1


/************************************************************
Original statements commented out by Ryan Cabanas on 8/26/08.
*************************************************************/

--DECLARE @CostType int
--DECLARE @StyleId uniqueidentifier
--DECLARE @InitialCost decimal(19,3)
--DECLARE @Cost decimal(19,5)
--DECLARE @TargetMarginPerc decimal(19,3)
--DECLARE @MiscCost decimal(19, 3)
--DECLARE @TargetRetail decimal(19, 3)
--DECLARE @FrtType int						--StyleCostingCustomField5
--DECLARE @FrtCost decimal(19, 6)
--DECLARE @SampleWeight decimal(19,3)
--DECLARE @TargetCost decimal(19,3)
--DECLARE @RoyaltyPerc decimal(19, 3)
--DECLARE @GarmentSurcharge decimal(19, 3)
--DECLARE @CommissionPerc decimal(19,3)
--DECLARE @VariancePerc decimal(19,3)
--DECLARE @DutyPerc decimal(19,3)
--DECLARE @BrokerHarborFee decimal(19,3)
--DECLARE @MaterialCost decimal(19,3)
--
--SELECT
--@CostType = StyleCostingCustomField16,
--@StyleId = StyleId, 
--@TargetRetail = StyleCostingCustomField1,
--@SampleWeight = StyleCostingCustomField2,
--@TargetMarginPerc = StyleCostingCustomField3,
--@MiscCost = StyleCostingCustomField4,
--@FrtType = StyleCostingCustomField5,
--@RoyaltyPerc = StyleCostingCustomField8,
--@GarmentSurcharge = StyleCostingCustomField12, 
--@CommissionPerc = StyleCostingCustomField9,
--@VariancePerc = StyleCostingCustomField10,
--@DutyPerc = StyleCostingCustomField11,
--@BrokerHarborFee = StyleCostingCustomField13
--FROM  dbo.pStyleCosting
--WHERE StyleCostingId = @StyleCostingId 
--
--
--/*
----Costing Type
--1 = Air
--2 = Boat
--3 = Domestic
--4 = Indirect
--*/
--
----Material Cost
--
--
----Initial Cost
--SET @InitialCost = (@TargetRetail * (1-@TargetMarginPerc)) - @MiscCost
--
--
--DECLARE @AirCharge decimal(19, 3)
--DECLARE @SeaCharge decimal(19, 3)
--DECLARE @DomesticChargeWest decimal(19, 5)
--DECLARE @DomesticChargeEast decimal(19, 5)
--DECLARE @DomesticChargeMid decimal(19, 5)
--
--
--SELECT 
--@AirCharge = AirCharge, 
--@SeaCharge = SeaCharge, 
--@DomesticChargeEast = DomesticChargeEast,
--@DomesticChargeWest = DomesticChargeWest,
--@DomesticChargeMid = DomesticChargeMid
--FROM pStyleCostingPreference 
--
--BEGIN
----Air/Boat Cost charges are then detucted from this cost
--IF @CostType = 1 --AIR
--	SET @FrtCost = (@AirCharge * @SampleWeight)
--ELSE IF @CostType = 2 --BOAT
--	SET @FrtCost = (@SeaCharge * (@SampleWeight / 16))
--ELSE IF @CostType = 3 --DOMESTIC
--  	SET @FrtCost = ((@DomesticChargeWest + @DomesticChargeEast + @DomesticChargeMid) / 3)* @SampleWeight
--ELSE IF @CostType = 4 --INDIRECT
--	SET @FrtCost = ((@DomesticChargeWest + @DomesticChargeEast + @DomesticChargeMid) / 3)* @SampleWeight --(@AirCharge * @SampleWeight)
--ELSE
--	SET @FrtCost = 0 --((@DomesticChargeWest + @DomesticChargeEast + @DomesticChargeMid) / 3)* @SampleWeight
--END
--
----Cost is re-calculated by deduction the air boat cost
--SET @Cost = @InitialCost - @FrtCost
--
--DECLARE @Cost1 decimal(19,3)
--SET @Cost1 = @TargetRetail * @RoyaltyPerc
--
--DECLARE @Cost2 decimal(19,5)
--BEGIN
--	IF @CostType = 1
--		SET @Cost2 = @SampleWeight * @GarmentSurcharge
--	ELSE IF @CostType = 2 
--		SET @Cost2 = @SampleWeight * @GarmentSurcharge
--	ELSE
--		SET @Cost2 = @SampleWeight * @GarmentSurcharge
--END
--
--
--DECLARE @Cost3 decimal(19,3)
--BEGIN
--	IF @CostType = 1
--		SET @Cost3 = 1 + (@CommissionPerc + @VariancePerc + @DutyPerc + @BrokerHarborFee)
--	ELSE IF @CostType = 2
--		SET @Cost3 = 1 + (@CommissionPerc + @VariancePerc + @DutyPerc + @BrokerHarborFee)
--	ELSE 
--		SET @Cost3 = 1 + (@CommissionPerc + @VariancePerc + @DutyPerc + @BrokerHarborFee)
--END
--
----Target Cost
--SET @TargetCost = ((@Cost - @Cost1) + @Cost2) / @Cost3
--
--
--BEGIN
--IF @CostType = 1 --AIR
--	UPDATE dbo.pStyleCosting SET 
--		StyleCostingCustomField14 = @TargetCost, 
--		StyleCostingCustomField6 = 0,
--		StyleCostingCustomField7 = @FrtCost
--	WHERE StyleCostingId = @StyleCostingId 
--ELSE IF @CostType = 2 --BOAT
--	UPDATE dbo.pStyleCosting SET 
--		StyleCostingCustomField14 = @TargetCost, 
--		StyleCostingCustomField6 = 0,
--		StyleCostingCustomField7 = @FrtCost
--	WHERE StyleCostingId = @StyleCostingId 	
--ELSE IF @CostType = 3 --DOMESTIC
--	UPDATE dbo.pStyleCosting SET 
--		StyleCostingCustomField14 = @TargetCost, 
--		StyleCostingCustomField6 = @FrtCost,
--		StyleCostingCustomField7 = 0
--	WHERE StyleCostingId = @StyleCostingId   	
--ELSE IF @CostType = 4 --INDIRECT
--	UPDATE dbo.pStyleCosting SET 
--		StyleCostingCustomField14 = @TargetCost, 
--		StyleCostingCustomField6 = @FrtCost,
--		StyleCostingCustomField7 = 0
--	WHERE StyleCostingId = @StyleCostingId 	
--ELSE
--	UPDATE dbo.pStyleCosting SET 
--		StyleCostingCustomField14 = @TargetCost, 
--		StyleCostingCustomField6 = 0,
--		StyleCostingCustomField7 = 0
--	WHERE StyleCostingId = @StyleCostingId 	
--END
--
--
--SELECT @TargetRetail AS TargetRetail, 
--@InitialCost AS InitialCost, 
--@Cost AS Cost, 
--@Cost1 AS Cost1, 
--@Cost2 AS Cost2, 
--@Cost3 AS Cost3, 
--@SampleWeight AS SampleWeight,
--@TargetMarginPerc AS TargetMargin,
--@MiscCost AS MiscCost,
--@CostType AS CostType,
--@FrtType as FreightType, 
--@FrtCost AS FreightCost, 
--@SeaCharge AS SeaCharge,
--@AirCharge AS AirCharge,
--@TargetCost AS TargetCost 


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleRequestGrid_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_SampleRequestGrid_SELECT]
(
@TradePartnerID nvarchar(50),
@StyleNo nvarchar(200) = NULL,
@StyleDescription nvarchar(200) = NULL,
@sqlSelect varchar(8000) = NULL,
@TeamID varchar (50) = NULL 
)
AS

DECLARE @UserID varchar(10), @sql varchar(8000), @delim varchar(1), @select varchar(8000), @enddate varchar(100), @duedate varchar(100), @pivot varchar(100), @table varchar(100)

SET NOCOUNT ON
SET ANSI_WARNINGS OFF

SELECT @select = 'SELECT TOP 100 a.SampleRequestTradeID, 
	a.StyleColorID, a.StyleID, 
	a.StyleSet, pStyleHeader.StyleNo AS [Style No], 
	pStyleHeader.SizeRange AS [Size], pStyleHeader.Description, 
CASE 
WHEN a.StyleSet = 1 THEN 
	CASE WHEN pStyleHeader.PC1 Is Not Null THEN pStyleHeader.PC1 ELSE ''1st Set'' END
WHEN a.StyleSet = 2 THEN 
	CASE WHEN pStyleHeader.PC2 Is Not Null THEN pStyleHeader.PC2 ELSE ''2nd Set'' END
WHEN a.StyleSet = 3 THEN 
	CASE WHEN pStyleHeader.PC3 Is Not Null THEN pStyleHeader.PC3 ELSE ''3rd Set'' END
WHEN a.StyleSet = 4 THEN 
	CASE WHEN pStyleHeader.PC4 Is Not Null THEN pStyleHeader.PC4 ELSE ''4th Set'' END 
END AS [Style Set], pStyleColorway.MainColor AS Color FROM pSampleRequestWorkflow  a WITH (NOLOCK)  INNER JOIN
	pStyleHeader WITH (NOLOCK) ON a.StyleID = pStyleHeader.StyleID LEFT OUTER JOIN
	pStyleColorway WITH (NOLOCK) ON a.StyleColorID = pStyleColorway.StyleColorID INNER JOIN
	pSampleRequestTrade WITH (NOLOCK) ON a.SampleRequestTradeID = pSampleRequestTrade.SampleRequestTradeID '

IF NOT @TeamID IS NULL  
BEGIN
	SET @select = @select + ' WHERE pStyleHeader.StyleType IN  (  SELECT StyleTypeID FROM sAccessStyleFolder WITH (NOLOCK) WHERE TeamId = ''' +  CAST (@TeamID AS NVARCHAR(50))  + ''' AND (AccessRoleId = 3 OR AccessView = 1) ) ' 
END 


SET @select = @select + ' GROUP BY a.SampleRequestTradeID, a.StyleID, a.StyleColorID, 
   a.StyleSet, pStyleHeader.StyleNo, pStyleHeader.SizeRange, pStyleHeader.Description, 
   a.StyleSet, pStyleHeader.Pc1, pStyleHeader.Pc2, pStyleHeader.Pc3, pStyleHeader.Pc4, 
   a.TradePartnerID, pStyleColorway.MainColor, pSampleRequestTrade.SampleRequestShare	
HAVING a.TradePartnerID = ''' + @TradePartnerID + ''' AND (pSampleRequestTrade.SampleRequestShare = 1) AND
	a.SampleRequestTradeID IN (' + @sqlSelect + ')'

--IF @StyleNo IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.StyleNo LIKE ''%' + @StyleNo + '%''' 
--IF @StyleDescription IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.Description LIKE ''%' + @StyleDescription + '%''' 

SELECT @select = @select + ' ORDER BY pStyleHeader.StyleNo, a.StyleSet '

SELECT @enddate = 'MAX(a.EndDate)'
SELECT @duedate = 'MAX(a.DueDate)'
SELECT @pivot = 'a.SampleWorkflowID'
SELECt @table = 'pSampleRequestWorkflow WITH (NOLOCK)'

--PRINT ('SELECT ' + @pivot + ' AS tb_pivot INTO ##tmpSampleWorkflow FROM pSampleRequestWorkflow a WITH (NOLOCK)  WHERE 1=2')
EXEC ('SELECT ' + @pivot + ' AS tb_pivot INTO ##tmpSampleWorkflow FROM pSampleRequestWorkflow a WITH (NOLOCK) WHERE 1=2 AND SampleRequestTradeID IN (' + @sqlSelect + ')')

--PRINT ('INSERT INTO ##tmpSampleWorkflow SELECT DISTINCT ' + @pivot + ' FROM ' + @table + ' WHERE TradePartnerID = ''{' + @TradePartnerID + '}''' + ' AND ' + @pivot + ' Is Not Null')

IF @TeamID  is NULL 
	EXEC ('INSERT INTO ##tmpSampleWorkflow SELECT DISTINCT ' + @pivot + ' FROM pSampleRequestWorkflow  a WITH (NOLOCK)   WHERE SampleRequestTradeID IN (' + @sqlSelect + ')' + ' AND ' + @pivot + ' Is Not Null')
ELSE 
	EXEC ('   INSERT INTO ##tmpSampleWorkflow  SELECT DISTINCT a.SampleWorkflowID  FROM pSampleRequestWorkflow  a WITH (NOLOCK)   WHERE SampleRequestTradeID IN (' + @sqlSelect + ') AND  a.SampleWorkflowID   IN  (  ' + 
	' SELECT DISTINCT SampleWorkflowID   FROM  pSampleWorkflowViewSubmit WITH (NOLOCK)  	WHERE TeamId = ''' +  @TeamID + ''' AND  SampleWorkflowID IN  (   ' + 
	' SELECT SampleTypeId from sAccessSampleFolder WITH (NOLOCK) WHERE TeamId = ''' +  @TeamID + '''   AND (AccessRoleId=3 OR AccessView=1 )  )  )  ' )




SELECT @sql='',  @duedate=stuff(@duedate, len(@duedate), 1, ' END)' )
SELECT @sql=@sql + '',  @enddate=stuff(@enddate, len(@enddate), 1, ' END)' )

SELECT @delim=CASE Sign( CharIndex('char', data_type) + CharIndex('date', data_type) ) 
	WHEN 0 THEN '''' ELSE '''' END 
	FROM tempdb.information_schema.columns 
WHERE table_name='##tmpSampleWorkflow' AND column_name='tb_pivot'

SELECT @sql=@sql + '''D_' + convert(varchar(100), tb_pivot) + ''' = ' + 
	stuff(@duedate,charindex( '(', @duedate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
	+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
	+ '''E_' + convert(varchar(100), tb_pivot) + ''' = ' + 
	stuff(@enddate,charindex( '(', @enddate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
	+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
FROM ##tmpSampleWorkflow

IF @sql is not null AND LEN(@SQL) > 0
begin 
	SELECT @sql=left(@sql, len(@sql)-1)
	SELECT @select=stuff(@select, charindex(' FROM ', @select)+1, 0, ', ' + @sql + ' ')
end 

DROP TABLE ##tmpSampleWorkflow

PRINT (@select)
EXEC (@select)


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleWorkflowSubmit_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_SampleWorkflowSubmit_SELECT] 
(@UserID nvarchar(5))
AS

DECLARE @sql varchar(8000), @delim varchar(1), @select varchar(8000), @enddate varchar(100), @duedate varchar(100), @pivot varchar(100), @table varchar(100)
SET NOCOUNT ON
SET ANSI_WARNINGS OFF


SELECT @select = 'SELECT dbo.pSampleRequestWorkflow.StyleID, dbo.pStyleHeader.StyleNo AS [Style No], dbo.pStyleHeader.Description, 
CASE 
WHEN pSampleRequestWorkflow.StyleSet = 1 THEN 
	CASE WHEN dbo.pStyleHeader.PC1 Is Not Null THEN dbo.pStyleHeader.PC1 ELSE ''1st Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 2 THEN 
	CASE WHEN dbo.pStyleHeader.PC2 Is Not Null THEN dbo.pStyleHeader.PC2 ELSE ''2nd Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 3 THEN 
	CASE WHEN dbo.pStyleHeader.PC3 Is Not Null THEN dbo.pStyleHeader.PC3 ELSE ''3rd Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 4 THEN 
	CASE WHEN dbo.pStyleHeader.PC4 Is Not Null THEN dbo.pStyleHeader.PC4 ELSE ''4th Set'' END
END AS [Style Set] FROM  dbo.pSampleRequestWorkflow WITH (NOLOCK) 
INNER JOIN dbo.pStyleHeader WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.StyleID = dbo.pStyleHeader.StyleID 
GROUP BY dbo.pSampleRequestWorkflow.StyleID, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.Description, dbo.pSampleRequestWorkflow.StyleSet, 
dbo.pStyleHeader.PC1, dbo.pStyleHeader.PC2, dbo.pStyleHeader.PC3, dbo.pStyleHeader.PC4,pSampleRequestWorkflow.UserID
HAVING pSampleRequestWorkflow.UserID = ' + @UserID + ' ORDER BY dbo.pStyleHeader.StyleNo, dbo.pSampleRequestWorkflow.StyleSet'


SELECT @enddate = 'MAX(dbo.pSampleRequestWorkflow.EndDate)'
SELECT @duedate = 'MAX(dbo.pSampleRequestWorkflow.DueDate)'
SELECT @pivot = 'dbo.pSampleRequestWorkflow.SampleWorkflowID'
SELECt @table = 'pSampleRequestWorkflow WITH (NOLOCK)'

EXEC ('SELECT ' + @pivot + ' AS tb_pivot INTO ##SampleWorkflow FROM ' + @table + ' WHERE 1=2')
EXEC ('INSERT INTO ##SampleWorkflow SELECT DISTINCT ' + @pivot + ' FROM ' + @table + ' WHERE ' 
+ @pivot + ' Is Not Null')


SELECT @sql='',  @duedate=stuff(@duedate, len(@duedate), 1, ' END)' )
SELECT @sql=@sql + '',  @enddate=stuff(@enddate, len(@enddate), 1, ' END)' )

SELECT @delim=CASE Sign( CharIndex('char', data_type) + CharIndex('date', data_type) ) 
WHEN 0 THEN '''' ELSE '''' END 
FROM tempdb.information_schema.columns 
WHERE table_name='##SampleWorkflow' AND column_name='tb_pivot'

SELECT @sql=@sql + '''D_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@duedate,charindex( '(', @duedate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
+ '''E_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@enddate,charindex( '(', @enddate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
FROM ##SampleWorkflow

SELECT @sql=left(@sql, len(@sql)-1)

SELECT @select=stuff(@select, charindex(' FROM ', @select)+1, 0, ', ' + @sql + ' ')

DROP TABLE ##SampleWorkflow

EXEC (@select)


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleRequestGridAgent_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_SampleRequestGridAgent_SELECT] 
(
@TradePartnerID nvarchar(50),
@StyleNo nvarchar(200),
@StyleDescription nvarchar(200)
)
AS

DECLARE @UserID varchar(10), @sql varchar(8000), @delim varchar(1), @select varchar(8000), @enddate varchar(100), @duedate varchar(100), @pivot varchar(100), @table varchar(100)

SET NOCOUNT ON
SET ANSI_WARNINGS OFF

SELECT @select = 'SELECT dbo.pSampleRequestWorkflow.SampleRequestTradeID, 
dbo.pSampleRequestWorkflow.StyleColorID, dbo.pSampleRequestWorkflow.StyleID, 
dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.StyleNo AS [Style No], 
dbo.pStyleHeader.SizeRange AS [Size], dbo.pStyleHeader.Description, 
CASE 
WHEN pSampleRequestWorkflow.StyleSet = 1 THEN 
	CASE WHEN dbo.pStyleHeader.PC1 Is Not Null THEN dbo.pStyleHeader.PC1 ELSE ''1st Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 2 THEN 
	CASE WHEN dbo.pStyleHeader.PC2 Is Not Null THEN dbo.pStyleHeader.PC2 ELSE ''2nd Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 3 THEN 
	CASE WHEN dbo.pStyleHeader.PC3 Is Not Null THEN dbo.pStyleHeader.PC3 ELSE ''3rd Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 4 THEN 
	CASE WHEN dbo.pStyleHeader.PC4 Is Not Null THEN dbo.pStyleHeader.PC4 ELSE ''4th Set'' END 
END AS [Style Set], dbo.pStyleColorway.MainColor AS Color FROM dbo.pSampleRequestWorkflow WITH (NOLOCK) INNER JOIN
	dbo.pStyleHeader WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.StyleID = dbo.pStyleHeader.StyleID LEFT OUTER JOIN
	dbo.pStyleColorway WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.StyleColorID = dbo.pStyleColorway.StyleColorID INNER JOIN
	dbo.pSampleRequestTrade WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.SampleRequestTradeID = dbo.pSampleRequestTrade.SampleRequestTradeID
GROUP BY dbo.pSampleRequestWorkflow.SampleRequestTradeID, dbo.pSampleRequestWorkflow.StyleID, dbo.pSampleRequestWorkflow.StyleColorID, 
   dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.SizeRange, dbo.pStyleHeader.Description, 
   dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.Pc1, dbo.pStyleHeader.Pc2, dbo.pStyleHeader.Pc3, dbo.pStyleHeader.Pc4, 
   dbo.pSampleRequestWorkflow.TradePartnerID, dbo.pStyleColorway.MainColor, dbo.pSampleRequestTrade.SampleRequestShare	
HAVING dbo.pSampleRequestWorkflow.TradePartnerID = ''' + @TradePartnerID + ''' '

IF @StyleNo IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.StyleNo LIKE ''%' + @StyleNo + '%''' 
IF @StyleDescription IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.Description LIKE ''%' + @StyleDescription + '%''' 

SELECT @select = @select + ' ORDER BY dbo.pStyleHeader.StyleNo, dbo.pSampleRequestWorkflow.StyleSet '

SELECT @enddate = 'MAX(dbo.pSampleRequestWorkflow.EndDate)'
SELECT @duedate = 'MAX(dbo.pSampleRequestWorkflow.DueDate)'
SELECT @pivot = 'pSampleRequestWorkflow.SampleWorkflowID'
SELECt @table = 'pSampleRequestWorkflow WITH (NOLOCK)'

EXEC ('SELECT ' + @pivot + ' AS tb_pivot INTO ##tmpSampleWorkflow FROM ' + @table + ' WHERE 1=2')
EXEC ('INSERT INTO ##tmpSampleWorkflow SELECT DISTINCT ' + @pivot + ' FROM ' + @table + ' WHERE TradePartnerID = ''{' + @TradePartnerID + '}''' + ' AND ' + @pivot + ' Is Not Null')

SELECT @sql='',  @duedate=stuff(@duedate, len(@duedate), 1, ' END)' )
SELECT @sql=@sql + '',  @enddate=stuff(@enddate, len(@enddate), 1, ' END)' )

SELECT @delim=CASE Sign( CharIndex('char', data_type) + CharIndex('date', data_type) ) 
WHEN 0 THEN '''' ELSE '''' END 
FROM tempdb.information_schema.columns 
WHERE table_name='##tmpSampleWorkflow' AND column_name='tb_pivot'

SELECT @sql=@sql + '''D_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@duedate,charindex( '(', @duedate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
+ '''E_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@enddate,charindex( '(', @enddate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
FROM ##tmpSampleWorkflow

SELECT @sql=left(@sql, len(@sql)-1)

SELECT @select=stuff(@select, charindex(' FROM ', @select)+1, 0, ', ' + @sql + ' ')

DROP TABLE ##tmpSampleWorkflow

print  @select 

EXEC (@select)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_SampleRequestGridAgentAccess_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_SampleRequestGridAgentAccess_SELECT] 
(
@TradePartnerID nvarchar(50),
@StyleNo nvarchar(200),
@StyleDescription nvarchar(200),
@TeamID varchar (50) 
)
AS

DECLARE @UserID varchar(10), @sql varchar(8000), @delim varchar(1), @select varchar(8000), @enddate varchar(100), @duedate varchar(100), 
@pivot varchar(100), @table varchar(100)

SET NOCOUNT ON
SET ANSI_WARNINGS OFF

SELECT @select = 'SELECT dbo.pSampleRequestWorkflow.SampleRequestTradeID, 
dbo.pSampleRequestWorkflow.StyleColorID, dbo.pSampleRequestWorkflow.StyleID, 
dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.StyleNo AS [Style No], 
dbo.pStyleHeader.SizeRange AS [Size], dbo.pStyleHeader.Description, 
CASE 
WHEN pSampleRequestWorkflow.StyleSet = 1 THEN 
	CASE WHEN dbo.pStyleHeader.PC1 Is Not Null THEN dbo.pStyleHeader.PC1 ELSE ''1st Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 2 THEN 
	CASE WHEN dbo.pStyleHeader.PC2 Is Not Null THEN dbo.pStyleHeader.PC2 ELSE ''2nd Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 3 THEN 
	CASE WHEN dbo.pStyleHeader.PC3 Is Not Null THEN dbo.pStyleHeader.PC3 ELSE ''3rd Set'' END
WHEN pSampleRequestWorkflow.StyleSet = 4 THEN 
	CASE WHEN dbo.pStyleHeader.PC4 Is Not Null THEN dbo.pStyleHeader.PC4 ELSE ''4th Set'' END 
END AS [Style Set], dbo.pStyleColorway.MainColor AS Color FROM dbo.pSampleRequestWorkflow WITH (NOLOCK) INNER JOIN
	dbo.pStyleHeader WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.StyleID = dbo.pStyleHeader.StyleID LEFT OUTER JOIN
	dbo.pStyleColorway WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.StyleColorID = dbo.pStyleColorway.StyleColorID INNER JOIN
	dbo.pSampleRequestTrade WITH (NOLOCK) ON dbo.pSampleRequestWorkflow.SampleRequestTradeID = dbo.pSampleRequestTrade.SampleRequestTradeID
GROUP BY dbo.pSampleRequestWorkflow.SampleRequestTradeID, dbo.pSampleRequestWorkflow.StyleID, dbo.pSampleRequestWorkflow.StyleColorID, 
   dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.StyleNo, dbo.pStyleHeader.SizeRange, dbo.pStyleHeader.Description, 
   dbo.pSampleRequestWorkflow.StyleSet, dbo.pStyleHeader.Pc1, dbo.pStyleHeader.Pc2, dbo.pStyleHeader.Pc3, dbo.pStyleHeader.Pc4, 
   dbo.pSampleRequestWorkflow.TradePartnerID, dbo.pStyleColorway.MainColor, dbo.pSampleRequestTrade.SampleRequestShare	
HAVING dbo.pSampleRequestWorkflow.TradePartnerID = ''' + @TradePartnerID + ''' '

IF @StyleNo IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.StyleNo LIKE ''%' + @StyleNo + '%''' 
IF @StyleDescription IS NOT NULL SELECT @select = @select + ' AND pStyleHeader.Description LIKE ''%' + @StyleDescription + '%''' 

SELECT @select = @select + ' ORDER BY dbo.pStyleHeader.StyleNo, dbo.pSampleRequestWorkflow.StyleSet '

SELECT @enddate = 'MAX(dbo.pSampleRequestWorkflow.EndDate)'
SELECT @duedate = 'MAX(dbo.pSampleRequestWorkflow.DueDate)'
SELECT @pivot = 'pSampleRequestWorkflow.SampleWorkflowID'
SELECt @table = 'pSampleRequestWorkflow WITH (NOLOCK)'

EXEC ('SELECT ' + @pivot + ' AS tb_pivot INTO ##tmpSampleWorkflow FROM ' + @table + ' WHERE 1=2')
EXEC ('INSERT INTO ##tmpSampleWorkflow SELECT DISTINCT ' + @pivot + ' FROM ' + 
	@table + ' WHERE TradePartnerID = ''{' + @TradePartnerID + '}''' + ' AND ' + @pivot + ' Is Not Null'  + 
	'  AND SampleWorkflowID IN  (  SELECT  SampleTypeId FROM sAccessSampleFolder WITH (NOLOCK) WHERE TeamId = ''{' + @TeamID + '}''' +  '  AND ( AccessRoleId =  3 OR AccessView = 1) )  '   +
	'  AND SampleWorkflowID  IN ( select  DISTINCT SampleWorkflowId   from pSampleWorkflowViewSubmit WITH (NOLOCK) WHERE TeamId = ''' + @TeamID + '''  )'  )



SELECT @sql='',  @duedate=stuff(@duedate, len(@duedate), 1, ' END)' )
SELECT @sql=@sql + '',  @enddate=stuff(@enddate, len(@enddate), 1, ' END)' )

SELECT @delim=CASE Sign( CharIndex('char', data_type) + CharIndex('date', data_type) ) 
WHEN 0 THEN '''' ELSE '''' END 
FROM tempdb.information_schema.columns 
WHERE table_name='##tmpSampleWorkflow' AND column_name='tb_pivot'


SELECT @sql=@sql + '''D_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@duedate,charindex( '(', @duedate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
+ '''E_' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@enddate,charindex( '(', @enddate )+1, 0, ' CASE ' + @pivot + ' WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' 
FROM ##tmpSampleWorkflow

SELECT @sql=left(@sql, len(@sql)-1)

SELECT @select=stuff(@select, charindex(' FROM ', @select)+1, 0, ', ' + @sql + ' ')

DROP TABLE ##tmpSampleWorkflow

print  @select 

EXEC (@select)



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_MaterialRequestSubmitAgentNew_SELECT]'
GO
ALTER PROCEDURE [dbo].[spx_MaterialRequestSubmitAgentNew_SELECT](
@TradePartnerId uniqueidentifier,
@Top INT ,
@Total INT OUTPUT 
)
AS 


DECLARE @SQLString nvarchar(4000)
DECLARE @ParmDefinition nvarchar(500)


SET @SQLString = 'SELECT @pTotal = COUNT(*) FROM ( 
		SELECT pMaterialTradePartnerColor.MaterialTradePartnerColorID, pMaterial.MaterialID, pComponentType.ComponentDescription, 
		  pMaterial.MaterialNo, pMaterial.MaterialName, pMaterialTradePartnerColor.ColorCode, pMaterialTradePartnerColor.ColorNo, 
		  pMaterialTradePartnerColor.ColorName, vwx_MaterialSize_SEL.MaterialSize, pMaterialTradePartnerColor.AgentView, uTradePartnerVendor.VendorCode,
		  uTradePartnerVendor.VendorName, pMaterialTradePartnerColor.CDate
		FROM pMaterial INNER JOIN
		  pMaterialTradePartnerColor ON pMaterial.MaterialID = pMaterialTradePartnerColor.MaterialID INNER JOIN
		  pComponentType ON pMaterial.MaterialType = pComponentType.ComponentTypeID INNER JOIN
		  vwx_MaterialSize_SEL ON pMaterialTradePartnerColor.MaterialSizeID = vwx_MaterialSize_SEL.MaterialSizeID INNER JOIN
		  pMaterialTradePartner ON pMaterialTradePartnerColor.MaterialTradePartnerID = pMaterialTradePartner.MaterialTradePartnerId INNER JOIN
		  uTradePartnerVendor ON pMaterialTradePartner.TradepartnerVendorId = uTradePartnerVendor.TradePartnerVendorID
		WHERE uTradePartnerVendor.TradePartnerID = @pTradePartnerId AND pMaterialTradePartnerColor.AgentView = 0 AND CAST(pMaterialTradePartner.MaterialRequestWorkflowTempID AS VARCHAR(40)) <> '''' 
)  AS FOO
'

SET @ParmDefinition = '@pTradePartnerId UNIQUEIDENTIFIER, @pTotal INT OUTPUT'

EXECUTE sp_executesql @SQLString, @ParmDefinition, 
		@pTradePartnerId = @TradePartnerId, 
		@pTotal = @Total OUTPUT

IF (@Top IS NULL) OR ( @Top<=0 )
	SET @SQLString = 'SELECT ' 
ELSE 
	SET @SQLString = 'SELECT TOP ' +  CAST ( @Top AS NVARCHAR(5) ) 


SET @SQLString = @SQLString  + 'pMaterialTradePartnerColor.MaterialTradePartnerColorID, pMaterial.MaterialID, pComponentType.ComponentDescription, 
		  pMaterial.MaterialNo, pMaterial.MaterialName, pMaterialTradePartnerColor.ColorCode, pMaterialTradePartnerColor.ColorNo, 
		  pMaterialTradePartnerColor.ColorName, vwx_MaterialSize_SEL.MaterialSize, pMaterialTradePartnerColor.AgentView, uTradePartnerVendor.VendorCode,
		  uTradePartnerVendor.VendorName, pMaterialTradePartnerColor.CDate
		FROM pMaterial INNER JOIN
		  pMaterialTradePartnerColor ON pMaterial.MaterialID = pMaterialTradePartnerColor.MaterialID INNER JOIN
		  pComponentType ON pMaterial.MaterialType = pComponentType.ComponentTypeID INNER JOIN
		  vwx_MaterialSize_SEL ON pMaterialTradePartnerColor.MaterialSizeID = vwx_MaterialSize_SEL.MaterialSizeID INNER JOIN
		  pMaterialTradePartner ON pMaterialTradePartnerColor.MaterialTradePartnerID = pMaterialTradePartner.MaterialTradePartnerId INNER JOIN
		  uTradePartnerVendor ON pMaterialTradePartner.TradepartnerVendorId = uTradePartnerVendor.TradePartnerVendorID
		WHERE uTradePartnerVendor.TradePartnerID = @pTradePartnerId AND pMaterialTradePartnerColor.AgentView = 0 
		AND CAST(pMaterialTradePartner.MaterialRequestWorkflowTempID AS VARCHAR(40)) <> ''''
		ORDER BY dbo.pMaterialTradePartnerColor.CDate DESC, dbo.uTradePartnerVendor.VendorCode, dbo.pMaterial.MaterialNo, dbo.pMaterialTradePartnerColor.ColorName, 
           dbo.vwx_MaterialSize_SEL.MaterialSize
'


SET @ParmDefinition = '@pTradePartnerId UNIQUEIDENTIFIER'
EXECUTE sp_executesql @SQLString, @ParmDefinition, 
		@pTradePartnerId = @TradePartnerId



/*
MODIFIED: July 25, 2008

SELECT     a.SampleRequestTradeID, a.CDate, b.StyleID, b.StyleNo,     b.Description, b.SizeClass, c.VendorName, a.TradePartnerID, c.VendorCode , d.StyleSet
FROM         pStyleHeader b WITH (NOLOCK) INNER JOIN
    pSampleRequestTrade  a WITH (NOLOCK) ON b.StyleID = a.StyleID INNER JOIN
    uTradePartnerVendor  c WITH (NOLOCK) ON a.TradePartnerVendorID = c.TradePartnerVendorID 
    INNER JOIN pSampleRequestWorkflow d ON d.SampleRequestTradeID = a.SampleRequestTradeID
WHERE ( a.TradePartnerID = @TradePartnerId ) 
AND (a.AgentView = 0) AND (a.SampleRequestShare = 1)
GROUP BY a.SampleRequestTradeID, a.CDate, b.StyleID, b.StyleNo,     b.Description, b.SizeClass, c.VendorName, a.TradePartnerID, c.VendorCode , d.StyleSet
ORDER BY c.VendorCode, a.CDate, b.SizeClass, d.StyleSet



*/










GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_StyleWorkflow_PIVOT]'
GO
ALTER PROCEDURE [dbo].[spx_StyleWorkflow_PIVOT] 
(@StyleID [uniqueidentifier])
AS

DECLARE @ID varchar(100)
SET @ID = @StyleID

print '@id: ' + @ID

DECLARE @select varchar(8000)
SET @select = 'SELECT pStyleWorkflow.StyleID, pStyleWorkflow.StyleSet FROM pStyleWorkflow WITH (NOLOCK) 
	INNER JOIN pWorkflow WITH (NOLOCK) ON pStyleWorkflow.WorkflowID = pWorkflow.WorkflowID 
	INNER JOIN Users WITH (NOLOCK) ON pStyleWorkflow.WorkAssignedTo = Users.UserId 
	GROUP BY pStyleWorkflow.StyleID, pStyleWorkflow.StyleSet '
	
	

DECLARE @sumfunc varchar(100)
DECLARE @sql varchar(8000), @delim varchar(1)


SET @sumfunc = 'AVG(UserID)'

/* 

HAVING (pStyleWorkflow.StyleID = @StyleID) 
ORDER BY pStyleWorkflow.StyleID'


HAVING (pStyleWorkflow.StyleID = 6c25830f-5eca-4bc2-8f0c-15b027da4f9e) 

DECLARE @pivot varchar(100)  
DECLARE @table varchar(100) 
SET @pivot = 'Workflow'
SET @table = 'pWorkflow'

GROUP BY pWorkflow.Workflow 

*/

SET NOCOUNT ON
SET ANSI_WARNINGS OFF

EXEC ('SELECT pStyleWorkflow.WorkflowOrder, pWorkflow.Workflow AS tb_pivot INTO ##pivot FROM pStyleWorkflow WITH (NOLOCK) INNER JOIN pWorkflow WITH (NOLOCK) ON pStyleWorkflow.WorkflowID = pWorkflow.WorkflowID WHERE (1 = 2) ORDER BY pStyleWorkflow.WorkflowOrder')
EXEC ('INSERT INTO ##pivot SELECT DISTINCT pWorkflow.WorkflowSort, pWorkflow.Workflow FROM pStyleWorkflow WITH (NOLOCK) INNER JOIN pWorkflow WITH (NOLOCK) ON pStyleWorkflow.WorkflowID = pWorkflow.WorkflowID WHERE pWorkflow.Workflow Is Not Null')

SELECT @sql='',  @sumfunc=stuff(@sumfunc, len(@sumfunc), 1, ' END)')

print '@sql: ' + @sql

SELECT @delim=CASE Sign( CharIndex('char', data_type)+ CharIndex('date', data_type) ) 
WHEN 0 THEN '' ELSE '''' END 
FROM tempdb.information_schema.columns 
WHERE table_name='##pivot' AND column_name='pivot'

print '@delim: ' + @delim

SELECT @sql=@sql + '''' + convert(varchar(100), tb_pivot) + ''' = ' + 
stuff(@sumfunc,charindex( '(', @sumfunc )+1, 0, ' CASE Workflow WHEN ' 
+ @delim + convert(varchar(100), tb_pivot) + @delim + ' THEN ' ) + ', ' FROM ##pivot

--DROP TABLE ##pivot

SELECT @sql=left(@sql, len(@sql)-1)

print '@sql: ' + @sql

print '@select: ' + @select

SELECT @select=stuff(@select, charindex(' FROM ', @select)+1, 0, ', ' + @sql + ' ')

print '@select: ' + @select

EXEC (@select)
SET ANSI_WARNINGS ON



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering [dbo].[spx_LinePlanStyleColorwayDelivery_SELECT]'
GO





ALTER PROCEDURE [dbo].[spx_LinePlanStyleColorwayDelivery_SELECT]  (
@LinePlanID VARCHAR(40),
@LinePlanRangeID VARCHAR(40), 
@LinePlanRangeTypeID VARCHAR(40), 
@ColorPaletteID VARCHAR(40),
@ColorStatusID VARCHAR(5)
)
AS 

DECLARE @strQuery VARCHAR(4000)


SET @strQuery = 'SELECT a.StyleColorID, a.ColorPaletteID, a.SAPCode, a.StyleSet, a.StyleColorNo + ''- '' + a.StyleColorName AS ColorName,   
	a.MainColor, a.Sort, a.Version, a.CDate, a.CUser, a.PLMCode, 
	b.StyleNo, b.Description, b.SizeClass, b.SizeRange, b.StyleNo + ''- '' + b.Description AS StyleDescription, b.StyleID, 
	c.ColorFolderID, d.StyleColorDelivery1, d.StyleColorDelivery2, d.StyleColorDelivery3, d.StyleColorDelivery4,
	d.StyleColorStatus, d.CustomField1,
	d.StyleColorwaySeasonYearID, d.StyleSeasonYearID, d.Units, d.ColorType, d.SampleStatus
FROM pStyleColorway a WITH (NOLOCK) 
INNER JOIN  pColorPalette c WITH (NOLOCK) ON a.ColorPaletteID = c.ColorPaletteID 
INNER JOIN pStyleHeader b WITH (NOLOCK) ON a.StyleID = b.StyleID
INNER JOIN pStyleColorwaySeasonYear d WITH  (NOLOCK) ON d.StyleColorwayID  = a.StyleColorID
WHERE b.StyleID IN (
		SELECT StyleID FROM pLinePlanItem 
		WHERE CAST(LinePlanRangeID AS VARCHAR(40)) = ''' +  @LinePlanRangeID +  ''' 
		AND CAST(StyleID AS VARCHAR(40)) <> ''00000000-0000-0000-0000-000000000000'' 
		AND CAST(LinePlanRangeTypeID AS VARCHAR(40)) = ''' +  @LinePlanRangeTypeID +  ''' 
) 
AND d.StyleSeasonYearID IN (
	SELECT StyleSeasonYearID FROM pStyleSeasonYear 
	WHERE LinePlanItemID  IN  ( 
		select LinePlanItemID 
		from pLinePlanItem
		WHERE LinePlanRangeID  = ''' +  @LinePlanRangeID +  ''' 
		AND StyleId  <> ''00000000-0000-0000-0000-000000000000'' 
	)
)
'


IF @ColorPaletteID <> ''
BEGIN
	SET @strQuery = @strQuery + ' AND CAST(a.ColorPaletteID AS VARCHAR(40)) = ''' + @ColorPaletteID + ''''
END
IF @ColorStatusID <> ''
BEGIN
	SET @strQuery = @strQuery + ' AND CAST(d.StyleColorStatus AS VARCHAR(5)) = ''' + @ColorStatusID + ''''
END


SET @strQuery = @strQuery + ' ORDER BY b.StyleNo, a.Sort, a.StyleColorName '

print @strQuery
EXEC (@strQuery) 
























GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_SampleRequestQAItem_UPDATE]'
GO

CREATE PROCEDURE [dbo].[spx_SampleRequestQAItem_UPDATE]
(
	@SampleRequestQAWorksheetID uniqueidentifier,
	@Submit int,
	@SizeIndex int,
	@WashType nvarchar(20),
	@Pom nvarchar(10),
	@PomMeasurment nvarchar(200),
	@Tol numeric(18,4),
	@TolN numeric(18,4),
	@Spec numeric(18,4),
	@Spec0 numeric(18,4),
	@Spec1 numeric(18,4),
	@Spec2 numeric(18,4),
	@Spec3 numeric(18,4),
	@Spec4 numeric(18,4),
	@Spec5 numeric(18,4),
	@Spec6 numeric(18,4),
	@Spec7 numeric(18,4),
	@Spec8 numeric(18,4),
	@Spec9 numeric(18,4),
	@ModifiedBy nvarchar(200),
	@ModifiedDate datetime
)

AS 

DECLARE @Query as varchar(4000)

SET @Query ='UPDATE pSampleRequestQAWorksheet SET '
SET @Query = @Query + ' pSampleRequestQAWorksheet.POM = ''' + ISNULL(@POM,'') + ''','
SET @Query = @Query + ' pSampleRequestQAWorksheet.PointMeasur = ''' + ISNULL(@PomMeasurment,'') + ''','
IF @WashType = 'NOWASH'
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.TOLN = ' + CAST(ISNULL(@TOLN,0) AS VARCHAR(10)) + ','
	END
ELSE
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.TOL = ' + CAST(ISNULL(@TOL,0) AS VARCHAR(10)) + ','
	END

IF @SizeIndex = 0
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask000 = ' + CAST(ISNULL(@Spec,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec000 = ' + CAST(ISNULL(@Spec0,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec001 = ' + CAST(ISNULL(@Spec1,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec002 = ' + CAST(ISNULL(@Spec2,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec003 = ' + CAST(ISNULL(@Spec3,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec004 = ' + CAST(ISNULL(@Spec4,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec005 = ' + CAST(ISNULL(@Spec5,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec006 = ' + CAST(ISNULL(@Spec6,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec007 = ' + CAST(ISNULL(@Spec7,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec008 = ' + CAST(ISNULL(@Spec8,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec009 = ' + CAST(ISNULL(@Spec9,0) AS VARCHAR(10)) + ','		
	END

IF @SizeIndex = 1
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask001 = ' + CAST(ISNULL(@Spec,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec010 = ' + CAST(ISNULL(@Spec0,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec011 = ' + CAST(ISNULL(@Spec1,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec012 = ' + CAST(ISNULL(@Spec2,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec013 = ' + CAST(ISNULL(@Spec3,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec014 = ' + CAST(ISNULL(@Spec4,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec015 = ' + CAST(ISNULL(@Spec5,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec016 = ' + CAST(ISNULL(@Spec6,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec017 = ' + CAST(ISNULL(@Spec7,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec018 = ' + CAST(ISNULL(@Spec8,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec019 = ' + CAST(ISNULL(@Spec9,0) AS VARCHAR(10)) + ','		
	END

IF @SizeIndex = 2
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask002 = ' + CAST(ISNULL(@Spec,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec020 = ' + CAST(ISNULL(@Spec0,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec021 = ' + CAST(ISNULL(@Spec1,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec022 = ' + CAST(ISNULL(@Spec2,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec023 = ' + CAST(ISNULL(@Spec3,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec024 = ' + CAST(ISNULL(@Spec4,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec025 = ' + CAST(ISNULL(@Spec5,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec026 = ' + CAST(ISNULL(@Spec6,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec027 = ' + CAST(ISNULL(@Spec7,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec028 = ' + CAST(ISNULL(@Spec8,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec029 = ' + CAST(ISNULL(@Spec9,0) AS VARCHAR(10)) + ','		
	END

IF @SizeIndex = 3
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask003 = ' + CAST(ISNULL(@Spec,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec030 = ' + CAST(ISNULL(@Spec0,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec031 = ' + CAST(ISNULL(@Spec1,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec032 = ' + CAST(ISNULL(@Spec2,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec033 = ' + CAST(ISNULL(@Spec3,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec034 = ' + CAST(ISNULL(@Spec4,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec035 = ' + CAST(ISNULL(@Spec5,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec036 = ' + CAST(ISNULL(@Spec6,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec037 = ' + CAST(ISNULL(@Spec7,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec038 = ' + CAST(ISNULL(@Spec8,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec039 = ' + CAST(ISNULL(@Spec9,0) AS VARCHAR(10)) + ','		
	END


IF @SizeIndex = 4
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask004 = ' + CAST(ISNULL(@Spec,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec040 = ' + CAST(ISNULL(@Spec0,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec041 = ' + CAST(ISNULL(@Spec1,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec042 = ' + CAST(ISNULL(@Spec2,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec043 = ' + CAST(ISNULL(@Spec3,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec044 = ' + CAST(ISNULL(@Spec4,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec045 = ' + CAST(ISNULL(@Spec5,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec046 = ' + CAST(ISNULL(@Spec6,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec047 = ' + CAST(ISNULL(@Spec7,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec048 = ' + CAST(ISNULL(@Spec8,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec049 = ' + CAST(ISNULL(@Spec9,0) AS VARCHAR(10)) + ','		
	END


IF @SizeIndex = 5
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask005 = ' + CAST(ISNULL(@Spec,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec050 = ' + CAST(ISNULL(@Spec0,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec051 = ' + CAST(ISNULL(@Spec1,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec052 = ' + CAST(ISNULL(@Spec2,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec053 = ' + CAST(ISNULL(@Spec3,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec054 = ' + CAST(ISNULL(@Spec4,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec055 = ' + CAST(ISNULL(@Spec5,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec056 = ' + CAST(ISNULL(@Spec6,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec057 = ' + CAST(ISNULL(@Spec7,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec058 = ' + CAST(ISNULL(@Spec8,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec059 = ' + CAST(ISNULL(@Spec9,0) AS VARCHAR(10)) + ','		
	END

IF @SizeIndex = 6
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask006 = ' + CAST(ISNULL(@Spec,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec060 = ' + CAST(ISNULL(@Spec0,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec061 = ' + CAST(ISNULL(@Spec1,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec062 = ' + CAST(ISNULL(@Spec2,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec063 = ' + CAST(ISNULL(@Spec3,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec064 = ' + CAST(ISNULL(@Spec4,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec065 = ' + CAST(ISNULL(@Spec5,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec066 = ' + CAST(ISNULL(@Spec6,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec067 = ' + CAST(ISNULL(@Spec7,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec068 = ' + CAST(ISNULL(@Spec8,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec069 = ' + CAST(ISNULL(@Spec9,0) AS VARCHAR(10)) + ','		
	END

IF @SizeIndex = 7
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask007 = ' + CAST(ISNULL(@Spec,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec070 = ' + CAST(ISNULL(@Spec0,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec071 = ' + CAST(ISNULL(@Spec1,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec072 = ' + CAST(ISNULL(@Spec2,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec073 = ' + CAST(ISNULL(@Spec3,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec074 = ' + CAST(ISNULL(@Spec4,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec075 = ' + CAST(ISNULL(@Spec5,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec076 = ' + CAST(ISNULL(@Spec6,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec077 = ' + CAST(ISNULL(@Spec7,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec078 = ' + CAST(ISNULL(@Spec8,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec079 = ' + CAST(ISNULL(@Spec9,0) AS VARCHAR(10)) + ','		
	END

IF @SizeIndex = 8
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask008 = ' + CAST(ISNULL(@Spec,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec080 = ' + CAST(ISNULL(@Spec0,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec081 = ' + CAST(ISNULL(@Spec1,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec082 = ' + CAST(ISNULL(@Spec2,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec083 = ' + CAST(ISNULL(@Spec3,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec084 = ' + CAST(ISNULL(@Spec4,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec085 = ' + CAST(ISNULL(@Spec5,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec086 = ' + CAST(ISNULL(@Spec6,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec087 = ' + CAST(ISNULL(@Spec7,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec088 = ' + CAST(ISNULL(@Spec8,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec089 = ' + CAST(ISNULL(@Spec9,0) AS VARCHAR(10)) + ','		
	END

IF @SizeIndex = 9
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask009 = ' + CAST(ISNULL(@Spec,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec090 = ' + CAST(ISNULL(@Spec0,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec091 = ' + CAST(ISNULL(@Spec1,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec092 = ' + CAST(ISNULL(@Spec2,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec093 = ' + CAST(ISNULL(@Spec3,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec094 = ' + CAST(ISNULL(@Spec4,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec095 = ' + CAST(ISNULL(@Spec5,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec096 = ' + CAST(ISNULL(@Spec6,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec097 = ' + CAST(ISNULL(@Spec7,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec098 = ' + CAST(ISNULL(@Spec8,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec099 = ' + CAST(ISNULL(@Spec9,0) AS VARCHAR(10)) + ','		
	END

IF @SizeIndex = 10
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask010 = ' + CAST(ISNULL(@Spec,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec100 = ' + CAST(ISNULL(@Spec0,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec101 = ' + CAST(ISNULL(@Spec1,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec102 = ' + CAST(ISNULL(@Spec2,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec103 = ' + CAST(ISNULL(@Spec3,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec104 = ' + CAST(ISNULL(@Spec4,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec105 = ' + CAST(ISNULL(@Spec5,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec106 = ' + CAST(ISNULL(@Spec6,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec107 = ' + CAST(ISNULL(@Spec7,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec108 = ' + CAST(ISNULL(@Spec8,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec109 = ' + CAST(ISNULL(@Spec9,0) AS VARCHAR(10)) + ','		
	END

IF @SizeIndex = 11
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask011 = ' + CAST(ISNULL(@Spec,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec110 = ' + CAST(ISNULL(@Spec0,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec111 = ' + CAST(ISNULL(@Spec1,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec112 = ' + CAST(ISNULL(@Spec2,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec113 = ' + CAST(ISNULL(@Spec3,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec114 = ' + CAST(ISNULL(@Spec4,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec115 = ' + CAST(ISNULL(@Spec5,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec116 = ' + CAST(ISNULL(@Spec6,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec117 = ' + CAST(ISNULL(@Spec7,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec118 = ' + CAST(ISNULL(@Spec8,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec119 = ' + CAST(ISNULL(@Spec9,0) AS VARCHAR(10)) + ','		
	END

IF @SizeIndex = 12
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask012 = ' + CAST(ISNULL(@Spec,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec120 = ' + CAST(ISNULL(@Spec0,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec121 = ' + CAST(ISNULL(@Spec1,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec122 = ' + CAST(ISNULL(@Spec2,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec123 = ' + CAST(ISNULL(@Spec3,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec124 = ' + CAST(ISNULL(@Spec4,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec125 = ' + CAST(ISNULL(@Spec5,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec126 = ' + CAST(ISNULL(@Spec6,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec127 = ' + CAST(ISNULL(@Spec7,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec128 = ' + CAST(ISNULL(@Spec8,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec129 = ' + CAST(ISNULL(@Spec9,0) AS VARCHAR(10)) + ','		
	END

IF @SizeIndex = 13
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask013 = ' + CAST(ISNULL(@Spec,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec130 = ' + CAST(ISNULL(@Spec0,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec131 = ' + CAST(ISNULL(@Spec1,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec132 = ' + CAST(ISNULL(@Spec2,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec133 = ' + CAST(ISNULL(@Spec3,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec134 = ' + CAST(ISNULL(@Spec4,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec135 = ' + CAST(ISNULL(@Spec5,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec136 = ' + CAST(ISNULL(@Spec6,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec137 = ' + CAST(ISNULL(@Spec7,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec138 = ' + CAST(ISNULL(@Spec8,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec139 = ' + CAST(ISNULL(@Spec9,0) AS VARCHAR(10)) + ','		
	END

IF @SizeIndex = 14
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask014 = ' + CAST(ISNULL(@Spec,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec140 = ' + CAST(ISNULL(@Spec0,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec141 = ' + CAST(ISNULL(@Spec1,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec142 = ' + CAST(ISNULL(@Spec2,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec143 = ' + CAST(ISNULL(@Spec3,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec144 = ' + CAST(ISNULL(@Spec4,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec145 = ' + CAST(ISNULL(@Spec5,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec146 = ' + CAST(ISNULL(@Spec6,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec147 = ' + CAST(ISNULL(@Spec7,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec148 = ' + CAST(ISNULL(@Spec8,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec149 = ' + CAST(ISNULL(@Spec9,0) AS VARCHAR(10)) + ','		
	END

IF @SizeIndex = 15
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask015 = ' + CAST(ISNULL(@Spec,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec150 = ' + CAST(ISNULL(@Spec0,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec151 = ' + CAST(ISNULL(@Spec1,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec152 = ' + CAST(ISNULL(@Spec2,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec153 = ' + CAST(ISNULL(@Spec3,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec154 = ' + CAST(ISNULL(@Spec4,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec155 = ' + CAST(ISNULL(@Spec5,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec156 = ' + CAST(ISNULL(@Spec6,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec157 = ' + CAST(ISNULL(@Spec7,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec158 = ' + CAST(ISNULL(@Spec8,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec159 = ' + CAST(ISNULL(@Spec9,0) AS VARCHAR(10)) + ','		
	END

IF @SizeIndex = 16
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask016 = ' + CAST(ISNULL(@Spec,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec160 = ' + CAST(ISNULL(@Spec0,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec161 = ' + CAST(ISNULL(@Spec1,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec162 = ' + CAST(ISNULL(@Spec2,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec163 = ' + CAST(ISNULL(@Spec3,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec164 = ' + CAST(ISNULL(@Spec4,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec165 = ' + CAST(ISNULL(@Spec5,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec166 = ' + CAST(ISNULL(@Spec6,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec167 = ' + CAST(ISNULL(@Spec7,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec168 = ' + CAST(ISNULL(@Spec8,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec169 = ' + CAST(ISNULL(@Spec9,0) AS VARCHAR(10)) + ','		
	END

IF @SizeIndex = 17
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask017 = ' + CAST(ISNULL(@Spec,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec170 = ' + CAST(ISNULL(@Spec0,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec171 = ' + CAST(ISNULL(@Spec1,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec172 = ' + CAST(ISNULL(@Spec2,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec173 = ' + CAST(ISNULL(@Spec3,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec174 = ' + CAST(ISNULL(@Spec4,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec175 = ' + CAST(ISNULL(@Spec5,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec176 = ' + CAST(ISNULL(@Spec6,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec177 = ' + CAST(ISNULL(@Spec7,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec178 = ' + CAST(ISNULL(@Spec8,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec179 = ' + CAST(ISNULL(@Spec9,0) AS VARCHAR(10)) + ','		
	END

IF @SizeIndex = 18
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask018 = ' + CAST(ISNULL(@Spec,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec180 = ' + CAST(ISNULL(@Spec0,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec181 = ' + CAST(ISNULL(@Spec1,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec182 = ' + CAST(ISNULL(@Spec2,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec183 = ' + CAST(ISNULL(@Spec3,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec184 = ' + CAST(ISNULL(@Spec4,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec185 = ' + CAST(ISNULL(@Spec5,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec186 = ' + CAST(ISNULL(@Spec6,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec187 = ' + CAST(ISNULL(@Spec7,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec188 = ' + CAST(ISNULL(@Spec8,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec189 = ' + CAST(ISNULL(@Spec9,0) AS VARCHAR(10)) + ','		
	END

IF @SizeIndex = 19
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask019 = ' + CAST(ISNULL(@Spec,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec190 = ' + CAST(ISNULL(@Spec0,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec191 = ' + CAST(ISNULL(@Spec1,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec192 = ' + CAST(ISNULL(@Spec2,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec193 = ' + CAST(ISNULL(@Spec3,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec194 = ' + CAST(ISNULL(@Spec4,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec195 = ' + CAST(ISNULL(@Spec5,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec196 = ' + CAST(ISNULL(@Spec6,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec197 = ' + CAST(ISNULL(@Spec7,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec198 = ' + CAST(ISNULL(@Spec8,0) AS VARCHAR(10)) + ','
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec199 = ' + CAST(ISNULL(@Spec9,0) AS VARCHAR(10)) + ','		
	END

	SET @Query = @Query + ' pSampleRequestQAWorksheet.MDate = ''' + CAST(ISNULL(@ModifiedDate,'') AS VARCHAR(40)) + ''','
	SET @Query = @Query + ' pSampleRequestQAWorksheet.MUser = ''' + CAST(ISNULL(@ModifiedBy ,'') AS NVARCHAR(200)) + ''''
	SET @Query = @Query + ' WHERE pSampleRequestQAWorksheet.SampleRequestQAWorksheetID = ''' + CAST(ISNULL(@SampleRequestQAWorksheetID,'') AS VARCHAR(40)) + '''' 

--
--SELECT @Query

BEGIN
	EXEC (@Query) 
END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[rpx_SampleRequestSubmit_QAWorksheet_SELECT]'
GO
CREATE PROCEDURE [dbo].[rpx_SampleRequestSubmit_QAWorksheet_SELECT] (
	@StyleID nvarchar(200), 
	@StyleSet int,
	@SampleRequestTradeID nvarchar(200),
	@SampleRequestWorkflowID nvarchar(200),
	@SampleWorkflowID varchar(50),
	@Submit int,
	@SizeIndex int
)
AS 


DECLARE @Query as varchar(4000)

SET @Query = ' SELECT pSampleRequestQAWorksheet.POM, pSampleRequestQAWorksheet.PointMeasur, '
SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.TOL) AS TOL, dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.TOLN) AS TOLN, '
SET @Query = @Query + ' pSampleRequestQAWorksheet.Critical, pSampleRequestQASize.NumberOfSamples, '

IF @SizeIndex = 0
	BEGIN
		SET @Query = @Query + ' pSampleRequestQASize.Size0 AS Size,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Ask000) AS Ask,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec000) AS Spec0,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask000, pSampleRequestQAWorksheet.Spec000, pSampleRequestQAWorksheet.TOL) AS TolFlag0,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec001) AS Spec1,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask000, pSampleRequestQAWorksheet.Spec001, pSampleRequestQAWorksheet.TOL) AS TolFlag1,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec002) AS Spec2,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask000, pSampleRequestQAWorksheet.Spec002, pSampleRequestQAWorksheet.TOL) AS TolFlag2,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec003) AS Spec3,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask000, pSampleRequestQAWorksheet.Spec003, pSampleRequestQAWorksheet.TOL) AS TolFlag3,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec004) AS Spec4,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask000, pSampleRequestQAWorksheet.Spec004, pSampleRequestQAWorksheet.TOL) AS TolFlag4,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec005) AS Spec5,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask000, pSampleRequestQAWorksheet.Spec005, pSampleRequestQAWorksheet.TOL) AS TolFlag5,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec006) AS Spec6,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask000, pSampleRequestQAWorksheet.Spec006, pSampleRequestQAWorksheet.TOL) AS TolFlag6,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec007) AS Spec7,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask000, pSampleRequestQAWorksheet.Spec007, pSampleRequestQAWorksheet.TOL) AS TolFlag7,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec008) AS Spec8,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask000, pSampleRequestQAWorksheet.Spec008, pSampleRequestQAWorksheet.TOL) AS TolFlag8,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec009) AS Spec9,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask000, pSampleRequestQAWorksheet.Spec009, pSampleRequestQAWorksheet.TOL) AS TolFlag9,'
	END

IF @SizeIndex = 1
	BEGIN
		SET @Query = @Query + ' pSampleRequestQASize.Size1 AS Size,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Ask001) AS Ask,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec010) AS Spec0,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask001, pSampleRequestQAWorksheet.Spec010, pSampleRequestQAWorksheet.TOL) AS TolFlag0,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec011) AS Spec1,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask001, pSampleRequestQAWorksheet.Spec011, pSampleRequestQAWorksheet.TOL) AS TolFlag1,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec012) AS Spec2,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask001, pSampleRequestQAWorksheet.Spec012, pSampleRequestQAWorksheet.TOL) AS TolFlag2,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec013) AS Spec3,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask001, pSampleRequestQAWorksheet.Spec013, pSampleRequestQAWorksheet.TOL) AS TolFlag3,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec014) AS Spec4,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask001, pSampleRequestQAWorksheet.Spec014, pSampleRequestQAWorksheet.TOL) AS TolFlag4,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec015) AS Spec5,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask001, pSampleRequestQAWorksheet.Spec015, pSampleRequestQAWorksheet.TOL) AS TolFlag5,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec016) AS Spec6,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask001, pSampleRequestQAWorksheet.Spec016, pSampleRequestQAWorksheet.TOL) AS TolFlag6,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec017) AS Spec7,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask001, pSampleRequestQAWorksheet.Spec017, pSampleRequestQAWorksheet.TOL) AS TolFlag7,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec018) AS Spec8,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask001, pSampleRequestQAWorksheet.Spec018, pSampleRequestQAWorksheet.TOL) AS TolFlag8,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec019) AS Spec9,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask001, pSampleRequestQAWorksheet.Spec019, pSampleRequestQAWorksheet.TOL) AS TolFlag9,'
	END

IF @SizeIndex = 2
	BEGIN
		SET @Query = @Query + ' pSampleRequestQASize.Size2 AS Size,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Ask002) AS Ask,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec020) AS Spec0,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask002, pSampleRequestQAWorksheet.Spec020, pSampleRequestQAWorksheet.TOL) AS TolFlag0,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec021) AS Spec1,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask002, pSampleRequestQAWorksheet.Spec021, pSampleRequestQAWorksheet.TOL) AS TolFlag1,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec022) AS Spec2,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask002, pSampleRequestQAWorksheet.Spec022, pSampleRequestQAWorksheet.TOL) AS TolFlag2,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec023) AS Spec3,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask002, pSampleRequestQAWorksheet.Spec023, pSampleRequestQAWorksheet.TOL) AS TolFlag3,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec024) AS Spec4,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask002, pSampleRequestQAWorksheet.Spec024, pSampleRequestQAWorksheet.TOL) AS TolFlag4,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec025) AS Spec5,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask002, pSampleRequestQAWorksheet.Spec025, pSampleRequestQAWorksheet.TOL) AS TolFlag5,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec026) AS Spec6,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask002, pSampleRequestQAWorksheet.Spec026, pSampleRequestQAWorksheet.TOL) AS TolFlag6,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec027) AS Spec7,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask002, pSampleRequestQAWorksheet.Spec027, pSampleRequestQAWorksheet.TOL) AS TolFlag7,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec028) AS Spec8,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask002, pSampleRequestQAWorksheet.Spec028, pSampleRequestQAWorksheet.TOL) AS TolFlag8,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec029) AS Spec9,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask002, pSampleRequestQAWorksheet.Spec029, pSampleRequestQAWorksheet.TOL) AS TolFlag9,'
	END

IF @SizeIndex = 3
	BEGIN
		SET @Query = @Query + ' pSampleRequestQASize.Size3 AS Size,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Ask003) AS Ask,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec030) AS Spec0,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask003, pSampleRequestQAWorksheet.Spec030, pSampleRequestQAWorksheet.TOL) AS TolFlag0,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec031) AS Spec1,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask003, pSampleRequestQAWorksheet.Spec031, pSampleRequestQAWorksheet.TOL) AS TolFlag1,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec032) AS Spec2,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask003, pSampleRequestQAWorksheet.Spec032, pSampleRequestQAWorksheet.TOL) AS TolFlag2,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec033) AS Spec3,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask003, pSampleRequestQAWorksheet.Spec033, pSampleRequestQAWorksheet.TOL) AS TolFlag3,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec034) AS Spec4,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask003, pSampleRequestQAWorksheet.Spec034, pSampleRequestQAWorksheet.TOL) AS TolFlag4,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec035) AS Spec5,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask003, pSampleRequestQAWorksheet.Spec035, pSampleRequestQAWorksheet.TOL) AS TolFlag5,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec036) AS Spec6,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask003, pSampleRequestQAWorksheet.Spec036, pSampleRequestQAWorksheet.TOL) AS TolFlag6,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec037) AS Spec7,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask003, pSampleRequestQAWorksheet.Spec037, pSampleRequestQAWorksheet.TOL) AS TolFlag7,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec038) AS Spec8,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask003, pSampleRequestQAWorksheet.Spec038, pSampleRequestQAWorksheet.TOL) AS TolFlag8,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec039) AS Spec9,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask003, pSampleRequestQAWorksheet.Spec039, pSampleRequestQAWorksheet.TOL) AS TolFlag9,'
	END


IF @SizeIndex = 4
	BEGIN
		SET @Query = @Query + ' pSampleRequestQASize.Size4 AS Size,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Ask004) AS Ask,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec040) AS Spec0,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask004, pSampleRequestQAWorksheet.Spec040, pSampleRequestQAWorksheet.TOL) AS TolFlag0,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec041) AS Spec1,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask004, pSampleRequestQAWorksheet.Spec041, pSampleRequestQAWorksheet.TOL) AS TolFlag1,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec042) AS Spec2,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask004, pSampleRequestQAWorksheet.Spec042, pSampleRequestQAWorksheet.TOL) AS TolFlag2,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec043) AS Spec3,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask004, pSampleRequestQAWorksheet.Spec043, pSampleRequestQAWorksheet.TOL) AS TolFlag3,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec044) AS Spec4,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask004, pSampleRequestQAWorksheet.Spec044, pSampleRequestQAWorksheet.TOL) AS TolFlag4,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec045) AS Spec5,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask004, pSampleRequestQAWorksheet.Spec045, pSampleRequestQAWorksheet.TOL) AS TolFlag5,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec046) AS Spec6,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask004, pSampleRequestQAWorksheet.Spec046, pSampleRequestQAWorksheet.TOL) AS TolFlag6,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec047) AS Spec7,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask004, pSampleRequestQAWorksheet.Spec047, pSampleRequestQAWorksheet.TOL) AS TolFlag7,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec048) AS Spec8,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask004, pSampleRequestQAWorksheet.Spec048, pSampleRequestQAWorksheet.TOL) AS TolFlag8,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec049) AS Spec9,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask004, pSampleRequestQAWorksheet.Spec049, pSampleRequestQAWorksheet.TOL) AS TolFlag9,'
	END


IF @SizeIndex = 5
	BEGIN
		SET @Query = @Query + ' pSampleRequestQASize.Size5 AS Size,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Ask005) AS Ask,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec050) AS Spec0,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask005, pSampleRequestQAWorksheet.Spec050, pSampleRequestQAWorksheet.TOL) AS TolFlag0,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec051) AS Spec1,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask005, pSampleRequestQAWorksheet.Spec051, pSampleRequestQAWorksheet.TOL) AS TolFlag1,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec052) AS Spec2,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask005, pSampleRequestQAWorksheet.Spec052, pSampleRequestQAWorksheet.TOL) AS TolFlag2,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec053) AS Spec3,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask005, pSampleRequestQAWorksheet.Spec053, pSampleRequestQAWorksheet.TOL) AS TolFlag3,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec054) AS Spec4,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask005, pSampleRequestQAWorksheet.Spec054, pSampleRequestQAWorksheet.TOL) AS TolFlag4,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec055) AS Spec5,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask005, pSampleRequestQAWorksheet.Spec055, pSampleRequestQAWorksheet.TOL) AS TolFlag5,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec056) AS Spec6,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask005, pSampleRequestQAWorksheet.Spec056, pSampleRequestQAWorksheet.TOL) AS TolFlag6,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec057) AS Spec7,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask005, pSampleRequestQAWorksheet.Spec057, pSampleRequestQAWorksheet.TOL) AS TolFlag7,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec058) AS Spec8,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask005, pSampleRequestQAWorksheet.Spec058, pSampleRequestQAWorksheet.TOL) AS TolFlag8,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec059) AS Spec9,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask005, pSampleRequestQAWorksheet.Spec059, pSampleRequestQAWorksheet.TOL) AS TolFlag9,'
	END

IF @SizeIndex = 6
	BEGIN
		SET @Query = @Query + ' pSampleRequestQASize.Size6 AS Size,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Ask006) AS Ask,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec060) AS Spec0,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask006, pSampleRequestQAWorksheet.Spec060, pSampleRequestQAWorksheet.TOL) AS TolFlag0,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec061) AS Spec1,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask006, pSampleRequestQAWorksheet.Spec061, pSampleRequestQAWorksheet.TOL) AS TolFlag1,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec062) AS Spec2,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask006, pSampleRequestQAWorksheet.Spec062, pSampleRequestQAWorksheet.TOL) AS TolFlag2,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec063) AS Spec3,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask006, pSampleRequestQAWorksheet.Spec063, pSampleRequestQAWorksheet.TOL) AS TolFlag3,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec064) AS Spec4,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask006, pSampleRequestQAWorksheet.Spec064, pSampleRequestQAWorksheet.TOL) AS TolFlag4,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec065) AS Spec5,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask006, pSampleRequestQAWorksheet.Spec065, pSampleRequestQAWorksheet.TOL) AS TolFlag5,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec066) AS Spec6,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask006, pSampleRequestQAWorksheet.Spec066, pSampleRequestQAWorksheet.TOL) AS TolFlag6,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec067) AS Spec7,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask006, pSampleRequestQAWorksheet.Spec067, pSampleRequestQAWorksheet.TOL) AS TolFlag7,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec068) AS Spec8,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask006, pSampleRequestQAWorksheet.Spec068, pSampleRequestQAWorksheet.TOL) AS TolFlag8,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec069) AS Spec9,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask006, pSampleRequestQAWorksheet.Spec069, pSampleRequestQAWorksheet.TOL) AS TolFlag9,'
	END

IF @SizeIndex = 7
	BEGIN
		SET @Query = @Query + ' pSampleRequestQASize.Size7 AS Size,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Ask007) AS Ask,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec070) AS Spec0,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask007, pSampleRequestQAWorksheet.Spec070, pSampleRequestQAWorksheet.TOL) AS TolFlag0,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec071) AS Spec1,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask007, pSampleRequestQAWorksheet.Spec071, pSampleRequestQAWorksheet.TOL) AS TolFlag1,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec072) AS Spec2,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask007, pSampleRequestQAWorksheet.Spec072, pSampleRequestQAWorksheet.TOL) AS TolFlag2,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec073) AS Spec3,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask007, pSampleRequestQAWorksheet.Spec073, pSampleRequestQAWorksheet.TOL) AS TolFlag3,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec074) AS Spec4,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask007, pSampleRequestQAWorksheet.Spec074, pSampleRequestQAWorksheet.TOL) AS TolFlag4,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec075) AS Spec5,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask007, pSampleRequestQAWorksheet.Spec075, pSampleRequestQAWorksheet.TOL) AS TolFlag5,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec076) AS Spec6,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask007, pSampleRequestQAWorksheet.Spec076, pSampleRequestQAWorksheet.TOL) AS TolFlag6,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec077) AS Spec7,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask007, pSampleRequestQAWorksheet.Spec077, pSampleRequestQAWorksheet.TOL) AS TolFlag7,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec078) AS Spec8,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask007, pSampleRequestQAWorksheet.Spec078, pSampleRequestQAWorksheet.TOL) AS TolFlag8,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec079) AS Spec9,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask007, pSampleRequestQAWorksheet.Spec079, pSampleRequestQAWorksheet.TOL) AS TolFlag9,'
	END

IF @SizeIndex = 8
	BEGIN
		SET @Query = @Query + ' pSampleRequestQASize.Size8 AS Size,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Ask008) AS Ask,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec080) AS Spec0,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask008, pSampleRequestQAWorksheet.Spec080, pSampleRequestQAWorksheet.TOL) AS TolFlag0,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec081) AS Spec1,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask008, pSampleRequestQAWorksheet.Spec081, pSampleRequestQAWorksheet.TOL) AS TolFlag1,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec082) AS Spec2,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask008, pSampleRequestQAWorksheet.Spec082, pSampleRequestQAWorksheet.TOL) AS TolFlag2,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec083) AS Spec3,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask008, pSampleRequestQAWorksheet.Spec083, pSampleRequestQAWorksheet.TOL) AS TolFlag3,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec084) AS Spec4,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask008, pSampleRequestQAWorksheet.Spec084, pSampleRequestQAWorksheet.TOL) AS TolFlag4,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec085) AS Spec5,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask008, pSampleRequestQAWorksheet.Spec085, pSampleRequestQAWorksheet.TOL) AS TolFlag5,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec086) AS Spec6,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask008, pSampleRequestQAWorksheet.Spec086, pSampleRequestQAWorksheet.TOL) AS TolFlag6,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec087) AS Spec7,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask008, pSampleRequestQAWorksheet.Spec087, pSampleRequestQAWorksheet.TOL) AS TolFlag7,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec088) AS Spec8,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask008, pSampleRequestQAWorksheet.Spec088, pSampleRequestQAWorksheet.TOL) AS TolFlag8,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec089) AS Spec9,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask008, pSampleRequestQAWorksheet.Spec089, pSampleRequestQAWorksheet.TOL) AS TolFlag9,'
	END

IF @SizeIndex = 9
	BEGIN
		SET @Query = @Query + ' pSampleRequestQASize.Size9 AS Size,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Ask009) AS Ask,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec090) AS Spec0,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask009, pSampleRequestQAWorksheet.Spec090, pSampleRequestQAWorksheet.TOL) AS TolFlag0,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec091) AS Spec1,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask009, pSampleRequestQAWorksheet.Spec091, pSampleRequestQAWorksheet.TOL) AS TolFlag1,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec092) AS Spec2,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask009, pSampleRequestQAWorksheet.Spec092, pSampleRequestQAWorksheet.TOL) AS TolFlag2,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec093) AS Spec3,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask009, pSampleRequestQAWorksheet.Spec093, pSampleRequestQAWorksheet.TOL) AS TolFlag3,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec094) AS Spec4,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask009, pSampleRequestQAWorksheet.Spec094, pSampleRequestQAWorksheet.TOL) AS TolFlag4,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec095) AS Spec5,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask009, pSampleRequestQAWorksheet.Spec095, pSampleRequestQAWorksheet.TOL) AS TolFlag5,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec096) AS Spec6,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask009, pSampleRequestQAWorksheet.Spec096, pSampleRequestQAWorksheet.TOL) AS TolFlag6,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec097) AS Spec7,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask009, pSampleRequestQAWorksheet.Spec097, pSampleRequestQAWorksheet.TOL) AS TolFlag7,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec098) AS Spec8,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask009, pSampleRequestQAWorksheet.Spec098, pSampleRequestQAWorksheet.TOL) AS TolFlag8,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec099) AS Spec9,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask009, pSampleRequestQAWorksheet.Spec099, pSampleRequestQAWorksheet.TOL) AS TolFlag9,'
	END

IF @SizeIndex = 10
	BEGIN
		SET @Query = @Query + ' pSampleRequestQASize.Size10 AS Size,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Ask010) AS Ask,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec100) AS Spec0,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask010, pSampleRequestQAWorksheet.Spec100, pSampleRequestQAWorksheet.TOL) AS TolFlag0,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec101) AS Spec1,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask010, pSampleRequestQAWorksheet.Spec101, pSampleRequestQAWorksheet.TOL) AS TolFlag1,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec102) AS Spec2,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask010, pSampleRequestQAWorksheet.Spec102, pSampleRequestQAWorksheet.TOL) AS TolFlag2,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec103) AS Spec3,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask010, pSampleRequestQAWorksheet.Spec103, pSampleRequestQAWorksheet.TOL) AS TolFlag3,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec104) AS Spec4,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask010, pSampleRequestQAWorksheet.Spec104, pSampleRequestQAWorksheet.TOL) AS TolFlag4,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec105) AS Spec5,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask010, pSampleRequestQAWorksheet.Spec105, pSampleRequestQAWorksheet.TOL) AS TolFlag5,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec106) AS Spec6,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask010, pSampleRequestQAWorksheet.Spec106, pSampleRequestQAWorksheet.TOL) AS TolFlag6,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec107) AS Spec7,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask010, pSampleRequestQAWorksheet.Spec107, pSampleRequestQAWorksheet.TOL) AS TolFlag7,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec108) AS Spec8,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask010, pSampleRequestQAWorksheet.Spec108, pSampleRequestQAWorksheet.TOL) AS TolFlag8,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec109) AS Spec9,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask010, pSampleRequestQAWorksheet.Spec109, pSampleRequestQAWorksheet.TOL) AS TolFlag9,'
	END

IF @SizeIndex = 11
	BEGIN
		SET @Query = @Query + ' pSampleRequestQASize.Size11 AS Size,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Ask011) AS Ask,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec110) AS Spec0,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask011, pSampleRequestQAWorksheet.Spec110, pSampleRequestQAWorksheet.TOL) AS TolFlag0,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec111) AS Spec1,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask011, pSampleRequestQAWorksheet.Spec111, pSampleRequestQAWorksheet.TOL) AS TolFlag1,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec112) AS Spec2,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask011, pSampleRequestQAWorksheet.Spec112, pSampleRequestQAWorksheet.TOL) AS TolFlag2,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec113) AS Spec3,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask011, pSampleRequestQAWorksheet.Spec113, pSampleRequestQAWorksheet.TOL) AS TolFlag3,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec114) AS Spec4,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask011, pSampleRequestQAWorksheet.Spec114, pSampleRequestQAWorksheet.TOL) AS TolFlag4,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec115) AS Spec5,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask011, pSampleRequestQAWorksheet.Spec115, pSampleRequestQAWorksheet.TOL) AS TolFlag5,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec116) AS Spec6,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask011, pSampleRequestQAWorksheet.Spec116, pSampleRequestQAWorksheet.TOL) AS TolFlag6,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec117) AS Spec7,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask011, pSampleRequestQAWorksheet.Spec117, pSampleRequestQAWorksheet.TOL) AS TolFlag7,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec118) AS Spec8,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask011, pSampleRequestQAWorksheet.Spec118, pSampleRequestQAWorksheet.TOL) AS TolFlag8,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec119) AS Spec9,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask011, pSampleRequestQAWorksheet.Spec119, pSampleRequestQAWorksheet.TOL) AS TolFlag9,'
	END

IF @SizeIndex = 12
	BEGIN
		SET @Query = @Query + ' pSampleRequestQASize.Size12 AS Size,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Ask012) AS Ask,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec120) AS Spec0,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask012, pSampleRequestQAWorksheet.Spec120, pSampleRequestQAWorksheet.TOL) AS TolFlag0,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec121) AS Spec1,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask012, pSampleRequestQAWorksheet.Spec121, pSampleRequestQAWorksheet.TOL) AS TolFlag1,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec122) AS Spec2,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask012, pSampleRequestQAWorksheet.Spec122, pSampleRequestQAWorksheet.TOL) AS TolFlag2,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec123) AS Spec3,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask012, pSampleRequestQAWorksheet.Spec123, pSampleRequestQAWorksheet.TOL) AS TolFlag3,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec124) AS Spec4,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask012, pSampleRequestQAWorksheet.Spec124, pSampleRequestQAWorksheet.TOL) AS TolFlag4,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec125) AS Spec5,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask012, pSampleRequestQAWorksheet.Spec125, pSampleRequestQAWorksheet.TOL) AS TolFlag5,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec126) AS Spec6,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask012, pSampleRequestQAWorksheet.Spec126, pSampleRequestQAWorksheet.TOL) AS TolFlag6,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec127) AS Spec7,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask012, pSampleRequestQAWorksheet.Spec127, pSampleRequestQAWorksheet.TOL) AS TolFlag7,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec128) AS Spec8,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask012, pSampleRequestQAWorksheet.Spec128, pSampleRequestQAWorksheet.TOL) AS TolFlag8,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec129) AS Spec9,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask012, pSampleRequestQAWorksheet.Spec129, pSampleRequestQAWorksheet.TOL) AS TolFlag9,'
	END

IF @SizeIndex = 13
	BEGIN
		SET @Query = @Query + ' pSampleRequestQASize.Size13 AS Size,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Ask013) AS Ask,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec130) AS Spec0,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask013, pSampleRequestQAWorksheet.Spec130, pSampleRequestQAWorksheet.TOL) AS TolFlag0,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec131) AS Spec1,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask013, pSampleRequestQAWorksheet.Spec131, pSampleRequestQAWorksheet.TOL) AS TolFlag1,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec132) AS Spec2,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask013, pSampleRequestQAWorksheet.Spec132, pSampleRequestQAWorksheet.TOL) AS TolFlag2,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec133) AS Spec3,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask013, pSampleRequestQAWorksheet.Spec133, pSampleRequestQAWorksheet.TOL) AS TolFlag3,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec134) AS Spec4,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask013, pSampleRequestQAWorksheet.Spec134, pSampleRequestQAWorksheet.TOL) AS TolFlag4,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec135) AS Spec5,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask013, pSampleRequestQAWorksheet.Spec135, pSampleRequestQAWorksheet.TOL) AS TolFlag5,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec136) AS Spec6,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask013, pSampleRequestQAWorksheet.Spec136, pSampleRequestQAWorksheet.TOL) AS TolFlag6,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec137) AS Spec7,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask013, pSampleRequestQAWorksheet.Spec137, pSampleRequestQAWorksheet.TOL) AS TolFlag7,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec138) AS Spec8,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask013, pSampleRequestQAWorksheet.Spec138, pSampleRequestQAWorksheet.TOL) AS TolFlag8,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec139) AS Spec9,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask013, pSampleRequestQAWorksheet.Spec139, pSampleRequestQAWorksheet.TOL) AS TolFlag9,'
	END

IF @SizeIndex = 14
	BEGIN
		SET @Query = @Query + ' pSampleRequestQASize.Size14 AS Size,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Ask014) AS Ask,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec140) AS Spec0,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask014, pSampleRequestQAWorksheet.Spec140, pSampleRequestQAWorksheet.TOL) AS TolFlag0,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec141) AS Spec1,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask014, pSampleRequestQAWorksheet.Spec141, pSampleRequestQAWorksheet.TOL) AS TolFlag1,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec142) AS Spec2,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask014, pSampleRequestQAWorksheet.Spec142, pSampleRequestQAWorksheet.TOL) AS TolFlag2,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec143) AS Spec3,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask014, pSampleRequestQAWorksheet.Spec143, pSampleRequestQAWorksheet.TOL) AS TolFlag3,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec144) AS Spec4,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask014, pSampleRequestQAWorksheet.Spec144, pSampleRequestQAWorksheet.TOL) AS TolFlag4,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec145) AS Spec5,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask014, pSampleRequestQAWorksheet.Spec145, pSampleRequestQAWorksheet.TOL) AS TolFlag5,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec146) AS Spec6,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask014, pSampleRequestQAWorksheet.Spec146, pSampleRequestQAWorksheet.TOL) AS TolFlag6,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec147) AS Spec7,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask014, pSampleRequestQAWorksheet.Spec147, pSampleRequestQAWorksheet.TOL) AS TolFlag7,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec148) AS Spec8,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask014, pSampleRequestQAWorksheet.Spec148, pSampleRequestQAWorksheet.TOL) AS TolFlag8,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec149) AS Spec9,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask014, pSampleRequestQAWorksheet.Spec149, pSampleRequestQAWorksheet.TOL) AS TolFlag9,'
	END

IF @SizeIndex = 15
	BEGIN
		SET @Query = @Query + ' pSampleRequestQASize.Size15 AS Size,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Ask015) AS Ask,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec150) AS Spec0,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask015, pSampleRequestQAWorksheet.Spec150, pSampleRequestQAWorksheet.TOL) AS TolFlag0,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec151) AS Spec1,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask015, pSampleRequestQAWorksheet.Spec151, pSampleRequestQAWorksheet.TOL) AS TolFlag1,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec152) AS Spec2,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask015, pSampleRequestQAWorksheet.Spec152, pSampleRequestQAWorksheet.TOL) AS TolFlag2,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec153) AS Spec3,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask015, pSampleRequestQAWorksheet.Spec153, pSampleRequestQAWorksheet.TOL) AS TolFlag3,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec154) AS Spec4,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask015, pSampleRequestQAWorksheet.Spec154, pSampleRequestQAWorksheet.TOL) AS TolFlag4,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec155) AS Spec5,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask015, pSampleRequestQAWorksheet.Spec155, pSampleRequestQAWorksheet.TOL) AS TolFlag5,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec156) AS Spec6,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask015, pSampleRequestQAWorksheet.Spec156, pSampleRequestQAWorksheet.TOL) AS TolFlag6,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec157) AS Spec7,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask015, pSampleRequestQAWorksheet.Spec157, pSampleRequestQAWorksheet.TOL) AS TolFlag7,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec158) AS Spec8,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask015, pSampleRequestQAWorksheet.Spec158, pSampleRequestQAWorksheet.TOL) AS TolFlag8,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec159) AS Spec9,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask015, pSampleRequestQAWorksheet.Spec159, pSampleRequestQAWorksheet.TOL) AS TolFlag9,'
	END

IF @SizeIndex = 16
	BEGIN
		SET @Query = @Query + ' pSampleRequestQASize.Size16 AS Size,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Ask016) AS Ask,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec160) AS Spec0,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask016, pSampleRequestQAWorksheet.Spec160, pSampleRequestQAWorksheet.TOL) AS TolFlag0,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec161) AS Spec1,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask016, pSampleRequestQAWorksheet.Spec161, pSampleRequestQAWorksheet.TOL) AS TolFlag1,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec162) AS Spec2,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask016, pSampleRequestQAWorksheet.Spec162, pSampleRequestQAWorksheet.TOL) AS TolFlag2,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec163) AS Spec3,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask016, pSampleRequestQAWorksheet.Spec163, pSampleRequestQAWorksheet.TOL) AS TolFlag3,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec164) AS Spec4,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask016, pSampleRequestQAWorksheet.Spec164, pSampleRequestQAWorksheet.TOL) AS TolFlag4,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec165) AS Spec5,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask016, pSampleRequestQAWorksheet.Spec165, pSampleRequestQAWorksheet.TOL) AS TolFlag5,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec166) AS Spec6,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask016, pSampleRequestQAWorksheet.Spec166, pSampleRequestQAWorksheet.TOL) AS TolFlag6,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec167) AS Spec7,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask016, pSampleRequestQAWorksheet.Spec167, pSampleRequestQAWorksheet.TOL) AS TolFlag7,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec168) AS Spec8,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask016, pSampleRequestQAWorksheet.Spec168, pSampleRequestQAWorksheet.TOL) AS TolFlag8,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec169) AS Spec9,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask016, pSampleRequestQAWorksheet.Spec169, pSampleRequestQAWorksheet.TOL) AS TolFlag9,'
	END

IF @SizeIndex = 17
	BEGIN
		SET @Query = @Query + ' pSampleRequestQASize.Size17 AS Size,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Ask017) AS Ask,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec170) AS Spec0,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask017, pSampleRequestQAWorksheet.Spec170, pSampleRequestQAWorksheet.TOL) AS TolFlag0,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec171) AS Spec1,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask017, pSampleRequestQAWorksheet.Spec171, pSampleRequestQAWorksheet.TOL) AS TolFlag1,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec172) AS Spec2,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask017, pSampleRequestQAWorksheet.Spec172, pSampleRequestQAWorksheet.TOL) AS TolFlag2,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec173) AS Spec3,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask017, pSampleRequestQAWorksheet.Spec173, pSampleRequestQAWorksheet.TOL) AS TolFlag3,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec174) AS Spec4,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask017, pSampleRequestQAWorksheet.Spec174, pSampleRequestQAWorksheet.TOL) AS TolFlag4,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec175) AS Spec5,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask017, pSampleRequestQAWorksheet.Spec175, pSampleRequestQAWorksheet.TOL) AS TolFlag5,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec176) AS Spec6,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask017, pSampleRequestQAWorksheet.Spec176, pSampleRequestQAWorksheet.TOL) AS TolFlag6,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec177) AS Spec7,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask017, pSampleRequestQAWorksheet.Spec177, pSampleRequestQAWorksheet.TOL) AS TolFlag7,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec178) AS Spec8,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask017, pSampleRequestQAWorksheet.Spec178, pSampleRequestQAWorksheet.TOL) AS TolFlag8,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec179) AS Spec9,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask017, pSampleRequestQAWorksheet.Spec179, pSampleRequestQAWorksheet.TOL) AS TolFlag9,'
	END

IF @SizeIndex = 18
	BEGIN
		SET @Query = @Query + ' pSampleRequestQASize.Size18 AS Size,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Ask018) AS Ask,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec180) AS Spec0,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask018, pSampleRequestQAWorksheet.Spec180, pSampleRequestQAWorksheet.TOL) AS TolFlag0,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec181) AS Spec1,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask018, pSampleRequestQAWorksheet.Spec181, pSampleRequestQAWorksheet.TOL) AS TolFlag1,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec182) AS Spec2,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask018, pSampleRequestQAWorksheet.Spec182, pSampleRequestQAWorksheet.TOL) AS TolFlag2,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec183) AS Spec3,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask018, pSampleRequestQAWorksheet.Spec183, pSampleRequestQAWorksheet.TOL) AS TolFlag3,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec184) AS Spec4,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask018, pSampleRequestQAWorksheet.Spec184, pSampleRequestQAWorksheet.TOL) AS TolFlag4,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec185) AS Spec5,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask018, pSampleRequestQAWorksheet.Spec185, pSampleRequestQAWorksheet.TOL) AS TolFlag5,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec186) AS Spec6,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask018, pSampleRequestQAWorksheet.Spec186, pSampleRequestQAWorksheet.TOL) AS TolFlag6,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec187) AS Spec7,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask018, pSampleRequestQAWorksheet.Spec187, pSampleRequestQAWorksheet.TOL) AS TolFlag7,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec188) AS Spec8,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask018, pSampleRequestQAWorksheet.Spec188, pSampleRequestQAWorksheet.TOL) AS TolFlag8,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec189) AS Spec9,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask018, pSampleRequestQAWorksheet.Spec189, pSampleRequestQAWorksheet.TOL) AS TolFlag9,'
	END

IF @SizeIndex = 19
	BEGIN
		SET @Query = @Query + ' pSampleRequestQASize.Size19 AS Size,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Ask019) AS Ask,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec190) AS Spec0,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask019, pSampleRequestQAWorksheet.Spec190, pSampleRequestQAWorksheet.TOL) AS TolFlag0,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec191) AS Spec1,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask019, pSampleRequestQAWorksheet.Spec191, pSampleRequestQAWorksheet.TOL) AS TolFlag1,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec192) AS Spec2,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask019, pSampleRequestQAWorksheet.Spec192, pSampleRequestQAWorksheet.TOL) AS TolFlag2,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec193) AS Spec3,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask019, pSampleRequestQAWorksheet.Spec193, pSampleRequestQAWorksheet.TOL) AS TolFlag3,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec194) AS Spec4,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask019, pSampleRequestQAWorksheet.Spec194, pSampleRequestQAWorksheet.TOL) AS TolFlag4,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec195) AS Spec5,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask019, pSampleRequestQAWorksheet.Spec195, pSampleRequestQAWorksheet.TOL) AS TolFlag5,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec196) AS Spec6,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask019, pSampleRequestQAWorksheet.Spec196, pSampleRequestQAWorksheet.TOL) AS TolFlag6,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec197) AS Spec7,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask019, pSampleRequestQAWorksheet.Spec197, pSampleRequestQAWorksheet.TOL) AS TolFlag7,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec198) AS Spec8,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask019, pSampleRequestQAWorksheet.Spec198, pSampleRequestQAWorksheet.TOL) AS TolFlag8,'
		SET @Query = @Query + ' dbo.fnx_Num2Frac(pSampleRequestQAWorksheet.Spec199) AS Spec9,'
		SET @Query = @Query + ' dbo.fnx_ToleranceFlag(pSampleRequestQAWorksheet.Ask019, pSampleRequestQAWorksheet.Spec199, pSampleRequestQAWorksheet.TOL) AS TolFlag9,'
	END

		SET @Query = @Query + ' pSampleRequestQAWorksheet.CDate, pSampleRequestQAWorksheet.CUser, pSampleRequestQAWorksheet.MDate, '
		SET @Query = @Query + ' pSampleRequestQAWorksheet.MUser, pSampleRequestQAWorksheet.Change, pSampleRequestQAWorksheet.Sort, pPOMLibrary.HowToMeasurText, '
		SET @Query = @Query + ' pPOMLibrary.HowToMeasurImage '
		SET @Query = @Query + ' FROM  pSampleRequestQAWorksheet '
		SET @Query = @Query + ' LEFT OUTER JOIN pPOMLibrary ON pSampleRequestQAWorksheet.POMLibraryID = pPOMLibrary.POMLibraryID '
		SET @Query = @Query + ' LEFT OUTER JOIN pSampleRequestQASize ON pSampleRequestQAWorksheet.SampleRequestTradeID = pSampleRequestQASize.SampleRequestTradeID '
		SET @Query = @Query + '											AND pSampleRequestQAWorksheet.SampleRequestWorkflowID = pSampleRequestQASize.SampleRequestWorkflowID '
		SET @Query = @Query + '											AND pSampleRequestQAWorksheet.SampleWorkflowID = pSampleRequestQASize.SampleWorkflowID '
		SET @Query = @Query + '											AND pSampleRequestQAWorksheet.StyleID = pSampleRequestQASize.StyleID '
		SET @Query = @Query + '											AND pSampleRequestQAWorksheet.StyleColorID = pSampleRequestQASize.StyleColorID '
		SET @Query = @Query + '											AND pSampleRequestQAWorksheet.StyleSet = pSampleRequestQASize.StyleSet '
		SET @Query = @Query + ' WHERE pSampleRequestQAWorksheet.StyleID = ''' + CAST(ISNULL(@StyleID,'') AS VARCHAR(40)) + ''''
		SET @Query = @Query + ' AND  pSampleRequestQAWorksheet.StyleSet = ''' + CAST(ISNULL(@StyleSet,'') AS VARCHAR(2)) + ''''
		SET @Query = @Query + ' AND pSampleRequestQAWorksheet.SampleRequestTradeID = ''' + CAST(ISNULL(@SampleRequestTradeID,'') AS VARCHAR(40)) + ''''
		SET @Query = @Query + ' AND pSampleRequestQAWorksheet.SampleRequestWorkflowID = ''' + CAST(ISNULL(@SampleRequestWorkflowID,'') AS VARCHAR(40)) + ''''
		SET @Query = @Query + ' AND pSampleRequestQAWorksheet.SampleWorkflowID = ''' + CAST(ISNULL(@SampleWorkflowID,'') AS VARCHAR(10)) + ''''
		SET @Query = @Query + ' AND pSampleRequestQAWorksheet.Submit = ''' + CAST(ISNULL(@Submit,'') AS VARCHAR(2)) + ''''
		SET @Query = @Query + ' ORDER BY pSampleRequestQAWorksheet.Sort, pSampleRequestQAWorksheet.POM, pSampleRequestQAWorksheet.PointMeasur '


--SELECT @Query

BEGIN
	EXEC (@Query) 
END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_SampleRequestQAWorksheetDataSet_SELECT]'
GO

/*
Comments:

#01 - Ryan Cabanas - November 13, 2009
	Modified the 'Ask' field for the 17th set because it was accidentally pointing
to 'Ask014'.  Should be 'Ask017'.
*/

CREATE  PROCEDURE [dbo].[spx_SampleRequestQAWorksheetDataSet_SELECT] (
	@StyleID uniqueidentifier, 
	@StyleSet int,
	@SampleRequestTradeID uniqueidentifier,
	@SampleRequestWorkflowID uniqueidentifier,
	@SampleWorkflowID varchar (50) ,
	@Submit int,
	@nHowToMeasure int = 0, 
	@SizeIndex int
)
AS 


DECLARE @Query as varchar(4000)

SET @Query = ' SELECT SampleRequestQAWorksheetID, SampleRequestQAWorksheetSizeID, SampleRequestTradeID, SampleRequestWorkflowID, SampleWorkflowID, TradePartnerVendorID, '
SET @Query = @Query + ' WorkflowID, SpecMasterID, pSampleRequestQAWorksheet.POMTempItemID, pSampleRequestQAWorksheet.POMLibraryID, ModelSpecID, ModelID, ' 
SET @Query = @Query + ' POMTempID, StyleID, StyleColorID, Submit, Critical, SpecID, StyleSet, pSampleRequestQAWorksheet.POM, '
SET @Query = @Query + ' pSampleRequestQAWorksheet.PointMeasur, TOL, TOLN, '     

IF @SizeIndex = 0
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask000 AS Ask,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec000 AS Spec0,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec001 AS Spec1,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec002 AS Spec2,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec003 AS Spec3,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec004 AS Spec4,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec005 AS Spec5,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec006 AS Spec6,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec007 AS Spec7,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec008 AS Spec8,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec009 AS Spec9,'		
	END

IF @SizeIndex = 1
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask001 AS Ask,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec010 AS Spec0,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec011 AS Spec1,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec012 AS Spec2,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec013 AS Spec3,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec014 AS Spec4,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec015 AS Spec5,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec016 AS Spec6,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec017 AS Spec7,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec018 AS Spec8,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec019 AS Spec9,'		
	END

IF @SizeIndex = 2
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask002 AS Ask,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec020 AS Spec0,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec021 AS Spec1,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec022 AS Spec2,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec023 AS Spec3,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec024 AS Spec4,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec025 AS Spec5,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec026 AS Spec6,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec027 AS Spec7,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec028 AS Spec8,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec029 AS Spec9,'		
	END

IF @SizeIndex = 3
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask003 AS Ask,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec030 AS Spec0,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec031 AS Spec1,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec032 AS Spec2,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec033 AS Spec3,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec034 AS Spec4,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec035 AS Spec5,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec036 AS Spec6,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec037 AS Spec7,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec038 AS Spec8,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec039 AS Spec9,'		
	END


IF @SizeIndex = 4
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask004 AS Ask,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec040 AS Spec0,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec041 AS Spec1,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec042 AS Spec2,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec043 AS Spec3,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec044 AS Spec4,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec045 AS Spec5,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec046 AS Spec6,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec047 AS Spec7,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec048 AS Spec8,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec049 AS Spec9,'		
	END


IF @SizeIndex = 5
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask005 AS Ask,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec050 AS Spec0,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec051 AS Spec1,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec052 AS Spec2,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec053 AS Spec3,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec054 AS Spec4,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec055 AS Spec5,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec056 AS Spec6,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec057 AS Spec7,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec058 AS Spec8,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec059 AS Spec9,'		
	END

IF @SizeIndex = 6
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask006 AS Ask,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec060 AS Spec0,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec061 AS Spec1,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec062 AS Spec2,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec063 AS Spec3,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec064 AS Spec4,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec065 AS Spec5,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec066 AS Spec6,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec067 AS Spec7,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec068 AS Spec8,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec069 AS Spec9,'		
	END

IF @SizeIndex = 7
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask007 AS Ask,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec070 AS Spec0,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec071 AS Spec1,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec072 AS Spec2,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec073 AS Spec3,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec074 AS Spec4,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec075 AS Spec5,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec076 AS Spec6,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec077 AS Spec7,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec078 AS Spec8,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec079 AS Spec9,'		
	END

IF @SizeIndex = 8
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask008 AS Ask,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec080 AS Spec0,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec081 AS Spec1,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec082 AS Spec2,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec083 AS Spec3,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec084 AS Spec4,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec085 AS Spec5,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec086 AS Spec6,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec087 AS Spec7,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec088 AS Spec8,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec089 AS Spec9,'		
	END

IF @SizeIndex = 9
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask009 AS Ask,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec090 AS Spec0,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec091 AS Spec1,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec092 AS Spec2,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec093 AS Spec3,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec094 AS Spec4,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec095 AS Spec5,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec096 AS Spec6,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec097 AS Spec7,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec098 AS Spec8,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec099 AS Spec9,'		
	END

IF @SizeIndex = 10
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask010 AS Ask,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec100 AS Spec0,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec101 AS Spec1,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec102 AS Spec2,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec103 AS Spec3,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec104 AS Spec4,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec105 AS Spec5,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec106 AS Spec6,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec107 AS Spec7,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec108 AS Spec8,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec109 AS Spec9,'		
	END

IF @SizeIndex = 11
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask011 AS Ask,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec110 AS Spec0,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec111 AS Spec1,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec112 AS Spec2,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec113 AS Spec3,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec114 AS Spec4,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec115 AS Spec5,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec116 AS Spec6,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec117 AS Spec7,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec118 AS Spec8,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec119 AS Spec9,'		
	END

IF @SizeIndex = 12
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask012 AS Ask,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec120 AS Spec0,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec121 AS Spec1,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec122 AS Spec2,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec123 AS Spec3,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec124 AS Spec4,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec125 AS Spec5,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec126 AS Spec6,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec127 AS Spec7,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec128 AS Spec8,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec129 AS Spec9,'		
	END

IF @SizeIndex = 13
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask013 AS Ask,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec130 AS Spec0,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec131 AS Spec1,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec132 AS Spec2,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec133 AS Spec3,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec134 AS Spec4,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec135 AS Spec5,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec136 AS Spec6,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec137 AS Spec7,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec138 AS Spec8,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec139 AS Spec9,'		
	END

IF @SizeIndex = 14
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask014 AS Ask,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec140 AS Spec0,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec141 AS Spec1,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec142 AS Spec2,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec143 AS Spec3,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec144 AS Spec4,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec145 AS Spec5,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec146 AS Spec6,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec147 AS Spec7,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec148 AS Spec8,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec149 AS Spec9,'		
	END

IF @SizeIndex = 15
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask015 AS Ask,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec150 AS Spec0,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec151 AS Spec1,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec152 AS Spec2,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec153 AS Spec3,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec154 AS Spec4,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec155 AS Spec5,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec156 AS Spec6,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec157 AS Spec7,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec158 AS Spec8,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec159 AS Spec9,'		
	END

IF @SizeIndex = 16
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask016 AS Ask,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec160 AS Spec0,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec161 AS Spec1,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec162 AS Spec2,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec163 AS Spec3,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec164 AS Spec4,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec165 AS Spec5,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec166 AS Spec6,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec167 AS Spec7,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec168 AS Spec8,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec169 AS Spec9,'		
	END

IF @SizeIndex = 17
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask017 AS Ask,'		--Comment #01
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec170 AS Spec0,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec171 AS Spec1,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec172 AS Spec2,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec173 AS Spec3,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec174 AS Spec4,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec175 AS Spec5,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec176 AS Spec6,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec177 AS Spec7,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec178 AS Spec8,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec179 AS Spec9,'		
	END

IF @SizeIndex = 18
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask018 AS Ask,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec180 AS Spec0,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec181 AS Spec1,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec182 AS Spec2,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec183 AS Spec3,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec184 AS Spec4,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec185 AS Spec5,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec186 AS Spec6,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec187 AS Spec7,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec188 AS Spec8,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec189 AS Spec9,'		
	END

IF @SizeIndex = 19
	BEGIN
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Ask019 AS Ask,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec190 AS Spec0,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec191 AS Spec1,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec192 AS Spec2,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec193 AS Spec3,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec194 AS Spec4,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec195 AS Spec5,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec196 AS Spec6,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec197 AS Spec7,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec198 AS Spec8,'
		SET @Query = @Query + ' pSampleRequestQAWorksheet.Spec199 AS Spec9,'		
	END

		SET @Query = @Query + ' pSampleRequestQAWorksheet.CDate, pSampleRequestQAWorksheet.CUser, pSampleRequestQAWorksheet.MDate, '
		SET @Query = @Query + ' pSampleRequestQAWorksheet.MUser, pSampleRequestQAWorksheet.Change, pSampleRequestQAWorksheet.Sort, pPOMLibrary.HowToMeasurText, '
		SET @Query = @Query + ' pPOMLibrary.HowToMeasurImage '
		SET @Query = @Query + ' FROM  pSampleRequestQAWorksheet LEFT OUTER JOIN '
		SET @Query = @Query + ' pPOMLibrary ON pSampleRequestQAWorksheet.POMLibraryID = pPOMLibrary.POMLibraryID '
		SET @Query = @Query + ' WHERE pSampleRequestQAWorksheet.StyleID = ''' + CAST(ISNULL(@StyleID,'') AS VARCHAR(40)) + ''''
		SET @Query = @Query + ' AND  pSampleRequestQAWorksheet.StyleSet = ''' + CAST(ISNULL(@StyleSet,'') AS VARCHAR(2)) + ''''
		SET @Query = @Query + ' AND pSampleRequestQAWorksheet.SampleRequestTradeID = ''' + CAST(ISNULL(@SampleRequestTradeID,'') AS VARCHAR(40)) + ''''
		SET @Query = @Query + ' AND pSampleRequestQAWorksheet.SampleRequestWorkflowID = ''' + CAST(ISNULL(@SampleRequestWorkflowID,'') AS VARCHAR(40)) + ''''
		SET @Query = @Query + ' AND pSampleRequestQAWorksheet.SampleWorkflowID = ''' + CAST(ISNULL(@SampleWorkflowID,'') AS VARCHAR(10)) + ''''
		SET @Query = @Query + ' AND pSampleRequestQAWorksheet.Submit = ''' + CAST(ISNULL(@Submit,'') AS VARCHAR(2)) + ''''
		SET @Query = @Query + ' ORDER BY pSampleRequestQAWorksheet.Sort, pSampleRequestQAWorksheet.POM, pSampleRequestQAWorksheet.PointMeasur '


--SELECT @Query

BEGIN
	EXEC (@Query) 
END



GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_StyleSourcing_MostLikelyVendor_Logic_UPDATE]'
GO


CREATE PROCEDURE [dbo].[spx_StyleSourcing_MostLikelyVendor_Logic_UPDATE] (
@StyleSeasonYearID UNIQUEIDENTIFIER ,
@MUser NVARCHAR(200),
@MDate DATETIME 
)
AS 


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_Material_NewLogic_UPDATE]'
GO

CREATE procedure dbo.spx_Material_NewLogic_UPDATE (
@MaterialID UNIQUEIDENTIFIER ,
@MUser NVARCHAR(200) ,
@MDate DATETIME 
) 
AS 

	DECLARE @DUMMY INT


GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating [dbo].[spx_SampleRequestQASize_UPDATE]'
GO

CREATE PROCEDURE [dbo].[spx_SampleRequestQASize_UPDATE]
(
	@StyleID uniqueidentifier, 
	@SampleRequestTradeID uniqueidentifier,
	@SampleRequestWorkflowID uniqueidentifier,
	@NoOfSamples int,
	@SizeIndex int,
	@Selected int,
	@ModifiedBy nvarchar(200),
	@ModifiedDate datetime
)

AS 

DECLARE @Query as varchar(4000)

SET @Query ='UPDATE pSampleRequestQASize SET '

IF @SizeIndex = 0
	BEGIN
		SET @Query = @Query + ' Sel0 = ' + CAST(ISNULL(@Selected,0) AS VARCHAR(1)) + ','
	END

IF @SizeIndex = 1
	BEGIN
		SET @Query = @Query + ' Sel1 = ' + CAST(ISNULL(@Selected,0) AS VARCHAR(1)) + ','
	END

IF @SizeIndex = 2
	BEGIN
		SET @Query = @Query + ' Sel2 = ' + CAST(ISNULL(@Selected,0) AS VARCHAR(1)) + ','
	END

IF @SizeIndex = 3
	BEGIN
		SET @Query = @Query + ' Sel3 = ' + CAST(ISNULL(@Selected,0) AS VARCHAR(1)) + ','
	END

IF @SizeIndex = 4
	BEGIN
		SET @Query = @Query + ' Sel4 = ' + CAST(ISNULL(@Selected,0) AS VARCHAR(1)) + ','
	END

IF @SizeIndex = 5
	BEGIN
		SET @Query = @Query + ' Sel5 = ' + CAST(ISNULL(@Selected,0) AS VARCHAR(1)) + ','	
	END

IF @SizeIndex = 6
	BEGIN
		SET @Query = @Query + ' Sel6 = ' + CAST(ISNULL(@Selected,0) AS VARCHAR(1)) + ','	
	END

IF @SizeIndex = 7
	BEGIN
		SET @Query = @Query + ' Sel7 = ' + CAST(ISNULL(@Selected,0) AS VARCHAR(1)) + ','
	END

IF @SizeIndex = 8
	BEGIN
		SET @Query = @Query + ' Sel8 = ' + CAST(ISNULL(@Selected,0) AS VARCHAR(1)) + ','	
	END

IF @SizeIndex = 9
	BEGIN
		SET @Query = @Query + ' Sel9 = ' + CAST(ISNULL(@Selected,0) AS VARCHAR(1)) + ','
	END

IF @SizeIndex = 10
	BEGIN
		SET @Query = @Query + ' Sel10 = ' + CAST(ISNULL(@Selected,0) AS VARCHAR(1)) + ','	
	END

IF @SizeIndex = 11
	BEGIN
		SET @Query = @Query + ' Sel11 = ' + CAST(ISNULL(@Selected,0) AS VARCHAR(1)) + ','
	END

IF @SizeIndex = 12
	BEGIN
		SET @Query = @Query + ' Sel12 = ' + CAST(ISNULL(@Selected,0) AS VARCHAR(1)) + ','	
	END

IF @SizeIndex = 13
	BEGIN
		SET @Query = @Query + ' Sel13 = ' + CAST(ISNULL(@Selected,0) AS VARCHAR(1)) + ','
	END

IF @SizeIndex = 14
	BEGIN
		SET @Query = @Query + ' Sel14 = ' + CAST(ISNULL(@Selected,0) AS VARCHAR(1)) + ','
	END

IF @SizeIndex = 15
	BEGIN
		SET @Query = @Query + ' Sel15 = ' + CAST(ISNULL(@Selected,0) AS VARCHAR(1)) + ','
	END

IF @SizeIndex = 16
	BEGIN
		SET @Query = @Query + ' Sel16 = ' + CAST(ISNULL(@Selected,0) AS VARCHAR(1)) + ','
	END

IF @SizeIndex = 17
	BEGIN
		SET @Query = @Query + ' Sel14 = ' + CAST(ISNULL(@Selected,0) AS VARCHAR(1)) + ','
	END

IF @SizeIndex = 18
	BEGIN
		SET @Query = @Query + ' Sel18 = ' + CAST(ISNULL(@Selected,0) AS VARCHAR(1)) + ','
	END

IF @SizeIndex = 19
	BEGIN
		SET @Query = @Query + ' Sel19 = ' + CAST(ISNULL(@Selected,0) AS VARCHAR(1)) + ','
	END

	SET @Query = @Query + ' NumberOfSamples = ''' + CAST(ISNULL(@NoOfSamples,'') AS VARCHAR(2)) + ''','
	SET @Query = @Query + ' MDate = ''' + CAST(ISNULL(@ModifiedDate,'') AS VARCHAR(40)) + ''','
	SET @Query = @Query + ' MUser = ''' + CAST(ISNULL(@ModifiedBy ,'') AS NVARCHAR(200)) + ''''
	SET @Query = @Query + ' WHERE SampleRequestTradeID = ''' + CAST(ISNULL(@SampleRequestTradeID,'') AS VARCHAR(40)) + '''' 
	SET @Query = @Query + ' AND SampleRequestWorkflowID = ''' + CAST(ISNULL(@SampleRequestWorkflowID,'') AS VARCHAR(40)) + '''' 
	SET @Query = @Query + ' AND StyleID = ''' + CAST(ISNULL(@StyleID,'') AS VARCHAR(40)) + '''' 

BEGIN
	EXEC (@Query) 
END




GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_pStyleImageItem] on [dbo].[pStyleImageItem]'
GO
ALTER TABLE [dbo].[pStyleImageItem] ADD CONSTRAINT [PK_pStyleImageItem] PRIMARY KEY CLUSTERED  ([StyleImageItemID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_rReportParamTemp] on [dbo].[rReportParamTemp]'
GO
ALTER TABLE [dbo].[rReportParamTemp] ADD CONSTRAINT [PK_rReportParamTemp] PRIMARY KEY CLUSTERED  ([ReportParamID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating primary key [PK_sExchangeRateItem] on [dbo].[sExchangeRateItem]'
GO
ALTER TABLE [dbo].[sExchangeRateItem] ADD CONSTRAINT [PK_sExchangeRateItem] PRIMARY KEY CLUSTERED  ([ExchangeRateItemID])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating index [IDX_POMTYPE] on [dbo].[pPOMTemplate]'
GO
CREATE NONCLUSTERED INDEX [IDX_POMTYPE] ON [dbo].[pPOMTemplate] ([POMType])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating index [pStyleCare_Index] on [dbo].[pStyleCare]'
GO
CREATE NONCLUSTERED INDEX [pStyleCare_Index] ON [dbo].[pStyleCare] ([StyleId], [StyleSet])
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Adding constraints to [dbo].[ACustom12]'
GO
ALTER TABLE [dbo].[ACustom12] ADD CONSTRAINT [DF_aCustom12_Active] DEFAULT ((1)) FOR [Active]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Adding constraints to [dbo].[cCalendarEvent]'
GO
ALTER TABLE [dbo].[cCalendarEvent] ADD CONSTRAINT [DF_cCalendarEvent_CalendarEventID] DEFAULT (newid()) FOR [CalendarEventID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Adding constraints to [dbo].[hImage]'
GO
ALTER TABLE [dbo].[hImage] ADD CONSTRAINT [DF_hImage_SystemServerStorageID] DEFAULT ('00000000-0000-0000-0000-000000000000') FOR [SystemServerStorageID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Adding constraints to [dbo].[pColorType]'
GO
ALTER TABLE [dbo].[pColorType] ADD CONSTRAINT [DF_pColorType_Active] DEFAULT ((1)) FOR [Active]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Adding constraints to [dbo].[pImageType]'
GO
ALTER TABLE [dbo].[pImageType] ADD CONSTRAINT [DF_pImageType_Active] DEFAULT ((0)) FOR [Active]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Adding constraints to [dbo].[pLinePlanBusiness]'
GO
ALTER TABLE [dbo].[pLinePlanBusiness] ADD CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusLYCh1] DEFAULT ((0)) FOR [LinePlanBusLYCh1]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusiness] ADD CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusLYCh2] DEFAULT ((0)) FOR [LinePlanBusLYCh2]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusiness] ADD CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusLYCh3] DEFAULT ((0)) FOR [LinePlanBusLYCh3]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusiness] ADD CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusLYCh4] DEFAULT ((0)) FOR [LinePlanBusLYCh4]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusiness] ADD CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusLYCh5] DEFAULT ((0)) FOR [LinePlanBusLYCh5]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusiness] ADD CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusPnCh1] DEFAULT ((0)) FOR [LinePlanBusPnCh1]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusiness] ADD CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusPnCh2] DEFAULT ((0)) FOR [LinePlanBusPnCh2]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusiness] ADD CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusPnCh3] DEFAULT ((0)) FOR [LinePlanBusPnCh3]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusiness] ADD CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusPnCh4] DEFAULT ((0)) FOR [LinePlanBusPnCh4]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusiness] ADD CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusPnCh5] DEFAULT ((0)) FOR [LinePlanBusPnCh5]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusiness] ADD CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusCuCh1] DEFAULT ((0)) FOR [LinePlanBusCuCh1]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusiness] ADD CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusCuCh2] DEFAULT ((0)) FOR [LinePlanBusCuCh2]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusiness] ADD CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusCuCh3] DEFAULT ((0)) FOR [LinePlanBusCuCh3]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusiness] ADD CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusCuCh4] DEFAULT ((0)) FOR [LinePlanBusCuCh4]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusiness] ADD CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusCuCh5] DEFAULT ((0)) FOR [LinePlanBusCuCh5]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusiness] ADD CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusWpCh1] DEFAULT ((0)) FOR [LinePlanBusWpCh1]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusiness] ADD CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusWpCh2] DEFAULT ((0)) FOR [LinePlanBusWpCh2]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusiness] ADD CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusLWpCh3] DEFAULT ((0)) FOR [LinePlanBusWpCh3]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusiness] ADD CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusWpCh4] DEFAULT ((0)) FOR [LinePlanBusWpCh4]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusiness] ADD CONSTRAINT [DF_pLinePlanBusiness_LinePlanBusWpCh5] DEFAULT ((0)) FOR [LinePlanBusWpCh5]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Adding constraints to [dbo].[pLinePlanBusinessItem]'
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] ADD CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusLYCh1] DEFAULT ((0)) FOR [LinePlanBusLYCh1]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] ADD CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusLYCh2] DEFAULT ((0)) FOR [LinePlanBusLYCh2]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] ADD CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusLYCh3] DEFAULT ((0)) FOR [LinePlanBusLYCh3]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] ADD CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusLYCh4] DEFAULT ((0)) FOR [LinePlanBusLYCh4]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] ADD CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusLYCh5] DEFAULT ((0)) FOR [LinePlanBusLYCh5]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] ADD CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusPnCh1] DEFAULT ((0)) FOR [LinePlanBusPnCh1]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] ADD CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusPnCh2] DEFAULT ((0)) FOR [LinePlanBusPnCh2]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] ADD CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusPnCh3] DEFAULT ((0)) FOR [LinePlanBusPnCh3]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] ADD CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusPnCh4] DEFAULT ((0)) FOR [LinePlanBusPnCh4]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] ADD CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusPnCh5] DEFAULT ((0)) FOR [LinePlanBusPnCh5]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] ADD CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusCuCh1] DEFAULT ((0)) FOR [LinePlanBusCuCh1]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] ADD CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusCuCh2] DEFAULT ((0)) FOR [LinePlanBusCuCh2]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] ADD CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusCuCh3] DEFAULT ((0)) FOR [LinePlanBusCuCh3]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] ADD CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusCuCh4] DEFAULT ((0)) FOR [LinePlanBusCuCh4]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] ADD CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusCuCh5] DEFAULT ((0)) FOR [LinePlanBusCuCh5]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] ADD CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusLWpCh1] DEFAULT ((0)) FOR [LinePlanBusWpCh1]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] ADD CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusLWpCh2] DEFAULT ((0)) FOR [LinePlanBusWpCh2]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] ADD CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusLWpCh3] DEFAULT ((0)) FOR [LinePlanBusWpCh3]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] ADD CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusLWpCh4] DEFAULT ((0)) FOR [LinePlanBusWpCh4]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pLinePlanBusinessItem] ADD CONSTRAINT [DF_pLinePlanBusinessItem_LinePlanBusLWpCh5] DEFAULT ((0)) FOR [LinePlanBusWpCh5]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Adding constraints to [dbo].[pLinePlanShowroomStyleColor]'
GO
ALTER TABLE [dbo].[pLinePlanShowroomStyleColor] ADD CONSTRAINT [DF_pLinePlanShowroomStyleColor_LinePlanShowroomStyleColorID] DEFAULT (newid()) FOR [LinePlanShowroomStyleColorID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Adding constraints to [dbo].[pLinePlanTemplate]'
GO
ALTER TABLE [dbo].[pLinePlanTemplate] ADD CONSTRAINT [DF_pLinePlanTemplate_Active] DEFAULT ((1)) FOR [Active]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Adding constraints to [dbo].[pMaterialRequestWorkflowTemplateItem]'
GO
ALTER TABLE [dbo].[pMaterialRequestWorkflowTemplateItem] ADD CONSTRAINT [DF_pMaterialRequestWorkflowTemplateItem_MaterialRequestWorkflowAssignedTo] DEFAULT ((0)) FOR [MaterialRequestWorkflowAssignedTo]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Adding constraints to [dbo].[pMaterialSize]'
GO
ALTER TABLE [dbo].[pMaterialSize] ADD CONSTRAINT [DF_pMaterialSize_MaterialSizeID] DEFAULT (newid()) FOR [MaterialSizeID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Adding constraints to [dbo].[pMaterialTradePartnerColor]'
GO
ALTER TABLE [dbo].[pMaterialTradePartnerColor] ADD CONSTRAINT [DF_pMaterialTradePartnerColor_AgentView] DEFAULT ((0)) FOR [AgentView]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Adding constraints to [dbo].[pSampleRequestSubmitStatus]'
GO
ALTER TABLE [dbo].[pSampleRequestSubmitStatus] ADD CONSTRAINT [DF_pSampleRequestSubmitStatus_ApprovedType] DEFAULT ((0)) FOR [ApprovedType]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Adding constraints to [dbo].[pSampleWorkflowItemTemplate]'
GO
ALTER TABLE [dbo].[pSampleWorkflowItemTemplate] ADD CONSTRAINT [DF_pSampleWorkflowItemTemplate_SampleWorkflowRDays] DEFAULT ((0)) FOR [SampleWorkflowRDays]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Adding constraints to [dbo].[pStyleCosting]'
GO
ALTER TABLE [dbo].[pStyleCosting] ADD CONSTRAINT [DF_Temp_pStyleCosting_StyleCostingID] DEFAULT (newid()) FOR [StyleCostingID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pStyleCosting] ADD CONSTRAINT [DF_Temp_pStyleCosting_Active] DEFAULT ((0)) FOR [Active]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pStyleCosting] ADD CONSTRAINT [DF_Temp_pStyleCosting_StyleColorwayID] DEFAULT ('00000000-0000-0000-0000-000000000000') FOR [StyleColorwayID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Adding constraints to [dbo].[pStyleCostingDuty]'
GO
ALTER TABLE [dbo].[pStyleCostingDuty] ADD CONSTRAINT [DF_pStyleCostingDuty_DutyId_1] DEFAULT (newid()) FOR [DutyId]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Adding constraints to [dbo].[pStyleCostingHeader]'
GO
ALTER TABLE [dbo].[pStyleCostingHeader] ADD CONSTRAINT [DF_pStyleCostingHeader_StyleCostingHeaderID] DEFAULT (newid()) FOR [StyleCostingHeaderID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Adding constraints to [dbo].[pStyleDocument]'
GO
ALTER TABLE [dbo].[pStyleDocument] ADD CONSTRAINT [DF_pStyleDocument_SystemServerStorageID] DEFAULT ('00000000-0000-0000-0000-000000000000') FOR [SystemServerStorageID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Adding constraints to [dbo].[pStyleMaterials]'
GO
ALTER TABLE [dbo].[pStyleMaterials] ADD CONSTRAINT [DF_pStyleMaterials_MaterialSort] DEFAULT ('0000') FOR [MaterialSort]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Adding constraints to [dbo].[pStyleMaterialTemp]'
GO
ALTER TABLE [dbo].[pStyleMaterialTemp] ADD CONSTRAINT [DF_pStyleMaterialTemp_Qty] DEFAULT ((0)) FOR [Qty]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pStyleMaterialTemp] ADD CONSTRAINT [DF_pStyleMaterialTemp_Colorway] DEFAULT ((1)) FOR [Colorway]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pStyleMaterialTemp] ADD CONSTRAINT [DF_pStyleMaterialTemp_MaterialTrack] DEFAULT ((0)) FOR [MaterialTrack]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
ALTER TABLE [dbo].[pStyleMaterialTemp] ADD CONSTRAINT [DF_pStyleMaterialTemp_MaterialLinked] DEFAULT ((1)) FOR [MaterialLinked]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Adding constraints to [dbo].[pStyleSourcing]'
GO
ALTER TABLE [dbo].[pStyleSourcing] ADD CONSTRAINT [DF_pStyleSourcing_StyleSourcingID] DEFAULT (newid()) FOR [StyleSourcingID]
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating trigger [dbo].[icustom1_AspNet_SqlCacheNotification_Trigger] on [dbo].[iCustom1]'
GO
CREATE TRIGGER dbo.[icustom1_AspNet_SqlCacheNotification_Trigger] ON [dbo].[iCustom1]
                       FOR INSERT, UPDATE, DELETE AS BEGIN
                       SET NOCOUNT ON
                       EXEC dbo.AspNet_SqlCacheUpdateChangeIdStoredProcedure N'icustom1'
                       END
                       
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating trigger [dbo].[pColorType_AspNet_SqlCacheNotification_Trigger] on [dbo].[pColorType]'
GO
CREATE TRIGGER dbo.[pColorType_AspNet_SqlCacheNotification_Trigger] ON [dbo].[pColorType]
                       FOR INSERT, UPDATE, DELETE AS BEGIN
                       SET NOCOUNT ON
                       EXEC dbo.AspNet_SqlCacheUpdateChangeIdStoredProcedure N'pColorType'
                       END
                       
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating trigger [dbo].[pLineFolderType_AspNet_SqlCacheNotification_Trigger] on [dbo].[pLineFolderType]'
GO
CREATE TRIGGER dbo.[pLineFolderType_AspNet_SqlCacheNotification_Trigger] ON dbo.pLineFolderType
                       FOR INSERT, UPDATE, DELETE AS BEGIN
                       SET NOCOUNT ON
                       EXEC dbo.AspNet_SqlCacheUpdateChangeIdStoredProcedure N'pLineFolderType'
                       END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating trigger [dbo].[pMaterialRequestWorkflow_AspNet_SqlCacheNotification_Trigger] on [dbo].[pMaterialRequestWorkflow]'
GO
CREATE TRIGGER dbo.[pMaterialRequestWorkflow_AspNet_SqlCacheNotification_Trigger] ON dbo.pMaterialRequestWorkflow
                       FOR INSERT, UPDATE, DELETE AS BEGIN
                       SET NOCOUNT ON
                       EXEC dbo.AspNet_SqlCacheUpdateChangeIdStoredProcedure N'pMaterialRequestWorkflow'
                       END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating trigger [dbo].[pMaterialRequestWorkflowGroup_AspNet_SqlCacheNotification_Trigger] on [dbo].[pMaterialRequestWorkflowGroup]'
GO
CREATE TRIGGER dbo.[pMaterialRequestWorkflowGroup_AspNet_SqlCacheNotification_Trigger] ON [dbo].[pMaterialRequestWorkflowGroup]
                       FOR INSERT, UPDATE, DELETE AS BEGIN
                       SET NOCOUNT ON
                       EXEC dbo.AspNet_SqlCacheUpdateChangeIdStoredProcedure N'pMaterialRequestWorkflowGroup'
                       END
                       
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating trigger [dbo].[sAccessColorFolder_AspNet_SqlCacheNotification_Trigger] on [dbo].[sAccessColorFolder]'
GO
CREATE TRIGGER dbo.[sAccessColorFolder_AspNet_SqlCacheNotification_Trigger] ON [dbo].[sAccessColorFolder]
                       FOR INSERT, UPDATE, DELETE AS BEGIN
                       SET NOCOUNT ON
                       EXEC dbo.AspNet_SqlCacheUpdateChangeIdStoredProcedure N'sAccessColorFolder'
                       END
                       
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating trigger [dbo].[sSystemServerStorageSetting_AspNet_SqlCacheNotification_Trigger] on [dbo].[sSystemServerStorageSetting]'
GO
CREATE TRIGGER dbo.[sSystemServerStorageSetting_AspNet_SqlCacheNotification_Trigger] ON dbo.sSystemServerStorageSetting
                       FOR INSERT, UPDATE, DELETE AS BEGIN
                       SET NOCOUNT ON
                       EXEC dbo.AspNet_SqlCacheUpdateChangeIdStoredProcedure N'sSystemServerStorageSetting'
                       END
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating trigger [dbo].[Users_AspNet_SqlCacheNotification_Trigger] on [dbo].[Users]'
GO
CREATE TRIGGER dbo.[Users_AspNet_SqlCacheNotification_Trigger] ON [dbo].[Users]
                       FOR INSERT, UPDATE, DELETE AS BEGIN
                       SET NOCOUNT ON
                       EXEC dbo.AspNet_SqlCacheUpdateChangeIdStoredProcedure N'Users'
                       END
                       
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Altering extended properties'
GO
EXEC sp_updateextendedproperty N'MS_Orientation', 0x, 'SCHEMA', N'dbo', 'TABLE', N'pImageType', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_updateextendedproperty N'MS_Orientation', 0x, 'SCHEMA', N'dbo', 'TABLE', N'pLineFolder', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_updateextendedproperty N'MS_Orientation', 0x, 'SCHEMA', N'dbo', 'TABLE', N'pStyleType', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_updateextendedproperty N'MS_Orientation', 0x00, 'SCHEMA', N'dbo', 'PROCEDURE', N'spx_StyleCostingTab_SELECT', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_updateextendedproperty N'MS_Orientation', 0x00, 'SCHEMA', N'dbo', 'PROCEDURE', N'spx_StyleCostingId_SELECT', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
PRINT N'Creating extended properties'
GO
EXEC sp_addextendedproperty N'MS_Orientation', 0x00, 'SCHEMA', N'dbo', 'TABLE', N'pBodyHistory', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_DisplayControl', N'109', 'SCHEMA', N'dbo', 'TABLE', N'pBodyHistory', 'COLUMN', N'BodyHistoryID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_Format', N'', 'SCHEMA', N'dbo', 'TABLE', N'pBodyHistory', 'COLUMN', N'BodyHistoryID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_IMEMode', N'0', 'SCHEMA', N'dbo', 'TABLE', N'pBodyHistory', 'COLUMN', N'BodyHistoryID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_DisplayControl', N'', 'SCHEMA', N'dbo', 'TABLE', N'pBodyHistory', 'COLUMN', N'BodyID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_Format', N'', 'SCHEMA', N'dbo', 'TABLE', N'pBodyHistory', 'COLUMN', N'BodyID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_IMEMode', N'0', 'SCHEMA', N'dbo', 'TABLE', N'pBodyHistory', 'COLUMN', N'BodyID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_DisplayControl', N'', 'SCHEMA', N'dbo', 'TABLE', N'pBodyHistory', 'COLUMN', N'CDate'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_Format', N'', 'SCHEMA', N'dbo', 'TABLE', N'pBodyHistory', 'COLUMN', N'CDate'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_IMEMode', N'0', 'SCHEMA', N'dbo', 'TABLE', N'pBodyHistory', 'COLUMN', N'CDate'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_DisplayControl', N'', 'SCHEMA', N'dbo', 'TABLE', N'pBodyHistory', 'COLUMN', N'TeamID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_Format', N'', 'SCHEMA', N'dbo', 'TABLE', N'pBodyHistory', 'COLUMN', N'TeamID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_IMEMode', N'0', 'SCHEMA', N'dbo', 'TABLE', N'pBodyHistory', 'COLUMN', N'TeamID'
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_DiagramPane1', N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1[97] 3) )"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1[75] 4) )"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 12
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = -349
      End
      Begin Tables = 
         Begin Table = "pSampleRequestActivity"
            Begin Extent = 
               Top = 609
               Left = 444
               Bottom = 882
               Right = 665
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "pSampleRequestComment"
            Begin Extent = 
               Top = 6
               Left = 450
               Bottom = 278
               Right = 660
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "pSampleRequestLog"
            Begin Extent = 
               Top = 402
               Left = 1520
               Bottom = 680
               Right = 1747
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "pSampleRequestMaterial"
            Begin Extent = 
               Top = 411
               Left = 1262
               Bottom = 821
               Right = 1485
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "pSampleRequestSpecItem"
            Begin Extent = 
               Top = 1
               Left = 1268
               Bottom = 400
               Right = 1485
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "pSampleRequestSpecSize"
            Begin Extent = 
               Top = 8
               Left = 1526
               Bottom = 395
               Right = 1745
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "pSampleRequestStyle"
            Begin Extent = 
               Top = 489
               Left = 6', 'SCHEMA', N'dbo', 'VIEW', N'vws_SampleRequest_Relationship', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_DiagramPane2', N'96
               Bottom = 1032
               Right = 939
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "pSampleRequestSubmit"
            Begin Extent = 
               Top = 387
               Left = 974
               Bottom = 1028
               Right = 1213
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "pSampleRequestSubmitImage"
            Begin Extent = 
               Top = 3
               Left = 982
               Bottom = 381
               Right = 1209
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "pSampleRequestSubmitStatus"
            Begin Extent = 
               Top = 833
               Left = 1260
               Bottom = 1018
               Right = 1476
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "pSampleRequestTrade"
            Begin Extent = 
               Top = 296
               Left = 448
               Bottom = 595
               Right = 665
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "pSampleRequestWorkflow"
            Begin Extent = 
               Top = 6
               Left = 700
               Bottom = 479
               Right = 938
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
      PaneHidden = 
   End
   Begin DataPane = 
      PaneHidden = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      PaneHidden = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
', 'SCHEMA', N'dbo', 'VIEW', N'vws_SampleRequest_Relationship', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_DiagramPaneCount', 2, 'SCHEMA', N'dbo', 'VIEW', N'vws_SampleRequest_Relationship', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_DiagramPane1', N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "pLineFolderItem"
            Begin Extent = 
               Top = 0
               Left = 215
               Bottom = 283
               Right = 421
            End
            DisplayFlags = 280
            TopColumn = 11
         End
         Begin Table = "pStyleHeader"
            Begin Extent = 
               Top = 127
               Left = 450
               Bottom = 409
               Right = 648
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "pStyleDevelopmentItem"
            Begin Extent = 
               Top = 0
               Left = 689
               Bottom = 119
               Right = 898
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "pStyleMaterials"
            Begin Extent = 
               Top = 153
               Left = 771
               Bottom = 328
               Right = 990
            End
            DisplayFlags = 280
            TopColumn = 5
         End
         Begin Table = "pLineFolder"
            Begin Extent = 
               Top = 8
               Left = 8
               Bottom = 280
               Right = 199
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 38
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500', 'SCHEMA', N'dbo', 'VIEW', N'vwx_LineFolderItem_SELECT', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_DiagramPane2', N'
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
', 'SCHEMA', N'dbo', 'VIEW', N'vwx_LineFolderItem_SELECT', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_DiagramPaneCount', 2, 'SCHEMA', N'dbo', 'VIEW', N'vwx_LineFolderItem_SELECT', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_DiagramPane1', N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "pMaterialRequestWorkflow"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 338
               Right = 300
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "pMaterialRequestWorkflowGroup"
            Begin Extent = 
               Top = 6
               Left = 338
               Bottom = 225
               Right = 590
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
', 'SCHEMA', N'dbo', 'VIEW', N'vwx_MaterialRequestWorkflowGroup_SEL', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_DiagramPaneCount', 1, 'SCHEMA', N'dbo', 'VIEW', N'vwx_MaterialRequestWorkflowGroup_SEL', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_DiagramPane1', N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "pMaterialRequestWorkflow"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 332
               Right = 300
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "pMaterialRequestWorkflowTemplateItem"
            Begin Extent = 
               Top = 6
               Left = 338
               Bottom = 335
               Right = 726
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
', 'SCHEMA', N'dbo', 'VIEW', N'vwx_MaterialRequestWorkflowTemplateItem_SEL', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_DiagramPaneCount', 1, 'SCHEMA', N'dbo', 'VIEW', N'vwx_MaterialRequestWorkflowTemplateItem_SEL', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_DiagramPane1', N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "a"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 114
               Right = 246
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "b"
            Begin Extent = 
               Top = 114
               Left = 38
               Bottom = 222
               Right = 249
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "d"
            Begin Extent = 
               Top = 6
               Left = 284
               Bottom = 114
               Right = 457
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
', 'SCHEMA', N'dbo', 'VIEW', N'vwx_MaterialWizardRequest_ColorSeasonYear_Available_SEL', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_DiagramPaneCount', 1, 'SCHEMA', N'dbo', 'VIEW', N'vwx_MaterialWizardRequest_ColorSeasonYear_Available_SEL', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_DiagramPane1', N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "pStyleHeader"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 341
               Right = 236
            End
            DisplayFlags = 280
            TopColumn = 127
         End
         Begin Table = "pStyleSeasonYear"
            Begin Extent = 
               Top = 6
               Left = 274
               Bottom = 343
               Right = 472
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
', 'SCHEMA', N'dbo', 'VIEW', N'vwx_StyleHeader_SELECT', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_DiagramPaneCount', 1, 'SCHEMA', N'dbo', 'VIEW', N'vwx_StyleHeader_SELECT', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_DiagramPane1', N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "xCustom8"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 114
               Right = 189
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
', 'SCHEMA', N'dbo', 'VIEW', N'vwx_xCustom8', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
EXEC sp_addextendedproperty N'MS_DiagramPaneCount', 1, 'SCHEMA', N'dbo', 'VIEW', N'vwx_xCustom8', NULL, NULL
GO
IF @@ERROR<>0 AND @@TRANCOUNT>0 ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT=0 BEGIN INSERT INTO #tmpErrors (Error) SELECT 1 BEGIN TRANSACTION END
GO
IF EXISTS (SELECT * FROM #tmpErrors) ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT>0 BEGIN
PRINT 'The database update succeeded'
COMMIT TRANSACTION
END
ELSE PRINT 'The database update failed'
GO
DROP TABLE #tmpErrors
GO
